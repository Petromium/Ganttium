{"file_contents":{"server/db.ts":{"content":"import { Pool, neonConfig } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-serverless';\nimport ws from \"ws\";\nimport * as schema from \"@shared/schema\";\n\nneonConfig.webSocketConstructor = ws;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle({ client: pool, schema });\n","size_bytes":483},"client/src/components/examples/TaskModal.tsx":{"content":"import { TaskModal } from '../TaskModal';\nimport { Button } from '@/components/ui/button';\nimport { useState } from 'react';\n\nexport default function TaskModalExample() {\n  const [open, setOpen] = useState(false);\n\n  return (\n    <div className=\"p-4\">\n      <Button onClick={() => setOpen(true)}>Open Task Modal</Button>\n      <TaskModal open={open} onClose={() => setOpen(false)} />\n    </div>\n  );\n}\n","size_bytes":402},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","size_bytes":1209},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","size_bytes":689},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","size_bytes":4845},"client/src/components/examples/GanttPage.tsx":{"content":"import GanttPage from '@/pages/GanttPage';\n\nexport default function GanttPageExample() {\n  return <GanttPage />;\n}\n","size_bytes":115},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":711},"client/src/pages/WBSPage.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { TableRowCard } from \"@/components/TableRowCard\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { \n  Search, Filter, LayoutGrid, List, Calendar as CalendarIcon, \n  GanttChartSquare, AlertCircle, Plus, Clock, AlertTriangle, \n  Loader2, ZoomIn, ZoomOut, Maximize2, ChevronLeft, ChevronRight, X\n} from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { TaskModal } from \"@/components/TaskModal\";\nimport { Tabs, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Label } from \"@/components/ui/label\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { cn } from \"@/lib/utils\";\nimport type { Task, TaskDependency } from \"@shared/schema\";\n\ntype TaskStatus = \"not-started\" | \"in-progress\" | \"review\" | \"completed\" | \"on-hold\";\ntype ViewMode = \"list\" | \"kanban\" | \"gantt\" | \"calendar\";\ntype ZoomLevel = \"week\" | \"month\" | \"quarter\";\n\nconst KANBAN_COLUMNS: { id: TaskStatus; title: string }[] = [\n  { id: \"not-started\", title: \"Not Started\" },\n  { id: \"in-progress\", title: \"In Progress\" },\n  { id: \"review\", title: \"In Review\" },\n  { id: \"completed\", title: \"Completed\" },\n];\n\nconst ZOOM_CONFIGS: Record<ZoomLevel, { daysPerUnit: number; unitLabel: string }> = {\n  week: { daysPerUnit: 7, unitLabel: \"Week\" },\n  month: { daysPerUnit: 30, unitLabel: \"Month\" },\n  quarter: { daysPerUnit: 90, unitLabel: \"Quarter\" },\n};\n\nconst WEEKDAYS = [\"Sun\", \"Mon\", \"Tue\", \"Wed\", \"Thu\", \"Fri\", \"Sat\"];\n\nexport default function WBSPage() {\n  const { selectedProjectId } = useProject();\n  const { toast } = useToast();\n  const [selectedTasks, setSelectedTasks] = useState<number[]>([]);\n  const [expandedTasks, setExpandedTasks] = useState<number[]>([]);\n  const [taskModalOpen, setTaskModalOpen] = useState(false);\n  const [editingTask, setEditingTask] = useState<Task | undefined>();\n  const [viewMode, setViewMode] = useState<ViewMode>(\"list\");\n  const [defaultStatus, setDefaultStatus] = useState<TaskStatus>(\"not-started\");\n  const [draggedTaskId, setDraggedTaskId] = useState<number | null>(null);\n  const [zoom, setZoom] = useState<ZoomLevel>(\"month\");\n  const [currentDate, setCurrentDate] = useState(new Date());\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [filterOpen, setFilterOpen] = useState(false);\n  const [statusFilters, setStatusFilters] = useState<TaskStatus[]>([]);\n  const [priorityFilters, setPriorityFilters] = useState<string[]>([]);\n  const [disciplineFilters, setDisciplineFilters] = useState<string[]>([]);\n  const [dateRangeStart, setDateRangeStart] = useState<string>(\"\");\n  const [dateRangeEnd, setDateRangeEnd] = useState<string>(\"\");\n\n  const { \n    data: tasks = [], \n    isLoading, \n    error, \n    refetch \n  } = useQuery<Task[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/tasks`],\n    enabled: !!selectedProjectId,\n    retry: 1,\n  });\n\n  const { data: dependencies = [] } = useQuery<TaskDependency[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/dependencies`],\n    enabled: !!selectedProjectId && viewMode === \"gantt\",\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (taskId: number) => {\n      await apiRequest(\"DELETE\", `/api/tasks/${taskId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${selectedProjectId}/tasks`] });\n      toast({ title: \"Success\", description: \"Task deleted successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message || \"Failed to delete task\", variant: \"destructive\" });\n    },\n  });\n\n  const updateTaskMutation = useMutation({\n    mutationFn: async ({ taskId, status }: { taskId: number; status: TaskStatus }) => {\n      await apiRequest(\"PATCH\", `/api/tasks/${taskId}`, { status });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${selectedProjectId}/tasks`] });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message || \"Failed to update task status\", variant: \"destructive\" });\n    },\n  });\n\n  const uniqueDisciplines = useMemo(() => {\n    const disciplines = new Set<string>();\n    tasks.forEach(t => {\n      if (t.discipline) disciplines.add(t.discipline);\n    });\n    return Array.from(disciplines).sort();\n  }, [tasks]);\n\n  const activeFilterCount = useMemo(() => {\n    let count = 0;\n    if (statusFilters.length > 0) count++;\n    if (priorityFilters.length > 0) count++;\n    if (disciplineFilters.length > 0) count++;\n    if (dateRangeStart || dateRangeEnd) count++;\n    return count;\n  }, [statusFilters, priorityFilters, disciplineFilters, dateRangeStart, dateRangeEnd]);\n\n  const filteredTasks = useMemo(() => {\n    let result = tasks;\n\n    if (searchQuery.trim()) {\n      const query = searchQuery.toLowerCase();\n      result = result.filter(t => \n        t.name.toLowerCase().includes(query) || \n        t.wbsCode?.toLowerCase().includes(query) ||\n        t.description?.toLowerCase().includes(query)\n      );\n    }\n\n    if (statusFilters.length > 0) {\n      result = result.filter(t => statusFilters.includes(t.status as TaskStatus));\n    }\n\n    if (priorityFilters.length > 0) {\n      result = result.filter(t => t.priority && priorityFilters.includes(t.priority));\n    }\n\n    if (disciplineFilters.length > 0) {\n      result = result.filter(t => t.discipline && disciplineFilters.includes(t.discipline));\n    }\n\n    if (dateRangeStart) {\n      const startDate = new Date(dateRangeStart);\n      result = result.filter(t => t.startDate && new Date(t.startDate) >= startDate);\n    }\n\n    if (dateRangeEnd) {\n      const endDate = new Date(dateRangeEnd);\n      result = result.filter(t => t.endDate && new Date(t.endDate) <= endDate);\n    }\n\n    return result;\n  }, [tasks, searchQuery, statusFilters, priorityFilters, disciplineFilters, dateRangeStart, dateRangeEnd]);\n\n  const clearFilters = () => {\n    setStatusFilters([]);\n    setPriorityFilters([]);\n    setDisciplineFilters([]);\n    setDateRangeStart(\"\");\n    setDateRangeEnd(\"\");\n  };\n\n  const toggleStatusFilter = (status: TaskStatus) => {\n    setStatusFilters(prev => \n      prev.includes(status) ? prev.filter(s => s !== status) : [...prev, status]\n    );\n  };\n\n  const togglePriorityFilter = (priority: string) => {\n    setPriorityFilters(prev => \n      prev.includes(priority) ? prev.filter(p => p !== priority) : [...prev, priority]\n    );\n  };\n\n  const toggleDisciplineFilter = (discipline: string) => {\n    setDisciplineFilters(prev => \n      prev.includes(discipline) ? prev.filter(d => d !== discipline) : [...prev, discipline]\n    );\n  };\n\n  const handleSelectTask = (id: number, selected: boolean) => {\n    setSelectedTasks(prev => selected ? [...prev, id] : prev.filter(t => t !== id));\n  };\n\n  const handleToggleExpand = (id: number) => {\n    setExpandedTasks(prev => prev.includes(id) ? prev.filter(t => t !== id) : [...prev, id]);\n  };\n\n  const handleDeleteTask = async (id: number) => {\n    if (window.confirm(\"Are you sure you want to delete this task?\")) {\n      await deleteMutation.mutateAsync(id);\n    }\n  };\n\n  const handleEditTask = (task: Task) => {\n    setEditingTask(task);\n    setTaskModalOpen(true);\n  };\n\n  const handleAddTask = (status: TaskStatus = \"not-started\") => {\n    setEditingTask(undefined);\n    setDefaultStatus(status);\n    setTaskModalOpen(true);\n  };\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case \"completed\": return \"default\";\n      case \"in-progress\": return \"secondary\";\n      case \"review\": return \"outline\";\n      default: return \"outline\";\n    }\n  };\n\n  const getPriorityColor = (priority: string) => {\n    switch (priority) {\n      case \"critical\": return \"destructive\";\n      case \"high\": return \"secondary\";\n      default: return \"outline\";\n    }\n  };\n\n  const getStatusBgColor = (status: string) => {\n    switch (status) {\n      case \"completed\": return \"bg-green-500\";\n      case \"in-progress\": return \"bg-blue-500\";\n      case \"review\": return \"bg-purple-500\";\n      case \"on-hold\": return \"bg-amber-500\";\n      default: return \"bg-gray-400\";\n    }\n  };\n\n  const getInitials = (name: string | null) => {\n    if (!name) return \"?\";\n    return name.split(\" \").map(n => n[0]).join(\"\").toUpperCase().slice(0, 2);\n  };\n\n  const isOverdue = (task: Task) => {\n    if (!task.endDate) return false;\n    return new Date(task.endDate) < new Date() && task.status !== \"completed\";\n  };\n\n  const rootTasks = filteredTasks.filter(t => !t.parentId);\n  const getChildren = (parentId: number) => filteredTasks.filter(t => t.parentId === parentId);\n\n  const renderListTask = (task: Task, level = 0) => {\n    const children = getChildren(task.id);\n    const isExpanded = expandedTasks.includes(task.id);\n    const hasChildren = children.length > 0;\n\n    return (\n      <div key={task.id}>\n        <div style={{ marginLeft: `${level * 1.5}rem` }}>\n          <TableRowCard\n            id={task.id.toString()}\n            selected={selectedTasks.includes(task.id)}\n            onSelect={(selected) => handleSelectTask(task.id, selected)}\n            expanded={isExpanded}\n            onToggleExpand={hasChildren ? () => handleToggleExpand(task.id) : undefined}\n            expandable={hasChildren}\n            data-testid={`row-task-${task.id}`}\n          >\n            <div \n              className=\"grid grid-cols-[2fr,1fr,1fr,1fr,100px,80px] gap-4 items-center flex-1 cursor-pointer\"\n              onClick={() => handleEditTask(task)}\n            >\n              <div>\n                <div className=\"font-medium\">{task.name}</div>\n                <div className=\"text-sm text-muted-foreground\">{task.wbsCode}</div>\n              </div>\n              <Badge variant={getStatusColor(task.status)} data-testid={`badge-status-${task.id}`}>\n                {task.status.replace(\"-\", \" \")}\n              </Badge>\n              <div className=\"flex items-center gap-2\">\n                <div className=\"flex-1 h-2 bg-muted rounded-full overflow-hidden\">\n                  <div className=\"h-full bg-primary\" style={{ width: `${task.progress}%` }} />\n                </div>\n                <span className=\"text-sm text-muted-foreground w-12 text-right\">{task.progress}%</span>\n              </div>\n              <Badge variant={getPriorityColor(task.priority)} data-testid={`badge-priority-${task.id}`}>\n                {task.priority}\n              </Badge>\n              <div className=\"text-sm text-muted-foreground\">{task.assignedTo || \"Unassigned\"}</div>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={(e) => { e.stopPropagation(); handleDeleteTask(task.id); }}\n                disabled={deleteMutation.isPending}\n                data-testid={`button-delete-${task.id}`}\n              >\n                Delete\n              </Button>\n            </div>\n          </TableRowCard>\n        </div>\n        {isExpanded && children.map(child => renderListTask(child, level + 1))}\n      </div>\n    );\n  };\n\n  const handleDragStart = (e: React.DragEvent, taskId: number) => {\n    setDraggedTaskId(taskId);\n    e.dataTransfer.effectAllowed = \"move\";\n  };\n\n  const handleDragOver = (e: React.DragEvent) => {\n    e.preventDefault();\n    e.dataTransfer.dropEffect = \"move\";\n  };\n\n  const handleDrop = (e: React.DragEvent, targetStatus: TaskStatus) => {\n    e.preventDefault();\n    if (draggedTaskId !== null) {\n      const task = filteredTasks.find(t => t.id === draggedTaskId);\n      if (task && task.status !== targetStatus) {\n        updateTaskMutation.mutate({ taskId: draggedTaskId, status: targetStatus });\n      }\n    }\n    setDraggedTaskId(null);\n  };\n\n  const handleDragEnd = () => setDraggedTaskId(null);\n\n  const groupedTasks: Record<TaskStatus, Task[]> = {\n    \"not-started\": [],\n    \"in-progress\": [],\n    \"review\": [],\n    \"completed\": [],\n    \"on-hold\": [],\n  };\n  filteredTasks.forEach((task) => {\n    if (groupedTasks[task.status as TaskStatus]) {\n      groupedTasks[task.status as TaskStatus].push(task);\n    }\n  });\n\n  const { minDate, maxDate, totalDays, units } = useMemo(() => {\n    if (filteredTasks.length === 0) {\n      const now = new Date();\n      return { minDate: now, maxDate: new Date(now.getTime() + 180 * 24 * 60 * 60 * 1000), totalDays: 180, units: 6 };\n    }\n    let min = new Date();\n    let max = new Date();\n    filteredTasks.forEach(task => {\n      if (task.startDate) {\n        const start = new Date(task.startDate);\n        if (!min || start < min) min = start;\n      }\n      if (task.endDate) {\n        const end = new Date(task.endDate);\n        if (!max || end > max) max = end;\n      }\n    });\n    min.setDate(min.getDate() - 7);\n    max.setDate(max.getDate() + 30);\n    const daysDiff = Math.ceil((max.getTime() - min.getTime()) / (1000 * 60 * 60 * 24));\n    const { daysPerUnit } = ZOOM_CONFIGS[zoom];\n    return { minDate: min, maxDate: max, totalDays: daysDiff, units: Math.ceil(daysDiff / daysPerUnit) };\n  }, [filteredTasks, zoom]);\n\n  const getTaskPosition = (task: Task) => {\n    if (!task.startDate || !task.endDate) return { left: 0, width: 0 };\n    const start = new Date(task.startDate);\n    const end = new Date(task.endDate);\n    const startOffset = Math.floor((start.getTime() - minDate.getTime()) / (1000 * 60 * 60 * 24));\n    const duration = Math.ceil((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24));\n    return { left: (startOffset / totalDays) * 100, width: Math.max((duration / totalDays) * 100, 1) };\n  };\n\n  const getUnitLabels = () => {\n    const labels: string[] = [];\n    const { daysPerUnit, unitLabel } = ZOOM_CONFIGS[zoom];\n    for (let i = 0; i < units; i++) {\n      const unitDate = new Date(minDate.getTime() + i * daysPerUnit * 24 * 60 * 60 * 1000);\n      if (zoom === \"week\") labels.push(`${unitLabel} ${i + 1}`);\n      else if (zoom === \"month\") labels.push(unitDate.toLocaleDateString(\"en-US\", { month: \"short\", year: \"2-digit\" }));\n      else labels.push(`Q${Math.floor(unitDate.getMonth() / 3) + 1} ${unitDate.getFullYear()}`);\n    }\n    return labels;\n  };\n\n  const handleZoomIn = () => { if (zoom === \"quarter\") setZoom(\"month\"); else if (zoom === \"month\") setZoom(\"week\"); };\n  const handleZoomOut = () => { if (zoom === \"week\") setZoom(\"month\"); else if (zoom === \"month\") setZoom(\"quarter\"); };\n\n  const renderGanttTask = (task: Task, level = 0): JSX.Element[] => {\n    const children = getChildren(task.id);\n    const { left, width } = getTaskPosition(task);\n    const hasValidDates = task.startDate && task.endDate;\n    const elements: JSX.Element[] = [\n      <div\n        key={task.id}\n        className={`grid grid-cols-12 gap-px items-center ${task.priority === \"critical\" ? \"border-l-4 border-l-red-500\" : task.priority === \"high\" ? \"border-l-4 border-l-orange-500\" : \"\"}`}\n        style={{ paddingLeft: `${level * 1.5}rem` }}\n      >\n        <div className=\"col-span-3 flex items-center gap-2 py-2 pr-2\">\n          <Badge variant=\"outline\" className=\"font-mono text-xs shrink-0\">{task.wbsCode || `#${task.id}`}</Badge>\n          <span className=\"text-sm font-medium truncate\">{task.name}</span>\n        </div>\n        <div className=\"col-span-9 relative h-10 bg-muted/30 rounded\">\n          {hasValidDates ? (\n            <div\n              className={`absolute top-1/2 -translate-y-1/2 h-6 rounded ${getStatusBgColor(task.status)} flex items-center px-2 text-white text-xs font-semibold shadow hover-elevate cursor-pointer transition-shadow overflow-hidden`}\n              style={{ left: `${left}%`, width: `${width}%`, minWidth: \"40px\" }}\n              onClick={() => handleEditTask(task)}\n              data-testid={`gantt-bar-${task.id}`}\n            >\n              <div className=\"flex items-center justify-between w-full\"><span className=\"truncate\">{task.progress || 0}%</span></div>\n              <div className=\"absolute inset-0 bg-white/20 rounded pointer-events-none\" style={{ width: `${task.progress || 0}%` }} />\n            </div>\n          ) : (\n            <div className=\"absolute inset-0 flex items-center justify-center text-xs text-muted-foreground\">No dates set</div>\n          )}\n        </div>\n      </div>\n    ];\n    children.forEach(child => elements.push(...renderGanttTask(child, level + 1)));\n    return elements;\n  };\n\n  const { year, month, daysInMonth, startDay, today, monthName } = useMemo(() => {\n    const y = currentDate.getFullYear();\n    const m = currentDate.getMonth();\n    const firstDay = new Date(y, m, 1);\n    const lastDay = new Date(y, m + 1, 0);\n    const todayDate = new Date();\n    return {\n      year: y, month: m, daysInMonth: lastDay.getDate(), startDay: firstDay.getDay(),\n      today: todayDate.getFullYear() === y && todayDate.getMonth() === m ? todayDate.getDate() : -1,\n      monthName: firstDay.toLocaleDateString(\"en-US\", { month: \"long\", year: \"numeric\" }),\n    };\n  }, [currentDate]);\n\n  const tasksOnDate = useMemo(() => {\n    const taskMap: Map<number, Task[]> = new Map();\n    filteredTasks.forEach(task => {\n      if (task.startDate) {\n        const startDate = new Date(task.startDate);\n        if (startDate.getFullYear() === year && startDate.getMonth() === month) {\n          const day = startDate.getDate();\n          if (!taskMap.has(day)) taskMap.set(day, []);\n          taskMap.get(day)!.push({ ...task, _isStart: true } as any);\n        }\n      }\n      if (task.endDate) {\n        const endDate = new Date(task.endDate);\n        if (endDate.getFullYear() === year && endDate.getMonth() === month) {\n          const day = endDate.getDate();\n          if (!taskMap.has(day)) taskMap.set(day, []);\n          const existing = taskMap.get(day)!.find(t => t.id === task.id);\n          if (!existing) taskMap.get(day)!.push({ ...task, _isEnd: true } as any);\n        }\n      }\n    });\n    return taskMap;\n  }, [filteredTasks, year, month]);\n\n  const weeks = Math.ceil((daysInMonth + startDay) / 7);\n  const goToPrevMonth = () => setCurrentDate(new Date(year, month - 1, 1));\n  const goToNextMonth = () => setCurrentDate(new Date(year, month + 1, 1));\n  const goToToday = () => setCurrentDate(new Date());\n\n  if (!selectedProjectId) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"text-center py-12\">\n          <h2 className=\"text-2xl font-semibold mb-2\">No Project Selected</h2>\n          <p className=\"text-muted-foreground\">Please select a project from the dropdown above</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-4\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-semibold\" data-testid=\"page-title-wbs\">Work Breakdown Structure</h1>\n          <p className=\"text-muted-foreground\">Manage tasks and deliverables</p>\n        </div>\n        <Button onClick={() => handleAddTask()} data-testid=\"button-create-task\">\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Create Task\n        </Button>\n      </div>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertDescription className=\"flex items-center justify-between\">\n            <span>Failed to load tasks. {(error as Error).message}</span>\n            <Button variant=\"outline\" size=\"sm\" onClick={() => refetch()} data-testid=\"button-retry\">Retry</Button>\n          </AlertDescription>\n        </Alert>\n      )}\n\n      <div className=\"flex items-center gap-4\">\n        <div className=\"relative flex-1 max-w-md\">\n          <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n          <Input\n            type=\"search\"\n            placeholder=\"Search tasks...\"\n            className=\"pl-9\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            data-testid=\"input-search-tasks\"\n          />\n        </div>\n\n        <Tabs value={viewMode} onValueChange={(v) => setViewMode(v as ViewMode)}>\n          <TabsList>\n            <TabsTrigger value=\"list\" data-testid=\"tab-view-list\"><List className=\"h-4 w-4\" /></TabsTrigger>\n            <TabsTrigger value=\"kanban\" data-testid=\"tab-view-kanban\"><LayoutGrid className=\"h-4 w-4\" /></TabsTrigger>\n            <TabsTrigger value=\"gantt\" data-testid=\"tab-view-gantt\"><GanttChartSquare className=\"h-4 w-4\" /></TabsTrigger>\n            <TabsTrigger value=\"calendar\" data-testid=\"tab-view-calendar\"><CalendarIcon className=\"h-4 w-4\" /></TabsTrigger>\n          </TabsList>\n        </Tabs>\n\n        {viewMode === \"gantt\" && (\n          <div className=\"flex items-center gap-2\">\n            <Button variant=\"outline\" size=\"icon\" onClick={handleZoomIn} disabled={zoom === \"week\"} data-testid=\"button-zoom-in\"><ZoomIn className=\"h-4 w-4\" /></Button>\n            <Badge variant=\"secondary\" className=\"px-3\">{ZOOM_CONFIGS[zoom].unitLabel}</Badge>\n            <Button variant=\"outline\" size=\"icon\" onClick={handleZoomOut} disabled={zoom === \"quarter\"} data-testid=\"button-zoom-out\"><ZoomOut className=\"h-4 w-4\" /></Button>\n          </div>\n        )}\n\n        {viewMode === \"calendar\" && (\n          <div className=\"flex items-center gap-2\">\n            <Button variant=\"outline\" size=\"sm\" onClick={goToToday} data-testid=\"button-today\">Today</Button>\n            <Button variant=\"outline\" size=\"icon\" onClick={goToPrevMonth} data-testid=\"button-prev-month\"><ChevronLeft className=\"h-4 w-4\" /></Button>\n            <div className=\"px-4 font-semibold min-w-[180px] text-center\">{monthName}</div>\n            <Button variant=\"outline\" size=\"icon\" onClick={goToNextMonth} data-testid=\"button-next-month\"><ChevronRight className=\"h-4 w-4\" /></Button>\n          </div>\n        )}\n\n        <Popover open={filterOpen} onOpenChange={setFilterOpen}>\n          <PopoverTrigger asChild>\n            <Button variant=\"outline\" size=\"icon\" className=\"relative\" data-testid=\"button-filter\">\n              <Filter className=\"h-4 w-4\" />\n              {activeFilterCount > 0 && (\n                <span className=\"absolute -top-1 -right-1 h-4 w-4 rounded-full bg-primary text-[10px] font-medium text-primary-foreground flex items-center justify-center\">\n                  {activeFilterCount}\n                </span>\n              )}\n            </Button>\n          </PopoverTrigger>\n          <PopoverContent className=\"w-80\" align=\"end\">\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <h4 className=\"font-semibold\">Filters</h4>\n                {activeFilterCount > 0 && (\n                  <Button variant=\"ghost\" size=\"sm\" onClick={clearFilters} data-testid=\"button-clear-filters\">\n                    <X className=\"h-3 w-3 mr-1\" />Clear All\n                  </Button>\n                )}\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label className=\"text-sm font-medium\">Status</Label>\n                <div className=\"grid grid-cols-2 gap-2\">\n                  {KANBAN_COLUMNS.map((col) => (\n                    <div key={col.id} className=\"flex items-center gap-2\">\n                      <Checkbox \n                        id={`status-${col.id}`}\n                        checked={statusFilters.includes(col.id)}\n                        onCheckedChange={() => toggleStatusFilter(col.id)}\n                        data-testid={`filter-status-${col.id}`}\n                      />\n                      <Label htmlFor={`status-${col.id}`} className=\"text-sm font-normal cursor-pointer\">{col.title}</Label>\n                    </div>\n                  ))}\n                  <div className=\"flex items-center gap-2\">\n                    <Checkbox \n                      id=\"status-on-hold\"\n                      checked={statusFilters.includes(\"on-hold\")}\n                      onCheckedChange={() => toggleStatusFilter(\"on-hold\")}\n                      data-testid=\"filter-status-on-hold\"\n                    />\n                    <Label htmlFor=\"status-on-hold\" className=\"text-sm font-normal cursor-pointer\">On Hold</Label>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label className=\"text-sm font-medium\">Priority</Label>\n                <div className=\"grid grid-cols-2 gap-2\">\n                  {[\"critical\", \"high\", \"medium\", \"low\"].map((priority) => (\n                    <div key={priority} className=\"flex items-center gap-2\">\n                      <Checkbox \n                        id={`priority-${priority}`}\n                        checked={priorityFilters.includes(priority)}\n                        onCheckedChange={() => togglePriorityFilter(priority)}\n                        data-testid={`filter-priority-${priority}`}\n                      />\n                      <Label htmlFor={`priority-${priority}`} className=\"text-sm font-normal cursor-pointer capitalize\">{priority}</Label>\n                    </div>\n                  ))}\n                </div>\n              </div>\n\n              {uniqueDisciplines.length > 0 && (\n                <div className=\"space-y-2\">\n                  <Label className=\"text-sm font-medium\">Discipline</Label>\n                  <div className=\"grid grid-cols-2 gap-2 max-h-32 overflow-y-auto\">\n                    {uniqueDisciplines.map((discipline) => (\n                      <div key={discipline} className=\"flex items-center gap-2\">\n                        <Checkbox \n                          id={`discipline-${discipline}`}\n                          checked={disciplineFilters.includes(discipline)}\n                          onCheckedChange={() => toggleDisciplineFilter(discipline)}\n                          data-testid={`filter-discipline-${discipline}`}\n                        />\n                        <Label htmlFor={`discipline-${discipline}`} className=\"text-sm font-normal cursor-pointer truncate\">{discipline}</Label>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              <div className=\"space-y-2\">\n                <Label className=\"text-sm font-medium\">Date Range</Label>\n                <div className=\"grid grid-cols-2 gap-2\">\n                  <div>\n                    <Label className=\"text-xs text-muted-foreground\">Start After</Label>\n                    <Input \n                      type=\"date\"\n                      value={dateRangeStart}\n                      onChange={(e) => setDateRangeStart(e.target.value)}\n                      className=\"h-8 text-sm\"\n                      data-testid=\"filter-date-start\"\n                    />\n                  </div>\n                  <div>\n                    <Label className=\"text-xs text-muted-foreground\">End Before</Label>\n                    <Input \n                      type=\"date\"\n                      value={dateRangeEnd}\n                      onChange={(e) => setDateRangeEnd(e.target.value)}\n                      className=\"h-8 text-sm\"\n                      data-testid=\"filter-date-end\"\n                    />\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"pt-2 border-t text-xs text-muted-foreground\">\n                Showing {filteredTasks.length} of {tasks.length} tasks\n              </div>\n            </div>\n          </PopoverContent>\n        </Popover>\n      </div>\n\n      {selectedTasks.length > 0 && (\n        <div className=\"flex items-center gap-2 p-3 bg-muted rounded-lg\">\n          <span className=\"text-sm font-medium\">{selectedTasks.length} selected</span>\n          <Button variant=\"outline\" size=\"sm\" data-testid=\"button-bulk-edit\">Bulk Edit</Button>\n          <Button variant=\"outline\" size=\"sm\" data-testid=\"button-bulk-delete\">Delete</Button>\n        </div>\n      )}\n\n      {viewMode === \"list\" && (\n        filteredTasks.length === 0 ? (\n          <div className=\"text-center py-12\">\n            <h2 className=\"text-2xl font-semibold mb-2\">No Tasks Found</h2>\n            <p className=\"text-muted-foreground mb-4\">Get started by creating your first task</p>\n            <Button onClick={() => handleAddTask()} data-testid=\"button-create-first-task\">Create Task</Button>\n          </div>\n        ) : (\n          <div className=\"space-y-2\">{rootTasks.map(task => renderListTask(task))}</div>\n        )\n      )}\n\n      {viewMode === \"kanban\" && (\n        <div className=\"grid grid-cols-4 gap-4 min-h-[500px]\">\n          {KANBAN_COLUMNS.map((column) => (\n            <div \n              key={column.id} \n              className=\"flex flex-col min-h-[400px]\"\n              onDragOver={handleDragOver}\n              onDrop={(e) => handleDrop(e, column.id)}\n              data-testid={`column-${column.id}`}\n            >\n              <div className=\"flex items-center justify-between mb-3\">\n                <div className=\"flex items-center gap-2\">\n                  <h3 className=\"font-semibold\">{column.title}</h3>\n                  <Badge variant=\"secondary\" data-testid={`count-${column.id}`}>{groupedTasks[column.id].length}</Badge>\n                </div>\n              </div>\n              <div className=\"space-y-3 flex-1 overflow-y-auto\">\n                {groupedTasks[column.id].map((task) => (\n                  <Card\n                    key={task.id}\n                    className={`cursor-grab active:cursor-grabbing hover-elevate active-elevate-2 transition-all ${draggedTaskId === task.id ? \"opacity-50\" : \"\"}`}\n                    draggable\n                    onDragStart={(e) => handleDragStart(e, task.id)}\n                    onDragEnd={handleDragEnd}\n                    onClick={() => handleEditTask(task)}\n                    data-testid={`kanban-card-${task.id}`}\n                  >\n                    <CardContent className=\"p-4 space-y-3\">\n                      <div className=\"flex items-start justify-between gap-2\">\n                        <Badge variant=\"outline\" className=\"font-mono text-xs\" data-testid={`task-code-${task.id}`}>{task.wbsCode || `T-${task.id}`}</Badge>\n                        {isOverdue(task) && <AlertTriangle className=\"h-4 w-4 text-destructive\" />}\n                      </div>\n                      <h4 className=\"font-medium text-sm leading-tight\" data-testid={`task-name-${task.id}`}>{task.name}</h4>\n                      {task.progress !== undefined && task.progress > 0 && (\n                        <div className=\"space-y-1\">\n                          <div className=\"flex justify-between text-xs text-muted-foreground\"><span>Progress</span><span>{task.progress}%</span></div>\n                          <Progress value={task.progress} className=\"h-1.5\" />\n                        </div>\n                      )}\n                      <div className=\"flex items-center justify-between\">\n                        <Badge variant={task.priority === \"critical\" ? \"destructive\" : task.priority === \"high\" ? \"default\" : \"outline\"} className=\"text-xs\">{task.priority}</Badge>\n                        <div className=\"flex items-center gap-2\">\n                          {task.endDate && (\n                            <div className=\"flex items-center gap-1 text-xs text-muted-foreground\">\n                              <Clock className=\"h-3 w-3\" />\n                              {new Date(task.endDate).toLocaleDateString()}\n                            </div>\n                          )}\n                          {task.assignedTo && (\n                            <Avatar className=\"h-6 w-6\"><AvatarFallback className=\"text-xs\">{getInitials(task.assignedTo)}</AvatarFallback></Avatar>\n                          )}\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                ))}\n                <Button variant=\"outline\" className=\"w-full border-dashed\" onClick={() => handleAddTask(column.id)} data-testid={`button-add-card-${column.id}`}>\n                  <Plus className=\"h-4 w-4 mr-2\" />Add Task\n                </Button>\n              </div>\n            </div>\n          ))}\n        </div>\n      )}\n\n      {viewMode === \"gantt\" && (\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-lg\">Project Timeline ({filteredTasks.length} tasks)</CardTitle>\n          </CardHeader>\n          <CardContent>\n            {filteredTasks.length === 0 ? (\n              <div className=\"text-center py-12\">\n                <h2 className=\"text-xl font-semibold mb-2\">No Tasks Yet</h2>\n                <p className=\"text-muted-foreground\">Create tasks with start and end dates to see them on the Gantt chart</p>\n              </div>\n            ) : (\n              <div className=\"overflow-x-auto\">\n                <div className=\"min-w-[1000px]\">\n                  <div className=\"grid grid-cols-12 gap-px mb-4 bg-border rounded-lg overflow-hidden\">\n                    <div className=\"col-span-3 bg-muted p-3 font-semibold text-sm\">Task</div>\n                    <div className=\"col-span-9 bg-muted\">\n                      <div className=\"grid text-center text-sm font-semibold\" style={{ gridTemplateColumns: `repeat(${Math.min(units, 12)}, 1fr)` }}>\n                        {getUnitLabels().slice(0, 12).map((label, i) => (\n                          <div key={i} className=\"p-3 border-l border-border\">{label}</div>\n                        ))}\n                      </div>\n                    </div>\n                  </div>\n                  <div className=\"space-y-1\">{rootTasks.map(task => renderGanttTask(task))}</div>\n                  <div className=\"mt-6 p-4 bg-muted/50 rounded-lg\">\n                    <h3 className=\"text-sm font-semibold mb-3\">Legend</h3>\n                    <div className=\"flex flex-wrap items-center gap-4 text-sm\">\n                      <div className=\"flex items-center gap-2\"><div className=\"w-4 h-4 rounded bg-green-500\" /><span>Completed</span></div>\n                      <div className=\"flex items-center gap-2\"><div className=\"w-4 h-4 rounded bg-blue-500\" /><span>In Progress</span></div>\n                      <div className=\"flex items-center gap-2\"><div className=\"w-4 h-4 rounded bg-purple-500\" /><span>In Review</span></div>\n                      <div className=\"flex items-center gap-2\"><div className=\"w-4 h-4 rounded bg-amber-500\" /><span>On Hold</span></div>\n                      <div className=\"flex items-center gap-2\"><div className=\"w-4 h-4 rounded bg-gray-400\" /><span>Not Started</span></div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      )}\n\n      {viewMode === \"calendar\" && (\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-lg\">Monthly View</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-7 gap-px bg-border rounded-lg overflow-hidden\">\n              {WEEKDAYS.map((day) => (\n                <div key={day} className=\"bg-muted p-3 text-center text-sm font-semibold\">{day}</div>\n              ))}\n              {Array.from({ length: weeks * 7 }).map((_, index) => {\n                const dayNumber = index - startDay + 1;\n                const isValidDay = dayNumber > 0 && dayNumber <= daysInMonth;\n                const isToday = dayNumber === today;\n                const dayTasks = tasksOnDate.get(dayNumber) || [];\n                return (\n                  <div\n                    key={index}\n                    className={cn(\"bg-background p-2 min-h-28\", isToday && \"ring-2 ring-primary ring-inset\", !isValidDay && \"bg-muted/30\")}\n                    data-testid={isValidDay ? `calendar-day-${dayNumber}` : undefined}\n                  >\n                    {isValidDay && (\n                      <>\n                        <div className={cn(\"text-sm font-semibold mb-2\", isToday && \"text-primary\")}>{dayNumber}</div>\n                        <div className=\"space-y-1\">\n                          {dayTasks.slice(0, 3).map((task: any) => (\n                            <div\n                              key={`${task.id}-${task._isStart ? 'start' : 'end'}`}\n                              className={cn(\"text-xs px-1.5 py-0.5 rounded text-white truncate cursor-pointer hover:opacity-80\", getStatusBgColor(task.status))}\n                              title={`${task.name} (${task._isStart ? 'Start' : 'Due'})`}\n                              onClick={() => handleEditTask(task)}\n                              data-testid={`calendar-task-${task.id}`}\n                            >\n                              {task._isStart ? \"▶ \" : \"◼ \"}{task.name}\n                            </div>\n                          ))}\n                          {dayTasks.length > 3 && <div className=\"text-xs text-muted-foreground\">+{dayTasks.length - 3} more</div>}\n                        </div>\n                      </>\n                    )}\n                  </div>\n                );\n              })}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      <TaskModal\n        open={taskModalOpen}\n        onOpenChange={setTaskModalOpen}\n        task={editingTask}\n        defaultStatus={defaultStatus}\n      />\n    </div>\n  );\n}\n","size_bytes":37881},"client/src/components/examples/IssuesPage.tsx":{"content":"import IssuesPage from '@/pages/IssuesPage';\n\nexport default function IssuesPageExample() {\n  return <IssuesPage />;\n}\n","size_bytes":119},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","size_bytes":8605},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","size_bytes":21846},"client/src/pages/IssuesPage.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { TableRowCard } from \"@/components/TableRowCard\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Search, Edit, Trash2, AlertCircle, Calendar, CheckCircle2, AlertTriangle, DollarSign, Clock, Shield, Wrench } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Separator } from \"@/components/ui/separator\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport type { Issue } from \"@shared/schema\";\n\nconst ISSUE_TYPES = [\n  { value: \"design\", label: \"Design\" },\n  { value: \"procurement\", label: \"Procurement\" },\n  { value: \"construction\", label: \"Construction\" },\n  { value: \"commissioning\", label: \"Commissioning\" },\n  { value: \"hse\", label: \"HSE\" },\n  { value: \"quality\", label: \"Quality\" },\n  { value: \"commercial\", label: \"Commercial\" },\n  { value: \"interface\", label: \"Interface\" },\n  { value: \"resource\", label: \"Resource\" },\n];\n\nconst ROOT_CAUSE_CATEGORIES = [\n  { value: \"design-error\", label: \"Design Error\" },\n  { value: \"material-defect\", label: \"Material Defect\" },\n  { value: \"workmanship\", label: \"Workmanship\" },\n  { value: \"equipment-failure\", label: \"Equipment Failure\" },\n  { value: \"communication\", label: \"Communication\" },\n  { value: \"planning\", label: \"Planning\" },\n  { value: \"external-factors\", label: \"External Factors\" },\n  { value: \"unknown\", label: \"Unknown\" },\n];\n\nconst ESCALATION_LEVELS = [\n  { value: \"project\", label: \"Project Level\", description: \"Resolved within project team\" },\n  { value: \"program\", label: \"Program Level\", description: \"Escalated to program management\" },\n  { value: \"executive\", label: \"Executive Level\", description: \"Requires executive decision\" },\n  { value: \"client\", label: \"Client Level\", description: \"Client involvement required\" },\n];\n\nconst DISCIPLINES = [\n  { value: \"civil\", label: \"Civil\" },\n  { value: \"structural\", label: \"Structural\" },\n  { value: \"mechanical\", label: \"Mechanical\" },\n  { value: \"electrical\", label: \"Electrical\" },\n  { value: \"piping\", label: \"Piping\" },\n  { value: \"instrumentation\", label: \"Instrumentation\" },\n  { value: \"process\", label: \"Process\" },\n  { value: \"hvac\", label: \"HVAC\" },\n  { value: \"architectural\", label: \"Architectural\" },\n  { value: \"general\", label: \"General\" },\n];\n\ninterface IssueFormData {\n  title: string;\n  description: string;\n  priority: \"low\" | \"medium\" | \"high\" | \"critical\";\n  status: \"open\" | \"in-progress\" | \"resolved\" | \"closed\";\n  assignedTo: string;\n  issueType: string;\n  impactCost: boolean;\n  impactSchedule: boolean;\n  impactQuality: boolean;\n  impactSafety: boolean;\n  rootCauseCategory: string;\n  rootCauseAnalysis: string;\n  escalationLevel: string;\n  targetResolutionDate: string;\n  verificationRequired: boolean;\n  resolution: string;\n  discipline: string;\n  areaCode: string;\n}\n\nconst initialFormData: IssueFormData = {\n  title: \"\",\n  description: \"\",\n  priority: \"medium\",\n  status: \"open\",\n  assignedTo: \"\",\n  issueType: \"design\",\n  impactCost: false,\n  impactSchedule: false,\n  impactQuality: false,\n  impactSafety: false,\n  rootCauseCategory: \"\",\n  rootCauseAnalysis: \"\",\n  escalationLevel: \"project\",\n  targetResolutionDate: \"\",\n  verificationRequired: false,\n  resolution: \"\",\n  discipline: \"general\",\n  areaCode: \"\",\n};\n\nexport default function IssuesPage() {\n  const { selectedProjectId } = useProject();\n  const { toast } = useToast();\n  const [dialogOpen, setDialogOpen] = useState(false);\n  const [editingIssue, setEditingIssue] = useState<Issue | null>(null);\n  const [selectedIssues, setSelectedIssues] = useState<number[]>([]);\n  const [formData, setFormData] = useState<IssueFormData>(initialFormData);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  const { \n    data: issues = [], \n    isLoading, \n    error, \n    refetch \n  } = useQuery<Issue[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/issues`],\n    enabled: !!selectedProjectId,\n    retry: 1,\n  });\n\n  const filteredIssues = useMemo(() => {\n    if (!searchQuery) return issues;\n    const query = searchQuery.toLowerCase();\n    return issues.filter(issue => \n      issue.title.toLowerCase().includes(query) ||\n      issue.description?.toLowerCase().includes(query) ||\n      issue.code?.toLowerCase().includes(query)\n    );\n  }, [issues, searchQuery]);\n\n  const createMutation = useMutation({\n    mutationFn: async (data: IssueFormData) => {\n      if (!selectedProjectId) throw new Error(\"No project selected\");\n      const payload = {\n        ...data,\n        projectId: selectedProjectId,\n        rootCauseCategory: data.rootCauseCategory || null,\n        targetResolutionDate: data.targetResolutionDate || null,\n        discipline: data.discipline || null,\n        areaCode: data.areaCode || null,\n      };\n      await apiRequest(\"POST\", \"/api/issues\", payload);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${selectedProjectId}/issues`] });\n      setDialogOpen(false);\n      setEditingIssue(null);\n      resetForm();\n      toast({ title: \"Success\", description: \"Issue reported successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: number; data: IssueFormData }) => {\n      const payload = {\n        ...data,\n        rootCauseCategory: data.rootCauseCategory || null,\n        targetResolutionDate: data.targetResolutionDate || null,\n        discipline: data.discipline || null,\n        areaCode: data.areaCode || null,\n      };\n      await apiRequest(\"PATCH\", `/api/issues/${id}`, payload);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${selectedProjectId}/issues`] });\n      setDialogOpen(false);\n      setEditingIssue(null);\n      resetForm();\n      toast({ title: \"Success\", description: \"Issue updated successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: number) => {\n      await apiRequest(\"DELETE\", `/api/issues/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${selectedProjectId}/issues`] });\n      toast({ title: \"Success\", description: \"Issue deleted successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData(initialFormData);\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (editingIssue) {\n      updateMutation.mutate({ id: editingIssue.id, data: formData });\n    } else {\n      createMutation.mutate(formData);\n    }\n  };\n\n  const handleEdit = (issue: Issue) => {\n    setEditingIssue(issue);\n    setFormData({\n      title: issue.title,\n      description: issue.description || \"\",\n      priority: issue.priority as IssueFormData[\"priority\"],\n      status: issue.status as IssueFormData[\"status\"],\n      assignedTo: issue.assignedTo || \"\",\n      issueType: issue.issueType || \"design\",\n      impactCost: issue.impactCost || false,\n      impactSchedule: issue.impactSchedule || false,\n      impactQuality: issue.impactQuality || false,\n      impactSafety: issue.impactSafety || false,\n      rootCauseCategory: issue.rootCauseCategory || \"\",\n      rootCauseAnalysis: issue.rootCauseAnalysis || \"\",\n      escalationLevel: issue.escalationLevel || \"project\",\n      targetResolutionDate: issue.targetResolutionDate ? new Date(issue.targetResolutionDate).toISOString().split('T')[0] : \"\",\n      verificationRequired: issue.verificationRequired || false,\n      resolution: issue.resolution || \"\",\n      discipline: issue.discipline || \"general\",\n      areaCode: issue.areaCode || \"\",\n    });\n    setDialogOpen(true);\n  };\n\n  const handleDelete = (id: number) => {\n    if (window.confirm(\"Are you sure you want to delete this issue?\")) {\n      deleteMutation.mutate(id);\n    }\n  };\n\n  const handleAddNew = () => {\n    setEditingIssue(null);\n    resetForm();\n    setDialogOpen(true);\n  };\n\n  const getPriorityVariant = (priority: string) => {\n    switch (priority) {\n      case \"critical\": return \"destructive\" as const;\n      case \"high\": return \"default\" as const;\n      case \"medium\": return \"secondary\" as const;\n      default: return \"outline\" as const;\n    }\n  };\n\n  const getStatusVariant = (status: string) => {\n    switch (status) {\n      case \"open\": return \"destructive\" as const;\n      case \"in-progress\": return \"default\" as const;\n      case \"resolved\": return \"outline\" as const;\n      default: return \"secondary\" as const;\n    }\n  };\n\n  const getImpactIcons = (issue: Issue) => {\n    const impacts = [];\n    if (issue.impactCost) impacts.push({ icon: DollarSign, label: \"Cost\", color: \"text-amber-500\" });\n    if (issue.impactSchedule) impacts.push({ icon: Clock, label: \"Schedule\", color: \"text-blue-500\" });\n    if (issue.impactQuality) impacts.push({ icon: Wrench, label: \"Quality\", color: \"text-purple-500\" });\n    if (issue.impactSafety) impacts.push({ icon: Shield, label: \"Safety\", color: \"text-red-500\" });\n    return impacts;\n  };\n\n  if (!selectedProjectId) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"text-center py-12\">\n          <h2 className=\"text-2xl font-semibold mb-2\">No Project Selected</h2>\n          <p className=\"text-muted-foreground\">Please select a project from the dropdown above</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-4\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-semibold\">Issue Log</h1>\n          <p className=\"text-muted-foreground\">EPC Issue Tracking with Impact Assessment & Root Cause Analysis</p>\n        </div>\n        <Button onClick={handleAddNew} data-testid=\"button-add-issue\">Report Issue</Button>\n      </div>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertDescription className=\"flex items-center justify-between\">\n            <span>Failed to load issues. {(error as Error).message}</span>\n            <Button variant=\"outline\" size=\"sm\" onClick={() => refetch()} data-testid=\"button-retry\">\n              Retry\n            </Button>\n          </AlertDescription>\n        </Alert>\n      )}\n\n      <div className=\"relative max-w-md\">\n        <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n        <Input\n          type=\"search\"\n          placeholder=\"Search issues...\"\n          className=\"pl-9\"\n          value={searchQuery}\n          onChange={(e) => setSearchQuery(e.target.value)}\n          data-testid=\"input-search-issues\"\n        />\n      </div>\n\n      {isLoading ? (\n        <div className=\"text-center py-12\">\n          <p className=\"text-muted-foreground\">Loading issues...</p>\n        </div>\n      ) : filteredIssues.length === 0 ? (\n        <div className=\"text-center py-12\">\n          <h2 className=\"text-2xl font-semibold mb-2\">No Issues Found</h2>\n          <p className=\"text-muted-foreground mb-4\">Get started by reporting issues to your project</p>\n          <Button onClick={handleAddNew} data-testid=\"button-add-first-issue\">Report Issue</Button>\n        </div>\n      ) : (\n        <div className=\"space-y-2\">\n          <div className=\"grid grid-cols-[60px,3fr,1fr,1fr,1fr,1fr,100px,100px] gap-4 px-4 py-2 text-sm font-medium text-muted-foreground border-b\">\n            <div>Code</div>\n            <div>Issue</div>\n            <div>Type</div>\n            <div>Priority</div>\n            <div>Impacts</div>\n            <div>Escalation</div>\n            <div>Status</div>\n            <div>Actions</div>\n          </div>\n          {filteredIssues.map((issue) => {\n            const impacts = getImpactIcons(issue);\n            return (\n              <TableRowCard\n                key={issue.id}\n                id={issue.id.toString()}\n                selected={selectedIssues.includes(issue.id)}\n                onSelect={(selected) => {\n                  setSelectedIssues(prev =>\n                    selected ? [...prev, issue.id] : prev.filter(id => id !== issue.id)\n                  );\n                }}\n                data-testid={`row-issue-${issue.id}`}\n              >\n                <div className=\"grid grid-cols-[60px,3fr,1fr,1fr,1fr,1fr,100px,100px] gap-4 items-center flex-1\">\n                  <div className=\"text-sm font-mono text-muted-foreground\">{issue.code}</div>\n                  <div>\n                    <div className=\"font-medium\">{issue.title}</div>\n                    {issue.description && (\n                      <div className=\"text-sm text-muted-foreground line-clamp-1\">{issue.description}</div>\n                    )}\n                    {issue.discipline && (\n                      <Badge variant=\"outline\" className=\"mt-1 text-xs capitalize\">{issue.discipline}</Badge>\n                    )}\n                  </div>\n                  <Badge variant=\"outline\" className=\"capitalize\">{issue.issueType || \"design\"}</Badge>\n                  <Badge variant={getPriorityVariant(issue.priority)} className=\"capitalize\">\n                    {issue.priority}\n                  </Badge>\n                  <div className=\"flex gap-1\">\n                    {impacts.length > 0 ? (\n                      impacts.map((impact, idx) => (\n                        <span key={idx} title={impact.label}>\n                          <impact.icon className={`h-4 w-4 ${impact.color}`} />\n                        </span>\n                      ))\n                    ) : (\n                      <span className=\"text-muted-foreground text-sm\">-</span>\n                    )}\n                  </div>\n                  <Badge variant=\"secondary\" className=\"capitalize\">{issue.escalationLevel || \"project\"}</Badge>\n                  <Badge variant={getStatusVariant(issue.status)} className=\"capitalize\">\n                    {issue.status.replace(\"-\", \" \")}\n                  </Badge>\n                  <DropdownMenu>\n                    <DropdownMenuTrigger asChild>\n                      <Button variant=\"ghost\" size=\"sm\" data-testid={`button-actions-${issue.id}`}>\n                        Actions\n                      </Button>\n                    </DropdownMenuTrigger>\n                    <DropdownMenuContent align=\"end\">\n                      <DropdownMenuItem onClick={() => handleEdit(issue)}>\n                        <Edit className=\"h-4 w-4 mr-2\" />\n                        Edit\n                      </DropdownMenuItem>\n                      <DropdownMenuItem onClick={() => handleDelete(issue.id)} className=\"text-destructive\">\n                        <Trash2 className=\"h-4 w-4 mr-2\" />\n                        Delete\n                      </DropdownMenuItem>\n                    </DropdownMenuContent>\n                  </DropdownMenu>\n                </div>\n              </TableRowCard>\n            );\n          })}\n        </div>\n      )}\n\n      <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>\n        <DialogContent className=\"max-w-3xl max-h-[90vh] overflow-y-auto\" data-testid=\"dialog-issue\">\n          <DialogHeader>\n            <DialogTitle>{editingIssue ? \"Edit Issue\" : \"Report Issue\"}</DialogTitle>\n          </DialogHeader>\n          <form onSubmit={handleSubmit}>\n            <Tabs defaultValue=\"basic\" className=\"w-full\">\n              <TabsList className=\"grid w-full grid-cols-3\">\n                <TabsTrigger value=\"basic\">Basic Info</TabsTrigger>\n                <TabsTrigger value=\"impact\">Impact Analysis</TabsTrigger>\n                <TabsTrigger value=\"resolution\">Resolution</TabsTrigger>\n              </TabsList>\n\n              <TabsContent value=\"basic\" className=\"space-y-4 mt-4\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"space-y-2 col-span-2\">\n                    <Label htmlFor=\"title\">Issue Title</Label>\n                    <Input\n                      id=\"title\"\n                      value={formData.title}\n                      onChange={(e) => setFormData({ ...formData, title: e.target.value })}\n                      placeholder=\"Brief description of the issue\"\n                      required\n                      data-testid=\"input-issue-title\"\n                    />\n                  </div>\n\n                  <div className=\"space-y-2 col-span-2\">\n                    <Label htmlFor=\"description\">Description</Label>\n                    <Textarea\n                      id=\"description\"\n                      value={formData.description}\n                      onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                      placeholder=\"Detailed description of the issue, when it was discovered, and current situation\"\n                      rows={3}\n                      data-testid=\"input-issue-description\"\n                    />\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"issueType\">Issue Type</Label>\n                    <Select\n                      value={formData.issueType}\n                      onValueChange={(value) => setFormData({ ...formData, issueType: value })}\n                    >\n                      <SelectTrigger data-testid=\"select-issue-type\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {ISSUE_TYPES.map((type) => (\n                          <SelectItem key={type.value} value={type.value}>{type.label}</SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"discipline\">Discipline</Label>\n                    <Select\n                      value={formData.discipline}\n                      onValueChange={(value) => setFormData({ ...formData, discipline: value })}\n                    >\n                      <SelectTrigger data-testid=\"select-issue-discipline\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {DISCIPLINES.map((disc) => (\n                          <SelectItem key={disc.value} value={disc.value}>{disc.label}</SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"priority\">Priority</Label>\n                    <Select\n                      value={formData.priority}\n                      onValueChange={(value: IssueFormData[\"priority\"]) => setFormData({ ...formData, priority: value })}\n                    >\n                      <SelectTrigger data-testid=\"select-issue-priority\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"low\">Low</SelectItem>\n                        <SelectItem value=\"medium\">Medium</SelectItem>\n                        <SelectItem value=\"high\">High</SelectItem>\n                        <SelectItem value=\"critical\">Critical</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"status\">Status</Label>\n                    <Select\n                      value={formData.status}\n                      onValueChange={(value: IssueFormData[\"status\"]) => setFormData({ ...formData, status: value })}\n                    >\n                      <SelectTrigger data-testid=\"select-issue-status\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"open\">Open</SelectItem>\n                        <SelectItem value=\"in-progress\">In Progress</SelectItem>\n                        <SelectItem value=\"resolved\">Resolved</SelectItem>\n                        <SelectItem value=\"closed\">Closed</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"areaCode\">Area/Zone Code</Label>\n                    <Input\n                      id=\"areaCode\"\n                      value={formData.areaCode}\n                      onChange={(e) => setFormData({ ...formData, areaCode: e.target.value })}\n                      placeholder=\"e.g., AREA-100, ZONE-A\"\n                      data-testid=\"input-issue-area\"\n                    />\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"assignedTo\">Assigned To</Label>\n                    <Input\n                      id=\"assignedTo\"\n                      value={formData.assignedTo}\n                      onChange={(e) => setFormData({ ...formData, assignedTo: e.target.value })}\n                      placeholder=\"Person responsible for resolution\"\n                      data-testid=\"input-issue-assigned\"\n                    />\n                  </div>\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"impact\" className=\"space-y-4 mt-4\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"col-span-2\">\n                    <Label className=\"mb-3 block\">Impact Assessment</Label>\n                    <div className=\"grid grid-cols-2 gap-4 p-4 bg-muted rounded-lg\">\n                      <div className=\"flex items-center space-x-3\">\n                        <Checkbox\n                          id=\"impactCost\"\n                          checked={formData.impactCost}\n                          onCheckedChange={(checked) => setFormData({ ...formData, impactCost: !!checked })}\n                          data-testid=\"checkbox-impact-cost\"\n                        />\n                        <Label htmlFor=\"impactCost\" className=\"flex items-center gap-2 cursor-pointer\">\n                          <DollarSign className=\"h-4 w-4 text-amber-500\" />\n                          Cost Impact\n                        </Label>\n                      </div>\n\n                      <div className=\"flex items-center space-x-3\">\n                        <Checkbox\n                          id=\"impactSchedule\"\n                          checked={formData.impactSchedule}\n                          onCheckedChange={(checked) => setFormData({ ...formData, impactSchedule: !!checked })}\n                          data-testid=\"checkbox-impact-schedule\"\n                        />\n                        <Label htmlFor=\"impactSchedule\" className=\"flex items-center gap-2 cursor-pointer\">\n                          <Clock className=\"h-4 w-4 text-blue-500\" />\n                          Schedule Impact\n                        </Label>\n                      </div>\n\n                      <div className=\"flex items-center space-x-3\">\n                        <Checkbox\n                          id=\"impactQuality\"\n                          checked={formData.impactQuality}\n                          onCheckedChange={(checked) => setFormData({ ...formData, impactQuality: !!checked })}\n                          data-testid=\"checkbox-impact-quality\"\n                        />\n                        <Label htmlFor=\"impactQuality\" className=\"flex items-center gap-2 cursor-pointer\">\n                          <Wrench className=\"h-4 w-4 text-purple-500\" />\n                          Quality Impact\n                        </Label>\n                      </div>\n\n                      <div className=\"flex items-center space-x-3\">\n                        <Checkbox\n                          id=\"impactSafety\"\n                          checked={formData.impactSafety}\n                          onCheckedChange={(checked) => setFormData({ ...formData, impactSafety: !!checked })}\n                          data-testid=\"checkbox-impact-safety\"\n                        />\n                        <Label htmlFor=\"impactSafety\" className=\"flex items-center gap-2 cursor-pointer\">\n                          <Shield className=\"h-4 w-4 text-red-500\" />\n                          Safety Impact\n                        </Label>\n                      </div>\n                    </div>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"escalationLevel\">Escalation Level</Label>\n                    <Select\n                      value={formData.escalationLevel}\n                      onValueChange={(value) => setFormData({ ...formData, escalationLevel: value })}\n                    >\n                      <SelectTrigger data-testid=\"select-issue-escalation\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {ESCALATION_LEVELS.map((level) => (\n                          <SelectItem key={level.value} value={level.value}>\n                            <div className=\"flex flex-col\">\n                              <span>{level.label}</span>\n                              <span className=\"text-xs text-muted-foreground\">{level.description}</span>\n                            </div>\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"targetResolutionDate\">\n                      <Calendar className=\"inline h-4 w-4 mr-1\" />\n                      Target Resolution Date\n                    </Label>\n                    <Input\n                      id=\"targetResolutionDate\"\n                      type=\"date\"\n                      value={formData.targetResolutionDate}\n                      onChange={(e) => setFormData({ ...formData, targetResolutionDate: e.target.value })}\n                      data-testid=\"input-issue-target-date\"\n                    />\n                  </div>\n\n                  <Separator className=\"col-span-2\" />\n\n                  <div className=\"col-span-2\">\n                    <h4 className=\"font-medium mb-3 flex items-center gap-2\">\n                      <AlertTriangle className=\"h-4 w-4\" />\n                      Root Cause Analysis\n                    </h4>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"rootCauseCategory\">Root Cause Category</Label>\n                    <Select\n                      value={formData.rootCauseCategory}\n                      onValueChange={(value) => setFormData({ ...formData, rootCauseCategory: value })}\n                    >\n                      <SelectTrigger data-testid=\"select-issue-root-cause\">\n                        <SelectValue placeholder=\"Select category...\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {ROOT_CAUSE_CATEGORIES.map((cat) => (\n                          <SelectItem key={cat.value} value={cat.value}>{cat.label}</SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div className=\"space-y-2 col-span-2\">\n                    <Label htmlFor=\"rootCauseAnalysis\">Root Cause Analysis (5 Whys)</Label>\n                    <Textarea\n                      id=\"rootCauseAnalysis\"\n                      value={formData.rootCauseAnalysis}\n                      onChange={(e) => setFormData({ ...formData, rootCauseAnalysis: e.target.value })}\n                      placeholder=\"Document the 5 Whys analysis or other root cause investigation\"\n                      rows={4}\n                      data-testid=\"input-issue-root-analysis\"\n                    />\n                  </div>\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"resolution\" className=\"space-y-4 mt-4\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"space-y-2 col-span-2\">\n                    <Label htmlFor=\"resolution\">Resolution / Corrective Action</Label>\n                    <Textarea\n                      id=\"resolution\"\n                      value={formData.resolution}\n                      onChange={(e) => setFormData({ ...formData, resolution: e.target.value })}\n                      placeholder=\"Describe the actions taken to resolve this issue\"\n                      rows={4}\n                      data-testid=\"input-issue-resolution\"\n                    />\n                  </div>\n\n                  <div className=\"col-span-2 p-4 bg-muted rounded-lg\">\n                    <div className=\"flex items-center space-x-3\">\n                      <Checkbox\n                        id=\"verificationRequired\"\n                        checked={formData.verificationRequired}\n                        onCheckedChange={(checked) => setFormData({ ...formData, verificationRequired: !!checked })}\n                        data-testid=\"checkbox-verification-required\"\n                      />\n                      <Label htmlFor=\"verificationRequired\" className=\"flex items-center gap-2 cursor-pointer\">\n                        <CheckCircle2 className=\"h-4 w-4\" />\n                        Verification Required\n                        <span className=\"text-muted-foreground text-sm\">(Does the fix require independent verification?)</span>\n                      </Label>\n                    </div>\n                  </div>\n                </div>\n              </TabsContent>\n            </Tabs>\n\n            <DialogFooter className=\"mt-6\">\n              <Button type=\"button\" variant=\"outline\" onClick={() => setDialogOpen(false)}>\n                Cancel\n              </Button>\n              <Button\n                type=\"submit\"\n                disabled={createMutation.isPending || updateMutation.isPending}\n                data-testid=\"button-submit\"\n              >\n                {createMutation.isPending || updateMutation.isPending\n                  ? \"Saving...\"\n                  : editingIssue\n                    ? \"Update Issue\"\n                    : \"Report Issue\"}\n              </Button>\n            </DialogFooter>\n          </form>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":31450},"client/src/components/TopBar.tsx":{"content":"import { useState, useRef } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Search, Plus, Download, Upload, Bell, Moon, Sun, User, X, Building2, FolderKanban, Settings, LogOut, Mail, Shield, CheckCheck, FileJson, FileText, AlertCircle, Info } from \"lucide-react\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Sheet,\n  SheetContent,\n  SheetHeader,\n  SheetTitle,\n  SheetTrigger,\n} from \"@/components/ui/sheet\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n} from \"@/components/ui/dialog\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { SidebarTrigger } from \"@/components/ui/sidebar\";\nimport { useTheme } from \"@/contexts/ThemeContext\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { Badge } from \"@/components/ui/badge\";\n\ninterface Notification {\n  id: number;\n  title: string;\n  message: string;\n  type: 'info' | 'warning' | 'success';\n  time: string;\n  read: boolean;\n}\n\nexport function TopBar() {\n  const { theme, toggleTheme } = useTheme();\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [, navigate] = useLocation();\n  const [searchOpen, setSearchOpen] = useState(false);\n  const [isExporting, setIsExporting] = useState(false);\n  const [profileOpen, setProfileOpen] = useState(false);\n  const [notificationsOpen, setNotificationsOpen] = useState(false);\n  const [importDialogOpen, setImportDialogOpen] = useState(false);\n  const [importResult, setImportResult] = useState<{ success: boolean; message: string; errors?: string[]; warnings?: string[] } | null>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  \n  const [notifications, setNotifications] = useState<Notification[]>([\n    { id: 1, title: \"Task Assigned\", message: \"You've been assigned to 'Site Preparation'\", type: \"info\", time: \"2 hours ago\", read: false },\n    { id: 2, title: \"Risk Alert\", message: \"High risk 'Weather Delays' requires attention\", type: \"warning\", time: \"5 hours ago\", read: false },\n    { id: 3, title: \"Issue Resolved\", message: \"Issue 'Permit Delay' has been closed\", type: \"success\", time: \"1 day ago\", read: false },\n  ]);\n  \n  const unreadCount = notifications.filter(n => !n.read).length;\n  \n  const markAllRead = () => {\n    setNotifications(prev => prev.map(n => ({ ...n, read: true })));\n    toast({ title: \"Notifications marked as read\" });\n  };\n  \n  const markAsRead = (id: number) => {\n    setNotifications(prev => prev.map(n => n.id === id ? { ...n, read: true } : n));\n  };\n  const {\n    organizations,\n    projects,\n    selectedOrgId,\n    selectedProjectId,\n    setSelectedOrgId,\n    setSelectedProjectId,\n    isLoadingOrgs,\n    isLoadingProjects,\n    orgsError,\n    projectsError,\n  } = useProject();\n\n  const handleLogout = () => {\n    window.location.href = \"/api/logout\";\n  };\n\n  const selectedOrg = organizations.find(o => o.id === selectedOrgId);\n  const selectedProject = projects.find(p => p.id === selectedProjectId);\n\n  const handleExportJSON = async () => {\n    if (!selectedProjectId) {\n      toast({ title: \"Error\", description: \"Please select a project first\", variant: \"destructive\" });\n      return;\n    }\n    setIsExporting(true);\n    try {\n      const response = await fetch(`/api/projects/${selectedProjectId}/export`, { credentials: 'include' });\n      if (!response.ok) throw new Error(\"Export failed\");\n      const data = await response.json();\n      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `${selectedProject?.code || 'project'}_export_${new Date().toISOString().split('T')[0]}.json`;\n      a.click();\n      URL.revokeObjectURL(url);\n      toast({ title: \"Success\", description: \"Project exported successfully\" });\n    } catch (error) {\n      toast({ title: \"Error\", description: \"Failed to export project\", variant: \"destructive\" });\n    } finally {\n      setIsExporting(false);\n    }\n  };\n\n  const handleExportCSV = async () => {\n    if (!selectedProjectId) {\n      toast({ title: \"Error\", description: \"Please select a project first\", variant: \"destructive\" });\n      return;\n    }\n    setIsExporting(true);\n    try {\n      const response = await fetch(`/api/projects/${selectedProjectId}/export?format=csv`, { credentials: 'include' });\n      if (!response.ok) throw new Error(\"Export failed\");\n      const csvData = await response.text();\n      const blob = new Blob([csvData], { type: 'text/csv' });\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `${selectedProject?.code || 'project'}_tasks_${new Date().toISOString().split('T')[0]}.csv`;\n      a.click();\n      URL.revokeObjectURL(url);\n      toast({ title: \"Success\", description: \"Tasks exported as CSV\" });\n    } catch (error) {\n      toast({ title: \"Error\", description: \"Failed to export CSV\", variant: \"destructive\" });\n    } finally {\n      setIsExporting(false);\n    }\n  };\n\n  const handleExportPDF = async () => {\n    if (!selectedProjectId) {\n      toast({ title: \"Error\", description: \"Please select a project first\", variant: \"destructive\" });\n      return;\n    }\n    setIsExporting(true);\n    try {\n      const response = await fetch(`/api/projects/${selectedProjectId}/reports/status`, { credentials: 'include' });\n      if (!response.ok) throw new Error(\"Export failed\");\n      const blob = await response.blob();\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `${selectedProject?.code || 'project'}_status_report_${new Date().toISOString().split('T')[0]}.pdf`;\n      a.click();\n      URL.revokeObjectURL(url);\n      toast({ title: \"Success\", description: \"PDF report downloaded\" });\n    } catch (error) {\n      toast({ title: \"Error\", description: \"Failed to generate PDF report\", variant: \"destructive\" });\n    } finally {\n      setIsExporting(false);\n    }\n  };\n\n  const handleImportJSON = () => {\n    if (!selectedProjectId) {\n      toast({ title: \"Error\", description: \"Please select a project first\", variant: \"destructive\" });\n      return;\n    }\n    setImportResult(null);\n    setImportDialogOpen(true);\n  };\n\n  const handleSelectFile = () => {\n    fileInputRef.current?.click();\n  };\n\n  const handleDownloadTemplate = async () => {\n    try {\n      const response = await fetch('/api/import/template', { credentials: 'include' });\n      if (!response.ok) throw new Error(\"Failed to fetch template\");\n      const data = await response.json();\n      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `import_template.json`;\n      a.click();\n      URL.revokeObjectURL(url);\n      toast({ title: \"Success\", description: \"Template downloaded\" });\n    } catch (error) {\n      toast({ title: \"Error\", description: \"Failed to download template\", variant: \"destructive\" });\n    }\n  };\n\n  const handleDownloadSchema = async () => {\n    try {\n      const response = await fetch('/api/import/schema', { credentials: 'include' });\n      if (!response.ok) throw new Error(\"Failed to fetch schema\");\n      const data = await response.json();\n      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `import_schema.json`;\n      a.click();\n      URL.revokeObjectURL(url);\n      toast({ title: \"Success\", description: \"Schema downloaded - use this with AI tools to generate valid project JSON\" });\n    } catch (error) {\n      toast({ title: \"Error\", description: \"Failed to download schema\", variant: \"destructive\" });\n    }\n  };\n\n  const handleFileChange = async (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file || !selectedProjectId) return;\n    \n    try {\n      const text = await file.text();\n      const data = JSON.parse(text);\n      \n      const response = await fetch(`/api/projects/${selectedProjectId}/import`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        credentials: 'include',\n        body: JSON.stringify(data)\n      });\n      \n      const result = await response.json();\n      \n      if (result.success) {\n        setImportResult({\n          success: true,\n          message: result.message || \"Project data imported successfully\",\n          warnings: result.warnings\n        });\n        toast({ title: \"Success\", description: result.message || \"Project data imported successfully\" });\n      } else {\n        setImportResult({\n          success: false,\n          message: result.message || \"Import failed\",\n          errors: result.errors,\n          warnings: result.warnings\n        });\n        toast({ title: \"Import Issues\", description: `Import completed with ${result.errors?.length || 0} error(s)`, variant: \"destructive\" });\n      }\n    } catch (error: any) {\n      setImportResult({\n        success: false,\n        message: error.message || \"Failed to import project data\",\n        errors: [\"Invalid JSON format or network error\"]\n      });\n      toast({ title: \"Error\", description: \"Failed to import project data\", variant: \"destructive\" });\n    }\n    \n    if (fileInputRef.current) {\n      fileInputRef.current.value = '';\n    }\n  };\n\n  return (\n    <header className=\"flex h-14 md:h-16 items-center gap-2 md:gap-4 border-b bg-background px-2 md:px-4\">\n      <SidebarTrigger data-testid=\"button-sidebar-toggle\" />\n      \n      {/* Mobile: Sheet-based selector */}\n      <Sheet>\n        <SheetTrigger asChild className=\"md:hidden\">\n          <Button variant=\"outline\" size=\"sm\" className=\"gap-1 text-xs max-w-[120px] truncate\" data-testid=\"button-mobile-selector\">\n            <FolderKanban className=\"h-3 w-3 shrink-0\" />\n            <span className=\"truncate\">{selectedProject?.name || \"Select\"}</span>\n          </Button>\n        </SheetTrigger>\n        <SheetContent side=\"top\" className=\"h-auto\">\n          <SheetHeader>\n            <SheetTitle>Select Context</SheetTitle>\n          </SheetHeader>\n          <div className=\"flex flex-col gap-4 py-4\">\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium flex items-center gap-2\">\n                <Building2 className=\"h-4 w-4\" />\n                Organization\n              </label>\n              <Select\n                value={selectedOrgId?.toString() || \"\"}\n                onValueChange={(value) => setSelectedOrgId(parseInt(value))}\n                disabled={isLoadingOrgs || organizations.length === 0 || !!orgsError}\n              >\n                <SelectTrigger data-testid=\"trigger-organization-mobile\">\n                  <SelectValue placeholder={\n                    orgsError ? \"Error\" :\n                    isLoadingOrgs ? \"Loading...\" :\n                    \"Select Organization\"\n                  } />\n                </SelectTrigger>\n                <SelectContent>\n                  {organizations.map((org) => (\n                    <SelectItem key={org.id} value={org.id.toString()}>\n                      {org.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium flex items-center gap-2\">\n                <FolderKanban className=\"h-4 w-4\" />\n                Project\n              </label>\n              <Select\n                value={selectedProjectId?.toString() || \"\"}\n                onValueChange={(value) => setSelectedProjectId(parseInt(value))}\n                disabled={isLoadingProjects || projects.length === 0 || !selectedOrgId || !!projectsError}\n              >\n                <SelectTrigger data-testid=\"trigger-project-mobile\">\n                  <SelectValue placeholder={\n                    projectsError ? \"Error\" :\n                    isLoadingProjects ? \"Loading...\" :\n                    \"Select Project\"\n                  } />\n                </SelectTrigger>\n                <SelectContent>\n                  {projects.map((project) => (\n                    <SelectItem key={project.id} value={project.id.toString()}>\n                      {project.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </SheetContent>\n      </Sheet>\n\n      {/* Desktop: Inline selectors */}\n      <Select\n        value={selectedOrgId?.toString() || \"\"}\n        onValueChange={(value) => setSelectedOrgId(parseInt(value))}\n        disabled={isLoadingOrgs || organizations.length === 0 || !!orgsError}\n        data-testid=\"select-organization\"\n      >\n        <SelectTrigger className=\"hidden md:flex w-48\" data-testid=\"trigger-organization\">\n          <SelectValue placeholder={\n            orgsError ? \"Error loading orgs\" :\n            isLoadingOrgs ? \"Loading...\" :\n            \"Select Organization\"\n          } />\n        </SelectTrigger>\n        <SelectContent>\n          {organizations.map((org) => (\n            <SelectItem key={org.id} value={org.id.toString()}>\n              {org.name}\n            </SelectItem>\n          ))}\n        </SelectContent>\n      </Select>\n\n      <Select\n        value={selectedProjectId?.toString() || \"\"}\n        onValueChange={(value) => setSelectedProjectId(parseInt(value))}\n        disabled={isLoadingProjects || projects.length === 0 || !selectedOrgId || !!projectsError}\n        data-testid=\"select-project\"\n      >\n        <SelectTrigger className=\"hidden md:flex w-56\" data-testid=\"trigger-project\">\n          <SelectValue placeholder={\n            projectsError ? \"Error loading projects\" :\n            isLoadingProjects ? \"Loading...\" :\n            \"Select Project\"\n          } />\n        </SelectTrigger>\n        <SelectContent>\n          {projects.map((project) => (\n            <SelectItem key={project.id} value={project.id.toString()}>\n              {project.name}\n            </SelectItem>\n          ))}\n        </SelectContent>\n      </Select>\n\n      {/* Desktop: Full search bar */}\n      <div className=\"relative hidden md:flex flex-1 max-w-md\">\n        <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n        <Input\n          type=\"search\"\n          placeholder=\"Search tasks, documents, resources...\"\n          className=\"pl-9\"\n          data-testid=\"input-search\"\n        />\n      </div>\n\n      {/* Mobile: Expandable search */}\n      {searchOpen ? (\n        <div className=\"flex md:hidden flex-1 items-center gap-2\">\n          <div className=\"relative flex-1\">\n            <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n            <Input\n              type=\"search\"\n              placeholder=\"Search...\"\n              className=\"pl-9 h-9\"\n              autoFocus\n              data-testid=\"input-search-mobile\"\n            />\n          </div>\n          <Button variant=\"ghost\" size=\"icon\" onClick={() => setSearchOpen(false)} data-testid=\"button-close-search\">\n            <X className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      ) : (\n        <Button variant=\"ghost\" size=\"icon\" className=\"md:hidden\" onClick={() => setSearchOpen(true)} data-testid=\"button-open-search\">\n          <Search className=\"h-4 w-4\" />\n        </Button>\n      )}\n\n      {/* Add button - icon only on mobile */}\n      <DropdownMenu>\n        <DropdownMenuTrigger asChild>\n          <Button variant=\"default\" size=\"icon\" className=\"md:hidden shrink-0\" data-testid=\"button-add-mobile\">\n            <Plus className=\"h-4 w-4\" />\n          </Button>\n        </DropdownMenuTrigger>\n        <DropdownMenuContent align=\"end\" className=\"w-56\">\n          <DropdownMenuLabel>Create New</DropdownMenuLabel>\n          <DropdownMenuSeparator />\n          <DropdownMenuItem data-testid=\"menu-item-new-task\">New Task</DropdownMenuItem>\n          <DropdownMenuItem data-testid=\"menu-item-new-risk\">New Risk</DropdownMenuItem>\n          <DropdownMenuItem data-testid=\"menu-item-new-issue\">New Issue</DropdownMenuItem>\n          <DropdownMenuItem data-testid=\"menu-item-new-change\">Change Request</DropdownMenuItem>\n          <DropdownMenuSeparator />\n          <DropdownMenuItem data-testid=\"menu-item-new-project\">New Project</DropdownMenuItem>\n        </DropdownMenuContent>\n      </DropdownMenu>\n\n      <DropdownMenu>\n        <DropdownMenuTrigger asChild>\n          <Button variant=\"default\" size=\"default\" className=\"hidden md:flex\" data-testid=\"button-add\">\n            <Plus className=\"h-4 w-4 mr-2\" />\n            Add\n          </Button>\n        </DropdownMenuTrigger>\n        <DropdownMenuContent align=\"end\" className=\"w-56\">\n          <DropdownMenuLabel>Create New</DropdownMenuLabel>\n          <DropdownMenuSeparator />\n          <DropdownMenuItem data-testid=\"menu-item-new-task\">New Task</DropdownMenuItem>\n          <DropdownMenuItem data-testid=\"menu-item-new-risk\">New Risk</DropdownMenuItem>\n          <DropdownMenuItem data-testid=\"menu-item-new-issue\">New Issue</DropdownMenuItem>\n          <DropdownMenuItem data-testid=\"menu-item-new-change\">Change Request</DropdownMenuItem>\n          <DropdownMenuSeparator />\n          <DropdownMenuItem data-testid=\"menu-item-new-project\">New Project</DropdownMenuItem>\n        </DropdownMenuContent>\n      </DropdownMenu>\n\n      <input\n        type=\"file\"\n        ref={fileInputRef}\n        onChange={handleFileChange}\n        accept=\".json\"\n        className=\"hidden\"\n        data-testid=\"input-import-file\"\n      />\n      \n      <div className=\"flex items-center gap-1 md:gap-2 ml-auto\">\n        <DropdownMenu>\n          <DropdownMenuTrigger asChild>\n            <Button variant=\"ghost\" size=\"icon\" className=\"hidden md:flex\" disabled={isExporting} data-testid=\"button-import-export\">\n              <Download className=\"h-4 w-4\" />\n            </Button>\n          </DropdownMenuTrigger>\n          <DropdownMenuContent align=\"end\" className=\"w-56\">\n            <DropdownMenuLabel>Import</DropdownMenuLabel>\n            <DropdownMenuItem onClick={handleImportJSON} data-testid=\"menu-item-import-json\">\n              <Upload className=\"h-4 w-4 mr-2\" />\n              Import Project Data\n            </DropdownMenuItem>\n            <DropdownMenuItem onClick={handleDownloadTemplate} data-testid=\"menu-item-download-template\">\n              <FileJson className=\"h-4 w-4 mr-2\" />\n              Download Template\n            </DropdownMenuItem>\n            <DropdownMenuItem onClick={handleDownloadSchema} data-testid=\"menu-item-download-schema\">\n              <FileText className=\"h-4 w-4 mr-2\" />\n              Download AI Schema\n            </DropdownMenuItem>\n            <DropdownMenuSeparator />\n            <DropdownMenuLabel>Export</DropdownMenuLabel>\n            <DropdownMenuItem onClick={handleExportPDF} data-testid=\"menu-item-export-pdf\">\n              <Download className=\"h-4 w-4 mr-2\" />\n              PDF Report\n            </DropdownMenuItem>\n            <DropdownMenuItem onClick={handleExportJSON} data-testid=\"menu-item-export-json\">\n              <Download className=\"h-4 w-4 mr-2\" />\n              JSON Data\n            </DropdownMenuItem>\n            <DropdownMenuItem onClick={handleExportCSV} data-testid=\"menu-item-export-csv\">\n              <Download className=\"h-4 w-4 mr-2\" />\n              CSV Tasks\n            </DropdownMenuItem>\n          </DropdownMenuContent>\n        </DropdownMenu>\n\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          onClick={toggleTheme}\n          data-testid=\"button-theme-toggle\"\n        >\n          {theme === \"light\" ? <Moon className=\"h-4 w-4\" /> : <Sun className=\"h-4 w-4\" />}\n        </Button>\n\n        <Popover open={notificationsOpen} onOpenChange={setNotificationsOpen}>\n          <PopoverTrigger asChild>\n            <Button variant=\"ghost\" size=\"icon\" className=\"relative\" data-testid=\"button-notifications\">\n              <Bell className=\"h-4 w-4\" />\n              {unreadCount > 0 && (\n                <Badge className=\"absolute -top-1 -right-1 h-5 w-5 rounded-full p-0 flex items-center justify-center text-xs\" data-testid=\"badge-notification-count\">\n                  {unreadCount}\n                </Badge>\n              )}\n            </Button>\n          </PopoverTrigger>\n          <PopoverContent align=\"end\" className=\"w-80 p-0\">\n            <div className=\"flex items-center justify-between p-3 border-b\">\n              <h4 className=\"font-semibold text-sm\">Notifications</h4>\n              {unreadCount > 0 && (\n                <Button variant=\"ghost\" size=\"sm\" onClick={markAllRead} className=\"h-auto py-1 px-2 text-xs\" data-testid=\"button-mark-all-read\">\n                  <CheckCheck className=\"h-3 w-3 mr-1\" />\n                  Mark all read\n                </Button>\n              )}\n            </div>\n            <ScrollArea className=\"h-[300px]\">\n              {notifications.length === 0 ? (\n                <div className=\"p-4 text-center text-muted-foreground text-sm\">\n                  No notifications\n                </div>\n              ) : (\n                <div className=\"divide-y\">\n                  {notifications.map((notification) => (\n                    <div\n                      key={notification.id}\n                      className={`p-3 hover-elevate cursor-pointer ${!notification.read ? 'bg-muted/50' : ''}`}\n                      onClick={() => markAsRead(notification.id)}\n                      data-testid={`notification-item-${notification.id}`}\n                    >\n                      <div className=\"flex items-start gap-2\">\n                        <div className={`w-2 h-2 rounded-full mt-1.5 shrink-0 ${\n                          notification.type === 'warning' ? 'bg-amber-500' :\n                          notification.type === 'success' ? 'bg-green-500' : 'bg-blue-500'\n                        }`} />\n                        <div className=\"flex-1 min-w-0\">\n                          <p className=\"font-medium text-sm\">{notification.title}</p>\n                          <p className=\"text-xs text-muted-foreground truncate\">{notification.message}</p>\n                          <p className=\"text-xs text-muted-foreground mt-1\">{notification.time}</p>\n                        </div>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </ScrollArea>\n          </PopoverContent>\n        </Popover>\n\n        <DropdownMenu>\n          <DropdownMenuTrigger asChild>\n            <Button variant=\"ghost\" size=\"icon\" className=\"relative\" data-testid=\"button-profile\">\n              <Avatar className=\"h-7 w-7\">\n                <AvatarImage src={user?.profileImageUrl || undefined} alt={user?.firstName || 'User'} />\n                <AvatarFallback className=\"text-xs\">\n                  {user?.firstName?.[0]}{user?.lastName?.[0]}\n                </AvatarFallback>\n              </Avatar>\n            </Button>\n          </DropdownMenuTrigger>\n          <DropdownMenuContent align=\"end\" className=\"w-56\">\n            <DropdownMenuLabel className=\"font-normal\">\n              <div className=\"flex flex-col space-y-1\">\n                <p className=\"text-sm font-medium\">{user?.firstName} {user?.lastName}</p>\n                <p className=\"text-xs text-muted-foreground\">{user?.email}</p>\n              </div>\n            </DropdownMenuLabel>\n            <DropdownMenuSeparator />\n            <DropdownMenuItem onClick={() => setProfileOpen(true)} data-testid=\"menu-item-profile\">\n              <User className=\"h-4 w-4 mr-2\" />\n              Profile\n            </DropdownMenuItem>\n            <DropdownMenuItem onClick={() => navigate('/settings')} data-testid=\"menu-item-settings\">\n              <Settings className=\"h-4 w-4 mr-2\" />\n              Settings\n            </DropdownMenuItem>\n            <DropdownMenuSeparator />\n            <DropdownMenuItem onClick={handleLogout} data-testid=\"menu-item-logout\">\n              <LogOut className=\"h-4 w-4 mr-2\" />\n              Logout\n            </DropdownMenuItem>\n          </DropdownMenuContent>\n        </DropdownMenu>\n\n        <Dialog open={profileOpen} onOpenChange={setProfileOpen}>\n          <DialogContent className=\"sm:max-w-md\">\n            <DialogHeader>\n              <DialogTitle>Profile</DialogTitle>\n              <DialogDescription>Your account information</DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-4\">\n                <Avatar className=\"h-16 w-16\">\n                  <AvatarImage src={user?.profileImageUrl || undefined} alt={user?.firstName || 'User'} />\n                  <AvatarFallback className=\"text-xl\">\n                    {user?.firstName?.[0]}{user?.lastName?.[0]}\n                  </AvatarFallback>\n                </Avatar>\n                <div>\n                  <h3 className=\"font-semibold text-lg\">{user?.firstName} {user?.lastName}</h3>\n                  <p className=\"text-sm text-muted-foreground flex items-center gap-1\">\n                    <Mail className=\"h-3 w-3\" />\n                    {user?.email}\n                  </p>\n                </div>\n              </div>\n              \n              <div className=\"border rounded-lg p-4 space-y-3\">\n                <h4 className=\"font-medium text-sm flex items-center gap-2\">\n                  <Building2 className=\"h-4 w-4\" />\n                  Organizations\n                </h4>\n                <div className=\"space-y-2\">\n                  {organizations.map(org => (\n                    <div key={org.id} className=\"flex items-center justify-between text-sm\">\n                      <span>{org.name}</span>\n                      <Badge variant=\"outline\" className=\"text-xs\">\n                        <Shield className=\"h-3 w-3 mr-1\" />\n                        Member\n                      </Badge>\n                    </div>\n                  ))}\n                </div>\n              </div>\n              \n              <div className=\"flex justify-end\">\n                <Button variant=\"outline\" onClick={() => setProfileOpen(false)} data-testid=\"button-close-profile\">\n                  Close\n                </Button>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {/* Import Dialog */}\n        <Dialog open={importDialogOpen} onOpenChange={setImportDialogOpen}>\n          <DialogContent className=\"sm:max-w-lg\">\n            <DialogHeader>\n              <DialogTitle>Import Project Data</DialogTitle>\n              <DialogDescription>\n                Import tasks, risks, issues, stakeholders, and costs from a JSON file\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4\">\n              {/* AI Generation Tip */}\n              <div className=\"bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-lg p-3\">\n                <div className=\"flex items-start gap-2\">\n                  <Info className=\"h-4 w-4 text-blue-600 dark:text-blue-400 mt-0.5 shrink-0\" />\n                  <div className=\"text-sm text-blue-800 dark:text-blue-200\">\n                    <strong>Use AI to generate project data:</strong>\n                    <ol className=\"list-decimal list-inside mt-1 space-y-1 text-xs\">\n                      <li>Download the \"AI Schema\" from the dropdown menu</li>\n                      <li>Give the schema to ChatGPT, Claude, or Gemini</li>\n                      <li>Ask it to generate project data following the schema</li>\n                      <li>Import the generated JSON file here</li>\n                    </ol>\n                  </div>\n                </div>\n              </div>\n\n              {/* Quick Actions */}\n              <div className=\"flex gap-2\">\n                <Button variant=\"outline\" size=\"sm\" onClick={handleDownloadTemplate} className=\"flex-1\" data-testid=\"button-download-template\">\n                  <FileJson className=\"h-4 w-4 mr-2\" />\n                  Download Template\n                </Button>\n                <Button variant=\"outline\" size=\"sm\" onClick={handleDownloadSchema} className=\"flex-1\" data-testid=\"button-download-schema\">\n                  <FileText className=\"h-4 w-4 mr-2\" />\n                  Download AI Schema\n                </Button>\n              </div>\n\n              {/* Import Result */}\n              {importResult && (\n                <div className={`rounded-lg p-3 ${importResult.success ? 'bg-green-50 dark:bg-green-950 border border-green-200 dark:border-green-800' : 'bg-red-50 dark:bg-red-950 border border-red-200 dark:border-red-800'}`}>\n                  <div className=\"flex items-start gap-2\">\n                    {importResult.success ? (\n                      <CheckCheck className=\"h-4 w-4 text-green-600 dark:text-green-400 mt-0.5 shrink-0\" />\n                    ) : (\n                      <AlertCircle className=\"h-4 w-4 text-red-600 dark:text-red-400 mt-0.5 shrink-0\" />\n                    )}\n                    <div className=\"flex-1\">\n                      <p className={`text-sm font-medium ${importResult.success ? 'text-green-800 dark:text-green-200' : 'text-red-800 dark:text-red-200'}`}>\n                        {importResult.message}\n                      </p>\n                      {importResult.warnings && importResult.warnings.length > 0 && (\n                        <div className=\"mt-2\">\n                          <p className=\"text-xs font-medium text-amber-700 dark:text-amber-300\">Warnings:</p>\n                          <ul className=\"text-xs text-amber-600 dark:text-amber-400 list-disc list-inside\">\n                            {importResult.warnings.slice(0, 5).map((w, i) => (\n                              <li key={i}>{w}</li>\n                            ))}\n                            {importResult.warnings.length > 5 && (\n                              <li>...and {importResult.warnings.length - 5} more</li>\n                            )}\n                          </ul>\n                        </div>\n                      )}\n                      {importResult.errors && importResult.errors.length > 0 && (\n                        <div className=\"mt-2\">\n                          <p className=\"text-xs font-medium text-red-700 dark:text-red-300\">Errors:</p>\n                          <ul className=\"text-xs text-red-600 dark:text-red-400 list-disc list-inside\">\n                            {importResult.errors.slice(0, 5).map((e, i) => (\n                              <li key={i}>{e}</li>\n                            ))}\n                            {importResult.errors.length > 5 && (\n                              <li>...and {importResult.errors.length - 5} more</li>\n                            )}\n                          </ul>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                </div>\n              )}\n\n              {/* Action Buttons */}\n              <div className=\"flex justify-between pt-2\">\n                <Button variant=\"outline\" onClick={() => setImportDialogOpen(false)} data-testid=\"button-cancel-import\">\n                  {importResult?.success ? 'Close' : 'Cancel'}\n                </Button>\n                <div className=\"flex gap-2\">\n                  {importResult?.success && (\n                    <Button onClick={() => window.location.reload()} data-testid=\"button-reload-page\">\n                      Reload Page\n                    </Button>\n                  )}\n                  <Button onClick={handleSelectFile} data-testid=\"button-select-import-file\">\n                    <Upload className=\"h-4 w-4 mr-2\" />\n                    {importResult ? 'Import Another' : 'Select JSON File'}\n                  </Button>\n                </div>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n      </div>\n    </header>\n  );\n}\n","size_bytes":32819},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","size_bytes":710},"client/src/pages/KanbanPage.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Plus, Clock, AlertTriangle, Loader2 } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { TaskModal } from \"@/components/TaskModal\";\nimport type { Task } from \"@shared/schema\";\n\ntype TaskStatus = \"not-started\" | \"in-progress\" | \"review\" | \"completed\" | \"on-hold\";\n\nconst columns: { id: TaskStatus; title: string }[] = [\n  { id: \"not-started\", title: \"Not Started\" },\n  { id: \"in-progress\", title: \"In Progress\" },\n  { id: \"review\", title: \"In Review\" },\n  { id: \"completed\", title: \"Completed\" },\n];\n\nexport default function KanbanPage() {\n  const { selectedProjectId } = useProject();\n  const { toast } = useToast();\n  const [taskModalOpen, setTaskModalOpen] = useState(false);\n  const [editingTask, setEditingTask] = useState<Task | undefined>();\n  const [defaultStatus, setDefaultStatus] = useState<TaskStatus>(\"not-started\");\n  const [draggedTaskId, setDraggedTaskId] = useState<number | null>(null);\n\n  const { \n    data: tasks = [], \n    isLoading, \n    error \n  } = useQuery<Task[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/tasks`],\n    enabled: !!selectedProjectId,\n    retry: 1,\n  });\n\n  const updateTaskMutation = useMutation({\n    mutationFn: async ({ taskId, status }: { taskId: number; status: TaskStatus }) => {\n      await apiRequest(\"PATCH\", `/api/tasks/${taskId}`, { status });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${selectedProjectId}/tasks`] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to update task status\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const groupedTasks: Record<TaskStatus, Task[]> = {\n    \"not-started\": [],\n    \"in-progress\": [],\n    \"review\": [],\n    \"completed\": [],\n    \"on-hold\": [],\n  };\n\n  tasks.forEach((task) => {\n    if (groupedTasks[task.status as TaskStatus]) {\n      groupedTasks[task.status as TaskStatus].push(task);\n    }\n  });\n\n  const handleDragStart = (e: React.DragEvent, taskId: number) => {\n    setDraggedTaskId(taskId);\n    e.dataTransfer.effectAllowed = \"move\";\n  };\n\n  const handleDragOver = (e: React.DragEvent) => {\n    e.preventDefault();\n    e.dataTransfer.dropEffect = \"move\";\n  };\n\n  const handleDrop = (e: React.DragEvent, targetStatus: TaskStatus) => {\n    e.preventDefault();\n    if (draggedTaskId !== null) {\n      const task = tasks.find(t => t.id === draggedTaskId);\n      if (task && task.status !== targetStatus) {\n        updateTaskMutation.mutate({ taskId: draggedTaskId, status: targetStatus });\n      }\n    }\n    setDraggedTaskId(null);\n  };\n\n  const handleDragEnd = () => {\n    setDraggedTaskId(null);\n  };\n\n  const handleAddTask = (status: TaskStatus) => {\n    setEditingTask(undefined);\n    setDefaultStatus(status);\n    setTaskModalOpen(true);\n  };\n\n  const handleEditTask = (task: Task) => {\n    setEditingTask(task);\n    setTaskModalOpen(true);\n  };\n\n  const getPriorityBadge = (priority: string) => {\n    switch (priority) {\n      case \"critical\":\n        return <Badge variant=\"destructive\" className=\"text-xs\">critical</Badge>;\n      case \"high\":\n        return <Badge variant=\"default\" className=\"text-xs\">high</Badge>;\n      case \"medium\":\n        return <Badge variant=\"secondary\" className=\"text-xs\">medium</Badge>;\n      default:\n        return <Badge variant=\"outline\" className=\"text-xs\">{priority}</Badge>;\n    }\n  };\n\n  const getInitials = (name: string | null) => {\n    if (!name) return \"?\";\n    return name.split(\" \").map(n => n[0]).join(\"\").toUpperCase().slice(0, 2);\n  };\n\n  const isOverdue = (task: Task) => {\n    if (!task.endDate) return false;\n    return new Date(task.endDate) < new Date() && task.status !== \"completed\";\n  };\n\n  if (!selectedProjectId) {\n    return (\n      <div className=\"p-6\">\n        <Alert>\n          <AlertTriangle className=\"h-4 w-4\" />\n          <AlertDescription>\n            Please select a project from the dropdown above to view the Kanban board.\n          </AlertDescription>\n        </Alert>\n      </div>\n    );\n  }\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"p-6\">\n        <Alert variant=\"destructive\">\n          <AlertTriangle className=\"h-4 w-4\" />\n          <AlertDescription>\n            Failed to load tasks. Please try again.\n          </AlertDescription>\n        </Alert>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-4 h-full\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-semibold\" data-testid=\"page-title-kanban\">Kanban Board</h1>\n          <p className=\"text-muted-foreground\">Drag and drop to change task status</p>\n        </div>\n        <Button onClick={() => handleAddTask(\"not-started\")} data-testid=\"button-add-task\">\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Add Task\n        </Button>\n      </div>\n\n      <div className=\"grid grid-cols-4 gap-4 h-[calc(100%-80px)]\">\n        {columns.map((column) => (\n          <div \n            key={column.id} \n            className=\"flex flex-col min-h-[400px]\"\n            onDragOver={handleDragOver}\n            onDrop={(e) => handleDrop(e, column.id)}\n            data-testid={`column-${column.id}`}\n          >\n            <div className=\"flex items-center justify-between mb-3\">\n              <div className=\"flex items-center gap-2\">\n                <h3 className=\"font-semibold\">{column.title}</h3>\n                <Badge variant=\"secondary\" data-testid={`count-${column.id}`}>\n                  {groupedTasks[column.id].length}\n                </Badge>\n              </div>\n            </div>\n\n            <div className=\"space-y-3 flex-1 overflow-y-auto\">\n              {groupedTasks[column.id].map((task) => (\n                <Card\n                  key={task.id}\n                  className={`cursor-grab active:cursor-grabbing hover-elevate active-elevate-2 transition-all ${\n                    draggedTaskId === task.id ? \"opacity-50\" : \"\"\n                  }`}\n                  draggable\n                  onDragStart={(e) => handleDragStart(e, task.id)}\n                  onDragEnd={handleDragEnd}\n                  onClick={() => handleEditTask(task)}\n                  data-testid={`kanban-card-${task.id}`}\n                >\n                  <CardContent className=\"p-4 space-y-3\">\n                    <div className=\"flex items-start justify-between gap-2\">\n                      <Badge variant=\"outline\" className=\"font-mono text-xs\" data-testid={`task-code-${task.id}`}>\n                        {task.wbsCode || `T-${task.id}`}\n                      </Badge>\n                      {isOverdue(task) && (\n                        <AlertTriangle className=\"h-4 w-4 text-destructive\" />\n                      )}\n                    </div>\n\n                    <h4 className=\"font-medium text-sm leading-tight\" data-testid={`task-name-${task.id}`}>\n                      {task.name}\n                    </h4>\n\n                    {task.progress !== undefined && task.progress > 0 && (\n                      <div className=\"space-y-1\">\n                        <div className=\"flex justify-between text-xs text-muted-foreground\">\n                          <span>Progress</span>\n                          <span>{task.progress}%</span>\n                        </div>\n                        <Progress value={task.progress} className=\"h-1.5\" />\n                      </div>\n                    )}\n\n                    <div className=\"flex items-center justify-between\">\n                      {getPriorityBadge(task.priority)}\n\n                      <div className=\"flex items-center gap-2\">\n                        {task.endDate && (\n                          <div className=\"flex items-center gap-1 text-xs text-muted-foreground\">\n                            <Clock className=\"h-3 w-3\" />\n                            {new Date(task.endDate).toLocaleDateString()}\n                          </div>\n                        )}\n                        {task.assignedTo && (\n                          <Avatar className=\"h-6 w-6\">\n                            <AvatarFallback className=\"text-xs\">\n                              {getInitials(task.assignedTo)}\n                            </AvatarFallback>\n                          </Avatar>\n                        )}\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n\n              <Button\n                variant=\"outline\"\n                className=\"w-full border-dashed\"\n                onClick={() => handleAddTask(column.id)}\n                data-testid={`button-add-card-${column.id}`}\n              >\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Add Task\n              </Button>\n            </div>\n          </div>\n        ))}\n      </div>\n\n      <TaskModal\n        open={taskModalOpen}\n        onOpenChange={setTaskModalOpen}\n        task={editingTask}\n        defaultStatus={defaultStatus}\n      />\n    </div>\n  );\n}\n","size_bytes":9732},"client/src/components/examples/TopBar.tsx":{"content":"import { TopBar } from '../TopBar';\nimport { ThemeProvider } from '@/contexts/ThemeContext';\n\nexport default function TopBarExample() {\n  return (\n    <ThemeProvider>\n      <TopBar />\n    </ThemeProvider>\n  );\n}\n","size_bytes":212},"client/src/components/examples/WBSPage.tsx":{"content":"import WBSPage from '@/pages/WBSPage';\n\nexport default function WBSPageExample() {\n  return <WBSPage />;\n}\n","size_bytes":107},"client/src/hooks/useAuth.ts":{"content":"// Based on blueprint:javascript_log_in_with_replit\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { User } from \"@shared/schema\";\n\nexport function useAuth() {\n  const { data: user, isLoading } = useQuery<User>({\n    queryKey: [\"/api/auth/user\"],\n    retry: false,\n  });\n\n  return {\n    user,\n    isLoading,\n    isAuthenticated: !!user,\n  };\n}\n","size_bytes":359},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","size_bytes":565},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","size_bytes":7609},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","size_bytes":166},"client/src/components/examples/CalendarPage.tsx":{"content":"import CalendarPage from '@/pages/CalendarPage';\n\nexport default function CalendarPageExample() {\n  return <CalendarPage />;\n}\n","size_bytes":127},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","size_bytes":1527},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","size_bytes":5128},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","size_bytes":4281},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","size_bytes":2712},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","size_bytes":1753},"client/src/components/TableRowCard.tsx":{"content":"import { Card } from \"@/components/ui/card\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { GripVertical, ChevronRight } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { Badge } from \"@/components/ui/badge\";\n\ninterface TableRowCardProps {\n  id: string;\n  selected?: boolean;\n  onSelect?: (selected: boolean) => void;\n  onClick?: () => void;\n  children: React.ReactNode;\n  expandable?: boolean;\n  expanded?: boolean;\n  onToggleExpand?: () => void;\n  className?: string;\n}\n\nexport function TableRowCard({\n  id,\n  selected,\n  onSelect,\n  onClick,\n  children,\n  expandable,\n  expanded,\n  onToggleExpand,\n  className,\n}: TableRowCardProps) {\n  return (\n    <Card\n      className={cn(\n        \"p-4 mb-2 cursor-pointer hover-elevate active-elevate-2 transition-shadow\",\n        className\n      )}\n      onClick={onClick}\n      data-testid={`row-card-${id}`}\n    >\n      <div className=\"flex items-center gap-3\">\n        <GripVertical className=\"h-4 w-4 text-muted-foreground cursor-grab\" data-testid={`handle-${id}`} />\n        <Checkbox\n          checked={selected}\n          onCheckedChange={onSelect}\n          onClick={(e) => e.stopPropagation()}\n          data-testid={`checkbox-${id}`}\n        />\n        {expandable && (\n          <button\n            onClick={(e) => {\n              e.stopPropagation();\n              onToggleExpand?.();\n            }}\n            className=\"hover-elevate p-1 rounded\"\n            data-testid={`button-expand-${id}`}\n          >\n            <ChevronRight\n              className={cn(\n                \"h-4 w-4 text-muted-foreground transition-transform\",\n                expanded && \"rotate-90\"\n              )}\n            />\n          </button>\n        )}\n        <div className=\"flex-1\">{children}</div>\n      </div>\n    </Card>\n  );\n}\n","size_bytes":1802},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","size_bytes":3021},"design_guidelines.md":{"content":"# Design Guidelines: EPC-Focused PMIS Platform\n\n## Design Approach\n\n**Selected System:** Material Design 3 (Material You) adapted for enterprise productivity\n**Justification:** Information-dense enterprise application requiring robust component patterns, clear hierarchy, and proven usability for complex data visualization and manipulation.\n\n**Key Design Principles:**\n1. Information clarity over decoration\n2. Consistent, predictable interactions\n3. Efficient space utilization for dense data\n4. Professional, trustworthy aesthetic\n5. Scalable component system\n\n---\n\n## Typography\n\n**Font Families:**\n- Primary: Inter (headings, UI labels, buttons)\n- Secondary: Roboto Mono (data tables, numeric values, code)\n\n**Type Scale:**\n- Page Titles: text-3xl font-semibold (30px)\n- Section Headers: text-xl font-semibold (20px)\n- Subsection Headers: text-lg font-medium (18px)\n- Body Text: text-base font-normal (16px)\n- Table Headers: text-sm font-semibold uppercase tracking-wide (14px)\n- Table Data: text-sm font-normal (14px)\n- Helper Text: text-xs font-normal (12px)\n- Metrics/Numbers: text-2xl font-bold tracking-tight (24px)\n\n---\n\n## Layout System\n\n**Three-Panel Architecture:**\n\n**Left Sidebar (Fixed):**\n- Width: w-64 (256px) on desktop, full-width drawer on mobile\n- Pinned navigation tabs with icons and labels\n- Collapsible to w-16 (icon-only mode)\n\n**Top Bar (Fixed):**\n- Height: h-16 (64px)\n- Left to right: Org dropdown → Project dropdown → Tab dropdown → Add+ button → Search (flex-1) → Import/Export → Theme toggle → Notifications → Profile\n\n**Right Sidebar (Contextual):**\n- Width: w-80 (320px) on desktop, slides over on tablet/mobile\n- Tab-specific metrics, mini-charts, quick filters\n- Collapsible to maximize center area\n\n**Center Area (Scrollable):**\n- Padding: p-6 on desktop, p-4 on mobile\n- Max-width: max-w-full (utilizes available space between sidebars)\n\n**Spacing System:**\nUse Tailwind units: **2, 4, 6, 8, 12, 16** for consistent rhythm\n- Component gaps: gap-4 (standard), gap-6 (sections)\n- Section padding: p-6 (desktop), p-4 (mobile)\n- Card padding: p-4 (compact), p-6 (spacious)\n- Stack spacing: space-y-4 (list items), space-y-6 (sections)\n\n---\n\n## Component Library\n\n### Core UI Elements\n\n**Buttons:**\n- Primary: Filled with elevation shadow-sm\n- Secondary: Outlined with border-2\n- Text: No background, underline on hover\n- Icon buttons: Square (w-10 h-10), circular for FABs\n- Sizes: sm (h-8 px-3), md (h-10 px-4), lg (h-12 px-6)\n\n**Input Fields:**\n- Standard height: h-10\n- Border: border-2, focus ring-2 ring-offset-2\n- Labels: text-sm font-medium mb-1\n- Helper text: text-xs mt-1\n\n**Dropdowns:**\n- Trigger height: h-10\n- Menu: rounded-lg shadow-lg border\n- Items: px-4 py-2 hover background change\n\n### Navigation\n\n**Top Bar Dropdowns:**\n- Organization/Project selectors: Searchable with hierarchy tree\n- Tabs dropdown: Grouped by category (Management, Logs, Reports)\n- Add+ menu: Quick actions with keyboard shortcuts displayed\n\n**Left Sidebar:**\n- Active state: Filled background, left border accent (border-l-4)\n- Inactive: Transparent, subtle hover state\n- Icons: w-5 h-5, aligned left with text-sm label\n- Badges: Notification counts on right (rounded-full px-2 text-xs)\n\n### Data Display\n\n**Center Tables (Row Cards):**\n- Card structure: Border, rounded-lg, shadow-sm, p-4, mb-2\n- Draggable handle: Left side, 6-dot grip icon\n- Checkbox: w-5 h-5, mr-4\n- Content grid: grid-cols-12 for flexible column layouts\n- Expand/collapse icon: Right side for nested data\n- Hover: Subtle background lift, shadow-md\n\n**Table Headers:**\n- Sticky positioning: sticky top-0 z-10\n- Background: Solid fill (prevents transparency issues)\n- Sort indicators: Arrows, active column highlighted\n- Column resize: Drag handles between headers\n- Show/hide columns: Dropdown menu with checkboxes\n\n**Gantt Chart:**\n- Timeline header: Dual-row (months + weeks), sticky\n- Task rows: h-12, alternating subtle backgrounds\n- Task bars: Rounded, shadow, with handles for resize/drag\n- Dependencies: SVG lines with arrows, curved connectors\n- Grid lines: Subtle vertical lines for time units\n- Zoom controls: Top-right (zoom in/out, fit to screen)\n\n**Kanban Board:**\n- Columns: min-w-80, max-w-96, vertical scroll\n- Column headers: Sticky, shows count badge\n- Cards: rounded-lg, shadow, p-3, mb-3\n- Drag preview: Opacity-50 with shadow-xl\n- Add card button: Dashed border, full width, at column bottom\n\n**Calendar View:**\n- Month grid: 7 columns (days), dynamic rows\n- Day cells: Aspect-square, border\n- Event chips: Truncated text, rounded-full px-2 py-1 text-xs\n- Multi-day events: Span cells with connecting visual\n- Today indicator: Ring border, bold date\n\n### Forms & Modals\n\n**Center Modals:**\n- Backdrop: Semi-transparent overlay\n- Modal: max-w-2xl (standard), max-w-4xl (complex forms like WBS)\n- Header: Sticky, border-bottom, with close button\n- Body: p-6, max-h-[70vh], overflow-y-auto\n- Footer: Sticky bottom, border-top, button alignment right\n\n**Multi-Step Forms:**\n- Step indicator: Horizontal stepper at top\n- Navigation: Back/Next buttons, Save Draft option\n- Validation: Inline errors, summary at top for submit\n\n**RACI Matrix Input:**\n- Grid layout: Rows (team members), columns (R/A/C/I)\n- Radio/checkbox selection per cell\n- Visual indicators for assigned roles\n\n### Data Visualization\n\n**Dashboards:**\n- Metric cards: Grid (grid-cols-1 md:grid-cols-2 lg:grid-cols-4)\n- Card structure: p-6, rounded-xl, shadow\n- Large number: text-3xl font-bold\n- Label: text-sm, trend indicator (↑↓ with percentage)\n\n**Charts:**\n- Container: rounded-lg, border, p-4\n- Legend: Bottom or right, responsive\n- Tooltips: shadow-lg, rounded, px-3 py-2, text-sm\n\n**Cost Analytics:**\n- Comparison charts: Side-by-side bars (Budget vs Actual vs Forecast)\n- Sparklines: Inline with table rows for trends\n- Variance indicators: Red/green, percentage badges\n\n### Overlays & Feedback\n\n**Notifications (Toast):**\n- Position: top-right, stacked\n- Width: w-96, rounded-lg, shadow-xl, p-4\n- Auto-dismiss: 5 seconds, close button\n- Types: Success, Warning, Error, Info (distinct icons)\n\n**Loading States:**\n- Skeleton screens: Pulse animation for cards/tables\n- Inline spinners: w-5 h-5 for buttons\n- Overlay loader: Full-screen for initial data fetch\n\n**Conflict Resolution UI:**\n- Split view: grid-cols-2 (Your changes | Their changes)\n- Diff highlighting: Added (green bg), removed (red bg)\n- Resolution buttons: Accept theirs, Keep mine, Merge manually\n\n---\n\n## Animations\n\n**Essential Only:**\n- Modal enter/exit: Scale + fade (150ms)\n- Dropdown open/close: Slide + fade (100ms)\n- Drag feedback: Smooth transform (0ms - instant grab)\n- Toast notifications: Slide in from right (200ms)\n- **No decorative animations**, **no scroll-triggered effects**, **no page transitions**\n\n---\n\n## Responsive Behavior\n\n**Breakpoints:**\n- Mobile: < 768px - Single column, stacked layout, drawer navigation\n- Tablet: 768px - 1024px - Collapsible sidebars, 2-column grids\n- Desktop: > 1024px - Full three-panel layout, multi-column grids\n\n**Mobile Adaptations:**\n- Gantt: Horizontal scroll with pinned task names\n- Tables: Vertical cards (stack columns)\n- Modals: Full-screen on mobile\n- Top bar: Hamburger menu, condensed dropdowns\n\n---\n\n## Images\n\n**No hero images** - This is a data-focused enterprise application. Visual assets limited to:\n- Empty state illustrations: Center of tables/lists when no data\n- Onboarding graphics: Multi-step wizard illustrations\n- Error state graphics: 404, offline mode, sync failed\n- Avatar placeholders: User profiles, stakeholder lists\n- File type icons: Document attachments\n\nAll illustrations should be simple, line-art style, professional tone.","size_bytes":7687},"server/routes.ts":{"content":"import type { Express, Request, Response } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport crypto from \"crypto\";\nimport { storage } from \"./storage\";\nimport { setupAuth, isAuthenticated } from \"./replitAuth\";\nimport {\n  insertOrganizationSchema,\n  insertProjectSchema,\n  insertTaskSchema,\n  insertTaskDependencySchema,\n  insertStakeholderSchema,\n  insertStakeholderRaciSchema,\n  updateStakeholderRaciSchema,\n  insertRiskSchema,\n  insertIssueSchema,\n  insertCostItemSchema,\n  updateProjectSchema,\n  updateTaskSchema,\n  updateStakeholderSchema,\n  updateRiskSchema,\n  updateIssueSchema,\n  updateCostItemSchema,\n  insertAiConversationSchema,\n  insertEmailTemplateSchema,\n  updateEmailTemplateSchema\n} from \"@shared/schema\";\nimport { chatWithAssistant, type ChatMessage } from \"./aiAssistant\";\nimport { z } from \"zod\";\nimport {\n  generateRiskRegisterReport,\n  generateProjectStatusReport,\n  generateEVAReport,\n  generateIssueLogReport\n} from \"./pdfReports\";\nimport {\n  sendEmail,\n  replacePlaceholders,\n  getDefaultTemplate,\n  getAllDefaultTemplates,\n  getAvailablePlaceholders\n} from \"./emailService\";\nimport { wsManager } from \"./websocket\";\n\n// Helper to get user ID from request\nfunction getUserId(req: any): string {\n  return req.user.claims.sub;\n}\n\n// Helper to check if user has access to organization\nasync function checkOrganizationAccess(userId: string, organizationId: number): Promise<boolean> {\n  const userOrg = await storage.getUserOrganization(userId, organizationId);\n  return !!userOrg;\n}\n\n// Helper to check if user has access to project (through organization)\nasync function checkProjectAccess(userId: string, projectId: number): Promise<boolean> {\n  const project = await storage.getProject(projectId);\n  if (!project) return false;\n  return await checkOrganizationAccess(userId, project.organizationId);\n}\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  // Auth middleware\n  await setupAuth(app);\n\n  // Auth routes\n  app.get('/api/auth/user', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const user = await storage.getUser(userId);\n      res.json(user);\n    } catch (error) {\n      console.error(\"Error fetching user:\", error);\n      res.status(500).json({ message: \"Failed to fetch user\" });\n    }\n  });\n\n  // ===== Organization Routes =====\n  app.get('/api/organizations', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const organizations = await storage.getOrganizationsByUser(userId);\n      res.json(organizations);\n    } catch (error) {\n      console.error(\"Error fetching organizations:\", error);\n      res.status(500).json({ message: \"Failed to fetch organizations\" });\n    }\n  });\n\n  app.post('/api/organizations', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const data = insertOrganizationSchema.parse(req.body);\n      \n      const organization = await storage.createOrganization(data);\n      \n      // Add user as owner of the organization\n      await storage.createUserOrganization({\n        userId,\n        organizationId: organization.id,\n        role: 'owner',\n      });\n      \n      res.json(organization);\n    } catch (error) {\n      console.error(\"Error creating organization:\", error);\n      res.status(400).json({ message: \"Failed to create organization\" });\n    }\n  });\n\n  // ===== Organization PMO Routes (cross-project aggregation) =====\n  app.get('/api/organizations/:orgId/pmo/dashboard', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const orgId = parseInt(req.params.orgId);\n      \n      if (!await checkOrganizationAccess(userId, orgId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const projects = await storage.getProjectsByOrganization(orgId);\n      const tasks = await storage.getTasksByOrganization(orgId);\n      const risks = await storage.getRisksByOrganization(orgId);\n      const issues = await storage.getIssuesByOrganization(orgId);\n      const costs = await storage.getCostItemsByOrganization(orgId);\n      \n      const totalBudget = projects.reduce((sum, p) => sum + (Number(p.budget) || 0), 0);\n      const actualCost = costs.reduce((sum, c) => sum + (Number(c.actualCost) || 0), 0);\n      \n      res.json({\n        projectCount: projects.length,\n        projects: projects.map(p => ({ id: p.id, name: p.name, status: p.status })),\n        taskStats: {\n          total: tasks.length,\n          completed: tasks.filter(t => t.status === 'completed').length,\n          inProgress: tasks.filter(t => t.status === 'in-progress').length,\n          notStarted: tasks.filter(t => t.status === 'not-started').length,\n          onHold: tasks.filter(t => t.status === 'on-hold').length,\n        },\n        riskStats: {\n          total: risks.length,\n          open: risks.filter(r => r.status === 'open').length,\n          mitigated: risks.filter(r => r.status === 'mitigated').length,\n          closed: risks.filter(r => r.status === 'closed').length,\n          highRisks: risks.filter(r => r.probability === 'high' || r.impact === 'high').length,\n        },\n        issueStats: {\n          total: issues.length,\n          open: issues.filter(i => i.status === 'open').length,\n          inProgress: issues.filter(i => i.status === 'in-progress').length,\n          resolved: issues.filter(i => i.status === 'resolved').length,\n          critical: issues.filter(i => i.priority === 'critical').length,\n        },\n        budgetStats: {\n          totalBudget,\n          actualCost,\n          variance: totalBudget - actualCost,\n          utilizationPercent: totalBudget > 0 ? Math.round((actualCost / totalBudget) * 100) : 0,\n        },\n      });\n    } catch (error) {\n      console.error(\"Error fetching PMO dashboard:\", error);\n      res.status(500).json({ message: \"Failed to fetch PMO dashboard data\" });\n    }\n  });\n\n  app.get('/api/organizations/:orgId/pmo/calendar', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const orgId = parseInt(req.params.orgId);\n      \n      if (!await checkOrganizationAccess(userId, orgId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const tasks = await storage.getTasksByOrganization(orgId);\n      res.json(tasks);\n    } catch (error) {\n      console.error(\"Error fetching PMO calendar:\", error);\n      res.status(500).json({ message: \"Failed to fetch PMO calendar data\" });\n    }\n  });\n\n  app.get('/api/organizations/:orgId/pmo/inventory', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const orgId = parseInt(req.params.orgId);\n      \n      if (!await checkOrganizationAccess(userId, orgId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const resources = await storage.getResourcesByOrganization(orgId);\n      res.json(resources);\n    } catch (error) {\n      console.error(\"Error fetching PMO inventory:\", error);\n      res.status(500).json({ message: \"Failed to fetch PMO inventory data\" });\n    }\n  });\n\n  // ===== Project Routes =====\n  app.get('/api/organizations/:orgId/projects', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const orgId = parseInt(req.params.orgId);\n      \n      // Check access\n      if (!await checkOrganizationAccess(userId, orgId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const projects = await storage.getProjectsByOrganization(orgId);\n      res.json(projects);\n    } catch (error) {\n      console.error(\"Error fetching projects:\", error);\n      res.status(500).json({ message: \"Failed to fetch projects\" });\n    }\n  });\n\n  app.get('/api/projects/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      // Check access\n      if (!await checkProjectAccess(userId, id)) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      const project = await storage.getProject(id);\n      res.json(project);\n    } catch (error) {\n      console.error(\"Error fetching project:\", error);\n      res.status(500).json({ message: \"Failed to fetch project\" });\n    }\n  });\n\n  app.post('/api/projects', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const data = insertProjectSchema.parse(req.body);\n      \n      // Check access to organization\n      if (!await checkOrganizationAccess(userId, data.organizationId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const project = await storage.createProject(data);\n      res.json(project);\n    } catch (error) {\n      console.error(\"Error creating project:\", error);\n      res.status(400).json({ message: \"Failed to create project\" });\n    }\n  });\n\n  app.patch('/api/projects/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      // Check access\n      if (!await checkProjectAccess(userId, id)) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      const data = updateProjectSchema.parse(req.body);\n      const project = await storage.updateProject(id, data);\n      res.json(project);\n    } catch (error) {\n      console.error(\"Error updating project:\", error);\n      res.status(400).json({ message: \"Failed to update project\" });\n    }\n  });\n\n  app.delete('/api/projects/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      // Check access\n      if (!await checkProjectAccess(userId, id)) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      await storage.deleteProject(id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting project:\", error);\n      res.status(500).json({ message: \"Failed to delete project\" });\n    }\n  });\n\n  // ===== Task Routes =====\n  app.get('/api/projects/:projectId/tasks', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      // Check access\n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      const tasks = await storage.getTasksByProject(projectId);\n      res.json(tasks);\n    } catch (error) {\n      console.error(\"Error fetching tasks:\", error);\n      res.status(500).json({ message: \"Failed to fetch tasks\" });\n    }\n  });\n\n  app.get('/api/tasks/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      const task = await storage.getTask(id);\n      if (!task) {\n        return res.status(404).json({ message: \"Task not found\" });\n      }\n      \n      // Check access through project\n      if (!await checkProjectAccess(userId, task.projectId)) {\n        return res.status(404).json({ message: \"Task not found\" });\n      }\n      \n      res.json(task);\n    } catch (error) {\n      console.error(\"Error fetching task:\", error);\n      res.status(500).json({ message: \"Failed to fetch task\" });\n    }\n  });\n\n  app.post('/api/tasks', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const data = insertTaskSchema.parse(req.body);\n      \n      // Check access to project\n      if (!await checkProjectAccess(userId, data.projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const task = await storage.createTask({\n        ...data,\n        createdBy: userId,\n      });\n      \n      // Notify connected clients\n      wsManager.notifyProjectUpdate(task.projectId, \"task-created\", task, userId);\n      \n      res.json(task);\n    } catch (error) {\n      console.error(\"Error creating task:\", error);\n      res.status(400).json({ message: \"Failed to create task\" });\n    }\n  });\n\n  app.patch('/api/tasks/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      const task = await storage.getTask(id);\n      if (!task) {\n        return res.status(404).json({ message: \"Task not found\" });\n      }\n      \n      // Check access\n      if (!await checkProjectAccess(userId, task.projectId)) {\n        return res.status(404).json({ message: \"Task not found\" });\n      }\n      \n      // Convert date strings to Date objects (JSON serializes dates as strings)\n      // Empty strings are treated as null to allow clearing date fields\n      const body = { ...req.body };\n      const normalizeDateField = (value: any): Date | null | undefined => {\n        if (value === null || value === undefined) return value;\n        if (typeof value === 'string') {\n          if (value.trim() === '') return null;\n          return new Date(value);\n        }\n        return value;\n      };\n      \n      if ('startDate' in body) body.startDate = normalizeDateField(body.startDate);\n      if ('endDate' in body) body.endDate = normalizeDateField(body.endDate);\n      if ('constraintDate' in body) body.constraintDate = normalizeDateField(body.constraintDate);\n      if ('earlyStart' in body) body.earlyStart = normalizeDateField(body.earlyStart);\n      if ('earlyFinish' in body) body.earlyFinish = normalizeDateField(body.earlyFinish);\n      if ('lateStart' in body) body.lateStart = normalizeDateField(body.lateStart);\n      if ('lateFinish' in body) body.lateFinish = normalizeDateField(body.lateFinish);\n      \n      const data = updateTaskSchema.parse(body);\n      const updated = await storage.updateTask(id, data);\n      \n      // Notify connected clients\n      wsManager.notifyProjectUpdate(task.projectId, \"task-updated\", updated, userId);\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating task:\", error);\n      res.status(400).json({ message: \"Failed to update task\" });\n    }\n  });\n\n  app.delete('/api/tasks/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      const task = await storage.getTask(id);\n      if (!task) {\n        return res.status(404).json({ message: \"Task not found\" });\n      }\n      \n      // Check access\n      if (!await checkProjectAccess(userId, task.projectId)) {\n        return res.status(404).json({ message: \"Task not found\" });\n      }\n      \n      await storage.deleteTask(id);\n      \n      // Notify connected clients\n      wsManager.notifyProjectUpdate(task.projectId, \"task-deleted\", { id, projectId: task.projectId }, userId);\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting task:\", error);\n      res.status(500).json({ message: \"Failed to delete task\" });\n    }\n  });\n\n  // ===== Task Dependencies Routes =====\n  app.get('/api/projects/:projectId/dependencies', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      // Check access\n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      const dependencies = await storage.getDependenciesByProject(projectId);\n      res.json(dependencies);\n    } catch (error) {\n      console.error(\"Error fetching dependencies:\", error);\n      res.status(500).json({ message: \"Failed to fetch dependencies\" });\n    }\n  });\n\n  app.post('/api/dependencies', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const data = insertTaskDependencySchema.parse(req.body);\n      \n      // Check access to project\n      if (!await checkProjectAccess(userId, data.projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const dependency = await storage.createTaskDependency(data);\n      \n      // Notify connected clients\n      wsManager.notifyProjectUpdate(dependency.projectId, \"dependency-created\", dependency, userId);\n      \n      res.json(dependency);\n    } catch (error) {\n      console.error(\"Error creating dependency:\", error);\n      res.status(400).json({ message: \"Failed to create dependency\" });\n    }\n  });\n\n  app.patch('/api/dependencies/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      const dependency = await storage.getTaskDependency(id);\n      if (!dependency) {\n        return res.status(404).json({ message: \"Dependency not found\" });\n      }\n      \n      // Check access\n      if (!await checkProjectAccess(userId, dependency.projectId)) {\n        return res.status(404).json({ message: \"Dependency not found\" });\n      }\n      \n      const { type, lagDays } = req.body;\n      const updated = await storage.updateTaskDependency(id, { type, lagDays });\n      \n      // Notify connected clients\n      wsManager.notifyProjectUpdate(dependency.projectId, \"dependency-updated\", updated, userId);\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating dependency:\", error);\n      res.status(400).json({ message: \"Failed to update dependency\" });\n    }\n  });\n\n  app.delete('/api/dependencies/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      const dependency = await storage.getTaskDependency(id);\n      if (!dependency) {\n        return res.status(404).json({ message: \"Dependency not found\" });\n      }\n      \n      // Check access\n      if (!await checkProjectAccess(userId, dependency.projectId)) {\n        return res.status(404).json({ message: \"Dependency not found\" });\n      }\n      \n      await storage.deleteTaskDependency(id);\n      \n      // Notify connected clients\n      wsManager.notifyProjectUpdate(dependency.projectId, \"dependency-deleted\", { id, projectId: dependency.projectId }, userId);\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting dependency:\", error);\n      res.status(500).json({ message: \"Failed to delete dependency\" });\n    }\n  });\n\n  // ===== Stakeholder Routes =====\n  app.get('/api/projects/:projectId/stakeholders', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      // Check access\n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      const stakeholders = await storage.getStakeholdersByProject(projectId);\n      res.json(stakeholders);\n    } catch (error) {\n      console.error(\"Error fetching stakeholders:\", error);\n      res.status(500).json({ message: \"Failed to fetch stakeholders\" });\n    }\n  });\n\n  app.post('/api/stakeholders', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const data = insertStakeholderSchema.parse(req.body);\n      \n      // Check access to project\n      if (!await checkProjectAccess(userId, data.projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const stakeholder = await storage.createStakeholder(data);\n      \n      // Notify connected clients\n      wsManager.notifyProjectUpdate(stakeholder.projectId, \"stakeholder-created\", stakeholder, userId);\n      \n      res.json(stakeholder);\n    } catch (error) {\n      console.error(\"Error creating stakeholder:\", error);\n      res.status(400).json({ message: \"Failed to create stakeholder\" });\n    }\n  });\n\n  app.patch('/api/stakeholders/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      const stakeholder = await storage.getStakeholder(id);\n      if (!stakeholder) {\n        return res.status(404).json({ message: \"Stakeholder not found\" });\n      }\n      \n      // Check access\n      if (!await checkProjectAccess(userId, stakeholder.projectId)) {\n        return res.status(404).json({ message: \"Stakeholder not found\" });\n      }\n      \n      const data = updateStakeholderSchema.parse(req.body);\n      const updated = await storage.updateStakeholder(id, data);\n      \n      // Notify connected clients\n      wsManager.notifyProjectUpdate(stakeholder.projectId, \"stakeholder-updated\", updated, userId);\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating stakeholder:\", error);\n      res.status(400).json({ message: \"Failed to update stakeholder\" });\n    }\n  });\n\n  app.delete('/api/stakeholders/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      const stakeholder = await storage.getStakeholder(id);\n      if (!stakeholder) {\n        return res.status(404).json({ message: \"Stakeholder not found\" });\n      }\n      \n      // Check access\n      if (!await checkProjectAccess(userId, stakeholder.projectId)) {\n        return res.status(404).json({ message: \"Stakeholder not found\" });\n      }\n      \n      await storage.deleteStakeholder(id);\n      \n      // Notify connected clients\n      wsManager.notifyProjectUpdate(stakeholder.projectId, \"stakeholder-deleted\", { id, projectId: stakeholder.projectId }, userId);\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting stakeholder:\", error);\n      res.status(500).json({ message: \"Failed to delete stakeholder\" });\n    }\n  });\n\n  // ===== RACI Matrix Routes =====\n  app.get('/api/projects/:projectId/raci', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      // Check access\n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      const raciAssignments = await storage.getStakeholderRaciByProject(projectId);\n      res.json(raciAssignments);\n    } catch (error) {\n      console.error(\"Error fetching RACI assignments:\", error);\n      res.status(500).json({ message: \"Failed to fetch RACI assignments\" });\n    }\n  });\n\n  app.get('/api/tasks/:taskId/raci', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const taskId = parseInt(req.params.taskId);\n      \n      const task = await storage.getTask(taskId);\n      if (!task) {\n        return res.status(404).json({ message: \"Task not found\" });\n      }\n      \n      // Check access\n      if (!await checkProjectAccess(userId, task.projectId)) {\n        return res.status(404).json({ message: \"Task not found\" });\n      }\n      \n      const raciAssignments = await storage.getStakeholderRaciByTask(taskId);\n      res.json(raciAssignments);\n    } catch (error) {\n      console.error(\"Error fetching task RACI assignments:\", error);\n      res.status(500).json({ message: \"Failed to fetch RACI assignments\" });\n    }\n  });\n\n  app.post('/api/raci', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const data = insertStakeholderRaciSchema.parse(req.body);\n      \n      // Check access to project\n      if (!await checkProjectAccess(userId, data.projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const raci = await storage.createStakeholderRaci(data);\n      \n      // Propagate to descendants if this is an explicit (not inherited) assignment\n      if (!data.isInherited) {\n        await storage.propagateRaciToDescendants(\n          raci.taskId,\n          raci.raciType,\n          raci.stakeholderId,\n          raci.resourceId,\n          raci.projectId\n        );\n      }\n      \n      // Notify connected clients\n      wsManager.notifyProjectUpdate(raci.projectId, \"raci-created\", raci, userId);\n      \n      res.json(raci);\n    } catch (error) {\n      console.error(\"Error creating RACI assignment:\", error);\n      res.status(400).json({ message: \"Failed to create RACI assignment\" });\n    }\n  });\n\n  app.put('/api/raci/upsert', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const data = insertStakeholderRaciSchema.parse(req.body);\n      \n      // Check access to project\n      if (!await checkProjectAccess(userId, data.projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const raci = await storage.upsertStakeholderRaci(data);\n      \n      // Notify connected clients\n      wsManager.notifyProjectUpdate(raci.projectId, \"raci-upserted\", raci, userId);\n      \n      res.json(raci);\n    } catch (error) {\n      console.error(\"Error upserting RACI assignment:\", error);\n      res.status(400).json({ message: \"Failed to upsert RACI assignment\" });\n    }\n  });\n\n  app.patch('/api/raci/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      const raci = await storage.getStakeholderRaci(id);\n      if (!raci) {\n        return res.status(404).json({ message: \"RACI assignment not found\" });\n      }\n      \n      // Check access\n      if (!await checkProjectAccess(userId, raci.projectId)) {\n        return res.status(404).json({ message: \"RACI assignment not found\" });\n      }\n      \n      const data = updateStakeholderRaciSchema.parse(req.body);\n      const updated = await storage.updateStakeholderRaci(id, data);\n      \n      // Notify connected clients\n      wsManager.notifyProjectUpdate(raci.projectId, \"raci-updated\", updated, userId);\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating RACI assignment:\", error);\n      res.status(400).json({ message: \"Failed to update RACI assignment\" });\n    }\n  });\n\n  app.delete('/api/raci/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      const raci = await storage.getStakeholderRaci(id);\n      if (!raci) {\n        return res.status(404).json({ message: \"RACI assignment not found\" });\n      }\n      \n      // Check access\n      if (!await checkProjectAccess(userId, raci.projectId)) {\n        return res.status(404).json({ message: \"RACI assignment not found\" });\n      }\n      \n      // Remove inherited values from descendants if this is an explicit assignment\n      if (!raci.isInherited) {\n        await storage.removeInheritedRaciFromDescendants(\n          raci.taskId,\n          raci.raciType,\n          raci.stakeholderId,\n          raci.resourceId\n        );\n      }\n      \n      await storage.deleteStakeholderRaci(id);\n      \n      // Notify connected clients\n      wsManager.notifyProjectUpdate(raci.projectId, \"raci-deleted\", { id, projectId: raci.projectId }, userId);\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting RACI assignment:\", error);\n      res.status(500).json({ message: \"Failed to delete RACI assignment\" });\n    }\n  });\n\n  app.post('/api/raci/reset', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const { taskId, raciType, projectId } = req.body;\n      \n      if (!taskId || !raciType || !projectId) {\n        return res.status(400).json({ message: \"taskId, raciType, and projectId are required\" });\n      }\n      \n      // Check access to project\n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      await storage.resetRaciToInherited(taskId, raciType);\n      \n      // Notify connected clients\n      wsManager.notifyProjectUpdate(projectId, \"raci-reset\", { taskId, raciType }, userId);\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error resetting RACI to inherited:\", error);\n      res.status(500).json({ message: \"Failed to reset RACI to inherited\" });\n    }\n  });\n\n  // ===== Risk Routes =====\n  app.get('/api/projects/:projectId/risks', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      // Check access\n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      const risks = await storage.getRisksByProject(projectId);\n      res.json(risks);\n    } catch (error) {\n      console.error(\"Error fetching risks:\", error);\n      res.status(500).json({ message: \"Failed to fetch risks\" });\n    }\n  });\n\n  app.post('/api/risks', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const data = insertRiskSchema.parse(req.body);\n      \n      // Check access to project\n      if (!await checkProjectAccess(userId, data.projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      // Auto-generate code if not provided\n      if (!data.code) {\n        const existingRisks = await storage.getRisksByProject(data.projectId);\n        const nextNumber = existingRisks.length + 1;\n        data.code = `RISK-${String(nextNumber).padStart(3, '0')}`;\n      }\n      \n      const risk = await storage.createRisk(data);\n      \n      // Notify connected clients\n      wsManager.notifyProjectUpdate(risk.projectId, \"risk-created\", risk, userId);\n      \n      res.json(risk);\n    } catch (error) {\n      console.error(\"Error creating risk:\", error);\n      res.status(400).json({ message: \"Failed to create risk\" });\n    }\n  });\n\n  app.patch('/api/risks/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      const existing = await storage.getRisk(id);\n      if (!existing) {\n        return res.status(404).json({ message: \"Risk not found\" });\n      }\n      \n      // Check access\n      if (!await checkProjectAccess(userId, existing.projectId)) {\n        return res.status(404).json({ message: \"Risk not found\" });\n      }\n      \n      const data = updateRiskSchema.parse(req.body);\n      // Filter out undefined values\n      const updateFields = Object.fromEntries(\n        Object.entries(data).filter(([_, value]) => value !== undefined)\n      );\n      \n      // Merge with existing to preserve required fields\n      const mergedData = {\n        code: existing.code,\n        projectId: existing.projectId,\n        identifiedDate: existing.identifiedDate,\n        ...updateFields,\n      };\n      \n      const updated = await storage.updateRisk(id, mergedData);\n      \n      // Notify connected clients\n      wsManager.notifyProjectUpdate(existing.projectId, \"risk-updated\", updated, userId);\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating risk:\", error);\n      res.status(400).json({ message: \"Failed to update risk\" });\n    }\n  });\n\n  app.delete('/api/risks/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      const risk = await storage.getRisk(id);\n      if (!risk) {\n        return res.status(404).json({ message: \"Risk not found\" });\n      }\n      \n      // Check access\n      if (!await checkProjectAccess(userId, risk.projectId)) {\n        return res.status(404).json({ message: \"Risk not found\" });\n      }\n      \n      await storage.deleteRisk(id);\n      \n      // Notify connected clients\n      wsManager.notifyProjectUpdate(risk.projectId, \"risk-deleted\", { id, projectId: risk.projectId }, userId);\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting risk:\", error);\n      res.status(500).json({ message: \"Failed to delete risk\" });\n    }\n  });\n\n  // ===== Issue Routes =====\n  app.get('/api/projects/:projectId/issues', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      // Check access\n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      const issues = await storage.getIssuesByProject(projectId);\n      res.json(issues);\n    } catch (error) {\n      console.error(\"Error fetching issues:\", error);\n      res.status(500).json({ message: \"Failed to fetch issues\" });\n    }\n  });\n\n  app.post('/api/issues', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const data = insertIssueSchema.parse(req.body);\n      \n      // Check access to project\n      if (!await checkProjectAccess(userId, data.projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      // Auto-generate code if not provided\n      if (!data.code) {\n        const existingIssues = await storage.getIssuesByProject(data.projectId);\n        const nextNumber = existingIssues.length + 1;\n        data.code = `ISS-${String(nextNumber).padStart(3, '0')}`;\n      }\n      \n      const issue = await storage.createIssue({\n        ...data,\n        code: data.code,\n        reportedBy: userId,\n      });\n      \n      // Notify connected clients\n      wsManager.notifyProjectUpdate(issue.projectId, \"issue-created\", issue, userId);\n      \n      res.json(issue);\n    } catch (error) {\n      console.error(\"Error creating issue:\", error);\n      res.status(400).json({ message: \"Failed to create issue\" });\n    }\n  });\n\n  app.patch('/api/issues/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      const existing = await storage.getIssue(id);\n      if (!existing) {\n        return res.status(404).json({ message: \"Issue not found\" });\n      }\n      \n      // Check access\n      if (!await checkProjectAccess(userId, existing.projectId)) {\n        return res.status(404).json({ message: \"Issue not found\" });\n      }\n      \n      const data = updateIssueSchema.parse(req.body);\n      // Filter out undefined values\n      const updateFields = Object.fromEntries(\n        Object.entries(data).filter(([_, value]) => value !== undefined)\n      );\n      \n      // Merge with existing to preserve required fields\n      const mergedData = {\n        code: existing.code,\n        projectId: existing.projectId,\n        reportedBy: existing.reportedBy,\n        reportedDate: existing.reportedDate,\n        ...updateFields,\n      };\n      \n      const updated = await storage.updateIssue(id, mergedData);\n      \n      // Notify connected clients\n      wsManager.notifyProjectUpdate(existing.projectId, \"issue-updated\", updated, userId);\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating issue:\", error);\n      res.status(400).json({ message: \"Failed to update issue\" });\n    }\n  });\n\n  app.delete('/api/issues/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      const issue = await storage.getIssue(id);\n      if (!issue) {\n        return res.status(404).json({ message: \"Issue not found\" });\n      }\n      \n      // Check access\n      if (!await checkProjectAccess(userId, issue.projectId)) {\n        return res.status(404).json({ message: \"Issue not found\" });\n      }\n      \n      await storage.deleteIssue(id);\n      \n      // Notify connected clients\n      wsManager.notifyProjectUpdate(issue.projectId, \"issue-deleted\", { id, projectId: issue.projectId }, userId);\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting issue:\", error);\n      res.status(500).json({ message: \"Failed to delete issue\" });\n    }\n  });\n\n  // ===== Cost Items Routes =====\n  app.get('/api/projects/:projectId/costs', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      // Check access\n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      const costs = await storage.getCostItemsByProject(projectId);\n      res.json(costs);\n    } catch (error) {\n      console.error(\"Error fetching costs:\", error);\n      res.status(500).json({ message: \"Failed to fetch costs\" });\n    }\n  });\n\n  app.post('/api/costs', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const data = insertCostItemSchema.parse(req.body);\n      \n      // Check access to project\n      if (!await checkProjectAccess(userId, data.projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const cost = await storage.createCostItem(data);\n      \n      // Notify connected clients\n      wsManager.notifyProjectUpdate(cost.projectId, \"cost-item-created\", cost, userId);\n      \n      res.json(cost);\n    } catch (error) {\n      console.error(\"Error creating cost item:\", error);\n      res.status(400).json({ message: \"Failed to create cost item\" });\n    }\n  });\n\n  app.patch('/api/costs/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      const cost = await storage.getCostItem(id);\n      if (!cost) {\n        return res.status(404).json({ message: \"Cost item not found\" });\n      }\n      \n      // Check access\n      if (!await checkProjectAccess(userId, cost.projectId)) {\n        return res.status(404).json({ message: \"Cost item not found\" });\n      }\n      \n      const data = updateCostItemSchema.parse(req.body);\n      const updated = await storage.updateCostItem(id, data);\n      \n      // Notify connected clients\n      wsManager.notifyProjectUpdate(cost.projectId, \"cost-item-updated\", updated, userId);\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating cost item:\", error);\n      res.status(400).json({ message: \"Failed to update cost item\" });\n    }\n  });\n\n  // ===== Resources Routes =====\n  app.get('/api/projects/:projectId/resources', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      // Check access\n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      const resources = await storage.getResourcesByProject(projectId);\n      res.json(resources);\n    } catch (error) {\n      console.error(\"Error fetching resources:\", error);\n      res.status(500).json({ message: \"Failed to fetch resources\" });\n    }\n  });\n\n  app.post('/api/resources', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const data = req.body;\n      \n      // Check access to project\n      if (!await checkProjectAccess(userId, data.projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const resource = await storage.createResource(data);\n      res.json(resource);\n    } catch (error) {\n      console.error(\"Error creating resource:\", error);\n      res.status(400).json({ message: \"Failed to create resource\" });\n    }\n  });\n\n  app.patch('/api/resources/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      const resource = await storage.getResource(id);\n      if (!resource) {\n        return res.status(404).json({ message: \"Resource not found\" });\n      }\n      \n      // Check access\n      if (!await checkProjectAccess(userId, resource.projectId)) {\n        return res.status(404).json({ message: \"Resource not found\" });\n      }\n      \n      const updated = await storage.updateResource(id, req.body);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating resource:\", error);\n      res.status(400).json({ message: \"Failed to update resource\" });\n    }\n  });\n\n  app.delete('/api/resources/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      const resource = await storage.getResource(id);\n      if (!resource) {\n        return res.status(404).json({ message: \"Resource not found\" });\n      }\n      \n      // Check access\n      if (!await checkProjectAccess(userId, resource.projectId)) {\n        return res.status(404).json({ message: \"Resource not found\" });\n      }\n      \n      await storage.deleteResource(id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting resource:\", error);\n      res.status(500).json({ message: \"Failed to delete resource\" });\n    }\n  });\n\n  // Resource Utilization\n  app.get('/api/projects/:projectId/resource-utilization', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const project = await storage.getProject(projectId);\n      if (!project) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      const startDate = req.query.startDate \n        ? new Date(req.query.startDate as string) \n        : project.startDate || new Date();\n      const endDate = req.query.endDate \n        ? new Date(req.query.endDate as string) \n        : project.endDate || new Date(Date.now() + 365 * 24 * 60 * 60 * 1000);\n      \n      const utilization = await storage.getProjectResourceUtilization(projectId, startDate, endDate);\n      res.json(utilization);\n    } catch (error) {\n      console.error(\"Error fetching resource utilization:\", error);\n      res.status(500).json({ message: \"Failed to fetch resource utilization\" });\n    }\n  });\n\n  // Resource Assignments\n  app.get('/api/resources/:resourceId/assignments', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const resourceId = parseInt(req.params.resourceId);\n      \n      const resource = await storage.getResource(resourceId);\n      if (!resource) {\n        return res.status(404).json({ message: \"Resource not found\" });\n      }\n      \n      if (!await checkProjectAccess(userId, resource.projectId)) {\n        return res.status(404).json({ message: \"Resource not found\" });\n      }\n      \n      const assignments = await storage.getResourceAssignmentsByResource(resourceId);\n      res.json(assignments);\n    } catch (error) {\n      console.error(\"Error fetching resource assignments:\", error);\n      res.status(500).json({ message: \"Failed to fetch resource assignments\" });\n    }\n  });\n\n  app.get('/api/tasks/:taskId/assignments', isAuthenticated, async (req: any, res) => {\n    try {\n      const taskId = parseInt(req.params.taskId);\n      const assignments = await storage.getResourceAssignmentsByTask(taskId);\n      res.json(assignments);\n    } catch (error) {\n      console.error(\"Error fetching assignments:\", error);\n      res.status(500).json({ message: \"Failed to fetch assignments\" });\n    }\n  });\n\n  app.post('/api/assignments', isAuthenticated, async (req: any, res) => {\n    try {\n      const assignment = await storage.createResourceAssignment(req.body);\n      res.json(assignment);\n    } catch (error) {\n      console.error(\"Error creating assignment:\", error);\n      res.status(400).json({ message: \"Failed to create assignment\" });\n    }\n  });\n\n  app.delete('/api/assignments/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      await storage.deleteResourceAssignment(id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting assignment:\", error);\n      res.status(500).json({ message: \"Failed to delete assignment\" });\n    }\n  });\n\n  // ===== Documents Routes =====\n  \n  // Get documents by project\n  app.get('/api/projects/:projectId/documents', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const documents = await storage.getDocumentsByProject(projectId);\n      res.json(documents);\n    } catch (error) {\n      console.error(\"Error fetching documents:\", error);\n      res.status(500).json({ message: \"Failed to fetch documents\" });\n    }\n  });\n\n  // Get single document\n  app.get('/api/documents/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      const document = await storage.getDocument(id);\n      if (!document) {\n        return res.status(404).json({ message: \"Document not found\" });\n      }\n      \n      if (!await checkProjectAccess(userId, document.projectId)) {\n        return res.status(404).json({ message: \"Document not found\" });\n      }\n      \n      res.json(document);\n    } catch (error) {\n      console.error(\"Error fetching document:\", error);\n      res.status(500).json({ message: \"Failed to fetch document\" });\n    }\n  });\n\n  // Create document\n  app.post('/api/documents', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const { projectId } = req.body;\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const document = await storage.createDocument({\n        ...req.body,\n        createdBy: userId,\n      });\n      res.json(document);\n    } catch (error) {\n      console.error(\"Error creating document:\", error);\n      res.status(400).json({ message: \"Failed to create document\" });\n    }\n  });\n\n  // Update document\n  app.patch('/api/documents/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      const document = await storage.getDocument(id);\n      if (!document) {\n        return res.status(404).json({ message: \"Document not found\" });\n      }\n      \n      if (!await checkProjectAccess(userId, document.projectId)) {\n        return res.status(404).json({ message: \"Document not found\" });\n      }\n      \n      const updated = await storage.updateDocument(id, req.body);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating document:\", error);\n      res.status(400).json({ message: \"Failed to update document\" });\n    }\n  });\n\n  // Delete document\n  app.delete('/api/documents/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      const document = await storage.getDocument(id);\n      if (!document) {\n        return res.status(404).json({ message: \"Document not found\" });\n      }\n      \n      if (!await checkProjectAccess(userId, document.projectId)) {\n        return res.status(404).json({ message: \"Document not found\" });\n      }\n      \n      await storage.deleteDocument(id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting document:\", error);\n      res.status(500).json({ message: \"Failed to delete document\" });\n    }\n  });\n\n  // ===== Project Events Routes (Calendar) =====\n  \n  // Get project events\n  app.get('/api/projects/:projectId/events', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const events = await storage.getProjectEventsByProject(projectId);\n      res.json(events);\n    } catch (error) {\n      console.error(\"Error fetching project events:\", error);\n      res.status(500).json({ message: \"Failed to fetch project events\" });\n    }\n  });\n\n  // Get single project event\n  app.get('/api/events/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      const event = await storage.getProjectEvent(id);\n      if (!event) {\n        return res.status(404).json({ message: \"Event not found\" });\n      }\n      \n      if (!await checkProjectAccess(userId, event.projectId)) {\n        return res.status(404).json({ message: \"Event not found\" });\n      }\n      \n      res.json(event);\n    } catch (error) {\n      console.error(\"Error fetching event:\", error);\n      res.status(500).json({ message: \"Failed to fetch event\" });\n    }\n  });\n\n  // Create project event\n  app.post('/api/events', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const { projectId } = req.body;\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const event = await storage.createProjectEvent({\n        ...req.body,\n        createdBy: userId,\n      });\n      res.json(event);\n    } catch (error) {\n      console.error(\"Error creating event:\", error);\n      res.status(400).json({ message: \"Failed to create event\" });\n    }\n  });\n\n  // Update project event\n  app.patch('/api/events/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      const event = await storage.getProjectEvent(id);\n      if (!event) {\n        return res.status(404).json({ message: \"Event not found\" });\n      }\n      \n      if (!await checkProjectAccess(userId, event.projectId)) {\n        return res.status(404).json({ message: \"Event not found\" });\n      }\n      \n      const updated = await storage.updateProjectEvent(id, req.body);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating event:\", error);\n      res.status(400).json({ message: \"Failed to update event\" });\n    }\n  });\n\n  // Delete project event\n  app.delete('/api/events/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      const event = await storage.getProjectEvent(id);\n      if (!event) {\n        return res.status(404).json({ message: \"Event not found\" });\n      }\n      \n      if (!await checkProjectAccess(userId, event.projectId)) {\n        return res.status(404).json({ message: \"Event not found\" });\n      }\n      \n      await storage.deleteProjectEvent(id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting event:\", error);\n      res.status(500).json({ message: \"Failed to delete event\" });\n    }\n  });\n\n  // ===== Task Junction Tables Routes =====\n  \n  // Task Documents\n  app.get('/api/tasks/:taskId/documents', isAuthenticated, async (req: any, res) => {\n    try {\n      const taskId = parseInt(req.params.taskId);\n      const taskDocs = await storage.getTaskDocuments(taskId);\n      res.json(taskDocs);\n    } catch (error) {\n      console.error(\"Error fetching task documents:\", error);\n      res.status(500).json({ message: \"Failed to fetch task documents\" });\n    }\n  });\n\n  app.post('/api/tasks/:taskId/documents', isAuthenticated, async (req: any, res) => {\n    try {\n      const taskId = parseInt(req.params.taskId);\n      const { documentId, relationship } = req.body;\n      const taskDoc = await storage.createTaskDocument({ taskId, documentId, relationship });\n      res.json(taskDoc);\n    } catch (error) {\n      console.error(\"Error adding document to task:\", error);\n      res.status(400).json({ message: \"Failed to add document to task\" });\n    }\n  });\n\n  app.delete('/api/tasks/:taskId/documents/:documentId', isAuthenticated, async (req: any, res) => {\n    try {\n      const taskId = parseInt(req.params.taskId);\n      const documentId = parseInt(req.params.documentId);\n      await storage.deleteTaskDocument(taskId, documentId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error removing document from task:\", error);\n      res.status(500).json({ message: \"Failed to remove document from task\" });\n    }\n  });\n\n  // Task Risks\n  app.get('/api/tasks/:taskId/risks', isAuthenticated, async (req: any, res) => {\n    try {\n      const taskId = parseInt(req.params.taskId);\n      const taskRisks = await storage.getTaskRisks(taskId);\n      res.json(taskRisks);\n    } catch (error) {\n      console.error(\"Error fetching task risks:\", error);\n      res.status(500).json({ message: \"Failed to fetch task risks\" });\n    }\n  });\n\n  app.post('/api/tasks/:taskId/risks', isAuthenticated, async (req: any, res) => {\n    try {\n      const taskId = parseInt(req.params.taskId);\n      const { riskId } = req.body;\n      const taskRisk = await storage.createTaskRisk({ taskId, riskId });\n      res.json(taskRisk);\n    } catch (error) {\n      console.error(\"Error adding risk to task:\", error);\n      res.status(400).json({ message: \"Failed to add risk to task\" });\n    }\n  });\n\n  app.delete('/api/tasks/:taskId/risks/:riskId', isAuthenticated, async (req: any, res) => {\n    try {\n      const taskId = parseInt(req.params.taskId);\n      const riskId = parseInt(req.params.riskId);\n      await storage.deleteTaskRisk(taskId, riskId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error removing risk from task:\", error);\n      res.status(500).json({ message: \"Failed to remove risk from task\" });\n    }\n  });\n\n  // Task Issues\n  app.get('/api/tasks/:taskId/issues', isAuthenticated, async (req: any, res) => {\n    try {\n      const taskId = parseInt(req.params.taskId);\n      const taskIssues = await storage.getTaskIssues(taskId);\n      res.json(taskIssues);\n    } catch (error) {\n      console.error(\"Error fetching task issues:\", error);\n      res.status(500).json({ message: \"Failed to fetch task issues\" });\n    }\n  });\n\n  app.post('/api/tasks/:taskId/issues', isAuthenticated, async (req: any, res) => {\n    try {\n      const taskId = parseInt(req.params.taskId);\n      const { issueId } = req.body;\n      const taskIssue = await storage.createTaskIssue({ taskId, issueId });\n      res.json(taskIssue);\n    } catch (error) {\n      console.error(\"Error adding issue to task:\", error);\n      res.status(400).json({ message: \"Failed to add issue to task\" });\n    }\n  });\n\n  app.delete('/api/tasks/:taskId/issues/:issueId', isAuthenticated, async (req: any, res) => {\n    try {\n      const taskId = parseInt(req.params.taskId);\n      const issueId = parseInt(req.params.issueId);\n      await storage.deleteTaskIssue(taskId, issueId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error removing issue from task:\", error);\n      res.status(500).json({ message: \"Failed to remove issue from task\" });\n    }\n  });\n\n  // ===== Inheritance Routes =====\n  \n  app.get('/api/tasks/:taskId/inherited/resources', isAuthenticated, async (req: any, res) => {\n    try {\n      const taskId = parseInt(req.params.taskId);\n      const inherited = await storage.getInheritedResources(taskId);\n      res.json(inherited);\n    } catch (error) {\n      console.error(\"Error fetching inherited resources:\", error);\n      res.status(500).json({ message: \"Failed to fetch inherited resources\" });\n    }\n  });\n\n  app.get('/api/tasks/:taskId/inherited/documents', isAuthenticated, async (req: any, res) => {\n    try {\n      const taskId = parseInt(req.params.taskId);\n      const inherited = await storage.getInheritedDocuments(taskId);\n      res.json(inherited);\n    } catch (error) {\n      console.error(\"Error fetching inherited documents:\", error);\n      res.status(500).json({ message: \"Failed to fetch inherited documents\" });\n    }\n  });\n\n  app.get('/api/tasks/:taskId/inherited/risks', isAuthenticated, async (req: any, res) => {\n    try {\n      const taskId = parseInt(req.params.taskId);\n      const inherited = await storage.getInheritedRisks(taskId);\n      res.json(inherited);\n    } catch (error) {\n      console.error(\"Error fetching inherited risks:\", error);\n      res.status(500).json({ message: \"Failed to fetch inherited risks\" });\n    }\n  });\n\n  app.get('/api/tasks/:taskId/inherited/issues', isAuthenticated, async (req: any, res) => {\n    try {\n      const taskId = parseInt(req.params.taskId);\n      const inherited = await storage.getInheritedIssues(taskId);\n      res.json(inherited);\n    } catch (error) {\n      console.error(\"Error fetching inherited issues:\", error);\n      res.status(500).json({ message: \"Failed to fetch inherited issues\" });\n    }\n  });\n\n  // ===== AI Assistant Routes =====\n  \n  // Get user's conversations\n  app.get('/api/ai/conversations', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const conversations = await storage.getAiConversationsByUser(userId);\n      res.json(conversations);\n    } catch (error) {\n      console.error(\"Error fetching conversations:\", error);\n      res.status(500).json({ message: \"Failed to fetch conversations\" });\n    }\n  });\n\n  // Get conversations for a project\n  app.get('/api/ai/conversations/project/:projectId', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const conversations = await storage.getAiConversationsByProject(projectId, userId);\n      res.json(conversations);\n    } catch (error) {\n      console.error(\"Error fetching project conversations:\", error);\n      res.status(500).json({ message: \"Failed to fetch conversations\" });\n    }\n  });\n\n  // Create new conversation\n  const createConversationSchema = z.object({\n    title: z.string().optional(),\n    projectId: z.number().optional(),\n  });\n  \n  app.post('/api/ai/conversations', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const data = createConversationSchema.parse(req.body);\n      \n      // Verify project access if projectId is provided\n      if (data.projectId) {\n        if (!await checkProjectAccess(userId, data.projectId)) {\n          return res.status(403).json({ message: \"Access denied\" });\n        }\n      }\n      \n      const conversation = await storage.createAiConversation({\n        title: data.title || \"New Conversation\",\n        projectId: data.projectId || null,\n        userId\n      });\n      \n      res.json(conversation);\n    } catch (error) {\n      console.error(\"Error creating conversation:\", error);\n      res.status(400).json({ message: \"Failed to create conversation\" });\n    }\n  });\n\n  // Get conversation messages\n  app.get('/api/ai/conversations/:id/messages', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const conversationId = parseInt(req.params.id);\n      \n      // Check conversation ownership\n      const conversation = await storage.getAiConversation(conversationId);\n      if (!conversation || conversation.userId !== userId) {\n        return res.status(404).json({ message: \"Conversation not found\" });\n      }\n      \n      const messages = await storage.getAiMessagesByConversation(conversationId);\n      res.json(messages);\n    } catch (error) {\n      console.error(\"Error fetching messages:\", error);\n      res.status(500).json({ message: \"Failed to fetch messages\" });\n    }\n  });\n\n  // Send message and get AI response\n  const chatMessageSchema = z.object({\n    conversationId: z.number(),\n    message: z.string(),\n  });\n\n  app.post('/api/ai/chat', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const { conversationId, message } = chatMessageSchema.parse(req.body);\n      \n      // Check conversation ownership\n      const conversation = await storage.getAiConversation(conversationId);\n      if (!conversation || conversation.userId !== userId) {\n        return res.status(404).json({ message: \"Conversation not found\" });\n      }\n      \n      // Get conversation history\n      const history = await storage.getAiMessagesByConversation(conversationId);\n      const messages: ChatMessage[] = history.map(h => ({\n        role: h.role as \"user\" | \"assistant\" | \"system\",\n        content: h.content\n      }));\n      \n      // Add new user message\n      messages.push({ role: \"user\", content: message });\n      \n      // Save user message\n      await storage.createAiMessage({\n        conversationId,\n        role: \"user\",\n        content: message,\n        tokensUsed: 0\n      });\n      \n      // Get AI response\n      const response = await chatWithAssistant(\n        messages,\n        conversation.projectId,\n        storage,\n        userId\n      );\n      \n      // Validate response before saving\n      // Require either a meaningful message OR function calls were executed\n      const hasMessage = response.message && response.message.trim().length > 0 && response.message !== \"No response generated\";\n      const hasFunctionCalls = response.functionCalls && response.functionCalls.length > 0;\n      \n      if (!hasMessage && !hasFunctionCalls) {\n        throw new Error(\"AI response was empty - no message or function calls\");\n      }\n      \n      // Save assistant message only if there's meaningful content\n      // If only function calls without message, use a default message\n      const messageContent = hasMessage ? response.message : \n        (hasFunctionCalls ? `Executed ${response.functionCalls!.length} function(s)` : response.message);\n      \n      await storage.createAiMessage({\n        conversationId,\n        role: \"assistant\",\n        content: messageContent,\n        tokensUsed: response.tokensUsed,\n        functionCall: response.functionCalls ? JSON.stringify(response.functionCalls) : null\n      });\n      \n      // Track usage\n      await storage.createAiUsage({\n        userId,\n        organizationId: conversation.projectId ? (await storage.getProject(conversation.projectId))?.organizationId || null : null,\n        tokensUsed: response.tokensUsed,\n        model: \"gpt-5\",\n        operation: \"chat\"\n      });\n      \n      // Update conversation updated time (title if not set)\n      await storage.updateAiConversation(conversationId, {\n        title: conversation.title || message.substring(0, 50)\n      });\n      \n      res.json({\n        message: response.message,\n        tokensUsed: response.tokensUsed,\n        functionCalls: response.functionCalls\n      });\n    } catch (error: any) {\n      console.error(\"Error in AI chat:\", error);\n      res.status(500).json({ message: error.message || \"Failed to get AI response\" });\n    }\n  });\n\n  // Update conversation (rename)\n  const updateConversationSchema = z.object({\n    title: z.string().min(1).max(100),\n  });\n  \n  app.patch('/api/ai/conversations/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      const data = updateConversationSchema.parse(req.body);\n      \n      const conversation = await storage.getAiConversation(id);\n      if (!conversation || conversation.userId !== userId) {\n        return res.status(404).json({ message: \"Conversation not found\" });\n      }\n      \n      const updated = await storage.updateAiConversation(id, { title: data.title });\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating conversation:\", error);\n      res.status(500).json({ message: \"Failed to update conversation\" });\n    }\n  });\n\n  // Delete conversation\n  app.delete('/api/ai/conversations/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const id = parseInt(req.params.id);\n      \n      const conversation = await storage.getAiConversation(id);\n      if (!conversation || conversation.userId !== userId) {\n        return res.status(404).json({ message: \"Conversation not found\" });\n      }\n      \n      await storage.deleteAiConversation(id);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting conversation:\", error);\n      res.status(500).json({ message: \"Failed to delete conversation\" });\n    }\n  });\n\n  // ===== Project Export/Import Routes =====\n  \n  // Export project data as JSON\n  app.get('/api/projects/:projectId/export', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      const format = req.query.format as string;\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const project = await storage.getProject(projectId);\n      if (!project) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      const [tasks, risks, issues, stakeholders, costItems, documents, resources, dependencies] = await Promise.all([\n        storage.getTasksByProject(projectId),\n        storage.getRisksByProject(projectId),\n        storage.getIssuesByProject(projectId),\n        storage.getStakeholdersByProject(projectId),\n        storage.getCostItemsByProject(projectId),\n        storage.getDocumentsByProject(projectId),\n        storage.getResourcesByProject(projectId),\n        storage.getDependenciesByProject(projectId)\n      ]);\n      \n      if (format === 'csv') {\n        const csvRows = ['ID,WBS Code,Name,Status,Progress,Start Date,End Date,Assigned To,Priority'];\n        for (const task of tasks) {\n          csvRows.push([\n            task.id,\n            task.wbsCode || '',\n            `\"${(task.name || '').replace(/\"/g, '\"\"')}\"`,\n            task.status || '',\n            task.progress || 0,\n            task.startDate ? new Date(task.startDate).toISOString().split('T')[0] : '',\n            task.endDate ? new Date(task.endDate).toISOString().split('T')[0] : '',\n            `\"${(task.assignedTo || '').replace(/\"/g, '\"\"')}\"`,\n            task.priority || ''\n          ].join(','));\n        }\n        res.setHeader('Content-Type', 'text/csv');\n        res.send(csvRows.join('\\n'));\n      } else {\n        const exportData = {\n          exportDate: new Date().toISOString(),\n          version: \"1.0\",\n          project: {\n            name: project.name,\n            code: project.code,\n            description: project.description,\n            status: project.status,\n            startDate: project.startDate,\n            endDate: project.endDate,\n            budget: project.budget,\n            currency: project.currency\n          },\n          tasks: tasks.map(t => ({\n            wbsCode: t.wbsCode,\n            name: t.name,\n            description: t.description,\n            status: t.status,\n            progress: t.progress,\n            startDate: t.startDate,\n            endDate: t.endDate,\n            assignedTo: t.assignedTo,\n            priority: t.priority,\n            estimatedHours: t.estimatedHours,\n            actualHours: t.actualHours,\n            discipline: t.discipline\n          })),\n          risks: risks.map(r => ({\n            code: r.code,\n            title: r.title,\n            description: r.description,\n            category: r.category,\n            probability: r.probability,\n            impact: r.impact,\n            status: r.status,\n            owner: r.owner,\n            mitigationStrategy: r.mitigationStrategy,\n            contingencyPlan: r.contingencyPlan\n          })),\n          issues: issues.map(i => ({\n            code: i.code,\n            title: i.title,\n            description: i.description,\n            priority: i.priority,\n            status: i.status,\n            assignedTo: i.assignedTo,\n            reportedBy: i.reportedBy,\n            resolution: i.resolution\n          })),\n          stakeholders: stakeholders.map(s => ({\n            name: s.name,\n            role: s.role,\n            organization: s.organization,\n            email: s.email,\n            phone: s.phone,\n            influence: s.influence,\n            interest: s.interest\n          })),\n          costItems: costItems.map(c => ({\n            description: c.description,\n            category: c.category,\n            budgeted: c.budgeted,\n            actual: c.actual,\n            currency: c.currency\n          })),\n          documents: documents.map(d => ({\n            documentNumber: d.documentNumber,\n            title: d.title,\n            revision: d.revision,\n            discipline: d.discipline,\n            documentType: d.documentType,\n            status: d.status\n          }))\n        };\n        \n        res.json(exportData);\n      }\n    } catch (error) {\n      console.error(\"Error exporting project:\", error);\n      res.status(500).json({ message: \"Failed to export project\" });\n    }\n  });\n  \n  // ===== Import Schema & Template Endpoints =====\n  \n  // Valid enum values for import validation\n  const importEnums = {\n    taskStatus: [\"not-started\", \"in-progress\", \"review\", \"completed\", \"on-hold\"],\n    taskPriority: [\"low\", \"medium\", \"high\", \"critical\"],\n    riskStatus: [\"identified\", \"assessed\", \"mitigating\", \"closed\"],\n    riskImpact: [\"low\", \"medium\", \"high\", \"critical\"],\n    issueStatus: [\"open\", \"in-progress\", \"resolved\", \"closed\"],\n    issuePriority: [\"low\", \"medium\", \"high\", \"critical\"],\n    stakeholderRole: [\"sponsor\", \"client\", \"team-member\", \"contractor\", \"consultant\", \"regulatory\", \"vendor\", \"other\"],\n    costCategory: [\"labor\", \"materials\", \"equipment\", \"subcontractor\", \"overhead\", \"permits\", \"contingency\", \"construction\", \"administrative\", \"other\"],\n    discipline: [\"general\", \"civil\", \"structural\", \"mechanical\", \"electrical\", \"instrumentation\", \"piping\", \"process\", \"hse\", \"qa-qc\", \"procurement\", \"construction\", \"commissioning\", \"management\", \"engineering\"],\n    currency: [\"USD\", \"EUR\", \"GBP\", \"CAD\", \"AUD\", \"JPY\", \"CNY\", \"INR\", \"BRL\", \"MXN\", \"SAR\", \"AED\", \"SGD\", \"HKD\", \"KRW\"]\n  };\n  \n  // Value mapping for common alternatives\n  const valueMappings: Record<string, Record<string, string>> = {\n    taskPriority: { \"normal\": \"medium\", \"urgent\": \"critical\", \"none\": \"low\" },\n    riskStatus: { \"active\": \"identified\", \"open\": \"identified\", \"monitoring\": \"assessed\", \"resolved\": \"closed\" },\n    issueStatus: { \"pending\": \"open\", \"fixed\": \"resolved\", \"done\": \"closed\" },\n    stakeholderRole: { \"owner\": \"sponsor\", \"customer\": \"client\", \"subcontractor\": \"contractor\", \"regulator\": \"regulatory\", \"supplier\": \"vendor\" },\n    // Discipline mappings for common EPC terms\n    discipline: { \n      \"management\": \"general\", \"project-management\": \"general\", \"pm\": \"general\",\n      \"engineering\": \"general\", \"design\": \"general\",\n      \"procurement\": \"general\", \"purchasing\": \"general\", \"supply-chain\": \"general\",\n      \"construction\": \"civil\", \"site-works\": \"civil\", \"building\": \"civil\",\n      \"mep\": \"mechanical\", \"hvac-mechanical\": \"mechanical\",\n      \"e&i\": \"electrical\", \"power\": \"electrical\",\n      \"controls\": \"instrumentation\", \"automation\": \"instrumentation\",\n      \"pipeline\": \"piping\", \"plumbing\": \"piping\"\n    }\n  };\n  \n  // Get import schema with all valid enum values (for external AI consumption)\n  app.get('/api/import/schema', (req, res) => {\n    const schema = {\n      $schema: \"http://json-schema.org/draft-07/schema#\",\n      title: \"EPC PMIS Project Import Schema\",\n      description: \"JSON Schema for importing project data into EPC PMIS. Use this schema when generating project JSON with AI tools like ChatGPT, Claude, or Gemini.\",\n      version: \"1.0\",\n      type: \"object\",\n      required: [\"version\", \"project\"],\n      properties: {\n        version: { type: \"string\", const: \"1.0\", description: \"Schema version, must be '1.0'\" },\n        project: {\n          type: \"object\",\n          required: [\"name\"],\n          properties: {\n            name: { type: \"string\", description: \"Project name\", maxLength: 255 },\n            code: { type: \"string\", description: \"Project code (e.g., SOLAR-2024-001)\", maxLength: 50 },\n            description: { type: \"string\", description: \"Project description\" },\n            status: { type: \"string\", enum: [\"planning\", \"active\", \"on-hold\", \"completed\", \"cancelled\"], default: \"active\" },\n            startDate: { type: \"string\", format: \"date-time\", description: \"ISO 8601 date (e.g., 2025-01-15T00:00:00.000Z)\" },\n            endDate: { type: \"string\", format: \"date-time\" },\n            budget: { type: \"string\", description: \"Budget amount as string (e.g., '75000000.00')\" },\n            currency: { type: \"string\", enum: importEnums.currency, default: \"USD\" }\n          }\n        },\n        tasks: {\n          type: \"array\",\n          description: \"WBS task hierarchy. Use wbsCode to define hierarchy (e.g., '1', '1.1', '1.1.1' for parent-child relationships)\",\n          items: {\n            type: \"object\",\n            required: [\"wbsCode\", \"name\"],\n            properties: {\n              wbsCode: { type: \"string\", description: \"WBS code defines hierarchy. Examples: '1' (level 1), '1.1' (child of 1), '1.1.2' (child of 1.1). Max 5 levels.\", pattern: \"^[0-9]+(\\\\.[0-9]+){0,4}$\" },\n              name: { type: \"string\", description: \"Task name\", maxLength: 255 },\n              description: { type: \"string\" },\n              status: { type: \"string\", enum: importEnums.taskStatus, default: \"not-started\" },\n              priority: { type: \"string\", enum: importEnums.taskPriority, default: \"medium\", description: \"IMPORTANT: Use 'medium' not 'normal'\" },\n              progress: { type: \"integer\", minimum: 0, maximum: 100, default: 0 },\n              startDate: { type: \"string\", format: \"date-time\" },\n              endDate: { type: \"string\", format: \"date-time\" },\n              assignedTo: { type: [\"string\", \"null\"], description: \"Assignee identifier (e.g., 'PM-01', 'ENG-LEAD'). Stored as text - no user account required.\" },\n              estimatedHours: { type: \"string\", description: \"Estimated hours as string (e.g., '480.00')\" },\n              actualHours: { type: \"string\", description: \"Actual hours as string\" },\n              discipline: { \n                type: \"string\", \n                description: \"FLEXIBLE: Any discipline text is accepted (e.g., 'management', 'engineering', 'procurement'). Known values auto-map to standard categories. Original text preserved for reporting.\",\n                examples: [\"management\", \"engineering\", \"civil\", \"mechanical\", \"electrical\", \"procurement\", \"construction\"]\n              }\n            }\n          }\n        },\n        risks: {\n          type: \"array\",\n          items: {\n            type: \"object\",\n            required: [\"title\"],\n            properties: {\n              code: { type: \"string\", description: \"Risk code (e.g., RISK-001). Auto-generated if not provided.\" },\n              title: { type: \"string\", maxLength: 255 },\n              description: { type: \"string\" },\n              category: { type: \"string\", description: \"Risk category (freeform text)\" },\n              probability: { type: \"integer\", minimum: 1, maximum: 5, description: \"1-5 scale (1=Very Low, 5=Very High)\" },\n              impact: { type: \"string\", enum: importEnums.riskImpact, default: \"medium\" },\n              status: { type: \"string\", enum: importEnums.riskStatus, default: \"identified\", description: \"IMPORTANT: Use 'identified' not 'active'\" },\n              owner: { type: [\"string\", \"null\"], description: \"Risk owner identifier\" },\n              mitigationPlan: { type: \"string\" }\n            }\n          }\n        },\n        issues: {\n          type: \"array\",\n          items: {\n            type: \"object\",\n            required: [\"title\"],\n            properties: {\n              code: { type: \"string\", description: \"Issue code (e.g., ISS-001). Auto-generated if not provided.\" },\n              title: { type: \"string\", maxLength: 255 },\n              description: { type: \"string\" },\n              priority: { type: \"string\", enum: importEnums.issuePriority, default: \"medium\" },\n              status: { type: \"string\", enum: importEnums.issueStatus, default: \"open\" },\n              assignedTo: { type: [\"string\", \"null\"] },\n              reportedBy: { type: [\"string\", \"null\"] },\n              resolution: { type: [\"string\", \"null\"] }\n            }\n          }\n        },\n        stakeholders: {\n          type: \"array\",\n          items: {\n            type: \"object\",\n            required: [\"name\"],\n            properties: {\n              name: { type: \"string\", maxLength: 255 },\n              role: { type: \"string\", enum: importEnums.stakeholderRole, default: \"other\" },\n              organization: { type: \"string\" },\n              email: { type: \"string\", format: \"email\" },\n              phone: { type: \"string\" },\n              influence: { type: \"integer\", minimum: 1, maximum: 5, description: \"1-5 scale\" },\n              interest: { type: \"integer\", minimum: 1, maximum: 5, description: \"1-5 scale\" }\n            }\n          }\n        },\n        costItems: {\n          type: \"array\",\n          items: {\n            type: \"object\",\n            required: [\"description\"],\n            properties: {\n              description: { type: \"string\" },\n              category: { type: \"string\", enum: importEnums.costCategory, default: \"other\" },\n              budgeted: { type: \"string\", description: \"Budgeted amount as string\" },\n              actual: { type: \"string\", description: \"Actual amount as string\" },\n              currency: { type: \"string\", enum: importEnums.currency, default: \"USD\" }\n            }\n          }\n        }\n      },\n      examples: [{\n        version: \"1.0\",\n        project: { name: \"Example Solar Project\", code: \"SOLAR-2025-001\", status: \"active\", budget: \"50000000.00\", currency: \"USD\" },\n        tasks: [\n          { wbsCode: \"1\", name: \"Engineering\", status: \"in-progress\", priority: \"high\", progress: 50 },\n          { wbsCode: \"1.1\", name: \"Civil Design\", status: \"completed\", priority: \"critical\", progress: 100 }\n        ]\n      }],\n      valueMappings: {\n        description: \"The import system will automatically map these common alternative values:\",\n        taskPriority: { \"'normal' → 'medium'\": true, \"'urgent' → 'critical'\": true },\n        riskStatus: { \"'active' → 'identified'\": true, \"'open' → 'identified'\": true, \"'monitoring' → 'assessed'\": true },\n        stakeholderRole: { \"'owner' → 'sponsor'\": true, \"'customer' → 'client'\": true, \"'regulator' → 'regulatory'\": true }\n      }\n    };\n    \n    res.json(schema);\n  });\n  \n  // Get example template for import\n  app.get('/api/import/template', (req, res) => {\n    const template = {\n      version: \"1.0\",\n      project: {\n        name: \"Your Project Name\",\n        code: \"PROJECT-2025-001\",\n        description: \"Brief project description\",\n        status: \"active\",\n        startDate: new Date().toISOString(),\n        endDate: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString(),\n        budget: \"10000000.00\",\n        currency: \"USD\"\n      },\n      tasks: [\n        {\n          wbsCode: \"1\",\n          name: \"Phase 1 - Planning\",\n          description: \"Initial planning phase\",\n          status: \"not-started\",\n          priority: \"high\",\n          progress: 0,\n          startDate: new Date().toISOString(),\n          endDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),\n          assignedTo: \"PM-01\",  // Flexible: any text identifier works\n          estimatedHours: \"200.00\",\n          actualHours: \"0.00\",\n          discipline: \"management\"  // Flexible: any discipline text accepted\n        },\n        {\n          wbsCode: \"1.1\",\n          name: \"Requirements Gathering\",\n          description: \"Collect and document requirements\",\n          status: \"not-started\",\n          priority: \"critical\",\n          progress: 0,\n          assignedTo: \"ENG-LEAD\",  // Example: team role identifier\n          discipline: \"engineering\"  // Any EPC discipline term works\n        },\n        {\n          wbsCode: \"2\",\n          name: \"Phase 2 - Execution\",\n          description: \"Main execution phase\",\n          status: \"not-started\",\n          priority: \"critical\",\n          progress: 0,\n          assignedTo: \"CONST-DIR\",\n          discipline: \"construction\"\n        }\n      ],\n      risks: [\n        {\n          code: \"RISK-001\",\n          title: \"Example Risk\",\n          description: \"Description of the risk\",\n          category: \"technical\",\n          probability: 3,\n          impact: \"medium\",\n          status: \"identified\",\n          owner: null,\n          mitigationPlan: \"Mitigation strategy\"\n        }\n      ],\n      issues: [\n        {\n          code: \"ISS-001\",\n          title: \"Example Issue\",\n          description: \"Description of the issue\",\n          priority: \"medium\",\n          status: \"open\",\n          assignedTo: null,\n          reportedBy: null,\n          resolution: null\n        }\n      ],\n      stakeholders: [\n        {\n          name: \"Project Sponsor\",\n          role: \"sponsor\",\n          organization: \"Client Organization\",\n          email: \"sponsor@example.com\",\n          phone: \"+1-555-0100\",\n          influence: 5,\n          interest: 5\n        }\n      ],\n      costItems: [\n        {\n          description: \"Equipment Purchase\",\n          category: \"equipment\",\n          budgeted: \"500000.00\",\n          actual: \"0.00\",\n          currency: \"USD\"\n        }\n      ],\n      _instructions: {\n        usage: \"Copy this template and modify for your project. You can also provide this template to AI tools (ChatGPT, Claude, Gemini) as a reference format.\",\n        wbsHierarchy: \"WBS codes define parent-child relationships: '1' is parent of '1.1', which is parent of '1.1.1'. Maximum 5 levels.\",\n        flexibleFields: {\n          discipline: \"Any text accepted (e.g., 'management', 'engineering', 'procurement'). Known values auto-map to standard categories.\",\n          assignedTo: \"Any text identifier (e.g., 'PM-01', 'ENG-LEAD'). Stored as label - no user account required.\"\n        },\n        validEnums: {\n          ...importEnums,\n          _note: \"discipline is now FLEXIBLE - any text is accepted and preserved\"\n        },\n        tips: [\n          \"Priority must be: low, medium, high, or critical (not 'normal')\",\n          \"Risk status must be: identified, assessed, mitigating, or closed (not 'active')\",\n          \"Dates should be ISO 8601 format\",\n          \"Numbers should be strings (e.g., '1000.00')\",\n          \"discipline: ANY text is now accepted - use your own terminology\",\n          \"assignedTo: Use any identifier (PM-01, ENG-LEAD) - no user account needed\"\n        ],\n        labelManagement: \"After import, use Label Management to normalize discipline/assignee values for consistency.\"\n      }\n    };\n    \n    res.json(template);\n  });\n  \n  // Validate import data without importing\n  app.post('/api/import/validate', (req, res) => {\n    const importData = req.body;\n    const errors: string[] = [];\n    const warnings: string[] = [];\n    \n    if (!importData?.version) {\n      errors.push(\"Missing required field: version\");\n    }\n    \n    if (!importData?.project?.name) {\n      errors.push(\"Missing required field: project.name\");\n    }\n    \n    // Validate tasks\n    if (importData?.tasks) {\n      importData.tasks.forEach((task: any, index: number) => {\n        if (!task.wbsCode) errors.push(`Task ${index + 1}: Missing wbsCode`);\n        if (!task.name) errors.push(`Task ${index + 1}: Missing name`);\n        if (task.priority && !importEnums.taskPriority.includes(task.priority)) {\n          const mapped = valueMappings.taskPriority?.[task.priority];\n          if (mapped) {\n            warnings.push(`Task ${index + 1}: priority '${task.priority}' will be mapped to '${mapped}'`);\n          } else {\n            errors.push(`Task ${index + 1}: Invalid priority '${task.priority}'. Valid values: ${importEnums.taskPriority.join(\", \")}`);\n          }\n        }\n        if (task.status && !importEnums.taskStatus.includes(task.status)) {\n          errors.push(`Task ${index + 1}: Invalid status '${task.status}'. Valid values: ${importEnums.taskStatus.join(\", \")}`);\n        }\n      });\n    }\n    \n    // Validate risks\n    if (importData?.risks) {\n      importData.risks.forEach((risk: any, index: number) => {\n        if (!risk.title) errors.push(`Risk ${index + 1}: Missing title`);\n        if (risk.status && !importEnums.riskStatus.includes(risk.status)) {\n          const mapped = valueMappings.riskStatus?.[risk.status];\n          if (mapped) {\n            warnings.push(`Risk ${index + 1}: status '${risk.status}' will be mapped to '${mapped}'`);\n          } else {\n            errors.push(`Risk ${index + 1}: Invalid status '${risk.status}'. Valid values: ${importEnums.riskStatus.join(\", \")}`);\n          }\n        }\n        if (risk.impact && !importEnums.riskImpact.includes(risk.impact)) {\n          errors.push(`Risk ${index + 1}: Invalid impact '${risk.impact}'. Valid values: ${importEnums.riskImpact.join(\", \")}`);\n        }\n      });\n    }\n    \n    // Validate issues\n    if (importData?.issues) {\n      importData.issues.forEach((issue: any, index: number) => {\n        if (!issue.title) errors.push(`Issue ${index + 1}: Missing title`);\n        if (issue.status && !importEnums.issueStatus.includes(issue.status)) {\n          errors.push(`Issue ${index + 1}: Invalid status '${issue.status}'. Valid values: ${importEnums.issueStatus.join(\", \")}`);\n        }\n        if (issue.priority && !importEnums.issuePriority.includes(issue.priority)) {\n          errors.push(`Issue ${index + 1}: Invalid priority '${issue.priority}'. Valid values: ${importEnums.issuePriority.join(\", \")}`);\n        }\n      });\n    }\n    \n    res.json({\n      valid: errors.length === 0,\n      errors,\n      warnings,\n      summary: {\n        tasks: importData?.tasks?.length || 0,\n        risks: importData?.risks?.length || 0,\n        issues: importData?.issues?.length || 0,\n        stakeholders: importData?.stakeholders?.length || 0,\n        costItems: importData?.costItems?.length || 0\n      }\n    });\n  });\n  \n  // Input sanitization utilities for flexible text fields\n  const sanitizeText = (input: any, maxLength: number = 100): string | null => {\n    if (input === null || input === undefined) return null;\n    const str = String(input).trim();\n    if (str === '') return null;\n    // Remove potentially dangerous characters (XSS prevention)\n    const sanitized = str\n      .replace(/[<>]/g, '') // Remove angle brackets\n      .replace(/javascript:/gi, '') // Remove javascript: protocol\n      .replace(/on\\w+=/gi, '') // Remove event handlers like onclick=\n      .slice(0, maxLength); // Enforce length limit\n    return sanitized || null;\n  };\n  \n  // Validate text contains only safe characters\n  const isValidLabel = (input: string): boolean => {\n    // Allow alphanumeric, spaces, hyphens, underscores, dots, parentheses\n    return /^[\\w\\s\\-_.()\\/&]+$/i.test(input);\n  };\n  \n  // Helper to try enum mapping, return null if not valid (for flexible import)\n  const tryMapEnum = (category: string, value: string, validValues: string[]): string | null => {\n    if (!value) return null;\n    if (validValues.includes(value)) return value;\n    const mapped = valueMappings[category]?.[value];\n    return mapped || null;\n  };\n\n  // Import project data with validation and value mapping\n  app.post('/api/projects/:projectId/import', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const importData = req.body;\n      const errors: string[] = [];\n      const warnings: string[] = [];\n      \n      if (!importData || !importData.version) {\n        return res.status(400).json({ \n          success: false,\n          message: \"Invalid import format. Missing 'version' field.\",\n          hint: \"Get the correct format from GET /api/import/schema or GET /api/import/template\"\n        });\n      }\n      \n      // Helper to map values with fallback - for strict enum fields\n      const mapValue = (category: string, value: string, validValues: string[], defaultValue: string): string => {\n        if (!value) return defaultValue;\n        if (validValues.includes(value)) return value;\n        const mapped = valueMappings[category]?.[value];\n        if (mapped) {\n          warnings.push(`Mapped '${value}' to '${mapped}' for ${category}`);\n          return mapped;\n        }\n        // Don't error - just use default and warn\n        warnings.push(`Unknown ${category}: '${value}', using '${defaultValue}'`);\n        return defaultValue;\n      };\n      \n      // Helper to get parent WBS code\n      const getParentWbsCode = (wbsCode: string): string | null => {\n        const parts = wbsCode.split('.');\n        if (parts.length <= 1) return null;\n        return parts.slice(0, -1).join('.');\n      };\n      \n      let importedCounts = {\n        tasks: 0,\n        risks: 0,\n        issues: 0,\n        stakeholders: 0,\n        costItems: 0\n      };\n      \n      // Build WBS code to task ID map for hierarchy\n      const wbsToTaskId: Record<string, number> = {};\n      \n      // Sort tasks by WBS code depth to ensure parents are created first\n      const sortedTasks = [...(importData.tasks || [])].sort((a: any, b: any) => {\n        const aDepth = (a.wbsCode || '').split('.').length;\n        const bDepth = (b.wbsCode || '').split('.').length;\n        return aDepth - bDepth;\n      });\n      \n      // Import tasks with hierarchy and flexible text fields\n      for (const task of sortedTasks) {\n        try {\n          const wbsCode = task.wbsCode || `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n          const parentWbsCode = getParentWbsCode(wbsCode);\n          const parentId = parentWbsCode ? wbsToTaskId[parentWbsCode] : null;\n          \n          // Map strict enums with fallbacks\n          const mappedPriority = mapValue('taskPriority', task.priority, importEnums.taskPriority, 'medium');\n          const mappedStatus = task.status && importEnums.taskStatus.includes(task.status) ? task.status : 'not-started';\n          \n          // Try to map discipline to valid enum, otherwise store as flexible label\n          const disciplineEnumValue = tryMapEnum('discipline', task.discipline, importEnums.discipline);\n          const disciplineLabelValue = sanitizeText(task.discipline, 100);\n          \n          // If discipline isn't a valid enum, store the original as disciplineLabel\n          if (task.discipline && !disciplineEnumValue && disciplineLabelValue) {\n            warnings.push(`Task '${task.name}': discipline '${task.discipline}' stored as label (not in standard list)`);\n          }\n          \n          // Sanitize assignedTo - store as text label, don't try to link to user FK\n          const assignedToName = sanitizeText(task.assignedTo || task.assignee, 100);\n          if (assignedToName && !isValidLabel(assignedToName)) {\n            warnings.push(`Task '${task.name}': assignedTo contains invalid characters, sanitized`);\n          }\n          \n          const createdTask = await storage.createTask({\n            projectId,\n            parentId,\n            name: task.name || task.title || 'Untitled Task',\n            wbsCode,\n            createdBy: userId,\n            description: task.description,\n            status: mappedStatus as \"not-started\" | \"in-progress\" | \"review\" | \"completed\" | \"on-hold\",\n            progress: Math.min(100, Math.max(0, parseInt(task.progress) || 0)),\n            startDate: task.startDate ? new Date(task.startDate) : null,\n            endDate: task.endDate ? new Date(task.endDate) : null,\n            // Use assignedToName text field instead of FK\n            assignedTo: null, // Don't try to set FK from import\n            assignedToName: assignedToName,\n            priority: mappedPriority as \"low\" | \"medium\" | \"high\" | \"critical\",\n            estimatedHours: task.estimatedHours,\n            actualHours: task.actualHours,\n            // Use enum if valid, otherwise default to 'general'\n            discipline: (disciplineEnumValue || 'general') as any,\n            // Store original discipline text as label for flexibility\n            disciplineLabel: disciplineLabelValue\n          });\n          \n          wbsToTaskId[wbsCode] = createdTask.id;\n          importedCounts.tasks++;\n        } catch (taskError: any) {\n          errors.push(`Failed to import task '${task.name || task.wbsCode}': ${taskError.message}`);\n        }\n      }\n      \n      // Import risks\n      if (importData.risks && Array.isArray(importData.risks)) {\n        for (const risk of importData.risks) {\n          try {\n            const mappedStatus = mapValue('riskStatus', risk.status, importEnums.riskStatus, 'identified');\n            const mappedImpact = mapValue('riskImpact', risk.impact, importEnums.riskImpact, 'medium');\n            \n            await storage.createRisk({\n              projectId,\n              title: risk.title || 'Untitled Risk',\n              description: risk.description,\n              category: risk.category || 'other',\n              probability: Math.min(5, Math.max(1, parseInt(risk.probability) || 3)),\n              impact: mappedImpact as \"low\" | \"medium\" | \"high\" | \"critical\",\n              status: mappedStatus as \"identified\" | \"assessed\" | \"mitigating\" | \"closed\",\n              owner: risk.owner || null,\n              mitigationPlan: risk.mitigationPlan || risk.mitigationStrategy || risk.mitigation\n            });\n            importedCounts.risks++;\n          } catch (riskError: any) {\n            errors.push(`Failed to import risk '${risk.title}': ${riskError.message}`);\n          }\n        }\n      }\n      \n      // Import issues\n      if (importData.issues && Array.isArray(importData.issues)) {\n        for (const issue of importData.issues) {\n          try {\n            const mappedStatus = issue.status && importEnums.issueStatus.includes(issue.status) ? issue.status : 'open';\n            const mappedPriority = mapValue('issuePriority', issue.priority, importEnums.issuePriority, 'medium');\n            \n            await storage.createIssue({\n              projectId,\n              title: issue.title || 'Untitled Issue',\n              description: issue.description,\n              priority: mappedPriority as \"low\" | \"medium\" | \"high\" | \"critical\",\n              status: mappedStatus as \"open\" | \"in-progress\" | \"resolved\" | \"closed\",\n              assignedTo: issue.assignedTo || null,\n              reportedBy: issue.reportedBy || null,\n              resolution: issue.resolution || null\n            });\n            importedCounts.issues++;\n          } catch (issueError: any) {\n            errors.push(`Failed to import issue '${issue.title}': ${issueError.message}`);\n          }\n        }\n      }\n      \n      // Import stakeholders\n      if (importData.stakeholders && Array.isArray(importData.stakeholders)) {\n        for (const stakeholder of importData.stakeholders) {\n          try {\n            const mappedRole = mapValue('stakeholderRole', stakeholder.role, importEnums.stakeholderRole, 'other');\n            \n            await storage.createStakeholder({\n              projectId,\n              name: stakeholder.name || 'Unknown Stakeholder',\n              role: mappedRole as \"sponsor\" | \"client\" | \"team-member\" | \"contractor\" | \"consultant\" | \"other\",\n              organization: stakeholder.organization,\n              email: stakeholder.email,\n              phone: stakeholder.phone,\n              influence: Math.min(5, Math.max(1, parseInt(stakeholder.influence) || 3)),\n              interest: Math.min(5, Math.max(1, parseInt(stakeholder.interest) || 3))\n            });\n            importedCounts.stakeholders++;\n          } catch (stakeholderError: any) {\n            errors.push(`Failed to import stakeholder '${stakeholder.name}': ${stakeholderError.message}`);\n          }\n        }\n      }\n      \n      // Import cost items\n      if (importData.costItems && Array.isArray(importData.costItems)) {\n        for (const costItem of importData.costItems) {\n          try {\n            const mappedCategory = costItem.category && importEnums.costCategory.includes(costItem.category) ? costItem.category : 'other';\n            \n            await storage.createCostItem({\n              projectId,\n              description: costItem.description || costItem.name || 'Unnamed Cost',\n              category: mappedCategory,\n              budgeted: costItem.budgeted,\n              actual: costItem.actual,\n              currency: costItem.currency || 'USD'\n            });\n            importedCounts.costItems++;\n          } catch (costError: any) {\n            errors.push(`Failed to import cost item '${costItem.description}': ${costError.message}`);\n          }\n        }\n      }\n      \n      res.json({\n        success: errors.length === 0,\n        imported: importedCounts,\n        errors: errors.length > 0 ? errors : undefined,\n        warnings: warnings.length > 0 ? warnings : undefined,\n        message: errors.length === 0 \n          ? `Successfully imported ${importedCounts.tasks} tasks, ${importedCounts.risks} risks, ${importedCounts.issues} issues, ${importedCounts.stakeholders} stakeholders, ${importedCounts.costItems} cost items`\n          : `Import completed with ${errors.length} error(s)`\n      });\n    } catch (error: any) {\n      console.error(\"Error importing project:\", error);\n      res.status(500).json({ \n        success: false,\n        message: \"Failed to import project\",\n        error: error.message,\n        hint: \"Validate your JSON first using POST /api/import/validate\"\n      });\n    }\n  });\n\n  // ===== Label Management API Routes =====\n  \n  // Get unique discipline labels used in a project\n  app.get('/api/projects/:projectId/labels/disciplines', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const tasks = await storage.getTasksByProject(projectId);\n      \n      // Get unique discipline labels and counts\n      const disciplineStats: Record<string, { enum: string | null, label: string | null, count: number }> = {};\n      \n      for (const task of tasks) {\n        const key = (task as any).disciplineLabel || task.discipline || 'general';\n        if (!disciplineStats[key]) {\n          disciplineStats[key] = {\n            enum: task.discipline,\n            label: (task as any).disciplineLabel,\n            count: 0\n          };\n        }\n        disciplineStats[key].count++;\n      }\n      \n      res.json({\n        disciplines: Object.entries(disciplineStats).map(([value, stats]) => ({\n          value,\n          disciplineEnum: stats.enum,\n          disciplineLabel: stats.label,\n          taskCount: stats.count\n        })),\n        total: tasks.length\n      });\n    } catch (error: any) {\n      console.error(\"Error getting discipline labels:\", error);\n      res.status(500).json({ message: \"Failed to get discipline labels\" });\n    }\n  });\n  \n  // Get unique assignee names used in a project\n  app.get('/api/projects/:projectId/labels/assignees', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const tasks = await storage.getTasksByProject(projectId);\n      \n      // Get unique assignee names and counts\n      const assigneeStats: Record<string, { userId: string | null, name: string | null, count: number }> = {};\n      \n      for (const task of tasks) {\n        const name = (task as any).assignedToName;\n        if (name) {\n          if (!assigneeStats[name]) {\n            assigneeStats[name] = {\n              userId: task.assignedTo,\n              name: name,\n              count: 0\n            };\n          }\n          assigneeStats[name].count++;\n        }\n      }\n      \n      res.json({\n        assignees: Object.entries(assigneeStats).map(([value, stats]) => ({\n          value,\n          linkedUserId: stats.userId,\n          taskCount: stats.count\n        })),\n        total: Object.keys(assigneeStats).length\n      });\n    } catch (error: any) {\n      console.error(\"Error getting assignee labels:\", error);\n      res.status(500).json({ message: \"Failed to get assignee labels\" });\n    }\n  });\n  \n  // Bulk update discipline labels (find and replace)\n  app.post('/api/projects/:projectId/labels/disciplines/replace', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const { oldValue, newValue, updateEnum } = req.body;\n      \n      if (!oldValue || !newValue) {\n        return res.status(400).json({ message: \"Both oldValue and newValue are required\" });\n      }\n      \n      // Sanitize the new value\n      const sanitizedNew = sanitizeText(newValue, 100);\n      if (!sanitizedNew) {\n        return res.status(400).json({ message: \"Invalid newValue after sanitization\" });\n      }\n      \n      const tasks = await storage.getTasksByProject(projectId);\n      let updatedCount = 0;\n      \n      for (const task of tasks) {\n        const currentLabel = (task as any).disciplineLabel;\n        if (currentLabel === oldValue) {\n          // Determine if new value maps to a valid enum\n          const newEnumValue = tryMapEnum('discipline', sanitizedNew.toLowerCase(), importEnums.discipline);\n          \n          await storage.updateTask(task.id, {\n            disciplineLabel: sanitizedNew,\n            discipline: updateEnum && newEnumValue ? newEnumValue as any : task.discipline\n          });\n          updatedCount++;\n        }\n      }\n      \n      res.json({\n        success: true,\n        message: `Updated ${updatedCount} task(s)`,\n        updatedCount\n      });\n    } catch (error: any) {\n      console.error(\"Error replacing discipline labels:\", error);\n      res.status(500).json({ message: \"Failed to replace discipline labels\" });\n    }\n  });\n  \n  // Bulk update assignee names (find and replace)\n  app.post('/api/projects/:projectId/labels/assignees/replace', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const { oldValue, newValue, linkToUserId } = req.body;\n      \n      if (!oldValue || !newValue) {\n        return res.status(400).json({ message: \"Both oldValue and newValue are required\" });\n      }\n      \n      // Sanitize the new value\n      const sanitizedNew = sanitizeText(newValue, 100);\n      if (!sanitizedNew) {\n        return res.status(400).json({ message: \"Invalid newValue after sanitization\" });\n      }\n      \n      const tasks = await storage.getTasksByProject(projectId);\n      let updatedCount = 0;\n      \n      for (const task of tasks) {\n        const currentName = (task as any).assignedToName;\n        if (currentName === oldValue) {\n          await storage.updateTask(task.id, {\n            assignedToName: sanitizedNew,\n            assignedTo: linkToUserId || task.assignedTo\n          });\n          updatedCount++;\n        }\n      }\n      \n      res.json({\n        success: true,\n        message: `Updated ${updatedCount} task(s)`,\n        updatedCount\n      });\n    } catch (error: any) {\n      console.error(\"Error replacing assignee labels:\", error);\n      res.status(500).json({ message: \"Failed to replace assignee labels\" });\n    }\n  });\n\n  // ===== PDF Report Generation Routes =====\n  \n  // Helper to send PDF response\n  const sendPdfResponse = (res: Response, pdfDoc: PDFKit.PDFDocument, filename: string) => {\n    res.setHeader('Content-Type', 'application/pdf');\n    res.setHeader('Content-Disposition', `attachment; filename=\"${filename}\"`);\n    pdfDoc.pipe(res);\n    pdfDoc.end();\n  };\n\n  // Risk Register Report\n  app.get('/api/projects/:projectId/reports/risk-register', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const project = await storage.getProject(projectId);\n      if (!project) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      const risks = await storage.getRisksByProject(projectId);\n      const user = await storage.getUser(userId);\n      \n      const pdfDoc = generateRiskRegisterReport({\n        project,\n        risks,\n        generatedBy: user?.firstName && user?.lastName \n          ? `${user.firstName} ${user.lastName}` \n          : user?.email || 'System'\n      });\n      \n      const filename = `${project.code}_Risk_Register_${new Date().toISOString().split('T')[0]}.pdf`;\n      sendPdfResponse(res, pdfDoc, filename);\n    } catch (error) {\n      console.error(\"Error generating risk register report:\", error);\n      res.status(500).json({ message: \"Failed to generate report\" });\n    }\n  });\n\n  // Project Status Report\n  app.get('/api/projects/:projectId/reports/status', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const project = await storage.getProject(projectId);\n      if (!project) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      const [tasks, risks, issues, costItems] = await Promise.all([\n        storage.getTasksByProject(projectId),\n        storage.getRisksByProject(projectId),\n        storage.getIssuesByProject(projectId),\n        storage.getCostItemsByProject(projectId)\n      ]);\n      \n      const user = await storage.getUser(userId);\n      \n      const pdfDoc = generateProjectStatusReport({\n        project,\n        tasks,\n        risks,\n        issues,\n        costItems,\n        generatedBy: user?.firstName && user?.lastName \n          ? `${user.firstName} ${user.lastName}` \n          : user?.email || 'System'\n      });\n      \n      const filename = `${project.code}_Status_Report_${new Date().toISOString().split('T')[0]}.pdf`;\n      sendPdfResponse(res, pdfDoc, filename);\n    } catch (error) {\n      console.error(\"Error generating project status report:\", error);\n      res.status(500).json({ message: \"Failed to generate report\" });\n    }\n  });\n\n  // Earned Value Analysis Report\n  app.get('/api/projects/:projectId/reports/eva', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const project = await storage.getProject(projectId);\n      if (!project) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      const [tasks, costItems] = await Promise.all([\n        storage.getTasksByProject(projectId),\n        storage.getCostItemsByProject(projectId)\n      ]);\n      \n      const user = await storage.getUser(userId);\n      \n      const pdfDoc = generateEVAReport({\n        project,\n        tasks,\n        costItems,\n        generatedBy: user?.firstName && user?.lastName \n          ? `${user.firstName} ${user.lastName}` \n          : user?.email || 'System'\n      });\n      \n      const filename = `${project.code}_EVA_Report_${new Date().toISOString().split('T')[0]}.pdf`;\n      sendPdfResponse(res, pdfDoc, filename);\n    } catch (error) {\n      console.error(\"Error generating EVA report:\", error);\n      res.status(500).json({ message: \"Failed to generate report\" });\n    }\n  });\n\n  // Issue Log Report\n  app.get('/api/projects/:projectId/reports/issues', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const project = await storage.getProject(projectId);\n      if (!project) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      const issues = await storage.getIssuesByProject(projectId);\n      const user = await storage.getUser(userId);\n      \n      const pdfDoc = generateIssueLogReport({\n        project,\n        issues,\n        generatedBy: user?.firstName && user?.lastName \n          ? `${user.firstName} ${user.lastName}` \n          : user?.email || 'System'\n      });\n      \n      const filename = `${project.code}_Issue_Log_${new Date().toISOString().split('T')[0]}.pdf`;\n      sendPdfResponse(res, pdfDoc, filename);\n    } catch (error) {\n      console.error(\"Error generating issue log report:\", error);\n      res.status(500).json({ message: \"Failed to generate report\" });\n    }\n  });\n\n  // =============== EMAIL TEMPLATES ROUTES ===============\n  \n  // Get all default email templates (for reference)\n  app.get('/api/email-templates/defaults', isAuthenticated, async (req: any, res) => {\n    try {\n      const templates = getAllDefaultTemplates();\n      res.json(templates);\n    } catch (error) {\n      console.error(\"Error getting default templates:\", error);\n      res.status(500).json({ message: \"Failed to get default templates\" });\n    }\n  });\n\n  // Get available placeholders for a template type\n  app.get('/api/email-templates/placeholders/:type', isAuthenticated, async (req: any, res) => {\n    try {\n      const { type } = req.params;\n      const placeholders = getAvailablePlaceholders(type);\n      res.json({ type, placeholders });\n    } catch (error) {\n      console.error(\"Error getting placeholders:\", error);\n      res.status(500).json({ message: \"Failed to get placeholders\" });\n    }\n  });\n\n  // Get organization email templates\n  app.get('/api/organizations/:orgId/email-templates', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const orgId = parseInt(req.params.orgId);\n      \n      if (!await checkOrganizationAccess(userId, orgId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const templates = await storage.getEmailTemplatesByOrganization(orgId);\n      res.json(templates);\n    } catch (error) {\n      console.error(\"Error getting email templates:\", error);\n      res.status(500).json({ message: \"Failed to get email templates\" });\n    }\n  });\n\n  // Get single email template\n  app.get('/api/organizations/:orgId/email-templates/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const orgId = parseInt(req.params.orgId);\n      const templateId = parseInt(req.params.id);\n      \n      if (!await checkOrganizationAccess(userId, orgId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const template = await storage.getEmailTemplate(templateId);\n      if (!template || template.organizationId !== orgId) {\n        return res.status(404).json({ message: \"Template not found\" });\n      }\n      \n      res.json(template);\n    } catch (error) {\n      console.error(\"Error getting email template:\", error);\n      res.status(500).json({ message: \"Failed to get email template\" });\n    }\n  });\n\n  // Create email template\n  app.post('/api/organizations/:orgId/email-templates', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const orgId = parseInt(req.params.orgId);\n      \n      if (!await checkOrganizationAccess(userId, orgId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const parsed = insertEmailTemplateSchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ message: \"Invalid data\", errors: parsed.error.issues });\n      }\n      \n      const template = await storage.createEmailTemplate({\n        ...parsed.data,\n        organizationId: orgId,\n        createdBy: userId\n      });\n      \n      res.status(201).json(template);\n    } catch (error) {\n      console.error(\"Error creating email template:\", error);\n      res.status(500).json({ message: \"Failed to create email template\" });\n    }\n  });\n\n  // Update email template\n  app.patch('/api/organizations/:orgId/email-templates/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const orgId = parseInt(req.params.orgId);\n      const templateId = parseInt(req.params.id);\n      \n      if (!await checkOrganizationAccess(userId, orgId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const existing = await storage.getEmailTemplate(templateId);\n      if (!existing || existing.organizationId !== orgId) {\n        return res.status(404).json({ message: \"Template not found\" });\n      }\n      \n      const parsed = updateEmailTemplateSchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ message: \"Invalid data\", errors: parsed.error.issues });\n      }\n      \n      const updated = await storage.updateEmailTemplate(templateId, parsed.data);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating email template:\", error);\n      res.status(500).json({ message: \"Failed to update email template\" });\n    }\n  });\n\n  // Delete email template\n  app.delete('/api/organizations/:orgId/email-templates/:id', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const orgId = parseInt(req.params.orgId);\n      const templateId = parseInt(req.params.id);\n      \n      if (!await checkOrganizationAccess(userId, orgId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const existing = await storage.getEmailTemplate(templateId);\n      if (!existing || existing.organizationId !== orgId) {\n        return res.status(404).json({ message: \"Template not found\" });\n      }\n      \n      await storage.deleteEmailTemplate(templateId);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting email template:\", error);\n      res.status(500).json({ message: \"Failed to delete email template\" });\n    }\n  });\n\n  // Preview email template with placeholders\n  app.post('/api/organizations/:orgId/email-templates/:id/preview', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const orgId = parseInt(req.params.orgId);\n      const templateId = parseInt(req.params.id);\n      \n      if (!await checkOrganizationAccess(userId, orgId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const template = await storage.getEmailTemplate(templateId);\n      if (!template || template.organizationId !== orgId) {\n        return res.status(404).json({ message: \"Template not found\" });\n      }\n      \n      const placeholders = req.body.placeholders || {};\n      const previewSubject = replacePlaceholders(template.subject, placeholders);\n      const previewBody = replacePlaceholders(template.body, placeholders);\n      \n      res.json({\n        subject: previewSubject,\n        body: previewBody\n      });\n    } catch (error) {\n      console.error(\"Error previewing template:\", error);\n      res.status(500).json({ message: \"Failed to preview template\" });\n    }\n  });\n\n  // Send test email\n  app.post('/api/organizations/:orgId/email-templates/:id/send-test', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const orgId = parseInt(req.params.orgId);\n      const templateId = parseInt(req.params.id);\n      \n      if (!await checkOrganizationAccess(userId, orgId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const template = await storage.getEmailTemplate(templateId);\n      if (!template || template.organizationId !== orgId) {\n        return res.status(404).json({ message: \"Template not found\" });\n      }\n      \n      const { toEmail, placeholders = {} } = req.body;\n      if (!toEmail) {\n        return res.status(400).json({ message: \"Email address required\" });\n      }\n      \n      const subject = replacePlaceholders(template.subject, placeholders);\n      const body = replacePlaceholders(template.body, placeholders);\n      \n      // Log the email to the database\n      const sentEmail = await storage.createSentEmail({\n        organizationId: orgId,\n        templateId,\n        toEmail,\n        subject,\n        status: 'pending'\n      });\n      \n      // Send via SendGrid\n      const result = await sendEmail({\n        to: toEmail,\n        subject,\n        htmlContent: body,\n        templateId,\n        organizationId: orgId\n      });\n      \n      // Update status\n      await storage.updateSentEmailStatus(\n        sentEmail.id, \n        result.success ? 'sent' : 'failed',\n        result.error\n      );\n      \n      // Increment usage counter\n      if (result.success) {\n        await storage.incrementEmailUsage(orgId);\n      }\n      \n      res.json({ \n        success: result.success, \n        message: result.success ? 'Test email sent' : result.error \n      });\n    } catch (error) {\n      console.error(\"Error sending test email:\", error);\n      res.status(500).json({ message: \"Failed to send test email\" });\n    }\n  });\n\n  // Get sent emails log\n  app.get('/api/organizations/:orgId/sent-emails', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const orgId = parseInt(req.params.orgId);\n      \n      if (!await checkOrganizationAccess(userId, orgId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const limit = parseInt(req.query.limit as string) || 100;\n      const sentEmails = await storage.getSentEmailsByOrganization(orgId, limit);\n      res.json(sentEmails);\n    } catch (error) {\n      console.error(\"Error getting sent emails:\", error);\n      res.status(500).json({ message: \"Failed to get sent emails\" });\n    }\n  });\n\n  // Get email usage for current month\n  app.get('/api/organizations/:orgId/email-usage', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const orgId = parseInt(req.params.orgId);\n      \n      if (!await checkOrganizationAccess(userId, orgId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const month = new Date().toISOString().slice(0, 7);\n      const usage = await storage.getEmailUsage(orgId, month);\n      \n      res.json({\n        month,\n        emailsSent: usage?.emailsSent || 0,\n        emailLimit: usage?.emailLimit || 1000\n      });\n    } catch (error) {\n      console.error(\"Error getting email usage:\", error);\n      res.status(500).json({ message: \"Failed to get email usage\" });\n    }\n  });\n\n  // WebSocket status endpoint\n  app.get('/api/ws/status', isAuthenticated, async (req: any, res) => {\n    res.json({\n      connectedUsers: wsManager.getConnectedUsers(),\n      timestamp: Date.now()\n    });\n  });\n\n  // ===== File Upload Routes =====\n  \n  // Get upload URL for a project file\n  app.post('/api/projects/:projectId/files/upload-url', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const project = await storage.getProject(projectId);\n      if (!project) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      const { fileSize } = req.body;\n      if (!fileSize || typeof fileSize !== 'number') {\n        return res.status(400).json({ message: \"fileSize is required\" });\n      }\n      \n      // Check quota\n      const quota = await storage.getStorageQuota(project.organizationId);\n      const currentUsed = quota?.usedBytes || 0;\n      const maxQuota = quota?.quotaBytes || 1073741824; // 1GB default\n      \n      if (currentUsed + fileSize > maxQuota) {\n        return res.status(400).json({ \n          message: \"Storage quota exceeded\",\n          currentUsed,\n          maxQuota,\n          requested: fileSize\n        });\n      }\n      \n      const { ObjectStorageService } = await import('./objectStorage');\n      const objectStorage = new ObjectStorageService();\n      const { uploadURL, objectId } = await objectStorage.getObjectEntityUploadURL(\n        project.organizationId, \n        projectId\n      );\n      \n      res.json({ uploadURL, objectId });\n    } catch (error) {\n      console.error(\"Error getting upload URL:\", error);\n      res.status(500).json({ message: \"Failed to get upload URL\" });\n    }\n  });\n  \n  // Register uploaded file after upload completes\n  app.post('/api/projects/:projectId/files', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const project = await storage.getProject(projectId);\n      if (!project) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      const { name, originalName, mimeType, size, objectPath, category, description } = req.body;\n      \n      if (!name || !originalName || !mimeType || !size || !objectPath) {\n        return res.status(400).json({ message: \"Missing required fields\" });\n      }\n      \n      // Set ACL policy on the uploaded object\n      const { ObjectStorageService } = await import('./objectStorage');\n      const objectStorage = new ObjectStorageService();\n      \n      try {\n        await objectStorage.trySetObjectEntityAclPolicy(objectPath, {\n          owner: userId,\n          organizationId: project.organizationId,\n          visibility: \"private\",\n        });\n      } catch (aclError) {\n        console.error(\"Error setting ACL policy:\", aclError);\n      }\n      \n      // Create file record\n      const file = await storage.createProjectFile({\n        projectId,\n        organizationId: project.organizationId,\n        name,\n        originalName,\n        mimeType,\n        size,\n        objectPath,\n        category: category || 'general',\n        description,\n        uploadedBy: userId\n      });\n      \n      // Update storage quota\n      await storage.incrementStorageUsage(project.organizationId, size);\n      \n      // Notify via WebSocket\n      wsManager.notifyProjectUpdate(projectId, 'file-created', file, userId);\n      \n      res.status(201).json(file);\n    } catch (error) {\n      console.error(\"Error creating file:\", error);\n      res.status(500).json({ message: \"Failed to create file\" });\n    }\n  });\n  \n  // Get project files\n  app.get('/api/projects/:projectId/files', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const files = await storage.getProjectFilesByProject(projectId);\n      res.json(files);\n    } catch (error) {\n      console.error(\"Error getting files:\", error);\n      res.status(500).json({ message: \"Failed to get files\" });\n    }\n  });\n  \n  // Update project file\n  app.patch('/api/projects/:projectId/files/:fileId', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      const fileId = parseInt(req.params.fileId);\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const existingFile = await storage.getProjectFile(fileId);\n      if (!existingFile || existingFile.projectId !== projectId) {\n        return res.status(404).json({ message: \"File not found\" });\n      }\n      \n      const { name, category, description } = req.body;\n      const updated = await storage.updateProjectFile(fileId, { name, category, description });\n      \n      wsManager.notifyProjectUpdate(projectId, 'file-updated', updated, userId);\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating file:\", error);\n      res.status(500).json({ message: \"Failed to update file\" });\n    }\n  });\n  \n  // Delete project file\n  app.delete('/api/projects/:projectId/files/:fileId', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      const fileId = parseInt(req.params.fileId);\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const existingFile = await storage.getProjectFile(fileId);\n      if (!existingFile || existingFile.projectId !== projectId) {\n        return res.status(404).json({ message: \"File not found\" });\n      }\n      \n      const project = await storage.getProject(projectId);\n      \n      // Delete from object storage\n      const { ObjectStorageService } = await import('./objectStorage');\n      const objectStorage = new ObjectStorageService();\n      try {\n        await objectStorage.deleteObject(existingFile.objectPath);\n      } catch (deleteError) {\n        console.error(\"Error deleting from object storage:\", deleteError);\n      }\n      \n      // Delete from database\n      await storage.deleteProjectFile(fileId);\n      \n      // Update storage quota\n      if (project) {\n        await storage.decrementStorageUsage(project.organizationId, existingFile.size);\n      }\n      \n      wsManager.notifyProjectUpdate(projectId, 'file-deleted', { id: fileId }, userId);\n      \n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting file:\", error);\n      res.status(500).json({ message: \"Failed to delete file\" });\n    }\n  });\n  \n  // Serve private object files (with access control)\n  app.get('/objects/:objectPath(*)', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const objectPath = `/objects/${req.params.objectPath}`;\n      \n      const { ObjectStorageService, ObjectNotFoundError } = await import('./objectStorage');\n      const { ObjectPermission } = await import('./objectAcl');\n      const objectStorage = new ObjectStorageService();\n      \n      // Get user's organization IDs for ACL check\n      const userOrgs = await storage.getUserOrganizations(userId);\n      const userOrgIds = userOrgs.map(uo => uo.organizationId);\n      \n      const objectFile = await objectStorage.getObjectEntityFile(objectPath);\n      const canAccess = await objectStorage.canAccessObjectEntity({\n        objectFile,\n        userId,\n        requestedPermission: ObjectPermission.READ,\n        userOrganizationIds: userOrgIds\n      });\n      \n      if (!canAccess) {\n        return res.status(401).json({ message: \"Access denied\" });\n      }\n      \n      objectStorage.downloadObject(objectFile, res);\n    } catch (error) {\n      console.error(\"Error serving object:\", error);\n      if ((error as any).name === 'ObjectNotFoundError') {\n        return res.status(404).json({ message: \"File not found\" });\n      }\n      res.status(500).json({ message: \"Failed to serve file\" });\n    }\n  });\n  \n  // Get storage quota for organization\n  app.get('/api/organizations/:orgId/storage', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const orgId = parseInt(req.params.orgId);\n      \n      if (!await checkOrganizationAccess(userId, orgId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const quota = await storage.getStorageQuota(orgId);\n      \n      res.json({\n        usedBytes: quota?.usedBytes || 0,\n        quotaBytes: quota?.quotaBytes || 1073741824,\n        usedPercent: quota ? Math.round((quota.usedBytes / quota.quotaBytes) * 100) : 0\n      });\n    } catch (error) {\n      console.error(\"Error getting storage quota:\", error);\n      res.status(500).json({ message: \"Failed to get storage quota\" });\n    }\n  });\n\n  // ===== Cloud Storage Routes =====\n  \n  // Get available cloud storage providers\n  app.get('/api/cloud-storage/providers', isAuthenticated, async (req: any, res) => {\n    try {\n      const { CLOUD_PROVIDERS } = await import('./cloudStorage');\n      \n      const providers = Object.entries(CLOUD_PROVIDERS).map(([key, config]) => ({\n        id: key,\n        name: config.displayName,\n        icon: config.icon,\n        configured: !!(process.env[config.clientIdEnv] && process.env[config.clientSecretEnv])\n      }));\n      \n      res.json(providers);\n    } catch (error) {\n      console.error(\"Error getting providers:\", error);\n      res.status(500).json({ message: \"Failed to get cloud storage providers\" });\n    }\n  });\n  \n  // Get cloud storage connections for organization\n  app.get('/api/organizations/:orgId/cloud-storage', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const orgId = parseInt(req.params.orgId);\n      \n      if (!await checkOrganizationAccess(userId, orgId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const connections = await storage.getCloudStorageConnectionsByOrganization(orgId);\n      \n      // Don't expose tokens to frontend\n      const safeConnections = connections.map(conn => ({\n        id: conn.id,\n        provider: conn.provider,\n        accountEmail: conn.accountEmail,\n        accountName: conn.accountName,\n        rootFolderName: conn.rootFolderName,\n        syncEnabled: conn.syncEnabled,\n        syncStatus: conn.syncStatus,\n        lastSyncAt: conn.lastSyncAt,\n        syncError: conn.syncError,\n        createdAt: conn.createdAt\n      }));\n      \n      res.json(safeConnections);\n    } catch (error) {\n      console.error(\"Error getting cloud storage connections:\", error);\n      res.status(500).json({ message: \"Failed to get cloud storage connections\" });\n    }\n  });\n  \n  // Get OAuth authorization URL for cloud provider\n  app.post('/api/organizations/:orgId/cloud-storage/auth-url', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const orgId = parseInt(req.params.orgId);\n      \n      if (!await checkOrganizationAccess(userId, orgId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const { provider } = req.body;\n      if (!provider) {\n        return res.status(400).json({ message: \"Provider is required\" });\n      }\n      \n      // Check if already connected\n      const existing = await storage.getCloudStorageConnectionByProvider(orgId, provider);\n      if (existing) {\n        return res.status(400).json({ message: \"Provider already connected. Disconnect first.\" });\n      }\n      \n      const { getAuthorizationUrl } = await import('./cloudStorage');\n      \n      // Create HMAC-signed state token for OAuth security\n      const statePayload = JSON.stringify({\n        organizationId: orgId,\n        userId,\n        provider,\n        timestamp: Date.now()\n      });\n      const statePayloadBase64 = Buffer.from(statePayload).toString('base64');\n      const stateSecret = process.env.SESSION_SECRET || 'oauth-state-secret';\n      const stateSignature = crypto\n        .createHmac('sha256', stateSecret)\n        .update(statePayloadBase64)\n        .digest('hex');\n      const state = `${statePayloadBase64}.${stateSignature}`;\n      \n      const redirectUri = `${req.protocol}://${req.get('host')}/api/cloud-storage/callback`;\n      const authUrl = getAuthorizationUrl(provider, state, redirectUri);\n      \n      res.json({ authUrl, state });\n    } catch (error) {\n      console.error(\"Error generating auth URL:\", error);\n      res.status(500).json({ message: \"Failed to generate authorization URL\" });\n    }\n  });\n  \n  // OAuth callback handler\n  app.get('/api/cloud-storage/callback', async (req: any, res) => {\n    try {\n      const { code, state, error: oauthError } = req.query;\n      \n      if (oauthError) {\n        return res.redirect(`/settings?error=${encodeURIComponent(oauthError)}`);\n      }\n      \n      if (!code || !state) {\n        return res.redirect('/settings?error=invalid_callback');\n      }\n      \n      // Verify HMAC-signed state\n      const stateParts = (state as string).split('.');\n      if (stateParts.length !== 2) {\n        return res.redirect('/settings?error=invalid_state');\n      }\n      \n      const [statePayloadBase64, providedSignature] = stateParts;\n      const stateSecret = process.env.SESSION_SECRET || 'oauth-state-secret';\n      const expectedSignature = crypto\n        .createHmac('sha256', stateSecret)\n        .update(statePayloadBase64)\n        .digest('hex');\n      \n      // Reject if signature lengths don't match (SHA256 HMAC is always 64 hex chars)\n      if (providedSignature.length !== 64 || expectedSignature.length !== 64) {\n        console.error(\"OAuth state invalid signature length\");\n        return res.redirect('/settings?error=invalid_state');\n      }\n      \n      // Use timing-safe comparison to prevent timing attacks\n      const providedBuffer = Buffer.from(providedSignature, 'hex');\n      const expectedBuffer = Buffer.from(expectedSignature, 'hex');\n      \n      if (providedBuffer.length !== expectedBuffer.length || \n          !crypto.timingSafeEqual(providedBuffer, expectedBuffer)) {\n        console.error(\"OAuth state signature mismatch - potential tampering\");\n        return res.redirect('/settings?error=invalid_state');\n      }\n      \n      // Decode state payload\n      let stateData;\n      try {\n        stateData = JSON.parse(Buffer.from(statePayloadBase64, 'base64').toString());\n      } catch {\n        return res.redirect('/settings?error=invalid_state');\n      }\n      \n      const { organizationId, userId, provider } = stateData;\n      \n      // Verify state timestamp (5 minute expiry)\n      if (Date.now() - stateData.timestamp > 5 * 60 * 1000) {\n        return res.redirect('/settings?error=state_expired');\n      }\n      \n      const { exchangeCodeForTokens, getCloudStorageProvider, CLOUD_PROVIDERS } = await import('./cloudStorage');\n      \n      const redirectUri = `${req.protocol}://${req.get('host')}/api/cloud-storage/callback`;\n      const tokens = await exchangeCodeForTokens(provider, code as string, redirectUri);\n      \n      // Create connection record\n      const connection = await storage.createCloudStorageConnection({\n        organizationId,\n        provider,\n        connectedBy: userId,\n        accessToken: tokens.accessToken,\n        refreshToken: tokens.refreshToken,\n        tokenExpiresAt: tokens.expiresAt,\n        syncEnabled: true\n      });\n      \n      // Get user info from provider\n      try {\n        const providerInstance = getCloudStorageProvider(connection);\n        const userInfo = await providerInstance.getUserInfo();\n        \n        await storage.updateCloudStorageConnection(connection.id, {\n          accountEmail: userInfo.email,\n          accountName: userInfo.name\n        });\n      } catch (e) {\n        console.error(\"Error getting user info:\", e);\n      }\n      \n      res.redirect(`/settings?success=cloud_storage_connected&provider=${provider}`);\n    } catch (error) {\n      console.error(\"OAuth callback error:\", error);\n      res.redirect('/settings?error=oauth_failed');\n    }\n  });\n  \n  // Disconnect cloud storage provider\n  app.delete('/api/organizations/:orgId/cloud-storage/:connectionId', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const orgId = parseInt(req.params.orgId);\n      const connectionId = parseInt(req.params.connectionId);\n      \n      if (!await checkOrganizationAccess(userId, orgId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const connection = await storage.getCloudStorageConnection(connectionId);\n      if (!connection || connection.organizationId !== orgId) {\n        return res.status(404).json({ message: \"Connection not found\" });\n      }\n      \n      // Delete synced files first\n      await storage.deleteCloudSyncedFilesByConnection(connectionId);\n      \n      // Delete connection\n      await storage.deleteCloudStorageConnection(connectionId);\n      \n      res.json({ message: \"Cloud storage disconnected\" });\n    } catch (error) {\n      console.error(\"Error disconnecting cloud storage:\", error);\n      res.status(500).json({ message: \"Failed to disconnect cloud storage\" });\n    }\n  });\n  \n  // Trigger sync for cloud storage connection\n  app.post('/api/organizations/:orgId/cloud-storage/:connectionId/sync', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const orgId = parseInt(req.params.orgId);\n      const connectionId = parseInt(req.params.connectionId);\n      const { projectId } = req.body;\n      \n      if (!await checkOrganizationAccess(userId, orgId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      if (!projectId) {\n        return res.status(400).json({ message: \"Project ID is required\" });\n      }\n      \n      const connection = await storage.getCloudStorageConnection(connectionId);\n      if (!connection || connection.organizationId !== orgId) {\n        return res.status(404).json({ message: \"Connection not found\" });\n      }\n      \n      if (!connection.syncEnabled) {\n        return res.status(400).json({ message: \"Sync is disabled for this connection\" });\n      }\n      \n      const { syncCloudFiles } = await import('./cloudStorage');\n      const stats = await syncCloudFiles(connection, projectId);\n      \n      res.json({\n        message: \"Sync completed\",\n        added: stats.added,\n        updated: stats.updated,\n        errors: stats.errors\n      });\n    } catch (error) {\n      console.error(\"Error syncing cloud storage:\", error);\n      res.status(500).json({ message: \"Failed to sync cloud storage\" });\n    }\n  });\n  \n  // List files from cloud storage\n  app.get('/api/organizations/:orgId/cloud-storage/:connectionId/files', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const orgId = parseInt(req.params.orgId);\n      const connectionId = parseInt(req.params.connectionId);\n      const { folderId } = req.query;\n      \n      if (!await checkOrganizationAccess(userId, orgId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const connection = await storage.getCloudStorageConnection(connectionId);\n      if (!connection || connection.organizationId !== orgId) {\n        return res.status(404).json({ message: \"Connection not found\" });\n      }\n      \n      const { getCloudStorageProvider } = await import('./cloudStorage');\n      const provider = getCloudStorageProvider(connection);\n      const files = await provider.listFiles(folderId as string | undefined);\n      \n      res.json(files);\n    } catch (error) {\n      console.error(\"Error listing cloud files:\", error);\n      res.status(500).json({ message: \"Failed to list cloud files\" });\n    }\n  });\n  \n  // Get synced files for a project\n  app.get('/api/projects/:projectId/cloud-files', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const files = await storage.getCloudSyncedFilesByProject(projectId);\n      res.json(files);\n    } catch (error) {\n      console.error(\"Error getting cloud synced files:\", error);\n      res.status(500).json({ message: \"Failed to get cloud synced files\" });\n    }\n  });\n\n  // ==================== SUBSCRIPTION & USAGE ROUTES ====================\n  \n  // Get all subscription plans\n  app.get('/api/subscription-plans', isAuthenticated, async (_req, res) => {\n    try {\n      const plans = await storage.getSubscriptionPlans();\n      res.json(plans);\n    } catch (error) {\n      console.error(\"Error getting subscription plans:\", error);\n      res.status(500).json({ message: \"Failed to get subscription plans\" });\n    }\n  });\n  \n  // Get organization subscription and usage\n  app.get('/api/organizations/:orgId/subscription', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const orgId = parseInt(req.params.orgId);\n      \n      if (!await checkOrganizationAccess(userId, orgId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const subscription = await storage.getOrganizationSubscription(orgId);\n      let plan = null;\n      \n      if (subscription) {\n        plan = await storage.getSubscriptionPlan(subscription.planId);\n      } else {\n        plan = await storage.getSubscriptionPlanByTier('free');\n      }\n      \n      res.json({ subscription, plan });\n    } catch (error) {\n      console.error(\"Error getting subscription:\", error);\n      res.status(500).json({ message: \"Failed to get subscription\" });\n    }\n  });\n  \n  // Get organization usage statistics\n  app.get('/api/organizations/:orgId/usage', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const orgId = parseInt(req.params.orgId);\n      \n      if (!await checkOrganizationAccess(userId, orgId)) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n      \n      const now = new Date();\n      const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;\n      \n      const [storageQuota, aiUsage, emailUsage, subscription] = await Promise.all([\n        storage.getStorageQuota(orgId),\n        storage.getAiUsageSummary(orgId, currentMonth),\n        storage.getEmailUsage(orgId, currentMonth),\n        storage.getOrganizationSubscription(orgId)\n      ]);\n      \n      let plan = null;\n      if (subscription) {\n        plan = await storage.getSubscriptionPlan(subscription.planId);\n      } else {\n        plan = await storage.getSubscriptionPlanByTier('free');\n      }\n      \n      const projects = await storage.getProjectsByOrganization(orgId);\n      const userOrgs = await storage.getUserOrganizations(userId);\n      const orgMembers = userOrgs.filter(uo => uo.organizationId === orgId);\n      \n      res.json({\n        storage: {\n          usedBytes: storageQuota?.usedBytes || 0,\n          quotaBytes: plan?.storageQuotaBytes || 1073741824,\n          usedPercent: storageQuota && plan ? Math.round((storageQuota.usedBytes / plan.storageQuotaBytes) * 100) : 0\n        },\n        ai: {\n          tokensUsed: aiUsage?.tokensUsed || 0,\n          tokenLimit: plan?.aiTokensMonthly || 10000,\n          requestCount: aiUsage?.requestCount || 0,\n          usedPercent: aiUsage && plan ? Math.round((aiUsage.tokensUsed / plan.aiTokensMonthly) * 100) : 0\n        },\n        email: {\n          emailsSent: emailUsage?.emailsSent || 0,\n          emailLimit: plan?.emailsMonthly || 100,\n          usedPercent: emailUsage && plan ? Math.round((emailUsage.emailsSent / plan.emailsMonthly) * 100) : 0\n        },\n        projects: {\n          count: projects.length,\n          limit: plan?.maxProjects || 3\n        },\n        users: {\n          count: orgMembers.length,\n          limit: plan?.maxUsers || 2\n        },\n        plan: plan ? {\n          tier: plan.tier,\n          name: plan.name,\n          includesCloudSync: plan.includesCloudSync,\n          includesAdvancedReports: plan.includesAdvancedReports\n        } : null\n      });\n    } catch (error) {\n      console.error(\"Error getting usage:\", error);\n      res.status(500).json({ message: \"Failed to get usage statistics\" });\n    }\n  });\n  \n  // Initialize default subscription plans (admin only - can be called once)\n  app.post('/api/admin/init-subscription-plans', isAuthenticated, async (_req, res) => {\n    try {\n      const existingPlans = await storage.getSubscriptionPlans();\n      if (existingPlans.length > 0) {\n        return res.status(400).json({ message: \"Plans already initialized\" });\n      }\n      \n      const defaultPlans = [\n        {\n          tier: 'free' as const,\n          name: 'Free',\n          description: 'Get started with basic project management features',\n          priceMonthly: '0',\n          priceYearly: '0',\n          maxProjects: 3,\n          maxTasksPerProject: 100,\n          maxUsers: 2,\n          storageQuotaBytes: 536870912, // 512MB\n          aiTokensMonthly: 10000,\n          emailsMonthly: 50,\n          includesCloudSync: false,\n          includesAdvancedReports: false,\n          includesWhiteLabel: false,\n          isActive: true\n        },\n        {\n          tier: 'starter' as const,\n          name: 'Starter',\n          description: 'Essential features for small teams',\n          priceMonthly: '29',\n          priceYearly: '290',\n          maxProjects: 10,\n          maxTasksPerProject: 500,\n          maxUsers: 5,\n          storageQuotaBytes: 2147483648, // 2GB\n          aiTokensMonthly: 50000,\n          emailsMonthly: 500,\n          includesCloudSync: true,\n          includesAdvancedReports: false,\n          includesWhiteLabel: false,\n          isActive: true\n        },\n        {\n          tier: 'professional' as const,\n          name: 'Professional',\n          description: 'Advanced features for growing organizations',\n          priceMonthly: '79',\n          priceYearly: '790',\n          maxProjects: 50,\n          maxTasksPerProject: 1000,\n          maxUsers: 20,\n          storageQuotaBytes: 10737418240, // 10GB\n          aiTokensMonthly: 200000,\n          emailsMonthly: 2000,\n          includesCloudSync: true,\n          includesAdvancedReports: true,\n          includesWhiteLabel: false,\n          isActive: true\n        },\n        {\n          tier: 'enterprise' as const,\n          name: 'Enterprise',\n          description: 'Full-featured solution for large enterprises',\n          priceMonthly: '199',\n          priceYearly: '1990',\n          maxProjects: 100,\n          maxTasksPerProject: 1000,\n          maxUsers: 100,\n          storageQuotaBytes: 53687091200, // 50GB\n          aiTokensMonthly: 1000000,\n          emailsMonthly: 10000,\n          includesCloudSync: true,\n          includesAdvancedReports: true,\n          includesWhiteLabel: true,\n          isActive: true\n        }\n      ];\n      \n      const createdPlans = [];\n      for (const plan of defaultPlans) {\n        const created = await storage.createSubscriptionPlan(plan);\n        createdPlans.push(created);\n      }\n      \n      res.json({ message: \"Subscription plans initialized\", plans: createdPlans });\n    } catch (error) {\n      console.error(\"Error initializing subscription plans:\", error);\n      res.status(500).json({ message: \"Failed to initialize subscription plans\" });\n    }\n  });\n\n  // ===== Admin Routes =====\n  // Admin middleware - check if user is platform admin\n  const isAdmin = async (req: any, res: Response, next: Function) => {\n    try {\n      const userId = getUserId(req);\n      const user = await storage.getUser(userId);\n      \n      // For now, check if user is an admin of any organization (in production, use a separate admin flag)\n      const orgs = await storage.getOrganizationsByUser(userId);\n      const isOrgAdmin = orgs.some(org => {\n        // Check if user is owner/admin role\n        return true; // For MVP, any authenticated user with orgs can view admin stats\n      });\n      \n      if (!isOrgAdmin) {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n      \n      next();\n    } catch (error) {\n      console.error(\"Admin auth error:\", error);\n      res.status(500).json({ message: \"Authentication error\" });\n    }\n  };\n\n  app.get('/api/admin/stats', isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      // Get platform-wide statistics\n      const organizations = await storage.getAllOrganizations();\n      const allUsers = await storage.getAllUsers();\n      \n      let totalProjects = 0;\n      let totalTasks = 0;\n      let totalStorage = 0;\n      let totalAiTokens = 0;\n      let totalEmails = 0;\n      const subscriptionCounts = { free: 0, pro: 0, enterprise: 0 };\n      \n      for (const org of organizations) {\n        const projects = await storage.getProjectsByOrganization(org.id);\n        totalProjects += projects.length;\n        \n        for (const project of projects) {\n          const tasks = await storage.getTasksByProject(project.id);\n          totalTasks += tasks.length;\n        }\n        \n        // Get subscription info\n        const subscription = await storage.getOrganizationSubscription(org.id);\n        if (subscription) {\n          const plan = await storage.getSubscriptionPlan(subscription.planId);\n          if (plan) {\n            const tier = plan.tier.toLowerCase();\n            if (tier === 'free' || tier === 'trial') subscriptionCounts.free++;\n            else if (tier === 'starter' || tier === 'professional') subscriptionCounts.pro++;\n            else if (tier === 'enterprise') subscriptionCounts.enterprise++;\n            else subscriptionCounts.free++;\n          }\n          \n          // Get usage stats\n          const usage = await storage.getOrganizationUsage(subscription.id);\n          if (usage) {\n            totalStorage += usage.storageUsedBytes;\n            totalAiTokens += usage.aiTokensUsed;\n            totalEmails += usage.emailsSent;\n          }\n        } else {\n          subscriptionCounts.free++;\n        }\n      }\n      \n      res.json({\n        organizations: organizations.length,\n        users: allUsers.length,\n        projects: totalProjects,\n        tasks: totalTasks,\n        activeSubscriptions: subscriptionCounts,\n        storageUsed: totalStorage,\n        aiTokensUsed: totalAiTokens,\n        emailsSent: totalEmails\n      });\n    } catch (error) {\n      console.error(\"Error fetching admin stats:\", error);\n      res.status(500).json({ message: \"Failed to fetch platform stats\" });\n    }\n  });\n\n  app.get('/api/admin/organizations', isAuthenticated, isAdmin, async (req: any, res) => {\n    try {\n      const organizations = await storage.getAllOrganizations();\n      \n      const orgSummaries = await Promise.all(organizations.map(async (org) => {\n        const users = await storage.getUsersByOrganization(org.id);\n        const projects = await storage.getProjectsByOrganization(org.id);\n        \n        let storageUsedMB = 0;\n        let storageLimitMB = 1024; // Default 1GB\n        let tier = 'free';\n        \n        const subscription = await storage.getOrganizationSubscription(org.id);\n        if (subscription) {\n          const plan = await storage.getSubscriptionPlan(subscription.planId);\n          if (plan) {\n            storageLimitMB = plan.storageQuotaBytes / (1024 * 1024);\n            tier = plan.tier;\n          }\n          \n          const usage = await storage.getOrganizationUsage(subscription.id);\n          if (usage) {\n            storageUsedMB = usage.storageUsedBytes / (1024 * 1024);\n          }\n        }\n        \n        return {\n          id: org.id,\n          name: org.name,\n          tier,\n          userCount: users.length,\n          projectCount: projects.length,\n          storageUsedMB,\n          storageLimitMB\n        };\n      }));\n      \n      res.json(orgSummaries);\n    } catch (error) {\n      console.error(\"Error fetching admin organizations:\", error);\n      res.status(500).json({ message: \"Failed to fetch organizations\" });\n    }\n  });\n\n  // ===== CPM Scheduling Routes =====\n  app.post('/api/projects/:projectId/schedule', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      // Get project for start date\n      const project = await storage.getProject(projectId);\n      const startDate = project?.startDate ? new Date(project.startDate) : new Date();\n      \n      // Run scheduling\n      const { schedulingService } = await import('./scheduling');\n      const result = await schedulingService.runSchedule(projectId, startDate);\n      \n      if (result.success) {\n        wsManager.notifyProjectUpdate(projectId, \"schedule-updated\", result, userId);\n      }\n      \n      res.json(result);\n    } catch (error) {\n      console.error(\"Error running schedule:\", error);\n      res.status(500).json({ message: \"Failed to run schedule\" });\n    }\n  });\n\n  app.get('/api/projects/:projectId/schedule', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      const { schedulingService } = await import('./scheduling');\n      const scheduleData = await schedulingService.getScheduleData(projectId);\n      \n      res.json(scheduleData);\n    } catch (error) {\n      console.error(\"Error getting schedule data:\", error);\n      res.status(500).json({ message: \"Failed to get schedule data\" });\n    }\n  });\n\n  app.get('/api/projects/:projectId/critical-path', isAuthenticated, async (req: any, res) => {\n    try {\n      const userId = getUserId(req);\n      const projectId = parseInt(req.params.projectId);\n      \n      if (!await checkProjectAccess(userId, projectId)) {\n        return res.status(404).json({ message: \"Project not found\" });\n      }\n      \n      const { schedulingService } = await import('./scheduling');\n      const scheduleData = await schedulingService.getScheduleData(projectId);\n      \n      const criticalTasks = scheduleData.filter(t => t.isCriticalPath);\n      const criticalPathLength = criticalTasks.reduce((sum, t) => sum + t.duration, 0);\n      \n      res.json({\n        tasks: criticalTasks,\n        totalDuration: criticalPathLength\n      });\n    } catch (error) {\n      console.error(\"Error getting critical path:\", error);\n      res.status(500).json({ message: \"Failed to get critical path\" });\n    }\n  });\n\n  const httpServer = createServer(app);\n  \n  // Initialize WebSocket server\n  wsManager.initialize(httpServer);\n  \n  return httpServer;\n}\n","size_bytes":156294},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","size_bytes":2695},"server/index-prod.ts":{"content":"import fs from \"node:fs\";\nimport path from \"node:path\";\nimport { type Server } from \"node:http\";\n\nimport express, { type Express } from \"express\";\nimport runApp from \"./app\";\n\nexport async function serveStatic(app: Express, _server: Server) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n\n(async () => {\n  await runApp(serveStatic);\n})();\n","size_bytes":712},"client/src/components/MetricCard.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { LucideIcon } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface MetricCardProps {\n  title: string;\n  value: string | number;\n  change?: number;\n  icon?: LucideIcon;\n  className?: string;\n}\n\nexport function MetricCard({ title, value, change, icon: Icon, className }: MetricCardProps) {\n  const isPositive = change !== undefined && change > 0;\n  const isNegative = change !== undefined && change < 0;\n\n  return (\n    <Card className={cn(\"hover-elevate\", className)} data-testid={`card-metric-${title.toLowerCase().replace(/\\s+/g, '-')}`}>\n      <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n        <CardTitle className=\"text-sm font-medium text-muted-foreground\">{title}</CardTitle>\n        {Icon && <Icon className=\"h-4 w-4 text-muted-foreground\" />}\n      </CardHeader>\n      <CardContent>\n        <div className=\"text-2xl font-bold\" data-testid={`text-metric-value-${title.toLowerCase().replace(/\\s+/g, '-')}`}>{value}</div>\n        {change !== undefined && (\n          <p className={cn(\n            \"text-xs mt-1\",\n            isPositive && \"text-chart-3\",\n            isNegative && \"text-destructive\"\n          )}>\n            {isPositive && \"+\"}\n            {change}% from last month\n          </p>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":1397},"client/src/components/TaskModal.tsx":{"content":"import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { \n  Loader2, AlertTriangle, AlertCircle, User, Calendar, FileText, \n  ArrowRight, ArrowLeft, Clock, Activity, Plus, X, Link2, GitBranch,\n  Pencil, Check\n} from \"lucide-react\";\nimport type { Task, Risk, Issue, ResourceAssignment, Resource, Document, TaskDependency } from \"@shared/schema\";\n\ntype TaskStatus = \"not-started\" | \"in-progress\" | \"review\" | \"completed\" | \"on-hold\";\ntype TaskPriority = \"low\" | \"medium\" | \"high\" | \"critical\";\ntype DependencyType = \"FS\" | \"SS\" | \"FF\" | \"SF\";\n\nconst DISCIPLINES = [\n  { value: \"civil\", label: \"Civil\" },\n  { value: \"structural\", label: \"Structural\" },\n  { value: \"mechanical\", label: \"Mechanical\" },\n  { value: \"piping\", label: \"Piping\" },\n  { value: \"electrical\", label: \"Electrical\" },\n  { value: \"instrumentation\", label: \"Instrumentation\" },\n  { value: \"process\", label: \"Process\" },\n  { value: \"hvac\", label: \"HVAC\" },\n  { value: \"architectural\", label: \"Architectural\" },\n  { value: \"general\", label: \"General\" },\n];\n\nconst CONSTRAINT_TYPES = [\n  { value: \"asap\", label: \"As Soon As Possible\" },\n  { value: \"alap\", label: \"As Late As Possible\" },\n  { value: \"mso\", label: \"Must Start On\" },\n  { value: \"mfo\", label: \"Must Finish On\" },\n  { value: \"snet\", label: \"Start No Earlier Than\" },\n  { value: \"snlt\", label: \"Start No Later Than\" },\n  { value: \"fnet\", label: \"Finish No Earlier Than\" },\n  { value: \"fnlt\", label: \"Finish No Later Than\" },\n];\n\nconst DEPENDENCY_TYPES = [\n  { value: \"FS\", label: \"Finish-to-Start (FS)\" },\n  { value: \"SS\", label: \"Start-to-Start (SS)\" },\n  { value: \"FF\", label: \"Finish-to-Finish (FF)\" },\n  { value: \"SF\", label: \"Start-to-Finish (SF)\" },\n];\n\ninterface TaskFormData {\n  name: string;\n  description: string;\n  status: TaskStatus;\n  priority: TaskPriority;\n  startDate: string;\n  endDate: string;\n  progress: number;\n  discipline: string;\n  areaCode: string;\n  weightFactor: number;\n  constraintType: string;\n  baselineStart: string;\n  baselineFinish: string;\n  responsibleContractor: string;\n}\n\ninterface TaskModalProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  task?: Task;\n  defaultStatus?: TaskStatus;\n  onClose?: () => void;\n  onSave?: (data: any) => void;\n}\n\nexport function TaskModal({ \n  open, \n  onOpenChange, \n  task, \n  defaultStatus = \"not-started\",\n  onClose,\n  onSave \n}: TaskModalProps) {\n  const { selectedProjectId } = useProject();\n  const { toast } = useToast();\n  const [activeTab, setActiveTab] = useState(\"details\");\n  const [selectedPredecessor, setSelectedPredecessor] = useState<string>(\"\");\n  const [selectedSuccessor, setSelectedSuccessor] = useState<string>(\"\");\n  const [predecessorLag, setPredecessorLag] = useState<number>(0);\n  const [successorLag, setSuccessorLag] = useState<number>(0);\n  const [predecessorType, setPredecessorType] = useState<DependencyType>(\"FS\");\n  const [successorType, setSuccessorType] = useState<DependencyType>(\"FS\");\n  const [editingDependency, setEditingDependency] = useState<number | null>(null);\n  \n  const getDefaultFormData = (): TaskFormData => ({\n    name: \"\",\n    description: \"\",\n    status: defaultStatus,\n    priority: \"medium\",\n    startDate: \"\",\n    endDate: \"\",\n    progress: 0,\n    discipline: \"\",\n    areaCode: \"\",\n    weightFactor: 1.0,\n    constraintType: \"asap\",\n    baselineStart: \"\",\n    baselineFinish: \"\",\n    responsibleContractor: \"\",\n  });\n\n  const [formData, setFormData] = useState<TaskFormData>(getDefaultFormData());\n  \n  const { data: allTasks = [] } = useQuery<Task[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/tasks`],\n    enabled: !!selectedProjectId && open,\n  });\n\n  const { data: risks = [] } = useQuery<Risk[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/risks`],\n    enabled: !!selectedProjectId && !!task && open,\n  });\n\n  const { data: issues = [] } = useQuery<Issue[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/issues`],\n    enabled: !!selectedProjectId && !!task && open,\n  });\n\n  const { data: resources = [] } = useQuery<Resource[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/resources`],\n    enabled: !!selectedProjectId && open,\n  });\n\n  const { data: documents = [] } = useQuery<Document[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/documents`],\n    enabled: !!selectedProjectId && open,\n  });\n\n  const { data: assignments = [] } = useQuery<ResourceAssignment[]>({\n    queryKey: [`/api/tasks/${task?.id}/assignments`],\n    enabled: !!task?.id && open,\n  });\n\n  const { data: dependencies = [] } = useQuery<TaskDependency[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/dependencies`],\n    enabled: !!selectedProjectId && open,\n  });\n\n  const { data: taskDocuments = [] } = useQuery<any[]>({\n    queryKey: [`/api/tasks/${task?.id}/documents`],\n    enabled: !!task?.id && open,\n  });\n\n  const { data: taskRisks = [] } = useQuery<any[]>({\n    queryKey: [`/api/tasks/${task?.id}/risks`],\n    enabled: !!task?.id && open,\n  });\n\n  const { data: taskIssues = [] } = useQuery<any[]>({\n    queryKey: [`/api/tasks/${task?.id}/issues`],\n    enabled: !!task?.id && open,\n  });\n\n  const { data: inheritedResources = [] } = useQuery<any[]>({\n    queryKey: [`/api/tasks/${task?.id}/inherited/resources`],\n    enabled: !!task?.id && open,\n  });\n\n  const { data: inheritedDocuments = [] } = useQuery<any[]>({\n    queryKey: [`/api/tasks/${task?.id}/inherited/documents`],\n    enabled: !!task?.id && open,\n  });\n\n  const { data: inheritedRisks = [] } = useQuery<any[]>({\n    queryKey: [`/api/tasks/${task?.id}/inherited/risks`],\n    enabled: !!task?.id && open,\n  });\n\n  const { data: inheritedIssues = [] } = useQuery<any[]>({\n    queryKey: [`/api/tasks/${task?.id}/inherited/issues`],\n    enabled: !!task?.id && open,\n  });\n  \n  useEffect(() => {\n    if (open) {\n      if (task) {\n        setFormData({\n          name: task.name || \"\",\n          description: task.description || \"\",\n          status: (task.status as TaskStatus) || \"not-started\",\n          priority: (task.priority as TaskPriority) || \"medium\",\n          startDate: task.startDate ? new Date(task.startDate).toISOString().split('T')[0] : \"\",\n          endDate: task.endDate ? new Date(task.endDate).toISOString().split('T')[0] : \"\",\n          progress: task.progress || 0,\n          discipline: (task as any).discipline || \"\",\n          areaCode: (task as any).areaCode || \"\",\n          weightFactor: (task as any).weightFactor || 1.0,\n          constraintType: (task as any).constraintType || \"asap\",\n          baselineStart: (task as any).baselineStart ? new Date((task as any).baselineStart).toISOString().split('T')[0] : \"\",\n          baselineFinish: (task as any).baselineFinish ? new Date((task as any).baselineFinish).toISOString().split('T')[0] : \"\",\n          responsibleContractor: (task as any).responsibleContractor || \"\",\n        });\n      } else {\n        setFormData({\n          ...getDefaultFormData(),\n          status: defaultStatus,\n        });\n      }\n      setActiveTab(\"details\");\n      setSelectedPredecessor(\"\");\n      setSelectedSuccessor(\"\");\n      setPredecessorLag(0);\n      setSuccessorLag(0);\n      setEditingDependency(null);\n    }\n  }, [open, task, defaultStatus]);\n\n  const createMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return await apiRequest(\"POST\", `/api/tasks`, {\n        ...data,\n        projectId: selectedProjectId,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${selectedProjectId}/tasks`] });\n      toast({\n        title: \"Success\",\n        description: \"Task created successfully\",\n      });\n      handleClose();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to create task\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return await apiRequest(\"PATCH\", `/api/tasks/${task?.id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${selectedProjectId}/tasks`] });\n      toast({\n        title: \"Success\",\n        description: \"Task updated successfully\",\n      });\n      handleClose();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to update task\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const addDependencyMutation = useMutation({\n    mutationFn: async (data: { predecessorId: number; successorId: number; type: DependencyType; lagDays: number }) => {\n      return await apiRequest(\"POST\", `/api/dependencies`, {\n        ...data,\n        projectId: selectedProjectId,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${selectedProjectId}/dependencies`] });\n      toast({ title: \"Success\", description: \"Dependency added\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const removeDependencyMutation = useMutation({\n    mutationFn: async (dependencyId: number) => {\n      return await apiRequest(\"DELETE\", `/api/dependencies/${dependencyId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${selectedProjectId}/dependencies`] });\n      toast({ title: \"Success\", description: \"Dependency removed\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const updateDependencyMutation = useMutation({\n    mutationFn: async ({ id, type, lagDays }: { id: number; type: DependencyType; lagDays: number }) => {\n      return await apiRequest(\"PATCH\", `/api/dependencies/${id}`, { type, lagDays });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${selectedProjectId}/dependencies`] });\n      toast({ title: \"Success\", description: \"Dependency updated\" });\n      setEditingDependency(null);\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const addResourceMutation = useMutation({\n    mutationFn: async (data: { resourceId: number; allocation: number }) => {\n      return await apiRequest(\"POST\", `/api/assignments`, {\n        taskId: task?.id,\n        ...data,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/tasks/${task?.id}/assignments`] });\n      toast({ title: \"Success\", description: \"Resource assigned\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const removeResourceMutation = useMutation({\n    mutationFn: async (assignmentId: number) => {\n      return await apiRequest(\"DELETE\", `/api/assignments/${assignmentId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/tasks/${task?.id}/assignments`] });\n      toast({ title: \"Success\", description: \"Resource removed\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const addDocumentMutation = useMutation({\n    mutationFn: async (data: { documentId: number; relationship?: string }) => {\n      return await apiRequest(\"POST\", `/api/tasks/${task?.id}/documents`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/tasks/${task?.id}/documents`] });\n      toast({ title: \"Success\", description: \"Document linked\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const removeDocumentMutation = useMutation({\n    mutationFn: async (documentId: number) => {\n      return await apiRequest(\"DELETE\", `/api/tasks/${task?.id}/documents/${documentId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/tasks/${task?.id}/documents`] });\n      toast({ title: \"Success\", description: \"Document unlinked\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const addRiskMutation = useMutation({\n    mutationFn: async (riskId: number) => {\n      return await apiRequest(\"POST\", `/api/tasks/${task?.id}/risks`, { riskId });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/tasks/${task?.id}/risks`] });\n      toast({ title: \"Success\", description: \"Risk linked\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const removeRiskMutation = useMutation({\n    mutationFn: async (riskId: number) => {\n      return await apiRequest(\"DELETE\", `/api/tasks/${task?.id}/risks/${riskId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/tasks/${task?.id}/risks`] });\n      toast({ title: \"Success\", description: \"Risk unlinked\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const addIssueMutation = useMutation({\n    mutationFn: async (issueId: number) => {\n      return await apiRequest(\"POST\", `/api/tasks/${task?.id}/issues`, { issueId });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/tasks/${task?.id}/issues`] });\n      toast({ title: \"Success\", description: \"Issue linked\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const removeIssueMutation = useMutation({\n    mutationFn: async (issueId: number) => {\n      return await apiRequest(\"DELETE\", `/api/tasks/${task?.id}/issues/${issueId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/tasks/${task?.id}/issues`] });\n      toast({ title: \"Success\", description: \"Issue unlinked\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const handleClose = () => {\n    setFormData(getDefaultFormData());\n    if (onClose) {\n      onClose();\n    } else {\n      onOpenChange(false);\n    }\n  };\n\n  const handleSave = () => {\n    if (!formData.name.trim()) {\n      toast({\n        title: \"Validation Error\",\n        description: \"Task name is required\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const taskData = {\n      name: formData.name,\n      description: formData.description || undefined,\n      status: formData.status,\n      priority: formData.priority,\n      startDate: formData.startDate ? new Date(formData.startDate).toISOString() : undefined,\n      endDate: formData.endDate ? new Date(formData.endDate).toISOString() : undefined,\n      progress: formData.progress,\n      discipline: formData.discipline || undefined,\n      areaCode: formData.areaCode || undefined,\n      weightFactor: formData.weightFactor || undefined,\n      constraintType: formData.constraintType || undefined,\n      baselineStart: formData.baselineStart ? new Date(formData.baselineStart).toISOString() : undefined,\n      baselineFinish: formData.baselineFinish ? new Date(formData.baselineFinish).toISOString() : undefined,\n      responsibleContractor: formData.responsibleContractor || undefined,\n    };\n\n    if (onSave) {\n      onSave(taskData);\n      handleClose();\n    } else if (task) {\n      updateMutation.mutate(taskData);\n    } else {\n      createMutation.mutate(taskData);\n    }\n  };\n\n  const predecessors = dependencies.filter((dep) => dep.successorId === task?.id);\n  const successors = dependencies.filter((dep) => dep.predecessorId === task?.id);\n  const availableTasks = allTasks.filter(t => t.id !== task?.id);\n  const linkedDocIds = taskDocuments.map((td: any) => td.documentId);\n  const linkedRiskIds = taskRisks.map((tr: any) => tr.riskId);\n  const linkedIssueIds = taskIssues.map((ti: any) => ti.issueId);\n  const assignedResourceIds = assignments.map(a => a.resourceId);\n\n  const getStatusBadge = (status: string) => {\n    const variants: Record<string, \"default\" | \"secondary\" | \"destructive\" | \"outline\"> = {\n      \"not-started\": \"secondary\",\n      \"in-progress\": \"default\",\n      \"review\": \"outline\",\n      \"completed\": \"default\",\n      \"on-hold\": \"destructive\",\n      \"identified\": \"secondary\",\n      \"analyzing\": \"outline\",\n      \"mitigating\": \"default\",\n      \"closed\": \"default\",\n      \"accepted\": \"secondary\",\n      \"open\": \"destructive\",\n      \"in_progress\": \"default\",\n      \"resolved\": \"default\",\n    };\n    return variants[status] || \"secondary\";\n  };\n\n  const getPriorityColor = (priority: string) => {\n    const colors: Record<string, string> = {\n      low: \"text-green-600\",\n      medium: \"text-amber-600\",\n      high: \"text-orange-600\",\n      critical: \"text-red-600\",\n    };\n    return colors[priority] || \"text-muted-foreground\";\n  };\n\n  const getTaskName = (taskId: number) => {\n    const t = allTasks.find(task => task.id === taskId);\n    return t ? `${t.wbsCode || '#' + t.id} - ${t.name}` : `Task #${taskId}`;\n  };\n\n  const isLoading = createMutation.isPending || updateMutation.isPending;\n  const isEditing = !!task;\n\n  return (\n    <Dialog open={open} onOpenChange={(open) => {\n      if (!open) handleClose();\n      else onOpenChange(open);\n    }}>\n      <DialogContent className=\"max-w-4xl max-h-[85vh] overflow-hidden flex flex-col\" data-testid=\"modal-task\">\n        <DialogHeader className=\"shrink-0\">\n          <div className=\"flex items-center justify-between\">\n            <DialogTitle className=\"flex items-center gap-2\">\n              {isEditing ? (\n                <>\n                  <Badge variant=\"outline\" className=\"font-mono\">\n                    {task.wbsCode || `#${task.id}`}\n                  </Badge>\n                  <span>{task.name}</span>\n                </>\n              ) : (\n                \"Create New Task\"\n              )}\n            </DialogTitle>\n            {isEditing && (\n              <div className=\"flex items-center gap-2\">\n                <Badge variant={getStatusBadge(formData.status)}>\n                  {formData.status.replace(\"-\", \" \")}\n                </Badge>\n                <Badge variant=\"outline\" className={getPriorityColor(formData.priority)}>\n                  {formData.priority}\n                </Badge>\n              </div>\n            )}\n          </div>\n        </DialogHeader>\n\n        <Tabs value={activeTab} onValueChange={setActiveTab} className=\"flex-1 overflow-hidden flex flex-col\">\n          <TabsList className=\"grid w-full grid-cols-6 shrink-0\">\n            <TabsTrigger value=\"details\">Details</TabsTrigger>\n            <TabsTrigger value=\"dependencies\" disabled={!isEditing}>\n              Dependencies {isEditing && (predecessors.length + successors.length > 0) && `(${predecessors.length + successors.length})`}\n            </TabsTrigger>\n            <TabsTrigger value=\"resources\" disabled={!isEditing}>\n              Resources {isEditing && assignments.length > 0 && `(${assignments.length})`}\n            </TabsTrigger>\n            <TabsTrigger value=\"documents\" disabled={!isEditing}>\n              Documents {isEditing && taskDocuments.length > 0 && `(${taskDocuments.length})`}\n            </TabsTrigger>\n            <TabsTrigger value=\"risks\" disabled={!isEditing}>\n              Risks {isEditing && taskRisks.length > 0 && `(${taskRisks.length})`}\n            </TabsTrigger>\n            <TabsTrigger value=\"issues\" disabled={!isEditing}>\n              Issues {isEditing && taskIssues.length > 0 && `(${taskIssues.length})`}\n            </TabsTrigger>\n          </TabsList>\n\n          <ScrollArea className=\"flex-1 mt-4\">\n            <div className=\"pr-4 pb-4\">\n              <TabsContent value=\"details\" className=\"space-y-6 mt-0\">\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                  <div className=\"space-y-4\">\n                    <h3 className=\"text-sm font-semibold text-muted-foreground\">Basic Information</h3>\n                    \n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"task-name\">Task Name *</Label>\n                      <Input\n                        id=\"task-name\"\n                        placeholder=\"Enter task name\"\n                        value={formData.name}\n                        onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                        data-testid=\"input-task-name\"\n                      />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"task-description\">Description</Label>\n                      <Textarea\n                        id=\"task-description\"\n                        placeholder=\"Enter task description\"\n                        rows={3}\n                        value={formData.description}\n                        onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                        data-testid=\"textarea-task-description\"\n                      />\n                    </div>\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"task-status\">Status</Label>\n                        <Select \n                          value={formData.status} \n                          onValueChange={(value: TaskStatus) => setFormData({ ...formData, status: value })}\n                        >\n                          <SelectTrigger id=\"task-status\" data-testid=\"select-task-status\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"not-started\">Not Started</SelectItem>\n                            <SelectItem value=\"in-progress\">In Progress</SelectItem>\n                            <SelectItem value=\"review\">In Review</SelectItem>\n                            <SelectItem value=\"completed\">Completed</SelectItem>\n                            <SelectItem value=\"on-hold\">On Hold</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"task-priority\">Priority</Label>\n                        <Select \n                          value={formData.priority} \n                          onValueChange={(value: TaskPriority) => setFormData({ ...formData, priority: value })}\n                        >\n                          <SelectTrigger id=\"task-priority\" data-testid=\"select-task-priority\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"low\">Low</SelectItem>\n                            <SelectItem value=\"medium\">Medium</SelectItem>\n                            <SelectItem value=\"high\">High</SelectItem>\n                            <SelectItem value=\"critical\">Critical</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"task-progress\">Progress: {formData.progress}%</Label>\n                      <Input\n                        id=\"task-progress\"\n                        type=\"range\"\n                        min=\"0\"\n                        max=\"100\"\n                        value={formData.progress}\n                        onChange={(e) => setFormData({ ...formData, progress: parseInt(e.target.value) })}\n                        className=\"cursor-pointer\"\n                        data-testid=\"slider-task-progress\"\n                      />\n                    </div>\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"start-date\">Start Date</Label>\n                        <Input\n                          id=\"start-date\"\n                          type=\"date\"\n                          value={formData.startDate}\n                          onChange={(e) => setFormData({ ...formData, startDate: e.target.value })}\n                          data-testid=\"input-start-date\"\n                        />\n                      </div>\n\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"end-date\">End Date</Label>\n                        <Input\n                          id=\"end-date\"\n                          type=\"date\"\n                          value={formData.endDate}\n                          onChange={(e) => setFormData({ ...formData, endDate: e.target.value })}\n                          data-testid=\"input-end-date\"\n                        />\n                      </div>\n                    </div>\n                  </div>\n\n                  <div className=\"space-y-4\">\n                    <h3 className=\"text-sm font-semibold text-muted-foreground\">EPC Details</h3>\n                    \n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"discipline\">Discipline</Label>\n                        <Select \n                          value={formData.discipline} \n                          onValueChange={(value) => setFormData({ ...formData, discipline: value })}\n                        >\n                          <SelectTrigger id=\"discipline\" data-testid=\"select-discipline\">\n                            <SelectValue placeholder=\"Select discipline\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {DISCIPLINES.map((disc) => (\n                              <SelectItem key={disc.value} value={disc.value}>{disc.label}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"area-code\">Area Code</Label>\n                        <Input\n                          id=\"area-code\"\n                          placeholder=\"e.g., A-100\"\n                          value={formData.areaCode}\n                          onChange={(e) => setFormData({ ...formData, areaCode: e.target.value })}\n                          data-testid=\"input-area-code\"\n                        />\n                      </div>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label htmlFor=\"contractor\">Responsible Contractor</Label>\n                      <Input\n                        id=\"contractor\"\n                        placeholder=\"Enter contractor name\"\n                        value={formData.responsibleContractor}\n                        onChange={(e) => setFormData({ ...formData, responsibleContractor: e.target.value })}\n                        data-testid=\"input-contractor\"\n                      />\n                    </div>\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"constraint-type\">Constraint Type</Label>\n                        <Select \n                          value={formData.constraintType} \n                          onValueChange={(value) => setFormData({ ...formData, constraintType: value })}\n                        >\n                          <SelectTrigger id=\"constraint-type\" data-testid=\"select-constraint\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {CONSTRAINT_TYPES.map((ct) => (\n                              <SelectItem key={ct.value} value={ct.value}>{ct.label}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"weight-factor\">Weight Factor</Label>\n                        <Input\n                          id=\"weight-factor\"\n                          type=\"number\"\n                          step=\"0.01\"\n                          min=\"0\"\n                          max=\"1\"\n                          value={formData.weightFactor}\n                          onChange={(e) => setFormData({ ...formData, weightFactor: parseFloat(e.target.value) || 0 })}\n                          data-testid=\"input-weight-factor\"\n                        />\n                      </div>\n                    </div>\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"baseline-start\">Baseline Start</Label>\n                        <Input\n                          id=\"baseline-start\"\n                          type=\"date\"\n                          value={formData.baselineStart}\n                          onChange={(e) => setFormData({ ...formData, baselineStart: e.target.value })}\n                          data-testid=\"input-baseline-start\"\n                        />\n                      </div>\n\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"baseline-finish\">Baseline Finish</Label>\n                        <Input\n                          id=\"baseline-finish\"\n                          type=\"date\"\n                          value={formData.baselineFinish}\n                          onChange={(e) => setFormData({ ...formData, baselineFinish: e.target.value })}\n                          data-testid=\"input-baseline-finish\"\n                        />\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"dependencies\" className=\"space-y-4 mt-0\">\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center gap-2 p-4 bg-muted/50 rounded-lg\">\n                    <GitBranch className=\"h-5 w-5 text-muted-foreground\" />\n                    <div>\n                      <p className=\"text-sm font-medium\">Task Dependencies</p>\n                      <p className=\"text-xs text-muted-foreground\">\n                        Define predecessor (tasks that must finish before this task) and successor (tasks that wait for this task) relationships\n                      </p>\n                    </div>\n                  </div>\n\n                  <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\n                    <div className=\"border rounded-lg p-4 space-y-4\">\n                      <div className=\"flex items-center justify-between\">\n                        <h4 className=\"text-sm font-semibold flex items-center gap-2\">\n                          <ArrowLeft className=\"h-4 w-4 text-blue-500\" />\n                          Predecessors\n                          <Badge variant=\"secondary\" className=\"ml-1\">{predecessors.length}</Badge>\n                        </h4>\n                      </div>\n                      \n                      <p className=\"text-xs text-muted-foreground\">Tasks that must complete before this task can start</p>\n                      \n                      <div className=\"space-y-3 p-3 bg-muted/30 rounded-lg\">\n                        <div className=\"space-y-2\">\n                          <Label className=\"text-xs font-medium\">Add Predecessor</Label>\n                          <Select value={selectedPredecessor} onValueChange={setSelectedPredecessor}>\n                            <SelectTrigger data-testid=\"select-predecessor\" className=\"w-full\">\n                              <SelectValue placeholder=\"Select a task...\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {availableTasks\n                                .filter(t => !predecessors.some(p => p.predecessorId === t.id))\n                                .map((t) => (\n                                  <SelectItem key={t.id} value={t.id.toString()}>\n                                    <span className=\"font-mono text-xs\">{t.wbsCode || `#${t.id}`}</span>\n                                    <span className=\"ml-2\">{t.name}</span>\n                                  </SelectItem>\n                                ))}\n                            </SelectContent>\n                          </Select>\n                        </div>\n                        <div className=\"flex gap-2\">\n                          <div className=\"flex-1\">\n                            <Label className=\"text-xs\">Type</Label>\n                            <Select value={predecessorType} onValueChange={(v: DependencyType) => setPredecessorType(v)}>\n                              <SelectTrigger data-testid=\"select-predecessor-type\" className=\"w-full\">\n                                <SelectValue />\n                              </SelectTrigger>\n                              <SelectContent>\n                                {DEPENDENCY_TYPES.map((dt) => (\n                                  <SelectItem key={dt.value} value={dt.value}>\n                                    <span className=\"font-mono\">{dt.value}</span>\n                                    <span className=\"ml-2 text-muted-foreground text-xs\">({dt.label})</span>\n                                  </SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                          </div>\n                          <div className=\"w-20\">\n                            <Label className=\"text-xs\">Lag</Label>\n                            <Input\n                              type=\"number\"\n                              value={predecessorLag}\n                              onChange={(e) => setPredecessorLag(parseInt(e.target.value) || 0)}\n                              placeholder=\"0\"\n                              data-testid=\"input-predecessor-lag\"\n                            />\n                          </div>\n                        </div>\n                        <Button \n                          className=\"w-full\" \n                          size=\"sm\"\n                          onClick={() => {\n                            if (!selectedPredecessor || !task) return;\n                            addDependencyMutation.mutate({\n                              predecessorId: parseInt(selectedPredecessor),\n                              successorId: task.id,\n                              type: predecessorType,\n                              lagDays: predecessorLag,\n                            });\n                            setSelectedPredecessor(\"\");\n                            setPredecessorLag(0);\n                          }}\n                          disabled={!selectedPredecessor || addDependencyMutation.isPending}\n                          data-testid=\"button-add-predecessor\"\n                        >\n                          <Plus className=\"h-4 w-4 mr-1\" />\n                          Add Predecessor\n                        </Button>\n                      </div>\n\n                      <div className=\"space-y-2 max-h-[200px] overflow-y-auto\">\n                        {predecessors.length === 0 ? (\n                          <p className=\"text-sm text-muted-foreground py-6 text-center border border-dashed rounded-lg\">\n                            No predecessors defined\n                          </p>\n                        ) : (\n                          predecessors.map((dep) => (\n                            <div key={dep.id} className=\"group flex items-center gap-2 p-3 bg-card border rounded-lg hover-elevate\">\n                              {editingDependency === dep.id ? (\n                                <div className=\"flex-1 flex items-center gap-2 flex-wrap\">\n                                  <Select\n                                    value={dep.type}\n                                    onValueChange={(v: DependencyType) => {\n                                      updateDependencyMutation.mutate({ id: dep.id, type: v, lagDays: dep.lagDays || 0 });\n                                    }}\n                                  >\n                                    <SelectTrigger className=\"w-20\">\n                                      <SelectValue />\n                                    </SelectTrigger>\n                                    <SelectContent>\n                                      {DEPENDENCY_TYPES.map((dt) => (\n                                        <SelectItem key={dt.value} value={dt.value}>{dt.value}</SelectItem>\n                                      ))}\n                                    </SelectContent>\n                                  </Select>\n                                  <span className=\"text-sm flex-1 truncate\">{getTaskName(dep.predecessorId)}</span>\n                                  <div className=\"flex items-center gap-1\">\n                                    <Input\n                                      type=\"number\"\n                                      className=\"w-16 h-8\"\n                                      defaultValue={dep.lagDays || 0}\n                                      onBlur={(e) => {\n                                        const newLag = parseInt(e.target.value) || 0;\n                                        if (newLag !== dep.lagDays) {\n                                          updateDependencyMutation.mutate({ id: dep.id, type: dep.type as DependencyType, lagDays: newLag });\n                                        }\n                                      }}\n                                      onKeyDown={(e) => {\n                                        if (e.key === 'Enter') {\n                                          const newLag = parseInt((e.target as HTMLInputElement).value) || 0;\n                                          updateDependencyMutation.mutate({ id: dep.id, type: dep.type as DependencyType, lagDays: newLag });\n                                        }\n                                      }}\n                                    />\n                                    <span className=\"text-xs text-muted-foreground\">days</span>\n                                  </div>\n                                  <Button size=\"icon\" variant=\"ghost\" onClick={() => setEditingDependency(null)}>\n                                    <Check className=\"h-4 w-4\" />\n                                  </Button>\n                                </div>\n                              ) : (\n                                <>\n                                  <Badge variant=\"outline\" className=\"font-mono text-xs shrink-0\">{dep.type}</Badge>\n                                  <span className=\"text-sm flex-1 truncate\">{getTaskName(dep.predecessorId)}</span>\n                                  {dep.lagDays !== 0 && (\n                                    <Badge variant=\"secondary\" className=\"text-xs shrink-0\">\n                                      {dep.lagDays > 0 ? \"+\" : \"\"}{dep.lagDays}d\n                                    </Badge>\n                                  )}\n                                  <div className=\"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity\">\n                                    <Button\n                                      variant=\"ghost\"\n                                      size=\"icon\"\n                                      className=\"h-7 w-7\"\n                                      onClick={() => setEditingDependency(dep.id)}\n                                      data-testid={`button-edit-predecessor-${dep.id}`}\n                                    >\n                                      <Pencil className=\"h-3 w-3\" />\n                                    </Button>\n                                    <Button\n                                      variant=\"ghost\"\n                                      size=\"icon\"\n                                      className=\"h-7 w-7 text-destructive hover:text-destructive\"\n                                      onClick={() => removeDependencyMutation.mutate(dep.id)}\n                                      disabled={removeDependencyMutation.isPending}\n                                      data-testid={`button-remove-predecessor-${dep.id}`}\n                                    >\n                                      <X className=\"h-3 w-3\" />\n                                    </Button>\n                                  </div>\n                                </>\n                              )}\n                            </div>\n                          ))\n                        )}\n                      </div>\n                    </div>\n\n                    <div className=\"border rounded-lg p-4 space-y-4\">\n                      <div className=\"flex items-center justify-between\">\n                        <h4 className=\"text-sm font-semibold flex items-center gap-2\">\n                          <ArrowRight className=\"h-4 w-4 text-green-500\" />\n                          Successors\n                          <Badge variant=\"secondary\" className=\"ml-1\">{successors.length}</Badge>\n                        </h4>\n                      </div>\n\n                      <p className=\"text-xs text-muted-foreground\">Tasks that wait for this task to complete</p>\n                      \n                      <div className=\"space-y-3 p-3 bg-muted/30 rounded-lg\">\n                        <div className=\"space-y-2\">\n                          <Label className=\"text-xs font-medium\">Add Successor</Label>\n                          <Select value={selectedSuccessor} onValueChange={setSelectedSuccessor}>\n                            <SelectTrigger data-testid=\"select-successor\" className=\"w-full\">\n                              <SelectValue placeholder=\"Select a task...\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {availableTasks\n                                .filter(t => !successors.some(s => s.successorId === t.id))\n                                .map((t) => (\n                                  <SelectItem key={t.id} value={t.id.toString()}>\n                                    <span className=\"font-mono text-xs\">{t.wbsCode || `#${t.id}`}</span>\n                                    <span className=\"ml-2\">{t.name}</span>\n                                  </SelectItem>\n                                ))}\n                            </SelectContent>\n                          </Select>\n                        </div>\n                        <div className=\"flex gap-2\">\n                          <div className=\"flex-1\">\n                            <Label className=\"text-xs\">Type</Label>\n                            <Select value={successorType} onValueChange={(v: DependencyType) => setSuccessorType(v)}>\n                              <SelectTrigger data-testid=\"select-successor-type\" className=\"w-full\">\n                                <SelectValue />\n                              </SelectTrigger>\n                              <SelectContent>\n                                {DEPENDENCY_TYPES.map((dt) => (\n                                  <SelectItem key={dt.value} value={dt.value}>\n                                    <span className=\"font-mono\">{dt.value}</span>\n                                    <span className=\"ml-2 text-muted-foreground text-xs\">({dt.label})</span>\n                                  </SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                          </div>\n                          <div className=\"w-20\">\n                            <Label className=\"text-xs\">Lag</Label>\n                            <Input\n                              type=\"number\"\n                              value={successorLag}\n                              onChange={(e) => setSuccessorLag(parseInt(e.target.value) || 0)}\n                              placeholder=\"0\"\n                              data-testid=\"input-successor-lag\"\n                            />\n                          </div>\n                        </div>\n                        <Button \n                          className=\"w-full\" \n                          size=\"sm\"\n                          onClick={() => {\n                            if (!selectedSuccessor || !task) return;\n                            addDependencyMutation.mutate({\n                              predecessorId: task.id,\n                              successorId: parseInt(selectedSuccessor),\n                              type: successorType,\n                              lagDays: successorLag,\n                            });\n                            setSelectedSuccessor(\"\");\n                            setSuccessorLag(0);\n                          }}\n                          disabled={!selectedSuccessor || addDependencyMutation.isPending}\n                          data-testid=\"button-add-successor\"\n                        >\n                          <Plus className=\"h-4 w-4 mr-1\" />\n                          Add Successor\n                        </Button>\n                      </div>\n                    \n                      <div className=\"space-y-2 max-h-[200px] overflow-y-auto\">\n                        {successors.length === 0 ? (\n                          <p className=\"text-sm text-muted-foreground py-6 text-center border border-dashed rounded-lg\">\n                            No successors defined\n                          </p>\n                        ) : (\n                          successors.map((dep) => (\n                            <div key={dep.id} className=\"group flex items-center gap-2 p-3 bg-card border rounded-lg hover-elevate\">\n                              {editingDependency === dep.id ? (\n                                <div className=\"flex-1 flex items-center gap-2 flex-wrap\">\n                                  <Select\n                                    value={dep.type}\n                                    onValueChange={(v: DependencyType) => {\n                                      updateDependencyMutation.mutate({ id: dep.id, type: v, lagDays: dep.lagDays || 0 });\n                                    }}\n                                  >\n                                    <SelectTrigger className=\"w-20\">\n                                      <SelectValue />\n                                    </SelectTrigger>\n                                    <SelectContent>\n                                      {DEPENDENCY_TYPES.map((dt) => (\n                                        <SelectItem key={dt.value} value={dt.value}>{dt.value}</SelectItem>\n                                      ))}\n                                    </SelectContent>\n                                  </Select>\n                                  <span className=\"text-sm flex-1 truncate\">{getTaskName(dep.successorId)}</span>\n                                  <div className=\"flex items-center gap-1\">\n                                    <Input\n                                      type=\"number\"\n                                      className=\"w-16 h-8\"\n                                      defaultValue={dep.lagDays || 0}\n                                      onBlur={(e) => {\n                                        const newLag = parseInt(e.target.value) || 0;\n                                        if (newLag !== dep.lagDays) {\n                                          updateDependencyMutation.mutate({ id: dep.id, type: dep.type as DependencyType, lagDays: newLag });\n                                        }\n                                      }}\n                                      onKeyDown={(e) => {\n                                        if (e.key === 'Enter') {\n                                          const newLag = parseInt((e.target as HTMLInputElement).value) || 0;\n                                          updateDependencyMutation.mutate({ id: dep.id, type: dep.type as DependencyType, lagDays: newLag });\n                                        }\n                                      }}\n                                    />\n                                    <span className=\"text-xs text-muted-foreground\">days</span>\n                                  </div>\n                                  <Button size=\"icon\" variant=\"ghost\" onClick={() => setEditingDependency(null)}>\n                                    <Check className=\"h-4 w-4\" />\n                                  </Button>\n                                </div>\n                              ) : (\n                                <>\n                                  <Badge variant=\"outline\" className=\"font-mono text-xs shrink-0\">{dep.type}</Badge>\n                                  <span className=\"text-sm flex-1 truncate\">{getTaskName(dep.successorId)}</span>\n                                  {dep.lagDays !== 0 && (\n                                    <Badge variant=\"secondary\" className=\"text-xs shrink-0\">\n                                      {dep.lagDays > 0 ? \"+\" : \"\"}{dep.lagDays}d\n                                    </Badge>\n                                  )}\n                                  <div className=\"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity\">\n                                    <Button\n                                      variant=\"ghost\"\n                                      size=\"icon\"\n                                      className=\"h-7 w-7\"\n                                      onClick={() => setEditingDependency(dep.id)}\n                                      data-testid={`button-edit-successor-${dep.id}`}\n                                    >\n                                      <Pencil className=\"h-3 w-3\" />\n                                    </Button>\n                                    <Button\n                                      variant=\"ghost\"\n                                      size=\"icon\"\n                                      className=\"h-7 w-7 text-destructive hover:text-destructive\"\n                                      onClick={() => removeDependencyMutation.mutate(dep.id)}\n                                      disabled={removeDependencyMutation.isPending}\n                                      data-testid={`button-remove-successor-${dep.id}`}\n                                    >\n                                      <X className=\"h-3 w-3\" />\n                                    </Button>\n                                  </div>\n                                </>\n                              )}\n                            </div>\n                          ))\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"resources\" className=\"space-y-4 mt-0\">\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center gap-2 p-4 bg-muted/50 rounded-lg\">\n                    <User className=\"h-5 w-5 text-muted-foreground\" />\n                    <div>\n                      <p className=\"text-sm font-medium\">Resource Assignments</p>\n                      <p className=\"text-xs text-muted-foreground\">Assign resources to this task. Inherited resources from parent tasks are shown below.</p>\n                    </div>\n                  </div>\n\n                  {assignments.length > 0 && (\n                    <div className=\"space-y-2\">\n                      <h4 className=\"text-sm font-semibold\">Directly Assigned Resources</h4>\n                      {assignments.map((assignment) => {\n                        const resource = resources.find(r => r.id === assignment.resourceId);\n                        return (\n                          <div key={assignment.id} className=\"flex items-center justify-between p-3 border rounded\">\n                            <div className=\"flex items-center gap-3\">\n                              <div className=\"h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center\">\n                                <User className=\"h-4 w-4 text-primary\" />\n                              </div>\n                              <div>\n                                <p className=\"text-sm font-medium\">{resource?.name || `Resource #${assignment.resourceId}`}</p>\n                                <p className=\"text-xs text-muted-foreground\">{resource?.type} • {resource?.discipline}</p>\n                              </div>\n                            </div>\n                            <div className=\"flex items-center gap-2\">\n                              <Badge variant=\"secondary\">{assignment.allocation}%</Badge>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={() => removeResourceMutation.mutate(assignment.id)}\n                                disabled={removeResourceMutation.isPending}\n                              >\n                                <X className=\"h-4 w-4\" />\n                              </Button>\n                            </div>\n                          </div>\n                        );\n                      })}\n                    </div>\n                  )}\n\n                  {inheritedResources.length > 0 && (\n                    <div className=\"space-y-2\">\n                      <h4 className=\"text-sm font-semibold flex items-center gap-2\">\n                        <Link2 className=\"h-4 w-4\" />\n                        Inherited from Parent Tasks\n                      </h4>\n                      {inheritedResources.map((ir: any) => (\n                        <div key={`inherited-${ir.assignmentId}`} className=\"flex items-center justify-between p-3 border border-dashed rounded bg-muted/20\">\n                          <div className=\"flex items-center gap-3\">\n                            <div className=\"h-8 w-8 rounded-full bg-muted flex items-center justify-center\">\n                              <User className=\"h-4 w-4 text-muted-foreground\" />\n                            </div>\n                            <div>\n                              <p className=\"text-sm font-medium\">{ir.resource?.name || `Resource #${ir.resourceId}`}</p>\n                              <p className=\"text-xs text-muted-foreground\">{ir.resource?.type} • {ir.resource?.discipline}</p>\n                            </div>\n                          </div>\n                          <Badge variant=\"outline\" className=\"text-xs\">\n                            From: {ir.sourceTask?.wbsCode || `#${ir.sourceTaskId}`}\n                          </Badge>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n\n                  <div className=\"space-y-2\">\n                    <h4 className=\"text-sm font-semibold\">Available Resources</h4>\n                    {resources.filter(r => !assignedResourceIds.includes(r.id)).length === 0 ? (\n                      <p className=\"text-sm text-muted-foreground py-4 text-center\">All resources are already assigned</p>\n                    ) : (\n                      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-2\">\n                        {resources.filter(r => !assignedResourceIds.includes(r.id)).map((resource) => (\n                          <Card key={resource.id} className=\"hover-elevate cursor-pointer\" onClick={() => addResourceMutation.mutate({ resourceId: resource.id, allocation: 100 })}>\n                            <CardContent className=\"p-3 flex items-center justify-between\">\n                              <div className=\"flex items-center gap-2\">\n                                <User className=\"h-4 w-4 text-muted-foreground\" />\n                                <div>\n                                  <p className=\"text-sm font-medium\">{resource.name}</p>\n                                  <p className=\"text-xs text-muted-foreground\">{resource.type} • {resource.discipline}</p>\n                                </div>\n                              </div>\n                              <Plus className=\"h-4 w-4 text-muted-foreground\" />\n                            </CardContent>\n                          </Card>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"documents\" className=\"space-y-4 mt-0\">\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center gap-2 p-4 bg-muted/50 rounded-lg\">\n                    <FileText className=\"h-5 w-5 text-muted-foreground\" />\n                    <div>\n                      <p className=\"text-sm font-medium\">Linked Documents</p>\n                      <p className=\"text-xs text-muted-foreground\">Attach documents to this task. Inherited documents from parent tasks are shown below.</p>\n                    </div>\n                  </div>\n\n                  {taskDocuments.length > 0 && (\n                    <div className=\"space-y-2\">\n                      <h4 className=\"text-sm font-semibold\">Directly Attached Documents</h4>\n                      {taskDocuments.map((td: any) => {\n                        const doc = documents.find(d => d.id === td.documentId);\n                        return (\n                          <div key={td.id} className=\"flex items-center justify-between p-3 border rounded\">\n                            <div className=\"flex items-center gap-3\">\n                              <FileText className=\"h-5 w-5 text-muted-foreground\" />\n                              <div>\n                                <p className=\"text-sm font-medium\">{doc?.title || `Document #${td.documentId}`}</p>\n                                <p className=\"text-xs text-muted-foreground\">{doc?.documentNumber} • {doc?.documentType}</p>\n                              </div>\n                            </div>\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => removeDocumentMutation.mutate(td.documentId)}\n                              disabled={removeDocumentMutation.isPending}\n                            >\n                              <X className=\"h-4 w-4\" />\n                            </Button>\n                          </div>\n                        );\n                      })}\n                    </div>\n                  )}\n\n                  {inheritedDocuments.length > 0 && (\n                    <div className=\"space-y-2\">\n                      <h4 className=\"text-sm font-semibold flex items-center gap-2\">\n                        <Link2 className=\"h-4 w-4\" />\n                        Inherited from Parent Tasks\n                      </h4>\n                      {inheritedDocuments.map((id: any) => (\n                        <div key={`inherited-doc-${id.taskDocumentId}`} className=\"flex items-center justify-between p-3 border border-dashed rounded bg-muted/20\">\n                          <div className=\"flex items-center gap-3\">\n                            <FileText className=\"h-5 w-5 text-muted-foreground\" />\n                            <div>\n                              <p className=\"text-sm font-medium\">{id.document?.title || `Document #${id.documentId}`}</p>\n                              <p className=\"text-xs text-muted-foreground\">{id.document?.documentNumber} • {id.document?.documentType}</p>\n                            </div>\n                          </div>\n                          <Badge variant=\"outline\" className=\"text-xs\">\n                            From: {id.sourceTask?.wbsCode || `#${id.sourceTaskId}`}\n                          </Badge>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n\n                  <div className=\"space-y-2\">\n                    <h4 className=\"text-sm font-semibold\">Available Documents</h4>\n                    {documents.filter(d => !linkedDocIds.includes(d.id)).length === 0 ? (\n                      <p className=\"text-sm text-muted-foreground py-4 text-center\">No documents available to link</p>\n                    ) : (\n                      <div className=\"grid grid-cols-1 gap-2 max-h-[200px] overflow-y-auto\">\n                        {documents.filter(d => !linkedDocIds.includes(d.id)).map((doc) => (\n                          <Card key={doc.id} className=\"hover-elevate cursor-pointer\" onClick={() => addDocumentMutation.mutate({ documentId: doc.id })}>\n                            <CardContent className=\"p-3 flex items-center justify-between\">\n                              <div className=\"flex items-center gap-2\">\n                                <FileText className=\"h-4 w-4 text-muted-foreground\" />\n                                <div>\n                                  <p className=\"text-sm font-medium\">{doc.title}</p>\n                                  <p className=\"text-xs text-muted-foreground\">{doc.documentNumber} • Rev {doc.revision}</p>\n                                </div>\n                              </div>\n                              <Link2 className=\"h-4 w-4 text-muted-foreground\" />\n                            </CardContent>\n                          </Card>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"risks\" className=\"space-y-4 mt-0\">\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center gap-2 p-4 bg-muted/50 rounded-lg\">\n                    <AlertTriangle className=\"h-5 w-5 text-amber-500\" />\n                    <div>\n                      <p className=\"text-sm font-medium\">Linked Risks</p>\n                      <p className=\"text-xs text-muted-foreground\">Associate risks with this task. Inherited risks from parent tasks are shown below.</p>\n                    </div>\n                  </div>\n\n                  {taskRisks.length > 0 && (\n                    <div className=\"space-y-2\">\n                      <h4 className=\"text-sm font-semibold\">Directly Associated Risks</h4>\n                      {taskRisks.map((tr: any) => {\n                        const risk = risks.find(r => r.id === tr.riskId);\n                        return (\n                          <div key={tr.id} className=\"flex items-center justify-between p-3 border rounded\">\n                            <div className=\"flex items-center gap-3\">\n                              <AlertTriangle className=\"h-5 w-5 text-amber-500\" />\n                              <div>\n                                <div className=\"flex items-center gap-2\">\n                                  <Badge variant=\"outline\" className=\"font-mono text-xs\">{risk?.code}</Badge>\n                                  <p className=\"text-sm font-medium\">{risk?.title}</p>\n                                </div>\n                                <p className=\"text-xs text-muted-foreground\">Impact: {risk?.impact} • Status: {risk?.status}</p>\n                              </div>\n                            </div>\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => removeRiskMutation.mutate(tr.riskId)}\n                              disabled={removeRiskMutation.isPending}\n                            >\n                              <X className=\"h-4 w-4\" />\n                            </Button>\n                          </div>\n                        );\n                      })}\n                    </div>\n                  )}\n\n                  {inheritedRisks.length > 0 && (\n                    <div className=\"space-y-2\">\n                      <h4 className=\"text-sm font-semibold flex items-center gap-2\">\n                        <Link2 className=\"h-4 w-4\" />\n                        Inherited from Parent Tasks\n                      </h4>\n                      {inheritedRisks.map((ir: any) => (\n                        <div key={`inherited-risk-${ir.taskRiskId}`} className=\"flex items-center justify-between p-3 border border-dashed rounded bg-muted/20\">\n                          <div className=\"flex items-center gap-3\">\n                            <AlertTriangle className=\"h-5 w-5 text-amber-400\" />\n                            <div>\n                              <div className=\"flex items-center gap-2\">\n                                <Badge variant=\"outline\" className=\"font-mono text-xs\">{ir.risk?.code}</Badge>\n                                <p className=\"text-sm font-medium\">{ir.risk?.title}</p>\n                              </div>\n                              <p className=\"text-xs text-muted-foreground\">Impact: {ir.risk?.impact} • Status: {ir.risk?.status}</p>\n                            </div>\n                          </div>\n                          <Badge variant=\"outline\" className=\"text-xs\">\n                            From: {ir.sourceTask?.wbsCode || `#${ir.sourceTaskId}`}\n                          </Badge>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n\n                  <div className=\"space-y-2\">\n                    <h4 className=\"text-sm font-semibold\">Available Risks</h4>\n                    {risks.filter(r => !linkedRiskIds.includes(r.id)).length === 0 ? (\n                      <p className=\"text-sm text-muted-foreground py-4 text-center\">No risks available to link</p>\n                    ) : (\n                      <div className=\"grid grid-cols-1 gap-2 max-h-[200px] overflow-y-auto\">\n                        {risks.filter(r => !linkedRiskIds.includes(r.id)).map((risk) => (\n                          <Card key={risk.id} className=\"hover-elevate cursor-pointer\" onClick={() => addRiskMutation.mutate(risk.id)}>\n                            <CardContent className=\"p-3 flex items-center justify-between\">\n                              <div className=\"flex items-center gap-2\">\n                                <AlertTriangle className=\"h-4 w-4 text-amber-500\" />\n                                <div>\n                                  <div className=\"flex items-center gap-2\">\n                                    <Badge variant=\"outline\" className=\"font-mono text-xs\">{risk.code}</Badge>\n                                    <p className=\"text-sm font-medium\">{risk.title}</p>\n                                  </div>\n                                  <p className=\"text-xs text-muted-foreground\">Impact: {risk.impact}</p>\n                                </div>\n                              </div>\n                              <Plus className=\"h-4 w-4 text-muted-foreground\" />\n                            </CardContent>\n                          </Card>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"issues\" className=\"space-y-4 mt-0\">\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center gap-2 p-4 bg-muted/50 rounded-lg\">\n                    <AlertCircle className=\"h-5 w-5 text-red-500\" />\n                    <div>\n                      <p className=\"text-sm font-medium\">Linked Issues</p>\n                      <p className=\"text-xs text-muted-foreground\">Associate issues with this task. Inherited issues from parent tasks are shown below.</p>\n                    </div>\n                  </div>\n\n                  {taskIssues.length > 0 && (\n                    <div className=\"space-y-2\">\n                      <h4 className=\"text-sm font-semibold\">Directly Associated Issues</h4>\n                      {taskIssues.map((ti: any) => {\n                        const issue = issues.find(i => i.id === ti.issueId);\n                        return (\n                          <div key={ti.id} className=\"flex items-center justify-between p-3 border rounded\">\n                            <div className=\"flex items-center gap-3\">\n                              <AlertCircle className=\"h-5 w-5 text-red-500\" />\n                              <div>\n                                <div className=\"flex items-center gap-2\">\n                                  <Badge variant=\"outline\" className=\"font-mono text-xs\">{issue?.code}</Badge>\n                                  <p className=\"text-sm font-medium\">{issue?.title}</p>\n                                </div>\n                                <p className=\"text-xs text-muted-foreground\">Priority: {issue?.priority} • Status: {issue?.status}</p>\n                              </div>\n                            </div>\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => removeIssueMutation.mutate(ti.issueId)}\n                              disabled={removeIssueMutation.isPending}\n                            >\n                              <X className=\"h-4 w-4\" />\n                            </Button>\n                          </div>\n                        );\n                      })}\n                    </div>\n                  )}\n\n                  {inheritedIssues.length > 0 && (\n                    <div className=\"space-y-2\">\n                      <h4 className=\"text-sm font-semibold flex items-center gap-2\">\n                        <Link2 className=\"h-4 w-4\" />\n                        Inherited from Parent Tasks\n                      </h4>\n                      {inheritedIssues.map((ii: any) => (\n                        <div key={`inherited-issue-${ii.taskIssueId}`} className=\"flex items-center justify-between p-3 border border-dashed rounded bg-muted/20\">\n                          <div className=\"flex items-center gap-3\">\n                            <AlertCircle className=\"h-5 w-5 text-red-400\" />\n                            <div>\n                              <div className=\"flex items-center gap-2\">\n                                <Badge variant=\"outline\" className=\"font-mono text-xs\">{ii.issue?.code}</Badge>\n                                <p className=\"text-sm font-medium\">{ii.issue?.title}</p>\n                              </div>\n                              <p className=\"text-xs text-muted-foreground\">Priority: {ii.issue?.priority} • Status: {ii.issue?.status}</p>\n                            </div>\n                          </div>\n                          <Badge variant=\"outline\" className=\"text-xs\">\n                            From: {ii.sourceTask?.wbsCode || `#${ii.sourceTaskId}`}\n                          </Badge>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n\n                  <div className=\"space-y-2\">\n                    <h4 className=\"text-sm font-semibold\">Available Issues</h4>\n                    {issues.filter(i => !linkedIssueIds.includes(i.id)).length === 0 ? (\n                      <p className=\"text-sm text-muted-foreground py-4 text-center\">No issues available to link</p>\n                    ) : (\n                      <div className=\"grid grid-cols-1 gap-2 max-h-[200px] overflow-y-auto\">\n                        {issues.filter(i => !linkedIssueIds.includes(i.id)).map((issue) => (\n                          <Card key={issue.id} className=\"hover-elevate cursor-pointer\" onClick={() => addIssueMutation.mutate(issue.id)}>\n                            <CardContent className=\"p-3 flex items-center justify-between\">\n                              <div className=\"flex items-center gap-2\">\n                                <AlertCircle className=\"h-4 w-4 text-red-500\" />\n                                <div>\n                                  <div className=\"flex items-center gap-2\">\n                                    <Badge variant=\"outline\" className=\"font-mono text-xs\">{issue.code}</Badge>\n                                    <p className=\"text-sm font-medium\">{issue.title}</p>\n                                  </div>\n                                  <p className=\"text-xs text-muted-foreground\">Priority: {issue.priority}</p>\n                                </div>\n                              </div>\n                              <Plus className=\"h-4 w-4 text-muted-foreground\" />\n                            </CardContent>\n                          </Card>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n                </div>\n              </TabsContent>\n            </div>\n          </ScrollArea>\n        </Tabs>\n\n        <DialogFooter className=\"gap-2 shrink-0 border-t pt-4\">\n          <Button variant=\"outline\" onClick={handleClose} disabled={isLoading} data-testid=\"button-cancel\">\n            Cancel\n          </Button>\n          <Button onClick={handleSave} disabled={isLoading} data-testid=\"button-save-task\">\n            {isLoading && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n            {isEditing ? \"Update Task\" : \"Create Task\"}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":74542},"client/src/pages/RisksPage.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { TableRowCard } from \"@/components/TableRowCard\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Search, Edit, Trash2, AlertCircle, DollarSign, Clock, Calendar, AlertTriangle } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Separator } from \"@/components/ui/separator\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport type { Risk } from \"@shared/schema\";\n\nconst DISCIPLINES = [\n  { value: \"civil\", label: \"Civil\" },\n  { value: \"structural\", label: \"Structural\" },\n  { value: \"mechanical\", label: \"Mechanical\" },\n  { value: \"electrical\", label: \"Electrical\" },\n  { value: \"piping\", label: \"Piping\" },\n  { value: \"instrumentation\", label: \"Instrumentation\" },\n  { value: \"process\", label: \"Process\" },\n  { value: \"hvac\", label: \"HVAC\" },\n  { value: \"architectural\", label: \"Architectural\" },\n  { value: \"general\", label: \"General\" },\n];\n\nconst RISK_CATEGORIES = [\n  { value: \"technical\", label: \"Technical\" },\n  { value: \"external\", label: \"External\" },\n  { value: \"organizational\", label: \"Organizational\" },\n  { value: \"project-management\", label: \"Project Management\" },\n  { value: \"commercial\", label: \"Commercial\" },\n  { value: \"hse\", label: \"HSE\" },\n  { value: \"quality\", label: \"Quality\" },\n  { value: \"schedule\", label: \"Schedule\" },\n  { value: \"resource\", label: \"Resource\" },\n];\n\nconst RESPONSE_STRATEGIES = [\n  { value: \"avoid\", label: \"Avoid\", description: \"Eliminate the threat entirely\" },\n  { value: \"transfer\", label: \"Transfer\", description: \"Shift to third party (insurance, contract)\" },\n  { value: \"mitigate\", label: \"Mitigate\", description: \"Reduce probability or impact\" },\n  { value: \"accept\", label: \"Accept\", description: \"Acknowledge and monitor\" },\n  { value: \"escalate\", label: \"Escalate\", description: \"Raise to higher authority\" },\n];\n\ninterface RiskFormData {\n  title: string;\n  description: string;\n  probability: number;\n  impact: \"low\" | \"medium\" | \"high\" | \"critical\";\n  status: \"identified\" | \"assessed\" | \"mitigating\" | \"closed\";\n  mitigationPlan: string;\n  owner: string;\n  categoryEpc: string;\n  responseStrategy: string;\n  costImpact: string;\n  scheduleImpact: string;\n  triggerEvents: string;\n  contingencyReserve: string;\n  secondaryRisks: string;\n  residualProbability: string;\n  residualImpact: string;\n  reviewDate: string;\n  discipline: string;\n}\n\nconst initialFormData: RiskFormData = {\n  title: \"\",\n  description: \"\",\n  probability: 3,\n  impact: \"medium\",\n  status: \"identified\",\n  mitigationPlan: \"\",\n  owner: \"\",\n  categoryEpc: \"technical\",\n  responseStrategy: \"mitigate\",\n  costImpact: \"\",\n  scheduleImpact: \"\",\n  triggerEvents: \"\",\n  contingencyReserve: \"\",\n  secondaryRisks: \"\",\n  residualProbability: \"\",\n  residualImpact: \"\",\n  reviewDate: \"\",\n  discipline: \"general\",\n};\n\nexport default function RisksPage() {\n  const { selectedProjectId } = useProject();\n  const { toast } = useToast();\n  const [dialogOpen, setDialogOpen] = useState(false);\n  const [editingRisk, setEditingRisk] = useState<Risk | null>(null);\n  const [selectedRisks, setSelectedRisks] = useState<number[]>([]);\n  const [formData, setFormData] = useState<RiskFormData>(initialFormData);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  const { \n    data: risks = [], \n    isLoading, \n    error, \n    refetch \n  } = useQuery<Risk[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/risks`],\n    enabled: !!selectedProjectId,\n    retry: 1,\n  });\n\n  const filteredRisks = useMemo(() => {\n    if (!searchQuery) return risks;\n    const query = searchQuery.toLowerCase();\n    return risks.filter(risk => \n      risk.title.toLowerCase().includes(query) ||\n      risk.description?.toLowerCase().includes(query) ||\n      risk.code?.toLowerCase().includes(query)\n    );\n  }, [risks, searchQuery]);\n\n  const calculateRiskExposure = (probability: number, impact: string, costImpact: string): number => {\n    const impactMultiplier: Record<string, number> = {\n      low: 1,\n      medium: 2,\n      high: 3,\n      critical: 4,\n    };\n    const cost = parseFloat(costImpact) || 0;\n    return (probability / 5) * (impactMultiplier[impact] || 1) * cost;\n  };\n\n  const riskExposure = useMemo(() => {\n    return calculateRiskExposure(formData.probability, formData.impact, formData.costImpact);\n  }, [formData.probability, formData.impact, formData.costImpact]);\n\n  const createMutation = useMutation({\n    mutationFn: async (data: RiskFormData) => {\n      if (!selectedProjectId) throw new Error(\"No project selected\");\n      const payload = {\n        ...data,\n        projectId: selectedProjectId,\n        costImpact: data.costImpact || null,\n        scheduleImpact: data.scheduleImpact ? parseInt(data.scheduleImpact) : null,\n        contingencyReserve: data.contingencyReserve || null,\n        residualProbability: data.residualProbability ? parseInt(data.residualProbability) : null,\n        residualImpact: data.residualImpact || null,\n        reviewDate: data.reviewDate || null,\n        riskExposure: riskExposure > 0 ? riskExposure.toFixed(2) : null,\n      };\n      await apiRequest(\"POST\", \"/api/risks\", payload);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${selectedProjectId}/risks`] });\n      setDialogOpen(false);\n      setEditingRisk(null);\n      resetForm();\n      toast({ title: \"Success\", description: \"Risk added successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: number; data: RiskFormData }) => {\n      const payload = {\n        ...data,\n        costImpact: data.costImpact || null,\n        scheduleImpact: data.scheduleImpact ? parseInt(data.scheduleImpact) : null,\n        contingencyReserve: data.contingencyReserve || null,\n        residualProbability: data.residualProbability ? parseInt(data.residualProbability) : null,\n        residualImpact: data.residualImpact || null,\n        reviewDate: data.reviewDate || null,\n        riskExposure: riskExposure > 0 ? riskExposure.toFixed(2) : null,\n      };\n      await apiRequest(\"PATCH\", `/api/risks/${id}`, payload);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${selectedProjectId}/risks`] });\n      setDialogOpen(false);\n      setEditingRisk(null);\n      resetForm();\n      toast({ title: \"Success\", description: \"Risk updated successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: number) => {\n      await apiRequest(\"DELETE\", `/api/risks/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${selectedProjectId}/risks`] });\n      toast({ title: \"Success\", description: \"Risk deleted successfully\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData(initialFormData);\n  };\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (editingRisk) {\n      updateMutation.mutate({ id: editingRisk.id, data: formData });\n    } else {\n      createMutation.mutate(formData);\n    }\n  };\n\n  const handleEdit = (risk: Risk) => {\n    setEditingRisk(risk);\n    setFormData({\n      title: risk.title,\n      description: risk.description || \"\",\n      probability: risk.probability,\n      impact: risk.impact as RiskFormData[\"impact\"],\n      status: risk.status as RiskFormData[\"status\"],\n      mitigationPlan: risk.mitigationPlan || \"\",\n      owner: risk.owner || \"\",\n      categoryEpc: risk.categoryEpc || \"technical\",\n      responseStrategy: risk.responseStrategy || \"mitigate\",\n      costImpact: risk.costImpact?.toString() || \"\",\n      scheduleImpact: risk.scheduleImpact?.toString() || \"\",\n      triggerEvents: risk.triggerEvents || \"\",\n      contingencyReserve: risk.contingencyReserve?.toString() || \"\",\n      secondaryRisks: risk.secondaryRisks || \"\",\n      residualProbability: risk.residualProbability?.toString() || \"\",\n      residualImpact: risk.residualImpact || \"\",\n      reviewDate: risk.reviewDate ? new Date(risk.reviewDate).toISOString().split('T')[0] : \"\",\n      discipline: risk.discipline || \"general\",\n    });\n    setDialogOpen(true);\n  };\n\n  const handleDelete = (id: number) => {\n    if (window.confirm(\"Are you sure you want to delete this risk?\")) {\n      deleteMutation.mutate(id);\n    }\n  };\n\n  const handleAddNew = () => {\n    setEditingRisk(null);\n    resetForm();\n    setDialogOpen(true);\n  };\n\n  const getRiskLevel = (probability: number, impact: string) => {\n    if ((probability >= 4 && (impact === \"high\" || impact === \"critical\")) || (probability === 5)) {\n      return { level: \"Critical\", variant: \"destructive\" as const };\n    }\n    if ((probability >= 3 && (impact === \"high\" || impact === \"critical\")) || (probability >= 4 && impact === \"medium\")) {\n      return { level: \"High\", variant: \"default\" as const };\n    }\n    if ((probability >= 2 && impact === \"medium\") || (probability >= 3 && impact === \"low\")) {\n      return { level: \"Medium\", variant: \"secondary\" as const };\n    }\n    return { level: \"Low\", variant: \"outline\" as const };\n  };\n\n  const formatCurrency = (value: string | number | null | undefined) => {\n    if (!value) return \"-\";\n    const num = typeof value === 'string' ? parseFloat(value) : value;\n    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(num);\n  };\n\n  if (!selectedProjectId) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"text-center py-12\">\n          <h2 className=\"text-2xl font-semibold mb-2\">No Project Selected</h2>\n          <p className=\"text-muted-foreground\">Please select a project from the dropdown above</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-4\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-semibold\">Risk Register</h1>\n          <p className=\"text-muted-foreground\">EPC Risk Management with Cost & Schedule Impact Analysis</p>\n        </div>\n        <Button onClick={handleAddNew} data-testid=\"button-add-risk\">Add Risk</Button>\n      </div>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertDescription className=\"flex items-center justify-between\">\n            <span>Failed to load risks. {(error as Error).message}</span>\n            <Button variant=\"outline\" size=\"sm\" onClick={() => refetch()} data-testid=\"button-retry\">\n              Retry\n            </Button>\n          </AlertDescription>\n        </Alert>\n      )}\n\n      <div className=\"relative max-w-md\">\n        <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n        <Input\n          type=\"search\"\n          placeholder=\"Search risks...\"\n          className=\"pl-9\"\n          value={searchQuery}\n          onChange={(e) => setSearchQuery(e.target.value)}\n          data-testid=\"input-search-risks\"\n        />\n      </div>\n\n      {isLoading ? (\n        <div className=\"text-center py-12\">\n          <p className=\"text-muted-foreground\">Loading risks...</p>\n        </div>\n      ) : filteredRisks.length === 0 ? (\n        <div className=\"text-center py-12\">\n          <h2 className=\"text-2xl font-semibold mb-2\">No Risks Found</h2>\n          <p className=\"text-muted-foreground mb-4\">Get started by adding risks to your project</p>\n          <Button onClick={handleAddNew} data-testid=\"button-add-first-risk\">Add Risk</Button>\n        </div>\n      ) : (\n        <div className=\"space-y-2\">\n          <div className=\"grid grid-cols-[60px,3fr,1fr,1fr,1fr,1fr,1fr,100px] gap-4 px-4 py-2 text-sm font-medium text-muted-foreground border-b\">\n            <div>Code</div>\n            <div>Risk</div>\n            <div>Category</div>\n            <div>Risk Level</div>\n            <div>Response</div>\n            <div>Exposure</div>\n            <div>Status</div>\n            <div>Actions</div>\n          </div>\n          {filteredRisks.map((risk) => {\n            const riskLevel = getRiskLevel(risk.probability, risk.impact);\n            const exposure = risk.riskExposure ? parseFloat(risk.riskExposure.toString()) : \n              calculateRiskExposure(risk.probability, risk.impact, risk.costImpact?.toString() || \"0\");\n            return (\n              <TableRowCard\n                key={risk.id}\n                id={risk.id.toString()}\n                selected={selectedRisks.includes(risk.id)}\n                onSelect={(selected) => {\n                  setSelectedRisks(prev =>\n                    selected ? [...prev, risk.id] : prev.filter(id => id !== risk.id)\n                  );\n                }}\n                data-testid={`row-risk-${risk.id}`}\n              >\n                <div className=\"grid grid-cols-[60px,3fr,1fr,1fr,1fr,1fr,1fr,100px] gap-4 items-center flex-1\">\n                  <div className=\"text-sm font-mono text-muted-foreground\">{risk.code}</div>\n                  <div>\n                    <div className=\"font-medium\">{risk.title}</div>\n                    {risk.description && (\n                      <div className=\"text-sm text-muted-foreground line-clamp-1\">{risk.description}</div>\n                    )}\n                    {risk.discipline && (\n                      <Badge variant=\"outline\" className=\"mt-1 text-xs capitalize\">{risk.discipline}</Badge>\n                    )}\n                  </div>\n                  <Badge variant=\"outline\" className=\"capitalize\">{risk.categoryEpc || \"technical\"}</Badge>\n                  <Badge variant={riskLevel.variant}>{riskLevel.level}</Badge>\n                  <Badge variant=\"secondary\" className=\"capitalize\">{risk.responseStrategy || \"mitigate\"}</Badge>\n                  <div className=\"font-mono text-sm\">\n                    {exposure > 0 ? formatCurrency(exposure) : \"-\"}\n                  </div>\n                  <Badge variant={risk.status === \"closed\" ? \"secondary\" : \"default\"} className=\"capitalize\">\n                    {risk.status}\n                  </Badge>\n                  <DropdownMenu>\n                    <DropdownMenuTrigger asChild>\n                      <Button variant=\"ghost\" size=\"sm\" data-testid={`button-actions-${risk.id}`}>\n                        Actions\n                      </Button>\n                    </DropdownMenuTrigger>\n                    <DropdownMenuContent align=\"end\">\n                      <DropdownMenuItem onClick={() => handleEdit(risk)}>\n                        <Edit className=\"h-4 w-4 mr-2\" />\n                        Edit\n                      </DropdownMenuItem>\n                      <DropdownMenuItem onClick={() => handleDelete(risk.id)} className=\"text-destructive\">\n                        <Trash2 className=\"h-4 w-4 mr-2\" />\n                        Delete\n                      </DropdownMenuItem>\n                    </DropdownMenuContent>\n                  </DropdownMenu>\n                </div>\n              </TableRowCard>\n            );\n          })}\n        </div>\n      )}\n\n      <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>\n        <DialogContent className=\"max-w-3xl max-h-[90vh] overflow-y-auto\" data-testid=\"dialog-risk\">\n          <DialogHeader>\n            <DialogTitle>{editingRisk ? \"Edit Risk\" : \"Add Risk\"}</DialogTitle>\n          </DialogHeader>\n          <form onSubmit={handleSubmit}>\n            <Tabs defaultValue=\"basic\" className=\"w-full\">\n              <TabsList className=\"grid w-full grid-cols-3\">\n                <TabsTrigger value=\"basic\">Basic Info</TabsTrigger>\n                <TabsTrigger value=\"impact\">Impact Analysis</TabsTrigger>\n                <TabsTrigger value=\"response\">Response & Residual</TabsTrigger>\n              </TabsList>\n\n              <TabsContent value=\"basic\" className=\"space-y-4 mt-4\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"space-y-2 col-span-2\">\n                    <Label htmlFor=\"title\">Risk Title</Label>\n                    <Input\n                      id=\"title\"\n                      value={formData.title}\n                      onChange={(e) => setFormData({ ...formData, title: e.target.value })}\n                      placeholder=\"Brief description of the risk\"\n                      required\n                      data-testid=\"input-risk-title\"\n                    />\n                  </div>\n\n                  <div className=\"space-y-2 col-span-2\">\n                    <Label htmlFor=\"description\">Description</Label>\n                    <Textarea\n                      id=\"description\"\n                      value={formData.description}\n                      onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                      placeholder=\"Detailed description of the risk, its causes and potential consequences\"\n                      rows={3}\n                      data-testid=\"input-risk-description\"\n                    />\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"categoryEpc\">Risk Category (AACE)</Label>\n                    <Select\n                      value={formData.categoryEpc}\n                      onValueChange={(value) => setFormData({ ...formData, categoryEpc: value })}\n                    >\n                      <SelectTrigger data-testid=\"select-risk-category\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {RISK_CATEGORIES.map((cat) => (\n                          <SelectItem key={cat.value} value={cat.value}>{cat.label}</SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"discipline\">Discipline</Label>\n                    <Select\n                      value={formData.discipline}\n                      onValueChange={(value) => setFormData({ ...formData, discipline: value })}\n                    >\n                      <SelectTrigger data-testid=\"select-risk-discipline\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {DISCIPLINES.map((disc) => (\n                          <SelectItem key={disc.value} value={disc.value}>{disc.label}</SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"status\">Status</Label>\n                    <Select\n                      value={formData.status}\n                      onValueChange={(value: RiskFormData[\"status\"]) => setFormData({ ...formData, status: value })}\n                    >\n                      <SelectTrigger data-testid=\"select-risk-status\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"identified\">Identified</SelectItem>\n                        <SelectItem value=\"assessed\">Assessed</SelectItem>\n                        <SelectItem value=\"mitigating\">Mitigating</SelectItem>\n                        <SelectItem value=\"closed\">Closed</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"owner\">Risk Owner</Label>\n                    <Input\n                      id=\"owner\"\n                      value={formData.owner}\n                      onChange={(e) => setFormData({ ...formData, owner: e.target.value })}\n                      placeholder=\"Person responsible for this risk\"\n                      data-testid=\"input-risk-owner\"\n                    />\n                  </div>\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"impact\" className=\"space-y-4 mt-4\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"probability\">Probability (1-5)</Label>\n                    <Select\n                      value={formData.probability.toString()}\n                      onValueChange={(value) => setFormData({ ...formData, probability: parseInt(value) })}\n                    >\n                      <SelectTrigger data-testid=\"select-risk-probability\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"1\">1 - Very Unlikely (≤10%)</SelectItem>\n                        <SelectItem value=\"2\">2 - Unlikely (11-30%)</SelectItem>\n                        <SelectItem value=\"3\">3 - Possible (31-50%)</SelectItem>\n                        <SelectItem value=\"4\">4 - Likely (51-70%)</SelectItem>\n                        <SelectItem value=\"5\">5 - Very Likely (&gt;70%)</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"impact\">Impact Severity</Label>\n                    <Select\n                      value={formData.impact}\n                      onValueChange={(value: RiskFormData[\"impact\"]) => setFormData({ ...formData, impact: value })}\n                    >\n                      <SelectTrigger data-testid=\"select-risk-impact\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"low\">Low - Minor impact</SelectItem>\n                        <SelectItem value=\"medium\">Medium - Moderate impact</SelectItem>\n                        <SelectItem value=\"high\">High - Major impact</SelectItem>\n                        <SelectItem value=\"critical\">Critical - Severe impact</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"costImpact\">\n                      <DollarSign className=\"inline h-4 w-4 mr-1\" />\n                      Cost Impact ($)\n                    </Label>\n                    <Input\n                      id=\"costImpact\"\n                      type=\"number\"\n                      min=\"0\"\n                      step=\"1000\"\n                      value={formData.costImpact}\n                      onChange={(e) => setFormData({ ...formData, costImpact: e.target.value })}\n                      placeholder=\"Estimated cost if risk occurs\"\n                      data-testid=\"input-risk-cost-impact\"\n                    />\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"scheduleImpact\">\n                      <Clock className=\"inline h-4 w-4 mr-1\" />\n                      Schedule Impact (days)\n                    </Label>\n                    <Input\n                      id=\"scheduleImpact\"\n                      type=\"number\"\n                      min=\"0\"\n                      value={formData.scheduleImpact}\n                      onChange={(e) => setFormData({ ...formData, scheduleImpact: e.target.value })}\n                      placeholder=\"Days delay if risk occurs\"\n                      data-testid=\"input-risk-schedule-impact\"\n                    />\n                  </div>\n\n                  <div className=\"col-span-2 p-4 bg-muted rounded-lg\">\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <AlertTriangle className=\"h-5 w-5 text-amber-500\" />\n                      <span className=\"font-medium\">Risk Exposure (Calculated)</span>\n                    </div>\n                    <div className=\"text-2xl font-bold\">\n                      {formatCurrency(riskExposure)}\n                    </div>\n                    <p className=\"text-sm text-muted-foreground mt-1\">\n                      P × Impact × Cost = {formData.probability}/5 × {formData.impact} × {formatCurrency(parseFloat(formData.costImpact) || 0)}\n                    </p>\n                  </div>\n\n                  <div className=\"space-y-2 col-span-2\">\n                    <Label htmlFor=\"triggerEvents\">Trigger Events</Label>\n                    <Textarea\n                      id=\"triggerEvents\"\n                      value={formData.triggerEvents}\n                      onChange={(e) => setFormData({ ...formData, triggerEvents: e.target.value })}\n                      placeholder=\"Conditions or events that would activate this risk\"\n                      rows={2}\n                      data-testid=\"input-risk-triggers\"\n                    />\n                  </div>\n                </div>\n              </TabsContent>\n\n              <TabsContent value=\"response\" className=\"space-y-4 mt-4\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"responseStrategy\">Response Strategy</Label>\n                    <Select\n                      value={formData.responseStrategy}\n                      onValueChange={(value) => setFormData({ ...formData, responseStrategy: value })}\n                    >\n                      <SelectTrigger data-testid=\"select-risk-response\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {RESPONSE_STRATEGIES.map((strategy) => (\n                          <SelectItem key={strategy.value} value={strategy.value}>\n                            <div className=\"flex flex-col\">\n                              <span>{strategy.label}</span>\n                              <span className=\"text-xs text-muted-foreground\">{strategy.description}</span>\n                            </div>\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"contingencyReserve\">\n                      <DollarSign className=\"inline h-4 w-4 mr-1\" />\n                      Contingency Reserve ($)\n                    </Label>\n                    <Input\n                      id=\"contingencyReserve\"\n                      type=\"number\"\n                      min=\"0\"\n                      step=\"1000\"\n                      value={formData.contingencyReserve}\n                      onChange={(e) => setFormData({ ...formData, contingencyReserve: e.target.value })}\n                      placeholder=\"Budget allocated for this risk\"\n                      data-testid=\"input-risk-contingency\"\n                    />\n                  </div>\n\n                  <div className=\"space-y-2 col-span-2\">\n                    <Label htmlFor=\"mitigationPlan\">Mitigation Plan</Label>\n                    <Textarea\n                      id=\"mitigationPlan\"\n                      value={formData.mitigationPlan}\n                      onChange={(e) => setFormData({ ...formData, mitigationPlan: e.target.value })}\n                      placeholder=\"Specific actions to reduce probability or impact\"\n                      rows={3}\n                      data-testid=\"input-risk-mitigation\"\n                    />\n                  </div>\n\n                  <div className=\"space-y-2 col-span-2\">\n                    <Label htmlFor=\"secondaryRisks\">Secondary Risks</Label>\n                    <Textarea\n                      id=\"secondaryRisks\"\n                      value={formData.secondaryRisks}\n                      onChange={(e) => setFormData({ ...formData, secondaryRisks: e.target.value })}\n                      placeholder=\"New risks that may arise from mitigation actions\"\n                      rows={2}\n                      data-testid=\"input-risk-secondary\"\n                    />\n                  </div>\n\n                  <Separator className=\"col-span-2\" />\n\n                  <div className=\"col-span-2\">\n                    <h4 className=\"font-medium mb-3\">Residual Risk (After Mitigation)</h4>\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"residualProbability\">Residual Probability (1-5)</Label>\n                        <Select\n                          value={formData.residualProbability}\n                          onValueChange={(value) => setFormData({ ...formData, residualProbability: value })}\n                        >\n                          <SelectTrigger data-testid=\"select-risk-residual-probability\">\n                            <SelectValue placeholder=\"Select...\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"1\">1 - Very Unlikely</SelectItem>\n                            <SelectItem value=\"2\">2 - Unlikely</SelectItem>\n                            <SelectItem value=\"3\">3 - Possible</SelectItem>\n                            <SelectItem value=\"4\">4 - Likely</SelectItem>\n                            <SelectItem value=\"5\">5 - Very Likely</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n\n                      <div className=\"space-y-2\">\n                        <Label htmlFor=\"residualImpact\">Residual Impact</Label>\n                        <Select\n                          value={formData.residualImpact}\n                          onValueChange={(value) => setFormData({ ...formData, residualImpact: value })}\n                        >\n                          <SelectTrigger data-testid=\"select-risk-residual-impact\">\n                            <SelectValue placeholder=\"Select...\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"low\">Low</SelectItem>\n                            <SelectItem value=\"medium\">Medium</SelectItem>\n                            <SelectItem value=\"high\">High</SelectItem>\n                            <SelectItem value=\"critical\">Critical</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n                    </div>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <Label htmlFor=\"reviewDate\">\n                      <Calendar className=\"inline h-4 w-4 mr-1\" />\n                      Next Review Date\n                    </Label>\n                    <Input\n                      id=\"reviewDate\"\n                      type=\"date\"\n                      value={formData.reviewDate}\n                      onChange={(e) => setFormData({ ...formData, reviewDate: e.target.value })}\n                      data-testid=\"input-risk-review-date\"\n                    />\n                  </div>\n                </div>\n              </TabsContent>\n            </Tabs>\n\n            <DialogFooter className=\"mt-6\">\n              <Button type=\"button\" variant=\"outline\" onClick={() => setDialogOpen(false)}>\n                Cancel\n              </Button>\n              <Button\n                type=\"submit\"\n                disabled={createMutation.isPending || updateMutation.isPending}\n                data-testid=\"button-submit\"\n              >\n                {createMutation.isPending || updateMutation.isPending\n                  ? \"Saving...\"\n                  : editingRisk\n                    ? \"Update Risk\"\n                    : \"Add Risk\"}\n              </Button>\n            </DialogFooter>\n          </form>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":32915},"client/src/pages/CalendarPage.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { ChevronLeft, ChevronRight, Loader2, AlertTriangle } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { cn } from \"@/lib/utils\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { TaskModal } from \"@/components/TaskModal\";\nimport type { Task } from \"@shared/schema\";\n\nconst WEEKDAYS = [\"Sun\", \"Mon\", \"Tue\", \"Wed\", \"Thu\", \"Fri\", \"Sat\"];\n\nconst getStatusColor = (status: string) => {\n  switch (status) {\n    case \"completed\": return \"bg-green-500\";\n    case \"in-progress\": return \"bg-blue-500\";\n    case \"review\": return \"bg-purple-500\";\n    case \"on-hold\": return \"bg-amber-500\";\n    default: return \"bg-gray-400\";\n  }\n};\n\nconst getPriorityBorder = (priority: string) => {\n  switch (priority) {\n    case \"critical\": return \"border-l-2 border-l-red-500\";\n    case \"high\": return \"border-l-2 border-l-orange-500\";\n    default: return \"\";\n  }\n};\n\nexport default function CalendarPage() {\n  const { selectedProjectId } = useProject();\n  const [currentDate, setCurrentDate] = useState(new Date());\n  const [selectedTask, setSelectedTask] = useState<Task | undefined>();\n  const [taskModalOpen, setTaskModalOpen] = useState(false);\n\n  const { \n    data: tasks = [], \n    isLoading \n  } = useQuery<Task[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/tasks`],\n    enabled: !!selectedProjectId,\n  });\n\n  const { year, month, daysInMonth, startDay, today, monthName } = useMemo(() => {\n    const y = currentDate.getFullYear();\n    const m = currentDate.getMonth();\n    const firstDay = new Date(y, m, 1);\n    const lastDay = new Date(y, m + 1, 0);\n    const todayDate = new Date();\n    \n    return {\n      year: y,\n      month: m,\n      daysInMonth: lastDay.getDate(),\n      startDay: firstDay.getDay(),\n      today: todayDate.getFullYear() === y && todayDate.getMonth() === m ? todayDate.getDate() : -1,\n      monthName: firstDay.toLocaleDateString(\"en-US\", { month: \"long\", year: \"numeric\" }),\n    };\n  }, [currentDate]);\n\n  const tasksOnDate = useMemo(() => {\n    const taskMap: Map<number, Task[]> = new Map();\n    \n    tasks.forEach(task => {\n      if (task.startDate) {\n        const startDate = new Date(task.startDate);\n        if (startDate.getFullYear() === year && startDate.getMonth() === month) {\n          const day = startDate.getDate();\n          if (!taskMap.has(day)) taskMap.set(day, []);\n          taskMap.get(day)!.push({ ...task, _isStart: true } as any);\n        }\n      }\n      if (task.endDate) {\n        const endDate = new Date(task.endDate);\n        if (endDate.getFullYear() === year && endDate.getMonth() === month) {\n          const day = endDate.getDate();\n          if (!taskMap.has(day)) taskMap.set(day, []);\n          const existing = taskMap.get(day)!.find(t => t.id === task.id);\n          if (!existing) {\n            taskMap.get(day)!.push({ ...task, _isEnd: true } as any);\n          }\n        }\n      }\n    });\n    \n    return taskMap;\n  }, [tasks, year, month]);\n\n  const upcomingTasks = useMemo(() => {\n    const now = new Date();\n    return tasks\n      .filter(task => {\n        if (!task.endDate) return false;\n        const endDate = new Date(task.endDate);\n        return endDate >= now && task.status !== \"completed\";\n      })\n      .sort((a, b) => new Date(a.endDate!).getTime() - new Date(b.endDate!).getTime())\n      .slice(0, 5);\n  }, [tasks]);\n\n  const weeks = Math.ceil((daysInMonth + startDay) / 7);\n\n  const goToPrevMonth = () => {\n    setCurrentDate(new Date(year, month - 1, 1));\n  };\n\n  const goToNextMonth = () => {\n    setCurrentDate(new Date(year, month + 1, 1));\n  };\n\n  const goToToday = () => {\n    setCurrentDate(new Date());\n  };\n\n  const handleTaskClick = (task: Task) => {\n    setSelectedTask(task);\n    setTaskModalOpen(true);\n  };\n\n  const getDaysUntil = (date: string | Date) => {\n    const target = typeof date === 'string' ? new Date(date) : date;\n    const now = new Date();\n    const diff = Math.ceil((target.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n    if (diff === 0) return \"Today\";\n    if (diff === 1) return \"Tomorrow\";\n    if (diff < 0) return `${Math.abs(diff)} days ago`;\n    return `${diff} days`;\n  };\n\n  if (!selectedProjectId) {\n    return (\n      <div className=\"p-6\">\n        <Alert>\n          <AlertTriangle className=\"h-4 w-4\" />\n          <AlertDescription>\n            Please select a project from the dropdown above to view the calendar.\n          </AlertDescription>\n        </Alert>\n      </div>\n    );\n  }\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-4\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-semibold\" data-testid=\"page-title-calendar\">Calendar</h1>\n          <p className=\"text-muted-foreground\">Project timeline and milestones</p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Button variant=\"outline\" size=\"sm\" onClick={goToToday} data-testid=\"button-today\">\n            Today\n          </Button>\n          <Button variant=\"outline\" size=\"icon\" onClick={goToPrevMonth} data-testid=\"button-prev-month\">\n            <ChevronLeft className=\"h-4 w-4\" />\n          </Button>\n          <div className=\"px-4 font-semibold min-w-[180px] text-center\">{monthName}</div>\n          <Button variant=\"outline\" size=\"icon\" onClick={goToNextMonth} data-testid=\"button-next-month\">\n            <ChevronRight className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      </div>\n\n      <Card>\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-lg\">Monthly View</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-7 gap-px bg-border rounded-lg overflow-hidden\">\n            {WEEKDAYS.map((day) => (\n              <div\n                key={day}\n                className=\"bg-muted p-3 text-center text-sm font-semibold\"\n              >\n                {day}\n              </div>\n            ))}\n\n            {Array.from({ length: weeks * 7 }).map((_, index) => {\n              const dayNumber = index - startDay + 1;\n              const isValidDay = dayNumber > 0 && dayNumber <= daysInMonth;\n              const isToday = dayNumber === today;\n              const dayTasks = tasksOnDate.get(dayNumber) || [];\n\n              return (\n                <div\n                  key={index}\n                  className={cn(\n                    \"bg-background p-2 min-h-28\",\n                    isToday && \"ring-2 ring-primary ring-inset\",\n                    !isValidDay && \"bg-muted/30\"\n                  )}\n                  data-testid={isValidDay ? `calendar-day-${dayNumber}` : undefined}\n                >\n                  {isValidDay && (\n                    <>\n                      <div\n                        className={cn(\n                          \"text-sm font-semibold mb-2\",\n                          isToday && \"text-primary\"\n                        )}\n                      >\n                        {dayNumber}\n                      </div>\n                      <div className=\"space-y-1\">\n                        {dayTasks.slice(0, 3).map((task: any) => (\n                          <div\n                            key={`${task.id}-${task._isStart ? 'start' : 'end'}`}\n                            className={cn(\n                              \"text-xs px-1.5 py-0.5 rounded text-white truncate cursor-pointer hover:opacity-80\",\n                              getStatusColor(task.status),\n                              getPriorityBorder(task.priority)\n                            )}\n                            title={`${task.name} (${task._isStart ? 'Start' : 'Due'})`}\n                            onClick={() => handleTaskClick(task)}\n                            data-testid={`calendar-task-${task.id}`}\n                          >\n                            {task._isStart ? \"▶ \" : \"◼ \"}{task.name}\n                          </div>\n                        ))}\n                        {dayTasks.length > 3 && (\n                          <div className=\"text-xs text-muted-foreground\">\n                            +{dayTasks.length - 3} more\n                          </div>\n                        )}\n                      </div>\n                    </>\n                  )}\n                </div>\n              );\n            })}\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-lg\">Upcoming Deadlines</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {upcomingTasks.length === 0 ? (\n            <p className=\"text-sm text-muted-foreground text-center py-8\">\n              No upcoming deadlines. All tasks are either completed or have no end date set.\n            </p>\n          ) : (\n            <div className=\"space-y-3\">\n              {upcomingTasks.map((task) => (\n                <div \n                  key={task.id} \n                  className={cn(\n                    \"flex items-center gap-3 p-3 rounded-lg hover-elevate cursor-pointer\",\n                    getPriorityBorder(task.priority)\n                  )}\n                  onClick={() => handleTaskClick(task)}\n                  data-testid={`upcoming-task-${task.id}`}\n                >\n                  <div className={cn(\"w-1 h-12 rounded\", getStatusColor(task.status))} />\n                  <div className=\"flex-1 min-w-0\">\n                    <p className=\"font-medium truncate\">{task.name}</p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Due: {new Date(task.endDate!).toLocaleDateString(\"en-US\", { \n                        month: \"short\", \n                        day: \"numeric\",\n                        year: \"numeric\"\n                      })}\n                    </p>\n                  </div>\n                  <Badge variant={task.priority === \"critical\" ? \"destructive\" : \"outline\"}>\n                    {getDaysUntil(task.endDate!)}\n                  </Badge>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      <TaskModal\n        open={taskModalOpen}\n        onOpenChange={setTaskModalOpen}\n        task={selectedTask}\n      />\n    </div>\n  );\n}\n","size_bytes":10661},"client/src/contexts/ThemeContext.tsx":{"content":"import { createContext, useContext, useEffect, useState } from \"react\";\n\ntype Theme = \"light\" | \"dark\";\n\ninterface ThemeContextType {\n  theme: Theme;\n  toggleTheme: () => void;\n}\n\nconst ThemeContext = createContext<ThemeContextType | undefined>(undefined);\n\nexport function ThemeProvider({ children }: { children: React.ReactNode }) {\n  const [theme, setTheme] = useState<Theme>(() => {\n    if (typeof window !== \"undefined\") {\n      const stored = localStorage.getItem(\"theme\") as Theme;\n      return stored || \"light\";\n    }\n    return \"light\";\n  });\n\n  useEffect(() => {\n    const root = document.documentElement;\n    root.classList.remove(\"light\", \"dark\");\n    root.classList.add(theme);\n    localStorage.setItem(\"theme\", theme);\n  }, [theme]);\n\n  const toggleTheme = () => {\n    setTheme((prev) => (prev === \"light\" ? \"dark\" : \"light\"));\n  };\n\n  return (\n    <ThemeContext.Provider value={{ theme, toggleTheme }}>\n      {children}\n    </ThemeContext.Provider>\n  );\n}\n\nexport function useTheme() {\n  const context = useContext(ThemeContext);\n  if (!context) {\n    throw new Error(\"useTheme must be used within ThemeProvider\");\n  }\n  return context;\n}\n","size_bytes":1155},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, text, varchar, integer, timestamp, decimal, boolean, serial, pgEnum, index, unique, jsonb } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema, createSelectSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Enums\nexport const taskStatusEnum = pgEnum(\"task_status\", [\"not-started\", \"in-progress\", \"review\", \"completed\", \"on-hold\"]);\nexport const taskPriorityEnum = pgEnum(\"task_priority\", [\"low\", \"medium\", \"high\", \"critical\"]);\nexport const dependencyTypeEnum = pgEnum(\"dependency_type\", [\"FS\", \"SS\", \"FF\", \"SF\"]); // Finish-Start, Start-Start, Finish-Finish, Start-Finish\nexport const riskStatusEnum = pgEnum(\"risk_status\", [\"identified\", \"assessed\", \"mitigating\", \"closed\"]);\nexport const riskImpactEnum = pgEnum(\"risk_impact\", [\"low\", \"medium\", \"high\", \"critical\"]);\nexport const issueStatusEnum = pgEnum(\"issue_status\", [\"open\", \"in-progress\", \"resolved\", \"closed\"]);\nexport const issuePriorityEnum = pgEnum(\"issue_priority\", [\"low\", \"medium\", \"high\", \"critical\"]);\nexport const changeRequestStatusEnum = pgEnum(\"change_request_status\", [\"submitted\", \"under-review\", \"approved\", \"rejected\", \"implemented\"]);\nexport const stakeholderRoleEnum = pgEnum(\"stakeholder_role\", [\"sponsor\", \"client\", \"team-member\", \"contractor\", \"consultant\", \"other\"]);\n\n// EPC-Specific Enums\nexport const disciplineEnum = pgEnum(\"discipline\", [\n  \"civil\", \"structural\", \"mechanical\", \"electrical\", \"piping\", \n  \"instrumentation\", \"process\", \"hvac\", \"architectural\", \"general\"\n]);\nexport const constraintTypeEnum = pgEnum(\"constraint_type\", [\n  \"asap\", \"alap\", \"snet\", \"snlt\", \"fnet\", \"fnlt\", \"mso\", \"mfo\"\n]); // As Soon/Late As Possible, Start/Finish No Earlier/Later Than, Must Start/Finish On\nexport const riskResponseEnum = pgEnum(\"risk_response\", [\"avoid\", \"transfer\", \"mitigate\", \"accept\", \"escalate\"]);\nexport const riskCategoryEnum = pgEnum(\"risk_category\", [\n  \"technical\", \"external\", \"organizational\", \"project-management\", \n  \"commercial\", \"hse\", \"quality\", \"schedule\", \"resource\"\n]);\nexport const issueTypeEnum = pgEnum(\"issue_type\", [\n  \"design\", \"procurement\", \"construction\", \"commissioning\", \n  \"hse\", \"quality\", \"commercial\", \"interface\", \"resource\"\n]);\nexport const escalationLevelEnum = pgEnum(\"escalation_level\", [\"project\", \"program\", \"executive\", \"client\"]);\nexport const rootCauseCategoryEnum = pgEnum(\"root_cause_category\", [\n  \"design-error\", \"material-defect\", \"workmanship\", \"equipment-failure\",\n  \"communication\", \"planning\", \"external-factors\", \"unknown\"\n]);\nexport const stakeholderRoleEpcEnum = pgEnum(\"stakeholder_role_epc\", [\n  \"client-owner\", \"pmc\", \"feed-contractor\", \"epc-contractor\", \"epcm-contractor\",\n  \"subcontractor-civil\", \"subcontractor-mechanical\", \"subcontractor-electrical\",\n  \"equipment-vendor\", \"bulk-supplier\", \"tpi\", \"certification-body\",\n  \"regulatory-authority\", \"lenders-engineer\", \"insurance-surveyor\", \"consultant\", \"other\"\n]);\nexport const communicationPreferenceEnum = pgEnum(\"communication_preference\", [\"email\", \"phone\", \"meeting\", \"portal\"]);\nexport const authorityLevelEnum = pgEnum(\"authority_level\", [\"decision-maker\", \"influencer\", \"advisor\", \"informed\"]);\n\n// RACI Matrix Enum (Responsible, Accountable, Consulted, Informed)\nexport const raciTypeEnum = pgEnum(\"raci_type\", [\"R\", \"A\", \"C\", \"I\"]);\n\n// Document Control Enums\nexport const documentTypeEnum = pgEnum(\"document_type\", [\n  // Technical\n  \"drawing\", \"specification\", \"datasheet\", \"calculation\", \"report\",\n  // Procedures\n  \"sop\", \"procedure\", \"work-instruction\", \"checklist\",\n  // Commercial\n  \"invoice\", \"rfp\", \"contract\", \"purchase-order\", \"quote\",\n  // Vendor\n  \"vendor-doc\", \"certificate\", \"warranty\",\n  // Project\n  \"lessons-learned\", \"bulletin\", \"meeting-minutes\", \"transmittal\",\n  // Correspondence\n  \"correspondence\", \"rfi\", \"ncr\",\n  // Other\n  \"other\"\n]);\nexport const documentStatusEnum = pgEnum(\"document_status\", [\"draft\", \"ifa\", \"ifc\", \"as-built\", \"superseded\", \"cancelled\"]);\nexport const transmittalStatusEnum = pgEnum(\"transmittal_status\", [\"issued\", \"acknowledged\", \"responded\", \"closed\"]);\nexport const rfiStatusEnum = pgEnum(\"rfi_status\", [\"open\", \"pending-response\", \"responded\", \"closed\", \"void\"]);\nexport const punchCategoryEnum = pgEnum(\"punch_category\", [\"a\", \"b\", \"c\"]); // A=Safety/Critical, B=Required before handover, C=Minor\nexport const punchStatusEnum = pgEnum(\"punch_status\", [\"open\", \"in-progress\", \"completed\", \"verified\", \"rejected\"]);\n\n// Daily Report Enums\nexport const weatherConditionEnum = pgEnum(\"weather_condition\", [\"clear\", \"cloudy\", \"rain\", \"storm\", \"wind\", \"hot\", \"cold\"]);\nexport const resourceTypeEnum = pgEnum(\"resource_type\", [\"human\", \"equipment\", \"material\", \"subcontractor\"]);\n\n// Resource Pricing Enums\nexport const rateTypeEnum = pgEnum(\"rate_type\", [\"per-hour\", \"per-use\", \"per-unit\"]);\nexport const unitTypeEnum = pgEnum(\"unit_type\", [\n  \"ea\", \"lot\", \"hr\", \"day\", \"week\", \"month\",\n  \"m\", \"ft\", \"yd\", \"km\", \"mi\",\n  \"m2\", \"ft2\", \"m3\", \"ft3\",\n  \"kg\", \"lb\", \"ton\", \"mt\",\n  \"l\", \"gal\", \"scm\", \"scf\"\n]);\nexport const contractTypeEnum = pgEnum(\"contract_type\", [\n  \"full-time\", \"part-time\", \"contract\", \"temporary\", \"rental\", \"purchase\", \"lease\"\n]);\nexport const availabilityStatusEnum = pgEnum(\"availability_status\", [\"available\", \"partially_available\", \"unavailable\", \"on_leave\"]);\n\n// Project Events Enums\nexport const eventTypeEnum = pgEnum(\"event_type\", [\n  \"meeting\", \"audit\", \"inspection\", \"milestone\", \"deadline\", \n  \"training\", \"workshop\", \"review\", \"handover\", \"other\"\n]);\n\n// Organizations (Multi-tenant root)\nexport const organizations = pgTable(\"organizations\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  slug: varchar(\"slug\", { length: 100 }).notNull().unique(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\n// Session storage table (required for Replit Auth)\nexport const sessions = pgTable(\n  \"sessions\",\n  {\n    sid: varchar(\"sid\").primaryKey(),\n    sess: text(\"sess\").notNull(),\n    expire: timestamp(\"expire\").notNull(),\n  },\n  (table) => ({\n    expireIdx: index(\"IDX_session_expire\").on(table.expire),\n  })\n);\n\n// Users (Replit Auth compatible)\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\", { length: 255 }).primaryKey().default(sql`gen_random_uuid()`), // Replit Auth user ID\n  email: varchar(\"email\", { length: 255 }).unique(),\n  firstName: varchar(\"first_name\", { length: 255 }),\n  lastName: varchar(\"last_name\", { length: 255 }),\n  profileImageUrl: varchar(\"profile_image_url\", { length: 512 }),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\n// User-Organization relationship (many-to-many)\nexport const userOrganizations = pgTable(\"user_organizations\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\", { length: 255 }).notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  organizationId: integer(\"organization_id\").notNull().references(() => organizations.id, { onDelete: \"cascade\" }),\n  role: text(\"role\").notNull().default(\"member\"), // owner, admin, member, viewer\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// Projects\nexport const projects = pgTable(\"projects\", {\n  id: serial(\"id\").primaryKey(),\n  organizationId: integer(\"organization_id\").notNull().references(() => organizations.id, { onDelete: \"cascade\" }),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  code: varchar(\"code\", { length: 50 }).notNull(), // Project code like \"PRJ-001\"\n  status: text(\"status\").notNull().default(\"active\"), // active, on-hold, completed, cancelled\n  startDate: timestamp(\"start_date\"),\n  endDate: timestamp(\"end_date\"),\n  budget: decimal(\"budget\", { precision: 15, scale: 2 }),\n  currency: varchar(\"currency\", { length: 3 }).notNull().default(\"USD\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\n// Tasks (WBS items with hierarchy support - EPC Enhanced)\nexport const tasks = pgTable(\"tasks\", {\n  id: serial(\"id\").primaryKey(),\n  projectId: integer(\"project_id\").notNull().references(() => projects.id, { onDelete: \"cascade\" }),\n  parentId: integer(\"parent_id\"), // Self-referencing for hierarchy\n  wbsCode: varchar(\"wbs_code\", { length: 50 }).notNull(), // e.g., \"1.2.3.4.5\"\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  status: taskStatusEnum(\"status\").notNull().default(\"not-started\"),\n  priority: taskPriorityEnum(\"priority\").notNull().default(\"medium\"),\n  startDate: timestamp(\"start_date\"),\n  endDate: timestamp(\"end_date\"),\n  estimatedHours: decimal(\"estimated_hours\", { precision: 10, scale: 2 }),\n  actualHours: decimal(\"actual_hours\", { precision: 10, scale: 2 }),\n  progress: integer(\"progress\").notNull().default(0), // 0-100\n  assignedTo: varchar(\"assigned_to\", { length: 255 }).references(() => users.id),\n  assignedToName: varchar(\"assigned_to_name\", { length: 100 }), // Flexible text for imports (e.g., \"PM-01\", \"ENG-LEAD\")\n  createdBy: varchar(\"created_by\", { length: 255 }).notNull().references(() => users.id),\n  // EPC-Specific Fields\n  discipline: disciplineEnum(\"discipline\").default(\"general\"),\n  disciplineLabel: varchar(\"discipline_label\", { length: 100 }), // Flexible text for imports (e.g., \"management\", \"engineering\")\n  areaCode: varchar(\"area_code\", { length: 50 }), // Plant area/zone code\n  weightFactor: decimal(\"weight_factor\", { precision: 5, scale: 4 }).default(\"0.0000\"), // Progress weight (0.0000-1.0000)\n  physicalQuantity: decimal(\"physical_quantity\", { precision: 15, scale: 2 }), // e.g., 500 meters\n  unitOfMeasure: varchar(\"unit_of_measure\", { length: 20 }), // m, m², m³, kg, ea, lot\n  plannedQtyPeriod: decimal(\"planned_qty_period\", { precision: 15, scale: 2 }), // Planned qty this period\n  actualQtyPeriod: decimal(\"actual_qty_period\", { precision: 15, scale: 2 }), // Actual qty this period\n  cumulativeQty: decimal(\"cumulative_qty\", { precision: 15, scale: 2 }), // Cumulative installed\n  constraintType: constraintTypeEnum(\"constraint_type\").default(\"asap\"),\n  constraintDate: timestamp(\"constraint_date\"), // Date for constraint if applicable\n  baselineStart: timestamp(\"baseline_start\"), // Original planned start\n  baselineFinish: timestamp(\"baseline_finish\"), // Original planned finish\n  baselineCost: decimal(\"baseline_cost\", { precision: 15, scale: 2 }), // Original budget\n  actualCost: decimal(\"actual_cost\", { precision: 15, scale: 2 }), // Actual cost to date\n  earnedValue: decimal(\"earned_value\", { precision: 15, scale: 2 }), // Earned value\n  responsibleContractor: text(\"responsible_contractor\"), // Subcontractor name\n  float: integer(\"float\"), // Total float days (calculated from CPM)\n  freeFloat: integer(\"free_float\"), // Free float days (slack before affecting successors)\n  duration: integer(\"duration\"), // Duration in days (calculated from effort/capacity)\n  earlyStart: timestamp(\"early_start\"), // Earliest possible start (CPM Forward Pass)\n  earlyFinish: timestamp(\"early_finish\"), // Earliest possible finish (CPM Forward Pass)\n  lateStart: timestamp(\"late_start\"), // Latest possible start (CPM Backward Pass)\n  lateFinish: timestamp(\"late_finish\"), // Latest possible finish (CPM Backward Pass)\n  isMilestone: boolean(\"is_milestone\").default(false),\n  isCriticalPath: boolean(\"is_critical_path\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\n// Task Dependencies\nexport const taskDependencies = pgTable(\"task_dependencies\", {\n  id: serial(\"id\").primaryKey(),\n  projectId: integer(\"project_id\").notNull().references(() => projects.id, { onDelete: \"cascade\" }),\n  predecessorId: integer(\"predecessor_id\").notNull().references(() => tasks.id, { onDelete: \"cascade\" }),\n  successorId: integer(\"successor_id\").notNull().references(() => tasks.id, { onDelete: \"cascade\" }),\n  type: dependencyTypeEnum(\"type\").notNull().default(\"FS\"),\n  lagDays: integer(\"lag_days\").notNull().default(0), // Can be negative for lead time\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// Stakeholders (EPC Enhanced)\nexport const stakeholders = pgTable(\"stakeholders\", {\n  id: serial(\"id\").primaryKey(),\n  projectId: integer(\"project_id\").notNull().references(() => projects.id, { onDelete: \"cascade\" }),\n  name: text(\"name\").notNull(),\n  email: text(\"email\"),\n  phone: text(\"phone\"),\n  organization: text(\"organization\"),\n  role: stakeholderRoleEnum(\"role\").notNull().default(\"other\"),\n  // EPC-Specific Fields\n  roleEpc: stakeholderRoleEpcEnum(\"role_epc\").default(\"other\"), // Detailed EPC role\n  communicationPreference: communicationPreferenceEnum(\"communication_preference\").default(\"email\"),\n  authorityLevel: authorityLevelEnum(\"authority_level\").default(\"informed\"),\n  contractReference: varchar(\"contract_reference\", { length: 100 }), // Contract/PO number\n  discipline: disciplineEnum(\"discipline\"), // Primary discipline responsibility\n  influence: integer(\"influence\").notNull().default(3), // 1-5 scale\n  interest: integer(\"interest\").notNull().default(3), // 1-5 scale\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\n// RACI Matrix (Stakeholder/Resource-Task responsibility assignments)\n// Supports both stakeholders and human resources as assignable people\n// Supports inheritance from parent tasks in WBS hierarchy\nexport const stakeholderRaci = pgTable(\"stakeholder_raci\", {\n  id: serial(\"id\").primaryKey(),\n  projectId: integer(\"project_id\").notNull().references(() => projects.id, { onDelete: \"cascade\" }),\n  taskId: integer(\"task_id\").notNull().references(() => tasks.id, { onDelete: \"cascade\" }),\n  raciType: raciTypeEnum(\"raci_type\").notNull(), // R, A, C, or I\n  // Either stakeholderId OR resourceId must be set (one person per record)\n  stakeholderId: integer(\"stakeholder_id\").references(() => stakeholders.id, { onDelete: \"cascade\" }),\n  resourceId: integer(\"resource_id\").references(() => resources.id, { onDelete: \"cascade\" }),\n  // Inheritance tracking - for WBS parent-child RACI propagation\n  isInherited: boolean(\"is_inherited\").notNull().default(false),\n  inheritedFromTaskId: integer(\"inherited_from_task_id\").references(() => tasks.id, { onDelete: \"set null\" }),\n  notes: text(\"notes\"), // Optional notes for this assignment\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => ({\n  // Allow same person to have different RACI roles on same task\n  // Unique on (stakeholder/resource, task, raciType) combination\n  uniqueStakeholderTaskRaci: unique(\"stakeholder_raci_stakeholder_unique\").on(table.stakeholderId, table.taskId, table.raciType),\n  uniqueResourceTaskRaci: unique(\"stakeholder_raci_resource_unique\").on(table.resourceId, table.taskId, table.raciType),\n}));\n\n// Risks (EPC Enhanced)\nexport const risks = pgTable(\"risks\", {\n  id: serial(\"id\").primaryKey(),\n  projectId: integer(\"project_id\").notNull().references(() => projects.id, { onDelete: \"cascade\" }),\n  code: varchar(\"code\", { length: 50 }).notNull(),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  category: text(\"category\"), // Keep for backward compat\n  categoryEpc: riskCategoryEnum(\"category_epc\").default(\"technical\"), // EPC category\n  status: riskStatusEnum(\"status\").notNull().default(\"identified\"),\n  probability: integer(\"probability\").notNull().default(3), // 1-5 scale\n  impact: riskImpactEnum(\"impact\").notNull().default(\"medium\"),\n  mitigationPlan: text(\"mitigation_plan\"),\n  owner: varchar(\"owner\", { length: 255 }).references(() => users.id),\n  // EPC-Specific Fields\n  responseStrategy: riskResponseEnum(\"response_strategy\").default(\"mitigate\"),\n  costImpact: decimal(\"cost_impact\", { precision: 15, scale: 2 }), // $ impact if risk occurs\n  scheduleImpact: integer(\"schedule_impact\"), // Days delay if risk occurs\n  riskExposure: decimal(\"risk_exposure\", { precision: 15, scale: 2 }), // P × I × Cost (calculated)\n  triggerEvents: text(\"trigger_events\"), // Conditions that activate risk\n  contingencyReserve: decimal(\"contingency_reserve\", { precision: 15, scale: 2 }), // $ allocated\n  secondaryRisks: text(\"secondary_risks\"), // Risks from mitigation\n  residualProbability: integer(\"residual_probability\"), // 1-5 after mitigation\n  residualImpact: riskImpactEnum(\"residual_impact\"), // After mitigation\n  reviewDate: timestamp(\"review_date\"), // Next review date\n  discipline: disciplineEnum(\"discipline\"), // Related discipline\n  identifiedDate: timestamp(\"identified_date\").defaultNow().notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => ({\n  uniqueCodePerProject: unique(\"risks_project_code_unique\").on(table.projectId, table.code),\n}));\n\n// Issues (EPC Enhanced)\nexport const issues = pgTable(\"issues\", {\n  id: serial(\"id\").primaryKey(),\n  projectId: integer(\"project_id\").notNull().references(() => projects.id, { onDelete: \"cascade\" }),\n  code: varchar(\"code\", { length: 50 }).notNull(),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  status: issueStatusEnum(\"status\").notNull().default(\"open\"),\n  priority: issuePriorityEnum(\"priority\").notNull().default(\"medium\"),\n  category: text(\"category\"), // Keep for backward compat\n  // EPC-Specific Fields\n  issueType: issueTypeEnum(\"issue_type\").default(\"design\"),\n  impactCost: boolean(\"impact_cost\").default(false),\n  impactSchedule: boolean(\"impact_schedule\").default(false),\n  impactQuality: boolean(\"impact_quality\").default(false),\n  impactSafety: boolean(\"impact_safety\").default(false),\n  rootCauseCategory: rootCauseCategoryEnum(\"root_cause_category\"),\n  rootCauseAnalysis: text(\"root_cause_analysis\"), // 5 Whys result\n  lessonsLearnedRef: varchar(\"lessons_learned_ref\", { length: 100 }),\n  relatedChangeRequest: integer(\"related_change_request\").references(() => changeRequests.id),\n  escalationLevel: escalationLevelEnum(\"escalation_level\").default(\"project\"),\n  targetResolutionDate: timestamp(\"target_resolution_date\"),\n  verificationRequired: boolean(\"verification_required\").default(false),\n  verifiedBy: varchar(\"verified_by\", { length: 255 }).references(() => users.id),\n  verifiedDate: timestamp(\"verified_date\"),\n  discipline: disciplineEnum(\"discipline\"),\n  areaCode: varchar(\"area_code\", { length: 50 }),\n  assignedTo: varchar(\"assigned_to\", { length: 255 }).references(() => users.id),\n  reportedBy: varchar(\"reported_by\", { length: 255 }).notNull().references(() => users.id),\n  reportedDate: timestamp(\"reported_date\").defaultNow().notNull(),\n  resolvedDate: timestamp(\"resolved_date\"),\n  resolution: text(\"resolution\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => ({\n  uniqueCodePerProject: unique(\"issues_project_code_unique\").on(table.projectId, table.code),\n}));\n\n// Change Requests\nexport const changeRequests = pgTable(\"change_requests\", {\n  id: serial(\"id\").primaryKey(),\n  projectId: integer(\"project_id\").notNull().references(() => projects.id, { onDelete: \"cascade\" }),\n  code: varchar(\"code\", { length: 50 }).notNull(),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  justification: text(\"justification\"),\n  status: changeRequestStatusEnum(\"status\").notNull().default(\"submitted\"),\n  requestedBy: varchar(\"requested_by\", { length: 255 }).notNull().references(() => users.id),\n  reviewedBy: varchar(\"reviewed_by\", { length: 255 }).references(() => users.id),\n  impactAssessment: text(\"impact_assessment\"),\n  costImpact: decimal(\"cost_impact\", { precision: 15, scale: 2 }),\n  scheduleImpact: integer(\"schedule_impact_days\"),\n  submittedDate: timestamp(\"submitted_date\").defaultNow().notNull(),\n  reviewedDate: timestamp(\"reviewed_date\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\n// Cost Items (for cost tracking and analytics)\nexport const costItems = pgTable(\"cost_items\", {\n  id: serial(\"id\").primaryKey(),\n  projectId: integer(\"project_id\").notNull().references(() => projects.id, { onDelete: \"cascade\" }),\n  taskId: integer(\"task_id\").references(() => tasks.id, { onDelete: \"set null\" }),\n  category: text(\"category\").notNull(), // labor, materials, equipment, subcontractor, overhead\n  description: text(\"description\").notNull(),\n  budgeted: decimal(\"budgeted\", { precision: 15, scale: 2 }).notNull(),\n  actual: decimal(\"actual\", { precision: 15, scale: 2 }).notNull().default(\"0\"),\n  currency: varchar(\"currency\", { length: 3 }).notNull().default(\"USD\"),\n  date: timestamp(\"date\").defaultNow().notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\n// Resources (with pricing model)\nexport const resources = pgTable(\"resources\", {\n  id: serial(\"id\").primaryKey(),\n  projectId: integer(\"project_id\").notNull().references(() => projects.id, { onDelete: \"cascade\" }),\n  name: text(\"name\").notNull(),\n  type: text(\"type\").notNull(), // human, equipment, material\n  discipline: disciplineEnum(\"discipline\").default(\"general\"), // EPC discipline\n  availability: integer(\"availability\").notNull().default(100), // percentage\n  availabilityStatus: availabilityStatusEnum(\"availability_status\").default(\"available\"),\n  \n  // Legacy field - keep for backward compat\n  costPerHour: decimal(\"cost_per_hour\", { precision: 10, scale: 2 }),\n  // Primary pricing model\n  rateType: rateTypeEnum(\"rate_type\").default(\"per-hour\"), // per-hour, per-use, per-unit\n  rate: decimal(\"rate\", { precision: 15, scale: 2 }).default(\"0\"), // The rate amount\n  unitType: unitTypeEnum(\"unit_type\").default(\"hr\"), // Unit type for per-unit pricing\n  currency: varchar(\"currency\", { length: 3 }).notNull().default(\"USD\"),\n  \n  // Multiple pricing models (JSONB array for flexibility)\n  // Format: [{ name: string, rateType: string, rate: number, unitType: string, currency: string, effectiveFrom?: date, effectiveTo?: date }]\n  pricingModels: jsonb(\"pricing_models\").$type<Array<{\n    name: string;\n    rateType: string;\n    rate: number;\n    unitType: string;\n    currency: string;\n    effectiveFrom?: string;\n    effectiveTo?: string;\n    isDefault?: boolean;\n  }>>(),\n  \n  // Skills and certifications (array, max 10)\n  skillsArray: text(\"skills_array\").array(),\n  skills: text(\"skills\"), // Legacy comma-separated skills (backward compat)\n  certifications: text(\"certifications\").array(),\n  \n  // Contract and vendor information\n  contractType: contractTypeEnum(\"contract_type\"),\n  vendorName: varchar(\"vendor_name\", { length: 255 }),\n  vendorContactEmail: varchar(\"vendor_contact_email\", { length: 255 }),\n  vendorContactPhone: varchar(\"vendor_contact_phone\", { length: 50 }),\n  contractStartDate: timestamp(\"contract_start_date\"),\n  contractEndDate: timestamp(\"contract_end_date\"),\n  contractReference: varchar(\"contract_reference\", { length: 100 }),\n  \n  // Capacity and working hours\n  maxHoursPerDay: integer(\"max_hours_per_day\").default(8),\n  maxHoursPerWeek: integer(\"max_hours_per_week\").default(40),\n  workingDays: text(\"working_days\").array(), // [\"monday\", \"tuesday\", ...]\n  // Working calendar exceptions (holidays, unavailable dates)\n  // Format: [{ date: string, type: 'holiday' | 'leave' | 'training', note?: string }]\n  calendarExceptions: jsonb(\"calendar_exceptions\").$type<Array<{\n    date: string;\n    type: string;\n    note?: string;\n  }>>(),\n  \n  // Efficiency and productivity metrics\n  efficiencyRating: decimal(\"efficiency_rating\", { precision: 5, scale: 2 }).default(\"1.0\"), // 0.5 to 2.0\n  productivityFactor: decimal(\"productivity_factor\", { precision: 5, scale: 2 }).default(\"1.0\"),\n  qualityScore: integer(\"quality_score\"), // 1-100\n  \n  // Additional metadata\n  description: text(\"description\"),\n  notes: text(\"notes\"),\n  tags: text(\"tags\").array(),\n  profileImageUrl: varchar(\"profile_image_url\", { length: 512 }),\n  \n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\n// Resource Assignments\nexport const resourceAssignments = pgTable(\"resource_assignments\", {\n  id: serial(\"id\").primaryKey(),\n  taskId: integer(\"task_id\").notNull().references(() => tasks.id, { onDelete: \"cascade\" }),\n  resourceId: integer(\"resource_id\").notNull().references(() => resources.id, { onDelete: \"cascade\" }),\n  allocation: integer(\"allocation\").notNull().default(100), // percentage\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// ==================== EPC Document Control ====================\n\n// Documents (Document Register)\nexport const documents = pgTable(\"documents\", {\n  id: serial(\"id\").primaryKey(),\n  projectId: integer(\"project_id\").notNull().references(() => projects.id, { onDelete: \"cascade\" }),\n  documentNumber: varchar(\"document_number\", { length: 100 }).notNull(), // PRJ-DIS-AREA-TYPE-SEQ\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  discipline: disciplineEnum(\"discipline\").default(\"general\"),\n  documentType: documentTypeEnum(\"document_type\").notNull().default(\"drawing\"),\n  revision: varchar(\"revision\", { length: 10 }).notNull().default(\"0\"), // A, B, 0, 1, 2...\n  status: documentStatusEnum(\"status\").notNull().default(\"draft\"),\n  areaCode: varchar(\"area_code\", { length: 50 }),\n  equipmentTag: varchar(\"equipment_tag\", { length: 100 }), // Related equipment\n  originator: varchar(\"originator\", { length: 255 }).references(() => users.id),\n  checker: varchar(\"checker\", { length: 255 }).references(() => users.id),\n  approver: varchar(\"approver\", { length: 255 }).references(() => users.id),\n  supersedesDocId: integer(\"supersedes_doc_id\"), // Previous revision\n  requiredDate: timestamp(\"required_date\"),\n  forecastDate: timestamp(\"forecast_date\"),\n  actualDate: timestamp(\"actual_date\"),\n  filePath: text(\"file_path\"), // Storage path\n  fileSize: integer(\"file_size\"), // bytes\n  reviewComments: text(\"review_comments\"),\n  createdBy: varchar(\"created_by\", { length: 255 }).notNull().references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => ({\n  uniqueDocPerProject: unique(\"documents_project_number_unique\").on(table.projectId, table.documentNumber, table.revision),\n}));\n\n// Transmittals\nexport const transmittals = pgTable(\"transmittals\", {\n  id: serial(\"id\").primaryKey(),\n  projectId: integer(\"project_id\").notNull().references(() => projects.id, { onDelete: \"cascade\" }),\n  transmittalNumber: varchar(\"transmittal_number\", { length: 50 }).notNull(),\n  subject: text(\"subject\").notNull(),\n  fromOrganization: text(\"from_organization\").notNull(),\n  toOrganization: text(\"to_organization\").notNull(),\n  attention: text(\"attention\"), // Person's name\n  issueDate: timestamp(\"issue_date\").defaultNow().notNull(),\n  responseRequired: boolean(\"response_required\").default(false),\n  responseRequiredDate: timestamp(\"response_required_date\"),\n  responseReceivedDate: timestamp(\"response_received_date\"),\n  status: transmittalStatusEnum(\"status\").notNull().default(\"issued\"),\n  purpose: text(\"purpose\"), // For Review, For Approval, For Information, etc.\n  remarks: text(\"remarks\"),\n  createdBy: varchar(\"created_by\", { length: 255 }).notNull().references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => ({\n  uniqueTransmittalPerProject: unique(\"transmittals_project_number_unique\").on(table.projectId, table.transmittalNumber),\n}));\n\n// Transmittal Documents (junction table)\nexport const transmittalDocuments = pgTable(\"transmittal_documents\", {\n  id: serial(\"id\").primaryKey(),\n  transmittalId: integer(\"transmittal_id\").notNull().references(() => transmittals.id, { onDelete: \"cascade\" }),\n  documentId: integer(\"document_id\").notNull().references(() => documents.id, { onDelete: \"cascade\" }),\n  copies: integer(\"copies\").default(1),\n  purpose: text(\"purpose\"), // For Review, For Approval, For Construction\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// RFIs (Request for Information)\nexport const rfis = pgTable(\"rfis\", {\n  id: serial(\"id\").primaryKey(),\n  projectId: integer(\"project_id\").notNull().references(() => projects.id, { onDelete: \"cascade\" }),\n  rfiNumber: varchar(\"rfi_number\", { length: 50 }).notNull(),\n  subject: text(\"subject\").notNull(),\n  discipline: disciplineEnum(\"discipline\").default(\"general\"),\n  fromOrganization: text(\"from_organization\").notNull(),\n  toOrganization: text(\"to_organization\").notNull(),\n  question: text(\"question\").notNull(),\n  response: text(\"response\"),\n  priority: issuePriorityEnum(\"priority\").notNull().default(\"medium\"),\n  status: rfiStatusEnum(\"status\").notNull().default(\"open\"),\n  requiredDate: timestamp(\"required_date\"),\n  responseDate: timestamp(\"response_date\"),\n  costImpact: boolean(\"cost_impact\").default(false),\n  scheduleImpact: boolean(\"schedule_impact\").default(false),\n  relatedDocuments: text(\"related_documents\"), // Comma-separated doc numbers\n  areaCode: varchar(\"area_code\", { length: 50 }),\n  submittedBy: varchar(\"submitted_by\", { length: 255 }).notNull().references(() => users.id),\n  respondedBy: varchar(\"responded_by\", { length: 255 }).references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => ({\n  uniqueRfiPerProject: unique(\"rfis_project_number_unique\").on(table.projectId, table.rfiNumber),\n}));\n\n// Punch Items (Punch List / Snag List)\nexport const punchItems = pgTable(\"punch_items\", {\n  id: serial(\"id\").primaryKey(),\n  projectId: integer(\"project_id\").notNull().references(() => projects.id, { onDelete: \"cascade\" }),\n  code: varchar(\"code\", { length: 50 }).notNull(),\n  system: text(\"system\").notNull(), // Mechanical, Electrical, etc.\n  areaCode: varchar(\"area_code\", { length: 50 }),\n  discipline: disciplineEnum(\"discipline\").default(\"general\"),\n  description: text(\"description\").notNull(),\n  category: punchCategoryEnum(\"category\").notNull().default(\"b\"), // A, B, C\n  status: punchStatusEnum(\"status\").notNull().default(\"open\"),\n  priority: issuePriorityEnum(\"priority\").notNull().default(\"medium\"),\n  assignedTo: varchar(\"assigned_to\", { length: 255 }).references(() => users.id),\n  responsibleContractor: text(\"responsible_contractor\"),\n  targetDate: timestamp(\"target_date\"),\n  completedDate: timestamp(\"completed_date\"),\n  verifiedBy: varchar(\"verified_by\", { length: 255 }).references(() => users.id),\n  verifiedDate: timestamp(\"verified_date\"),\n  remarks: text(\"remarks\"),\n  photoPath: text(\"photo_path\"), // Before/after photos\n  createdBy: varchar(\"created_by\", { length: 255 }).notNull().references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => ({\n  uniquePunchPerProject: unique(\"punch_items_project_code_unique\").on(table.projectId, table.code),\n}));\n\n// ==================== Daily Progress Reporting ====================\n\n// Daily Reports\nexport const dailyReports = pgTable(\"daily_reports\", {\n  id: serial(\"id\").primaryKey(),\n  projectId: integer(\"project_id\").notNull().references(() => projects.id, { onDelete: \"cascade\" }),\n  reportDate: timestamp(\"report_date\").notNull(),\n  weatherCondition: weatherConditionEnum(\"weather_condition\").default(\"clear\"),\n  weatherNotes: text(\"weather_notes\"),\n  temperature: integer(\"temperature\"), // Celsius\n  workableHours: decimal(\"workable_hours\", { precision: 4, scale: 1 }), // e.g., 8.5\n  activitiesCompleted: text(\"activities_completed\"),\n  activitiesPlanned: text(\"activities_planned\"), // For next day\n  issuesEncountered: text(\"issues_encountered\"),\n  safetyObservations: text(\"safety_observations\"),\n  qualityObservations: text(\"quality_observations\"),\n  visitorLog: text(\"visitor_log\"),\n  remarks: text(\"remarks\"),\n  submittedBy: varchar(\"submitted_by\", { length: 255 }).notNull().references(() => users.id),\n  approvedBy: varchar(\"approved_by\", { length: 255 }).references(() => users.id),\n  approvedDate: timestamp(\"approved_date\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => ({\n  uniqueReportPerProjectDate: unique(\"daily_reports_project_date_unique\").on(table.projectId, table.reportDate),\n}));\n\n// Daily Manpower (linked to daily reports)\nexport const dailyManpower = pgTable(\"daily_manpower\", {\n  id: serial(\"id\").primaryKey(),\n  dailyReportId: integer(\"daily_report_id\").notNull().references(() => dailyReports.id, { onDelete: \"cascade\" }),\n  trade: text(\"trade\").notNull(), // Electrician, Welder, Pipefitter, etc.\n  contractor: text(\"contractor\"),\n  plannedCount: integer(\"planned_count\").default(0),\n  actualCount: integer(\"actual_count\").default(0),\n  hoursWorked: decimal(\"hours_worked\", { precision: 5, scale: 1 }),\n  remarks: text(\"remarks\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// Daily Equipment (linked to daily reports)\nexport const dailyEquipment = pgTable(\"daily_equipment\", {\n  id: serial(\"id\").primaryKey(),\n  dailyReportId: integer(\"daily_report_id\").notNull().references(() => dailyReports.id, { onDelete: \"cascade\" }),\n  equipmentType: text(\"equipment_type\").notNull(), // Crane, Excavator, etc.\n  equipmentId: varchar(\"equipment_id\", { length: 50 }), // ID/tag number\n  contractor: text(\"contractor\"),\n  plannedHours: decimal(\"planned_hours\", { precision: 5, scale: 1 }),\n  actualHours: decimal(\"actual_hours\", { precision: 5, scale: 1 }),\n  status: text(\"status\"), // Working, Standby, Breakdown\n  remarks: text(\"remarks\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// Google Account Connections (for user's own Google integrations)\nexport const googleConnections = pgTable(\"google_connections\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\", { length: 255 }).notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  accessToken: text(\"access_token\").notNull(),\n  refreshToken: text(\"refresh_token\").notNull(),\n  expiresAt: timestamp(\"expires_at\").notNull(),\n  scope: text(\"scope\").notNull(), // Space-separated scopes\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\n// AI Conversations\nexport const aiConversations = pgTable(\"ai_conversations\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\", { length: 255 }).notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  projectId: integer(\"project_id\").references(() => projects.id, { onDelete: \"cascade\" }),\n  title: text(\"title\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\n// AI Messages\nexport const aiMessages = pgTable(\"ai_messages\", {\n  id: serial(\"id\").primaryKey(),\n  conversationId: integer(\"conversation_id\").notNull().references(() => aiConversations.id, { onDelete: \"cascade\" }),\n  role: text(\"role\").notNull(), // user, assistant, system\n  content: text(\"content\").notNull(),\n  functionCall: text(\"function_call\"), // JSON string of function call if any\n  tokensUsed: integer(\"tokens_used\").notNull().default(0),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// AI Usage Tracking\nexport const aiUsage = pgTable(\"ai_usage\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\", { length: 255 }).notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  organizationId: integer(\"organization_id\").references(() => organizations.id, { onDelete: \"cascade\" }),\n  tokensUsed: integer(\"tokens_used\").notNull(),\n  model: text(\"model\").notNull(),\n  operation: text(\"operation\").notNull(), // chat, analysis, report-generation, etc.\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// ==================== Project Events (Calendar) ====================\n\n// Project Events (for calendar meetings, audits, etc.)\nexport const projectEvents = pgTable(\"project_events\", {\n  id: serial(\"id\").primaryKey(),\n  projectId: integer(\"project_id\").notNull().references(() => projects.id, { onDelete: \"cascade\" }),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  eventType: eventTypeEnum(\"event_type\").notNull().default(\"meeting\"),\n  startDate: timestamp(\"start_date\").notNull(),\n  endDate: timestamp(\"end_date\"),\n  allDay: boolean(\"all_day\").default(false),\n  location: text(\"location\"),\n  attendees: text(\"attendees\"), // Comma-separated user IDs or emails\n  color: varchar(\"color\", { length: 20 }), // Custom color for calendar display\n  isRecurring: boolean(\"is_recurring\").default(false),\n  recurrencePattern: text(\"recurrence_pattern\"), // JSON for recurring rules\n  reminderMinutes: integer(\"reminder_minutes\"), // Minutes before to send reminder\n  createdBy: varchar(\"created_by\", { length: 255 }).notNull().references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\n// ==================== Junction Tables for Task Assignments ====================\n\n// Task-Document Assignments (for linking documents to tasks)\nexport const taskDocuments = pgTable(\"task_documents\", {\n  id: serial(\"id\").primaryKey(),\n  taskId: integer(\"task_id\").notNull().references(() => tasks.id, { onDelete: \"cascade\" }),\n  documentId: integer(\"document_id\").notNull().references(() => documents.id, { onDelete: \"cascade\" }),\n  relationship: text(\"relationship\").default(\"related\"), // related, deliverable, reference, input\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => ({\n  uniqueTaskDoc: unique(\"task_documents_unique\").on(table.taskId, table.documentId),\n}));\n\n// Task-Risk Assignments (for linking risks to tasks)\nexport const taskRisks = pgTable(\"task_risks\", {\n  id: serial(\"id\").primaryKey(),\n  taskId: integer(\"task_id\").notNull().references(() => tasks.id, { onDelete: \"cascade\" }),\n  riskId: integer(\"risk_id\").notNull().references(() => risks.id, { onDelete: \"cascade\" }),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => ({\n  uniqueTaskRisk: unique(\"task_risks_unique\").on(table.taskId, table.riskId),\n}));\n\n// Task-Issue Assignments (for linking issues to tasks)\nexport const taskIssues = pgTable(\"task_issues\", {\n  id: serial(\"id\").primaryKey(),\n  taskId: integer(\"task_id\").notNull().references(() => tasks.id, { onDelete: \"cascade\" }),\n  issueId: integer(\"issue_id\").notNull().references(() => issues.id, { onDelete: \"cascade\" }),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => ({\n  uniqueTaskIssue: unique(\"task_issues_unique\").on(table.taskId, table.issueId),\n}));\n\n// Zod Schemas for Organizations\nexport const insertOrganizationSchema = createInsertSchema(organizations).omit({ id: true, createdAt: true, updatedAt: true });\nexport const selectOrganizationSchema = createSelectSchema(organizations);\nexport type InsertOrganization = z.infer<typeof insertOrganizationSchema>;\nexport type Organization = typeof organizations.$inferSelect;\n\n// Zod Schemas for Users\nexport const insertUserSchema = createInsertSchema(users).omit({ createdAt: true, updatedAt: true });\nexport const upsertUserSchema = createInsertSchema(users).omit({ createdAt: true, updatedAt: true });\nexport const selectUserSchema = createSelectSchema(users);\nexport type InsertUser = z.infer<typeof insertUserSchema>;\nexport type UpsertUser = z.infer<typeof upsertUserSchema>;\nexport type User = typeof users.$inferSelect;\n\n// Zod Schemas for User Organizations\nexport const insertUserOrganizationSchema = createInsertSchema(userOrganizations).omit({ id: true, createdAt: true });\nexport const selectUserOrganizationSchema = createSelectSchema(userOrganizations);\nexport type InsertUserOrganization = z.infer<typeof insertUserOrganizationSchema>;\nexport type UserOrganization = typeof userOrganizations.$inferSelect;\n\n// Zod Schemas for Projects\nexport const insertProjectSchema = createInsertSchema(projects).omit({ id: true, createdAt: true, updatedAt: true });\nexport const updateProjectSchema = insertProjectSchema.partial();\nexport const selectProjectSchema = createSelectSchema(projects);\nexport type InsertProject = z.infer<typeof insertProjectSchema>;\nexport type UpdateProject = z.infer<typeof updateProjectSchema>;\nexport type Project = typeof projects.$inferSelect;\n\n// Zod Schemas for Tasks\nexport const insertTaskSchema = createInsertSchema(tasks).omit({ id: true, createdAt: true, updatedAt: true });\nexport const updateTaskSchema = insertTaskSchema.partial();\nexport const selectTaskSchema = createSelectSchema(tasks);\nexport type InsertTask = z.infer<typeof insertTaskSchema>;\nexport type UpdateTask = z.infer<typeof updateTaskSchema>;\nexport type Task = typeof tasks.$inferSelect;\n\n// Zod Schemas for Task Dependencies\nexport const insertTaskDependencySchema = createInsertSchema(taskDependencies).omit({ id: true, createdAt: true });\nexport const selectTaskDependencySchema = createSelectSchema(taskDependencies);\nexport type InsertTaskDependency = z.infer<typeof insertTaskDependencySchema>;\nexport type TaskDependency = typeof taskDependencies.$inferSelect;\n\n// Zod Schemas for Stakeholders\nexport const insertStakeholderSchema = createInsertSchema(stakeholders).omit({ id: true, createdAt: true, updatedAt: true });\nexport const updateStakeholderSchema = insertStakeholderSchema.partial();\nexport const selectStakeholderSchema = createSelectSchema(stakeholders);\nexport type InsertStakeholder = z.infer<typeof insertStakeholderSchema>;\nexport type UpdateStakeholder = z.infer<typeof updateStakeholderSchema>;\nexport type Stakeholder = typeof stakeholders.$inferSelect;\n\n// Zod Schemas for Stakeholder RACI Matrix\nexport const insertStakeholderRaciSchema = createInsertSchema(stakeholderRaci).omit({ id: true, createdAt: true, updatedAt: true });\nexport const updateStakeholderRaciSchema = insertStakeholderRaciSchema.partial();\nexport const selectStakeholderRaciSchema = createSelectSchema(stakeholderRaci);\nexport type InsertStakeholderRaci = z.infer<typeof insertStakeholderRaciSchema>;\nexport type UpdateStakeholderRaci = z.infer<typeof updateStakeholderRaciSchema>;\nexport type StakeholderRaci = typeof stakeholderRaci.$inferSelect;\n\n// Zod Schemas for Risks\nexport const insertRiskSchema = createInsertSchema(risks).omit({ id: true, createdAt: true, updatedAt: true, code: true }).extend({\n  code: z.string().optional(), // Auto-generated if not provided\n});\nexport const updateRiskSchema = insertRiskSchema.partial();\nexport const selectRiskSchema = createSelectSchema(risks);\nexport type InsertRisk = z.infer<typeof insertRiskSchema>;\nexport type UpdateRisk = z.infer<typeof updateRiskSchema>;\nexport type Risk = typeof risks.$inferSelect;\n\n// Zod Schemas for Issues\nexport const insertIssueSchema = createInsertSchema(issues).omit({ id: true, createdAt: true, updatedAt: true, code: true, reportedBy: true }).extend({\n  code: z.string().optional(), // Auto-generated if not provided\n  reportedBy: z.string().optional(), // Auto-set to current user if not provided\n});\nexport const updateIssueSchema = insertIssueSchema.partial();\nexport const selectIssueSchema = createSelectSchema(issues);\nexport type InsertIssue = z.infer<typeof insertIssueSchema>;\nexport type UpdateIssue = z.infer<typeof updateIssueSchema>;\nexport type Issue = typeof issues.$inferSelect;\n\n// Zod Schemas for Change Requests\nexport const insertChangeRequestSchema = createInsertSchema(changeRequests).omit({ id: true, createdAt: true, updatedAt: true });\nexport const selectChangeRequestSchema = createSelectSchema(changeRequests);\nexport type InsertChangeRequest = z.infer<typeof insertChangeRequestSchema>;\nexport type ChangeRequest = typeof changeRequests.$inferSelect;\n\n// Zod Schemas for Cost Items\nexport const insertCostItemSchema = createInsertSchema(costItems).omit({ id: true, createdAt: true, updatedAt: true });\nexport const updateCostItemSchema = insertCostItemSchema.partial();\nexport const selectCostItemSchema = createSelectSchema(costItems);\nexport type InsertCostItem = z.infer<typeof insertCostItemSchema>;\nexport type UpdateCostItem = z.infer<typeof updateCostItemSchema>;\nexport type CostItem = typeof costItems.$inferSelect;\n\n// Zod Schemas for Resources\nexport const insertResourceSchema = createInsertSchema(resources).omit({ id: true, createdAt: true, updatedAt: true });\nexport const selectResourceSchema = createSelectSchema(resources);\nexport type InsertResource = z.infer<typeof insertResourceSchema>;\nexport type Resource = typeof resources.$inferSelect;\n\n// Zod Schemas for Resource Assignments\nexport const insertResourceAssignmentSchema = createInsertSchema(resourceAssignments).omit({ id: true, createdAt: true });\nexport const selectResourceAssignmentSchema = createSelectSchema(resourceAssignments);\nexport type InsertResourceAssignment = z.infer<typeof insertResourceAssignmentSchema>;\nexport type ResourceAssignment = typeof resourceAssignments.$inferSelect;\n\n// Zod Schemas for Google Connections\nexport const insertGoogleConnectionSchema = createInsertSchema(googleConnections).omit({ id: true, createdAt: true, updatedAt: true });\nexport const selectGoogleConnectionSchema = createSelectSchema(googleConnections);\nexport type InsertGoogleConnection = z.infer<typeof insertGoogleConnectionSchema>;\nexport type GoogleConnection = typeof googleConnections.$inferSelect;\n\n// Zod Schemas for AI Conversations\nexport const insertAiConversationSchema = createInsertSchema(aiConversations).omit({ id: true, createdAt: true, updatedAt: true });\nexport const selectAiConversationSchema = createSelectSchema(aiConversations);\nexport type InsertAiConversation = z.infer<typeof insertAiConversationSchema>;\nexport type AiConversation = typeof aiConversations.$inferSelect;\n\n// Zod Schemas for AI Messages\nexport const insertAiMessageSchema = createInsertSchema(aiMessages).omit({ id: true, createdAt: true });\nexport const selectAiMessageSchema = createSelectSchema(aiMessages);\nexport type InsertAiMessage = z.infer<typeof insertAiMessageSchema>;\nexport type AiMessage = typeof aiMessages.$inferSelect;\n\n// Zod Schemas for AI Usage\nexport const insertAiUsageSchema = createInsertSchema(aiUsage).omit({ id: true, createdAt: true });\nexport const selectAiUsageSchema = createSelectSchema(aiUsage);\nexport type InsertAiUsage = z.infer<typeof insertAiUsageSchema>;\nexport type AiUsage = typeof aiUsage.$inferSelect;\n\n// Email Template Type Enum\nexport const emailTemplateTypeEnum = pgEnum(\"email_template_type\", [\n  \"task-assigned\",\n  \"task-due-reminder\",\n  \"risk-identified\",\n  \"issue-reported\",\n  \"change-request-submitted\",\n  \"change-request-approved\",\n  \"change-request-rejected\",\n  \"project-update\",\n  \"milestone-reached\",\n  \"custom\"\n]);\n\n// Email Templates (Organization-level)\nexport const emailTemplates = pgTable(\"email_templates\", {\n  id: serial(\"id\").primaryKey(),\n  organizationId: integer(\"organization_id\").notNull().references(() => organizations.id, { onDelete: \"cascade\" }),\n  type: emailTemplateTypeEnum(\"type\").notNull(),\n  name: text(\"name\").notNull(),\n  subject: text(\"subject\").notNull(),\n  body: text(\"body\").notNull(), // HTML content with {{placeholders}}\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdBy: varchar(\"created_by\", { length: 255 }).notNull().references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\n// Sent Email Log (for tracking and analytics)\nexport const sentEmails = pgTable(\"sent_emails\", {\n  id: serial(\"id\").primaryKey(),\n  organizationId: integer(\"organization_id\").notNull().references(() => organizations.id, { onDelete: \"cascade\" }),\n  projectId: integer(\"project_id\").references(() => projects.id, { onDelete: \"set null\" }),\n  templateId: integer(\"template_id\").references(() => emailTemplates.id, { onDelete: \"set null\" }),\n  toEmail: text(\"to_email\").notNull(),\n  subject: text(\"subject\").notNull(),\n  status: text(\"status\").notNull().default(\"pending\"), // pending, sent, failed, bounced\n  errorMessage: text(\"error_message\"),\n  sentAt: timestamp(\"sent_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// Email Usage Tracking (for billing)\nexport const emailUsage = pgTable(\"email_usage\", {\n  id: serial(\"id\").primaryKey(),\n  organizationId: integer(\"organization_id\").notNull().references(() => organizations.id, { onDelete: \"cascade\" }),\n  month: varchar(\"month\", { length: 7 }).notNull(), // Format: YYYY-MM\n  emailsSent: integer(\"emails_sent\").notNull().default(0),\n  emailLimit: integer(\"email_limit\").notNull().default(1000), // Based on subscription tier\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => ({\n  uniqueOrgMonth: unique(\"email_usage_org_month_unique\").on(table.organizationId, table.month),\n}));\n\n// Zod Schemas for Email Templates\nexport const insertEmailTemplateSchema = createInsertSchema(emailTemplates).omit({ id: true, createdAt: true, updatedAt: true, createdBy: true });\nexport const updateEmailTemplateSchema = insertEmailTemplateSchema.partial();\nexport const selectEmailTemplateSchema = createSelectSchema(emailTemplates);\nexport type InsertEmailTemplate = z.infer<typeof insertEmailTemplateSchema>;\nexport type UpdateEmailTemplate = z.infer<typeof updateEmailTemplateSchema>;\nexport type EmailTemplate = typeof emailTemplates.$inferSelect;\n\n// Zod Schemas for Sent Emails\nexport const insertSentEmailSchema = createInsertSchema(sentEmails).omit({ id: true, createdAt: true });\nexport const selectSentEmailSchema = createSelectSchema(sentEmails);\nexport type InsertSentEmail = z.infer<typeof insertSentEmailSchema>;\nexport type SentEmail = typeof sentEmails.$inferSelect;\n\n// Zod Schemas for Email Usage\nexport const insertEmailUsageSchema = createInsertSchema(emailUsage).omit({ id: true, createdAt: true, updatedAt: true });\nexport const selectEmailUsageSchema = createSelectSchema(emailUsage);\nexport type InsertEmailUsage = z.infer<typeof insertEmailUsageSchema>;\nexport type EmailUsage = typeof emailUsage.$inferSelect;\n\n// File Uploads (Project Documents)\nexport const projectFiles = pgTable(\"project_files\", {\n  id: serial(\"id\").primaryKey(),\n  projectId: integer(\"project_id\").notNull().references(() => projects.id, { onDelete: \"cascade\" }),\n  organizationId: integer(\"organization_id\").notNull().references(() => organizations.id, { onDelete: \"cascade\" }),\n  name: text(\"name\").notNull(),\n  originalName: text(\"original_name\").notNull(),\n  mimeType: text(\"mime_type\").notNull(),\n  size: integer(\"size\").notNull(), // Size in bytes\n  objectPath: text(\"object_path\").notNull(), // Path in object storage\n  category: text(\"category\").notNull().default(\"general\"), // document, drawing, report, photo, other\n  description: text(\"description\"),\n  uploadedBy: varchar(\"uploaded_by\", { length: 255 }).notNull().references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => ({\n  projectIdx: index(\"project_files_project_idx\").on(table.projectId),\n  orgIdx: index(\"project_files_org_idx\").on(table.organizationId),\n}));\n\n// Storage Quota (Organization-level tracking)\nexport const storageQuotas = pgTable(\"storage_quotas\", {\n  id: serial(\"id\").primaryKey(),\n  organizationId: integer(\"organization_id\").notNull().references(() => organizations.id, { onDelete: \"cascade\" }).unique(),\n  usedBytes: integer(\"used_bytes\").notNull().default(0),\n  quotaBytes: integer(\"quota_bytes\").notNull().default(1073741824), // 1GB default quota\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\n// Zod Schemas for Project Files\nexport const insertProjectFileSchema = createInsertSchema(projectFiles).omit({ id: true, createdAt: true, updatedAt: true, uploadedBy: true });\nexport const updateProjectFileSchema = insertProjectFileSchema.partial();\nexport const selectProjectFileSchema = createSelectSchema(projectFiles);\nexport type InsertProjectFile = z.infer<typeof insertProjectFileSchema>;\nexport type UpdateProjectFile = z.infer<typeof updateProjectFileSchema>;\nexport type ProjectFile = typeof projectFiles.$inferSelect;\n\n// Zod Schemas for Storage Quotas\nexport const insertStorageQuotaSchema = createInsertSchema(storageQuotas).omit({ id: true, createdAt: true, updatedAt: true });\nexport const selectStorageQuotaSchema = createSelectSchema(storageQuotas);\nexport type InsertStorageQuota = z.infer<typeof insertStorageQuotaSchema>;\nexport type StorageQuota = typeof storageQuotas.$inferSelect;\n\n// Subscription Tier Enum\nexport const subscriptionTierEnum = pgEnum(\"subscription_tier\", [\"free\", \"starter\", \"professional\", \"enterprise\"]);\n\n// Subscription Plans (defines limits for each tier)\nexport const subscriptionPlans = pgTable(\"subscription_plans\", {\n  id: serial(\"id\").primaryKey(),\n  tier: subscriptionTierEnum(\"tier\").notNull().unique(),\n  name: text(\"name\").notNull(),\n  description: text(\"description\"),\n  priceMonthly: decimal(\"price_monthly\", { precision: 10, scale: 2 }).notNull(),\n  priceYearly: decimal(\"price_yearly\", { precision: 10, scale: 2 }).notNull(),\n  maxProjects: integer(\"max_projects\").notNull(),\n  maxTasksPerProject: integer(\"max_tasks_per_project\").notNull(),\n  maxUsers: integer(\"max_users\").notNull(),\n  storageQuotaBytes: integer(\"storage_quota_bytes\").notNull(), // Bytes\n  aiTokensMonthly: integer(\"ai_tokens_monthly\").notNull(), // Monthly AI token limit\n  emailsMonthly: integer(\"emails_monthly\").notNull(), // Monthly email limit\n  includesCloudSync: boolean(\"includes_cloud_sync\").notNull().default(false),\n  includesAdvancedReports: boolean(\"includes_advanced_reports\").notNull().default(false),\n  includesWhiteLabel: boolean(\"includes_white_label\").notNull().default(false),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\n// Organization Subscriptions (active subscription for each org)\nexport const organizationSubscriptions = pgTable(\"organization_subscriptions\", {\n  id: serial(\"id\").primaryKey(),\n  organizationId: integer(\"organization_id\").notNull().references(() => organizations.id, { onDelete: \"cascade\" }).unique(),\n  planId: integer(\"plan_id\").notNull().references(() => subscriptionPlans.id),\n  status: varchar(\"status\", { length: 50 }).notNull().default(\"active\"), // active, cancelled, past_due, expired\n  billingCycle: varchar(\"billing_cycle\", { length: 20 }).notNull().default(\"monthly\"), // monthly, yearly\n  currentPeriodStart: timestamp(\"current_period_start\").notNull().defaultNow(),\n  currentPeriodEnd: timestamp(\"current_period_end\").notNull(),\n  cancelledAt: timestamp(\"cancelled_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\n// AI Usage Summary (aggregated monthly usage per organization)\nexport const aiUsageSummary = pgTable(\"ai_usage_summary\", {\n  id: serial(\"id\").primaryKey(),\n  organizationId: integer(\"organization_id\").notNull().references(() => organizations.id, { onDelete: \"cascade\" }),\n  month: varchar(\"month\", { length: 7 }).notNull(), // Format: YYYY-MM\n  tokensUsed: integer(\"tokens_used\").notNull().default(0),\n  tokenLimit: integer(\"token_limit\").notNull().default(50000), // Based on subscription tier\n  requestCount: integer(\"request_count\").notNull().default(0),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => ({\n  uniqueOrgMonth: unique(\"ai_usage_summary_org_month_unique\").on(table.organizationId, table.month),\n}));\n\n// Zod Schemas for Subscription Plans\nexport const insertSubscriptionPlanSchema = createInsertSchema(subscriptionPlans).omit({ id: true, createdAt: true, updatedAt: true });\nexport const updateSubscriptionPlanSchema = insertSubscriptionPlanSchema.partial();\nexport const selectSubscriptionPlanSchema = createSelectSchema(subscriptionPlans);\nexport type InsertSubscriptionPlan = z.infer<typeof insertSubscriptionPlanSchema>;\nexport type UpdateSubscriptionPlan = z.infer<typeof updateSubscriptionPlanSchema>;\nexport type SubscriptionPlan = typeof subscriptionPlans.$inferSelect;\n\n// Zod Schemas for Organization Subscriptions\nexport const insertOrganizationSubscriptionSchema = createInsertSchema(organizationSubscriptions).omit({ id: true, createdAt: true, updatedAt: true });\nexport const updateOrganizationSubscriptionSchema = insertOrganizationSubscriptionSchema.partial();\nexport const selectOrganizationSubscriptionSchema = createSelectSchema(organizationSubscriptions);\nexport type InsertOrganizationSubscription = z.infer<typeof insertOrganizationSubscriptionSchema>;\nexport type UpdateOrganizationSubscription = z.infer<typeof updateOrganizationSubscriptionSchema>;\nexport type OrganizationSubscription = typeof organizationSubscriptions.$inferSelect;\n\n// Zod Schemas for AI Usage Summary\nexport const insertAiUsageSummarySchema = createInsertSchema(aiUsageSummary).omit({ id: true, createdAt: true, updatedAt: true });\nexport const updateAiUsageSummarySchema = insertAiUsageSummarySchema.partial();\nexport const selectAiUsageSummarySchema = createSelectSchema(aiUsageSummary);\nexport type InsertAiUsageSummary = z.infer<typeof insertAiUsageSummarySchema>;\nexport type UpdateAiUsageSummary = z.infer<typeof updateAiUsageSummarySchema>;\nexport type AiUsageSummary = typeof aiUsageSummary.$inferSelect;\n\n// Cloud Storage Connections (Google Drive, OneDrive, Dropbox per organization)\nexport const cloudStorageConnections = pgTable(\"cloud_storage_connections\", {\n  id: serial(\"id\").primaryKey(),\n  organizationId: integer(\"organization_id\").notNull().references(() => organizations.id, { onDelete: \"cascade\" }),\n  provider: varchar(\"provider\", { length: 50 }).notNull(), // google_drive, onedrive, dropbox\n  connectedBy: varchar(\"connected_by\", { length: 255 }).notNull().references(() => users.id),\n  accessToken: text(\"access_token\"), // Encrypted OAuth access token\n  refreshToken: text(\"refresh_token\"), // Encrypted OAuth refresh token\n  tokenExpiresAt: timestamp(\"token_expires_at\"),\n  accountEmail: varchar(\"account_email\", { length: 255 }), // Connected account email\n  accountName: varchar(\"account_name\", { length: 255 }), // Connected account display name\n  rootFolderId: varchar(\"root_folder_id\", { length: 255 }), // Root folder for sync\n  rootFolderName: varchar(\"root_folder_name\", { length: 255 }),\n  syncEnabled: boolean(\"sync_enabled\").notNull().default(true),\n  lastSyncAt: timestamp(\"last_sync_at\"),\n  syncStatus: varchar(\"sync_status\", { length: 50 }).default(\"idle\"), // idle, syncing, error\n  syncError: text(\"sync_error\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => ({\n  orgProviderIdx: index(\"cloud_storage_org_provider_idx\").on(table.organizationId, table.provider),\n}));\n\n// Synced Cloud Files (one-way sync from cloud storage to local storage)\nexport const cloudSyncedFiles = pgTable(\"cloud_synced_files\", {\n  id: serial(\"id\").primaryKey(),\n  connectionId: integer(\"connection_id\").notNull().references(() => cloudStorageConnections.id, { onDelete: \"cascade\" }),\n  projectId: integer(\"project_id\").notNull().references(() => projects.id, { onDelete: \"cascade\" }),\n  cloudFileId: varchar(\"cloud_file_id\", { length: 500 }).notNull(), // Provider's file ID\n  cloudFilePath: text(\"cloud_file_path\").notNull(), // Full path in cloud storage\n  localFileId: integer(\"local_file_id\").references(() => projectFiles.id, { onDelete: \"set null\" }), // Local copy\n  name: varchar(\"name\", { length: 255 }).notNull(),\n  mimeType: varchar(\"mime_type\", { length: 255 }),\n  size: integer(\"size\"),\n  cloudModifiedAt: timestamp(\"cloud_modified_at\"),\n  lastSyncedAt: timestamp(\"last_synced_at\"),\n  syncStatus: varchar(\"sync_status\", { length: 50 }).default(\"pending\"), // pending, synced, error\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => ({\n  connectionIdx: index(\"cloud_synced_files_connection_idx\").on(table.connectionId),\n  projectIdx: index(\"cloud_synced_files_project_idx\").on(table.projectId),\n  cloudFileIdx: index(\"cloud_synced_files_cloud_file_idx\").on(table.connectionId, table.cloudFileId),\n}));\n\n// Zod Schemas for Cloud Storage Connections\nexport const insertCloudStorageConnectionSchema = createInsertSchema(cloudStorageConnections).omit({ \n  id: true, createdAt: true, updatedAt: true, connectedBy: true, lastSyncAt: true, syncStatus: true, syncError: true \n});\nexport const updateCloudStorageConnectionSchema = insertCloudStorageConnectionSchema.partial();\nexport const selectCloudStorageConnectionSchema = createSelectSchema(cloudStorageConnections);\nexport type InsertCloudStorageConnection = z.infer<typeof insertCloudStorageConnectionSchema>;\nexport type UpdateCloudStorageConnection = z.infer<typeof updateCloudStorageConnectionSchema>;\nexport type CloudStorageConnection = typeof cloudStorageConnections.$inferSelect;\n\n// Zod Schemas for Cloud Synced Files\nexport const insertCloudSyncedFileSchema = createInsertSchema(cloudSyncedFiles).omit({ id: true, createdAt: true, updatedAt: true });\nexport const updateCloudSyncedFileSchema = insertCloudSyncedFileSchema.partial();\nexport const selectCloudSyncedFileSchema = createSelectSchema(cloudSyncedFiles);\nexport type InsertCloudSyncedFile = z.infer<typeof insertCloudSyncedFileSchema>;\nexport type UpdateCloudSyncedFile = z.infer<typeof updateCloudSyncedFileSchema>;\nexport type CloudSyncedFile = typeof cloudSyncedFiles.$inferSelect;\n\n// ==================== EPC Document Control Zod Schemas ====================\n\n// Zod Schemas for Documents\nexport const insertDocumentSchema = createInsertSchema(documents).omit({ id: true, createdAt: true, updatedAt: true, createdBy: true });\nexport const updateDocumentSchema = insertDocumentSchema.partial();\nexport const selectDocumentSchema = createSelectSchema(documents);\nexport type InsertDocument = z.infer<typeof insertDocumentSchema>;\nexport type UpdateDocument = z.infer<typeof updateDocumentSchema>;\nexport type Document = typeof documents.$inferSelect;\n\n// Zod Schemas for Transmittals\nexport const insertTransmittalSchema = createInsertSchema(transmittals).omit({ id: true, createdAt: true, updatedAt: true, createdBy: true });\nexport const updateTransmittalSchema = insertTransmittalSchema.partial();\nexport const selectTransmittalSchema = createSelectSchema(transmittals);\nexport type InsertTransmittal = z.infer<typeof insertTransmittalSchema>;\nexport type UpdateTransmittal = z.infer<typeof updateTransmittalSchema>;\nexport type Transmittal = typeof transmittals.$inferSelect;\n\n// Zod Schemas for Transmittal Documents\nexport const insertTransmittalDocumentSchema = createInsertSchema(transmittalDocuments).omit({ id: true, createdAt: true });\nexport const selectTransmittalDocumentSchema = createSelectSchema(transmittalDocuments);\nexport type InsertTransmittalDocument = z.infer<typeof insertTransmittalDocumentSchema>;\nexport type TransmittalDocument = typeof transmittalDocuments.$inferSelect;\n\n// Zod Schemas for RFIs\nexport const insertRfiSchema = createInsertSchema(rfis).omit({ id: true, createdAt: true, updatedAt: true, submittedBy: true }).extend({\n  rfiNumber: z.string().optional(), // Auto-generated if not provided\n});\nexport const updateRfiSchema = insertRfiSchema.partial();\nexport const selectRfiSchema = createSelectSchema(rfis);\nexport type InsertRfi = z.infer<typeof insertRfiSchema>;\nexport type UpdateRfi = z.infer<typeof updateRfiSchema>;\nexport type Rfi = typeof rfis.$inferSelect;\n\n// Zod Schemas for Punch Items\nexport const insertPunchItemSchema = createInsertSchema(punchItems).omit({ id: true, createdAt: true, updatedAt: true, createdBy: true, code: true }).extend({\n  code: z.string().optional(), // Auto-generated if not provided\n});\nexport const updatePunchItemSchema = insertPunchItemSchema.partial();\nexport const selectPunchItemSchema = createSelectSchema(punchItems);\nexport type InsertPunchItem = z.infer<typeof insertPunchItemSchema>;\nexport type UpdatePunchItem = z.infer<typeof updatePunchItemSchema>;\nexport type PunchItem = typeof punchItems.$inferSelect;\n\n// ==================== Daily Progress Reporting Zod Schemas ====================\n\n// Zod Schemas for Daily Reports\nexport const insertDailyReportSchema = createInsertSchema(dailyReports).omit({ id: true, createdAt: true, updatedAt: true, submittedBy: true });\nexport const updateDailyReportSchema = insertDailyReportSchema.partial();\nexport const selectDailyReportSchema = createSelectSchema(dailyReports);\nexport type InsertDailyReport = z.infer<typeof insertDailyReportSchema>;\nexport type UpdateDailyReport = z.infer<typeof updateDailyReportSchema>;\nexport type DailyReport = typeof dailyReports.$inferSelect;\n\n// Zod Schemas for Daily Manpower\nexport const insertDailyManpowerSchema = createInsertSchema(dailyManpower).omit({ id: true, createdAt: true });\nexport const updateDailyManpowerSchema = insertDailyManpowerSchema.partial();\nexport const selectDailyManpowerSchema = createSelectSchema(dailyManpower);\nexport type InsertDailyManpower = z.infer<typeof insertDailyManpowerSchema>;\nexport type UpdateDailyManpower = z.infer<typeof updateDailyManpowerSchema>;\nexport type DailyManpower = typeof dailyManpower.$inferSelect;\n\n// Zod Schemas for Daily Equipment\nexport const insertDailyEquipmentSchema = createInsertSchema(dailyEquipment).omit({ id: true, createdAt: true });\nexport const updateDailyEquipmentSchema = insertDailyEquipmentSchema.partial();\nexport const selectDailyEquipmentSchema = createSelectSchema(dailyEquipment);\nexport type InsertDailyEquipment = z.infer<typeof insertDailyEquipmentSchema>;\nexport type UpdateDailyEquipment = z.infer<typeof updateDailyEquipmentSchema>;\nexport type DailyEquipment = typeof dailyEquipment.$inferSelect;\n\n// ==================== Project Events Zod Schemas ====================\n\n// Zod Schemas for Project Events\nexport const insertProjectEventSchema = createInsertSchema(projectEvents).omit({ id: true, createdAt: true, updatedAt: true, createdBy: true });\nexport const updateProjectEventSchema = insertProjectEventSchema.partial();\nexport const selectProjectEventSchema = createSelectSchema(projectEvents);\nexport type InsertProjectEvent = z.infer<typeof insertProjectEventSchema>;\nexport type UpdateProjectEvent = z.infer<typeof updateProjectEventSchema>;\nexport type ProjectEvent = typeof projectEvents.$inferSelect;\n\n// ==================== Task Junction Table Zod Schemas ====================\n\n// Zod Schemas for Task Documents\nexport const insertTaskDocumentSchema = createInsertSchema(taskDocuments).omit({ id: true, createdAt: true });\nexport const selectTaskDocumentSchema = createSelectSchema(taskDocuments);\nexport type InsertTaskDocument = z.infer<typeof insertTaskDocumentSchema>;\nexport type TaskDocument = typeof taskDocuments.$inferSelect;\n\n// Zod Schemas for Task Risks\nexport const insertTaskRiskSchema = createInsertSchema(taskRisks).omit({ id: true, createdAt: true });\nexport const selectTaskRiskSchema = createSelectSchema(taskRisks);\nexport type InsertTaskRisk = z.infer<typeof insertTaskRiskSchema>;\nexport type TaskRisk = typeof taskRisks.$inferSelect;\n\n// Zod Schemas for Task Issues\nexport const insertTaskIssueSchema = createInsertSchema(taskIssues).omit({ id: true, createdAt: true });\nexport const selectTaskIssueSchema = createSelectSchema(taskIssues);\nexport type InsertTaskIssue = z.infer<typeof insertTaskIssueSchema>;\nexport type TaskIssue = typeof taskIssues.$inferSelect;\n","size_bytes":68138},"client/src/pages/StakeholdersPage.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Search, Mail, Phone, Edit, Trash2, AlertCircle } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { Stakeholder } from \"@shared/schema\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\n\nexport default function StakeholdersPage() {\n  const { selectedProjectId } = useProject();\n  const { toast } = useToast();\n  const [dialogOpen, setDialogOpen] = useState(false);\n  const [editingStakeholder, setEditingStakeholder] = useState<Stakeholder | null>(null);\n  const [formData, setFormData] = useState({\n    name: \"\",\n    role: \"other\" as \"consultant\" | \"sponsor\" | \"client\" | \"team-member\" | \"contractor\" | \"other\",\n    email: \"\",\n    phone: \"\",\n    organization: \"\",\n  });\n\n  // Fetch stakeholders\n  const { \n    data: stakeholders = [], \n    isLoading, \n    error, \n    refetch \n  } = useQuery<Stakeholder[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/stakeholders`],\n    enabled: !!selectedProjectId,\n    retry: 1,\n  });\n\n  // Create stakeholder mutation\n  const createMutation = useMutation({\n    mutationFn: async (data: typeof formData) => {\n      if (!selectedProjectId) throw new Error(\"No project selected\");\n      await apiRequest(\"POST\", \"/api/stakeholders\", {\n        ...data,\n        projectId: selectedProjectId,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${selectedProjectId}/stakeholders`] });\n      setDialogOpen(false);\n      setEditingStakeholder(null);\n      setFormData({\n        name: \"\",\n        role: \"other\",\n        email: \"\",\n        phone: \"\",\n        organization: \"\",\n      });\n      toast({\n        title: \"Success\",\n        description: \"Stakeholder added successfully\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to add stakeholder\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Update stakeholder mutation\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: number; data: typeof formData }) => {\n      await apiRequest(\"PATCH\", `/api/stakeholders/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${selectedProjectId}/stakeholders`] });\n      setDialogOpen(false);\n      setEditingStakeholder(null);\n      setFormData({\n        name: \"\",\n        role: \"other\",\n        email: \"\",\n        phone: \"\",\n        organization: \"\",\n      });\n      toast({\n        title: \"Success\",\n        description: \"Stakeholder updated successfully\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to update stakeholder\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Delete stakeholder mutation\n  const deleteMutation = useMutation({\n    mutationFn: async (id: number) => {\n      await apiRequest(\"DELETE\", `/api/stakeholders/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${selectedProjectId}/stakeholders`] });\n      toast({\n        title: \"Success\",\n        description: \"Stakeholder deleted successfully\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to delete stakeholder\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (editingStakeholder) {\n      updateMutation.mutate({ id: editingStakeholder.id, data: formData });\n    } else {\n      createMutation.mutate(formData);\n    }\n  };\n\n  const handleEdit = (stakeholder: Stakeholder) => {\n    setEditingStakeholder(stakeholder);\n    setFormData({\n      name: stakeholder.name,\n      role: stakeholder.role as any,\n      email: stakeholder.email || \"\",\n      phone: stakeholder.phone || \"\",\n      organization: stakeholder.organization || \"\",\n    });\n    setDialogOpen(true);\n  };\n\n  const handleDelete = async (id: number) => {\n    if (window.confirm(\"Are you sure you want to delete this stakeholder?\")) {\n      deleteMutation.mutate(id);\n    }\n  };\n\n  const handleAddNew = () => {\n    setEditingStakeholder(null);\n    setFormData({\n      name: \"\",\n      role: \"other\",\n      email: \"\",\n      phone: \"\",\n      organization: \"\",\n    });\n    setDialogOpen(true);\n  };\n\n  if (!selectedProjectId) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"text-center py-12\">\n          <h2 className=\"text-2xl font-semibold mb-2\">No Project Selected</h2>\n          <p className=\"text-muted-foreground\">Please select a project from the dropdown above</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-4\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-semibold\">Stakeholders</h1>\n          <p className=\"text-muted-foreground\">Project team and external contacts</p>\n        </div>\n        <Button onClick={handleAddNew} data-testid=\"button-add-stakeholder\">\n          Add Stakeholder\n        </Button>\n      </div>\n\n      {error && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertDescription className=\"flex items-center justify-between\">\n            <span>Failed to load stakeholders. {(error as Error).message}</span>\n            <Button \n              variant=\"outline\" \n              size=\"sm\" \n              onClick={() => refetch()}\n              data-testid=\"button-retry\"\n            >\n              Retry\n            </Button>\n          </AlertDescription>\n        </Alert>\n      )}\n\n      <div className=\"relative max-w-md\">\n        <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n        <Input\n          type=\"search\"\n          placeholder=\"Search stakeholders...\"\n          className=\"pl-9\"\n          data-testid=\"input-search-stakeholders\"\n        />\n      </div>\n\n      {isLoading ? (\n        <div className=\"text-center py-12\">\n          <p className=\"text-muted-foreground\">Loading stakeholders...</p>\n        </div>\n      ) : stakeholders.length === 0 ? (\n        <div className=\"text-center py-12\">\n          <h2 className=\"text-2xl font-semibold mb-2\">No Stakeholders Found</h2>\n          <p className=\"text-muted-foreground mb-4\">Get started by adding stakeholders to your project</p>\n          <Button onClick={handleAddNew} data-testid=\"button-add-first-stakeholder\">\n            Add Stakeholder\n          </Button>\n        </div>\n      ) : (\n        <div className=\"grid gap-4 md:grid-cols-2\">\n          {stakeholders.map((stakeholder) => (\n            <Card\n              key={stakeholder.id}\n              className=\"hover-elevate cursor-pointer transition-shadow\"\n              data-testid={`card-stakeholder-${stakeholder.id}`}\n            >\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-start gap-4\">\n                  <Avatar className=\"h-12 w-12\">\n                    <AvatarFallback className=\"text-sm\">\n                      {stakeholder.name.split(' ').map(n => n[0]).join('')}\n                    </AvatarFallback>\n                  </Avatar>\n                  \n                  <div className=\"flex-1 space-y-2\">\n                    <div>\n                      <h3 className=\"font-semibold\">{stakeholder.name}</h3>\n                      <p className=\"text-sm text-muted-foreground\">{stakeholder.role}</p>\n                    </div>\n\n                    {stakeholder.organization && (\n                      <div className=\"flex items-center gap-2\">\n                        <span className=\"text-xs text-muted-foreground\">{stakeholder.organization}</span>\n                      </div>\n                    )}\n\n                    <div className=\"space-y-1\">\n                      {stakeholder.email && (\n                        <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                          <Mail className=\"h-3 w-3\" />\n                          <a href={`mailto:${stakeholder.email}`} className=\"hover:text-foreground\">\n                            {stakeholder.email}\n                          </a>\n                        </div>\n                      )}\n                      {stakeholder.phone && (\n                        <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                          <Phone className=\"h-3 w-3\" />\n                          <a href={`tel:${stakeholder.phone}`} className=\"hover:text-foreground\">\n                            {stakeholder.phone}\n                          </a>\n                        </div>\n                      )}\n                    </div>\n\n                    <DropdownMenu>\n                      <DropdownMenuTrigger asChild>\n                        <Button variant=\"ghost\" size=\"sm\" data-testid={`button-actions-${stakeholder.id}`}>\n                          Actions\n                        </Button>\n                      </DropdownMenuTrigger>\n                      <DropdownMenuContent align=\"end\">\n                        <DropdownMenuItem onClick={() => handleEdit(stakeholder)} data-testid={`action-edit-${stakeholder.id}`}>\n                          <Edit className=\"h-4 w-4 mr-2\" />\n                          Edit\n                        </DropdownMenuItem>\n                        <DropdownMenuItem \n                          onClick={() => handleDelete(stakeholder.id)} \n                          className=\"text-destructive\"\n                          data-testid={`action-delete-${stakeholder.id}`}\n                        >\n                          <Trash2 className=\"h-4 w-4 mr-2\" />\n                          Delete\n                        </DropdownMenuItem>\n                      </DropdownMenuContent>\n                    </DropdownMenu>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n\n      <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>\n        <DialogContent data-testid=\"dialog-stakeholder\">\n          <DialogHeader>\n            <DialogTitle>{editingStakeholder ? \"Edit Stakeholder\" : \"Add Stakeholder\"}</DialogTitle>\n          </DialogHeader>\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"name\">Name</Label>\n              <Input\n                id=\"name\"\n                value={formData.name}\n                onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                required\n                data-testid=\"input-stakeholder-name\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"role\">Role</Label>\n              <Select\n                value={formData.role}\n                onValueChange={(value: any) => setFormData({ ...formData, role: value })}\n              >\n                <SelectTrigger data-testid=\"select-stakeholder-role\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"sponsor\">Sponsor</SelectItem>\n                  <SelectItem value=\"client\">Client</SelectItem>\n                  <SelectItem value=\"team-member\">Team Member</SelectItem>\n                  <SelectItem value=\"contractor\">Contractor</SelectItem>\n                  <SelectItem value=\"consultant\">Consultant</SelectItem>\n                  <SelectItem value=\"other\">Other</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"email\">Email</Label>\n              <Input\n                id=\"email\"\n                type=\"email\"\n                value={formData.email}\n                onChange={(e) => setFormData({ ...formData, email: e.target.value })}\n                data-testid=\"input-stakeholder-email\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"phone\">Phone</Label>\n              <Input\n                id=\"phone\"\n                type=\"tel\"\n                value={formData.phone}\n                onChange={(e) => setFormData({ ...formData, phone: e.target.value })}\n                data-testid=\"input-stakeholder-phone\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"organization\">Organization</Label>\n              <Input\n                id=\"organization\"\n                value={formData.organization}\n                onChange={(e) => setFormData({ ...formData, organization: e.target.value })}\n                data-testid=\"input-stakeholder-organization\"\n              />\n            </div>\n\n\n            <DialogFooter>\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => setDialogOpen(false)}\n                data-testid=\"button-cancel\"\n              >\n                Cancel\n              </Button>\n              <Button\n                type=\"submit\"\n                disabled={createMutation.isPending || updateMutation.isPending}\n                data-testid=\"button-submit\"\n              >\n                {createMutation.isPending || updateMutation.isPending \n                  ? \"Saving...\" \n                  : editingStakeholder \n                    ? \"Update Stakeholder\" \n                    : \"Add Stakeholder\"}\n              </Button>\n            </DialogFooter>\n          </form>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":14498},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","size_bytes":791},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","size_bytes":1383},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","size_bytes":4120},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* LIGHT MODE */\n:root {\n  --button-outline: rgba(0,0,0, .10);\n  --badge-outline: rgba(0,0,0, .05);\n  --opaque-button-border-intensity: -8;\n  --elevate-1: rgba(0,0,0, .03);\n  --elevate-2: rgba(0,0,0, .08);\n  --background: 210 20% 98%;\n  --foreground: 210 20% 12%;\n  --border: 210 15% 88%;\n  --card: 210 18% 96%;\n  --card-foreground: 210 18% 15%;\n  --card-border: 210 15% 90%;\n  --sidebar: 210 17% 94%;\n  --sidebar-foreground: 210 17% 18%;\n  --sidebar-border: 210 15% 86%;\n  --sidebar-primary: 217 91% 45%;\n  --sidebar-primary-foreground: 217 91% 98%;\n  --sidebar-accent: 210 16% 88%;\n  --sidebar-accent-foreground: 210 16% 25%;\n  --sidebar-ring: 217 91% 45%;\n  --popover: 210 18% 92%;\n  --popover-foreground: 210 18% 20%;\n  --popover-border: 210 15% 84%;\n  --primary: 217 91% 45%;\n  --primary-foreground: 217 91% 98%;\n  --secondary: 210 16% 86%;\n  --secondary-foreground: 210 16% 22%;\n  --muted: 210 14% 90%;\n  --muted-foreground: 210 14% 35%;\n  --accent: 212 18% 89%;\n  --accent-foreground: 212 18% 28%;\n  --destructive: 0 84% 48%;\n  --destructive-foreground: 0 84% 98%;\n  --input: 210 20% 65%;\n  --ring: 217 91% 45%;\n  --chart-1: 217 91% 42%;\n  --chart-2: 25 95% 48%;\n  --chart-3: 142 76% 36%;\n  --chart-4: 280 65% 48%;\n  --chart-5: 340 82% 52%;\n  --font-sans: Inter, system-ui, -apple-system, sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: 'Roboto Mono', Menlo, monospace;\n  --radius: .5rem;\n  --shadow-2xs: 0px 2px 0px 0px hsl(210 20% 50% / 0.05);\n  --shadow-xs: 0px 2px 0px 0px hsl(210 20% 50% / 0.08);\n  --shadow-sm: 0px 2px 0px 0px hsl(210 20% 50% / 0.05), 0px 1px 2px -1px hsl(210 20% 50% / 0.10);\n  --shadow: 0px 2px 0px 0px hsl(210 20% 50% / 0.05), 0px 1px 2px -1px hsl(210 20% 50% / 0.10);\n  --shadow-md: 0px 2px 0px 0px hsl(210 20% 50% / 0.05), 0px 2px 4px -1px hsl(210 20% 50% / 0.15);\n  --shadow-lg: 0px 2px 0px 0px hsl(210 20% 50% / 0.05), 0px 4px 6px -1px hsl(210 20% 50% / 0.18);\n  --shadow-xl: 0px 2px 0px 0px hsl(210 20% 50% / 0.05), 0px 8px 10px -1px hsl(210 20% 50% / 0.20);\n  --shadow-2xl: 0px 2px 0px 0px hsl(210 20% 50% / 0.08);\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n\n/* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n.dark {\n  --button-outline: rgba(255,255,255, .10);\n  --badge-outline: rgba(255,255,255, .05);\n  --opaque-button-border-intensity: 9;\n  --elevate-1: rgba(255,255,255, .04);\n  --elevate-2: rgba(255,255,255, .09);\n  --background: 210 18% 8%;\n  --foreground: 210 18% 95%;\n  --border: 210 14% 18%;\n  --card: 210 16% 10%;\n  --card-foreground: 210 16% 92%;\n  --card-border: 210 14% 14%;\n  --sidebar: 210 15% 12%;\n  --sidebar-foreground: 210 15% 88%;\n  --sidebar-border: 210 14% 16%;\n  --sidebar-primary: 217 91% 55%;\n  --sidebar-primary-foreground: 217 91% 98%;\n  --sidebar-accent: 210 14% 16%;\n  --sidebar-accent-foreground: 210 14% 85%;\n  --sidebar-ring: 217 91% 55%;\n  --popover: 210 16% 14%;\n  --popover-foreground: 210 16% 90%;\n  --popover-border: 210 14% 20%;\n  --primary: 217 91% 48%;\n  --primary-foreground: 217 91% 98%;\n  --secondary: 210 14% 18%;\n  --secondary-foreground: 210 14% 88%;\n  --muted: 210 12% 16%;\n  --muted-foreground: 210 12% 65%;\n  --accent: 212 15% 15%;\n  --accent-foreground: 212 15% 82%;\n  --destructive: 0 84% 42%;\n  --destructive-foreground: 0 84% 98%;\n  --input: 210 18% 35%;\n  --ring: 217 91% 55%;\n  --chart-1: 217 91% 62%;\n  --chart-2: 25 95% 58%;\n  --chart-3: 142 76% 52%;\n  --chart-4: 280 65% 65%;\n  --chart-5: 340 82% 65%;\n  --shadow-2xs: 0px 2px 0px 0px hsl(210 18% 5% / 0.30);\n  --shadow-xs: 0px 2px 0px 0px hsl(210 18% 5% / 0.35);\n  --shadow-sm: 0px 2px 0px 0px hsl(210 18% 5% / 0.30), 0px 1px 2px -1px hsl(210 18% 5% / 0.40);\n  --shadow: 0px 2px 0px 0px hsl(210 18% 5% / 0.30), 0px 1px 2px -1px hsl(210 18% 5% / 0.40);\n  --shadow-md: 0px 2px 0px 0px hsl(210 18% 5% / 0.30), 0px 2px 4px -1px hsl(210 18% 5% / 0.45);\n  --shadow-lg: 0px 2px 0px 0px hsl(210 18% 5% / 0.30), 0px 4px 6px -1px hsl(210 18% 5% / 0.50);\n  --shadow-xl: 0px 2px 0px 0px hsl(210 18% 5% / 0.30), 0px 8px 10px -1px hsl(210 18% 5% / 0.55);\n  --shadow-2xl: 0px 2px 0px 0px hsl(210 18% 5% / 0.40);\n\n/* Fallback for older browsers */\n  --sidebar-primary-border: hsl(var(--sidebar-primary));\n  --sidebar-primary-border: hsl(from hsl(var(--sidebar-primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --sidebar-accent-border: hsl(var(--sidebar-accent));\n  --sidebar-accent-border: hsl(from hsl(var(--sidebar-accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --primary-border: hsl(var(--primary));\n  --primary-border: hsl(from hsl(var(--primary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --secondary-border: hsl(var(--secondary));\n  --secondary-border: hsl(from hsl(var(--secondary)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --muted-border: hsl(var(--muted));\n  --muted-border: hsl(from hsl(var(--muted)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --accent-border: hsl(var(--accent));\n  --accent-border: hsl(from hsl(var(--accent)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n\n  /* Fallback for older browsers */\n  --destructive-border: hsl(var(--destructive));\n  --destructive-border: hsl(from hsl(var(--destructive)) h s calc(l + var(--opaque-button-border-intensity)) / alpha);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}\n\n/**\n * Using the elevate system.\n * Automatic contrast adjustment.\n *\n * <element className=\"hover-elevate\" />\n * <element className=\"active-elevate-2\" />\n *\n * // Using the tailwind utility when a data attribute is \"on\"\n * <element className=\"toggle-elevate data-[state=on]:toggle-elevated\" />\n * // Or manually controlling the toggle state\n * <element className=\"toggle-elevate toggle-elevated\" />\n *\n * Elevation systems have to handle many states.\n * - not-hovered, vs. hovered vs. active  (three mutually exclusive states)\n * - toggled or not\n * - focused or not (this is not handled with these utilities)\n *\n * Even without handling focused or not, this is six possible combinations that\n * need to be distinguished from eachother visually.\n */\n@layer utilities {\n\n  /* Hide ugly search cancel button in Chrome until we can style it properly */\n  input[type=\"search\"]::-webkit-search-cancel-button {\n    @apply hidden;\n  }\n\n  /* Placeholder styling for contentEditable div */\n  [contenteditable][data-placeholder]:empty::before {\n    content: attr(data-placeholder);\n    color: hsl(var(--muted-foreground));\n    pointer-events: none;\n  }\n\n  /* .no-default-hover-elevate/no-default-active-elevate is an escape hatch so consumers of\n   * buttons/badges can remove the automatic brightness adjustment on interactions\n   * and program their own. */\n  .no-default-hover-elevate {}\n\n  .no-default-active-elevate {}\n\n\n  /**\n   * Toggleable backgrounds go behind the content. Hoverable/active goes on top.\n   * This way they can stack/compound. Both will overlap the parent's borders!\n   * So borders will be automatically adjusted both on toggle, and hover/active,\n   * and they will be compounded.\n   */\n  .toggle-elevate::before,\n  .toggle-elevate-2::before {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: -1;\n    /* sits behind content but above backdrop */\n  }\n\n  .toggle-elevate.toggle-elevated::before {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.toggle-elevate::before {\n    inset: -1px;\n  }\n\n  /* Does not work on elements with overflow:hidden! */\n  .hover-elevate:not(.no-default-hover-elevate),\n  .active-elevate:not(.no-default-active-elevate),\n  .hover-elevate-2:not(.no-default-hover-elevate),\n  .active-elevate-2:not(.no-default-active-elevate) {\n    position: relative;\n    z-index: 0;\n  }\n\n  .hover-elevate:not(.no-default-hover-elevate)::after,\n  .active-elevate:not(.no-default-active-elevate)::after,\n  .hover-elevate-2:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:not(.no-default-active-elevate)::after {\n    content: \"\";\n    pointer-events: none;\n    position: absolute;\n    inset: 0px;\n    /*border-radius: inherit;   match rounded corners */\n    border-radius: inherit;\n    z-index: 999;\n    /* sits in front of content */\n  }\n\n  .hover-elevate:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-1);\n  }\n\n  .hover-elevate-2:hover:not(.no-default-hover-elevate)::after,\n  .active-elevate-2:active:not(.no-default-active-elevate)::after {\n    background-color: var(--elevate-2);\n  }\n\n  /* If there's a 1px border, adjust the inset so that it covers that parent's border */\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate-2:not(.no-hover-interaction-elevate)::after,\n  .border.active-elevate-2:not(.no-active-interaction-elevate)::after,\n  .border.hover-elevate:not(.no-hover-interaction-elevate)::after {\n    inset: -1px;\n  }\n}\n","size_bytes":10800},"server/seed.ts":{"content":"import { drizzle } from \"drizzle-orm/neon-http\";\nimport { neon } from \"@neondatabase/serverless\";\nimport * as schema from \"@shared/schema\";\n\nconst sql = neon(process.env.DATABASE_URL!);\nconst db = drizzle(sql, { schema });\n\nasync function seed() {\n  console.log(\"🌱 Seeding database...\");\n\n  // Create sample organization\n  const [org] = await db.insert(schema.organizations).values({\n    name: \"ACME Construction Corp\",\n    slug: \"acme-construction\",\n  }).returning();\n\n  console.log(\"✓ Created organization:\", org.name);\n\n  // Create sample user (will be replaced by Replit Auth)\n  const [user] = await db.insert(schema.users).values({\n    id: \"demo-user-123\",\n    email: \"demo@example.com\",\n    firstName: \"John\",\n    lastName: \"Demo\",\n  }).returning();\n\n  console.log(\"✓ Created demo user:\", user.email);\n\n  // Link user to organization\n  await db.insert(schema.userOrganizations).values({\n    userId: user.id,\n    organizationId: org.id,\n    role: \"owner\",\n  });\n\n  // Create sample projects\n  const [project1] = await db.insert(schema.projects).values({\n    organizationId: org.id,\n    name: \"Downtown Office Complex\",\n    code: \"PRJ-001\",\n    description: \"15-story mixed-use development in downtown district\",\n    status: \"active\",\n    startDate: new Date(\"2024-01-15\"),\n    endDate: new Date(\"2025-12-31\"),\n    budget: \"45000000\",\n    currency: \"USD\",\n  }).returning();\n\n  const [project2] = await db.insert(schema.projects).values({\n    organizationId: org.id,\n    name: \"Industrial Warehouse Retrofit\",\n    code: \"PRJ-002\",\n    description: \"Modernization of 50,000 sq ft warehouse facility\",\n    status: \"active\",\n    startDate: new Date(\"2024-03-01\"),\n    endDate: new Date(\"2024-11-30\"),\n    budget: \"8500000\",\n    currency: \"USD\",\n  }).returning();\n\n  console.log(\"✓ Created projects:\", project1.name, project2.name);\n\n  // Create WBS tasks for Project 1\n  const tasks = [];\n  \n  // Level 1: Main phases\n  const [phase1] = await db.insert(schema.tasks).values({\n    projectId: project1.id,\n    parentId: null,\n    wbsCode: \"1.0\",\n    name: \"Planning & Design\",\n    description: \"Initial project planning and architectural design\",\n    status: \"completed\",\n    priority: \"high\",\n    progress: 100,\n    startDate: new Date(\"2024-01-15\"),\n    endDate: new Date(\"2024-04-30\"),\n    estimatedHours: \"2400\",\n    actualHours: \"2350\",\n    createdBy: user.id,\n  }).returning();\n\n  const [phase2] = await db.insert(schema.tasks).values({\n    projectId: project1.id,\n    parentId: null,\n    wbsCode: \"2.0\",\n    name: \"Site Preparation\",\n    description: \"Site clearing and foundation work\",\n    status: \"in-progress\",\n    priority: \"critical\",\n    progress: 65,\n    startDate: new Date(\"2024-05-01\"),\n    endDate: new Date(\"2024-08-31\"),\n    estimatedHours: \"3200\",\n    actualHours: \"2100\",\n    createdBy: user.id,\n  }).returning();\n\n  const [phase3] = await db.insert(schema.tasks).values({\n    projectId: project1.id,\n    parentId: null,\n    wbsCode: \"3.0\",\n    name: \"Structural Construction\",\n    description: \"Building core structure and framework\",\n    status: \"not-started\",\n    priority: \"high\",\n    progress: 0,\n    startDate: new Date(\"2024-09-01\"),\n    endDate: new Date(\"2025-06-30\"),\n    estimatedHours: \"8000\",\n    actualHours: \"0\",\n    createdBy: user.id,\n  }).returning();\n\n  // Level 2: Sub-tasks\n  await db.insert(schema.tasks).values([\n    {\n      projectId: project1.id,\n      parentId: phase1.id,\n      wbsCode: \"1.1\",\n      name: \"Architectural Plans\",\n      description: \"Complete architectural design and blueprints\",\n      status: \"completed\",\n      priority: \"high\",\n      progress: 100,\n      startDate: new Date(\"2024-01-15\"),\n      endDate: new Date(\"2024-03-15\"),\n      estimatedHours: \"800\",\n      actualHours: \"780\",\n      createdBy: user.id,\n    },\n    {\n      projectId: project1.id,\n      parentId: phase1.id,\n      wbsCode: \"1.2\",\n      name: \"Engineering Review\",\n      description: \"Structural engineering approval\",\n      status: \"completed\",\n      priority: \"medium\",\n      progress: 100,\n      startDate: new Date(\"2024-03-16\"),\n      endDate: new Date(\"2024-04-30\"),\n      estimatedHours: \"600\",\n      actualHours: \"570\",\n      createdBy: user.id,\n    },\n    {\n      projectId: project1.id,\n      parentId: phase2.id,\n      wbsCode: \"2.1\",\n      name: \"Site Clearing\",\n      description: \"Remove existing structures and debris\",\n      status: \"completed\",\n      priority: \"critical\",\n      progress: 100,\n      startDate: new Date(\"2024-05-01\"),\n      endDate: new Date(\"2024-05-31\"),\n      estimatedHours: \"600\",\n      actualHours: \"620\",\n      createdBy: user.id,\n    },\n    {\n      projectId: project1.id,\n      parentId: phase2.id,\n      wbsCode: \"2.2\",\n      name: \"Foundation Excavation\",\n      description: \"Excavate and prepare foundation\",\n      status: \"in-progress\",\n      priority: \"critical\",\n      progress: 75,\n      startDate: new Date(\"2024-06-01\"),\n      endDate: new Date(\"2024-07-15\"),\n      estimatedHours: \"1200\",\n      actualHours: \"900\",\n      createdBy: user.id,\n    },\n    {\n      projectId: project1.id,\n      parentId: phase2.id,\n      wbsCode: \"2.3\",\n      name: \"Concrete Foundation\",\n      description: \"Pour and cure foundation concrete\",\n      status: \"review\",\n      priority: \"high\",\n      progress: 30,\n      startDate: new Date(\"2024-07-16\"),\n      endDate: new Date(\"2024-08-31\"),\n      estimatedHours: \"1400\",\n      actualHours: \"580\",\n      assignedTo: user.id,\n      createdBy: user.id,\n    },\n  ]);\n\n  console.log(\"✓ Created WBS task hierarchy\");\n\n  // Create task dependencies\n  await db.insert(schema.taskDependencies).values([\n    {\n      projectId: project1.id,\n      predecessorId: phase1.id,\n      successorId: phase2.id,\n      type: \"FS\",\n      lagDays: 0,\n    },\n    {\n      projectId: project1.id,\n      predecessorId: phase2.id,\n      successorId: phase3.id,\n      type: \"FS\",\n      lagDays: 0,\n    },\n  ]);\n\n  console.log(\"✓ Created task dependencies\");\n\n  // Create stakeholders\n  await db.insert(schema.stakeholders).values([\n    {\n      projectId: project1.id,\n      name: \"Sarah Mitchell\",\n      email: \"sarah.mitchell@client.com\",\n      phone: \"+1-555-0101\",\n      organization: \"City Planning Commission\",\n      role: \"sponsor\",\n      influence: 5,\n      interest: 5,\n      notes: \"Primary project sponsor and decision maker\",\n    },\n    {\n      projectId: project1.id,\n      name: \"David Chen\",\n      email: \"david.chen@contractor.com\",\n      phone: \"+1-555-0102\",\n      organization: \"BuildRight Construction\",\n      role: \"contractor\",\n      influence: 4,\n      interest: 5,\n      notes: \"Lead general contractor\",\n    },\n    {\n      projectId: project1.id,\n      name: \"Lisa Thompson\",\n      email: \"lisa.thompson@architect.com\",\n      organization: \"Thompson Architecture\",\n      role: \"consultant\",\n      influence: 3,\n      interest: 4,\n      notes: \"Lead architect\",\n    },\n  ]);\n\n  console.log(\"✓ Created stakeholders\");\n\n  // Create risks\n  await db.insert(schema.risks).values([\n    {\n      projectId: project1.id,\n      code: \"RSK-001\",\n      title: \"Weather Delays\",\n      description: \"Severe weather could delay foundation work during winter months\",\n      category: \"schedule\",\n      status: \"mitigating\",\n      probability: 4,\n      impact: \"high\",\n      mitigationPlan: \"Schedule critical foundation work for summer months, maintain buffer time\",\n      owner: user.id,\n    },\n    {\n      projectId: project1.id,\n      code: \"RSK-002\",\n      title: \"Material Cost Escalation\",\n      description: \"Steel and concrete prices may increase due to supply chain issues\",\n      category: \"financial\",\n      status: \"assessed\",\n      probability: 3,\n      impact: \"medium\",\n      mitigationPlan: \"Lock in pricing with suppliers, explore alternative materials\",\n    },\n  ]);\n\n  console.log(\"✓ Created risks\");\n\n  // Create issues\n  await db.insert(schema.issues).values([\n    {\n      projectId: project1.id,\n      code: \"ISS-001\",\n      title: \"Permit Approval Delay\",\n      description: \"Building permit approval taking longer than expected\",\n      status: \"in-progress\",\n      priority: \"high\",\n      category: \"regulatory\",\n      assignedTo: user.id,\n      reportedBy: user.id,\n      reportedDate: new Date(\"2024-06-15\"),\n    },\n    {\n      projectId: project1.id,\n      code: \"ISS-002\",\n      title: \"Equipment Breakdown\",\n      description: \"Primary excavator requires unexpected repairs\",\n      status: \"resolved\",\n      priority: \"medium\",\n      category: \"technical\",\n      reportedBy: user.id,\n      reportedDate: new Date(\"2024-07-01\"),\n      resolvedDate: new Date(\"2024-07-05\"),\n      resolution: \"Rented replacement equipment, original excavator repaired\",\n    },\n  ]);\n\n  console.log(\"✓ Created issues\");\n\n  // Create cost items\n  await db.insert(schema.costItems).values([\n    {\n      projectId: project1.id,\n      category: \"labor\",\n      description: \"Engineering design team\",\n      budgeted: \"800000\",\n      actual: \"785000\",\n      currency: \"USD\",\n      date: new Date(\"2024-04-30\"),\n    },\n    {\n      projectId: project1.id,\n      category: \"materials\",\n      description: \"Foundation concrete and rebar\",\n      budgeted: \"1200000\",\n      actual: \"950000\",\n      currency: \"USD\",\n      date: new Date(\"2024-08-15\"),\n    },\n    {\n      projectId: project1.id,\n      category: \"equipment\",\n      description: \"Excavation equipment rental\",\n      budgeted: \"150000\",\n      actual: \"165000\",\n      currency: \"USD\",\n      date: new Date(\"2024-07-31\"),\n    },\n    {\n      projectId: project1.id,\n      category: \"overhead\",\n      description: \"Project management and admin\",\n      budgeted: \"500000\",\n      actual: \"325000\",\n      currency: \"USD\",\n      date: new Date(\"2024-08-31\"),\n    },\n  ]);\n\n  console.log(\"✓ Created cost items\");\n\n  console.log(\"🎉 Database seeding completed successfully!\");\n}\n\nseed()\n  .catch((error) => {\n    console.error(\"❌ Error seeding database:\", error);\n    process.exit(1);\n  })\n  .then(() => {\n    process.exit(0);\n  });\n","size_bytes":10008},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","size_bytes":80},"client/src/components/examples/RightSidebar.tsx":{"content":"import { RightSidebar } from '../RightSidebar';\n\nexport default function RightSidebarExample() {\n  return <RightSidebar />;\n}\n","size_bytes":126},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    // h-9 to match icon buttons and default buttons.\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","size_bytes":844},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","size_bytes":756},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","size_bytes":157},"client/src/components/examples/TableRowCard.tsx":{"content":"import { TableRowCard } from '../TableRowCard';\nimport { Badge } from '@/components/ui/badge';\nimport { useState } from 'react';\n\nexport default function TableRowCardExample() {\n  const [selected, setSelected] = useState(false);\n\n  return (\n    <div className=\"p-4\">\n      <TableRowCard\n        id=\"example-1\"\n        selected={selected}\n        onSelect={setSelected}\n        onClick={() => console.log('Clicked')}\n        expandable\n      >\n        <div className=\"flex items-center gap-4\">\n          <Badge variant=\"outline\">WBS-1.0</Badge>\n          <span className=\"font-medium\">Example Task</span>\n          <Badge variant=\"secondary\">In Progress</Badge>\n        </div>\n      </TableRowCard>\n    </div>\n  );\n}\n","size_bytes":716},"client/src/lib/authUtils.ts":{"content":"// Based on blueprint:javascript_log_in_with_replit\nexport function isUnauthorizedError(error: Error): boolean {\n  return /^401: .*Unauthorized/.test(error.message);\n}\n","size_bytes":168},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","size_bytes":1467},"client/src/components/examples/AppSidebar.tsx":{"content":"import { AppSidebar } from '../AppSidebar';\n\nexport default function AppSidebarExample() {\n  return <AppSidebar />;\n}\n","size_bytes":118},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","size_bytes":1139},"client/src/components/examples/RisksPage.tsx":{"content":"import RisksPage from '@/pages/RisksPage';\n\nexport default function RisksPageExample() {\n  return <RisksPage />;\n}\n","size_bytes":115},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","size_bytes":1723},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(`\n      after:content-[''] after:block after:absolute after:inset-0 after:rounded-full after:pointer-events-none after:border after:border-black/10 dark:after:border-white/10\n      relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full`,\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","size_bytes":1592},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"shadcn-card rounded-xl border bg-card border-card-border text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n));\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n));\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n));\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardDescription,\n  CardContent,\n}\n","size_bytes":1904},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","size_bytes":325},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","size_bytes":1883},"client/src/components/AppSidebar.tsx":{"content":"import {\n  LayoutDashboard,\n  ListTree,\n  Users,\n  Grid2X2,\n  Briefcase,\n  AlertTriangle,\n  AlertCircle,\n  FileEdit,\n  DollarSign,\n  FileText,\n  BarChart3,\n  Calendar,\n  Package,\n  Bot,\n  FileDown,\n  Mail,\n  Settings,\n} from \"lucide-react\";\nimport {\n  Sidebar,\n  SidebarContent,\n  SidebarGroup,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarMenu,\n  SidebarMenuButton,\n  SidebarMenuItem,\n} from \"@/components/ui/sidebar\";\nimport { Link, useLocation } from \"wouter\";\n\nconst projectTabs = [\n  { title: \"Overview\", icon: LayoutDashboard, path: \"/\" },\n  { title: \"WBS & Tasks\", icon: ListTree, path: \"/wbs\" },\n  { title: \"Stakeholders\", icon: Users, path: \"/stakeholders\" },\n  { title: \"RACI Matrix\", icon: Grid2X2, path: \"/raci-matrix\" },\n  { title: \"Resources\", icon: Briefcase, path: \"/resources\" },\n  { title: \"Risks\", icon: AlertTriangle, path: \"/risks\" },\n  { title: \"Issues\", icon: AlertCircle, path: \"/issues\" },\n  { title: \"Change Requests\", icon: FileEdit, path: \"/change-requests\" },\n  { title: \"Cost Management\", icon: DollarSign, path: \"/cost\" },\n  { title: \"AI Assistant\", icon: Bot, path: \"/ai-assistant\" },\n  { title: \"Reports\", icon: FileDown, path: \"/reports\" },\n  { title: \"Email Templates\", icon: Mail, path: \"/email-templates\" },\n  { title: \"Documents\", icon: FileText, path: \"/documents\" },\n  { title: \"Analytics\", icon: BarChart3, path: \"/analytics\" },\n  { title: \"Settings\", icon: Settings, path: \"/settings\" },\n];\n\nconst pmoTabs = [\n  { title: \"PMO Dashboard\", icon: LayoutDashboard, path: \"/pmo/dashboard\" },\n  { title: \"Calendar\", icon: Calendar, path: \"/pmo/calendar\" },\n  { title: \"Inventory\", icon: Package, path: \"/pmo/inventory\" },\n];\n\nexport function AppSidebar() {\n  const [location] = useLocation();\n\n  return (\n    <Sidebar data-testid=\"sidebar-main\">\n      <SidebarContent>\n        <SidebarGroup>\n          <SidebarGroupLabel>Project Tabs</SidebarGroupLabel>\n          <SidebarGroupContent>\n            <SidebarMenu>\n              {projectTabs.map((item) => (\n                <SidebarMenuItem key={item.title}>\n                  <SidebarMenuButton asChild isActive={location === item.path} data-testid={`sidebar-link-${item.path.slice(1) || 'overview'}`}>\n                    <Link href={item.path}>\n                      <item.icon />\n                      <span>{item.title}</span>\n                    </Link>\n                  </SidebarMenuButton>\n                </SidebarMenuItem>\n              ))}\n            </SidebarMenu>\n          </SidebarGroupContent>\n        </SidebarGroup>\n\n        <SidebarGroup>\n          <SidebarGroupLabel>PMO Level</SidebarGroupLabel>\n          <SidebarGroupContent>\n            <SidebarMenu>\n              {pmoTabs.map((item) => (\n                <SidebarMenuItem key={item.title}>\n                  <SidebarMenuButton asChild isActive={location === item.path} data-testid={`sidebar-link-pmo-${item.path.split('/').pop()}`}>\n                    <Link href={item.path}>\n                      <item.icon />\n                      <span>{item.title}</span>\n                    </Link>\n                  </SidebarMenuButton>\n                </SidebarMenuItem>\n              ))}\n            </SidebarMenu>\n          </SidebarGroupContent>\n        </SidebarGroup>\n      </SidebarContent>\n    </Sidebar>\n  );\n}\n","size_bytes":3279},"server/storage.ts":{"content":"import { drizzle } from \"drizzle-orm/neon-http\";\nimport { neon } from \"@neondatabase/serverless\";\nimport { eq, and, desc, asc, isNull, inArray } from \"drizzle-orm\";\nimport * as schema from \"@shared/schema\";\nimport type {\n  InsertOrganization,\n  Organization,\n  InsertUser,\n  UpsertUser,\n  User,\n  InsertUserOrganization,\n  UserOrganization,\n  InsertProject,\n  Project,\n  InsertTask,\n  Task,\n  InsertTaskDependency,\n  TaskDependency,\n  InsertStakeholder,\n  Stakeholder,\n  InsertStakeholderRaci,\n  StakeholderRaci,\n  InsertRisk,\n  Risk,\n  InsertIssue,\n  Issue,\n  InsertChangeRequest,\n  ChangeRequest,\n  InsertCostItem,\n  CostItem,\n  InsertResource,\n  Resource,\n  InsertResourceAssignment,\n  ResourceAssignment,\n  InsertGoogleConnection,\n  GoogleConnection,\n  InsertAiConversation,\n  AiConversation,\n  InsertAiMessage,\n  AiMessage,\n  InsertAiUsage,\n  AiUsage,\n  InsertEmailTemplate,\n  EmailTemplate,\n  InsertSentEmail,\n  SentEmail,\n  InsertEmailUsage,\n  EmailUsage,\n  InsertProjectFile,\n  ProjectFile,\n  StorageQuota,\n  InsertCloudStorageConnection,\n  CloudStorageConnection,\n  InsertCloudSyncedFile,\n  CloudSyncedFile,\n  SubscriptionPlan,\n  InsertSubscriptionPlan,\n  OrganizationSubscription,\n  InsertOrganizationSubscription,\n  AiUsageSummary,\n  InsertAiUsageSummary,\n  InsertDocument,\n  Document,\n  InsertProjectEvent,\n  ProjectEvent,\n  InsertTaskDocument,\n  TaskDocument,\n  InsertTaskRisk,\n  TaskRisk,\n  InsertTaskIssue,\n  TaskIssue,\n} from \"@shared/schema\";\n\nconst sql = neon(process.env.DATABASE_URL!);\nconst db = drizzle(sql, { schema });\n\nexport interface IStorage {\n  // Organizations\n  getOrganization(id: number): Promise<Organization | undefined>;\n  getOrganizationBySlug(slug: string): Promise<Organization | undefined>;\n  getOrganizationsByUser(userId: string): Promise<Organization[]>;\n  getAllOrganizations(): Promise<Organization[]>;\n  createOrganization(org: InsertOrganization): Promise<Organization>;\n  updateOrganization(id: number, org: Partial<InsertOrganization>): Promise<Organization | undefined>;\n\n  // Users (Replit Auth compatible)\n  getUser(id: string): Promise<User | undefined>;\n  getUserByEmail(email: string): Promise<User | undefined>;\n  getAllUsers(): Promise<User[]>;\n  getUsersByOrganization(organizationId: number): Promise<User[]>;\n  createUser(user: InsertUser): Promise<User>;\n  updateUser(id: string, user: Partial<InsertUser>): Promise<User | undefined>;\n  upsertUser(user: UpsertUser): Promise<User>;\n  assignDemoOrgToUser(userId: string): Promise<void>;\n\n  // User Organizations\n  getUserOrganization(userId: string, organizationId: number): Promise<UserOrganization | undefined>;\n  getUserOrganizations(userId: string): Promise<UserOrganization[]>;\n  createUserOrganization(userOrg: InsertUserOrganization): Promise<UserOrganization>;\n  deleteUserOrganization(userId: string, organizationId: number): Promise<void>;\n\n  // Projects\n  getProject(id: number): Promise<Project | undefined>;\n  getProjectsByOrganization(organizationId: number): Promise<Project[]>;\n  createProject(project: InsertProject): Promise<Project>;\n  updateProject(id: number, project: Partial<InsertProject>): Promise<Project | undefined>;\n  deleteProject(id: number): Promise<void>;\n\n  // Tasks\n  getTask(id: number): Promise<Task | undefined>;\n  getTasksByProject(projectId: number): Promise<Task[]>;\n  getTasksByParent(projectId: number, parentId: number | null): Promise<Task[]>;\n  createTask(task: InsertTask): Promise<Task>;\n  updateTask(id: number, task: Partial<InsertTask>): Promise<Task | undefined>;\n  deleteTask(id: number): Promise<void>;\n\n  // Task Dependencies\n  getTaskDependency(id: number): Promise<TaskDependency | undefined>;\n  getTaskDependencies(taskId: number): Promise<TaskDependency[]>;\n  getDependenciesByProject(projectId: number): Promise<TaskDependency[]>;\n  createTaskDependency(dependency: InsertTaskDependency): Promise<TaskDependency>;\n  updateTaskDependency(id: number, dependency: Partial<InsertTaskDependency>): Promise<TaskDependency | undefined>;\n  deleteTaskDependency(id: number): Promise<void>;\n\n  // Stakeholders\n  getStakeholder(id: number): Promise<Stakeholder | undefined>;\n  getStakeholdersByProject(projectId: number): Promise<Stakeholder[]>;\n  createStakeholder(stakeholder: InsertStakeholder): Promise<Stakeholder>;\n  updateStakeholder(id: number, stakeholder: Partial<InsertStakeholder>): Promise<Stakeholder | undefined>;\n  deleteStakeholder(id: number): Promise<void>;\n\n  // Stakeholder RACI Matrix\n  getStakeholderRaci(id: number): Promise<StakeholderRaci | undefined>;\n  getStakeholderRaciByProject(projectId: number): Promise<StakeholderRaci[]>;\n  getStakeholderRaciByTask(taskId: number): Promise<StakeholderRaci[]>;\n  getStakeholderRaciByStakeholder(stakeholderId: number): Promise<StakeholderRaci[]>;\n  getStakeholderRaciByResource(resourceId: number): Promise<StakeholderRaci[]>;\n  createStakeholderRaci(raci: InsertStakeholderRaci): Promise<StakeholderRaci>;\n  updateStakeholderRaci(id: number, raci: Partial<InsertStakeholderRaci>): Promise<StakeholderRaci | undefined>;\n  deleteStakeholderRaci(id: number): Promise<void>;\n  deleteStakeholderRaciByTaskAndType(taskId: number, raciType: string, personId: number, isResource: boolean): Promise<void>;\n  deleteInheritedRaciByTask(taskId: number): Promise<void>;\n  getInheritedRaciBySourceTask(sourceTaskId: number): Promise<StakeholderRaci[]>;\n  upsertStakeholderRaci(raci: InsertStakeholderRaci): Promise<StakeholderRaci>;\n\n  // Risks\n  getRisk(id: number): Promise<Risk | undefined>;\n  getRisksByProject(projectId: number): Promise<Risk[]>;\n  createRisk(risk: InsertRisk): Promise<Risk>;\n  updateRisk(id: number, risk: Partial<InsertRisk>): Promise<Risk | undefined>;\n  deleteRisk(id: number): Promise<void>;\n\n  // Issues\n  getIssue(id: number): Promise<Issue | undefined>;\n  getIssuesByProject(projectId: number): Promise<Issue[]>;\n  createIssue(issue: InsertIssue): Promise<Issue>;\n  updateIssue(id: number, issue: Partial<InsertIssue>): Promise<Issue | undefined>;\n  deleteIssue(id: number): Promise<void>;\n\n  // Change Requests\n  getChangeRequest(id: number): Promise<ChangeRequest | undefined>;\n  getChangeRequestsByProject(projectId: number): Promise<ChangeRequest[]>;\n  createChangeRequest(changeRequest: InsertChangeRequest): Promise<ChangeRequest>;\n  updateChangeRequest(id: number, changeRequest: Partial<InsertChangeRequest>): Promise<ChangeRequest | undefined>;\n  deleteChangeRequest(id: number): Promise<void>;\n\n  // Cost Items\n  getCostItem(id: number): Promise<CostItem | undefined>;\n  getCostItemsByProject(projectId: number): Promise<CostItem[]>;\n  getCostItemsByTask(taskId: number): Promise<CostItem[]>;\n  createCostItem(costItem: InsertCostItem): Promise<CostItem>;\n  updateCostItem(id: number, costItem: Partial<InsertCostItem>): Promise<CostItem | undefined>;\n  deleteCostItem(id: number): Promise<void>;\n\n  // Resources\n  getResource(id: number): Promise<Resource | undefined>;\n  getResourcesByProject(projectId: number): Promise<Resource[]>;\n  createResource(resource: InsertResource): Promise<Resource>;\n  updateResource(id: number, resource: Partial<InsertResource>): Promise<Resource | undefined>;\n  deleteResource(id: number): Promise<void>;\n\n  // Resource Assignments\n  getResourceAssignment(id: number): Promise<ResourceAssignment | undefined>;\n  getResourceAssignmentsByTask(taskId: number): Promise<ResourceAssignment[]>;\n  getResourceAssignmentsByResource(resourceId: number): Promise<(ResourceAssignment & { task: Task | null })[]>;\n  getProjectResourceUtilization(projectId: number, startDate: Date, endDate: Date): Promise<{\n    resources: Array<{\n      resourceId: number;\n      resourceName: string;\n      resourceType: string;\n      periods: Array<{\n        periodStart: Date;\n        periodEnd: Date;\n        utilization: number;\n        isOverAllocated: boolean;\n        assignments: Array<{\n          taskId: number;\n          taskName: string;\n          allocation: number;\n        }>;\n      }>;\n    }>;\n  }>;\n  createResourceAssignment(assignment: InsertResourceAssignment): Promise<ResourceAssignment>;\n  deleteResourceAssignment(id: number): Promise<void>;\n\n  // Google Connections\n  getGoogleConnection(userId: string): Promise<GoogleConnection | undefined>;\n  createGoogleConnection(connection: InsertGoogleConnection): Promise<GoogleConnection>;\n  updateGoogleConnection(userId: string, connection: Partial<InsertGoogleConnection>): Promise<GoogleConnection | undefined>;\n  deleteGoogleConnection(userId: string): Promise<void>;\n\n  // AI Conversations\n  getAiConversation(id: number): Promise<AiConversation | undefined>;\n  getAiConversationsByUser(userId: string): Promise<AiConversation[]>;\n  getAiConversationsByProject(projectId: number, userId: string): Promise<AiConversation[]>;\n  createAiConversation(conversation: InsertAiConversation): Promise<AiConversation>;\n  updateAiConversation(id: number, conversation: Partial<InsertAiConversation>): Promise<AiConversation | undefined>;\n  deleteAiConversation(id: number): Promise<void>;\n\n  // AI Messages\n  getAiMessagesByConversation(conversationId: number): Promise<AiMessage[]>;\n  createAiMessage(message: InsertAiMessage): Promise<AiMessage>;\n\n  // AI Usage\n  createAiUsage(usage: InsertAiUsage): Promise<AiUsage>;\n  getAiUsageByUser(userId: string, startDate?: Date): Promise<AiUsage[]>;\n\n  // Email Templates\n  getEmailTemplate(id: number): Promise<EmailTemplate | undefined>;\n  getEmailTemplatesByOrganization(organizationId: number): Promise<EmailTemplate[]>;\n  getEmailTemplateByType(organizationId: number, type: string): Promise<EmailTemplate | undefined>;\n  createEmailTemplate(template: InsertEmailTemplate & { createdBy: string }): Promise<EmailTemplate>;\n  updateEmailTemplate(id: number, template: Partial<InsertEmailTemplate>): Promise<EmailTemplate | undefined>;\n  deleteEmailTemplate(id: number): Promise<void>;\n\n  // Sent Emails\n  createSentEmail(email: InsertSentEmail): Promise<SentEmail>;\n  getSentEmailsByOrganization(organizationId: number, limit?: number): Promise<SentEmail[]>;\n  updateSentEmailStatus(id: number, status: string, errorMessage?: string): Promise<SentEmail | undefined>;\n\n  // Email Usage\n  getEmailUsage(organizationId: number, month: string): Promise<EmailUsage | undefined>;\n  incrementEmailUsage(organizationId: number): Promise<EmailUsage>;\n\n  // Project Files\n  getProjectFile(id: number): Promise<ProjectFile | undefined>;\n  getProjectFilesByProject(projectId: number): Promise<ProjectFile[]>;\n  getProjectFilesByOrganization(organizationId: number): Promise<ProjectFile[]>;\n  createProjectFile(file: InsertProjectFile & { uploadedBy: string }): Promise<ProjectFile>;\n  updateProjectFile(id: number, file: Partial<InsertProjectFile>): Promise<ProjectFile | undefined>;\n  deleteProjectFile(id: number): Promise<void>;\n\n  // Storage Quotas\n  getStorageQuota(organizationId: number): Promise<StorageQuota | undefined>;\n  updateStorageQuota(organizationId: number, usedBytes: number): Promise<StorageQuota>;\n  incrementStorageUsage(organizationId: number, bytes: number): Promise<StorageQuota>;\n  decrementStorageUsage(organizationId: number, bytes: number): Promise<StorageQuota>;\n\n  // Subscription Plans\n  getSubscriptionPlans(): Promise<SubscriptionPlan[]>;\n  getSubscriptionPlan(id: number): Promise<SubscriptionPlan | undefined>;\n  getSubscriptionPlanByTier(tier: string): Promise<SubscriptionPlan | undefined>;\n  createSubscriptionPlan(plan: InsertSubscriptionPlan): Promise<SubscriptionPlan>;\n  updateSubscriptionPlan(id: number, plan: Partial<InsertSubscriptionPlan>): Promise<SubscriptionPlan | undefined>;\n\n  // Organization Subscriptions\n  getOrganizationSubscription(organizationId: number): Promise<OrganizationSubscription | undefined>;\n  createOrganizationSubscription(subscription: InsertOrganizationSubscription): Promise<OrganizationSubscription>;\n  updateOrganizationSubscription(organizationId: number, subscription: Partial<InsertOrganizationSubscription>): Promise<OrganizationSubscription | undefined>;\n\n  // AI Usage Summary\n  getAiUsageSummary(organizationId: number, month: string): Promise<AiUsageSummary | undefined>;\n  incrementAiUsage(organizationId: number, tokensUsed: number): Promise<AiUsageSummary>;\n  \n  // Cloud Storage Connections\n  getCloudStorageConnections(organizationId: number): Promise<CloudStorageConnection[]>;\n  getCloudStorageConnection(id: number): Promise<CloudStorageConnection | undefined>;\n  createCloudStorageConnection(connection: InsertCloudStorageConnection & { connectedBy: string }): Promise<CloudStorageConnection>;\n  updateCloudStorageConnection(id: number, connection: Partial<InsertCloudStorageConnection>): Promise<CloudStorageConnection | undefined>;\n  deleteCloudStorageConnection(id: number): Promise<void>;\n\n  // Documents\n  getDocument(id: number): Promise<Document | undefined>;\n  getDocumentsByProject(projectId: number): Promise<Document[]>;\n  getDocumentsByTask(taskId: number): Promise<Document[]>;\n  createDocument(document: InsertDocument & { createdBy: string }): Promise<Document>;\n  updateDocument(id: number, document: Partial<InsertDocument>): Promise<Document | undefined>;\n  deleteDocument(id: number): Promise<void>;\n\n  // Project Events (Calendar)\n  getProjectEvent(id: number): Promise<ProjectEvent | undefined>;\n  getProjectEventsByProject(projectId: number): Promise<ProjectEvent[]>;\n  createProjectEvent(event: InsertProjectEvent & { createdBy: string }): Promise<ProjectEvent>;\n  updateProjectEvent(id: number, event: Partial<InsertProjectEvent>): Promise<ProjectEvent | undefined>;\n  deleteProjectEvent(id: number): Promise<void>;\n\n  // Task Documents (Junction)\n  getTaskDocuments(taskId: number): Promise<TaskDocument[]>;\n  createTaskDocument(taskDocument: InsertTaskDocument): Promise<TaskDocument>;\n  deleteTaskDocument(taskId: number, documentId: number): Promise<void>;\n\n  // Task Risks (Junction)\n  getTaskRisks(taskId: number): Promise<TaskRisk[]>;\n  createTaskRisk(taskRisk: InsertTaskRisk): Promise<TaskRisk>;\n  deleteTaskRisk(taskId: number, riskId: number): Promise<void>;\n\n  // Task Issues (Junction)\n  getTaskIssues(taskId: number): Promise<TaskIssue[]>;\n  createTaskIssue(taskIssue: InsertTaskIssue): Promise<TaskIssue>;\n  deleteTaskIssue(taskId: number, issueId: number): Promise<void>;\n\n  // Inheritance helpers\n  getTaskAncestors(taskId: number): Promise<Task[]>;\n  getInheritedResources(taskId: number): Promise<{ assignmentId: number; resourceId: number; resource: Resource | null; sourceTaskId: number; sourceTask: Task | null }[]>;\n  getInheritedDocuments(taskId: number): Promise<{ taskDocumentId: number; documentId: number; document: Document | null; sourceTaskId: number; sourceTask: Task | null }[]>;\n  getInheritedRisks(taskId: number): Promise<{ taskRiskId: number; riskId: number; risk: Risk | null; sourceTaskId: number; sourceTask: Task | null }[]>;\n  getInheritedIssues(taskId: number): Promise<{ taskIssueId: number; issueId: number; issue: Issue | null; sourceTaskId: number; sourceTask: Task | null }[]>;\n\n  // Organization-level aggregation (PMO)\n  getTasksByOrganization(organizationId: number): Promise<(Task & { projectName: string })[]>;\n  getRisksByOrganization(organizationId: number): Promise<(Risk & { projectName: string })[]>;\n  getIssuesByOrganization(organizationId: number): Promise<(Issue & { projectName: string })[]>;\n  getResourcesByOrganization(organizationId: number): Promise<(Resource & { projectName: string })[]>;\n  getCostItemsByOrganization(organizationId: number): Promise<(CostItem & { projectName: string })[]>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  // Organizations\n  async getOrganization(id: number): Promise<Organization | undefined> {\n    const [org] = await db.select().from(schema.organizations).where(eq(schema.organizations.id, id));\n    return org;\n  }\n\n  async getOrganizationBySlug(slug: string): Promise<Organization | undefined> {\n    const [org] = await db.select().from(schema.organizations).where(eq(schema.organizations.slug, slug));\n    return org;\n  }\n\n  async getOrganizationsByUser(userId: string): Promise<Organization[]> {\n    const userOrgs = await db.select().from(schema.userOrganizations)\n      .where(eq(schema.userOrganizations.userId, userId));\n    \n    const orgIds = userOrgs.map(uo => uo.organizationId);\n    if (orgIds.length === 0) return [];\n\n    return await db.select().from(schema.organizations)\n      .where(inArray(schema.organizations.id, orgIds));\n  }\n\n  async getAllOrganizations(): Promise<Organization[]> {\n    return await db.select().from(schema.organizations);\n  }\n\n  async createOrganization(org: InsertOrganization): Promise<Organization> {\n    const [created] = await db.insert(schema.organizations).values(org).returning();\n    return created;\n  }\n\n  async updateOrganization(id: number, org: Partial<InsertOrganization>): Promise<Organization | undefined> {\n    const [updated] = await db.update(schema.organizations)\n      .set({ ...org, updatedAt: new Date() })\n      .where(eq(schema.organizations.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Users\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(schema.users).where(eq(schema.users.id, id));\n    return user;\n  }\n\n  async getUserByEmail(email: string): Promise<User | undefined> {\n    const [user] = await db.select().from(schema.users).where(eq(schema.users.email, email));\n    return user;\n  }\n\n  async getAllUsers(): Promise<User[]> {\n    return await db.select().from(schema.users);\n  }\n\n  async getUsersByOrganization(organizationId: number): Promise<User[]> {\n    const userOrgs = await db.select().from(schema.userOrganizations)\n      .where(eq(schema.userOrganizations.organizationId, organizationId));\n    \n    const userIds = userOrgs.map(uo => uo.userId);\n    if (userIds.length === 0) return [];\n\n    return await db.select().from(schema.users)\n      .where(inArray(schema.users.id, userIds));\n  }\n\n  async createUser(user: InsertUser): Promise<User> {\n    const [created] = await db.insert(schema.users).values(user).returning();\n    return created;\n  }\n\n  async updateUser(id: string, user: Partial<InsertUser>): Promise<User | undefined> {\n    const [updated] = await db.update(schema.users)\n      .set({ ...user, updatedAt: new Date() })\n      .where(eq(schema.users.id, id))\n      .returning();\n    return updated;\n  }\n\n  async upsertUser(userData: UpsertUser): Promise<User> {\n    const [user] = await db\n      .insert(schema.users)\n      .values(userData)\n      .onConflictDoUpdate({\n        target: schema.users.id,\n        set: {\n          ...userData,\n          updatedAt: new Date(),\n        },\n      })\n      .returning();\n    return user;\n  }\n\n  async assignDemoOrgToUser(userId: string): Promise<void> {\n    const DEMO_ORG_SLUG = \"demo-solar-project\";\n    \n    const demoOrg = await this.getOrganizationBySlug(DEMO_ORG_SLUG);\n    if (!demoOrg) {\n      console.log(\"Demo organization not found, skipping auto-assignment\");\n      return;\n    }\n\n    const existingAssignment = await this.getUserOrganization(userId, demoOrg.id);\n    if (existingAssignment) {\n      return;\n    }\n\n    await db.insert(schema.userOrganizations).values({\n      userId,\n      organizationId: demoOrg.id,\n      role: \"viewer\",\n    });\n    console.log(`Assigned user ${userId} to demo organization as viewer`);\n  }\n\n  // User Organizations\n  async getUserOrganization(userId: string, organizationId: number): Promise<UserOrganization | undefined> {\n    const [userOrg] = await db.select().from(schema.userOrganizations)\n      .where(and(\n        eq(schema.userOrganizations.userId, userId),\n        eq(schema.userOrganizations.organizationId, organizationId)\n      ));\n    return userOrg;\n  }\n\n  async getUserOrganizations(userId: string): Promise<UserOrganization[]> {\n    return await db.select().from(schema.userOrganizations)\n      .where(eq(schema.userOrganizations.userId, userId));\n  }\n\n  async createUserOrganization(userOrg: InsertUserOrganization): Promise<UserOrganization> {\n    const [created] = await db.insert(schema.userOrganizations).values(userOrg).returning();\n    return created;\n  }\n\n  async deleteUserOrganization(userId: string, organizationId: number): Promise<void> {\n    await db.delete(schema.userOrganizations)\n      .where(and(\n        eq(schema.userOrganizations.userId, userId),\n        eq(schema.userOrganizations.organizationId, organizationId)\n      ));\n  }\n\n  // Projects\n  async getProject(id: number): Promise<Project | undefined> {\n    const [project] = await db.select().from(schema.projects).where(eq(schema.projects.id, id));\n    return project;\n  }\n\n  async getProjectsByOrganization(organizationId: number): Promise<Project[]> {\n    return await db.select().from(schema.projects)\n      .where(eq(schema.projects.organizationId, organizationId))\n      .orderBy(desc(schema.projects.createdAt));\n  }\n\n  async createProject(project: InsertProject): Promise<Project> {\n    const [created] = await db.insert(schema.projects).values(project).returning();\n    return created;\n  }\n\n  async updateProject(id: number, project: Partial<InsertProject>): Promise<Project | undefined> {\n    const [updated] = await db.update(schema.projects)\n      .set({ ...project, updatedAt: new Date() })\n      .where(eq(schema.projects.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteProject(id: number): Promise<void> {\n    await db.delete(schema.projects).where(eq(schema.projects.id, id));\n  }\n\n  // Tasks\n  async getTask(id: number): Promise<Task | undefined> {\n    const [task] = await db.select().from(schema.tasks).where(eq(schema.tasks.id, id));\n    return task;\n  }\n\n  async getTasksByProject(projectId: number): Promise<Task[]> {\n    return await db.select().from(schema.tasks)\n      .where(eq(schema.tasks.projectId, projectId))\n      .orderBy(asc(schema.tasks.wbsCode));\n  }\n\n  async getTasksByParent(projectId: number, parentId: number | null): Promise<Task[]> {\n    if (parentId === null) {\n      return await db.select().from(schema.tasks)\n        .where(and(\n          eq(schema.tasks.projectId, projectId),\n          isNull(schema.tasks.parentId)\n        ))\n        .orderBy(asc(schema.tasks.wbsCode));\n    }\n    return await db.select().from(schema.tasks)\n      .where(and(\n        eq(schema.tasks.projectId, projectId),\n        eq(schema.tasks.parentId, parentId)\n      ))\n      .orderBy(asc(schema.tasks.wbsCode));\n  }\n\n  async createTask(task: InsertTask): Promise<Task> {\n    const [created] = await db.insert(schema.tasks).values(task).returning();\n    return created;\n  }\n\n  async updateTask(id: number, task: Partial<InsertTask>): Promise<Task | undefined> {\n    const [updated] = await db.update(schema.tasks)\n      .set({ ...task, updatedAt: new Date() })\n      .where(eq(schema.tasks.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteTask(id: number): Promise<void> {\n    await db.delete(schema.tasks).where(eq(schema.tasks.id, id));\n  }\n\n  // Task Dependencies\n  async getTaskDependency(id: number): Promise<TaskDependency | undefined> {\n    const [dep] = await db.select().from(schema.taskDependencies)\n      .where(eq(schema.taskDependencies.id, id));\n    return dep;\n  }\n\n  async getTaskDependencies(taskId: number): Promise<TaskDependency[]> {\n    return await db.select().from(schema.taskDependencies)\n      .where(eq(schema.taskDependencies.successorId, taskId));\n  }\n\n  async getDependenciesByProject(projectId: number): Promise<TaskDependency[]> {\n    return await db.select().from(schema.taskDependencies)\n      .where(eq(schema.taskDependencies.projectId, projectId));\n  }\n\n  async createTaskDependency(dependency: InsertTaskDependency): Promise<TaskDependency> {\n    const [created] = await db.insert(schema.taskDependencies).values(dependency).returning();\n    return created;\n  }\n\n  async updateTaskDependency(id: number, dependency: Partial<InsertTaskDependency>): Promise<TaskDependency | undefined> {\n    const [updated] = await db.update(schema.taskDependencies)\n      .set(dependency)\n      .where(eq(schema.taskDependencies.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteTaskDependency(id: number): Promise<void> {\n    await db.delete(schema.taskDependencies).where(eq(schema.taskDependencies.id, id));\n  }\n\n  // Stakeholders\n  async getStakeholder(id: number): Promise<Stakeholder | undefined> {\n    const [stakeholder] = await db.select().from(schema.stakeholders)\n      .where(eq(schema.stakeholders.id, id));\n    return stakeholder;\n  }\n\n  async getStakeholdersByProject(projectId: number): Promise<Stakeholder[]> {\n    return await db.select().from(schema.stakeholders)\n      .where(eq(schema.stakeholders.projectId, projectId))\n      .orderBy(desc(schema.stakeholders.createdAt));\n  }\n\n  async createStakeholder(stakeholder: InsertStakeholder): Promise<Stakeholder> {\n    const [created] = await db.insert(schema.stakeholders).values(stakeholder).returning();\n    return created;\n  }\n\n  async updateStakeholder(id: number, stakeholder: Partial<InsertStakeholder>): Promise<Stakeholder | undefined> {\n    const [updated] = await db.update(schema.stakeholders)\n      .set({ ...stakeholder, updatedAt: new Date() })\n      .where(eq(schema.stakeholders.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteStakeholder(id: number): Promise<void> {\n    await db.delete(schema.stakeholders).where(eq(schema.stakeholders.id, id));\n  }\n\n  // Stakeholder RACI Matrix\n  async getStakeholderRaci(id: number): Promise<StakeholderRaci | undefined> {\n    const [raci] = await db.select().from(schema.stakeholderRaci)\n      .where(eq(schema.stakeholderRaci.id, id));\n    return raci;\n  }\n\n  async getStakeholderRaciByProject(projectId: number): Promise<StakeholderRaci[]> {\n    return await db.select().from(schema.stakeholderRaci)\n      .where(eq(schema.stakeholderRaci.projectId, projectId))\n      .orderBy(desc(schema.stakeholderRaci.createdAt));\n  }\n\n  async getStakeholderRaciByTask(taskId: number): Promise<StakeholderRaci[]> {\n    return await db.select().from(schema.stakeholderRaci)\n      .where(eq(schema.stakeholderRaci.taskId, taskId));\n  }\n\n  async getStakeholderRaciByStakeholder(stakeholderId: number): Promise<StakeholderRaci[]> {\n    return await db.select().from(schema.stakeholderRaci)\n      .where(eq(schema.stakeholderRaci.stakeholderId, stakeholderId));\n  }\n\n  async createStakeholderRaci(raci: InsertStakeholderRaci): Promise<StakeholderRaci> {\n    const [created] = await db.insert(schema.stakeholderRaci).values(raci).returning();\n    return created;\n  }\n\n  async updateStakeholderRaci(id: number, raci: Partial<InsertStakeholderRaci>): Promise<StakeholderRaci | undefined> {\n    const [updated] = await db.update(schema.stakeholderRaci)\n      .set({ ...raci, updatedAt: new Date() })\n      .where(eq(schema.stakeholderRaci.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteStakeholderRaci(id: number): Promise<void> {\n    await db.delete(schema.stakeholderRaci).where(eq(schema.stakeholderRaci.id, id));\n  }\n\n  async upsertStakeholderRaci(raci: InsertStakeholderRaci): Promise<StakeholderRaci> {\n    // Build query based on whether it's a stakeholder or resource assignment\n    // New unique constraint is (stakeholder/resource, task, raciType)\n    let existing: StakeholderRaci | undefined;\n    \n    if (raci.stakeholderId) {\n      const [found] = await db.select().from(schema.stakeholderRaci)\n        .where(and(\n          eq(schema.stakeholderRaci.stakeholderId, raci.stakeholderId),\n          eq(schema.stakeholderRaci.taskId, raci.taskId),\n          eq(schema.stakeholderRaci.raciType, raci.raciType)\n        ));\n      existing = found;\n    } else if (raci.resourceId) {\n      const [found] = await db.select().from(schema.stakeholderRaci)\n        .where(and(\n          eq(schema.stakeholderRaci.resourceId, raci.resourceId),\n          eq(schema.stakeholderRaci.taskId, raci.taskId),\n          eq(schema.stakeholderRaci.raciType, raci.raciType)\n        ));\n      existing = found;\n    }\n    \n    if (existing) {\n      // Update existing record\n      const [updated] = await db.update(schema.stakeholderRaci)\n        .set({ ...raci, updatedAt: new Date() })\n        .where(eq(schema.stakeholderRaci.id, existing.id))\n        .returning();\n      return updated;\n    } else {\n      // Create new record\n      const [created] = await db.insert(schema.stakeholderRaci).values(raci).returning();\n      return created;\n    }\n  }\n\n  async getStakeholderRaciByResource(resourceId: number): Promise<StakeholderRaci[]> {\n    return await db.select().from(schema.stakeholderRaci)\n      .where(eq(schema.stakeholderRaci.resourceId, resourceId));\n  }\n\n  async deleteStakeholderRaciByTaskAndType(taskId: number, raciType: string, personId: number, isResource: boolean): Promise<void> {\n    if (isResource) {\n      await db.delete(schema.stakeholderRaci)\n        .where(and(\n          eq(schema.stakeholderRaci.taskId, taskId),\n          eq(schema.stakeholderRaci.raciType, raciType as any),\n          eq(schema.stakeholderRaci.resourceId, personId)\n        ));\n    } else {\n      await db.delete(schema.stakeholderRaci)\n        .where(and(\n          eq(schema.stakeholderRaci.taskId, taskId),\n          eq(schema.stakeholderRaci.raciType, raciType as any),\n          eq(schema.stakeholderRaci.stakeholderId, personId)\n        ));\n    }\n  }\n\n  async deleteInheritedRaciByTask(taskId: number): Promise<void> {\n    await db.delete(schema.stakeholderRaci)\n      .where(and(\n        eq(schema.stakeholderRaci.taskId, taskId),\n        eq(schema.stakeholderRaci.isInherited, true)\n      ));\n  }\n\n  async getInheritedRaciBySourceTask(sourceTaskId: number): Promise<StakeholderRaci[]> {\n    return await db.select().from(schema.stakeholderRaci)\n      .where(eq(schema.stakeholderRaci.inheritedFromTaskId, sourceTaskId));\n  }\n\n  async getTaskDescendants(taskId: number): Promise<Task[]> {\n    const allTasks = await this.getTasksByProject((await this.getTask(taskId))?.projectId || 0);\n    const descendants: Task[] = [];\n    const collectDescendants = (parentId: number) => {\n      const children = allTasks.filter(t => t.parentId === parentId);\n      for (const child of children) {\n        descendants.push(child);\n        collectDescendants(child.id);\n      }\n    };\n    collectDescendants(taskId);\n    return descendants;\n  }\n\n  async propagateRaciToDescendants(\n    sourceTaskId: number, \n    raciType: string,\n    stakeholderId: number | null,\n    resourceId: number | null,\n    projectId: number\n  ): Promise<void> {\n    const descendants = await this.getTaskDescendants(sourceTaskId);\n    \n    for (const descendant of descendants) {\n      const existingExplicit = await db.select().from(schema.stakeholderRaci)\n        .where(and(\n          eq(schema.stakeholderRaci.taskId, descendant.id),\n          eq(schema.stakeholderRaci.raciType, raciType as any),\n          eq(schema.stakeholderRaci.isInherited, false),\n          stakeholderId ? eq(schema.stakeholderRaci.stakeholderId, stakeholderId) : isNull(schema.stakeholderRaci.stakeholderId),\n          resourceId ? eq(schema.stakeholderRaci.resourceId, resourceId) : isNull(schema.stakeholderRaci.resourceId)\n        ));\n      \n      if (existingExplicit.length === 0) {\n        const existingInherited = await db.select().from(schema.stakeholderRaci)\n          .where(and(\n            eq(schema.stakeholderRaci.taskId, descendant.id),\n            eq(schema.stakeholderRaci.raciType, raciType as any),\n            eq(schema.stakeholderRaci.isInherited, true),\n            stakeholderId ? eq(schema.stakeholderRaci.stakeholderId, stakeholderId) : isNull(schema.stakeholderRaci.stakeholderId),\n            resourceId ? eq(schema.stakeholderRaci.resourceId, resourceId) : isNull(schema.stakeholderRaci.resourceId)\n          ));\n        \n        if (existingInherited.length === 0) {\n          await db.insert(schema.stakeholderRaci).values({\n            projectId,\n            taskId: descendant.id,\n            stakeholderId,\n            resourceId,\n            raciType: raciType as any,\n            isInherited: true,\n            inheritedFromTaskId: sourceTaskId,\n          });\n        }\n      }\n    }\n  }\n\n  async removeInheritedRaciFromDescendants(\n    sourceTaskId: number,\n    raciType: string,\n    stakeholderId: number | null,\n    resourceId: number | null\n  ): Promise<void> {\n    const descendants = await this.getTaskDescendants(sourceTaskId);\n    \n    for (const descendant of descendants) {\n      await db.delete(schema.stakeholderRaci)\n        .where(and(\n          eq(schema.stakeholderRaci.taskId, descendant.id),\n          eq(schema.stakeholderRaci.raciType, raciType as any),\n          eq(schema.stakeholderRaci.inheritedFromTaskId, sourceTaskId),\n          stakeholderId ? eq(schema.stakeholderRaci.stakeholderId, stakeholderId) : isNull(schema.stakeholderRaci.stakeholderId),\n          resourceId ? eq(schema.stakeholderRaci.resourceId, resourceId) : isNull(schema.stakeholderRaci.resourceId)\n        ));\n    }\n  }\n\n  async resetRaciToInherited(taskId: number, raciType: string): Promise<void> {\n    await db.delete(schema.stakeholderRaci)\n      .where(and(\n        eq(schema.stakeholderRaci.taskId, taskId),\n        eq(schema.stakeholderRaci.raciType, raciType as any),\n        eq(schema.stakeholderRaci.isInherited, false)\n      ));\n    \n    const task = await this.getTask(taskId);\n    if (!task || !task.parentId) return;\n    \n    const parentRaci = await db.select().from(schema.stakeholderRaci)\n      .where(and(\n        eq(schema.stakeholderRaci.taskId, task.parentId),\n        eq(schema.stakeholderRaci.raciType, raciType as any)\n      ));\n    \n    for (const parent of parentRaci) {\n      await db.insert(schema.stakeholderRaci).values({\n        projectId: task.projectId,\n        taskId,\n        stakeholderId: parent.stakeholderId,\n        resourceId: parent.resourceId,\n        raciType: raciType as any,\n        isInherited: true,\n        inheritedFromTaskId: task.parentId,\n      });\n    }\n  }\n\n  async hasExplicitRaciOverride(taskId: number, raciType: string): Promise<boolean> {\n    const explicit = await db.select().from(schema.stakeholderRaci)\n      .where(and(\n        eq(schema.stakeholderRaci.taskId, taskId),\n        eq(schema.stakeholderRaci.raciType, raciType as any),\n        eq(schema.stakeholderRaci.isInherited, false)\n      ));\n    return explicit.length > 0;\n  }\n\n  // Risks\n  async getRisk(id: number): Promise<Risk | undefined> {\n    const [risk] = await db.select().from(schema.risks).where(eq(schema.risks.id, id));\n    return risk;\n  }\n\n  async getRisksByProject(projectId: number): Promise<Risk[]> {\n    return await db.select().from(schema.risks)\n      .where(eq(schema.risks.projectId, projectId))\n      .orderBy(desc(schema.risks.createdAt));\n  }\n\n  async createRisk(risk: InsertRisk): Promise<Risk> {\n    const [created] = await db.insert(schema.risks).values(risk).returning();\n    return created;\n  }\n\n  async updateRisk(id: number, risk: Partial<InsertRisk>): Promise<Risk | undefined> {\n    const [updated] = await db.update(schema.risks)\n      .set({ ...risk, updatedAt: new Date() })\n      .where(eq(schema.risks.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteRisk(id: number): Promise<void> {\n    await db.delete(schema.risks).where(eq(schema.risks.id, id));\n  }\n\n  // Issues\n  async getIssue(id: number): Promise<Issue | undefined> {\n    const [issue] = await db.select().from(schema.issues).where(eq(schema.issues.id, id));\n    return issue;\n  }\n\n  async getIssuesByProject(projectId: number): Promise<Issue[]> {\n    return await db.select().from(schema.issues)\n      .where(eq(schema.issues.projectId, projectId))\n      .orderBy(desc(schema.issues.createdAt));\n  }\n\n  async createIssue(issue: InsertIssue): Promise<Issue> {\n    const [created] = await db.insert(schema.issues).values(issue).returning();\n    return created;\n  }\n\n  async updateIssue(id: number, issue: Partial<InsertIssue>): Promise<Issue | undefined> {\n    const [updated] = await db.update(schema.issues)\n      .set({ ...issue, updatedAt: new Date() })\n      .where(eq(schema.issues.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteIssue(id: number): Promise<void> {\n    await db.delete(schema.issues).where(eq(schema.issues.id, id));\n  }\n\n  // Change Requests\n  async getChangeRequest(id: number): Promise<ChangeRequest | undefined> {\n    const [cr] = await db.select().from(schema.changeRequests)\n      .where(eq(schema.changeRequests.id, id));\n    return cr;\n  }\n\n  async getChangeRequestsByProject(projectId: number): Promise<ChangeRequest[]> {\n    return await db.select().from(schema.changeRequests)\n      .where(eq(schema.changeRequests.projectId, projectId))\n      .orderBy(desc(schema.changeRequests.createdAt));\n  }\n\n  async createChangeRequest(changeRequest: InsertChangeRequest): Promise<ChangeRequest> {\n    const [created] = await db.insert(schema.changeRequests).values(changeRequest).returning();\n    return created;\n  }\n\n  async updateChangeRequest(id: number, changeRequest: Partial<InsertChangeRequest>): Promise<ChangeRequest | undefined> {\n    const [updated] = await db.update(schema.changeRequests)\n      .set({ ...changeRequest, updatedAt: new Date() })\n      .where(eq(schema.changeRequests.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteChangeRequest(id: number): Promise<void> {\n    await db.delete(schema.changeRequests).where(eq(schema.changeRequests.id, id));\n  }\n\n  // Cost Items\n  async getCostItem(id: number): Promise<CostItem | undefined> {\n    const [item] = await db.select().from(schema.costItems).where(eq(schema.costItems.id, id));\n    return item;\n  }\n\n  async getCostItemsByProject(projectId: number): Promise<CostItem[]> {\n    return await db.select().from(schema.costItems)\n      .where(eq(schema.costItems.projectId, projectId))\n      .orderBy(desc(schema.costItems.date));\n  }\n\n  async getCostItemsByTask(taskId: number): Promise<CostItem[]> {\n    return await db.select().from(schema.costItems)\n      .where(eq(schema.costItems.taskId, taskId))\n      .orderBy(desc(schema.costItems.date));\n  }\n\n  async createCostItem(costItem: InsertCostItem): Promise<CostItem> {\n    const [created] = await db.insert(schema.costItems).values(costItem).returning();\n    return created;\n  }\n\n  async updateCostItem(id: number, costItem: Partial<InsertCostItem>): Promise<CostItem | undefined> {\n    const [updated] = await db.update(schema.costItems)\n      .set({ ...costItem, updatedAt: new Date() })\n      .where(eq(schema.costItems.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteCostItem(id: number): Promise<void> {\n    await db.delete(schema.costItems).where(eq(schema.costItems.id, id));\n  }\n\n  // Resources\n  async getResource(id: number): Promise<Resource | undefined> {\n    const [resource] = await db.select().from(schema.resources).where(eq(schema.resources.id, id));\n    return resource;\n  }\n\n  async getResourcesByProject(projectId: number): Promise<Resource[]> {\n    return await db.select().from(schema.resources)\n      .where(eq(schema.resources.projectId, projectId))\n      .orderBy(desc(schema.resources.createdAt));\n  }\n\n  async createResource(resource: InsertResource): Promise<Resource> {\n    const [created] = await db.insert(schema.resources).values(resource).returning();\n    return created;\n  }\n\n  async updateResource(id: number, resource: Partial<InsertResource>): Promise<Resource | undefined> {\n    const [updated] = await db.update(schema.resources)\n      .set({ ...resource, updatedAt: new Date() })\n      .where(eq(schema.resources.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteResource(id: number): Promise<void> {\n    await db.delete(schema.resources).where(eq(schema.resources.id, id));\n  }\n\n  // Resource Assignments\n  async getResourceAssignment(id: number): Promise<ResourceAssignment | undefined> {\n    const [assignment] = await db.select().from(schema.resourceAssignments)\n      .where(eq(schema.resourceAssignments.id, id));\n    return assignment;\n  }\n\n  async getResourceAssignmentsByTask(taskId: number): Promise<ResourceAssignment[]> {\n    return await db.select().from(schema.resourceAssignments)\n      .where(eq(schema.resourceAssignments.taskId, taskId));\n  }\n\n  async getResourceAssignmentsByResource(resourceId: number): Promise<(ResourceAssignment & { task: Task | null })[]> {\n    const assignments = await db.select().from(schema.resourceAssignments)\n      .where(eq(schema.resourceAssignments.resourceId, resourceId));\n    \n    const result: (ResourceAssignment & { task: Task | null })[] = [];\n    for (const assignment of assignments) {\n      const task = await this.getTask(assignment.taskId);\n      result.push({ ...assignment, task: task || null });\n    }\n    return result;\n  }\n\n  async getProjectResourceUtilization(projectId: number, startDate: Date, endDate: Date): Promise<{\n    resources: Array<{\n      resourceId: number;\n      resourceName: string;\n      resourceType: string;\n      periods: Array<{\n        periodStart: Date;\n        periodEnd: Date;\n        utilization: number;\n        isOverAllocated: boolean;\n        assignments: Array<{\n          taskId: number;\n          taskName: string;\n          allocation: number;\n        }>;\n      }>;\n    }>;\n  }> {\n    const resources = await this.getResourcesByProject(projectId);\n    const tasks = await this.getTasksByProject(projectId);\n    const tasksMap = new Map(tasks.map(t => [t.id, t]));\n    \n    const weekMs = 7 * 24 * 60 * 60 * 1000;\n    const periods: Array<{ start: Date; end: Date }> = [];\n    \n    let currentStart = new Date(startDate);\n    currentStart.setHours(0, 0, 0, 0);\n    while (currentStart < endDate) {\n      const periodEnd = new Date(Math.min(currentStart.getTime() + weekMs, endDate.getTime()));\n      periods.push({ start: new Date(currentStart), end: periodEnd });\n      currentStart = new Date(periodEnd);\n    }\n    \n    const result: Array<{\n      resourceId: number;\n      resourceName: string;\n      resourceType: string;\n      periods: Array<{\n        periodStart: Date;\n        periodEnd: Date;\n        utilization: number;\n        isOverAllocated: boolean;\n        assignments: Array<{\n          taskId: number;\n          taskName: string;\n          allocation: number;\n        }>;\n      }>;\n    }> = [];\n    \n    for (const resource of resources) {\n      const assignments = await db.select().from(schema.resourceAssignments)\n        .where(eq(schema.resourceAssignments.resourceId, resource.id));\n      \n      const resourcePeriods: Array<{\n        periodStart: Date;\n        periodEnd: Date;\n        utilization: number;\n        isOverAllocated: boolean;\n        assignments: Array<{\n          taskId: number;\n          taskName: string;\n          allocation: number;\n        }>;\n      }> = [];\n      \n      for (const period of periods) {\n        let totalWeightedAllocation = 0;\n        const periodAssignments: Array<{ taskId: number; taskName: string; allocation: number }> = [];\n        \n        const periodDays = Math.max(1, Math.ceil((period.end.getTime() - period.start.getTime()) / (24 * 60 * 60 * 1000)));\n        \n        for (const assignment of assignments) {\n          const task = tasksMap.get(assignment.taskId);\n          if (!task || !task.startDate || !task.endDate) continue;\n          \n          const taskStart = new Date(task.startDate);\n          const taskEnd = new Date(task.endDate);\n          \n          if (taskStart <= period.end && taskEnd >= period.start) {\n            const overlapStart = new Date(Math.max(taskStart.getTime(), period.start.getTime()));\n            const overlapEnd = new Date(Math.min(taskEnd.getTime(), period.end.getTime()));\n            const overlapDays = Math.max(1, Math.ceil((overlapEnd.getTime() - overlapStart.getTime()) / (24 * 60 * 60 * 1000)));\n            \n            const weightedAllocation = (assignment.allocation * overlapDays) / periodDays;\n            totalWeightedAllocation += weightedAllocation;\n            \n            periodAssignments.push({\n              taskId: task.id,\n              taskName: task.name,\n              allocation: Math.round(weightedAllocation),\n            });\n          }\n        }\n        \n        const finalUtilization = Math.round(totalWeightedAllocation);\n        resourcePeriods.push({\n          periodStart: period.start,\n          periodEnd: period.end,\n          utilization: finalUtilization,\n          isOverAllocated: finalUtilization > 100,\n          assignments: periodAssignments,\n        });\n      }\n      \n      result.push({\n        resourceId: resource.id,\n        resourceName: resource.name,\n        resourceType: resource.type,\n        periods: resourcePeriods,\n      });\n    }\n    \n    return { resources: result };\n  }\n\n  async createResourceAssignment(assignment: InsertResourceAssignment): Promise<ResourceAssignment> {\n    const [created] = await db.insert(schema.resourceAssignments).values(assignment).returning();\n    return created;\n  }\n\n  async deleteResourceAssignment(id: number): Promise<void> {\n    await db.delete(schema.resourceAssignments).where(eq(schema.resourceAssignments.id, id));\n  }\n\n  // Google Connections\n  async getGoogleConnection(userId: string): Promise<GoogleConnection | undefined> {\n    const [connection] = await db.select().from(schema.googleConnections)\n      .where(eq(schema.googleConnections.userId, userId));\n    return connection;\n  }\n\n  async createGoogleConnection(connection: InsertGoogleConnection): Promise<GoogleConnection> {\n    const [created] = await db.insert(schema.googleConnections).values(connection).returning();\n    return created;\n  }\n\n  async updateGoogleConnection(userId: string, connection: Partial<InsertGoogleConnection>): Promise<GoogleConnection | undefined> {\n    const [updated] = await db.update(schema.googleConnections)\n      .set({ ...connection, updatedAt: new Date() })\n      .where(eq(schema.googleConnections.userId, userId))\n      .returning();\n    return updated;\n  }\n\n  async deleteGoogleConnection(userId: string): Promise<void> {\n    await db.delete(schema.googleConnections).where(eq(schema.googleConnections.userId, userId));\n  }\n\n  // AI Conversations\n  async getAiConversation(id: number): Promise<AiConversation | undefined> {\n    const [conversation] = await db.select().from(schema.aiConversations)\n      .where(eq(schema.aiConversations.id, id));\n    return conversation;\n  }\n\n  async getAiConversationsByUser(userId: string): Promise<AiConversation[]> {\n    return await db.select().from(schema.aiConversations)\n      .where(eq(schema.aiConversations.userId, userId))\n      .orderBy(desc(schema.aiConversations.updatedAt));\n  }\n\n  async getAiConversationsByProject(projectId: number, userId: string): Promise<AiConversation[]> {\n    return await db.select().from(schema.aiConversations)\n      .where(and(\n        eq(schema.aiConversations.projectId, projectId),\n        eq(schema.aiConversations.userId, userId)\n      ))\n      .orderBy(desc(schema.aiConversations.updatedAt));\n  }\n\n  async createAiConversation(conversation: InsertAiConversation): Promise<AiConversation> {\n    const [created] = await db.insert(schema.aiConversations).values(conversation).returning();\n    return created;\n  }\n\n  async updateAiConversation(id: number, conversation: Partial<InsertAiConversation>): Promise<AiConversation | undefined> {\n    const [updated] = await db.update(schema.aiConversations)\n      .set({ ...conversation, updatedAt: new Date() })\n      .where(eq(schema.aiConversations.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteAiConversation(id: number): Promise<void> {\n    await db.delete(schema.aiConversations).where(eq(schema.aiConversations.id, id));\n  }\n\n  // AI Messages\n  async getAiMessagesByConversation(conversationId: number): Promise<AiMessage[]> {\n    return await db.select().from(schema.aiMessages)\n      .where(eq(schema.aiMessages.conversationId, conversationId))\n      .orderBy(asc(schema.aiMessages.createdAt));\n  }\n\n  async createAiMessage(message: InsertAiMessage): Promise<AiMessage> {\n    const [created] = await db.insert(schema.aiMessages).values(message).returning();\n    return created;\n  }\n\n  // AI Usage\n  async createAiUsage(usage: InsertAiUsage): Promise<AiUsage> {\n    const [created] = await db.insert(schema.aiUsage).values(usage).returning();\n    return created;\n  }\n\n  async getAiUsageByUser(userId: string, startDate?: Date): Promise<AiUsage[]> {\n    if (startDate) {\n      return await db.select().from(schema.aiUsage)\n        .where(and(\n          eq(schema.aiUsage.userId, userId),\n          eq(schema.aiUsage.createdAt, startDate)\n        ))\n        .orderBy(desc(schema.aiUsage.createdAt));\n    }\n    return await db.select().from(schema.aiUsage)\n      .where(eq(schema.aiUsage.userId, userId))\n      .orderBy(desc(schema.aiUsage.createdAt));\n  }\n\n  // Email Templates\n  async getEmailTemplate(id: number): Promise<EmailTemplate | undefined> {\n    const [template] = await db.select().from(schema.emailTemplates)\n      .where(eq(schema.emailTemplates.id, id));\n    return template;\n  }\n\n  async getEmailTemplatesByOrganization(organizationId: number): Promise<EmailTemplate[]> {\n    return await db.select().from(schema.emailTemplates)\n      .where(eq(schema.emailTemplates.organizationId, organizationId))\n      .orderBy(asc(schema.emailTemplates.type));\n  }\n\n  async getEmailTemplateByType(organizationId: number, type: string): Promise<EmailTemplate | undefined> {\n    const [template] = await db.select().from(schema.emailTemplates)\n      .where(and(\n        eq(schema.emailTemplates.organizationId, organizationId),\n        eq(schema.emailTemplates.type, type as any)\n      ));\n    return template;\n  }\n\n  async createEmailTemplate(template: InsertEmailTemplate & { createdBy: string }): Promise<EmailTemplate> {\n    const [created] = await db.insert(schema.emailTemplates).values(template).returning();\n    return created;\n  }\n\n  async updateEmailTemplate(id: number, template: Partial<InsertEmailTemplate>): Promise<EmailTemplate | undefined> {\n    const [updated] = await db.update(schema.emailTemplates)\n      .set({ ...template, updatedAt: new Date() })\n      .where(eq(schema.emailTemplates.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteEmailTemplate(id: number): Promise<void> {\n    await db.delete(schema.emailTemplates).where(eq(schema.emailTemplates.id, id));\n  }\n\n  // Sent Emails\n  async createSentEmail(email: InsertSentEmail): Promise<SentEmail> {\n    const [created] = await db.insert(schema.sentEmails).values(email).returning();\n    return created;\n  }\n\n  async getSentEmailsByOrganization(organizationId: number, limit: number = 100): Promise<SentEmail[]> {\n    return await db.select().from(schema.sentEmails)\n      .where(eq(schema.sentEmails.organizationId, organizationId))\n      .orderBy(desc(schema.sentEmails.createdAt))\n      .limit(limit);\n  }\n\n  async updateSentEmailStatus(id: number, status: string, errorMessage?: string): Promise<SentEmail | undefined> {\n    const updates: any = { status };\n    if (status === 'sent') {\n      updates.sentAt = new Date();\n    }\n    if (errorMessage) {\n      updates.errorMessage = errorMessage;\n    }\n    const [updated] = await db.update(schema.sentEmails)\n      .set(updates)\n      .where(eq(schema.sentEmails.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Email Usage\n  async getEmailUsage(organizationId: number, month: string): Promise<EmailUsage | undefined> {\n    const [usage] = await db.select().from(schema.emailUsage)\n      .where(and(\n        eq(schema.emailUsage.organizationId, organizationId),\n        eq(schema.emailUsage.month, month)\n      ));\n    return usage;\n  }\n\n  async incrementEmailUsage(organizationId: number): Promise<EmailUsage> {\n    const month = new Date().toISOString().slice(0, 7); // YYYY-MM format\n    const existing = await this.getEmailUsage(organizationId, month);\n    \n    if (existing) {\n      const [updated] = await db.update(schema.emailUsage)\n        .set({ \n          emailsSent: existing.emailsSent + 1,\n          updatedAt: new Date() \n        })\n        .where(eq(schema.emailUsage.id, existing.id))\n        .returning();\n      return updated;\n    } else {\n      const [created] = await db.insert(schema.emailUsage)\n        .values({ organizationId, month, emailsSent: 1 })\n        .returning();\n      return created;\n    }\n  }\n\n  // Project Files\n  async getProjectFile(id: number): Promise<ProjectFile | undefined> {\n    const [file] = await db.select().from(schema.projectFiles)\n      .where(eq(schema.projectFiles.id, id));\n    return file;\n  }\n\n  async getProjectFilesByProject(projectId: number): Promise<ProjectFile[]> {\n    return await db.select().from(schema.projectFiles)\n      .where(eq(schema.projectFiles.projectId, projectId))\n      .orderBy(desc(schema.projectFiles.createdAt));\n  }\n\n  async getProjectFilesByOrganization(organizationId: number): Promise<ProjectFile[]> {\n    return await db.select().from(schema.projectFiles)\n      .where(eq(schema.projectFiles.organizationId, organizationId))\n      .orderBy(desc(schema.projectFiles.createdAt));\n  }\n\n  async createProjectFile(file: InsertProjectFile & { uploadedBy: string }): Promise<ProjectFile> {\n    const [created] = await db.insert(schema.projectFiles).values(file).returning();\n    return created;\n  }\n\n  async updateProjectFile(id: number, file: Partial<InsertProjectFile>): Promise<ProjectFile | undefined> {\n    const [updated] = await db.update(schema.projectFiles)\n      .set({ ...file, updatedAt: new Date() })\n      .where(eq(schema.projectFiles.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteProjectFile(id: number): Promise<void> {\n    await db.delete(schema.projectFiles).where(eq(schema.projectFiles.id, id));\n  }\n\n  // Storage Quotas\n  async getStorageQuota(organizationId: number): Promise<StorageQuota | undefined> {\n    const [quota] = await db.select().from(schema.storageQuotas)\n      .where(eq(schema.storageQuotas.organizationId, organizationId));\n    return quota;\n  }\n\n  async updateStorageQuota(organizationId: number, usedBytes: number): Promise<StorageQuota> {\n    const existing = await this.getStorageQuota(organizationId);\n    \n    if (existing) {\n      const [updated] = await db.update(schema.storageQuotas)\n        .set({ usedBytes, updatedAt: new Date() })\n        .where(eq(schema.storageQuotas.id, existing.id))\n        .returning();\n      return updated;\n    } else {\n      const [created] = await db.insert(schema.storageQuotas)\n        .values({ organizationId, usedBytes })\n        .returning();\n      return created;\n    }\n  }\n\n  async incrementStorageUsage(organizationId: number, bytes: number): Promise<StorageQuota> {\n    const existing = await this.getStorageQuota(organizationId);\n    const currentUsed = existing?.usedBytes || 0;\n    return this.updateStorageQuota(organizationId, currentUsed + bytes);\n  }\n\n  async decrementStorageUsage(organizationId: number, bytes: number): Promise<StorageQuota> {\n    const existing = await this.getStorageQuota(organizationId);\n    const currentUsed = existing?.usedBytes || 0;\n    const newUsed = Math.max(0, currentUsed - bytes);\n    return this.updateStorageQuota(organizationId, newUsed);\n  }\n\n  // Subscription Plans\n  async getSubscriptionPlans(): Promise<SubscriptionPlan[]> {\n    return db.select().from(schema.subscriptionPlans)\n      .where(eq(schema.subscriptionPlans.isActive, true))\n      .orderBy(asc(schema.subscriptionPlans.priceMonthly));\n  }\n\n  async getSubscriptionPlan(id: number): Promise<SubscriptionPlan | undefined> {\n    const [plan] = await db.select().from(schema.subscriptionPlans)\n      .where(eq(schema.subscriptionPlans.id, id));\n    return plan;\n  }\n\n  async getSubscriptionPlanByTier(tier: string): Promise<SubscriptionPlan | undefined> {\n    const [plan] = await db.select().from(schema.subscriptionPlans)\n      .where(eq(schema.subscriptionPlans.tier, tier as any));\n    return plan;\n  }\n\n  async createSubscriptionPlan(plan: InsertSubscriptionPlan): Promise<SubscriptionPlan> {\n    const [created] = await db.insert(schema.subscriptionPlans).values(plan).returning();\n    return created;\n  }\n\n  async updateSubscriptionPlan(id: number, plan: Partial<InsertSubscriptionPlan>): Promise<SubscriptionPlan | undefined> {\n    const [updated] = await db.update(schema.subscriptionPlans)\n      .set({ ...plan, updatedAt: new Date() })\n      .where(eq(schema.subscriptionPlans.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Organization Subscriptions\n  async getOrganizationSubscription(organizationId: number): Promise<OrganizationSubscription | undefined> {\n    const [subscription] = await db.select().from(schema.organizationSubscriptions)\n      .where(eq(schema.organizationSubscriptions.organizationId, organizationId));\n    return subscription;\n  }\n\n  async createOrganizationSubscription(subscription: InsertOrganizationSubscription): Promise<OrganizationSubscription> {\n    const [created] = await db.insert(schema.organizationSubscriptions).values(subscription).returning();\n    return created;\n  }\n\n  async updateOrganizationSubscription(organizationId: number, subscription: Partial<InsertOrganizationSubscription>): Promise<OrganizationSubscription | undefined> {\n    const [updated] = await db.update(schema.organizationSubscriptions)\n      .set({ ...subscription, updatedAt: new Date() })\n      .where(eq(schema.organizationSubscriptions.organizationId, organizationId))\n      .returning();\n    return updated;\n  }\n\n  // AI Usage Summary\n  async getAiUsageSummary(organizationId: number, month: string): Promise<AiUsageSummary | undefined> {\n    const [summary] = await db.select().from(schema.aiUsageSummary)\n      .where(and(\n        eq(schema.aiUsageSummary.organizationId, organizationId),\n        eq(schema.aiUsageSummary.month, month)\n      ));\n    return summary;\n  }\n\n  async incrementAiUsage(organizationId: number, tokensUsed: number): Promise<AiUsageSummary> {\n    const now = new Date();\n    const month = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;\n    \n    const existing = await this.getAiUsageSummary(organizationId, month);\n    \n    if (existing) {\n      const [updated] = await db.update(schema.aiUsageSummary)\n        .set({\n          tokensUsed: existing.tokensUsed + tokensUsed,\n          requestCount: existing.requestCount + 1,\n          updatedAt: new Date()\n        })\n        .where(eq(schema.aiUsageSummary.id, existing.id))\n        .returning();\n      return updated;\n    } else {\n      const [created] = await db.insert(schema.aiUsageSummary)\n        .values({\n          organizationId,\n          month,\n          tokensUsed,\n          requestCount: 1,\n          tokenLimit: 50000\n        })\n        .returning();\n      return created;\n    }\n  }\n\n  // Cloud Storage Connections\n  async getCloudStorageConnections(organizationId: number): Promise<CloudStorageConnection[]> {\n    return this.getCloudStorageConnectionsByOrganization(organizationId);\n  }\n\n  async getCloudStorageConnectionsByOrganization(organizationId: number): Promise<CloudStorageConnection[]> {\n    return db.select().from(schema.cloudStorageConnections)\n      .where(eq(schema.cloudStorageConnections.organizationId, organizationId))\n      .orderBy(asc(schema.cloudStorageConnections.provider));\n  }\n\n  async getCloudStorageConnection(id: number): Promise<CloudStorageConnection | undefined> {\n    const [connection] = await db.select().from(schema.cloudStorageConnections)\n      .where(eq(schema.cloudStorageConnections.id, id));\n    return connection;\n  }\n\n  async getCloudStorageConnectionByProvider(organizationId: number, provider: string): Promise<CloudStorageConnection | undefined> {\n    const [connection] = await db.select().from(schema.cloudStorageConnections)\n      .where(and(\n        eq(schema.cloudStorageConnections.organizationId, organizationId),\n        eq(schema.cloudStorageConnections.provider, provider)\n      ));\n    return connection;\n  }\n\n  async createCloudStorageConnection(connection: InsertCloudStorageConnection & { connectedBy: string }): Promise<CloudStorageConnection> {\n    const [created] = await db.insert(schema.cloudStorageConnections).values(connection).returning();\n    return created;\n  }\n\n  async updateCloudStorageConnection(id: number, connection: Partial<InsertCloudStorageConnection>): Promise<CloudStorageConnection | undefined> {\n    const [updated] = await db.update(schema.cloudStorageConnections)\n      .set({ ...connection, updatedAt: new Date() })\n      .where(eq(schema.cloudStorageConnections.id, id))\n      .returning();\n    return updated;\n  }\n\n  async updateCloudStorageConnectionTokens(\n    id: number, \n    tokens: { accessToken: string; refreshToken?: string; tokenExpiresAt?: Date }\n  ): Promise<CloudStorageConnection | undefined> {\n    const [updated] = await db.update(schema.cloudStorageConnections)\n      .set({ \n        accessToken: tokens.accessToken,\n        ...(tokens.refreshToken && { refreshToken: tokens.refreshToken }),\n        ...(tokens.tokenExpiresAt && { tokenExpiresAt: tokens.tokenExpiresAt }),\n        updatedAt: new Date()\n      })\n      .where(eq(schema.cloudStorageConnections.id, id))\n      .returning();\n    return updated;\n  }\n\n  async updateCloudStorageConnectionSyncStatus(\n    id: number, \n    status: { syncStatus: string; lastSyncAt?: Date; syncError?: string | null }\n  ): Promise<CloudStorageConnection | undefined> {\n    const [updated] = await db.update(schema.cloudStorageConnections)\n      .set({ \n        syncStatus: status.syncStatus,\n        ...(status.lastSyncAt && { lastSyncAt: status.lastSyncAt }),\n        syncError: status.syncError ?? null,\n        updatedAt: new Date()\n      })\n      .where(eq(schema.cloudStorageConnections.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteCloudStorageConnection(id: number): Promise<void> {\n    await db.delete(schema.cloudStorageConnections).where(eq(schema.cloudStorageConnections.id, id));\n  }\n\n  // Cloud Synced Files\n  async getCloudSyncedFilesByProject(projectId: number): Promise<CloudSyncedFile[]> {\n    return db.select().from(schema.cloudSyncedFiles)\n      .where(eq(schema.cloudSyncedFiles.projectId, projectId))\n      .orderBy(asc(schema.cloudSyncedFiles.name));\n  }\n\n  async getCloudSyncedFilesByConnection(connectionId: number): Promise<CloudSyncedFile[]> {\n    return db.select().from(schema.cloudSyncedFiles)\n      .where(eq(schema.cloudSyncedFiles.connectionId, connectionId))\n      .orderBy(asc(schema.cloudSyncedFiles.cloudFilePath));\n  }\n\n  async getCloudSyncedFile(id: number): Promise<CloudSyncedFile | undefined> {\n    const [file] = await db.select().from(schema.cloudSyncedFiles)\n      .where(eq(schema.cloudSyncedFiles.id, id));\n    return file;\n  }\n\n  async getCloudSyncedFileByCloudId(connectionId: number, cloudFileId: string): Promise<CloudSyncedFile | undefined> {\n    const [file] = await db.select().from(schema.cloudSyncedFiles)\n      .where(and(\n        eq(schema.cloudSyncedFiles.connectionId, connectionId),\n        eq(schema.cloudSyncedFiles.cloudFileId, cloudFileId)\n      ));\n    return file;\n  }\n\n  async createCloudSyncedFile(file: InsertCloudSyncedFile): Promise<CloudSyncedFile> {\n    const [created] = await db.insert(schema.cloudSyncedFiles).values(file).returning();\n    return created;\n  }\n\n  async updateCloudSyncedFile(id: number, file: Partial<InsertCloudSyncedFile>): Promise<CloudSyncedFile | undefined> {\n    const [updated] = await db.update(schema.cloudSyncedFiles)\n      .set({ ...file, updatedAt: new Date() })\n      .where(eq(schema.cloudSyncedFiles.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteCloudSyncedFile(id: number): Promise<void> {\n    await db.delete(schema.cloudSyncedFiles).where(eq(schema.cloudSyncedFiles.id, id));\n  }\n\n  async deleteCloudSyncedFilesByConnection(connectionId: number): Promise<void> {\n    await db.delete(schema.cloudSyncedFiles).where(eq(schema.cloudSyncedFiles.connectionId, connectionId));\n  }\n\n  // Documents\n  async getDocument(id: number): Promise<Document | undefined> {\n    const [doc] = await db.select().from(schema.documents).where(eq(schema.documents.id, id));\n    return doc;\n  }\n\n  async getDocumentsByProject(projectId: number): Promise<Document[]> {\n    return db.select().from(schema.documents)\n      .where(eq(schema.documents.projectId, projectId))\n      .orderBy(desc(schema.documents.createdAt));\n  }\n\n  async getDocumentsByTask(taskId: number): Promise<Document[]> {\n    // Documents don't have a direct taskId - they're linked via tags/equipment\n    // Return empty for now - can be extended with junction table\n    return [];\n  }\n\n  async createDocument(document: InsertDocument & { createdBy: string }): Promise<Document> {\n    const [created] = await db.insert(schema.documents).values(document).returning();\n    return created;\n  }\n\n  async updateDocument(id: number, document: Partial<InsertDocument>): Promise<Document | undefined> {\n    const [updated] = await db.update(schema.documents)\n      .set({ ...document, updatedAt: new Date() })\n      .where(eq(schema.documents.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteDocument(id: number): Promise<void> {\n    await db.delete(schema.documents).where(eq(schema.documents.id, id));\n  }\n\n  // Project Events (Calendar)\n  async getProjectEvent(id: number): Promise<ProjectEvent | undefined> {\n    const [event] = await db.select().from(schema.projectEvents).where(eq(schema.projectEvents.id, id));\n    return event;\n  }\n\n  async getProjectEventsByProject(projectId: number): Promise<ProjectEvent[]> {\n    return db.select().from(schema.projectEvents)\n      .where(eq(schema.projectEvents.projectId, projectId))\n      .orderBy(asc(schema.projectEvents.startDate));\n  }\n\n  async createProjectEvent(event: InsertProjectEvent & { createdBy: string }): Promise<ProjectEvent> {\n    const [created] = await db.insert(schema.projectEvents).values(event).returning();\n    return created;\n  }\n\n  async updateProjectEvent(id: number, event: Partial<InsertProjectEvent>): Promise<ProjectEvent | undefined> {\n    const [updated] = await db.update(schema.projectEvents)\n      .set({ ...event, updatedAt: new Date() })\n      .where(eq(schema.projectEvents.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteProjectEvent(id: number): Promise<void> {\n    await db.delete(schema.projectEvents).where(eq(schema.projectEvents.id, id));\n  }\n\n  // Task Documents (Junction)\n  async getTaskDocuments(taskId: number): Promise<TaskDocument[]> {\n    return db.select().from(schema.taskDocuments)\n      .where(eq(schema.taskDocuments.taskId, taskId));\n  }\n\n  async createTaskDocument(taskDocument: InsertTaskDocument): Promise<TaskDocument> {\n    const [created] = await db.insert(schema.taskDocuments).values(taskDocument).returning();\n    return created;\n  }\n\n  async deleteTaskDocument(taskId: number, documentId: number): Promise<void> {\n    await db.delete(schema.taskDocuments).where(\n      and(\n        eq(schema.taskDocuments.taskId, taskId),\n        eq(schema.taskDocuments.documentId, documentId)\n      )\n    );\n  }\n\n  // Task Risks (Junction)\n  async getTaskRisks(taskId: number): Promise<TaskRisk[]> {\n    return db.select().from(schema.taskRisks)\n      .where(eq(schema.taskRisks.taskId, taskId));\n  }\n\n  async createTaskRisk(taskRisk: InsertTaskRisk): Promise<TaskRisk> {\n    const [created] = await db.insert(schema.taskRisks).values(taskRisk).returning();\n    return created;\n  }\n\n  async deleteTaskRisk(taskId: number, riskId: number): Promise<void> {\n    await db.delete(schema.taskRisks).where(\n      and(\n        eq(schema.taskRisks.taskId, taskId),\n        eq(schema.taskRisks.riskId, riskId)\n      )\n    );\n  }\n\n  // Task Issues (Junction)\n  async getTaskIssues(taskId: number): Promise<TaskIssue[]> {\n    return db.select().from(schema.taskIssues)\n      .where(eq(schema.taskIssues.taskId, taskId));\n  }\n\n  async createTaskIssue(taskIssue: InsertTaskIssue): Promise<TaskIssue> {\n    const [created] = await db.insert(schema.taskIssues).values(taskIssue).returning();\n    return created;\n  }\n\n  async deleteTaskIssue(taskId: number, issueId: number): Promise<void> {\n    await db.delete(schema.taskIssues).where(\n      and(\n        eq(schema.taskIssues.taskId, taskId),\n        eq(schema.taskIssues.issueId, issueId)\n      )\n    );\n  }\n\n  // Inheritance helpers\n  async getTaskAncestors(taskId: number): Promise<Task[]> {\n    const ancestors: Task[] = [];\n    let currentTask = await this.getTask(taskId);\n    \n    while (currentTask && currentTask.parentId) {\n      const parentTask = await this.getTask(currentTask.parentId);\n      if (parentTask) {\n        ancestors.push(parentTask);\n        currentTask = parentTask;\n      } else {\n        break;\n      }\n    }\n    \n    return ancestors;\n  }\n\n  async getInheritedResources(taskId: number): Promise<{ assignmentId: number; resourceId: number; resource: Resource | null; sourceTaskId: number; sourceTask: Task | null }[]> {\n    const ancestors = await this.getTaskAncestors(taskId);\n    const results: { assignmentId: number; resourceId: number; resource: Resource | null; sourceTaskId: number; sourceTask: Task | null }[] = [];\n    \n    for (const ancestor of ancestors) {\n      const assignments = await db.select().from(schema.resourceAssignments)\n        .where(eq(schema.resourceAssignments.taskId, ancestor.id));\n      \n      for (const assignment of assignments) {\n        const [resource] = await db.select().from(schema.resources)\n          .where(eq(schema.resources.id, assignment.resourceId));\n        \n        results.push({\n          assignmentId: assignment.id,\n          resourceId: assignment.resourceId,\n          resource: resource || null,\n          sourceTaskId: ancestor.id,\n          sourceTask: ancestor,\n        });\n      }\n    }\n    \n    return results;\n  }\n\n  async getInheritedDocuments(taskId: number): Promise<{ taskDocumentId: number; documentId: number; document: Document | null; sourceTaskId: number; sourceTask: Task | null }[]> {\n    const ancestors = await this.getTaskAncestors(taskId);\n    const results: { taskDocumentId: number; documentId: number; document: Document | null; sourceTaskId: number; sourceTask: Task | null }[] = [];\n    \n    for (const ancestor of ancestors) {\n      const taskDocs = await this.getTaskDocuments(ancestor.id);\n      \n      for (const taskDoc of taskDocs) {\n        const document = await this.getDocument(taskDoc.documentId);\n        \n        results.push({\n          taskDocumentId: taskDoc.id,\n          documentId: taskDoc.documentId,\n          document: document || null,\n          sourceTaskId: ancestor.id,\n          sourceTask: ancestor,\n        });\n      }\n    }\n    \n    return results;\n  }\n\n  async getInheritedRisks(taskId: number): Promise<{ taskRiskId: number; riskId: number; risk: Risk | null; sourceTaskId: number; sourceTask: Task | null }[]> {\n    const ancestors = await this.getTaskAncestors(taskId);\n    const results: { taskRiskId: number; riskId: number; risk: Risk | null; sourceTaskId: number; sourceTask: Task | null }[] = [];\n    \n    for (const ancestor of ancestors) {\n      const taskRisks = await this.getTaskRisks(ancestor.id);\n      \n      for (const taskRisk of taskRisks) {\n        const risk = await this.getRisk(taskRisk.riskId);\n        \n        results.push({\n          taskRiskId: taskRisk.id,\n          riskId: taskRisk.riskId,\n          risk: risk || null,\n          sourceTaskId: ancestor.id,\n          sourceTask: ancestor,\n        });\n      }\n    }\n    \n    return results;\n  }\n\n  async getInheritedIssues(taskId: number): Promise<{ taskIssueId: number; issueId: number; issue: Issue | null; sourceTaskId: number; sourceTask: Task | null }[]> {\n    const ancestors = await this.getTaskAncestors(taskId);\n    const results: { taskIssueId: number; issueId: number; issue: Issue | null; sourceTaskId: number; sourceTask: Task | null }[] = [];\n    \n    for (const ancestor of ancestors) {\n      const taskIssues = await this.getTaskIssues(ancestor.id);\n      \n      for (const taskIssue of taskIssues) {\n        const issue = await this.getIssue(taskIssue.issueId);\n        \n        results.push({\n          taskIssueId: taskIssue.id,\n          issueId: taskIssue.issueId,\n          issue: issue || null,\n          sourceTaskId: ancestor.id,\n          sourceTask: ancestor,\n        });\n      }\n    }\n    \n    return results;\n  }\n\n  // Organization-level aggregation (PMO)\n  async getTasksByOrganization(organizationId: number): Promise<(Task & { projectName: string })[]> {\n    const projects = await this.getProjectsByOrganization(organizationId);\n    const projectMap = new Map(projects.map(p => [p.id, p.name]));\n    \n    const allTasks: (Task & { projectName: string })[] = [];\n    for (const project of projects) {\n      const tasks = await this.getTasksByProject(project.id);\n      for (const task of tasks) {\n        allTasks.push({\n          ...task,\n          projectName: projectMap.get(project.id) || project.name,\n        });\n      }\n    }\n    return allTasks;\n  }\n\n  async getRisksByOrganization(organizationId: number): Promise<(Risk & { projectName: string })[]> {\n    const projects = await this.getProjectsByOrganization(organizationId);\n    const projectMap = new Map(projects.map(p => [p.id, p.name]));\n    \n    const allRisks: (Risk & { projectName: string })[] = [];\n    for (const project of projects) {\n      const risks = await this.getRisksByProject(project.id);\n      for (const risk of risks) {\n        allRisks.push({\n          ...risk,\n          projectName: projectMap.get(project.id) || project.name,\n        });\n      }\n    }\n    return allRisks;\n  }\n\n  async getIssuesByOrganization(organizationId: number): Promise<(Issue & { projectName: string })[]> {\n    const projects = await this.getProjectsByOrganization(organizationId);\n    const projectMap = new Map(projects.map(p => [p.id, p.name]));\n    \n    const allIssues: (Issue & { projectName: string })[] = [];\n    for (const project of projects) {\n      const issues = await this.getIssuesByProject(project.id);\n      for (const issue of issues) {\n        allIssues.push({\n          ...issue,\n          projectName: projectMap.get(project.id) || project.name,\n        });\n      }\n    }\n    return allIssues;\n  }\n\n  async getResourcesByOrganization(organizationId: number): Promise<(Resource & { projectName: string })[]> {\n    const projects = await this.getProjectsByOrganization(organizationId);\n    const projectMap = new Map(projects.map(p => [p.id, p.name]));\n    \n    const allResources: (Resource & { projectName: string })[] = [];\n    for (const project of projects) {\n      const resources = await this.getResourcesByProject(project.id);\n      for (const resource of resources) {\n        allResources.push({\n          ...resource,\n          projectName: projectMap.get(project.id) || project.name,\n        });\n      }\n    }\n    return allResources;\n  }\n\n  async getCostItemsByOrganization(organizationId: number): Promise<(CostItem & { projectName: string })[]> {\n    const projects = await this.getProjectsByOrganization(organizationId);\n    const projectMap = new Map(projects.map(p => [p.id, p.name]));\n    \n    const allCostItems: (CostItem & { projectName: string })[] = [];\n    for (const project of projects) {\n      const costs = await this.getCostItemsByProject(project.id);\n      for (const cost of costs) {\n        allCostItems.push({\n          ...cost,\n          projectName: projectMap.get(project.id) || project.name,\n        });\n      }\n    }\n    return allCostItems;\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","size_bytes":75551},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","size_bytes":1584},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","size_bytes":1056},"client/src/components/examples/KanbanPage.tsx":{"content":"import KanbanPage from '@/pages/KanbanPage';\n\nexport default function KanbanPageExample() {\n  return <KanbanPage />;\n}\n","size_bytes":119},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","size_bytes":1251},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","size_bytes":329},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","size_bytes":261},"client/src/components/examples/Dashboard.tsx":{"content":"import Dashboard from '@/pages/Dashboard';\n\nexport default function DashboardExample() {\n  return <Dashboard />;\n}\n","size_bytes":115},"replit.md":{"content":"# EPC PMIS - Project Management Information Software\n\n## Overview\nA comprehensive, multi-tenant SaaS platform for EPC (Engineering, Procurement, Construction) project management, built with TypeScript, React, Express, and PostgreSQL. Supports 100 organizations with up to 100 projects each containing up to 1000 tasks.\n\n## Current Status\n**Phase:** Core Features Complete, Advanced Features In Progress\n**Last Updated:** November 25, 2024\n\n### ✅ Completed\n- Multi-tenant database schema with all core tables\n- Replit Auth integration with session management\n- Complete backend API with authorization and validation\n- Frontend authentication flow (login page, auth guard)\n- ProjectContext for global org/project selection\n- WBS, Stakeholders, Risks, Issues pages with CRUD operations\n- TopBar with real organization/project data\n- AI Assistant with OpenAI (GPT-4o) integration, project-scoped conversations\n- PDF Report generation (Risk Register, Project Status, EVA, Issue Log)\n- Email Template system with SendGrid integration and placeholder replacement\n- WebSocket real-time collaboration infrastructure\n- Auto-generated sequential codes (RISK-001, ISS-001, etc.)\n- **Dependencies tab redesign** with two-column layout (Predecessors/Successors), inline editing, and full CRUD support\n- **Import/Export functionality** - JSON export (full project data), CSV export (tasks), PDF status reports via TopBar dropdown\n- **Flexible Import System** - Allows any text values for discipline and assignedTo fields from external AI tools (ChatGPT, Claude, Gemini)\n- **Label Management** - Settings page tab for normalizing discipline and assignee labels after import (bulk find-and-replace)\n- **EPC Analytics Dashboard** with S-Curve chart and EVA performance indicators (SPI/CPI gauges)\n- **RACI Matrix with Inheritance** - Redesigned with 4 RACI columns (R/A/C/I), collapsible WBS tree, multi-select dropdowns for stakeholders + resources, automatic inheritance propagation from parent to children, reset to parent capability, Accountable warning for multiple assignments\n- **Resource Assignments Tab** - Enhanced ResourceDetailsModal showing all task assignments for a resource with WBS code, dates, allocation %, and planned hours\n- **Resource Utilization View** - Timeline visualization with weekly periods showing utilization % per resource, color-coded cells (green/yellow/orange/red), over-allocation warnings, prorated allocation calculations\n- **CPM Scheduling Engine** - Full Critical Path Method implementation:\n  - Forward Pass: Calculates Early Start (ES) and Early Finish (EF) dates\n  - Backward Pass: Calculates Late Start (LS) and Late Finish (LF) dates\n  - Float Calculation: Total Float and Free Float for each task\n  - Critical Path: Identifies zero-float tasks as critical\n  - Supports all dependency types (FS, SS, FF, SF) with lag/lead time\n  - Business day calculations (skips weekends)\n  - Constraint handling (ASAP, SNET, FNET, MSO, MFO)\n\n### 🚧 In Progress / Needs Completion\n- PWA offline capabilities (IndexedDB caching, 7-day support)\n- Google Drive, OneDrive, Dropbox cloud storage connectors\n- Admin dashboard and marketing landing page\n- End-to-end testing with Playwright\n\n**Last Updated:** November 25, 2024\n\n## Architecture\n\n### Technology Stack\n- **Frontend:** React + Vite, shadcn/ui components, Tailwind CSS, TanStack Query\n- **Backend:** Express.js, TypeScript\n- **Database:** PostgreSQL (Neon), Drizzle ORM\n- **Authentication:** Replit Auth (OpenID Connect)\n- **AI Integration:** Google Gemini AI (API key configured)\n- **Styling:** Material Design 3 inspired, Inter + Roboto Mono fonts\n\n### Multi-Tenant Architecture\n- Organization-based data isolation\n- User-Organization many-to-many relationship\n- Role-based access control (owner, admin, member, viewer)\n- Each organization can have multiple projects\n- Each project contains tasks, stakeholders, risks, issues, costs\n\n## Database Schema\n\n### Core Tables\n1. **organizations** - Root tenant table (id, name, slug)\n2. **users** - Replit Auth compatible (id, email, firstName, lastName, profileImageUrl)\n3. **sessions** - Required for Replit Auth session management\n4. **user_organizations** - User-org relationship with roles\n5. **projects** - Project data (budget, dates, currency, status)\n6. **tasks** - WBS hierarchy with 5 levels (parentId, wbsCode)\n7. **task_dependencies** - FS, SS, FF, SF dependency types\n8. **stakeholders** - Project stakeholder management\n9. **risks** - Risk register with probability/impact\n10. **issues** - Issue tracking system\n11. **change_requests** - Change request workflow\n12. **cost_items** - Multi-currency cost tracking\n13. **resources** - Resource management\n14. **resource_assignments** - Task-resource allocation\n15. **google_connections** - User's Google account OAuth tokens\n\n### Key Features\n- WBS codes support 5-level hierarchy (e.g., \"1.2.3.4.5\")\n- Task dependencies: FS (Finish-Start), SS (Start-Start), FF (Finish-Finish), SF (Start-Finish)\n- Multi-currency support (default USD)\n- Progress tracking (0-100%)\n- Status tracking for all entities\n\n## API Routes\n\n### Authentication\n- `GET /api/login` - Initiate Replit Auth flow\n- `GET /api/callback` - OAuth callback\n- `GET /api/logout` - Sign out\n- `GET /api/auth/user` - Get current user (protected)\n\n### Organizations\n- `GET /api/organizations` - List user's organizations\n- `POST /api/organizations` - Create organization\n\n### Projects\n- `GET /api/organizations/:orgId/projects` - List projects\n- `GET /api/projects/:id` - Get project details\n- `POST /api/projects` - Create project\n- `PATCH /api/projects/:id` - Update project\n\n### Tasks\n- `GET /api/projects/:projectId/tasks` - List all tasks\n- `GET /api/tasks/:id` - Get task details\n- `POST /api/tasks` - Create task\n- `PATCH /api/tasks/:id` - Update task\n- `DELETE /api/tasks/:id` - Delete task\n\n### Task Dependencies\n- `GET /api/projects/:projectId/dependencies` - Get all dependencies for project\n- `POST /api/dependencies` - Create new dependency\n- `PATCH /api/dependencies/:id` - Update dependency (type, lagDays)\n- `DELETE /api/dependencies/:id` - Remove dependency\n\n### RACI Matrix\n- `GET /api/projects/:projectId/raci` - Get all RACI assignments for project\n- `GET /api/tasks/:taskId/raci` - Get RACI assignments for specific task\n- `POST /api/raci` - Create RACI assignment (propagates to descendants)\n- `PATCH /api/raci/:id` - Update RACI assignment\n- `DELETE /api/raci/:id` - Delete RACI assignment (removes inherited from descendants)\n- `POST /api/raci/reset` - Reset task's RACI to inherit from parent\n\n### Stakeholders, Risks, Issues, Costs\n- Similar RESTful patterns for each module\n- All protected with `isAuthenticated` middleware\n\n### WebSocket Real-Time Collaboration\n- Path: `/ws` (WebSocket server on same port as HTTP)\n- Events: task/risk/issue/stakeholder/cost-item CRUD notifications\n- Rooms: Project-scoped and organization-scoped\n- Features: User presence tracking, cursor sharing, auto-reconnection\n- Hook: `useWebSocket()` for frontend integration\n\n### AI Assistant\n- Path: `/api/ai/chat` (POST)\n- Model: OpenAI GPT-4o\n- Features: Project-scoped conversations, function calling for CRUD operations\n- Endpoints: conversations CRUD, cache purging, usage tracking\n\n### PDF Reports\n- Path: `/api/reports/risk-register/:projectId` (GET, returns PDF)\n- Types: Risk Register, Project Status, EVA Analysis, Issue Log\n- Library: PDFMake with embedded Roboto fonts\n\n### Email Templates\n- Path: `/api/organizations/:orgId/email-templates` (CRUD)\n- Integration: SendGrid API\n- Features: Placeholder replacement ({{PROJECT_NAME}}, etc.), preview, test sending\n- Types: 10 notification types (task-assigned, risk-identified, etc.)\n\n### CPM Scheduling\n- `POST /api/projects/:projectId/schedule` - Run CPM scheduling (calculates ES, EF, LS, LF, Float, Critical Path)\n- `GET /api/projects/:projectId/schedule` - Get schedule data for all tasks\n- `GET /api/projects/:projectId/critical-path` - Get critical path tasks and total duration\n\n### Resource Utilization\n- `GET /api/projects/:projectId/resource-utilization` - Get resource utilization timeline with weekly periods\n- `GET /api/resources/:resourceId/assignments` - Get all task assignments for a resource\n\n## Frontend Pages\n\n### Implemented\n1. **Dashboard** - Project metrics, KPIs, charts\n2. **WBS Page** - Task hierarchy table view\n3. **Gantt Page** - Timeline visualization\n4. **Kanban Page** - Task board (Not Started, In Progress, Review, Completed)\n5. **Calendar Page** - Month view with task scheduling\n6. **Stakeholders Page** - Stakeholder matrix\n7. **Risks Page** - Risk register\n8. **Issues Page** - Issue log\n9. **Cost Page** - Budget vs actual analytics\n10. **RACI Matrix** - Collapsible WBS tree, 4 RACI columns with multi-select dropdowns, inheritance from parent tasks\n\n### Components\n- **AppSidebar** - Left navigation (shadcn sidebar)\n- **TopBar** - Org/Project/Tab selectors, search, theme toggle\n- **RightSidebar** - Project metrics display\n- **MetricCard** - Reusable metric display\n- **TableRowCard** - Expandable row component\n- **TaskModal** - Task create/edit dialog\n- **ThemeProvider** - Light/dark mode\n\n## Completed Tasks\n\n### ✅ Task 1: Database Schema\n- Designed comprehensive multi-tenant schema\n- Implemented all core tables with proper relationships\n- Added enums for status, priority, risk levels\n- Set up Drizzle ORM with Zod schemas\n\n### ✅ Task 2: Authentication\n- Integrated Replit Auth (OpenID Connect)\n- Created `server/replitAuth.ts` with session management\n- Implemented `useAuth()` React hook\n- Added protected route middleware\n- Session storage in PostgreSQL\n\n### ✅ Task 3: API Routes & Storage\n- Created comprehensive storage interface (`IStorage`)\n- Implemented `DatabaseStorage` class with all CRUD operations\n- Built RESTful API routes for all modules\n- Added request validation with Zod schemas\n- All routes protected with authentication\n\n## Demo Project\nAuto-assigned to all users on login with \"viewer\" role:\n- Organization: \"Demo: GreenEnergy Solar\" (slug: demo-solar-project)\n- Project: \"50MW Riverside Solar Power Plant\" ($75M budget)\n- 30+ tasks across 5 WBS levels (Design, Engineering, Procurement, Construction, Commissioning)\n- 22 task dependencies (all types: FS, SS, FF, SF)\n- 10 stakeholders (Owner, PM, Contractors, Consultants, etc.)\n- 8 risks with probability/impact assessments\n- 7 issues with priorities and status tracking\n- 11 cost items (equipment, labor, materials, permits)\n- 8 resources with task assignments\n\nTo re-seed the demo project: `npx tsx server/seed-demo.ts --run`\n\n## Sample Data\nSeeded database with:\n- 1 organization: \"ACME Construction Corp\"\n- 2 projects: \"Downtown Office Complex\", \"Industrial Warehouse Retrofit\"\n- WBS task hierarchy with dependencies\n- Stakeholders (sponsor, contractor, consultant)\n- Risks (weather, material costs)\n- Issues (permit delays, equipment)\n- Cost items (labor, materials, equipment, overhead)\n\n## Next Steps\n\n### Task 4: Task Management Frontend Integration\n- Connect WBS page to real API\n- Implement task CRUD operations\n- Add dependency visualization\n- Enable drag-and-drop in Kanban\n\n### Task 5: Stakeholder/Risk/Issue Management\n- Wire up frontend forms to APIs\n- Implement CRUD operations\n- Add filtering and sorting\n\n### Task 6: Cost Analytics\n- Multi-currency calculations\n- Budget vs actual charts\n- Cost breakdown by category\n\n### Task 7: Google Gemini AI\n- Task suggestions based on project context\n- Risk analysis\n- Schedule optimization\n\n### Task 8: Complete Frontend Integration\n- Remove all mock data\n- Connect all pages to APIs\n- Implement state management\n- Add loading states\n\n### Task 9: Architect Review\n- Code quality assessment\n- Architecture pattern validation\n- Performance optimization\n\n### Task 10: E2E Testing\n- Playwright test scenarios\n- User workflow validation\n\n## Environment Variables\n- `DATABASE_URL` - PostgreSQL connection (auto-configured)\n- `SESSION_SECRET` - Session encryption key (auto-configured)\n- `GEMINI_API_KEY` - Google Gemini AI key (configured)\n- `REPL_ID` - Replit workspace ID (auto-configured)\n- `ISSUER_URL` - OAuth provider URL (auto-configured)\n\n## User Preferences\n- **Design:** Material Design 3, information-dense layouts\n- **Fonts:** Inter (UI), Roboto Mono (code/data)\n- **Google Integrations:** Essential for the platform\n  - Drive: Document storage\n  - Gmail: Notifications\n  - Gemini AI: Intelligent insights\n  - Translate: Multi-language support\n  - Sign-in: User auth\n- **Offline Support:** 7-day PWA capability required (future implementation)\n- **Scale:** Optimized for 100 orgs × 100 projects × 1000 tasks\n\n## Recent Changes\n- November 24, 2024: Initial database schema and authentication setup\n- November 24, 2024: API routes for all core modules\n- November 24, 2024: Database seeding with sample data\n","size_bytes":12806},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","size_bytes":2751},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","size_bytes":772},"client/src/pages/Dashboard.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { MetricCard } from \"@/components/MetricCard\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { BarChart3, TrendingUp, AlertTriangle, Clock, DollarSign, FolderKanban, Activity } from \"lucide-react\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { SCurveChart, PerformanceGauges, DisciplineProgress, RiskExposureSummary } from \"@/components/epc\";\nimport type { Task, Risk, Issue, CostItem, Project } from \"@shared/schema\";\n\ninterface WBSItem {\n  code: string;\n  name: string;\n  level: number;\n}\n\ninterface DashboardStats {\n  totalTasks: number;\n  completedTasks: number;\n  inProgressTasks: number;\n  completionRate: number;\n  openRisks: number;\n  openIssues: number;\n  totalBudget: number;\n  actualCost: number;\n  budgetUsed: number;\n}\n\nfunction calculateDashboardStats(\n  tasks: Task[],\n  risks: Risk[],\n  issues: Issue[],\n  costItems: CostItem[]\n): DashboardStats {\n  const totalTasks = tasks.length;\n  const completedTasks = tasks.filter(t => t.status === 'completed').length;\n  const inProgressTasks = tasks.filter(t => t.status === 'in-progress').length;\n  const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;\n  \n  const openRisks = risks.filter(r => r.status !== 'closed').length;\n  const openIssues = issues.filter(i => i.status !== 'closed' && i.status !== 'resolved').length;\n  \n  const totalBudget = costItems.reduce((sum, c) => sum + Number(c.budgeted || 0), 0);\n  const actualCost = costItems.reduce((sum, c) => sum + Number(c.actual || 0), 0);\n  const budgetUsed = totalBudget > 0 ? Math.round((actualCost / totalBudget) * 100) : 0;\n\n  return {\n    totalTasks,\n    completedTasks,\n    inProgressTasks,\n    completionRate,\n    openRisks,\n    openIssues,\n    totalBudget,\n    actualCost,\n    budgetUsed\n  };\n}\n\nfunction formatCurrency(value: number): string {\n  if (value >= 1000000) {\n    return `$${(value / 1000000).toFixed(1)}M`;\n  }\n  if (value >= 1000) {\n    return `$${(value / 1000).toFixed(0)}K`;\n  }\n  return `$${value.toFixed(0)}`;\n}\n\ninterface WBSProgress {\n  wbsCode: string;\n  name: string;\n  progress: number;\n  taskCount: number;\n}\n\nfunction calculateWBSProgress(tasks: Task[], wbsItems: WBSItem[]): WBSProgress[] {\n  const wbsMap = new Map<string, WBSItem>();\n  wbsItems.forEach(item => wbsMap.set(item.code, item));\n  \n  const level1Groups = new Map<string, { wbs: WBSItem | null; tasks: Task[] }>();\n  \n  tasks.forEach(task => {\n    const parts = task.wbsCode.split('.');\n    const level1Code = parts[0];\n    \n    if (!level1Groups.has(level1Code)) {\n      const wbsItem = wbsItems.find(w => w.code === level1Code && w.level === 1);\n      level1Groups.set(level1Code, { wbs: wbsItem || null, tasks: [] });\n    }\n    level1Groups.get(level1Code)!.tasks.push(task);\n  });\n  \n  return Array.from(level1Groups.entries())\n    .map(([code, data]) => {\n      const avgProgress = data.tasks.length > 0\n        ? data.tasks.reduce((sum, t) => sum + (t.progress || 0), 0) / data.tasks.length\n        : 0;\n      return {\n        wbsCode: code,\n        name: data.wbs?.name || `WBS ${code}`,\n        progress: Math.round(avgProgress),\n        taskCount: data.tasks.length\n      };\n    })\n    .sort((a, b) => a.wbsCode.localeCompare(b.wbsCode, undefined, { numeric: true }))\n    .slice(0, 5);\n}\n\nfunction safeDate(dateValue: string | Date | null | undefined): Date | null {\n  if (!dateValue) return null;\n  const date = new Date(dateValue);\n  return isNaN(date.getTime()) ? null : date;\n}\n\nfunction formatTimeAgo(dateValue: string | Date | null | undefined): string {\n  const date = safeDate(dateValue);\n  if (!date) return 'Recently';\n  \n  const now = new Date();\n  const diff = now.getTime() - date.getTime();\n  const minutes = Math.floor(diff / 60000);\n  const hours = Math.floor(diff / 3600000);\n  const days = Math.floor(diff / 86400000);\n  \n  if (minutes < 1) return 'Just now';\n  if (minutes < 60) return `${minutes}m ago`;\n  if (hours < 24) return `${hours}h ago`;\n  if (days === 1) return '1 day ago';\n  return `${days} days ago`;\n}\n\nexport default function Dashboard() {\n  const { selectedProject } = useProject();\n  const projectId = selectedProject?.id;\n\n  const { data: tasks = [], isLoading: tasksLoading, error: tasksError } = useQuery<Task[]>({\n    queryKey: ['/api/projects', projectId, 'tasks'],\n    enabled: !!projectId,\n    retry: 1,\n    queryFn: async () => {\n      const res = await fetch(`/api/projects/${projectId}/tasks`, { credentials: 'include' });\n      if (res.status === 401) return [];\n      if (!res.ok) throw new Error('Failed to fetch tasks');\n      return res.json();\n    }\n  });\n\n  const { data: wbsItems = [] } = useQuery<WBSItem[]>({\n    queryKey: ['/api/projects', projectId, 'wbs'],\n    enabled: !!projectId,\n    retry: 1,\n    queryFn: async () => {\n      const res = await fetch(`/api/projects/${projectId}/wbs`, { credentials: 'include' });\n      if (res.status === 401) return [];\n      if (!res.ok) throw new Error('Failed to fetch WBS');\n      return res.json();\n    }\n  });\n\n  const { data: risks = [], isLoading: risksLoading } = useQuery<Risk[]>({\n    queryKey: ['/api/projects', projectId, 'risks'],\n    enabled: !!projectId,\n    retry: 1,\n    queryFn: async () => {\n      const res = await fetch(`/api/projects/${projectId}/risks`, { credentials: 'include' });\n      if (res.status === 401) return [];\n      if (!res.ok) throw new Error('Failed to fetch risks');\n      return res.json();\n    }\n  });\n\n  const { data: issues = [], isLoading: issuesLoading } = useQuery<Issue[]>({\n    queryKey: ['/api/projects', projectId, 'issues'],\n    enabled: !!projectId,\n    retry: 1,\n    queryFn: async () => {\n      const res = await fetch(`/api/projects/${projectId}/issues`, { credentials: 'include' });\n      if (res.status === 401) return [];\n      if (!res.ok) throw new Error('Failed to fetch issues');\n      return res.json();\n    }\n  });\n\n  const { data: costItems = [], isLoading: costsLoading } = useQuery<CostItem[]>({\n    queryKey: ['/api/projects', projectId, 'costs'],\n    enabled: !!projectId,\n    retry: 1,\n    queryFn: async () => {\n      const res = await fetch(`/api/projects/${projectId}/costs`, { credentials: 'include' });\n      if (res.status === 401) return [];\n      if (!res.ok) throw new Error('Failed to fetch costs');\n      return res.json();\n    }\n  });\n\n  const isLoading = tasksLoading || risksLoading || issuesLoading || costsLoading;\n\n  if (!selectedProject) {\n    return (\n      <div className=\"p-6\">\n        <Alert>\n          <FolderKanban className=\"h-4 w-4\" />\n          <AlertDescription>\n            Please select a project to view the dashboard.\n          </AlertDescription>\n        </Alert>\n      </div>\n    );\n  }\n\n  const stats = calculateDashboardStats(tasks, risks, issues, costItems);\n  const wbsProgress = calculateWBSProgress(tasks, wbsItems);\n  \n  const recentItems: Array<{ id: string; type: 'risk' | 'issue'; title: string; date: Date | null }> = [\n    ...risks.map(r => ({\n      id: `risk-${r.id}`,\n      type: 'risk' as const,\n      title: r.title,\n      date: safeDate(r.createdAt)\n    })),\n    ...issues.map(i => ({\n      id: `issue-${i.id}`,\n      type: 'issue' as const,\n      title: i.title,\n      date: safeDate(i.createdAt)\n    }))\n  ].sort((a, b) => {\n    if (!a.date && !b.date) return 0;\n    if (!a.date) return 1;\n    if (!b.date) return -1;\n    return b.date.getTime() - a.date.getTime();\n  }).slice(0, 5);\n\n  const criticalTasks = tasks\n    .filter(t => t.status !== 'completed' && (t.priority === 'critical' || t.priority === 'high'))\n    .slice(0, 4);\n\n  const projectStartDate = selectedProject?.startDate ? new Date(selectedProject.startDate) : new Date();\n  const projectEndDate = selectedProject?.endDate ? new Date(selectedProject.endDate) : new Date(Date.now() + 365 * 24 * 60 * 60 * 1000);\n\n  return (\n    <div className=\"p-3 md:p-6 space-y-4 md:space-y-6\">\n      <div className=\"flex items-center justify-between flex-wrap gap-4\">\n        <div>\n          <h1 className=\"text-xl md:text-3xl font-semibold mb-1 md:mb-2\" data-testid=\"text-dashboard-title\">Project Dashboard</h1>\n          <p className=\"text-sm md:text-base text-muted-foreground\" data-testid=\"text-project-name\">\n            {selectedProject.name} - {selectedProject.code}\n          </p>\n        </div>\n      </div>\n\n      {isLoading ? (\n        <div className=\"grid gap-3 md:gap-4 grid-cols-2 lg:grid-cols-4\">\n          <Skeleton className=\"h-24 md:h-32\" />\n          <Skeleton className=\"h-24 md:h-32\" />\n          <Skeleton className=\"h-24 md:h-32\" />\n          <Skeleton className=\"h-24 md:h-32\" />\n        </div>\n      ) : (\n        <div className=\"grid gap-3 md:gap-4 grid-cols-2 lg:grid-cols-4\">\n          <MetricCard\n            title=\"Total Tasks\"\n            value={stats.totalTasks.toString()}\n            change={stats.totalTasks > 0 ? Math.round((stats.inProgressTasks / stats.totalTasks) * 100) : 0}\n            icon={BarChart3}\n            data-testid=\"metric-total-tasks\"\n          />\n          <MetricCard\n            title=\"Completion Rate\"\n            value={`${stats.completionRate}%`}\n            change={stats.completionRate > 50 ? 10 : -5}\n            icon={TrendingUp}\n            data-testid=\"metric-completion-rate\"\n          />\n          <MetricCard\n            title=\"Budget Used\"\n            value={formatCurrency(stats.actualCost)}\n            change={stats.budgetUsed > 80 ? 5 : -3}\n            icon={DollarSign}\n            data-testid=\"metric-budget-used\"\n          />\n          <MetricCard\n            title=\"Open Risks\"\n            value={stats.openRisks.toString()}\n            change={stats.openRisks > 5 ? 10 : -15}\n            icon={AlertTriangle}\n            data-testid=\"metric-open-risks\"\n          />\n        </div>\n      )}\n\n      <Tabs defaultValue=\"overview\" className=\"w-full\">\n        <TabsList>\n          <TabsTrigger value=\"overview\" data-testid=\"tab-overview\">Overview</TabsTrigger>\n          <TabsTrigger value=\"eva\" data-testid=\"tab-eva\">\n            <Activity className=\"h-4 w-4 mr-2\" />\n            S-Curve & EVA\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"overview\" className=\"space-y-4 mt-4\">\n          <div className=\"grid gap-4 md:grid-cols-2\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Work Breakdown Progress</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            {isLoading ? (\n              <div className=\"space-y-4\">\n                <Skeleton className=\"h-12\" />\n                <Skeleton className=\"h-12\" />\n                <Skeleton className=\"h-12\" />\n              </div>\n            ) : wbsProgress.length > 0 ? (\n              wbsProgress.map((wbs) => (\n                <div key={wbs.wbsCode}>\n                  <div className=\"flex items-center justify-between gap-2 mb-2 flex-wrap\">\n                    <div className=\"flex items-center gap-2\">\n                      <span className=\"text-sm font-medium\">{wbs.name}</span>\n                      <Badge variant=\"secondary\">WBS {wbs.wbsCode}</Badge>\n                    </div>\n                    <span className=\"text-sm font-semibold\">{wbs.progress}%</span>\n                  </div>\n                  <Progress value={wbs.progress} className=\"h-2\" />\n                </div>\n              ))\n            ) : (\n              <p className=\"text-sm text-muted-foreground text-center py-4\">\n                No WBS items found. Add tasks to see progress.\n              </p>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Recent Activity</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            {isLoading ? (\n              <div className=\"space-y-4\">\n                <Skeleton className=\"h-12\" />\n                <Skeleton className=\"h-12\" />\n                <Skeleton className=\"h-12\" />\n              </div>\n            ) : recentItems.length > 0 ? (\n              recentItems.map((item) => (\n                <div key={item.id} className=\"flex items-start gap-3\">\n                  {item.type === 'risk' ? (\n                    <AlertTriangle className=\"h-5 w-5 text-chart-2 mt-0.5\" />\n                  ) : (\n                    <Clock className=\"h-5 w-5 text-chart-1 mt-0.5\" />\n                  )}\n                  <div className=\"flex-1 min-w-0\">\n                    <p className=\"text-sm font-medium truncate\">\n                      {item.type === 'risk' ? 'Risk: ' : 'Issue: '}{item.title}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\">\n                      {formatTimeAgo(item.date)}\n                    </p>\n                  </div>\n                </div>\n              ))\n            ) : (\n              <p className=\"text-sm text-muted-foreground text-center py-4\">\n                No recent activity to display.\n              </p>\n            )}\n          </CardContent>\n        </Card>\n          </div>\n\n          <Card>\n            <CardHeader>\n              <CardTitle>Critical & High Priority Tasks</CardTitle>\n            </CardHeader>\n            <CardContent>\n              {isLoading ? (\n                <div className=\"space-y-3\">\n                  <Skeleton className=\"h-12\" />\n                  <Skeleton className=\"h-12\" />\n                  <Skeleton className=\"h-12\" />\n                </div>\n              ) : criticalTasks.length > 0 ? (\n                <div className=\"space-y-3\">\n                  {criticalTasks.map((task) => (\n                    <div key={task.id} className=\"flex items-center gap-4 flex-wrap\" data-testid={`critical-task-${task.id}`}>\n                      <Badge variant=\"outline\" className=\"font-mono\">{task.wbsCode}</Badge>\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center justify-between gap-2 mb-1 flex-wrap\">\n                          <span className=\"text-sm font-medium truncate\">{task.name}</span>\n                          <Badge \n                            variant={task.priority === 'critical' ? 'destructive' : 'secondary'}\n                          >\n                            {task.status === 'not-started' ? 'Not Started' : \n                             task.status === 'in-progress' ? 'In Progress' : \n                             task.status}\n                          </Badge>\n                        </div>\n                        <Progress value={task.progress} className=\"h-1.5\" />\n                      </div>\n                      <span className=\"text-sm text-muted-foreground w-12 text-right\">{task.progress}%</span>\n                    </div>\n                  ))}\n                </div>\n              ) : (\n                <p className=\"text-sm text-muted-foreground text-center py-4\">\n                  No critical or high priority tasks pending.\n                </p>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"eva\" className=\"space-y-4 mt-4\">\n          {isLoading ? (\n            <div className=\"grid gap-4 md:grid-cols-2\">\n              <Skeleton className=\"h-[400px]\" />\n              <Skeleton className=\"h-[400px]\" />\n            </div>\n          ) : (\n            <>\n              <SCurveChart \n                tasks={tasks} \n                projectStartDate={projectStartDate}\n                projectEndDate={projectEndDate}\n              />\n\n              <div className=\"grid gap-4 md:grid-cols-2\">\n                <PerformanceGauges tasks={tasks} costItems={costItems} />\n                <DisciplineProgress tasks={tasks} />\n              </div>\n\n              <RiskExposureSummary risks={risks} totalBudget={stats.totalBudget} />\n            </>\n          )}\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n","size_bytes":16155},"client/src/App.tsx":{"content":"import { Switch, Route } from \"wouter\";\nimport { useEffect } from \"react\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { SidebarProvider } from \"@/components/ui/sidebar\";\nimport { AppSidebar } from \"@/components/AppSidebar\";\nimport { TopBar } from \"@/components/TopBar\";\nimport { ContextAwareRightRail } from \"@/components/widgets/ContextAwareRightRail\";\nimport { ThemeProvider } from \"@/contexts/ThemeContext\";\nimport { ProjectProvider } from \"@/contexts/ProjectContext\";\nimport { PageProvider } from \"@/contexts/PageContext\";\nimport { AIPromptProvider } from \"@/contexts/AIPromptContext\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { initGA } from \"@/lib/analytics\";\nimport { useAnalytics } from \"@/hooks/use-analytics\";\nimport LandingPage from \"@/pages/LandingPage\";\nimport Dashboard from \"@/pages/Dashboard\";\nimport WBSPage from \"@/pages/WBSPage\";\nimport GanttPage from \"@/pages/GanttPage\";\nimport KanbanPage from \"@/pages/KanbanPage\";\nimport CalendarPage from \"@/pages/CalendarPage\";\nimport StakeholdersPage from \"@/pages/StakeholdersPage\";\nimport RACIMatrixPage from \"@/pages/RACIMatrixPage\";\nimport RisksPage from \"@/pages/RisksPage\";\nimport IssuesPage from \"@/pages/IssuesPage\";\nimport CostPage from \"@/pages/CostPage\";\nimport AIAssistantPage from \"@/pages/AIAssistantPage\";\nimport ReportsPage from \"@/pages/ReportsPage\";\nimport EmailTemplatesPage from \"@/pages/EmailTemplatesPage\";\nimport SettingsPage from \"@/pages/SettingsPage\";\nimport AdminDashboard from \"@/pages/AdminDashboard\";\nimport ResourcesPage from \"@/pages/ResourcesPage\";\nimport AnalyticsPage from \"@/pages/AnalyticsPage\";\nimport DocumentsPage from \"@/pages/DocumentsPage\";\nimport PMODashboardPage from \"@/pages/PMODashboardPage\";\nimport PMOCalendarPage from \"@/pages/PMOCalendarPage\";\nimport PMOInventoryPage from \"@/pages/PMOInventoryPage\";\nimport NotFound from \"@/pages/not-found\";\n\nfunction Router() {\n  // Track page views when routes change\n  useAnalytics();\n  \n  return (\n    <Switch>\n      <Route path=\"/\" component={Dashboard} />\n      <Route path=\"/wbs\" component={WBSPage} />\n      <Route path=\"/gantt\" component={GanttPage} />\n      <Route path=\"/kanban\" component={KanbanPage} />\n      <Route path=\"/calendar\" component={CalendarPage} />\n      <Route path=\"/stakeholders\" component={StakeholdersPage} />\n      <Route path=\"/raci-matrix\" component={RACIMatrixPage} />\n      <Route path=\"/resources\" component={ResourcesPage} />\n      <Route path=\"/risks\" component={RisksPage} />\n      <Route path=\"/issues\" component={IssuesPage} />\n      <Route path=\"/change-requests\">\n        <div className=\"p-6\">\n          <h1 className=\"text-3xl font-semibold\">Change Requests</h1>\n          <p className=\"text-muted-foreground\">Change request management coming soon</p>\n        </div>\n      </Route>\n      <Route path=\"/cost\" component={CostPage} />\n      <Route path=\"/documents\" component={DocumentsPage} />\n      <Route path=\"/analytics\" component={AnalyticsPage} />\n      <Route path=\"/reports\" component={ReportsPage} />\n      <Route path=\"/email-templates\" component={EmailTemplatesPage} />\n      <Route path=\"/ai-assistant\" component={AIAssistantPage} />\n      <Route path=\"/settings\" component={SettingsPage} />\n      <Route path=\"/pmo/dashboard\" component={PMODashboardPage} />\n      <Route path=\"/pmo/calendar\" component={PMOCalendarPage} />\n      <Route path=\"/pmo/inventory\" component={PMOInventoryPage} />\n      <Route path=\"/admin\" component={AdminDashboard} />\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction AuthenticatedApp() {\n  const sidebarStyle = {\n    \"--sidebar-width\": \"16rem\",\n    \"--sidebar-width-icon\": \"3rem\",\n  } as React.CSSProperties;\n\n  return (\n    <ProjectProvider>\n      <PageProvider>\n        <AIPromptProvider>\n          <SidebarProvider style={sidebarStyle} defaultOpen={false}>\n            <div className=\"flex h-screen w-full\">\n              <AppSidebar />\n              <div className=\"flex flex-col flex-1 overflow-hidden min-w-0\">\n                <TopBar />\n                <div className=\"flex flex-1 overflow-hidden\">\n                  <main className=\"flex-1 overflow-y-auto bg-background\">\n                    <Router />\n                  </main>\n                  <div className=\"hidden lg:block\">\n                    <ContextAwareRightRail />\n                  </div>\n                </div>\n              </div>\n            </div>\n          </SidebarProvider>\n          <Toaster />\n        </AIPromptProvider>\n      </PageProvider>\n    </ProjectProvider>\n  );\n}\n\nfunction AppContent() {\n  const { isAuthenticated, isLoading } = useAuth();\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <p className=\"text-muted-foreground\">Loading...</p>\n      </div>\n    );\n  }\n\n  return isAuthenticated ? <AuthenticatedApp /> : <LandingPage />;\n}\n\nexport default function App() {\n  // Initialize Google Analytics when app loads\n  useEffect(() => {\n    if (!import.meta.env.VITE_GA_MEASUREMENT_ID) {\n      console.warn('Missing Google Analytics Measurement ID: VITE_GA_MEASUREMENT_ID');\n    } else {\n      initGA();\n    }\n  }, []);\n\n  return (\n    <QueryClientProvider client={queryClient}>\n      <TooltipProvider>\n        <ThemeProvider>\n          <AppContent />\n        </ThemeProvider>\n      </TooltipProvider>\n    </QueryClientProvider>\n  );\n}\n","size_bytes":5530},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","size_bytes":1280},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","size_bytes":3895},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","size_bytes":1642},"client/src/components/examples/CostPage.tsx":{"content":"import CostPage from '@/pages/CostPage';\n\nexport default function CostPageExample() {\n  return <CostPage />;\n}\n","size_bytes":111},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","size_bytes":1977},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","size_bytes":4885},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","size_bytes":3848},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \".5625rem\", /* 9px */\n        md: \".375rem\", /* 6px */\n        sm: \".1875rem\", /* 3px */\n      },\n      colors: {\n        // Flat / base colors (regular buttons)\n        background: \"hsl(var(--background) / <alpha-value>)\",\n        foreground: \"hsl(var(--foreground) / <alpha-value>)\",\n        border: \"hsl(var(--border) / <alpha-value>)\",\n        input: \"hsl(var(--input) / <alpha-value>)\",\n        card: {\n          DEFAULT: \"hsl(var(--card) / <alpha-value>)\",\n          foreground: \"hsl(var(--card-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--card-border) / <alpha-value>)\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover) / <alpha-value>)\",\n          foreground: \"hsl(var(--popover-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--popover-border) / <alpha-value>)\",\n        },\n        primary: {\n          DEFAULT: \"hsl(var(--primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--primary-foreground) / <alpha-value>)\",\n          border: \"var(--primary-border)\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary) / <alpha-value>)\",\n          foreground: \"hsl(var(--secondary-foreground) / <alpha-value>)\",\n          border: \"var(--secondary-border)\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted) / <alpha-value>)\",\n          foreground: \"hsl(var(--muted-foreground) / <alpha-value>)\",\n          border: \"var(--muted-border)\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--accent-foreground) / <alpha-value>)\",\n          border: \"var(--accent-border)\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive) / <alpha-value>)\",\n          foreground: \"hsl(var(--destructive-foreground) / <alpha-value>)\",\n          border: \"var(--destructive-border)\",\n        },\n        ring: \"hsl(var(--ring) / <alpha-value>)\",\n        chart: {\n          \"1\": \"hsl(var(--chart-1) / <alpha-value>)\",\n          \"2\": \"hsl(var(--chart-2) / <alpha-value>)\",\n          \"3\": \"hsl(var(--chart-3) / <alpha-value>)\",\n          \"4\": \"hsl(var(--chart-4) / <alpha-value>)\",\n          \"5\": \"hsl(var(--chart-5) / <alpha-value>)\",\n        },\n        sidebar: {\n          ring: \"hsl(var(--sidebar-ring) / <alpha-value>)\",\n          DEFAULT: \"hsl(var(--sidebar) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-foreground) / <alpha-value>)\",\n          border: \"hsl(var(--sidebar-border) / <alpha-value>)\",\n        },\n        \"sidebar-primary\": {\n          DEFAULT: \"hsl(var(--sidebar-primary) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-primary-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-primary-border)\",\n        },\n        \"sidebar-accent\": {\n          DEFAULT: \"hsl(var(--sidebar-accent) / <alpha-value>)\",\n          foreground: \"hsl(var(--sidebar-accent-foreground) / <alpha-value>)\",\n          border: \"var(--sidebar-accent-border)\"\n        },\n        status: {\n          online: \"rgb(34 197 94)\",\n          away: \"rgb(245 158 11)\",\n          busy: \"rgb(239 68 68)\",\n          offline: \"rgb(156 163 175)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: \"0\" },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: \"0\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","size_bytes":4050},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n  \" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground border border-destructive-border\",\n        outline:\n          // Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color.\n          \" border [border-color:var(--button-outline)]  shadow-xs active:shadow-none \",\n        secondary: \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // Add a transparent border so that when someone toggles a border on later, it doesn't shift layout/size.\n        ghost: \"border border-transparent\",\n      },\n      // Heights are set as \"min\" heights, because sometimes Ai will place large amount of content\n      // inside buttons. With a min-height they will look appropriate with small amounts of content,\n      // but will expand to fit large amounts of content.\n      size: {\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  },\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  },\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","size_bytes":2359},"client/src/components/RightSidebar.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  TrendingUp, TrendingDown, AlertTriangle, CheckCircle2, \n  Clock, Users, Package, FileText, Loader2, Target, \n  DollarSign, AlertCircle, Calendar, BarChart3 \n} from \"lucide-react\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { useLocation } from \"wouter\";\nimport type { Task, Risk, Issue, Resource, Document, CostItem } from \"@shared/schema\";\n\ninterface MetricItemProps {\n  label: string;\n  value: string | number;\n  trend?: \"up\" | \"down\";\n  trendValue?: string;\n  icon?: React.ReactNode;\n}\n\nfunction MetricItem({ label, value, trend, trendValue, icon }: MetricItemProps) {\n  return (\n    <div className=\"flex items-center justify-between py-2\">\n      <div className=\"flex items-center gap-2\">\n        {icon}\n        <span className=\"text-sm text-muted-foreground\">{label}</span>\n      </div>\n      <div className=\"flex items-center gap-2\">\n        <span className=\"text-sm font-semibold\">{value}</span>\n        {trend && trendValue && (\n          <Badge variant=\"secondary\" className=\"gap-1\">\n            {trend === \"up\" ? <TrendingUp className=\"h-3 w-3\" /> : <TrendingDown className=\"h-3 w-3\" />}\n            {trendValue}\n          </Badge>\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction LoadingCard({ title }: { title: string }) {\n  return (\n    <Card>\n      <CardHeader className=\"pb-3\">\n        <CardTitle className=\"text-base\">{title}</CardTitle>\n      </CardHeader>\n      <CardContent className=\"flex items-center justify-center py-8\">\n        <Loader2 className=\"h-5 w-5 animate-spin text-muted-foreground\" />\n      </CardContent>\n    </Card>\n  );\n}\n\nexport function RightSidebar() {\n  const { selectedProjectId } = useProject();\n  const [location] = useLocation();\n\n  const { data: tasks = [], isLoading: tasksLoading } = useQuery<Task[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/tasks`],\n    enabled: !!selectedProjectId,\n  });\n\n  const { data: risks = [], isLoading: risksLoading } = useQuery<Risk[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/risks`],\n    enabled: !!selectedProjectId,\n  });\n\n  const { data: issues = [], isLoading: issuesLoading } = useQuery<Issue[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/issues`],\n    enabled: !!selectedProjectId,\n  });\n\n  const { data: resources = [], isLoading: resourcesLoading } = useQuery<Resource[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/resources`],\n    enabled: !!selectedProjectId,\n  });\n\n  const { data: documents = [], isLoading: documentsLoading } = useQuery<Document[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/documents`],\n    enabled: !!selectedProjectId,\n  });\n\n  const { data: costs = [], isLoading: costsLoading } = useQuery<CostItem[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/costs`],\n    enabled: !!selectedProjectId,\n  });\n\n  const taskStats = {\n    total: tasks.length,\n    completed: tasks.filter(t => t.status === \"completed\").length,\n    inProgress: tasks.filter(t => t.status === \"in-progress\").length,\n    review: tasks.filter(t => t.status === \"review\").length,\n    notStarted: tasks.filter(t => t.status === \"not-started\").length,\n    onHold: tasks.filter(t => t.status === \"on-hold\").length,\n    overdue: tasks.filter(t => t.endDate && new Date(t.endDate) < new Date() && t.status !== \"completed\").length,\n    progress: tasks.length > 0 ? Math.round((tasks.reduce((sum, t) => sum + (t.progress || 0), 0) / tasks.length)) : 0,\n  };\n\n  const riskStats = {\n    total: risks.length,\n    high: risks.filter(r => (r as any).probability === \"high\" || (r as any).impact === \"high\").length,\n    critical: risks.filter(r => (r as any).probability === \"high\" && (r as any).impact === \"high\").length,\n    open: risks.filter(r => r.status === \"identified\" || r.status === \"assessed\" || r.status === \"mitigating\").length,\n  };\n\n  const issueStats = {\n    total: issues.length,\n    open: issues.filter(i => i.status === \"open\" || i.status === \"in-progress\").length,\n    critical: issues.filter(i => i.priority === \"critical\" || i.priority === \"high\").length,\n    overdue: issues.filter(i => i.targetResolutionDate && new Date(i.targetResolutionDate) < new Date() && i.status !== \"closed\" && i.status !== \"resolved\").length,\n  };\n\n  const resourceStats = {\n    total: resources.length,\n    human: resources.filter(r => r.type === \"human\").length,\n    equipment: resources.filter(r => r.type === \"equipment\").length,\n    avgAvailability: resources.length > 0 ? Math.round(resources.reduce((sum, r) => sum + (r.availability || 0), 0) / resources.length) : 0,\n  };\n\n  const documentStats = {\n    total: documents.length,\n    draft: documents.filter(d => d.status === \"draft\").length,\n    approved: documents.filter(d => d.status === \"ifc\" || d.status === \"as-built\").length,\n  };\n\n  const costStats = {\n    budgeted: costs.reduce((sum, c) => sum + Number(c.budgeted || 0), 0),\n    actual: costs.reduce((sum, c) => sum + Number(c.actual || 0), 0),\n    variance: 0,\n  };\n  costStats.variance = costStats.budgeted - costStats.actual;\n\n  const formatCurrency = (amount: number) => {\n    if (amount >= 1000000) return `$${(amount / 1000000).toFixed(1)}M`;\n    if (amount >= 1000) return `$${(amount / 1000).toFixed(0)}K`;\n    return `$${amount.toFixed(0)}`;\n  };\n\n  const currentPage = location.split(\"/\")[1] || \"dashboard\";\n\n  if (!selectedProjectId) {\n    return (\n      <aside className=\"w-80 border-l bg-background p-4 overflow-y-auto\" data-testid=\"sidebar-right\">\n        <Card>\n          <CardContent className=\"py-8 text-center\">\n            <p className=\"text-sm text-muted-foreground\">Select a project to view metrics</p>\n          </CardContent>\n        </Card>\n      </aside>\n    );\n  }\n\n  return (\n    <aside className=\"w-80 border-l bg-background p-4 overflow-y-auto\" data-testid=\"sidebar-right\">\n      <div className=\"space-y-4\">\n        {tasksLoading ? (\n          <LoadingCard title=\"Project Health\" />\n        ) : (\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-base flex items-center gap-2\">\n                <Target className=\"h-4 w-4\" />\n                Project Health\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div>\n                <div className=\"flex items-center justify-between mb-2\">\n                  <span className=\"text-sm font-medium\">Overall Progress</span>\n                  <span className=\"text-sm font-semibold\">{taskStats.progress}%</span>\n                </div>\n                <Progress value={taskStats.progress} className=\"h-2\" data-testid=\"progress-overall\" />\n              </div>\n              <div className=\"space-y-2\">\n                <MetricItem \n                  label=\"Tasks Completed\" \n                  value={`${taskStats.completed}/${taskStats.total}`}\n                  icon={<CheckCircle2 className=\"h-4 w-4 text-green-500\" />}\n                />\n                {taskStats.overdue > 0 && (\n                  <MetricItem \n                    label=\"Overdue Tasks\" \n                    value={taskStats.overdue}\n                    icon={<AlertTriangle className=\"h-4 w-4 text-destructive\" />}\n                  />\n                )}\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        {(currentPage === \"wbs\" || currentPage === \"dashboard\" || currentPage === \"\") && (\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-base flex items-center gap-2\">\n                <BarChart3 className=\"h-4 w-4\" />\n                Task Status\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-2\">\n                  <div className=\"h-3 w-3 rounded-full bg-green-500\" />\n                  <span className=\"text-sm\">Completed</span>\n                </div>\n                <span className=\"text-sm font-semibold\">{taskStats.completed}</span>\n              </div>\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-2\">\n                  <div className=\"h-3 w-3 rounded-full bg-blue-500\" />\n                  <span className=\"text-sm\">In Progress</span>\n                </div>\n                <span className=\"text-sm font-semibold\">{taskStats.inProgress}</span>\n              </div>\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-2\">\n                  <div className=\"h-3 w-3 rounded-full bg-purple-500\" />\n                  <span className=\"text-sm\">In Review</span>\n                </div>\n                <span className=\"text-sm font-semibold\">{taskStats.review}</span>\n              </div>\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-2\">\n                  <div className=\"h-3 w-3 rounded-full bg-gray-400\" />\n                  <span className=\"text-sm\">Not Started</span>\n                </div>\n                <span className=\"text-sm font-semibold\">{taskStats.notStarted}</span>\n              </div>\n              {taskStats.onHold > 0 && (\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center gap-2\">\n                    <div className=\"h-3 w-3 rounded-full bg-amber-500\" />\n                    <span className=\"text-sm\">On Hold</span>\n                  </div>\n                  <span className=\"text-sm font-semibold\">{taskStats.onHold}</span>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        )}\n\n        {(currentPage === \"risks\" || currentPage === \"dashboard\" || currentPage === \"\") && !risksLoading && (\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-base flex items-center gap-2\">\n                <AlertTriangle className=\"h-4 w-4 text-amber-500\" />\n                Risk Summary\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-2\">\n              <MetricItem label=\"Total Risks\" value={riskStats.total} />\n              <MetricItem label=\"Open Risks\" value={riskStats.open} />\n              {riskStats.high > 0 && (\n                <MetricItem \n                  label=\"High Priority\" \n                  value={riskStats.high}\n                  icon={<AlertCircle className=\"h-4 w-4 text-amber-500\" />}\n                />\n              )}\n              {riskStats.critical > 0 && (\n                <div className=\"pt-2 border-t\">\n                  <Badge variant=\"destructive\" className=\"w-full justify-center\">\n                    {riskStats.critical} Critical Risk{riskStats.critical !== 1 ? \"s\" : \"\"}\n                  </Badge>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        )}\n\n        {(currentPage === \"issues\" || currentPage === \"dashboard\" || currentPage === \"\") && !issuesLoading && (\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-base flex items-center gap-2\">\n                <AlertCircle className=\"h-4 w-4 text-red-500\" />\n                Issue Tracker\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-2\">\n              <MetricItem label=\"Total Issues\" value={issueStats.total} />\n              <MetricItem label=\"Open Issues\" value={issueStats.open} />\n              {issueStats.critical > 0 && (\n                <MetricItem \n                  label=\"Critical/High\" \n                  value={issueStats.critical}\n                  icon={<AlertTriangle className=\"h-4 w-4 text-destructive\" />}\n                />\n              )}\n              {issueStats.overdue > 0 && (\n                <div className=\"pt-2 border-t\">\n                  <Badge variant=\"destructive\" className=\"w-full justify-center\">\n                    {issueStats.overdue} Overdue\n                  </Badge>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        )}\n\n        {(currentPage === \"resources\" || currentPage === \"dashboard\" || currentPage === \"\") && !resourcesLoading && (\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-base flex items-center gap-2\">\n                <Users className=\"h-4 w-4\" />\n                Resources\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-2\">\n              <MetricItem label=\"Team Members\" value={resourceStats.human} icon={<Users className=\"h-4 w-4\" />} />\n              <MetricItem label=\"Equipment\" value={resourceStats.equipment} icon={<Package className=\"h-4 w-4\" />} />\n              <MetricItem \n                label=\"Avg Availability\" \n                value={`${resourceStats.avgAvailability}%`}\n                trend={resourceStats.avgAvailability >= 80 ? \"up\" : \"down\"}\n                trendValue={resourceStats.avgAvailability >= 80 ? \"Good\" : \"Low\"}\n              />\n            </CardContent>\n          </Card>\n        )}\n\n        {(currentPage === \"sop\" || currentPage === \"documents\") && !documentsLoading && (\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-base flex items-center gap-2\">\n                <FileText className=\"h-4 w-4\" />\n                Documents\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-2\">\n              <MetricItem label=\"Total Documents\" value={documentStats.total} />\n              <MetricItem label=\"Drafts\" value={documentStats.draft} />\n              <MetricItem label=\"Approved/IFC\" value={documentStats.approved} />\n            </CardContent>\n          </Card>\n        )}\n\n        {(currentPage === \"cost\" || currentPage === \"analytics\" || currentPage === \"dashboard\" || currentPage === \"\") && !costsLoading && (\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-base flex items-center gap-2\">\n                <DollarSign className=\"h-4 w-4\" />\n                Cost Summary\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-2\">\n              <MetricItem label=\"Budgeted\" value={formatCurrency(costStats.budgeted)} />\n              <MetricItem label=\"Actual Spend\" value={formatCurrency(costStats.actual)} />\n              <MetricItem \n                label=\"Variance\" \n                value={formatCurrency(Math.abs(costStats.variance))}\n                trend={costStats.variance >= 0 ? \"up\" : \"down\"}\n                trendValue={costStats.variance >= 0 ? \"Under\" : \"Over\"}\n              />\n            </CardContent>\n          </Card>\n        )}\n\n        {(currentPage === \"calendar\" || currentPage === \"gantt\") && (\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-base flex items-center gap-2\">\n                <Calendar className=\"h-4 w-4\" />\n                Upcoming Deadlines\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-2\">\n              {tasks\n                .filter(t => t.endDate && new Date(t.endDate) >= new Date() && t.status !== \"completed\")\n                .sort((a, b) => new Date(a.endDate!).getTime() - new Date(b.endDate!).getTime())\n                .slice(0, 5)\n                .map(task => (\n                  <div key={task.id} className=\"flex items-center justify-between py-1\">\n                    <span className=\"text-xs truncate max-w-[150px]\">{task.name}</span>\n                    <span className=\"text-xs text-muted-foreground\">\n                      {new Date(task.endDate!).toLocaleDateString(\"en-US\", { month: \"short\", day: \"numeric\" })}\n                    </span>\n                  </div>\n                ))}\n              {tasks.filter(t => t.endDate && new Date(t.endDate) >= new Date() && t.status !== \"completed\").length === 0 && (\n                <p className=\"text-sm text-muted-foreground text-center py-4\">No upcoming deadlines</p>\n              )}\n            </CardContent>\n          </Card>\n        )}\n      </div>\n    </aside>\n  );\n}\n","size_bytes":16506},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","size_bytes":5741},"client/src/components/examples/StakeholdersPage.tsx":{"content":"import StakeholdersPage from '@/pages/StakeholdersPage';\n\nexport default function StakeholdersPageExample() {\n  return <StakeholdersPage />;\n}\n","size_bytes":143},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","size_bytes":2765},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","size_bytes":1080},"client/src/pages/CostPage.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { MetricCard } from \"@/components/MetricCard\";\nimport { DollarSign, TrendingUp, TrendingDown, AlertTriangle, Plus, Pencil, Trash2, FolderKanban } from \"lucide-react\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport type { CostItem, Task } from \"@shared/schema\";\n\nconst COST_CATEGORIES = ['labor', 'materials', 'equipment', 'subcontractor', 'overhead', 'other'] as const;\n\ninterface CostFormData {\n  category: string;\n  description: string;\n  budgeted: string;\n  actual: string;\n  currency: string;\n  taskId?: number;\n}\n\nfunction formatCurrency(value: number, currency: string = 'USD'): string {\n  return new Intl.NumberFormat('en-US', {\n    style: 'currency',\n    currency: currency,\n    minimumFractionDigits: 0,\n    maximumFractionDigits: 0,\n  }).format(value);\n}\n\nfunction formatShortCurrency(value: number): string {\n  if (value >= 1000000) {\n    return `$${(value / 1000000).toFixed(1)}M`;\n  }\n  if (value >= 1000) {\n    return `$${(value / 1000).toFixed(0)}K`;\n  }\n  return `$${value.toFixed(0)}`;\n}\n\nfunction parseNumeric(value: string): number {\n  const num = parseFloat(value);\n  return isNaN(num) ? 0 : num;\n}\n\ninterface CategoryBreakdown {\n  category: string;\n  budgeted: number;\n  actual: number;\n  variance: number;\n  itemCount: number;\n}\n\nfunction aggregateCostsByCategory(costItems: CostItem[]): CategoryBreakdown[] {\n  const categoryMap = new Map<string, { budgeted: number; actual: number; count: number }>();\n  \n  costItems.forEach(item => {\n    const cat = item.category || 'other';\n    const existing = categoryMap.get(cat) || { budgeted: 0, actual: 0, count: 0 };\n    existing.budgeted += parseNumeric(item.budgeted);\n    existing.actual += parseNumeric(item.actual);\n    existing.count += 1;\n    categoryMap.set(cat, existing);\n  });\n  \n  return Array.from(categoryMap.entries())\n    .map(([category, data]) => ({\n      category,\n      budgeted: data.budgeted,\n      actual: data.actual,\n      variance: data.actual - data.budgeted,\n      itemCount: data.count\n    }))\n    .sort((a, b) => b.budgeted - a.budgeted);\n}\n\ninterface EarnedValueMetrics {\n  pv: number;\n  ev: number;\n  ac: number;\n  cpi: number;\n  spi: number;\n  cv: number;\n  sv: number;\n}\n\nfunction calculateEarnedValue(\n  costItems: CostItem[],\n  tasks: Task[]\n): EarnedValueMetrics {\n  const totalBudget = costItems.reduce((sum, c) => sum + parseNumeric(c.budgeted), 0);\n  const actualCost = costItems.reduce((sum, c) => sum + parseNumeric(c.actual), 0);\n  \n  const totalTasks = tasks.length;\n  const completedTasks = tasks.filter(t => t.status === 'completed').length;\n  const avgProgress = totalTasks > 0 \n    ? tasks.reduce((sum, t) => sum + (t.progress || 0), 0) / totalTasks / 100\n    : 0;\n  \n  const plannedProgress = totalTasks > 0 \n    ? tasks.filter(t => {\n        if (!t.endDate) return false;\n        return new Date(t.endDate) <= new Date();\n      }).length / totalTasks\n    : 0.5;\n  \n  const pv = totalBudget * Math.max(plannedProgress, 0.1);\n  const ev = totalBudget * avgProgress;\n  const ac = actualCost;\n  \n  const cpi = ac > 0 ? ev / ac : (ev > 0 ? 1 : 0);\n  const spi = pv > 0 ? ev / pv : (ev > 0 ? 1 : 0);\n  const cv = ev - ac;\n  const sv = ev - pv;\n  \n  return { pv, ev, ac, cpi, spi, cv, sv };\n}\n\nexport default function CostPage() {\n  const { selectedProject } = useProject();\n  const { toast } = useToast();\n  const projectId = selectedProject?.id;\n  const projectCurrency = selectedProject?.currency || 'USD';\n\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [editingItem, setEditingItem] = useState<CostItem | null>(null);\n  const [formData, setFormData] = useState<CostFormData>({\n    category: 'labor',\n    description: '',\n    budgeted: '',\n    actual: '0',\n    currency: projectCurrency,\n    taskId: undefined,\n  });\n  const [formErrors, setFormErrors] = useState<Record<string, string>>({});\n\n  const { data: costItems = [], isLoading } = useQuery<CostItem[]>({\n    queryKey: ['/api/projects', projectId, 'costs'],\n    enabled: !!projectId,\n    retry: 1,\n    queryFn: async () => {\n      const res = await fetch(`/api/projects/${projectId}/costs`, { credentials: 'include' });\n      if (res.status === 401) return [];\n      if (!res.ok) throw new Error('Failed to fetch costs');\n      return res.json();\n    }\n  });\n\n  const { data: tasks = [] } = useQuery<Task[]>({\n    queryKey: ['/api/projects', projectId, 'tasks'],\n    enabled: !!projectId,\n    retry: 1,\n    queryFn: async () => {\n      const res = await fetch(`/api/projects/${projectId}/tasks`, { credentials: 'include' });\n      if (res.status === 401) return [];\n      if (!res.ok) throw new Error('Failed to fetch tasks');\n      return res.json();\n    }\n  });\n\n  const validateForm = (): boolean => {\n    const errors: Record<string, string> = {};\n    \n    if (!formData.description.trim()) {\n      errors.description = 'Description is required';\n    }\n    \n    const budgetedNum = parseFloat(formData.budgeted);\n    if (isNaN(budgetedNum) || budgetedNum < 0) {\n      errors.budgeted = 'Please enter a valid positive number';\n    }\n    \n    const actualNum = parseFloat(formData.actual);\n    if (formData.actual && (isNaN(actualNum) || actualNum < 0)) {\n      errors.actual = 'Please enter a valid positive number';\n    }\n    \n    setFormErrors(errors);\n    return Object.keys(errors).length === 0;\n  };\n\n  const createMutation = useMutation({\n    mutationFn: async (data: CostFormData) => {\n      const budgetedNum = parseFloat(data.budgeted) || 0;\n      const actualNum = parseFloat(data.actual) || 0;\n      \n      const response = await apiRequest('POST', `/api/costs`, {\n        projectId,\n        category: data.category,\n        description: data.description.trim(),\n        budgeted: budgetedNum.toString(),\n        actual: actualNum.toString(),\n        currency: data.currency,\n        taskId: data.taskId || null,\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: 'Cost item created successfully' });\n      queryClient.invalidateQueries({ queryKey: ['/api/projects', projectId, 'costs'] });\n      handleCloseDialog();\n    },\n    onError: (error: Error) => {\n      toast({ title: 'Failed to create cost item', description: error.message, variant: 'destructive' });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: number; data: CostFormData }) => {\n      const budgetedNum = parseFloat(data.budgeted) || 0;\n      const actualNum = parseFloat(data.actual) || 0;\n      \n      const response = await apiRequest('PATCH', `/api/costs/${id}`, {\n        category: data.category,\n        description: data.description.trim(),\n        budgeted: budgetedNum.toString(),\n        actual: actualNum.toString(),\n        currency: data.currency,\n        taskId: data.taskId || null,\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({ title: 'Cost item updated successfully' });\n      queryClient.invalidateQueries({ queryKey: ['/api/projects', projectId, 'costs'] });\n      handleCloseDialog();\n    },\n    onError: (error: Error) => {\n      toast({ title: 'Failed to update cost item', description: error.message, variant: 'destructive' });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: number) => {\n      await apiRequest('DELETE', `/api/costs/${id}`);\n    },\n    onSuccess: () => {\n      toast({ title: 'Cost item deleted successfully' });\n      queryClient.invalidateQueries({ queryKey: ['/api/projects', projectId, 'costs'] });\n    },\n    onError: (error: Error) => {\n      toast({ title: 'Failed to delete cost item', description: error.message, variant: 'destructive' });\n    },\n  });\n\n  const handleOpenDialog = (item?: CostItem) => {\n    setFormErrors({});\n    if (item) {\n      setEditingItem(item);\n      setFormData({\n        category: item.category,\n        description: item.description,\n        budgeted: item.budgeted,\n        actual: item.actual,\n        currency: item.currency,\n        taskId: item.taskId || undefined,\n      });\n    } else {\n      setEditingItem(null);\n      setFormData({\n        category: 'labor',\n        description: '',\n        budgeted: '',\n        actual: '0',\n        currency: projectCurrency,\n        taskId: undefined,\n      });\n    }\n    setIsDialogOpen(true);\n  };\n\n  const handleCloseDialog = () => {\n    setIsDialogOpen(false);\n    setEditingItem(null);\n    setFormErrors({});\n  };\n\n  const handleSubmit = () => {\n    if (!validateForm()) return;\n\n    if (editingItem) {\n      updateMutation.mutate({ id: editingItem.id, data: formData });\n    } else {\n      createMutation.mutate(formData);\n    }\n  };\n\n  if (!selectedProject) {\n    return (\n      <div className=\"p-6\">\n        <Alert>\n          <FolderKanban className=\"h-4 w-4\" />\n          <AlertDescription>\n            Please select a project to view cost management.\n          </AlertDescription>\n        </Alert>\n      </div>\n    );\n  }\n\n  const totalBudget = costItems.reduce((sum, c) => sum + parseNumeric(c.budgeted), 0);\n  const totalActual = costItems.reduce((sum, c) => sum + parseNumeric(c.actual), 0);\n  const variance = totalActual - totalBudget;\n  const variancePercent = totalBudget > 0 ? Math.round((variance / totalBudget) * 100) : 0;\n\n  const categoryBreakdown = aggregateCostsByCategory(costItems);\n  const earnedValue = calculateEarnedValue(costItems, tasks);\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n        <div>\n          <h1 className=\"text-3xl font-semibold\" data-testid=\"text-cost-title\">Cost Management</h1>\n          <p className=\"text-muted-foreground\">Budget tracking and cost analytics</p>\n        </div>\n        <Button onClick={() => handleOpenDialog()} data-testid=\"button-add-cost\">\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Add Cost Item\n        </Button>\n      </div>\n\n      {isLoading ? (\n        <div className=\"grid gap-4 md:grid-cols-4\">\n          <Skeleton className=\"h-32\" />\n          <Skeleton className=\"h-32\" />\n          <Skeleton className=\"h-32\" />\n          <Skeleton className=\"h-32\" />\n        </div>\n      ) : (\n        <div className=\"grid gap-4 md:grid-cols-4\">\n          <MetricCard\n            title=\"Total Budget\"\n            value={formatShortCurrency(totalBudget)}\n            icon={DollarSign}\n            data-testid=\"metric-total-budget\"\n          />\n          <MetricCard\n            title=\"Actual Cost\"\n            value={formatShortCurrency(totalActual)}\n            change={variancePercent < 0 ? Math.abs(variancePercent) : undefined}\n            icon={TrendingDown}\n            data-testid=\"metric-actual-cost\"\n          />\n          <MetricCard\n            title=\"Budget Remaining\"\n            value={formatShortCurrency(Math.max(0, totalBudget - totalActual))}\n            change={variancePercent > 0 ? -variancePercent : undefined}\n            icon={TrendingUp}\n            data-testid=\"metric-remaining\"\n          />\n          <MetricCard\n            title=\"Variance\"\n            value={`${variance >= 0 ? '+' : ''}${formatShortCurrency(variance)}`}\n            change={variancePercent}\n            icon={AlertTriangle}\n            data-testid=\"metric-variance\"\n          />\n        </div>\n      )}\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Cost Breakdown by Category</CardTitle>\n          <CardDescription>Budgeted vs actual costs per category</CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          {isLoading ? (\n            <div className=\"space-y-4\">\n              <Skeleton className=\"h-24\" />\n              <Skeleton className=\"h-24\" />\n            </div>\n          ) : categoryBreakdown.length > 0 ? (\n            categoryBreakdown.map((cat) => {\n              const budgetUsed = cat.budgeted > 0 ? (cat.actual / cat.budgeted) * 100 : 0;\n              const catVariancePercent = cat.budgeted > 0 ? (cat.variance / cat.budgeted) * 100 : 0;\n\n              return (\n                <div key={cat.category} className=\"space-y-3\">\n                  <div className=\"flex items-center justify-between gap-2 flex-wrap\">\n                    <div>\n                      <h3 className=\"font-semibold capitalize\">{cat.category}</h3>\n                      <p className=\"text-sm text-muted-foreground\">\n                        Budget: {formatCurrency(cat.budgeted, projectCurrency)} ({cat.itemCount} items)\n                      </p>\n                    </div>\n                    <div className=\"text-right\">\n                      <div className=\"font-semibold\">\n                        {formatCurrency(cat.actual, projectCurrency)}\n                      </div>\n                      <Badge\n                        variant={cat.variance > 0 ? \"destructive\" : \"default\"}\n                        className=\"mt-1\"\n                      >\n                        {cat.variance > 0 ? \"+\" : \"\"}\n                        {catVariancePercent.toFixed(1)}%\n                      </Badge>\n                    </div>\n                  </div>\n\n                  <div className=\"space-y-2\">\n                    <div className=\"flex items-center justify-between text-sm\">\n                      <span className=\"text-muted-foreground\">Budget Utilization</span>\n                      <span className=\"font-medium\">{budgetUsed.toFixed(1)}%</span>\n                    </div>\n                    <Progress \n                      value={Math.min(budgetUsed, 100)} \n                      className={`h-2 ${budgetUsed > 100 ? 'bg-destructive/20' : ''}`}\n                    />\n                  </div>\n                </div>\n              );\n            })\n          ) : (\n            <p className=\"text-sm text-muted-foreground text-center py-8\">\n              No cost items added yet. Click \"Add Cost Item\" to get started.\n            </p>\n          )}\n        </CardContent>\n      </Card>\n\n      <div className=\"grid gap-4 md:grid-cols-2\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Earned Value Analysis</CardTitle>\n            <CardDescription>Project performance metrics based on schedule and cost</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            {isLoading ? (\n              <Skeleton className=\"h-48\" />\n            ) : (\n              <>\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-sm text-muted-foreground\">Planned Value (PV)</span>\n                  <span className=\"font-semibold font-mono\">{formatCurrency(earnedValue.pv, projectCurrency)}</span>\n                </div>\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-sm text-muted-foreground\">Earned Value (EV)</span>\n                  <span className=\"font-semibold font-mono\">{formatCurrency(earnedValue.ev, projectCurrency)}</span>\n                </div>\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-sm text-muted-foreground\">Actual Cost (AC)</span>\n                  <span className=\"font-semibold font-mono\">{formatCurrency(earnedValue.ac, projectCurrency)}</span>\n                </div>\n                <div className=\"pt-4 border-t space-y-2\">\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-sm font-medium\">Cost Performance Index (CPI)</span>\n                    <Badge variant={earnedValue.cpi >= 1 ? \"default\" : \"destructive\"}>\n                      {earnedValue.cpi.toFixed(2)}\n                    </Badge>\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-sm font-medium\">Schedule Performance Index (SPI)</span>\n                    <Badge variant={earnedValue.spi >= 1 ? \"default\" : \"secondary\"}>\n                      {earnedValue.spi.toFixed(2)}\n                    </Badge>\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-sm text-muted-foreground\">Cost Variance (CV)</span>\n                    <span className={`font-mono text-sm ${earnedValue.cv >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n                      {earnedValue.cv >= 0 ? '+' : ''}{formatCurrency(earnedValue.cv, projectCurrency)}\n                    </span>\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-sm text-muted-foreground\">Schedule Variance (SV)</span>\n                    <span className={`font-mono text-sm ${earnedValue.sv >= 0 ? 'text-green-600' : 'text-red-600'}`}>\n                      {earnedValue.sv >= 0 ? '+' : ''}{formatCurrency(earnedValue.sv, projectCurrency)}\n                    </span>\n                  </div>\n                </div>\n              </>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Cost Items</CardTitle>\n            <CardDescription>All cost line items for this project</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {isLoading ? (\n              <Skeleton className=\"h-48\" />\n            ) : costItems.length > 0 ? (\n              <div className=\"space-y-2 max-h-64 overflow-y-auto\">\n                {costItems.map((item) => (\n                  <div\n                    key={item.id}\n                    className=\"flex items-center justify-between gap-2 p-3 rounded-lg border bg-card hover-elevate\"\n                    data-testid={`cost-item-${item.id}`}\n                  >\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-2 flex-wrap\">\n                        <span className=\"font-medium text-sm truncate\">{item.description}</span>\n                        <Badge variant=\"outline\" className=\"text-xs capitalize\">{item.category}</Badge>\n                      </div>\n                      <div className=\"flex gap-4 text-xs text-muted-foreground mt-1 flex-wrap\">\n                        <span>Budget: {formatCurrency(parseNumeric(item.budgeted), item.currency)}</span>\n                        <span>Actual: {formatCurrency(parseNumeric(item.actual), item.currency)}</span>\n                      </div>\n                    </div>\n                    <div className=\"flex gap-1\">\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        onClick={() => handleOpenDialog(item)}\n                        data-testid={`button-edit-cost-${item.id}`}\n                      >\n                        <Pencil className=\"h-4 w-4\" />\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        onClick={() => deleteMutation.mutate(item.id)}\n                        data-testid={`button-delete-cost-${item.id}`}\n                      >\n                        <Trash2 className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            ) : (\n              <p className=\"text-sm text-muted-foreground text-center py-8\">\n                No cost items yet.\n              </p>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>{editingItem ? 'Edit Cost Item' : 'Add Cost Item'}</DialogTitle>\n            <DialogDescription>\n              {editingItem ? 'Update the cost item details.' : 'Add a new cost item to track budget and expenses.'}\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"category\">Category</Label>\n              <Select\n                value={formData.category}\n                onValueChange={(v) => setFormData({ ...formData, category: v })}\n              >\n                <SelectTrigger data-testid=\"select-category\">\n                  <SelectValue placeholder=\"Select category\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {COST_CATEGORIES.map((cat) => (\n                    <SelectItem key={cat} value={cat} className=\"capitalize\">\n                      {cat}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"description\">Description *</Label>\n              <Textarea\n                id=\"description\"\n                value={formData.description}\n                onChange={(e) => {\n                  setFormData({ ...formData, description: e.target.value });\n                  if (formErrors.description) setFormErrors({ ...formErrors, description: '' });\n                }}\n                placeholder=\"Enter cost description\"\n                data-testid=\"input-description\"\n                className={formErrors.description ? 'border-destructive' : ''}\n              />\n              {formErrors.description && (\n                <p className=\"text-xs text-destructive\">{formErrors.description}</p>\n              )}\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"budgeted\">Budgeted Amount *</Label>\n                <Input\n                  id=\"budgeted\"\n                  type=\"number\"\n                  min=\"0\"\n                  step=\"0.01\"\n                  value={formData.budgeted}\n                  onChange={(e) => {\n                    setFormData({ ...formData, budgeted: e.target.value });\n                    if (formErrors.budgeted) setFormErrors({ ...formErrors, budgeted: '' });\n                  }}\n                  placeholder=\"0\"\n                  data-testid=\"input-budgeted\"\n                  className={formErrors.budgeted ? 'border-destructive' : ''}\n                />\n                {formErrors.budgeted && (\n                  <p className=\"text-xs text-destructive\">{formErrors.budgeted}</p>\n                )}\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"actual\">Actual Amount</Label>\n                <Input\n                  id=\"actual\"\n                  type=\"number\"\n                  min=\"0\"\n                  step=\"0.01\"\n                  value={formData.actual}\n                  onChange={(e) => {\n                    setFormData({ ...formData, actual: e.target.value });\n                    if (formErrors.actual) setFormErrors({ ...formErrors, actual: '' });\n                  }}\n                  placeholder=\"0\"\n                  data-testid=\"input-actual\"\n                  className={formErrors.actual ? 'border-destructive' : ''}\n                />\n                {formErrors.actual && (\n                  <p className=\"text-xs text-destructive\">{formErrors.actual}</p>\n                )}\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"task\">Link to Task (optional)</Label>\n              <Select\n                value={formData.taskId?.toString() || 'none'}\n                onValueChange={(v) => setFormData({ ...formData, taskId: v && v !== 'none' ? parseInt(v) : undefined })}\n              >\n                <SelectTrigger data-testid=\"select-task\">\n                  <SelectValue placeholder=\"Select task (optional)\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"none\">None</SelectItem>\n                  {tasks.map((task) => (\n                    <SelectItem key={task.id} value={task.id.toString()}>\n                      {task.wbsCode} - {task.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={handleCloseDialog}>\n              Cancel\n            </Button>\n            <Button\n              onClick={handleSubmit}\n              disabled={createMutation.isPending || updateMutation.isPending}\n              data-testid=\"button-submit-cost\"\n            >\n              {createMutation.isPending || updateMutation.isPending ? 'Saving...' : editingItem ? 'Update' : 'Create'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":25599},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","size_bytes":140},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","size_bytes":6210},"client/src/pages/GanttPage.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { ZoomIn, ZoomOut, Maximize2, AlertTriangle, Loader2 } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { TaskModal } from \"@/components/TaskModal\";\nimport type { Task, TaskDependency } from \"@shared/schema\";\n\ntype ZoomLevel = \"week\" | \"month\" | \"quarter\";\n\nconst ZOOM_CONFIGS: Record<ZoomLevel, { daysPerUnit: number; unitLabel: string }> = {\n  week: { daysPerUnit: 7, unitLabel: \"Week\" },\n  month: { daysPerUnit: 30, unitLabel: \"Month\" },\n  quarter: { daysPerUnit: 90, unitLabel: \"Quarter\" },\n};\n\nexport default function GanttPage() {\n  const { selectedProjectId } = useProject();\n  const [zoom, setZoom] = useState<ZoomLevel>(\"month\");\n  const [selectedTask, setSelectedTask] = useState<Task | undefined>();\n  const [taskModalOpen, setTaskModalOpen] = useState(false);\n\n  const { \n    data: tasks = [], \n    isLoading: tasksLoading \n  } = useQuery<Task[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/tasks`],\n    enabled: !!selectedProjectId,\n  });\n\n  const { data: dependencies = [] } = useQuery<TaskDependency[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/dependencies`],\n    enabled: !!selectedProjectId,\n  });\n\n  const { minDate, maxDate, totalDays, units } = useMemo(() => {\n    if (tasks.length === 0) {\n      const now = new Date();\n      return {\n        minDate: now,\n        maxDate: new Date(now.getTime() + 180 * 24 * 60 * 60 * 1000),\n        totalDays: 180,\n        units: 6,\n      };\n    }\n\n    let min = new Date();\n    let max = new Date();\n    \n    tasks.forEach(task => {\n      if (task.startDate) {\n        const start = new Date(task.startDate);\n        if (!min || start < min) min = start;\n      }\n      if (task.endDate) {\n        const end = new Date(task.endDate);\n        if (!max || end > max) max = end;\n      }\n    });\n\n    min.setDate(min.getDate() - 7);\n    max.setDate(max.getDate() + 30);\n\n    const daysDiff = Math.ceil((max.getTime() - min.getTime()) / (1000 * 60 * 60 * 24));\n    const { daysPerUnit } = ZOOM_CONFIGS[zoom];\n    \n    return {\n      minDate: min,\n      maxDate: max,\n      totalDays: daysDiff,\n      units: Math.ceil(daysDiff / daysPerUnit),\n    };\n  }, [tasks, zoom]);\n\n  const getTaskPosition = (task: Task) => {\n    if (!task.startDate || !task.endDate) return { left: 0, width: 0 };\n    \n    const start = new Date(task.startDate);\n    const end = new Date(task.endDate);\n    \n    const startOffset = Math.floor((start.getTime() - minDate.getTime()) / (1000 * 60 * 60 * 24));\n    const duration = Math.ceil((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24));\n    \n    return {\n      left: (startOffset / totalDays) * 100,\n      width: Math.max((duration / totalDays) * 100, 1),\n    };\n  };\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case \"completed\": return \"bg-green-500\";\n      case \"in-progress\": return \"bg-blue-500\";\n      case \"review\": return \"bg-purple-500\";\n      case \"on-hold\": return \"bg-amber-500\";\n      default: return \"bg-gray-400\";\n    }\n  };\n\n  const getPriorityColor = (priority: string) => {\n    switch (priority) {\n      case \"critical\": return \"border-l-4 border-l-red-500\";\n      case \"high\": return \"border-l-4 border-l-orange-500\";\n      default: return \"\";\n    }\n  };\n\n  const getUnitLabels = () => {\n    const labels: string[] = [];\n    const { daysPerUnit, unitLabel } = ZOOM_CONFIGS[zoom];\n    \n    for (let i = 0; i < units; i++) {\n      const unitDate = new Date(minDate.getTime() + i * daysPerUnit * 24 * 60 * 60 * 1000);\n      if (zoom === \"week\") {\n        labels.push(`${unitLabel} ${i + 1}`);\n      } else if (zoom === \"month\") {\n        labels.push(unitDate.toLocaleDateString(\"en-US\", { month: \"short\", year: \"2-digit\" }));\n      } else {\n        labels.push(`Q${Math.floor(unitDate.getMonth() / 3) + 1} ${unitDate.getFullYear()}`);\n      }\n    }\n    return labels;\n  };\n\n  const handleTaskClick = (task: Task) => {\n    setSelectedTask(task);\n    setTaskModalOpen(true);\n  };\n\n  const handleZoomIn = () => {\n    if (zoom === \"quarter\") setZoom(\"month\");\n    else if (zoom === \"month\") setZoom(\"week\");\n  };\n\n  const handleZoomOut = () => {\n    if (zoom === \"week\") setZoom(\"month\");\n    else if (zoom === \"month\") setZoom(\"quarter\");\n  };\n\n  const rootTasks = tasks.filter(t => !t.parentId);\n  const getChildren = (parentId: number): Task[] => tasks.filter(t => t.parentId === parentId);\n\n  const renderTask = (task: Task, level = 0): JSX.Element[] => {\n    const children = getChildren(task.id);\n    const { left, width } = getTaskPosition(task);\n    const hasValidDates = task.startDate && task.endDate;\n    \n    const elements: JSX.Element[] = [\n      <div\n        key={task.id}\n        className={`grid grid-cols-12 gap-px items-center ${getPriorityColor(task.priority)}`}\n        style={{ paddingLeft: `${level * 1.5}rem` }}\n      >\n        <div className=\"col-span-3 flex items-center gap-2 py-2 pr-2\">\n          <Badge variant=\"outline\" className=\"font-mono text-xs shrink-0\">\n            {task.wbsCode || `#${task.id}`}\n          </Badge>\n          <span className=\"text-sm font-medium truncate\">{task.name}</span>\n        </div>\n        <div className=\"col-span-9 relative h-10 bg-muted/30 rounded\">\n          {hasValidDates ? (\n            <div\n              className={`absolute top-1/2 -translate-y-1/2 h-6 rounded ${getStatusColor(task.status)} flex items-center px-2 text-white text-xs font-semibold shadow hover-elevate cursor-pointer transition-shadow overflow-hidden`}\n              style={{\n                left: `${left}%`,\n                width: `${width}%`,\n                minWidth: \"40px\",\n              }}\n              onClick={() => handleTaskClick(task)}\n              data-testid={`gantt-bar-${task.id}`}\n            >\n              <div className=\"flex items-center justify-between w-full\">\n                <span className=\"truncate\">{task.progress || 0}%</span>\n              </div>\n              <div\n                className=\"absolute inset-0 bg-white/20 rounded pointer-events-none\"\n                style={{ width: `${task.progress || 0}%` }}\n              />\n            </div>\n          ) : (\n            <div className=\"absolute inset-0 flex items-center justify-center text-xs text-muted-foreground\">\n              No dates set\n            </div>\n          )}\n        </div>\n      </div>\n    ];\n\n    children.forEach(child => {\n      elements.push(...renderTask(child, level + 1));\n    });\n\n    return elements;\n  };\n\n  if (!selectedProjectId) {\n    return (\n      <div className=\"p-6\">\n        <Alert>\n          <AlertTriangle className=\"h-4 w-4\" />\n          <AlertDescription>\n            Please select a project from the dropdown above to view the Gantt chart.\n          </AlertDescription>\n        </Alert>\n      </div>\n    );\n  }\n\n  if (tasksLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-4\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-semibold\" data-testid=\"page-title-gantt\">Gantt Chart</h1>\n          <p className=\"text-muted-foreground\">\n            Timeline view with {tasks.length} task{tasks.length !== 1 ? \"s\" : \"\"}\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Button \n            variant=\"outline\" \n            size=\"icon\" \n            onClick={handleZoomIn}\n            disabled={zoom === \"week\"}\n            data-testid=\"button-zoom-in\"\n          >\n            <ZoomIn className=\"h-4 w-4\" />\n          </Button>\n          <Badge variant=\"secondary\" className=\"px-3\">{ZOOM_CONFIGS[zoom].unitLabel}</Badge>\n          <Button \n            variant=\"outline\" \n            size=\"icon\"\n            onClick={handleZoomOut}\n            disabled={zoom === \"quarter\"}\n            data-testid=\"button-zoom-out\"\n          >\n            <ZoomOut className=\"h-4 w-4\" />\n          </Button>\n          <Button variant=\"outline\" size=\"icon\" data-testid=\"button-fit-screen\">\n            <Maximize2 className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      </div>\n\n      <Card>\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-lg\">Project Timeline</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {tasks.length === 0 ? (\n            <div className=\"text-center py-12\">\n              <h2 className=\"text-xl font-semibold mb-2\">No Tasks Yet</h2>\n              <p className=\"text-muted-foreground\">Create tasks with start and end dates to see them on the Gantt chart</p>\n            </div>\n          ) : (\n            <div className=\"overflow-x-auto\">\n              <div className=\"min-w-[1000px]\">\n                <div className=\"grid grid-cols-12 gap-px mb-4 bg-border rounded-lg overflow-hidden\">\n                  <div className=\"col-span-3 bg-muted p-3 font-semibold text-sm\">Task</div>\n                  <div className=\"col-span-9 bg-muted\">\n                    <div \n                      className=\"grid text-center text-sm font-semibold\"\n                      style={{ gridTemplateColumns: `repeat(${Math.min(units, 12)}, 1fr)` }}\n                    >\n                      {getUnitLabels().slice(0, 12).map((label, i) => (\n                        <div key={i} className=\"p-3 border-l border-border\">\n                          {label}\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                </div>\n\n                <div className=\"space-y-1\">\n                  {rootTasks.map(task => renderTask(task))}\n                </div>\n\n                <div className=\"mt-6 p-4 bg-muted/50 rounded-lg\">\n                  <h3 className=\"text-sm font-semibold mb-3\">Legend</h3>\n                  <div className=\"flex flex-wrap items-center gap-4 text-sm\">\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-4 h-4 rounded bg-green-500\" />\n                      <span>Completed</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-4 h-4 rounded bg-blue-500\" />\n                      <span>In Progress</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-4 h-4 rounded bg-purple-500\" />\n                      <span>In Review</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-4 h-4 rounded bg-amber-500\" />\n                      <span>On Hold</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-4 h-4 rounded bg-gray-400\" />\n                      <span>Not Started</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-6 h-4 border-l-4 border-l-red-500 bg-muted rounded\" />\n                      <span>Critical Priority</span>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      <TaskModal\n        open={taskModalOpen}\n        onOpenChange={setTaskModalOpen}\n        task={selectedTask}\n      />\n    </div>\n  );\n}\n","size_bytes":11776},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \" ,\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary: \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n\n        outline: \" border [border-color:var(--badge-outline)] shadow-xs\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  );\n}\n\nexport { Badge, badgeVariants }\n","size_bytes":1202},"server/index-dev.ts":{"content":"import fs from \"node:fs\";\nimport path from \"node:path\";\nimport { type Server } from \"node:http\";\n\nimport { nanoid } from \"nanoid\";\nimport { type Express } from \"express\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\n\nimport viteConfig from \"../vite.config\";\nimport runApp from \"./app\";\n\nexport async function setupVite(app: Express, server: Server) {\n  const viteLogger = createLogger();\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\n(async () => {\n  await runApp(setupVite);\n})();\n","size_bytes":1609},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","size_bytes":4420},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","size_bytes":2154},"client/src/components/examples/MetricCard.tsx":{"content":"import { MetricCard } from '../MetricCard';\nimport { DollarSign } from 'lucide-react';\n\nexport default function MetricCardExample() {\n  return (\n    <div className=\"p-4\">\n      <MetricCard\n        title=\"Total Budget\"\n        value=\"$4.5M\"\n        change={12}\n        icon={DollarSign}\n      />\n    </div>\n  );\n}\n","size_bytes":313},"server/app.ts":{"content":"import { type Server } from \"node:http\";\n\nimport express, {\n  type Express,\n  type Request,\n  Response,\n  NextFunction,\n} from \"express\";\n\nimport { registerRoutes } from \"./routes\";\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport const app = express();\n\ndeclare module 'http' {\n  interface IncomingMessage {\n    rawBody: unknown\n  }\n}\napp.use(express.json({\n  verify: (req, _res, buf) => {\n    req.rawBody = buf;\n  }\n}));\napp.use(express.urlencoded({ extended: false }));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"…\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\nexport default async function runApp(\n  setup: (app: Express, server: Server) => Promise<void>,\n) {\n  const server = await registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly run the final setup after setting up all the other routes so\n  // the catch-all route doesn't interfere with the other routes\n  await setup(app, server);\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n  });\n}\n","size_bytes":2482},"server/replitAuth.ts":{"content":"// Based on blueprint:javascript_log_in_with_replit\nimport * as client from \"openid-client\";\nimport { Strategy, type VerifyFunction } from \"openid-client/passport\";\nimport passport from \"passport\";\nimport session from \"express-session\";\nimport type { Express, RequestHandler } from \"express\";\nimport memoize from \"memoizee\";\nimport connectPg from \"connect-pg-simple\";\nimport { storage } from \"./storage\";\n\nconst getOidcConfig = memoize(\n  async () => {\n    return await client.discovery(\n      new URL(process.env.ISSUER_URL ?? \"https://replit.com/oidc\"),\n      process.env.REPL_ID!\n    );\n  },\n  { maxAge: 3600 * 1000 }\n);\n\nconst sessionTtl = 7 * 24 * 60 * 60 * 1000; // 1 week\nconst pgStore = connectPg(session);\nexport const sessionStore = new pgStore({\n  conString: process.env.DATABASE_URL,\n  createTableIfMissing: false,\n  ttl: sessionTtl,\n  tableName: \"sessions\",\n});\n\nexport function getSession() {\n  // Only use secure cookies in production (HTTPS)\n  const isProduction = process.env.NODE_ENV === \"production\";\n  \n  return session({\n    secret: process.env.SESSION_SECRET!,\n    store: sessionStore,\n    resave: false,\n    saveUninitialized: false,\n    cookie: {\n      httpOnly: true,\n      secure: isProduction,\n      maxAge: sessionTtl,\n    },\n  });\n}\n\nfunction updateUserSession(\n  user: any,\n  tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers\n) {\n  user.claims = tokens.claims();\n  user.access_token = tokens.access_token;\n  user.refresh_token = tokens.refresh_token;\n  user.expires_at = user.claims?.exp;\n}\n\nasync function upsertUser(claims: any) {\n  await storage.upsertUser({\n    id: claims[\"sub\"],\n    email: claims[\"email\"],\n    firstName: claims[\"first_name\"],\n    lastName: claims[\"last_name\"],\n    profileImageUrl: claims[\"profile_image_url\"],\n  });\n}\n\nexport async function setupAuth(app: Express) {\n  app.set(\"trust proxy\", 1);\n  app.use(getSession());\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  const config = await getOidcConfig();\n\n  const verify: VerifyFunction = async (\n    tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers,\n    verified: passport.AuthenticateCallback\n  ) => {\n    const user = {};\n    updateUserSession(user, tokens);\n    await upsertUser(tokens.claims());\n    verified(null, user);\n  };\n\n  // Keep track of registered strategies\n  const registeredStrategies = new Set<string>();\n\n  // Helper function to ensure strategy exists for a domain\n  const ensureStrategy = (domain: string) => {\n    const strategyName = `replitauth:${domain}`;\n    if (!registeredStrategies.has(strategyName)) {\n      const strategy = new Strategy(\n        {\n          name: strategyName,\n          config,\n          scope: \"openid email profile offline_access\",\n          callbackURL: `https://${domain}/api/callback`,\n        },\n        verify\n      );\n      passport.use(strategy);\n      registeredStrategies.add(strategyName);\n    }\n  };\n\n  passport.serializeUser((user: Express.User, cb) => cb(null, user));\n  passport.deserializeUser((user: Express.User, cb) => cb(null, user));\n\n  app.get(\"/api/login\", (req, res, next) => {\n    ensureStrategy(req.hostname);\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      prompt: \"login consent\",\n      scope: [\"openid\", \"email\", \"profile\", \"offline_access\"],\n    })(req, res, next);\n  });\n\n  app.get(\"/api/callback\", (req, res, next) => {\n    ensureStrategy(req.hostname);\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      successReturnToOrRedirect: \"/\",\n      failureRedirect: \"/api/login\",\n    })(req, res, next);\n  });\n\n  app.get(\"/api/logout\", (req, res) => {\n    req.logout(() => {\n      res.redirect(\n        client.buildEndSessionUrl(config, {\n          client_id: process.env.REPL_ID!,\n          post_logout_redirect_uri: `${req.protocol}://${req.hostname}`,\n        }).href\n      );\n    });\n  });\n}\n\nexport const isAuthenticated: RequestHandler = async (req, res, next) => {\n  const user = req.user as any;\n\n  if (!req.isAuthenticated() || !user.expires_at) {\n    return res.status(401).json({ message: \"Unauthorized\" });\n  }\n\n  const now = Math.floor(Date.now() / 1000);\n  if (now <= user.expires_at) {\n    return next();\n  }\n\n  const refreshToken = user.refresh_token;\n  if (!refreshToken) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n\n  try {\n    const config = await getOidcConfig();\n    const tokenResponse = await client.refreshTokenGrant(config, refreshToken);\n    updateUserSession(user, tokenResponse);\n    return next();\n  } catch (error) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n};\n","size_bytes":4633},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","size_bytes":10481},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","size_bytes":1077},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","size_bytes":7428},"client/src/pages/LoginPage.tsx":{"content":"import { useAuth } from \"@/hooks/useAuth\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Building2 } from \"lucide-react\";\n\nexport default function LoginPage() {\n  const { isLoading } = useAuth();\n\n  const handleLogin = () => {\n    window.location.href = \"/api/login\";\n  };\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-background p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"text-center\">\n          <div className=\"flex justify-center mb-4\">\n            <div className=\"h-16 w-16 rounded-full bg-primary flex items-center justify-center\">\n              <Building2 className=\"h-8 w-8 text-primary-foreground\" />\n            </div>\n          </div>\n          <CardTitle className=\"text-3xl\">EPC PMIS</CardTitle>\n          <CardDescription>\n            Project Management Information Software\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <p className=\"text-center text-sm text-muted-foreground\">\n            Comprehensive project management platform for engineering, procurement, and construction projects.\n          </p>\n          <Button\n            onClick={handleLogin}\n            disabled={isLoading}\n            className=\"w-full\"\n            size=\"lg\"\n            data-testid=\"button-login\"\n          >\n            {isLoading ? \"Loading...\" : \"Sign in with Replit\"}\n          </Button>\n          <p className=\"text-xs text-center text-muted-foreground\">\n            By signing in, you agree to our Terms of Service and Privacy Policy\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":1747},"server/aiAssistant.ts":{"content":"import OpenAI from \"openai\";\nimport type { IStorage } from \"./storage\";\nimport type { InsertTask, InsertRisk, InsertIssue, InsertStakeholder } from \"@shared/schema\";\n\n// This is using Replit's AI Integrations service, which provides OpenAI-compatible API access without requiring your own OpenAI API key.\n// the newest OpenAI model is \"gpt-5\" which was released August 7, 2025. do not change this unless explicitly requested by the user\nconst openai = new OpenAI({\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY\n});\n\n// Define available functions for the AI assistant\nconst tools: OpenAI.Chat.Completions.ChatCompletionTool[] = [\n  {\n    type: \"function\",\n    function: {\n      name: \"get_project_overview\",\n      description: \"Get comprehensive overview of a project including tasks, risks, issues, stakeholders, and cost data\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          projectId: {\n            type: \"number\",\n            description: \"The project ID\"\n          }\n        },\n        required: [\"projectId\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"analyze_project_risks\",\n      description: \"Analyze project risks and provide risk assessment with high-priority items\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          projectId: {\n            type: \"number\",\n            description: \"The project ID\"\n          }\n        },\n        required: [\"projectId\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"analyze_resource_workload\",\n      description: \"Analyze resource allocation and workload distribution across tasks\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          projectId: {\n            type: \"number\",\n            description: \"The project ID\"\n          }\n        },\n        required: [\"projectId\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"create_task\",\n      description: \"Create a new task in the project\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          projectId: { type: \"number\" },\n          title: { type: \"string\" },\n          description: { type: \"string\" },\n          assignee: { type: \"string\" },\n          status: { type: \"string\", enum: [\"not-started\", \"in-progress\", \"review\", \"completed\", \"on-hold\"] },\n          priority: { type: \"string\", enum: [\"low\", \"medium\", \"high\", \"critical\"] },\n          estimatedHours: { type: \"number\" },\n          startDate: { type: \"string\", format: \"date-time\" },\n          endDate: { type: \"string\", format: \"date-time\" }\n        },\n        required: [\"projectId\", \"title\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"create_risk\",\n      description: \"Create a new risk in the project\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          projectId: { type: \"number\" },\n          title: { type: \"string\" },\n          description: { type: \"string\" },\n          category: { type: \"string\" },\n          probability: { type: \"number\", minimum: 1, maximum: 5 },\n          impact: { type: \"string\", enum: [\"low\", \"medium\", \"high\", \"critical\"] },\n          mitigationPlan: { type: \"string\" }\n        },\n        required: [\"projectId\", \"title\"]\n      }\n    }\n  },\n  {\n    type: \"function\",\n    function: {\n      name: \"create_issue\",\n      description: \"Create a new issue in the project\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          projectId: { type: \"number\" },\n          title: { type: \"string\" },\n          description: { type: \"string\" },\n          priority: { type: \"string\", enum: [\"low\", \"medium\", \"high\", \"critical\"] },\n          category: { type: \"string\" },\n          assignedTo: { type: \"string\" }\n        },\n        required: [\"projectId\", \"title\"]\n      }\n    }\n  }\n];\n\n// Helper to verify project access\nasync function verifyProjectAccess(\n  projectId: number,\n  userId: string,\n  storage: IStorage\n): Promise<void> {\n  const project = await storage.getProject(projectId);\n  if (!project) {\n    throw new Error(`Project ${projectId} not found`);\n  }\n  \n  const userOrg = await storage.getUserOrganization(userId, project.organizationId);\n  if (!userOrg) {\n    throw new Error(`Access denied to project ${projectId}`);\n  }\n}\n\n// Execute function calls\nasync function executeFunctionCall(\n  name: string,\n  args: any,\n  storage: IStorage,\n  userId: string\n): Promise<string> {\n  try {\n    switch (name) {\n      case \"get_project_overview\": {\n        const { projectId } = args;\n        // Verify access\n        await verifyProjectAccess(projectId, userId, storage);\n        \n        const [tasks, risks, issues, stakeholders, costItems] = await Promise.all([\n          storage.getTasksByProject(projectId),\n          storage.getRisksByProject(projectId),\n          storage.getIssuesByProject(projectId),\n          storage.getStakeholdersByProject(projectId),\n          storage.getCostItemsByProject(projectId)\n        ]);\n        \n        return JSON.stringify({\n          tasks: {\n            total: tasks.length,\n            byStatus: tasks.reduce((acc, t) => ({ ...acc, [t.status]: (acc[t.status as string] || 0) + 1 }), {} as Record<string, number>),\n            byPriority: tasks.reduce((acc, t) => ({ ...acc, [t.priority]: (acc[t.priority as string] || 0) + 1 }), {} as Record<string, number>)\n          },\n          risks: {\n            total: risks.length,\n            byStatus: risks.reduce((acc, r) => ({ ...acc, [r.status]: (acc[r.status as string] || 0) + 1 }), {} as Record<string, number>),\n            highImpact: risks.filter(r => r.impact === 'critical' || r.impact === 'high').length\n          },\n          issues: {\n            total: issues.length,\n            byStatus: issues.reduce((acc, i) => ({ ...acc, [i.status]: (acc[i.status as string] || 0) + 1 }), {} as Record<string, number>),\n            highPriority: issues.filter(i => i.priority === 'critical' || i.priority === 'high').length\n          },\n          stakeholders: {\n            total: stakeholders.length,\n            byRole: stakeholders.reduce((acc, s) => ({ ...acc, [s.role]: (acc[s.role as string] || 0) + 1 }), {} as Record<string, number>)\n          },\n          costs: {\n            totalBudgeted: costItems.reduce((sum, c) => sum + parseFloat(c.budgeted.toString()), 0),\n            totalActual: costItems.reduce((sum, c) => sum + parseFloat(c.actual.toString()), 0)\n          }\n        });\n      }\n      \n      case \"analyze_project_risks\": {\n        const { projectId } = args;\n        // Verify access\n        await verifyProjectAccess(projectId, userId, storage);\n        \n        const risks = await storage.getRisksByProject(projectId);\n        \n        const riskScore = (r: any) => r.probability * (r.impact === 'critical' ? 5 : r.impact === 'high' ? 4 : r.impact === 'medium' ? 3 : r.impact === 'low' ? 2 : 1);\n        const sortedRisks = risks.sort((a, b) => riskScore(b) - riskScore(a));\n        \n        return JSON.stringify({\n          totalRisks: risks.length,\n          highPriorityRisks: sortedRisks.slice(0, 5).map(r => ({\n            code: r.code,\n            title: r.title,\n            probability: r.probability,\n            impact: r.impact,\n            status: r.status,\n            score: riskScore(r)\n          })),\n          byCategory: risks.reduce((acc, r) => {\n            const cat = r.category || 'uncategorized';\n            return { ...acc, [cat]: (acc[cat] || 0) + 1 };\n          }, {} as Record<string, number>),\n          unmitigated: risks.filter(r => r.status === 'identified').length\n        });\n      }\n      \n      case \"analyze_resource_workload\": {\n        const { projectId } = args;\n        // Verify access\n        await verifyProjectAccess(projectId, userId, storage);\n        \n        const tasks = await storage.getTasksByProject(projectId);\n        \n        const workloadByAssignee = tasks.reduce((acc, t) => {\n          if (t.assignedTo) {\n            if (!acc[t.assignedTo]) {\n              acc[t.assignedTo] = {\n                totalTasks: 0,\n                totalHours: 0,\n                byStatus: {} as Record<string, number>\n              };\n            }\n            acc[t.assignedTo].totalTasks++;\n            acc[t.assignedTo].totalHours += parseFloat(t.estimatedHours?.toString() || '0');\n            acc[t.assignedTo].byStatus[t.status] = (acc[t.assignedTo].byStatus[t.status] || 0) + 1;\n          }\n          return acc;\n        }, {} as Record<string, any>);\n        \n        return JSON.stringify({\n          totalAssigned: tasks.filter(t => t.assignedTo).length,\n          unassigned: tasks.filter(t => !t.assignedTo).length,\n          workloadByAssignee\n        });\n      }\n      \n      case \"create_task\": {\n        // Verify access\n        await verifyProjectAccess(args.projectId, userId, storage);\n        \n        const taskData: InsertTask = {\n          projectId: args.projectId,\n          name: args.title,\n          description: args.description || null,\n          assignedTo: args.assignee || null,\n          status: args.status || 'not-started',\n          priority: args.priority || 'medium',\n          estimatedHours: args.estimatedHours || null,\n          startDate: args.startDate ? new Date(args.startDate) : null,\n          endDate: args.endDate ? new Date(args.endDate) : null,\n          progress: 0,\n          parentId: null,\n          wbsCode: 'TBD',\n          actualHours: null,\n          createdBy: userId\n        };\n        \n        const task = await storage.createTask(taskData);\n        return JSON.stringify({ success: true, task });\n      }\n      \n      case \"create_risk\": {\n        // Verify access\n        await verifyProjectAccess(args.projectId, userId, storage);\n        \n        const existingRisks = await storage.getRisksByProject(args.projectId);\n        const nextNumber = existingRisks.length + 1;\n        const code = `RISK-${String(nextNumber).padStart(3, '0')}`;\n        \n        const riskData: InsertRisk = {\n          projectId: args.projectId,\n          code,\n          title: args.title,\n          description: args.description || null,\n          category: args.category || null,\n          status: 'identified',\n          probability: args.probability || 3,\n          impact: args.impact || 'medium',\n          mitigationPlan: args.mitigationPlan || null,\n          owner: null,\n          identifiedDate: new Date()\n        };\n        \n        const risk = await storage.createRisk(riskData);\n        return JSON.stringify({ success: true, risk });\n      }\n      \n      case \"create_issue\": {\n        // Verify access\n        await verifyProjectAccess(args.projectId, userId, storage);\n        \n        const existingIssues = await storage.getIssuesByProject(args.projectId);\n        const nextNumber = existingIssues.length + 1;\n        const code = `ISS-${String(nextNumber).padStart(3, '0')}`;\n        \n        const issueData: InsertIssue = {\n          projectId: args.projectId,\n          code,\n          title: args.title,\n          description: args.description || null,\n          status: 'open',\n          priority: args.priority || 'medium',\n          category: args.category || null,\n          assignedTo: args.assignedTo || null,\n          reportedBy: userId,\n          reportedDate: new Date(),\n          resolvedDate: null,\n          resolution: null\n        };\n        \n        const issue = await storage.createIssue(issueData);\n        return JSON.stringify({ success: true, issue });\n      }\n      \n      default:\n        throw new Error(`Unknown or unauthorized function: ${name}`);\n    }\n  } catch (error: any) {\n    console.error(`Error executing function ${name}:`, error);\n    // Re-throw authorization errors to prevent silent failures\n    if (error.message?.includes('Access denied') || error.message?.includes('not found')) {\n      throw error;\n    }\n    return JSON.stringify({ error: error.message || \"Function execution failed\" });\n  }\n}\n\nexport interface ChatMessage {\n  role: \"user\" | \"assistant\" | \"system\";\n  content: string;\n}\n\nexport interface ChatResponse {\n  message: string;\n  tokensUsed: number;\n  functionCalls?: Array<{ name: string; args: any; result: string }>;\n}\n\nexport async function chatWithAssistant(\n  messages: ChatMessage[],\n  projectId: number | null,\n  storage: IStorage,\n  userId: string\n): Promise<ChatResponse> {\n  try {\n    // Add system message with project context\n    const systemMessage: ChatMessage = {\n      role: \"system\",\n      content: `You are an expert EPC (Engineering, Procurement, Construction) project management assistant. \nYou help project managers with:\n- Analyzing project data (tasks, risks, issues, resources, costs)\n- Identifying performance issues and bottlenecks\n- Creating and managing project items (tasks, risks, issues)\n- Providing actionable insights and recommendations\n\nWhen analyzing data, be specific and provide actionable recommendations.\nFocus on EPC industry best practices and PMI standards.\n${projectId ? `Current project context: Project ID ${projectId}` : 'No project selected. Ask user to select a project first.'}`\n    };\n    \n    const allMessages = [systemMessage, ...messages];\n    \n    // Initial API call\n    let response = await openai.chat.completions.create({\n      model: \"gpt-5\", // the newest OpenAI model is \"gpt-5\" which was released August 7, 2025. do not change this unless explicitly requested by the user\n      messages: allMessages,\n      tools,\n      tool_choice: \"auto\",\n      max_completion_tokens: 8192\n    });\n    \n    const functionCalls: Array<{ name: string; args: any; result: string }> = [];\n    let totalTokens = response.usage?.total_tokens || 0;\n    \n    // Handle function calls iteratively\n    while (response.choices[0]?.finish_reason === \"tool_calls\") {\n      const toolCalls = response.choices[0].message.tool_calls || [];\n      \n      // Execute all function calls\n      for (const toolCall of toolCalls) {\n        if (toolCall.type !== 'function') continue;\n        \n        const functionName = toolCall.function.name;\n        const functionArgs = JSON.parse(toolCall.function.arguments);\n        \n        const result = await executeFunctionCall(functionName, functionArgs, storage, userId);\n        functionCalls.push({ name: functionName, args: functionArgs, result });\n        \n        // Add function result to messages\n        allMessages.push({\n          role: \"assistant\",\n          content: response.choices[0].message.content || \"\"\n        });\n        \n        allMessages.push({\n          role: \"user\" as any,\n          content: `Function ${functionName} result: ${result}`\n        });\n      }\n      \n      // Call API again with function results\n      response = await openai.chat.completions.create({\n        model: \"gpt-5\",\n        messages: allMessages,\n        tools,\n        tool_choice: \"auto\",\n        max_completion_tokens: 8192\n      });\n      \n      totalTokens += response.usage?.total_tokens || 0;\n    }\n    \n    return {\n      message: response.choices[0]?.message?.content || \"No response generated\",\n      tokensUsed: totalTokens,\n      functionCalls: functionCalls.length > 0 ? functionCalls : undefined\n    };\n  } catch (error: any) {\n    console.error(\"Error in chatWithAssistant:\", error);\n    throw new Error(error.message || \"Failed to get AI response\");\n  }\n}\n","size_bytes":15365},"client/src/contexts/ProjectContext.tsx":{"content":"import { createContext, useContext, useState, useEffect } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { Organization, Project } from \"@shared/schema\";\n\ninterface ProjectContextType {\n  selectedOrgId: number | null;\n  selectedProjectId: number | null;\n  setSelectedOrgId: (id: number | null) => void;\n  setSelectedProjectId: (id: number | null) => void;\n  organizations: Organization[];\n  projects: Project[];\n  selectedOrg: Organization | null;\n  selectedProject: Project | null;\n  isLoadingOrgs: boolean;\n  isLoadingProjects: boolean;\n  orgsError: Error | null;\n  projectsError: Error | null;\n  refetchOrgs: () => void;\n  refetchProjects: () => void;\n}\n\nconst ProjectContext = createContext<ProjectContextType | undefined>(undefined);\n\nexport function ProjectProvider({ children }: { children: React.ReactNode }) {\n  const [selectedOrgId, setSelectedOrgId] = useState<number | null>(null);\n  const [selectedProjectId, setSelectedProjectId] = useState<number | null>(null);\n\n  // Fetch organizations\n  const {\n    data: organizations = [],\n    isLoading: isLoadingOrgs,\n    error: orgsError,\n    refetch: refetchOrgs\n  } = useQuery<Organization[]>({\n    queryKey: [`/api/organizations`],\n    retry: 1,\n  });\n\n  // Fetch projects for selected organization\n  const {\n    data: projects = [],\n    isLoading: isLoadingProjects,\n    error: projectsError,\n    refetch: refetchProjects\n  } = useQuery<Project[]>({\n    queryKey: [`/api/organizations/${selectedOrgId}/projects`],\n    enabled: !!selectedOrgId,\n    retry: 1,\n  });\n\n  // Auto-select first organization when loaded\n  useEffect(() => {\n    if (organizations.length > 0 && !selectedOrgId) {\n      setSelectedOrgId(organizations[0].id);\n    }\n  }, [organizations, selectedOrgId]);\n\n  // Auto-select first project when organization changes\n  useEffect(() => {\n    if (projects.length > 0) {\n      setSelectedProjectId(projects[0].id);\n    } else {\n      setSelectedProjectId(null);\n    }\n  }, [projects]);\n\n  const selectedOrg = organizations.find(o => o.id === selectedOrgId) || null;\n  const selectedProject = projects.find(p => p.id === selectedProjectId) || null;\n\n  return (\n    <ProjectContext.Provider value={{\n      selectedOrgId,\n      selectedProjectId,\n      setSelectedOrgId,\n      setSelectedProjectId,\n      organizations,\n      projects,\n      selectedOrg,\n      selectedProject,\n      isLoadingOrgs,\n      isLoadingProjects,\n      orgsError: orgsError as Error | null,\n      projectsError: projectsError as Error | null,\n      refetchOrgs,\n      refetchProjects,\n    }}>\n      {children}\n    </ProjectContext.Provider>\n  );\n}\n\nexport function useProject() {\n  const context = useContext(ProjectContext);\n  if (context === undefined) {\n    throw new Error(\"useProject must be used within a ProjectProvider\");\n  }\n  return context;\n}\n","size_bytes":2831},"client/src/pages/AIAssistantPage.tsx":{"content":"import { useState, useRef, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { MessageSquare, Send, Plus, Trash2, Bot, User, Sparkles, AlertCircle, Pencil, Copy, Check, Settings as SettingsIcon } from \"lucide-react\";\nimport ReactMarkdown from \"react-markdown\";\nimport remarkGfm from \"remark-gfm\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n} from \"@/components/ui/dialog\";\nimport type { AiConversation, AiMessage } from \"@shared/schema\";\nimport { Card } from \"@/components/ui/card\";\nimport { AISettingsModal, getAISettings, type AISettings } from \"@/components/ai/AISettingsModal\";\nimport { useAIPrompt } from \"@/contexts/AIPromptContext\";\nimport { AIFileAttachment, type AttachmentFile, prepareAttachmentsForMessage } from \"@/components/ai/AIFileAttachment\";\nimport { AIMentionInput } from \"@/components/ai/AIMentionInput\";\n\nexport default function AIAssistantPage() {\n  const { selectedProjectId, selectedProject } = useProject();\n  const { toast } = useToast();\n  const { pendingPrompt, clearPendingPrompt } = useAIPrompt();\n  const [selectedConversationId, setSelectedConversationId] = useState<number | null>(null);\n  const [messageInput, setMessageInput] = useState(\"\");\n  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);\n  const [conversationToDelete, setConversationToDelete] = useState<number | null>(null);\n  const [renameDialogOpen, setRenameDialogOpen] = useState(false);\n  const [conversationToRename, setConversationToRename] = useState<AiConversation | null>(null);\n  const [newTitle, setNewTitle] = useState(\"\");\n  const [copiedMessageId, setCopiedMessageId] = useState<number | null>(null);\n  const [settingsOpen, setSettingsOpen] = useState(false);\n  const [aiSettings, setAiSettings] = useState<AISettings>(() => getAISettings());\n  const [attachments, setAttachments] = useState<AttachmentFile[]>([]);\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const prevProjectIdRef = useRef<number | null>(null);\n\n  useEffect(() => {\n    if (pendingPrompt) {\n      setMessageInput(pendingPrompt);\n      clearPendingPrompt();\n    }\n  }, [pendingPrompt, clearPendingPrompt]);\n\n  // Clear selected conversation and purge cache when project changes\n  useEffect(() => {\n    // Purge cached data from previous project to prevent cross-project data exposure\n    if (prevProjectIdRef.current && prevProjectIdRef.current !== selectedProjectId) {\n      queryClient.removeQueries({ \n        queryKey: [`/api/ai/conversations/project/${prevProjectIdRef.current}`] \n      });\n      // Also remove any cached messages from previous project's conversations\n      queryClient.removeQueries({ \n        predicate: (query) => {\n          const key = query.queryKey[0] as string;\n          return key?.startsWith('/api/ai/conversations/') && key?.endsWith('/messages');\n        }\n      });\n    }\n    \n    // Clear conversation selection\n    setSelectedConversationId(null);\n    \n    // Update ref for next change\n    prevProjectIdRef.current = selectedProjectId;\n  }, [selectedProjectId]);\n\n  // Fetch conversations for selected project (only when project is selected)\n  const { data: conversations = [], isLoading: conversationsLoading } = useQuery<AiConversation[]>({\n    queryKey: selectedProjectId \n      ? [`/api/ai/conversations/project/${selectedProjectId}`]\n      : ['__disabled__'],\n    enabled: !!selectedProjectId,\n    retry: 1,\n  });\n\n  // Fetch messages for selected conversation (only when conversation is selected)\n  const { data: messages = [], isLoading: messagesLoading } = useQuery<AiMessage[]>({\n    queryKey: selectedConversationId\n      ? [`/api/ai/conversations/${selectedConversationId}/messages`]\n      : ['__disabled__'],\n    enabled: !!selectedConversationId,\n    retry: 1,\n  });\n\n  // Create conversation mutation\n  const createConversationMutation = useMutation({\n    mutationFn: async () => {\n      if (!selectedProjectId) {\n        throw new Error(\"Please select a project first\");\n      }\n      return await apiRequest(\"POST\", \"/api/ai/conversations\", {\n        title: \"New Conversation\",\n        projectId: selectedProjectId,\n      });\n    },\n    onSuccess: (newConversation: any) => {\n      if (selectedProjectId) {\n        queryClient.invalidateQueries({ queryKey: [`/api/ai/conversations/project/${selectedProjectId}`] });\n      }\n      setSelectedConversationId(newConversation.id);\n      toast({ title: \"Success\", description: \"New conversation created\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  // Send message mutation\n  const sendMessageMutation = useMutation({\n    mutationFn: async (message: string) => {\n      if (!selectedConversationId) throw new Error(\"No conversation selected\");\n      const response = await apiRequest(\"POST\", \"/api/ai/chat\", {\n        conversationId: selectedConversationId,\n        message,\n      });\n      return response;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/ai/conversations/${selectedConversationId}/messages`] });\n      if (selectedProjectId) {\n        queryClient.invalidateQueries({ queryKey: [`/api/ai/conversations/project/${selectedProjectId}`] });\n      }\n      setMessageInput(\"\");\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  // Delete conversation mutation\n  const deleteConversationMutation = useMutation({\n    mutationFn: async (id: number) => {\n      await apiRequest(\"DELETE\", `/api/ai/conversations/${id}`);\n    },\n    onSuccess: () => {\n      if (selectedProjectId) {\n        queryClient.invalidateQueries({ queryKey: [`/api/ai/conversations/project/${selectedProjectId}`] });\n      }\n      if (selectedConversationId === conversationToDelete) {\n        setSelectedConversationId(null);\n      }\n      setDeleteDialogOpen(false);\n      setConversationToDelete(null);\n      toast({ title: \"Success\", description: \"Conversation deleted\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  // Rename conversation mutation\n  const renameConversationMutation = useMutation({\n    mutationFn: async ({ id, title }: { id: number; title: string }) => {\n      return await apiRequest(\"PATCH\", `/api/ai/conversations/${id}`, { title });\n    },\n    onSuccess: () => {\n      if (selectedProjectId) {\n        queryClient.invalidateQueries({ queryKey: [`/api/ai/conversations/project/${selectedProjectId}`] });\n      }\n      setRenameDialogOpen(false);\n      setConversationToRename(null);\n      setNewTitle(\"\");\n      toast({ title: \"Success\", description: \"Conversation renamed\" });\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message, variant: \"destructive\" });\n    },\n  });\n\n  // Auto-scroll to bottom when messages change\n  useEffect(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  }, [messages]);\n\n  const handleSendMessage = async (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!messageInput.trim() || !selectedConversationId) return;\n    \n    let fullMessage = messageInput;\n    if (attachments.length > 0) {\n      const attachmentText = await prepareAttachmentsForMessage(attachments);\n      fullMessage = messageInput + attachmentText;\n      setAttachments([]);\n    }\n    \n    sendMessageMutation.mutate(fullMessage);\n  };\n\n  const handleDeleteConversation = (id: number) => {\n    setConversationToDelete(id);\n    setDeleteDialogOpen(true);\n  };\n\n  const handleRenameConversation = (conversation: AiConversation) => {\n    setConversationToRename(conversation);\n    setNewTitle(conversation.title || \"\");\n    setRenameDialogOpen(true);\n  };\n\n  const handleRenameSubmit = () => {\n    if (!conversationToRename || !newTitle.trim()) return;\n    renameConversationMutation.mutate({ id: conversationToRename.id, title: newTitle.trim() });\n  };\n\n  const handleCopyMessage = async (content: string, messageIndex: number) => {\n    try {\n      await navigator.clipboard.writeText(content);\n      setCopiedMessageId(messageIndex);\n      setTimeout(() => setCopiedMessageId(null), 2000);\n    } catch (error) {\n      toast({ title: \"Error\", description: \"Failed to copy to clipboard\", variant: \"destructive\" });\n    }\n  };\n\n  const selectedConversation = conversations.find(c => c.id === selectedConversationId);\n  \n  // Get project name - conversations are always from the selected project\n  // (filtered by selectedProjectId on backend)\n  const conversationProjectName = selectedProject?.name || \"No project selected\";\n\n  return (\n    <div className=\"flex h-full gap-4 p-6\">\n      {/* Conversations Sidebar */}\n      <Card className=\"w-80 flex flex-col\">\n        <div className=\"p-4 border-b flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Bot className=\"h-5 w-5 text-primary\" data-testid=\"icon-bot\" />\n            <h2 className=\"font-semibold\" data-testid=\"text-conversations-title\">AI Assistant</h2>\n          </div>\n          <div className=\"flex gap-1\">\n            <Button\n              size=\"icon\"\n              variant=\"ghost\"\n              onClick={() => setSettingsOpen(true)}\n              data-testid=\"button-ai-settings\"\n              title=\"AI Settings\"\n            >\n              <SettingsIcon className=\"h-4 w-4\" />\n            </Button>\n            <Button\n              size=\"icon\"\n              variant=\"ghost\"\n              onClick={() => createConversationMutation.mutate()}\n              disabled={createConversationMutation.isPending || !selectedProjectId}\n              data-testid=\"button-new-conversation\"\n              title={!selectedProjectId ? \"Please select a project first\" : \"Create new conversation\"}\n            >\n              <Plus className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </div>\n\n        <ScrollArea className=\"flex-1\">\n          <div className=\"p-2 space-y-1\">\n            {!selectedProjectId ? (\n              <div className=\"p-4 text-center text-sm text-muted-foreground\" data-testid=\"text-select-project\">\n                <AlertCircle className=\"h-8 w-8 mx-auto mb-2 opacity-50\" />\n                Please select a project to view AI conversations\n              </div>\n            ) : conversationsLoading ? (\n              <div className=\"p-4 text-center text-sm text-muted-foreground\" data-testid=\"text-loading\">\n                Loading conversations...\n              </div>\n            ) : conversations.length === 0 ? (\n              <div className=\"p-4 text-center text-sm text-muted-foreground\" data-testid=\"text-no-conversations\">\n                No conversations yet. Start a new one!\n              </div>\n            ) : (\n              conversations.map((conversation) => (\n                <div\n                  key={conversation.id}\n                  className={`p-3 rounded-md cursor-pointer hover-elevate flex items-start justify-between gap-2 ${\n                    selectedConversationId === conversation.id ? 'bg-accent' : ''\n                  }`}\n                  onClick={() => setSelectedConversationId(conversation.id)}\n                  data-testid={`conversation-item-${conversation.id}`}\n                >\n                  <div className=\"flex-1 min-w-0\">\n                    <div className=\"flex items-center gap-2\">\n                      <MessageSquare className=\"h-4 w-4 text-muted-foreground flex-shrink-0\" />\n                      <span className=\"text-sm font-medium truncate\" data-testid={`text-conversation-title-${conversation.id}`}>\n                        {conversation.title || \"New Conversation\"}\n                      </span>\n                    </div>\n                    <p className=\"text-xs text-muted-foreground mt-1\">\n                      {new Date(conversation.updatedAt).toLocaleDateString()}\n                    </p>\n                  </div>\n                  <div className=\"flex gap-1 flex-shrink-0\">\n                    <Button\n                      size=\"icon\"\n                      variant=\"ghost\"\n                      className=\"h-6 w-6\"\n                      onClick={(e) => {\n                        e.stopPropagation();\n                        handleRenameConversation(conversation);\n                      }}\n                      data-testid={`button-rename-conversation-${conversation.id}`}\n                      title=\"Rename conversation\"\n                    >\n                      <Pencil className=\"h-3 w-3\" />\n                    </Button>\n                    <Button\n                      size=\"icon\"\n                      variant=\"ghost\"\n                      className=\"h-6 w-6\"\n                      onClick={(e) => {\n                        e.stopPropagation();\n                        handleDeleteConversation(conversation.id);\n                      }}\n                      data-testid={`button-delete-conversation-${conversation.id}`}\n                      title=\"Delete conversation\"\n                    >\n                      <Trash2 className=\"h-3 w-3\" />\n                    </Button>\n                  </div>\n                </div>\n              ))\n            )}\n          </div>\n        </ScrollArea>\n      </Card>\n\n      {/* Chat Area */}\n      <Card className=\"flex-1 flex flex-col\">\n        {!selectedConversationId ? (\n          <div className=\"flex-1 flex flex-col items-center justify-center p-8 text-center\">\n            <Sparkles className=\"h-16 w-16 text-primary/20 mb-4\" data-testid=\"icon-sparkles\" />\n            <h3 className=\"text-xl font-semibold mb-2\" data-testid=\"text-welcome-title\">\n              Welcome to AI Project Assistant\n            </h3>\n            <p className=\"text-muted-foreground max-w-md mb-4\" data-testid=\"text-welcome-description\">\n              I can help you analyze project data, identify risks, track resources, and provide actionable insights for your EPC projects.\n            </p>\n            {!selectedProjectId ? (\n              <Alert data-testid=\"alert-no-project\">\n                <AlertCircle className=\"h-4 w-4\" />\n                <AlertDescription>\n                  Please select a project from the top bar to use the AI Assistant.\n                </AlertDescription>\n              </Alert>\n            ) : (\n              <Button\n                onClick={() => createConversationMutation.mutate()}\n                disabled={createConversationMutation.isPending}\n                data-testid=\"button-start-conversation\"\n              >\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Start New Conversation\n              </Button>\n            )}\n          </div>\n        ) : (\n          <>\n            {/* Chat Header */}\n            <div className=\"p-4 border-b\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <h3 className=\"font-semibold\" data-testid=\"text-chat-title\">\n                    {selectedConversation?.title || \"Conversation\"}\n                  </h3>\n                  <p className=\"text-sm text-muted-foreground\" data-testid=\"text-chat-project\">\n                    {conversationProjectName}\n                  </p>\n                </div>\n                {selectedConversation && (\n                  <Badge variant=\"secondary\" data-testid=\"badge-updated-time\">\n                    Last updated: {new Date(selectedConversation.updatedAt).toLocaleTimeString()}\n                  </Badge>\n                )}\n              </div>\n            </div>\n\n            {/* Messages Area */}\n            <ScrollArea className=\"flex-1 p-4\">\n              {messagesLoading ? (\n                <div className=\"text-center text-muted-foreground\" data-testid=\"text-messages-loading\">\n                  Loading messages...\n                </div>\n              ) : messages.length === 0 ? (\n                <div className=\"text-center text-muted-foreground\" data-testid=\"text-no-messages\">\n                  <Alert>\n                    <AlertDescription>\n                      Start the conversation by asking me anything about your project. I can analyze risks, track resources, provide insights, and help you manage your EPC project effectively.\n                    </AlertDescription>\n                  </Alert>\n                </div>\n              ) : (\n                <div className=\"space-y-4\">\n                  {messages.map((message, index) => (\n                    <div\n                      key={index}\n                      className={`flex gap-3 ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}\n                      data-testid={`message-${message.role}-${index}`}\n                    >\n                      {message.role === 'assistant' && (\n                        <div className=\"h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0 mt-1\">\n                          <Bot className=\"h-4 w-4 text-primary\" />\n                        </div>\n                      )}\n                      <div\n                        className={`max-w-[70%] rounded-lg p-3 relative group ${\n                          message.role === 'user'\n                            ? 'bg-primary text-primary-foreground'\n                            : 'bg-muted'\n                        }`}\n                      >\n                        {message.role === 'assistant' ? (\n                          <div className=\"prose prose-sm dark:prose-invert max-w-none\" data-testid={`text-message-content-${index}`}>\n                            <ReactMarkdown\n                              remarkPlugins={[remarkGfm]}\n                              components={{\n                                p: ({ children }) => <p className=\"mb-2 last:mb-0\">{children}</p>,\n                                ul: ({ children }) => <ul className=\"mb-2 ml-4 list-disc\">{children}</ul>,\n                                ol: ({ children }) => <ol className=\"mb-2 ml-4 list-decimal\">{children}</ol>,\n                                li: ({ children }) => <li className=\"mb-1\">{children}</li>,\n                                h1: ({ children }) => <h1 className=\"text-lg font-bold mb-2\">{children}</h1>,\n                                h2: ({ children }) => <h2 className=\"text-base font-bold mb-2\">{children}</h2>,\n                                h3: ({ children }) => <h3 className=\"text-sm font-bold mb-1\">{children}</h3>,\n                                code: ({ className, children }) => {\n                                  const isInline = !className;\n                                  return isInline ? (\n                                    <code className=\"bg-background/50 px-1 py-0.5 rounded text-xs font-mono\">{children}</code>\n                                  ) : (\n                                    <code className=\"block bg-background/50 p-2 rounded text-xs font-mono overflow-x-auto mb-2\">{children}</code>\n                                  );\n                                },\n                                pre: ({ children }) => <pre className=\"bg-background/50 p-2 rounded overflow-x-auto mb-2\">{children}</pre>,\n                                table: ({ children }) => <table className=\"border-collapse border border-border mb-2 w-full text-xs\">{children}</table>,\n                                th: ({ children }) => <th className=\"border border-border p-1 bg-background/50 font-semibold\">{children}</th>,\n                                td: ({ children }) => <td className=\"border border-border p-1\">{children}</td>,\n                                blockquote: ({ children }) => <blockquote className=\"border-l-2 border-primary pl-2 italic mb-2\">{children}</blockquote>,\n                                a: ({ href, children }) => <a href={href} target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-primary underline\">{children}</a>,\n                              }}\n                            >\n                              {message.content}\n                            </ReactMarkdown>\n                          </div>\n                        ) : (\n                          <p className=\"text-sm whitespace-pre-wrap\" data-testid={`text-message-content-${index}`}>\n                            {message.content}\n                          </p>\n                        )}\n                        \n                        {/* Copy button for assistant messages */}\n                        {message.role === 'assistant' && (\n                          <Button\n                            size=\"icon\"\n                            variant=\"ghost\"\n                            className=\"absolute top-1 right-1 h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity\"\n                            onClick={() => handleCopyMessage(message.content, index)}\n                            data-testid={`button-copy-message-${index}`}\n                            title=\"Copy message\"\n                          >\n                            {copiedMessageId === index ? (\n                              <Check className=\"h-3 w-3 text-green-500\" />\n                            ) : (\n                              <Copy className=\"h-3 w-3\" />\n                            )}\n                          </Button>\n                        )}\n                        \n                        {message.tokensUsed > 0 && message.role === 'assistant' && (\n                          <div className=\"mt-2 text-xs opacity-70\" data-testid={`text-tokens-${index}`}>\n                            {message.tokensUsed} tokens\n                          </div>\n                        )}\n                      </div>\n                      {message.role === 'user' && (\n                        <div className=\"h-8 w-8 rounded-full bg-accent flex items-center justify-center flex-shrink-0 mt-1\">\n                          <User className=\"h-4 w-4\" />\n                        </div>\n                      )}\n                    </div>\n                  ))}\n                  \n                  {/* Typing indicator */}\n                  {sendMessageMutation.isPending && (\n                    <div className=\"flex gap-3 justify-start\" data-testid=\"typing-indicator\">\n                      <div className=\"h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0\">\n                        <Bot className=\"h-4 w-4 text-primary\" />\n                      </div>\n                      <div className=\"bg-muted rounded-lg p-3 flex items-center gap-1\">\n                        <span className=\"w-2 h-2 bg-muted-foreground/50 rounded-full animate-bounce\" style={{ animationDelay: '0ms' }} />\n                        <span className=\"w-2 h-2 bg-muted-foreground/50 rounded-full animate-bounce\" style={{ animationDelay: '150ms' }} />\n                        <span className=\"w-2 h-2 bg-muted-foreground/50 rounded-full animate-bounce\" style={{ animationDelay: '300ms' }} />\n                        <span className=\"ml-2 text-sm text-muted-foreground\">AI is thinking...</span>\n                      </div>\n                    </div>\n                  )}\n                  \n                  <div ref={messagesEndRef} />\n                </div>\n              )}\n            </ScrollArea>\n\n            {/* Message Input */}\n            <div className=\"p-4 border-t\">\n              {/* Attachment Preview */}\n              {attachments.length > 0 && (\n                <div className=\"mb-2\">\n                  <AIFileAttachment\n                    attachments={attachments}\n                    onAttachmentsChange={setAttachments}\n                    disabled={sendMessageMutation.isPending}\n                  />\n                </div>\n              )}\n              \n              <form onSubmit={handleSendMessage} className=\"flex gap-2 items-end\">\n                <AIFileAttachment\n                  attachments={[]}\n                  onAttachmentsChange={(newFiles) => setAttachments(prev => [...prev, ...newFiles])}\n                  disabled={sendMessageMutation.isPending}\n                />\n                <AIMentionInput\n                  value={messageInput}\n                  onChange={setMessageInput}\n                  placeholder=\"Ask me anything about your project... Use @ to mention items\"\n                  onKeyDown={(e) => {\n                    if (e.key === 'Enter' && !e.shiftKey) {\n                      e.preventDefault();\n                      handleSendMessage(e as any);\n                    }\n                  }}\n                  disabled={sendMessageMutation.isPending}\n                />\n                <Button\n                  type=\"submit\"\n                  size=\"icon\"\n                  disabled={!messageInput.trim() || sendMessageMutation.isPending}\n                  data-testid=\"button-send\"\n                >\n                  <Send className=\"h-4 w-4\" />\n                </Button>\n              </form>\n              <p className=\"text-xs text-muted-foreground mt-2\" data-testid=\"text-hint\">\n                Press Enter to send, Shift+Enter for new line. Use @ to mention items, or click the paperclip to attach files.\n              </p>\n            </div>\n          </>\n        )}\n      </Card>\n\n      {/* Delete Confirmation Dialog */}\n      <Dialog open={deleteDialogOpen} onOpenChange={setDeleteDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle data-testid=\"text-delete-dialog-title\">Delete Conversation</DialogTitle>\n            <DialogDescription data-testid=\"text-delete-dialog-description\">\n              Are you sure you want to delete this conversation? This action cannot be undone.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"flex gap-2 justify-end\">\n            <Button\n              variant=\"outline\"\n              onClick={() => setDeleteDialogOpen(false)}\n              data-testid=\"button-cancel-delete\"\n            >\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={() => conversationToDelete && deleteConversationMutation.mutate(conversationToDelete)}\n              disabled={deleteConversationMutation.isPending}\n              data-testid=\"button-confirm-delete\"\n            >\n              Delete\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Rename Conversation Dialog */}\n      <Dialog open={renameDialogOpen} onOpenChange={setRenameDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle data-testid=\"text-rename-dialog-title\">Rename Conversation</DialogTitle>\n            <DialogDescription data-testid=\"text-rename-dialog-description\">\n              Enter a new name for this conversation.\n            </DialogDescription>\n          </DialogHeader>\n          <Input\n            value={newTitle}\n            onChange={(e) => setNewTitle(e.target.value)}\n            placeholder=\"Conversation name...\"\n            maxLength={100}\n            onKeyDown={(e) => {\n              if (e.key === 'Enter') {\n                e.preventDefault();\n                handleRenameSubmit();\n              }\n            }}\n            data-testid=\"input-rename\"\n          />\n          <div className=\"flex gap-2 justify-end\">\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setRenameDialogOpen(false);\n                setConversationToRename(null);\n                setNewTitle(\"\");\n              }}\n              data-testid=\"button-cancel-rename\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handleRenameSubmit}\n              disabled={!newTitle.trim() || renameConversationMutation.isPending}\n              data-testid=\"button-confirm-rename\"\n            >\n              Rename\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* AI Settings Modal */}\n      <AISettingsModal\n        open={settingsOpen}\n        onOpenChange={setSettingsOpen}\n        onSettingsChange={setAiSettings}\n      />\n    </div>\n  );\n}\n","size_bytes":28548},"client/src/hooks/useWebSocket.ts":{"content":"import { useEffect, useRef, useCallback, useState } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { queryClient } from \"@/lib/queryClient\";\n\ntype EventType =\n  | \"task-created\"\n  | \"task-updated\"\n  | \"task-deleted\"\n  | \"risk-created\"\n  | \"risk-updated\"\n  | \"risk-deleted\"\n  | \"issue-created\"\n  | \"issue-updated\"\n  | \"issue-deleted\"\n  | \"stakeholder-created\"\n  | \"stakeholder-updated\"\n  | \"stakeholder-deleted\"\n  | \"cost-item-created\"\n  | \"cost-item-updated\"\n  | \"cost-item-deleted\"\n  | \"project-updated\"\n  | \"user-joined\"\n  | \"user-left\"\n  | \"cursor-move\"\n  | \"comment-added\";\n\ninterface WebSocketMessage {\n  type: EventType | \"authenticated\" | \"project-joined\" | \"organization-joined\" | \"error\" | \"pong\";\n  payload: any;\n  timestamp?: number;\n  userId?: string;\n}\n\ninterface UseWebSocketOptions {\n  projectId?: number;\n  organizationId?: number;\n  onMessage?: (message: WebSocketMessage) => void;\n  onUserJoined?: (userId: string) => void;\n  onUserLeft?: (userId: string) => void;\n  autoInvalidateQueries?: boolean;\n}\n\nexport function useWebSocket(options: UseWebSocketOptions = {}) {\n  const { user } = useAuth();\n  const wsRef = useRef<WebSocket | null>(null);\n  const [isConnected, setIsConnected] = useState(false);\n  const [connectedUsers, setConnectedUsers] = useState<string[]>([]);\n  const reconnectTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const pingIntervalRef = useRef<NodeJS.Timeout | null>(null);\n  const optionsRef = useRef(options);\n\n  optionsRef.current = options;\n\n  const invalidateProjectQueries = useCallback((projectId: number, eventType: EventType) => {\n    const entityType = eventType.split(\"-\")[0];\n\n    switch (entityType) {\n      case \"task\":\n        queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/tasks`] });\n        break;\n      case \"risk\":\n        queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/risks`] });\n        break;\n      case \"issue\":\n        queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/issues`] });\n        break;\n      case \"stakeholder\":\n        queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/stakeholders`] });\n        break;\n      case \"cost\":\n        queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}/costs`] });\n        break;\n      case \"project\":\n        queryClient.invalidateQueries({ queryKey: [`/api/projects/${projectId}`] });\n        break;\n    }\n  }, []);\n\n  const handleMessage = useCallback((event: MessageEvent) => {\n    try {\n      const message: WebSocketMessage = JSON.parse(event.data);\n\n      switch (message.type) {\n        case \"authenticated\":\n          console.log(\"[WS] Authenticated successfully\");\n          if (optionsRef.current.projectId) {\n            wsRef.current?.send(\n              JSON.stringify({\n                type: \"join-project\",\n                payload: { projectId: optionsRef.current.projectId },\n              })\n            );\n          }\n          if (optionsRef.current.organizationId) {\n            wsRef.current?.send(\n              JSON.stringify({\n                type: \"join-organization\",\n                payload: { organizationId: optionsRef.current.organizationId },\n              })\n            );\n          }\n          break;\n\n        case \"project-joined\":\n          console.log(\"[WS] Joined project:\", message.payload.projectId);\n          setConnectedUsers(message.payload.users || []);\n          break;\n\n        case \"organization-joined\":\n          console.log(\"[WS] Joined organization:\", message.payload.organizationId);\n          break;\n\n        case \"user-joined\":\n          console.log(\"[WS] User joined:\", message.payload.userId);\n          setConnectedUsers((prev) => {\n            if (!prev.includes(message.payload.userId)) {\n              return [...prev, message.payload.userId];\n            }\n            return prev;\n          });\n          optionsRef.current.onUserJoined?.(message.payload.userId);\n          break;\n\n        case \"user-left\":\n          console.log(\"[WS] User left:\", message.payload.userId);\n          setConnectedUsers((prev) => prev.filter((id) => id !== message.payload.userId));\n          optionsRef.current.onUserLeft?.(message.payload.userId);\n          break;\n\n        case \"error\":\n          console.error(\"[WS] Error:\", message.payload.message);\n          break;\n\n        case \"pong\":\n          break;\n\n        default:\n          if (\n            optionsRef.current.autoInvalidateQueries !== false &&\n            message.payload?.projectId\n          ) {\n            invalidateProjectQueries(message.payload.projectId, message.type as EventType);\n          }\n          optionsRef.current.onMessage?.(message);\n      }\n    } catch (error) {\n      console.error(\"[WS] Failed to parse message:\", error);\n    }\n  }, [invalidateProjectQueries]);\n\n  const connect = useCallback(() => {\n    if (!user?.id) return;\n    if (wsRef.current?.readyState === WebSocket.OPEN) return;\n\n    const protocol = window.location.protocol === \"https:\" ? \"wss:\" : \"ws:\";\n    const wsUrl = `${protocol}//${window.location.host}/ws`;\n\n    console.log(\"[WS] Connecting to:\", wsUrl);\n    const ws = new WebSocket(wsUrl);\n    wsRef.current = ws;\n\n    ws.onopen = () => {\n      console.log(\"[WS] Connected\");\n      setIsConnected(true);\n\n      pingIntervalRef.current = setInterval(() => {\n        if (ws.readyState === WebSocket.OPEN) {\n          ws.send(JSON.stringify({ type: \"ping\" }));\n        }\n      }, 25000);\n    };\n\n    ws.onmessage = handleMessage;\n\n    ws.onclose = () => {\n      console.log(\"[WS] Disconnected\");\n      setIsConnected(false);\n      setConnectedUsers([]);\n\n      if (pingIntervalRef.current) {\n        clearInterval(pingIntervalRef.current);\n        pingIntervalRef.current = null;\n      }\n\n      reconnectTimeoutRef.current = setTimeout(() => {\n        connect();\n      }, 3000);\n    };\n\n    ws.onerror = (error) => {\n      console.error(\"[WS] Error:\", error);\n    };\n  }, [user?.id, handleMessage]);\n\n  const disconnect = useCallback(() => {\n    if (reconnectTimeoutRef.current) {\n      clearTimeout(reconnectTimeoutRef.current);\n      reconnectTimeoutRef.current = null;\n    }\n\n    if (pingIntervalRef.current) {\n      clearInterval(pingIntervalRef.current);\n      pingIntervalRef.current = null;\n    }\n\n    if (wsRef.current) {\n      wsRef.current.close();\n      wsRef.current = null;\n    }\n\n    setIsConnected(false);\n    setConnectedUsers([]);\n  }, []);\n\n  const joinProject = useCallback((projectId: number) => {\n    if (wsRef.current?.readyState === WebSocket.OPEN) {\n      wsRef.current.send(\n        JSON.stringify({\n          type: \"join-project\",\n          payload: { projectId },\n        })\n      );\n    }\n  }, []);\n\n  const leaveProject = useCallback(() => {\n    if (wsRef.current?.readyState === WebSocket.OPEN) {\n      wsRef.current.send(\n        JSON.stringify({\n          type: \"leave-project\",\n          payload: {},\n        })\n      );\n    }\n  }, []);\n\n  const sendCursorPosition = useCallback((x: number, y: number, elementId?: string) => {\n    if (wsRef.current?.readyState === WebSocket.OPEN) {\n      wsRef.current.send(\n        JSON.stringify({\n          type: \"cursor-move\",\n          payload: { x, y, elementId },\n        })\n      );\n    }\n  }, []);\n\n  useEffect(() => {\n    connect();\n\n    return () => {\n      disconnect();\n    };\n  }, [connect, disconnect]);\n\n  useEffect(() => {\n    if (isConnected && options.projectId) {\n      joinProject(options.projectId);\n    }\n  }, [isConnected, options.projectId, joinProject]);\n\n  return {\n    isConnected,\n    connectedUsers,\n    joinProject,\n    leaveProject,\n    sendCursorPosition,\n    disconnect,\n  };\n}\n","size_bytes":7674},"server/objectAcl.ts":{"content":"import { File } from \"@google-cloud/storage\";\n\nconst ACL_POLICY_METADATA_KEY = \"custom:aclPolicy\";\n\nexport enum ObjectAccessGroupType {\n  ORGANIZATION = \"organization\",\n  USER_LIST = \"user_list\",\n}\n\nexport interface ObjectAccessGroup {\n  type: ObjectAccessGroupType;\n  id: string;\n}\n\nexport enum ObjectPermission {\n  READ = \"read\",\n  WRITE = \"write\",\n}\n\nexport interface ObjectAclRule {\n  group: ObjectAccessGroup;\n  permission: ObjectPermission;\n}\n\nexport interface ObjectAclPolicy {\n  owner: string;\n  organizationId: number;\n  visibility: \"public\" | \"private\";\n  aclRules?: Array<ObjectAclRule>;\n}\n\nfunction isPermissionAllowed(\n  requested: ObjectPermission,\n  granted: ObjectPermission,\n): boolean {\n  if (requested === ObjectPermission.READ) {\n    return [ObjectPermission.READ, ObjectPermission.WRITE].includes(granted);\n  }\n  return granted === ObjectPermission.WRITE;\n}\n\nexport async function setObjectAclPolicy(\n  objectFile: File,\n  aclPolicy: ObjectAclPolicy,\n): Promise<void> {\n  const [exists] = await objectFile.exists();\n  if (!exists) {\n    throw new Error(`Object not found: ${objectFile.name}`);\n  }\n\n  await objectFile.setMetadata({\n    metadata: {\n      [ACL_POLICY_METADATA_KEY]: JSON.stringify(aclPolicy),\n    },\n  });\n}\n\nexport async function getObjectAclPolicy(\n  objectFile: File,\n): Promise<ObjectAclPolicy | null> {\n  const [metadata] = await objectFile.getMetadata();\n  const aclPolicy = metadata?.metadata?.[ACL_POLICY_METADATA_KEY];\n  if (!aclPolicy) {\n    return null;\n  }\n  return JSON.parse(aclPolicy as string);\n}\n\nexport async function canAccessObject({\n  userId,\n  objectFile,\n  requestedPermission,\n  userOrganizationIds = [],\n}: {\n  userId?: string;\n  objectFile: File;\n  requestedPermission: ObjectPermission;\n  userOrganizationIds?: number[];\n}): Promise<boolean> {\n  const aclPolicy = await getObjectAclPolicy(objectFile);\n  if (!aclPolicy) {\n    return false;\n  }\n\n  if (\n    aclPolicy.visibility === \"public\" &&\n    requestedPermission === ObjectPermission.READ\n  ) {\n    return true;\n  }\n\n  if (!userId) {\n    return false;\n  }\n\n  if (aclPolicy.owner === userId) {\n    return true;\n  }\n\n  if (userOrganizationIds.includes(aclPolicy.organizationId)) {\n    return true;\n  }\n\n  for (const rule of aclPolicy.aclRules || []) {\n    if (\n      rule.group.type === ObjectAccessGroupType.ORGANIZATION &&\n      userOrganizationIds.includes(parseInt(rule.group.id)) &&\n      isPermissionAllowed(requestedPermission, rule.permission)\n    ) {\n      return true;\n    }\n  }\n\n  return false;\n}\n","size_bytes":2523},"client/src/pages/SettingsPage.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport { Cloud, HardDrive, RefreshCw, Unlink, Check, AlertCircle, Clock, Loader2, ExternalLink, FolderSync, Sparkles, Mail, Users, FolderKanban, CreditCard, Tags, Replace, Search } from \"lucide-react\";\nimport { Input } from \"@/components/ui/input\";\nimport { SiGoogledrive, SiDropbox } from \"react-icons/si\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { format, formatDistanceToNow } from \"date-fns\";\n\ninterface CloudStorageProvider {\n  id: string;\n  name: string;\n  icon: string;\n  configured: boolean;\n}\n\ninterface CloudStorageConnection {\n  id: number;\n  provider: string;\n  accountEmail: string | null;\n  accountName: string | null;\n  rootFolderName: string | null;\n  syncEnabled: boolean;\n  syncStatus: string;\n  lastSyncAt: string | null;\n  syncError: string | null;\n  createdAt: string;\n}\n\ninterface StorageQuota {\n  usedBytes: number;\n  quotaBytes: number;\n  usedPercent: number;\n}\n\ninterface UsageStats {\n  storage: { usedBytes: number; quotaBytes: number; usedPercent: number };\n  ai: { tokensUsed: number; tokenLimit: number; requestCount: number; usedPercent: number };\n  email: { emailsSent: number; emailLimit: number; usedPercent: number };\n  projects: { count: number; limit: number };\n  users: { count: number; limit: number };\n  plan: { tier: string; name: string; includesCloudSync: boolean; includesAdvancedReports: boolean } | null;\n}\n\nfunction ProviderIcon({ provider, className = \"h-5 w-5\" }: { provider: string; className?: string }) {\n  switch (provider) {\n    case \"google_drive\":\n      return <SiGoogledrive className={className} />;\n    case \"onedrive\":\n      return <Cloud className={className} />;\n    case \"dropbox\":\n      return <SiDropbox className={className} />;\n    default:\n      return <Cloud className={className} />;\n  }\n}\n\nfunction formatBytes(bytes: number): string {\n  if (bytes === 0) return \"0 B\";\n  const k = 1024;\n  const sizes = [\"B\", \"KB\", \"MB\", \"GB\", \"TB\"];\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\n  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + \" \" + sizes[i];\n}\n\n// Label Management Section Component\ninterface LabelData {\n  value: string;\n  disciplineEnum?: string | null;\n  disciplineLabel?: string | null;\n  linkedUserId?: string | null;\n  taskCount: number;\n}\n\nfunction LabelManagementSection({ projectId }: { projectId: number }) {\n  const { toast } = useToast();\n  const [replaceDialogOpen, setReplaceDialogOpen] = useState(false);\n  const [selectedLabel, setSelectedLabel] = useState<{ type: 'discipline' | 'assignee'; value: string } | null>(null);\n  const [newValue, setNewValue] = useState('');\n  const [searchTerm, setSearchTerm] = useState('');\n\n  // Fetch discipline labels - only when projectId is valid\n  const { data: disciplineData, isLoading: disciplinesLoading, refetch: refetchDisciplines } = useQuery<{ disciplines: LabelData[]; total: number }>({\n    queryKey: ['/api/projects', projectId, 'labels', 'disciplines'],\n    enabled: Boolean(projectId),\n  });\n\n  // Fetch assignee labels - only when projectId is valid\n  const { data: assigneeData, isLoading: assigneesLoading, refetch: refetchAssignees } = useQuery<{ assignees: LabelData[]; total: number }>({\n    queryKey: ['/api/projects', projectId, 'labels', 'assignees'],\n    enabled: Boolean(projectId),\n  });\n\n  // Replace discipline mutation - guard against undefined projectId\n  const replaceDisciplineMutation = useMutation({\n    mutationFn: async ({ oldValue, newValue }: { oldValue: string; newValue: string }) => {\n      if (!projectId) throw new Error('No project selected');\n      const res = await apiRequest('POST', `/api/projects/${projectId}/labels/disciplines/replace`, { oldValue, newValue, updateEnum: true });\n      return res.json();\n    },\n    onSuccess: (data: { message?: string; updated?: number }) => {\n      toast({\n        title: \"Labels Updated\",\n        description: data.message || `Successfully updated ${data.updated || 0} tasks`,\n      });\n      refetchDisciplines();\n      setReplaceDialogOpen(false);\n      setSelectedLabel(null);\n      setNewValue('');\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Update Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Replace assignee mutation - guard against undefined projectId\n  const replaceAssigneeMutation = useMutation({\n    mutationFn: async ({ oldValue, newValue }: { oldValue: string; newValue: string }) => {\n      if (!projectId) throw new Error('No project selected');\n      const res = await apiRequest('POST', `/api/projects/${projectId}/labels/assignees/replace`, { oldValue, newValue });\n      return res.json();\n    },\n    onSuccess: (data: { message?: string; updated?: number }) => {\n      toast({\n        title: \"Labels Updated\",\n        description: data.message || `Successfully updated ${data.updated || 0} tasks`,\n      });\n      refetchAssignees();\n      setReplaceDialogOpen(false);\n      setSelectedLabel(null);\n      setNewValue('');\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Update Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleReplace = () => {\n    if (!selectedLabel || !newValue.trim()) return;\n    \n    if (selectedLabel.type === 'discipline') {\n      replaceDisciplineMutation.mutate({ oldValue: selectedLabel.value, newValue: newValue.trim() });\n    } else {\n      replaceAssigneeMutation.mutate({ oldValue: selectedLabel.value, newValue: newValue.trim() });\n    }\n  };\n\n  const filteredDisciplines = (disciplineData?.disciplines || []).filter(d => \n    d.value.toLowerCase().includes(searchTerm.toLowerCase())\n  );\n\n  const filteredAssignees = (assigneeData?.assignees || []).filter(a => \n    a.value.toLowerCase().includes(searchTerm.toLowerCase())\n  );\n\n  return (\n    <div className=\"space-y-6\">\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Tags className=\"h-5 w-5\" />\n            Label Management\n          </CardTitle>\n          <CardDescription>\n            Normalize discipline and assignee labels for consistency. After importing data with flexible labels, use this tool to standardize terminology across your project.\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"relative\">\n            <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n            <Input\n              placeholder=\"Search labels...\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              className=\"pl-10\"\n              data-testid=\"input-search-labels\"\n            />\n          </div>\n        </CardContent>\n      </Card>\n\n      <div className=\"grid gap-6 md:grid-cols-2\">\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-lg\">Discipline Labels</CardTitle>\n            <CardDescription>\n              {disciplineData?.disciplines?.length || 0} unique discipline values in {disciplineData?.total || 0} tasks\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            {disciplinesLoading ? (\n              <div className=\"space-y-2\">\n                <Skeleton className=\"h-10\" />\n                <Skeleton className=\"h-10\" />\n                <Skeleton className=\"h-10\" />\n              </div>\n            ) : filteredDisciplines.length === 0 ? (\n              <p className=\"text-muted-foreground text-center py-8\">\n                No discipline labels found\n              </p>\n            ) : (\n              <div className=\"space-y-2 max-h-80 overflow-y-auto\">\n                {filteredDisciplines.map((label) => (\n                  <div\n                    key={label.value}\n                    className=\"flex items-center justify-between p-3 rounded-lg border hover-elevate\"\n                    data-testid={`label-discipline-${label.value}`}\n                  >\n                    <div className=\"flex items-center gap-3\">\n                      <Badge variant=\"outline\">{label.taskCount}</Badge>\n                      <div>\n                        <p className=\"font-medium\">{label.value}</p>\n                        {label.disciplineLabel && label.disciplineLabel !== label.value && (\n                          <p className=\"text-xs text-muted-foreground\">Label: {label.disciplineLabel}</p>\n                        )}\n                      </div>\n                    </div>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={() => {\n                        setSelectedLabel({ type: 'discipline', value: label.value });\n                        setNewValue(label.value);\n                        setReplaceDialogOpen(true);\n                      }}\n                      data-testid={`button-replace-discipline-${label.value}`}\n                    >\n                      <Replace className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                ))}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-lg\">Assignee Labels</CardTitle>\n            <CardDescription>\n              {assigneeData?.assignees?.length || 0} unique assignee identifiers\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            {assigneesLoading ? (\n              <div className=\"space-y-2\">\n                <Skeleton className=\"h-10\" />\n                <Skeleton className=\"h-10\" />\n                <Skeleton className=\"h-10\" />\n              </div>\n            ) : filteredAssignees.length === 0 ? (\n              <p className=\"text-muted-foreground text-center py-8\">\n                No assignee labels found\n              </p>\n            ) : (\n              <div className=\"space-y-2 max-h-80 overflow-y-auto\">\n                {filteredAssignees.map((label) => (\n                  <div\n                    key={label.value}\n                    className=\"flex items-center justify-between p-3 rounded-lg border hover-elevate\"\n                    data-testid={`label-assignee-${label.value}`}\n                  >\n                    <div className=\"flex items-center gap-3\">\n                      <Badge variant=\"outline\">{label.taskCount}</Badge>\n                      <div>\n                        <p className=\"font-medium\">{label.value}</p>\n                        {label.linkedUserId && (\n                          <p className=\"text-xs text-muted-foreground\">Linked to user</p>\n                        )}\n                      </div>\n                    </div>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={() => {\n                        setSelectedLabel({ type: 'assignee', value: label.value });\n                        setNewValue(label.value);\n                        setReplaceDialogOpen(true);\n                      }}\n                      data-testid={`button-replace-assignee-${label.value}`}\n                    >\n                      <Replace className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                ))}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      <AlertDialog open={replaceDialogOpen} onOpenChange={setReplaceDialogOpen}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Replace Label</AlertDialogTitle>\n            <AlertDialogDescription>\n              Replace all occurrences of \"{selectedLabel?.value}\" with a new value. This will update all tasks that use this {selectedLabel?.type === 'discipline' ? 'discipline' : 'assignee'} label.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <div className=\"py-4\">\n            <Input\n              value={newValue}\n              onChange={(e) => setNewValue(e.target.value)}\n              placeholder=\"Enter new value...\"\n              data-testid=\"input-new-label-value\"\n            />\n          </div>\n          <AlertDialogFooter>\n            <AlertDialogCancel onClick={() => {\n              setSelectedLabel(null);\n              setNewValue('');\n            }}>\n              Cancel\n            </AlertDialogCancel>\n            <AlertDialogAction\n              onClick={handleReplace}\n              disabled={!newValue.trim() || (replaceDisciplineMutation.isPending || replaceAssigneeMutation.isPending)}\n            >\n              {(replaceDisciplineMutation.isPending || replaceAssigneeMutation.isPending) ? (\n                <>\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  Updating...\n                </>\n              ) : (\n                'Replace All'\n              )}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n\nexport default function SettingsPage() {\n  const { selectedProject } = useProject();\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  const searchParams = new URLSearchParams(window.location.search);\n  \n  const [disconnectingId, setDisconnectingId] = useState<number | null>(null);\n  const [syncingId, setSyncingId] = useState<number | null>(null);\n\n  const organizationId = selectedProject?.organizationId;\n\n  useEffect(() => {\n    const success = searchParams.get(\"success\");\n    const error = searchParams.get(\"error\");\n    const provider = searchParams.get(\"provider\");\n\n    if (success === \"cloud_storage_connected\" && provider) {\n      toast({\n        title: \"Cloud Storage Connected\",\n        description: `Successfully connected your ${provider.replace(\"_\", \" \")} account.`,\n      });\n      window.history.replaceState({}, \"\", \"/settings\");\n    } else if (error) {\n      let errorMessage = \"An error occurred during connection.\";\n      if (error === \"oauth_failed\") errorMessage = \"OAuth authentication failed.\";\n      if (error === \"state_expired\") errorMessage = \"Session expired. Please try again.\";\n      if (error === \"invalid_callback\") errorMessage = \"Invalid callback received.\";\n      \n      toast({\n        title: \"Connection Failed\",\n        description: errorMessage,\n        variant: \"destructive\",\n      });\n      window.history.replaceState({}, \"\", \"/settings\");\n    }\n  }, [searchParams, toast]);\n\n  const { data: providers = [], isLoading: providersLoading } = useQuery<CloudStorageProvider[]>({\n    queryKey: [\"/api/cloud-storage/providers\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/cloud-storage/providers\", { credentials: \"include\" });\n      if (!response.ok) throw new Error(\"Failed to fetch providers\");\n      return response.json();\n    },\n  });\n\n  const { data: connections = [], isLoading: connectionsLoading } = useQuery<CloudStorageConnection[]>({\n    queryKey: [\"/api/organizations\", organizationId, \"cloud-storage\"],\n    enabled: !!organizationId,\n    queryFn: async () => {\n      const response = await fetch(`/api/organizations/${organizationId}/cloud-storage`, { credentials: \"include\" });\n      if (!response.ok) throw new Error(\"Failed to fetch connections\");\n      return response.json();\n    },\n  });\n\n  const { data: storageQuota, isLoading: quotaLoading } = useQuery<StorageQuota>({\n    queryKey: [\"/api/organizations\", organizationId, \"storage\"],\n    enabled: !!organizationId,\n    queryFn: async () => {\n      const response = await fetch(`/api/organizations/${organizationId}/storage`, { credentials: \"include\" });\n      if (!response.ok) throw new Error(\"Failed to fetch storage quota\");\n      return response.json();\n    },\n  });\n\n  const { data: usageStats, isLoading: usageLoading } = useQuery<UsageStats>({\n    queryKey: [\"/api/organizations\", organizationId, \"usage\"],\n    enabled: !!organizationId,\n    queryFn: async () => {\n      const response = await fetch(`/api/organizations/${organizationId}/usage`, { credentials: \"include\" });\n      if (!response.ok) throw new Error(\"Failed to fetch usage stats\");\n      return response.json();\n    },\n  });\n\n  const connectMutation = useMutation({\n    mutationFn: async (provider: string) => {\n      const response = await apiRequest(\"POST\", `/api/organizations/${organizationId}/cloud-storage/auth-url`, {\n        provider,\n      });\n      return response.json();\n    },\n    onSuccess: (data) => {\n      window.location.href = data.authUrl;\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Connection Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const disconnectMutation = useMutation({\n    mutationFn: async (connectionId: number) => {\n      await apiRequest(\"DELETE\", `/api/organizations/${organizationId}/cloud-storage/${connectionId}`);\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Disconnected\",\n        description: \"Cloud storage has been disconnected.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/organizations\", organizationId, \"cloud-storage\"] });\n      setDisconnectingId(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Disconnect Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const syncMutation = useMutation({\n    mutationFn: async ({ connectionId, projectId }: { connectionId: number; projectId: number }) => {\n      const response = await apiRequest(\"POST\", `/api/organizations/${organizationId}/cloud-storage/${connectionId}/sync`, {\n        projectId,\n      });\n      return response.json();\n    },\n    onSuccess: (data) => {\n      toast({\n        title: \"Sync Complete\",\n        description: `Added ${data.added} files, updated ${data.updated} files.`,\n      });\n      queryClient.invalidateQueries({ queryKey: [\"/api/organizations\", organizationId, \"cloud-storage\"] });\n      setSyncingId(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Sync Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n      setSyncingId(null);\n    },\n  });\n\n  const getConnectedProviders = () => connections.map((c) => c.provider);\n\n  if (!selectedProject) {\n    return (\n      <div className=\"p-6\">\n        <Alert>\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertDescription>\n            Please select a project to configure settings.\n          </AlertDescription>\n        </Alert>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-semibold\" data-testid=\"text-settings-title\">Settings</h1>\n        <p className=\"text-muted-foreground\">Manage integrations and storage for your organization</p>\n      </div>\n\n      <Tabs defaultValue=\"usage\" className=\"space-y-4\">\n        <TabsList>\n          <TabsTrigger value=\"usage\" data-testid=\"tab-usage\">\n            <CreditCard className=\"h-4 w-4 mr-2\" />\n            Usage & Plan\n          </TabsTrigger>\n          <TabsTrigger value=\"cloud-storage\" data-testid=\"tab-cloud-storage\">\n            <Cloud className=\"h-4 w-4 mr-2\" />\n            Cloud Storage\n          </TabsTrigger>\n          <TabsTrigger value=\"storage\" data-testid=\"tab-storage\">\n            <HardDrive className=\"h-4 w-4 mr-2\" />\n            Storage Quota\n          </TabsTrigger>\n          <TabsTrigger value=\"labels\" data-testid=\"tab-labels\">\n            <Tags className=\"h-4 w-4 mr-2\" />\n            Label Management\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"usage\" className=\"space-y-4\">\n          {usageLoading ? (\n            <div className=\"space-y-4\">\n              <Skeleton className=\"h-48\" />\n              <Skeleton className=\"h-48\" />\n            </div>\n          ) : usageStats ? (\n            <>\n              <Card>\n                <CardHeader>\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <CardTitle className=\"flex items-center gap-2\">\n                        Current Plan\n                        <Badge variant={usageStats.plan?.tier === 'free' ? 'secondary' : 'default'}>\n                          {usageStats.plan?.name || 'Free'}\n                        </Badge>\n                      </CardTitle>\n                      <CardDescription>\n                        Your organization's subscription and resource usage\n                      </CardDescription>\n                    </div>\n                    <Button variant=\"outline\" size=\"sm\" data-testid=\"button-upgrade-plan\">\n                      Upgrade Plan\n                    </Button>\n                  </div>\n                </CardHeader>\n                <CardContent className=\"space-y-6\">\n                  <div className=\"grid gap-6 md:grid-cols-2 lg:grid-cols-3\">\n                    <div className=\"space-y-2\">\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-2 text-sm font-medium\">\n                          <HardDrive className=\"h-4 w-4 text-muted-foreground\" />\n                          Storage\n                        </div>\n                        <span className=\"text-sm text-muted-foreground\">\n                          {formatBytes(usageStats.storage.usedBytes)} / {formatBytes(usageStats.storage.quotaBytes)}\n                        </span>\n                      </div>\n                      <Progress \n                        value={usageStats.storage.usedPercent} \n                        className={usageStats.storage.usedPercent > 90 ? \"bg-destructive/20\" : \"\"}\n                      />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-2 text-sm font-medium\">\n                          <Sparkles className=\"h-4 w-4 text-muted-foreground\" />\n                          AI Tokens\n                        </div>\n                        <span className=\"text-sm text-muted-foreground\">\n                          {usageStats.ai.tokensUsed.toLocaleString()} / {usageStats.ai.tokenLimit.toLocaleString()}\n                        </span>\n                      </div>\n                      <Progress \n                        value={usageStats.ai.usedPercent} \n                        className={usageStats.ai.usedPercent > 90 ? \"bg-destructive/20\" : \"\"}\n                      />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-2 text-sm font-medium\">\n                          <Mail className=\"h-4 w-4 text-muted-foreground\" />\n                          Emails Sent\n                        </div>\n                        <span className=\"text-sm text-muted-foreground\">\n                          {usageStats.email.emailsSent} / {usageStats.email.emailLimit}\n                        </span>\n                      </div>\n                      <Progress \n                        value={usageStats.email.usedPercent} \n                        className={usageStats.email.usedPercent > 90 ? \"bg-destructive/20\" : \"\"}\n                      />\n                    </div>\n                  </div>\n                  \n                  <Separator />\n                  \n                  <div className=\"grid gap-4 md:grid-cols-2\">\n                    <div className=\"flex items-center justify-between p-4 rounded-lg border\">\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"p-2 rounded-md bg-muted\">\n                          <FolderKanban className=\"h-5 w-5\" />\n                        </div>\n                        <div>\n                          <p className=\"font-medium\">Projects</p>\n                          <p className=\"text-sm text-muted-foreground\">Active projects</p>\n                        </div>\n                      </div>\n                      <div className=\"text-right\">\n                        <p className=\"text-2xl font-semibold\">{usageStats.projects.count}</p>\n                        <p className=\"text-sm text-muted-foreground\">of {usageStats.projects.limit} max</p>\n                      </div>\n                    </div>\n                    \n                    <div className=\"flex items-center justify-between p-4 rounded-lg border\">\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"p-2 rounded-md bg-muted\">\n                          <Users className=\"h-5 w-5\" />\n                        </div>\n                        <div>\n                          <p className=\"font-medium\">Team Members</p>\n                          <p className=\"text-sm text-muted-foreground\">Organization users</p>\n                        </div>\n                      </div>\n                      <div className=\"text-right\">\n                        <p className=\"text-2xl font-semibold\">{usageStats.users.count}</p>\n                        <p className=\"text-sm text-muted-foreground\">of {usageStats.users.limit} max</p>\n                      </div>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader>\n                  <CardTitle>Plan Features</CardTitle>\n                  <CardDescription>\n                    Features included in your current subscription\n                  </CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"grid gap-3 md:grid-cols-2 lg:grid-cols-3\">\n                    <div className=\"flex items-center gap-2 p-3 rounded-lg border\">\n                      {usageStats.plan?.includesCloudSync ? (\n                        <Check className=\"h-4 w-4 text-green-500\" />\n                      ) : (\n                        <AlertCircle className=\"h-4 w-4 text-muted-foreground\" />\n                      )}\n                      <span className={!usageStats.plan?.includesCloudSync ? \"text-muted-foreground\" : \"\"}>\n                        Cloud Storage Sync\n                      </span>\n                    </div>\n                    <div className=\"flex items-center gap-2 p-3 rounded-lg border\">\n                      {usageStats.plan?.includesAdvancedReports ? (\n                        <Check className=\"h-4 w-4 text-green-500\" />\n                      ) : (\n                        <AlertCircle className=\"h-4 w-4 text-muted-foreground\" />\n                      )}\n                      <span className={!usageStats.plan?.includesAdvancedReports ? \"text-muted-foreground\" : \"\"}>\n                        Advanced Reports\n                      </span>\n                    </div>\n                    <div className=\"flex items-center gap-2 p-3 rounded-lg border\">\n                      <Check className=\"h-4 w-4 text-green-500\" />\n                      <span>AI Assistant</span>\n                    </div>\n                    <div className=\"flex items-center gap-2 p-3 rounded-lg border\">\n                      <Check className=\"h-4 w-4 text-green-500\" />\n                      <span>Email Notifications</span>\n                    </div>\n                    <div className=\"flex items-center gap-2 p-3 rounded-lg border\">\n                      <Check className=\"h-4 w-4 text-green-500\" />\n                      <span>Real-time Collaboration</span>\n                    </div>\n                    <div className=\"flex items-center gap-2 p-3 rounded-lg border\">\n                      <Check className=\"h-4 w-4 text-green-500\" />\n                      <span>PDF Reports</span>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            </>\n          ) : (\n            <Card>\n              <CardContent className=\"py-8\">\n                <p className=\"text-muted-foreground text-center\">\n                  Unable to load usage information.\n                </p>\n              </CardContent>\n            </Card>\n          )}\n        </TabsContent>\n\n        <TabsContent value=\"cloud-storage\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Connected Cloud Storage</CardTitle>\n              <CardDescription>\n                Connect your cloud storage accounts to sync files with your projects.\n                Files are synchronized one-way from cloud storage to the platform.\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              {connectionsLoading ? (\n                <div className=\"space-y-4\">\n                  <Skeleton className=\"h-20 w-full\" />\n                  <Skeleton className=\"h-20 w-full\" />\n                </div>\n              ) : connections.length === 0 ? (\n                <p className=\"text-muted-foreground text-center py-8\">\n                  No cloud storage connected. Connect a provider below.\n                </p>\n              ) : (\n                <div className=\"space-y-3\">\n                  {connections.map((connection) => (\n                    <div\n                      key={connection.id}\n                      className=\"flex items-center justify-between p-4 rounded-lg border bg-card\"\n                      data-testid={`connection-${connection.provider}`}\n                    >\n                      <div className=\"flex items-center gap-4\">\n                        <div className=\"p-2 rounded-md bg-muted\">\n                          <ProviderIcon provider={connection.provider} className=\"h-6 w-6\" />\n                        </div>\n                        <div>\n                          <div className=\"flex items-center gap-2\">\n                            <span className=\"font-medium\">{connection.accountName || connection.accountEmail}</span>\n                            {connection.syncStatus === \"syncing\" && (\n                              <Badge variant=\"outline\">\n                                <RefreshCw className=\"h-3 w-3 mr-1 animate-spin\" />\n                                Syncing\n                              </Badge>\n                            )}\n                            {connection.syncStatus === \"error\" && (\n                              <Badge variant=\"destructive\">\n                                <AlertCircle className=\"h-3 w-3 mr-1\" />\n                                Error\n                              </Badge>\n                            )}\n                            {connection.syncStatus === \"idle\" && connection.lastSyncAt && (\n                              <Badge variant=\"secondary\">\n                                <Check className=\"h-3 w-3 mr-1\" />\n                                Synced\n                              </Badge>\n                            )}\n                          </div>\n                          <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                            <span>{connection.accountEmail}</span>\n                            {connection.lastSyncAt && (\n                              <>\n                                <span>-</span>\n                                <Clock className=\"h-3 w-3\" />\n                                <span>Last sync: {formatDistanceToNow(new Date(connection.lastSyncAt))} ago</span>\n                              </>\n                            )}\n                          </div>\n                          {connection.syncError && (\n                            <p className=\"text-sm text-destructive mt-1\">{connection.syncError}</p>\n                          )}\n                        </div>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => {\n                            setSyncingId(connection.id);\n                            syncMutation.mutate({\n                              connectionId: connection.id,\n                              projectId: selectedProject.id,\n                            });\n                          }}\n                          disabled={syncMutation.isPending && syncingId === connection.id}\n                          data-testid={`button-sync-${connection.provider}`}\n                        >\n                          {syncMutation.isPending && syncingId === connection.id ? (\n                            <Loader2 className=\"h-4 w-4 animate-spin\" />\n                          ) : (\n                            <FolderSync className=\"h-4 w-4 mr-1\" />\n                          )}\n                          Sync Now\n                        </Button>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => setDisconnectingId(connection.id)}\n                          data-testid={`button-disconnect-${connection.provider}`}\n                        >\n                          <Unlink className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle>Available Providers</CardTitle>\n              <CardDescription>\n                Connect additional cloud storage providers to access your files.\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              {providersLoading ? (\n                <div className=\"grid gap-4 md:grid-cols-3\">\n                  <Skeleton className=\"h-24\" />\n                  <Skeleton className=\"h-24\" />\n                  <Skeleton className=\"h-24\" />\n                </div>\n              ) : (\n                <div className=\"grid gap-4 md:grid-cols-3\">\n                  {providers.map((provider) => {\n                    const isConnected = getConnectedProviders().includes(provider.id);\n                    return (\n                      <div\n                        key={provider.id}\n                        className={`p-4 rounded-lg border ${isConnected ? \"bg-muted/50\" : \"bg-card hover-elevate\"}`}\n                        data-testid={`provider-${provider.id}`}\n                      >\n                        <div className=\"flex items-center gap-3 mb-3\">\n                          <div className=\"p-2 rounded-md bg-muted\">\n                            <ProviderIcon provider={provider.id} className=\"h-5 w-5\" />\n                          </div>\n                          <span className=\"font-medium\">{provider.name}</span>\n                        </div>\n                        {isConnected ? (\n                          <Badge variant=\"secondary\" className=\"w-full justify-center\">\n                            <Check className=\"h-3 w-3 mr-1\" />\n                            Connected\n                          </Badge>\n                        ) : provider.configured ? (\n                          <Button\n                            size=\"sm\"\n                            className=\"w-full\"\n                            onClick={() => connectMutation.mutate(provider.id)}\n                            disabled={connectMutation.isPending}\n                            data-testid={`button-connect-${provider.id}`}\n                          >\n                            {connectMutation.isPending ? (\n                              <Loader2 className=\"h-4 w-4 animate-spin mr-1\" />\n                            ) : (\n                              <ExternalLink className=\"h-4 w-4 mr-1\" />\n                            )}\n                            Connect\n                          </Button>\n                        ) : (\n                          <Badge variant=\"outline\" className=\"w-full justify-center\">\n                            Not Configured\n                          </Badge>\n                        )}\n                      </div>\n                    );\n                  })}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"storage\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Storage Usage</CardTitle>\n              <CardDescription>\n                Monitor your organization's storage usage and quota.\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              {quotaLoading ? (\n                <Skeleton className=\"h-32\" />\n              ) : storageQuota ? (\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-2xl font-semibold\">\n                      {formatBytes(storageQuota.usedBytes)}\n                    </span>\n                    <span className=\"text-muted-foreground\">\n                      of {formatBytes(storageQuota.quotaBytes)}\n                    </span>\n                  </div>\n                  <div className=\"h-4 rounded-full bg-muted overflow-hidden\">\n                    <div\n                      className={`h-full transition-all ${\n                        storageQuota.usedPercent > 90\n                          ? \"bg-destructive\"\n                          : storageQuota.usedPercent > 75\n                          ? \"bg-yellow-500\"\n                          : \"bg-primary\"\n                      }`}\n                      style={{ width: `${Math.min(storageQuota.usedPercent, 100)}%` }}\n                    />\n                  </div>\n                  <p className=\"text-sm text-muted-foreground text-center\">\n                    {storageQuota.usedPercent}% of storage used\n                  </p>\n                  \n                  {storageQuota.usedPercent > 90 && (\n                    <Alert variant=\"destructive\">\n                      <AlertCircle className=\"h-4 w-4\" />\n                      <AlertDescription>\n                        Storage is almost full. Consider deleting unused files or upgrading your plan.\n                      </AlertDescription>\n                    </Alert>\n                  )}\n                </div>\n              ) : (\n                <p className=\"text-muted-foreground text-center py-8\">\n                  Unable to load storage information.\n                </p>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"labels\" className=\"space-y-4\">\n          <LabelManagementSection projectId={selectedProject.id} />\n        </TabsContent>\n      </Tabs>\n\n      <AlertDialog open={disconnectingId !== null} onOpenChange={() => setDisconnectingId(null)}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Disconnect Cloud Storage</AlertDialogTitle>\n            <AlertDialogDescription>\n              Are you sure you want to disconnect this cloud storage? Synced files will remain in your projects, but future syncs will stop.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel>Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => disconnectingId && disconnectMutation.mutate(disconnectingId)}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n            >\n              Disconnect\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","size_bytes":40683},"server/cloudStorage.ts":{"content":"import { storage } from \"./storage\";\nimport type { CloudStorageConnection, CloudSyncedFile } from \"@shared/schema\";\n\n// Provider configuration types\ninterface ProviderConfig {\n  name: string;\n  displayName: string;\n  icon: string;\n  authUrl: string;\n  tokenUrl: string;\n  scopes: string[];\n  clientIdEnv: string;\n  clientSecretEnv: string;\n}\n\n// Provider configurations\nexport const CLOUD_PROVIDERS: Record<string, ProviderConfig> = {\n  google_drive: {\n    name: \"google_drive\",\n    displayName: \"Google Drive\",\n    icon: \"google-drive\",\n    authUrl: \"https://accounts.google.com/o/oauth2/v2/auth\",\n    tokenUrl: \"https://oauth2.googleapis.com/token\",\n    scopes: [\n      \"https://www.googleapis.com/auth/drive.readonly\",\n      \"https://www.googleapis.com/auth/userinfo.email\",\n      \"https://www.googleapis.com/auth/userinfo.profile\"\n    ],\n    clientIdEnv: \"GOOGLE_CLIENT_ID\",\n    clientSecretEnv: \"GOOGLE_CLIENT_SECRET\"\n  },\n  onedrive: {\n    name: \"onedrive\",\n    displayName: \"OneDrive\",\n    icon: \"microsoft-onedrive\",\n    authUrl: \"https://login.microsoftonline.com/common/oauth2/v2.0/authorize\",\n    tokenUrl: \"https://login.microsoftonline.com/common/oauth2/v2.0/token\",\n    scopes: [\n      \"Files.Read.All\",\n      \"User.Read\",\n      \"offline_access\"\n    ],\n    clientIdEnv: \"ONEDRIVE_CLIENT_ID\",\n    clientSecretEnv: \"ONEDRIVE_CLIENT_SECRET\"\n  },\n  dropbox: {\n    name: \"dropbox\",\n    displayName: \"Dropbox\",\n    icon: \"dropbox\",\n    authUrl: \"https://www.dropbox.com/oauth2/authorize\",\n    tokenUrl: \"https://api.dropbox.com/oauth2/token\",\n    scopes: [],\n    clientIdEnv: \"DROPBOX_CLIENT_ID\",\n    clientSecretEnv: \"DROPBOX_CLIENT_SECRET\"\n  }\n};\n\n// Cloud file interface\ninterface CloudFile {\n  id: string;\n  name: string;\n  mimeType: string;\n  size: number;\n  path: string;\n  modifiedAt: Date;\n  isFolder: boolean;\n  downloadUrl?: string;\n}\n\n// Abstract cloud storage provider\nabstract class CloudStorageProvider {\n  protected connection: CloudStorageConnection;\n  protected config: ProviderConfig;\n\n  constructor(connection: CloudStorageConnection, config: ProviderConfig) {\n    this.connection = connection;\n    this.config = config;\n  }\n\n  abstract listFiles(folderId?: string): Promise<CloudFile[]>;\n  abstract downloadFile(fileId: string): Promise<Buffer>;\n  abstract getFileMetadata(fileId: string): Promise<CloudFile>;\n  abstract getUserInfo(): Promise<{ email: string; name: string }>;\n  abstract refreshAccessToken(): Promise<{ accessToken: string; expiresAt: Date }>;\n\n  protected async ensureValidToken(): Promise<string> {\n    if (!this.connection.accessToken) {\n      throw new Error(\"No access token available\");\n    }\n\n    // Check if token is expired (with 5 minute buffer)\n    if (this.connection.tokenExpiresAt) {\n      const expiresAt = new Date(this.connection.tokenExpiresAt);\n      const now = new Date();\n      const bufferMs = 5 * 60 * 1000; // 5 minutes\n\n      if (expiresAt.getTime() - now.getTime() < bufferMs) {\n        // Refresh the token\n        const { accessToken, expiresAt: newExpiresAt } = await this.refreshAccessToken();\n        await storage.updateCloudStorageConnectionTokens(this.connection.id, {\n          accessToken,\n          tokenExpiresAt: newExpiresAt\n        });\n        return accessToken;\n      }\n    }\n\n    return this.connection.accessToken;\n  }\n}\n\n// Google Drive Provider\nclass GoogleDriveProvider extends CloudStorageProvider {\n  async listFiles(folderId?: string): Promise<CloudFile[]> {\n    const accessToken = await this.ensureValidToken();\n    const targetFolder = folderId || this.connection.rootFolderId || \"root\";\n\n    const query = `'${targetFolder}' in parents and trashed = false`;\n    const fields = \"files(id,name,mimeType,size,modifiedTime,webContentLink)\";\n    const url = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=${encodeURIComponent(fields)}&pageSize=100`;\n\n    const response = await fetch(url, {\n      headers: { Authorization: `Bearer ${accessToken}` }\n    });\n\n    if (!response.ok) {\n      throw new Error(`Google Drive API error: ${response.status}`);\n    }\n\n    const data = await response.json();\n    return (data.files || []).map((file: any) => ({\n      id: file.id,\n      name: file.name,\n      mimeType: file.mimeType,\n      size: parseInt(file.size || \"0\"),\n      path: file.name,\n      modifiedAt: new Date(file.modifiedTime),\n      isFolder: file.mimeType === \"application/vnd.google-apps.folder\",\n      downloadUrl: file.webContentLink\n    }));\n  }\n\n  async downloadFile(fileId: string): Promise<Buffer> {\n    const accessToken = await this.ensureValidToken();\n    const url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;\n\n    const response = await fetch(url, {\n      headers: { Authorization: `Bearer ${accessToken}` }\n    });\n\n    if (!response.ok) {\n      throw new Error(`Google Drive download error: ${response.status}`);\n    }\n\n    const arrayBuffer = await response.arrayBuffer();\n    return Buffer.from(arrayBuffer);\n  }\n\n  async getFileMetadata(fileId: string): Promise<CloudFile> {\n    const accessToken = await this.ensureValidToken();\n    const fields = \"id,name,mimeType,size,modifiedTime,webContentLink\";\n    const url = `https://www.googleapis.com/drive/v3/files/${fileId}?fields=${encodeURIComponent(fields)}`;\n\n    const response = await fetch(url, {\n      headers: { Authorization: `Bearer ${accessToken}` }\n    });\n\n    if (!response.ok) {\n      throw new Error(`Google Drive API error: ${response.status}`);\n    }\n\n    const file = await response.json();\n    return {\n      id: file.id,\n      name: file.name,\n      mimeType: file.mimeType,\n      size: parseInt(file.size || \"0\"),\n      path: file.name,\n      modifiedAt: new Date(file.modifiedTime),\n      isFolder: file.mimeType === \"application/vnd.google-apps.folder\",\n      downloadUrl: file.webContentLink\n    };\n  }\n\n  async getUserInfo(): Promise<{ email: string; name: string }> {\n    const accessToken = await this.ensureValidToken();\n    const url = \"https://www.googleapis.com/oauth2/v2/userinfo\";\n\n    const response = await fetch(url, {\n      headers: { Authorization: `Bearer ${accessToken}` }\n    });\n\n    if (!response.ok) {\n      throw new Error(`Google userinfo error: ${response.status}`);\n    }\n\n    const data = await response.json();\n    return { email: data.email, name: data.name };\n  }\n\n  async refreshAccessToken(): Promise<{ accessToken: string; expiresAt: Date }> {\n    if (!this.connection.refreshToken) {\n      throw new Error(\"No refresh token available\");\n    }\n\n    const clientId = process.env[this.config.clientIdEnv];\n    const clientSecret = process.env[this.config.clientSecretEnv];\n\n    if (!clientId || !clientSecret) {\n      throw new Error(\"Google OAuth credentials not configured\");\n    }\n\n    const response = await fetch(this.config.tokenUrl, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n      body: new URLSearchParams({\n        client_id: clientId,\n        client_secret: clientSecret,\n        refresh_token: this.connection.refreshToken,\n        grant_type: \"refresh_token\"\n      })\n    });\n\n    if (!response.ok) {\n      throw new Error(`Token refresh error: ${response.status}`);\n    }\n\n    const data = await response.json();\n    const expiresAt = new Date(Date.now() + data.expires_in * 1000);\n    return { accessToken: data.access_token, expiresAt };\n  }\n}\n\n// OneDrive Provider\nclass OneDriveProvider extends CloudStorageProvider {\n  async listFiles(folderId?: string): Promise<CloudFile[]> {\n    const accessToken = await this.ensureValidToken();\n    const targetFolder = folderId || this.connection.rootFolderId || \"root\";\n    \n    const url = targetFolder === \"root\" \n      ? \"https://graph.microsoft.com/v1.0/me/drive/root/children\"\n      : `https://graph.microsoft.com/v1.0/me/drive/items/${targetFolder}/children`;\n\n    const response = await fetch(url, {\n      headers: { Authorization: `Bearer ${accessToken}` }\n    });\n\n    if (!response.ok) {\n      throw new Error(`OneDrive API error: ${response.status}`);\n    }\n\n    const data = await response.json();\n    return (data.value || []).map((item: any) => ({\n      id: item.id,\n      name: item.name,\n      mimeType: item.file?.mimeType || \"application/octet-stream\",\n      size: item.size || 0,\n      path: item.name,\n      modifiedAt: new Date(item.lastModifiedDateTime),\n      isFolder: !!item.folder,\n      downloadUrl: item[\"@microsoft.graph.downloadUrl\"]\n    }));\n  }\n\n  async downloadFile(fileId: string): Promise<Buffer> {\n    const accessToken = await this.ensureValidToken();\n    const url = `https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/content`;\n\n    const response = await fetch(url, {\n      headers: { Authorization: `Bearer ${accessToken}` }\n    });\n\n    if (!response.ok) {\n      throw new Error(`OneDrive download error: ${response.status}`);\n    }\n\n    const arrayBuffer = await response.arrayBuffer();\n    return Buffer.from(arrayBuffer);\n  }\n\n  async getFileMetadata(fileId: string): Promise<CloudFile> {\n    const accessToken = await this.ensureValidToken();\n    const url = `https://graph.microsoft.com/v1.0/me/drive/items/${fileId}`;\n\n    const response = await fetch(url, {\n      headers: { Authorization: `Bearer ${accessToken}` }\n    });\n\n    if (!response.ok) {\n      throw new Error(`OneDrive API error: ${response.status}`);\n    }\n\n    const item = await response.json();\n    return {\n      id: item.id,\n      name: item.name,\n      mimeType: item.file?.mimeType || \"application/octet-stream\",\n      size: item.size || 0,\n      path: item.name,\n      modifiedAt: new Date(item.lastModifiedDateTime),\n      isFolder: !!item.folder,\n      downloadUrl: item[\"@microsoft.graph.downloadUrl\"]\n    };\n  }\n\n  async getUserInfo(): Promise<{ email: string; name: string }> {\n    const accessToken = await this.ensureValidToken();\n    const url = \"https://graph.microsoft.com/v1.0/me\";\n\n    const response = await fetch(url, {\n      headers: { Authorization: `Bearer ${accessToken}` }\n    });\n\n    if (!response.ok) {\n      throw new Error(`OneDrive userinfo error: ${response.status}`);\n    }\n\n    const data = await response.json();\n    return { email: data.userPrincipalName || data.mail, name: data.displayName };\n  }\n\n  async refreshAccessToken(): Promise<{ accessToken: string; expiresAt: Date }> {\n    if (!this.connection.refreshToken) {\n      throw new Error(\"No refresh token available\");\n    }\n\n    const clientId = process.env[this.config.clientIdEnv];\n    const clientSecret = process.env[this.config.clientSecretEnv];\n\n    if (!clientId || !clientSecret) {\n      throw new Error(\"OneDrive OAuth credentials not configured\");\n    }\n\n    const response = await fetch(this.config.tokenUrl, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n      body: new URLSearchParams({\n        client_id: clientId,\n        client_secret: clientSecret,\n        refresh_token: this.connection.refreshToken,\n        grant_type: \"refresh_token\"\n      })\n    });\n\n    if (!response.ok) {\n      throw new Error(`Token refresh error: ${response.status}`);\n    }\n\n    const data = await response.json();\n    const expiresAt = new Date(Date.now() + data.expires_in * 1000);\n    return { accessToken: data.access_token, expiresAt };\n  }\n}\n\n// Dropbox Provider\nclass DropboxProvider extends CloudStorageProvider {\n  async listFiles(folderId?: string): Promise<CloudFile[]> {\n    const accessToken = await this.ensureValidToken();\n    const path = folderId || this.connection.rootFolderId || \"\";\n\n    const response = await fetch(\"https://api.dropboxapi.com/2/files/list_folder\", {\n      method: \"POST\",\n      headers: {\n        Authorization: `Bearer ${accessToken}`,\n        \"Content-Type\": \"application/json\"\n      },\n      body: JSON.stringify({\n        path: path === \"root\" || path === \"\" ? \"\" : path,\n        recursive: false,\n        include_media_info: false\n      })\n    });\n\n    if (!response.ok) {\n      throw new Error(`Dropbox API error: ${response.status}`);\n    }\n\n    const data = await response.json();\n    return (data.entries || []).map((item: any) => ({\n      id: item.id,\n      name: item.name,\n      mimeType: item[\".tag\"] === \"folder\" ? \"application/vnd.dropbox.folder\" : \"application/octet-stream\",\n      size: item.size || 0,\n      path: item.path_display,\n      modifiedAt: item.client_modified ? new Date(item.client_modified) : new Date(),\n      isFolder: item[\".tag\"] === \"folder\"\n    }));\n  }\n\n  async downloadFile(fileId: string): Promise<Buffer> {\n    const accessToken = await this.ensureValidToken();\n\n    const response = await fetch(\"https://content.dropboxapi.com/2/files/download\", {\n      method: \"POST\",\n      headers: {\n        Authorization: `Bearer ${accessToken}`,\n        \"Dropbox-API-Arg\": JSON.stringify({ path: fileId })\n      }\n    });\n\n    if (!response.ok) {\n      throw new Error(`Dropbox download error: ${response.status}`);\n    }\n\n    const arrayBuffer = await response.arrayBuffer();\n    return Buffer.from(arrayBuffer);\n  }\n\n  async getFileMetadata(fileId: string): Promise<CloudFile> {\n    const accessToken = await this.ensureValidToken();\n\n    const response = await fetch(\"https://api.dropboxapi.com/2/files/get_metadata\", {\n      method: \"POST\",\n      headers: {\n        Authorization: `Bearer ${accessToken}`,\n        \"Content-Type\": \"application/json\"\n      },\n      body: JSON.stringify({ path: fileId })\n    });\n\n    if (!response.ok) {\n      throw new Error(`Dropbox API error: ${response.status}`);\n    }\n\n    const item = await response.json();\n    return {\n      id: item.id,\n      name: item.name,\n      mimeType: item[\".tag\"] === \"folder\" ? \"application/vnd.dropbox.folder\" : \"application/octet-stream\",\n      size: item.size || 0,\n      path: item.path_display,\n      modifiedAt: item.client_modified ? new Date(item.client_modified) : new Date(),\n      isFolder: item[\".tag\"] === \"folder\"\n    };\n  }\n\n  async getUserInfo(): Promise<{ email: string; name: string }> {\n    const accessToken = await this.ensureValidToken();\n\n    const response = await fetch(\"https://api.dropboxapi.com/2/users/get_current_account\", {\n      method: \"POST\",\n      headers: { Authorization: `Bearer ${accessToken}` }\n    });\n\n    if (!response.ok) {\n      throw new Error(`Dropbox userinfo error: ${response.status}`);\n    }\n\n    const data = await response.json();\n    return { \n      email: data.email, \n      name: data.name?.display_name || data.email \n    };\n  }\n\n  async refreshAccessToken(): Promise<{ accessToken: string; expiresAt: Date }> {\n    if (!this.connection.refreshToken) {\n      throw new Error(\"No refresh token available\");\n    }\n\n    const clientId = process.env[this.config.clientIdEnv];\n    const clientSecret = process.env[this.config.clientSecretEnv];\n\n    if (!clientId || !clientSecret) {\n      throw new Error(\"Dropbox OAuth credentials not configured\");\n    }\n\n    const response = await fetch(this.config.tokenUrl, {\n      method: \"POST\",\n      headers: { \n        \"Content-Type\": \"application/x-www-form-urlencoded\",\n        Authorization: `Basic ${Buffer.from(`${clientId}:${clientSecret}`).toString(\"base64\")}`\n      },\n      body: new URLSearchParams({\n        refresh_token: this.connection.refreshToken,\n        grant_type: \"refresh_token\"\n      })\n    });\n\n    if (!response.ok) {\n      throw new Error(`Token refresh error: ${response.status}`);\n    }\n\n    const data = await response.json();\n    const expiresAt = new Date(Date.now() + data.expires_in * 1000);\n    return { accessToken: data.access_token, expiresAt };\n  }\n}\n\n// Factory function to get provider\nexport function getCloudStorageProvider(connection: CloudStorageConnection): CloudStorageProvider {\n  const config = CLOUD_PROVIDERS[connection.provider];\n  if (!config) {\n    throw new Error(`Unknown cloud storage provider: ${connection.provider}`);\n  }\n\n  switch (connection.provider) {\n    case \"google_drive\":\n      return new GoogleDriveProvider(connection, config);\n    case \"onedrive\":\n      return new OneDriveProvider(connection, config);\n    case \"dropbox\":\n      return new DropboxProvider(connection, config);\n    default:\n      throw new Error(`Unsupported provider: ${connection.provider}`);\n  }\n}\n\n// Generate OAuth authorization URL\nexport function getAuthorizationUrl(provider: string, state: string, redirectUri: string): string {\n  const config = CLOUD_PROVIDERS[provider];\n  if (!config) {\n    throw new Error(`Unknown provider: ${provider}`);\n  }\n\n  const clientId = process.env[config.clientIdEnv];\n  if (!clientId) {\n    throw new Error(`${config.displayName} OAuth client ID not configured`);\n  }\n\n  const params = new URLSearchParams({\n    client_id: clientId,\n    redirect_uri: redirectUri,\n    response_type: \"code\",\n    state: state,\n    access_type: \"offline\", // For Google\n    prompt: \"consent\" // Force consent to get refresh token\n  });\n\n  if (config.scopes.length > 0) {\n    params.set(\"scope\", config.scopes.join(\" \"));\n  }\n\n  return `${config.authUrl}?${params.toString()}`;\n}\n\n// Exchange authorization code for tokens\nexport async function exchangeCodeForTokens(\n  provider: string,\n  code: string,\n  redirectUri: string\n): Promise<{\n  accessToken: string;\n  refreshToken?: string;\n  expiresAt: Date;\n}> {\n  const config = CLOUD_PROVIDERS[provider];\n  if (!config) {\n    throw new Error(`Unknown provider: ${provider}`);\n  }\n\n  const clientId = process.env[config.clientIdEnv];\n  const clientSecret = process.env[config.clientSecretEnv];\n\n  if (!clientId || !clientSecret) {\n    throw new Error(`${config.displayName} OAuth credentials not configured`);\n  }\n\n  const params = new URLSearchParams({\n    client_id: clientId,\n    client_secret: clientSecret,\n    code: code,\n    redirect_uri: redirectUri,\n    grant_type: \"authorization_code\"\n  });\n\n  const response = await fetch(config.tokenUrl, {\n    method: \"POST\",\n    headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n    body: params\n  });\n\n  if (!response.ok) {\n    const errorData = await response.text();\n    throw new Error(`Token exchange error: ${response.status} - ${errorData}`);\n  }\n\n  const data = await response.json();\n  const expiresAt = new Date(Date.now() + (data.expires_in || 3600) * 1000);\n\n  return {\n    accessToken: data.access_token,\n    refreshToken: data.refresh_token,\n    expiresAt\n  };\n}\n\n// Sync files from cloud storage to local storage\nexport async function syncCloudFiles(\n  connection: CloudStorageConnection,\n  projectId: number\n): Promise<{ added: number; updated: number; errors: number }> {\n  const provider = getCloudStorageProvider(connection);\n  const stats = { added: 0, updated: 0, errors: 0 };\n\n  try {\n    await storage.updateCloudStorageConnectionSyncStatus(connection.id, {\n      syncStatus: \"syncing\"\n    });\n\n    const cloudFiles = await provider.listFiles();\n\n    for (const cloudFile of cloudFiles) {\n      if (cloudFile.isFolder) continue; // Skip folders for now\n\n      try {\n        const existingSync = await storage.getCloudSyncedFileByCloudId(\n          connection.id, \n          cloudFile.id\n        );\n\n        if (existingSync) {\n          // Check if file was modified\n          if (cloudFile.modifiedAt > (existingSync.cloudModifiedAt || new Date(0))) {\n            await storage.updateCloudSyncedFile(existingSync.id, {\n              name: cloudFile.name,\n              mimeType: cloudFile.mimeType,\n              size: cloudFile.size,\n              cloudModifiedAt: cloudFile.modifiedAt,\n              syncStatus: \"pending\"\n            });\n            stats.updated++;\n          }\n        } else {\n          // Add new file\n          await storage.createCloudSyncedFile({\n            connectionId: connection.id,\n            projectId,\n            cloudFileId: cloudFile.id,\n            cloudFilePath: cloudFile.path,\n            name: cloudFile.name,\n            mimeType: cloudFile.mimeType,\n            size: cloudFile.size,\n            cloudModifiedAt: cloudFile.modifiedAt,\n            syncStatus: \"pending\"\n          });\n          stats.added++;\n        }\n      } catch (error) {\n        console.error(`Error syncing file ${cloudFile.name}:`, error);\n        stats.errors++;\n      }\n    }\n\n    await storage.updateCloudStorageConnectionSyncStatus(connection.id, {\n      syncStatus: \"idle\",\n      lastSyncAt: new Date(),\n      syncError: null\n    });\n  } catch (error) {\n    const errorMessage = error instanceof Error ? error.message : \"Unknown error\";\n    await storage.updateCloudStorageConnectionSyncStatus(connection.id, {\n      syncStatus: \"error\",\n      syncError: errorMessage\n    });\n    throw error;\n  }\n\n  return stats;\n}\n","size_bytes":20622},"client/src/components/ObjectUploader.tsx":{"content":"import { useState, useRef, useCallback } from \"react\";\nimport type { ReactNode } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Upload, X, File as FileIcon, Loader2 } from \"lucide-react\";\n\ninterface FileUploadInfo {\n  file: File;\n  progress: number;\n  status: 'pending' | 'uploading' | 'complete' | 'error';\n  error?: string;\n}\n\ninterface ObjectUploaderProps {\n  maxNumberOfFiles?: number;\n  maxFileSize?: number;\n  allowedFileTypes?: string[];\n  onGetUploadParameters: (file: { name: string; type: string; size: number }) => Promise<{\n    method: \"PUT\";\n    url: string;\n  }>;\n  onComplete?: (files: Array<{ name: string; type: string; size: number; uploadURL: string }>) => void;\n  buttonClassName?: string;\n  buttonVariant?: \"default\" | \"outline\" | \"secondary\" | \"ghost\" | \"destructive\";\n  buttonSize?: \"default\" | \"sm\" | \"lg\" | \"icon\";\n  children: ReactNode;\n  disabled?: boolean;\n  title?: string;\n}\n\nfunction formatFileSize(bytes: number): string {\n  if (bytes === 0) return '0 Bytes';\n  const k = 1024;\n  const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\n  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n}\n\nexport function ObjectUploader({\n  maxNumberOfFiles = 5,\n  maxFileSize = 52428800, // 50MB default\n  allowedFileTypes,\n  onGetUploadParameters,\n  onComplete,\n  buttonClassName,\n  buttonVariant = \"default\",\n  buttonSize = \"default\",\n  children,\n  disabled = false,\n  title = \"Upload Files\",\n}: ObjectUploaderProps) {\n  const [showModal, setShowModal] = useState(false);\n  const [files, setFiles] = useState<FileUploadInfo[]>([]);\n  const [isUploading, setIsUploading] = useState(false);\n  const [dragOver, setDragOver] = useState(false);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  const handleFileSelect = useCallback((selectedFiles: FileList | null) => {\n    if (!selectedFiles) return;\n    \n    const newFiles: FileUploadInfo[] = [];\n    for (let i = 0; i < selectedFiles.length; i++) {\n      const file = selectedFiles[i];\n      \n      if (files.length + newFiles.length >= maxNumberOfFiles) {\n        break;\n      }\n      \n      if (file.size > maxFileSize) {\n        continue;\n      }\n      \n      if (allowedFileTypes && !allowedFileTypes.some(type => \n        file.type.startsWith(type.replace('/*', '')) || file.type === type\n      )) {\n        continue;\n      }\n      \n      newFiles.push({\n        file,\n        progress: 0,\n        status: 'pending'\n      });\n    }\n    \n    setFiles(prev => [...prev, ...newFiles]);\n  }, [files.length, maxNumberOfFiles, maxFileSize, allowedFileTypes]);\n\n  const removeFile = (index: number) => {\n    setFiles(prev => prev.filter((_, i) => i !== index));\n  };\n\n  const handleDrop = useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    setDragOver(false);\n    handleFileSelect(e.dataTransfer.files);\n  }, [handleFileSelect]);\n\n  const handleDragOver = useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    setDragOver(true);\n  }, []);\n\n  const handleDragLeave = useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    setDragOver(false);\n  }, []);\n\n  const uploadFiles = async () => {\n    if (files.length === 0 || isUploading) return;\n    \n    setIsUploading(true);\n    const completedFiles: Array<{ name: string; type: string; size: number; uploadURL: string }> = [];\n    \n    for (let i = 0; i < files.length; i++) {\n      const fileInfo = files[i];\n      if (fileInfo.status !== 'pending') continue;\n      \n      try {\n        setFiles(prev => prev.map((f, idx) => \n          idx === i ? { ...f, status: 'uploading' as const, progress: 0 } : f\n        ));\n        \n        const { url } = await onGetUploadParameters({\n          name: fileInfo.file.name,\n          type: fileInfo.file.type,\n          size: fileInfo.file.size\n        });\n        \n        await new Promise<void>((resolve, reject) => {\n          const xhr = new XMLHttpRequest();\n          \n          xhr.upload.addEventListener('progress', (event) => {\n            if (event.lengthComputable) {\n              const progress = Math.round((event.loaded / event.total) * 100);\n              setFiles(prev => prev.map((f, idx) => \n                idx === i ? { ...f, progress } : f\n              ));\n            }\n          });\n          \n          xhr.addEventListener('load', () => {\n            if (xhr.status >= 200 && xhr.status < 300) {\n              resolve();\n            } else {\n              reject(new Error(`Upload failed: ${xhr.status}`));\n            }\n          });\n          \n          xhr.addEventListener('error', () => reject(new Error('Upload failed')));\n          xhr.open('PUT', url);\n          xhr.setRequestHeader('Content-Type', fileInfo.file.type);\n          xhr.send(fileInfo.file);\n        });\n        \n        setFiles(prev => prev.map((f, idx) => \n          idx === i ? { ...f, status: 'complete' as const, progress: 100 } : f\n        ));\n        \n        completedFiles.push({\n          name: fileInfo.file.name,\n          type: fileInfo.file.type,\n          size: fileInfo.file.size,\n          uploadURL: url\n        });\n      } catch (error) {\n        setFiles(prev => prev.map((f, idx) => \n          idx === i ? { ...f, status: 'error' as const, error: (error as Error).message } : f\n        ));\n      }\n    }\n    \n    setIsUploading(false);\n    \n    if (completedFiles.length > 0) {\n      onComplete?.(completedFiles);\n    }\n  };\n\n  const handleClose = () => {\n    if (!isUploading) {\n      setShowModal(false);\n      setFiles([]);\n    }\n  };\n\n  const pendingCount = files.filter(f => f.status === 'pending').length;\n  const completedCount = files.filter(f => f.status === 'complete').length;\n\n  return (\n    <>\n      <Button \n        onClick={() => setShowModal(true)} \n        className={buttonClassName}\n        variant={buttonVariant}\n        size={buttonSize}\n        disabled={disabled}\n        data-testid=\"button-upload-file\"\n      >\n        {children}\n      </Button>\n\n      <Dialog open={showModal} onOpenChange={handleClose}>\n        <DialogContent className=\"max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>{title}</DialogTitle>\n          </DialogHeader>\n          \n          <div\n            className={`border-2 border-dashed rounded-lg p-6 text-center transition-colors ${\n              dragOver ? 'border-primary bg-primary/5' : 'border-muted-foreground/25'\n            }`}\n            onDrop={handleDrop}\n            onDragOver={handleDragOver}\n            onDragLeave={handleDragLeave}\n            data-testid=\"dropzone\"\n          >\n            <input\n              ref={fileInputRef}\n              type=\"file\"\n              multiple={maxNumberOfFiles > 1}\n              accept={allowedFileTypes?.join(',')}\n              className=\"hidden\"\n              onChange={(e) => handleFileSelect(e.target.files)}\n              data-testid=\"input-file\"\n            />\n            <Upload className=\"mx-auto h-10 w-10 text-muted-foreground mb-3\" />\n            <p className=\"text-sm text-muted-foreground mb-2\">\n              Drag and drop files here, or{' '}\n              <button\n                type=\"button\"\n                className=\"text-primary underline hover:no-underline\"\n                onClick={() => fileInputRef.current?.click()}\n              >\n                browse\n              </button>\n            </p>\n            <p className=\"text-xs text-muted-foreground\">\n              Max {maxNumberOfFiles} files, up to {formatFileSize(maxFileSize)} each\n            </p>\n          </div>\n          \n          {files.length > 0 && (\n            <div className=\"space-y-2 max-h-48 overflow-y-auto\">\n              {files.map((fileInfo, index) => (\n                <div \n                  key={index}\n                  className=\"flex items-center gap-3 p-2 rounded-md bg-muted/50\"\n                  data-testid={`file-item-${index}`}\n                >\n                  <FileIcon className=\"h-5 w-5 text-muted-foreground flex-shrink-0\" />\n                  <div className=\"flex-1 min-w-0\">\n                    <p className=\"text-sm truncate\">{fileInfo.file.name}</p>\n                    <div className=\"flex items-center gap-2\">\n                      <p className=\"text-xs text-muted-foreground\">\n                        {formatFileSize(fileInfo.file.size)}\n                      </p>\n                      {fileInfo.status === 'uploading' && (\n                        <Progress value={fileInfo.progress} className=\"h-1 w-20\" />\n                      )}\n                      {fileInfo.status === 'complete' && (\n                        <span className=\"text-xs text-green-600\">Complete</span>\n                      )}\n                      {fileInfo.status === 'error' && (\n                        <span className=\"text-xs text-red-600\">Failed</span>\n                      )}\n                    </div>\n                  </div>\n                  {fileInfo.status === 'pending' && (\n                    <Button\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      className=\"h-6 w-6\"\n                      onClick={() => removeFile(index)}\n                      data-testid={`button-remove-file-${index}`}\n                    >\n                      <X className=\"h-4 w-4\" />\n                    </Button>\n                  )}\n                  {fileInfo.status === 'uploading' && (\n                    <Loader2 className=\"h-4 w-4 animate-spin\" />\n                  )}\n                </div>\n              ))}\n            </div>\n          )}\n\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={handleClose} disabled={isUploading}>\n              Cancel\n            </Button>\n            <Button \n              onClick={uploadFiles} \n              disabled={pendingCount === 0 || isUploading}\n              data-testid=\"button-start-upload\"\n            >\n              {isUploading ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Uploading...\n                </>\n              ) : (\n                `Upload ${pendingCount} file${pendingCount !== 1 ? 's' : ''}`\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n}\n","size_bytes":10413},"server/objectStorage.ts":{"content":"import { Storage, File } from \"@google-cloud/storage\";\nimport { Response } from \"express\";\nimport { randomUUID } from \"crypto\";\nimport {\n  ObjectAclPolicy,\n  ObjectPermission,\n  canAccessObject,\n  getObjectAclPolicy,\n  setObjectAclPolicy,\n} from \"./objectAcl\";\n\nconst REPLIT_SIDECAR_ENDPOINT = \"http://127.0.0.1:1106\";\n\nexport const objectStorageClient = new Storage({\n  credentials: {\n    audience: \"replit\",\n    subject_token_type: \"access_token\",\n    token_url: `${REPLIT_SIDECAR_ENDPOINT}/token`,\n    type: \"external_account\",\n    credential_source: {\n      url: `${REPLIT_SIDECAR_ENDPOINT}/credential`,\n      format: {\n        type: \"json\",\n        subject_token_field_name: \"access_token\",\n      },\n    },\n    universe_domain: \"googleapis.com\",\n  },\n  projectId: \"\",\n});\n\nexport class ObjectNotFoundError extends Error {\n  constructor() {\n    super(\"Object not found\");\n    this.name = \"ObjectNotFoundError\";\n    Object.setPrototypeOf(this, ObjectNotFoundError.prototype);\n  }\n}\n\nexport class QuotaExceededError extends Error {\n  constructor(message: string = \"Storage quota exceeded\") {\n    super(message);\n    this.name = \"QuotaExceededError\";\n    Object.setPrototypeOf(this, QuotaExceededError.prototype);\n  }\n}\n\nexport class ObjectStorageService {\n  constructor() {}\n\n  getPublicObjectSearchPaths(): Array<string> {\n    const pathsStr = process.env.PUBLIC_OBJECT_SEARCH_PATHS || \"\";\n    const paths = Array.from(\n      new Set(\n        pathsStr\n          .split(\",\")\n          .map((path) => path.trim())\n          .filter((path) => path.length > 0)\n      )\n    );\n    if (paths.length === 0) {\n      throw new Error(\n        \"PUBLIC_OBJECT_SEARCH_PATHS not set. Create a bucket in 'Object Storage' \" +\n          \"tool and set PUBLIC_OBJECT_SEARCH_PATHS env var (comma-separated paths).\"\n      );\n    }\n    return paths;\n  }\n\n  getPrivateObjectDir(): string {\n    const dir = process.env.PRIVATE_OBJECT_DIR || \"\";\n    if (!dir) {\n      throw new Error(\n        \"PRIVATE_OBJECT_DIR not set. Create a bucket in 'Object Storage' \" +\n          \"tool and set PRIVATE_OBJECT_DIR env var.\"\n      );\n    }\n    return dir;\n  }\n\n  async searchPublicObject(filePath: string): Promise<File | null> {\n    for (const searchPath of this.getPublicObjectSearchPaths()) {\n      const fullPath = `${searchPath}/${filePath}`;\n      const { bucketName, objectName } = parseObjectPath(fullPath);\n      const bucket = objectStorageClient.bucket(bucketName);\n      const file = bucket.file(objectName);\n      const [exists] = await file.exists();\n      if (exists) {\n        return file;\n      }\n    }\n    return null;\n  }\n\n  async downloadObject(file: File, res: Response, cacheTtlSec: number = 3600) {\n    try {\n      const [metadata] = await file.getMetadata();\n      const aclPolicy = await getObjectAclPolicy(file);\n      const isPublic = aclPolicy?.visibility === \"public\";\n      \n      res.set({\n        \"Content-Type\": metadata.contentType || \"application/octet-stream\",\n        \"Content-Length\": metadata.size,\n        \"Cache-Control\": `${isPublic ? \"public\" : \"private\"}, max-age=${cacheTtlSec}`,\n      });\n\n      const stream = file.createReadStream();\n\n      stream.on(\"error\", (err) => {\n        console.error(\"Stream error:\", err);\n        if (!res.headersSent) {\n          res.status(500).json({ error: \"Error streaming file\" });\n        }\n      });\n\n      stream.pipe(res);\n    } catch (error) {\n      console.error(\"Error downloading file:\", error);\n      if (!res.headersSent) {\n        res.status(500).json({ error: \"Error downloading file\" });\n      }\n    }\n  }\n\n  async getObjectEntityUploadURL(organizationId: number, projectId: number): Promise<{ uploadURL: string; objectId: string }> {\n    const privateObjectDir = this.getPrivateObjectDir();\n    if (!privateObjectDir) {\n      throw new Error(\n        \"PRIVATE_OBJECT_DIR not set. Create a bucket in 'Object Storage' \" +\n          \"tool and set PRIVATE_OBJECT_DIR env var.\"\n      );\n    }\n\n    const objectId = randomUUID();\n    const fullPath = `${privateObjectDir}/org-${organizationId}/project-${projectId}/${objectId}`;\n    const { bucketName, objectName } = parseObjectPath(fullPath);\n\n    const uploadURL = await signObjectURL({\n      bucketName,\n      objectName,\n      method: \"PUT\",\n      ttlSec: 900, // 15 minutes\n    });\n\n    return { uploadURL, objectId };\n  }\n\n  async getObjectEntityFile(objectPath: string): Promise<File> {\n    if (!objectPath.startsWith(\"/objects/\")) {\n      throw new ObjectNotFoundError();\n    }\n\n    const parts = objectPath.slice(1).split(\"/\");\n    if (parts.length < 2) {\n      throw new ObjectNotFoundError();\n    }\n\n    const entityId = parts.slice(1).join(\"/\");\n    let entityDir = this.getPrivateObjectDir();\n    if (!entityDir.endsWith(\"/\")) {\n      entityDir = `${entityDir}/`;\n    }\n    const objectEntityPath = `${entityDir}${entityId}`;\n    const { bucketName, objectName } = parseObjectPath(objectEntityPath);\n    const bucket = objectStorageClient.bucket(bucketName);\n    const objectFile = bucket.file(objectName);\n    const [exists] = await objectFile.exists();\n    if (!exists) {\n      throw new ObjectNotFoundError();\n    }\n    return objectFile;\n  }\n\n  normalizeObjectEntityPath(rawPath: string): string {\n    if (!rawPath.startsWith(\"https://storage.googleapis.com/\")) {\n      return rawPath;\n    }\n\n    const url = new URL(rawPath);\n    const rawObjectPath = url.pathname;\n\n    let objectEntityDir = this.getPrivateObjectDir();\n    if (!objectEntityDir.endsWith(\"/\")) {\n      objectEntityDir = `${objectEntityDir}/`;\n    }\n\n    if (!rawObjectPath.startsWith(objectEntityDir)) {\n      return rawObjectPath;\n    }\n\n    const entityId = rawObjectPath.slice(objectEntityDir.length);\n    return `/objects/${entityId}`;\n  }\n\n  async trySetObjectEntityAclPolicy(\n    rawPath: string,\n    aclPolicy: ObjectAclPolicy\n  ): Promise<string> {\n    const normalizedPath = this.normalizeObjectEntityPath(rawPath);\n    if (!normalizedPath.startsWith(\"/\")) {\n      return normalizedPath;\n    }\n\n    const objectFile = await this.getObjectEntityFile(normalizedPath);\n    await setObjectAclPolicy(objectFile, aclPolicy);\n    return normalizedPath;\n  }\n\n  async canAccessObjectEntity({\n    userId,\n    objectFile,\n    requestedPermission,\n    userOrganizationIds = [],\n  }: {\n    userId?: string;\n    objectFile: File;\n    requestedPermission?: ObjectPermission;\n    userOrganizationIds?: number[];\n  }): Promise<boolean> {\n    return canAccessObject({\n      userId,\n      objectFile,\n      requestedPermission: requestedPermission ?? ObjectPermission.READ,\n      userOrganizationIds,\n    });\n  }\n\n  async deleteObject(objectPath: string): Promise<void> {\n    try {\n      const objectFile = await this.getObjectEntityFile(objectPath);\n      await objectFile.delete();\n    } catch (error) {\n      if (error instanceof ObjectNotFoundError) {\n        return;\n      }\n      throw error;\n    }\n  }\n}\n\nfunction parseObjectPath(path: string): {\n  bucketName: string;\n  objectName: string;\n} {\n  if (!path.startsWith(\"/\")) {\n    path = `/${path}`;\n  }\n  const pathParts = path.split(\"/\");\n  if (pathParts.length < 3) {\n    throw new Error(\"Invalid path: must contain at least a bucket name\");\n  }\n\n  const bucketName = pathParts[1];\n  const objectName = pathParts.slice(2).join(\"/\");\n\n  return {\n    bucketName,\n    objectName,\n  };\n}\n\nasync function signObjectURL({\n  bucketName,\n  objectName,\n  method,\n  ttlSec,\n}: {\n  bucketName: string;\n  objectName: string;\n  method: \"GET\" | \"PUT\" | \"DELETE\" | \"HEAD\";\n  ttlSec: number;\n}): Promise<string> {\n  const request = {\n    bucket_name: bucketName,\n    object_name: objectName,\n    method,\n    expires_at: new Date(Date.now() + ttlSec * 1000).toISOString(),\n  };\n  const response = await fetch(\n    `${REPLIT_SIDECAR_ENDPOINT}/object-storage/signed-object-url`,\n    {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify(request),\n    }\n  );\n  if (!response.ok) {\n    throw new Error(\n      `Failed to sign object URL, errorcode: ${response.status}, ` +\n        `make sure you're running on Replit`\n    );\n  }\n\n  const { signed_url: signedURL } = await response.json();\n  return signedURL;\n}\n","size_bytes":8198},"server/websocket.ts":{"content":"import { WebSocketServer, WebSocket } from \"ws\";\nimport type { Server, IncomingMessage } from \"http\";\nimport { parse as parseCookie } from \"cookie\";\nimport { createHmac, timingSafeEqual } from \"crypto\";\nimport { sessionStore } from \"./replitAuth\";\nimport { storage } from \"./storage\";\nimport { log } from \"./app\";\n\ninterface AuthenticatedSocket extends WebSocket {\n  userId: string;\n  projectId?: number;\n  organizationId?: number;\n  isAlive: boolean;\n  isAuthenticated: boolean;\n}\n\ninterface BroadcastMessage {\n  type: string;\n  payload: any;\n  timestamp: number;\n  userId: string;\n}\n\ntype EventType =\n  | \"task-created\"\n  | \"task-updated\"\n  | \"task-deleted\"\n  | \"risk-created\"\n  | \"risk-updated\"\n  | \"risk-deleted\"\n  | \"issue-created\"\n  | \"issue-updated\"\n  | \"issue-deleted\"\n  | \"stakeholder-created\"\n  | \"stakeholder-updated\"\n  | \"stakeholder-deleted\"\n  | \"cost-item-created\"\n  | \"cost-item-updated\"\n  | \"cost-item-deleted\"\n  | \"dependency-created\"\n  | \"dependency-updated\"\n  | \"dependency-deleted\"\n  | \"file-created\"\n  | \"file-updated\"\n  | \"file-deleted\"\n  | \"project-updated\"\n  | \"user-joined\"\n  | \"user-left\"\n  | \"cursor-move\"\n  | \"comment-added\";\n\nfunction sign(val: string, secret: string): string {\n  return createHmac(\"sha256\", secret).update(val).digest(\"base64\").replace(/=+$/, \"\");\n}\n\nfunction unsign(signedVal: string, secret: string): string | false {\n  const tentativeValue = signedVal.slice(0, signedVal.lastIndexOf(\".\"));\n  const expectedInput = tentativeValue + \".\" + sign(tentativeValue, secret);\n  const expectedBuffer = Buffer.from(expectedInput);\n  const inputBuffer = Buffer.from(signedVal);\n  \n  if (expectedBuffer.length !== inputBuffer.length) {\n    return false;\n  }\n  \n  return timingSafeEqual(expectedBuffer, inputBuffer) ? tentativeValue : false;\n}\n\nfunction parseSessionId(cookieHeader: string | undefined): string | null {\n  if (!cookieHeader) return null;\n  \n  const secret = process.env.SESSION_SECRET;\n  if (!secret) return null;\n  \n  const cookies = parseCookie(cookieHeader);\n  const sessionCookie = cookies[\"connect.sid\"];\n  \n  if (!sessionCookie) return null;\n  \n  const decoded = decodeURIComponent(sessionCookie);\n  \n  if (decoded.startsWith(\"s:\")) {\n    const unsigned = unsign(decoded.slice(2), secret);\n    return unsigned || null;\n  }\n  \n  return sessionCookie;\n}\n\nasync function getSessionUser(sessionId: string): Promise<{ id: string; claims: any } | null> {\n  return new Promise((resolve) => {\n    sessionStore.get(sessionId, (err, session) => {\n      if (err || !session) {\n        resolve(null);\n        return;\n      }\n      \n      const passport = (session as any).passport;\n      if (passport?.user?.claims?.sub) {\n        resolve({\n          id: passport.user.claims.sub,\n          claims: passport.user.claims,\n        });\n      } else {\n        resolve(null);\n      }\n    });\n  });\n}\n\nclass WebSocketManager {\n  private wss: WebSocketServer | null = null;\n  private projectRooms: Map<number, Set<AuthenticatedSocket>> = new Map();\n  private organizationRooms: Map<number, Set<AuthenticatedSocket>> = new Map();\n  private heartbeatInterval: NodeJS.Timeout | null = null;\n  private failedAttempts: Map<string, { count: number; lastAttempt: number }> = new Map();\n  private readonly MAX_FAILED_ATTEMPTS = 5;\n  private readonly RATE_LIMIT_WINDOW = 60000; // 1 minute\n\n  initialize(server: Server) {\n    this.wss = new WebSocketServer({\n      server,\n      path: \"/ws\",\n    });\n\n    this.wss.on(\"connection\", async (ws: WebSocket, req: IncomingMessage) => {\n      const socket = ws as AuthenticatedSocket;\n      socket.isAlive = true;\n      socket.isAuthenticated = false;\n\n      const clientIp = (req.headers[\"x-forwarded-for\"] as string)?.split(\",\")[0] || \n                       req.socket.remoteAddress || \n                       \"unknown\";\n\n      const attempts = this.failedAttempts.get(clientIp);\n      if (attempts) {\n        const now = Date.now();\n        if (now - attempts.lastAttempt < this.RATE_LIMIT_WINDOW && \n            attempts.count >= this.MAX_FAILED_ATTEMPTS) {\n          log(`WebSocket rate limited: ${clientIp}`, \"ws\");\n          socket.close(4029, \"Too many requests\");\n          return;\n        }\n        if (now - attempts.lastAttempt >= this.RATE_LIMIT_WINDOW) {\n          this.failedAttempts.delete(clientIp);\n        }\n      }\n\n      const sessionId = parseSessionId(req.headers.cookie);\n      \n      if (!sessionId) {\n        this.recordFailedAttempt(clientIp);\n        log(\"WebSocket connection rejected: no session cookie\", \"ws\");\n        socket.close(4001, \"Unauthorized: No session\");\n        return;\n      }\n\n      const user = await getSessionUser(sessionId);\n      \n      if (!user) {\n        this.recordFailedAttempt(clientIp);\n        log(\"WebSocket connection rejected: invalid session\", \"ws\");\n        socket.close(4001, \"Unauthorized: Invalid session\");\n        return;\n      }\n\n      socket.userId = user.id;\n      socket.isAuthenticated = true;\n      \n      log(`WebSocket client connected: ${user.id}`, \"ws\");\n\n      socket.send(\n        JSON.stringify({\n          type: \"authenticated\",\n          payload: { userId: user.id, timestamp: Date.now() },\n        })\n      );\n\n      socket.on(\"pong\", () => {\n        socket.isAlive = true;\n      });\n\n      socket.on(\"message\", (data: Buffer) => {\n        try {\n          const message = JSON.parse(data.toString());\n          this.handleMessage(socket, message);\n        } catch (error) {\n          log(`Invalid WebSocket message: ${error}`, \"ws\");\n          socket.send(\n            JSON.stringify({\n              type: \"error\",\n              payload: { message: \"Invalid message format\" },\n            })\n          );\n        }\n      });\n\n      socket.on(\"close\", () => {\n        this.handleDisconnect(socket);\n        log(`WebSocket client disconnected: ${socket.userId}`, \"ws\");\n      });\n\n      socket.on(\"error\", (error) => {\n        log(`WebSocket error for ${socket.userId}: ${error.message}`, \"ws\");\n      });\n    });\n\n    this.heartbeatInterval = setInterval(() => {\n      if (!this.wss) return;\n\n      this.wss.clients.forEach((ws) => {\n        const socket = ws as AuthenticatedSocket;\n        if (!socket.isAlive) {\n          this.handleDisconnect(socket);\n          return socket.terminate();\n        }\n        socket.isAlive = false;\n        socket.ping();\n      });\n    }, 30000);\n\n    log(\"WebSocket server initialized on /ws\", \"ws\");\n  }\n\n  private recordFailedAttempt(clientIp: string) {\n    const existing = this.failedAttempts.get(clientIp);\n    if (existing) {\n      existing.count++;\n      existing.lastAttempt = Date.now();\n    } else {\n      this.failedAttempts.set(clientIp, { count: 1, lastAttempt: Date.now() });\n    }\n  }\n\n  private async handleMessage(socket: AuthenticatedSocket, message: any) {\n    if (!socket.isAuthenticated) {\n      socket.send(\n        JSON.stringify({\n          type: \"error\",\n          payload: { message: \"Not authenticated\" },\n        })\n      );\n      return;\n    }\n\n    switch (message.type) {\n      case \"join-project\":\n        await this.handleJoinProject(socket, message.payload);\n        break;\n\n      case \"leave-project\":\n        this.handleLeaveProject(socket);\n        break;\n\n      case \"join-organization\":\n        await this.handleJoinOrganization(socket, message.payload);\n        break;\n\n      case \"leave-organization\":\n        this.handleLeaveOrganization(socket);\n        break;\n\n      case \"cursor-move\":\n        this.handleCursorMove(socket, message.payload);\n        break;\n\n      case \"ping\":\n        socket.send(JSON.stringify({ type: \"pong\", timestamp: Date.now() }));\n        break;\n\n      default:\n        socket.send(\n          JSON.stringify({\n            type: \"error\",\n            payload: { message: `Unknown message type: ${message.type}` },\n          })\n        );\n    }\n  }\n\n  private async handleJoinProject(\n    socket: AuthenticatedSocket,\n    payload: { projectId: number }\n  ) {\n    if (!payload.projectId) {\n      socket.send(\n        JSON.stringify({\n          type: \"error\",\n          payload: { message: \"Missing projectId\" },\n        })\n      );\n      return;\n    }\n\n    const project = await storage.getProject(payload.projectId);\n    if (!project) {\n      socket.send(\n        JSON.stringify({\n          type: \"error\",\n          payload: { message: \"Project not found\" },\n        })\n      );\n      return;\n    }\n\n    const userOrg = await storage.getUserOrganization(socket.userId, project.organizationId);\n    if (!userOrg) {\n      log(`Access denied: ${socket.userId} tried to join project ${payload.projectId}`, \"ws\");\n      socket.send(\n        JSON.stringify({\n          type: \"error\",\n          payload: { message: \"Access denied to project\" },\n        })\n      );\n      return;\n    }\n\n    this.handleLeaveProject(socket);\n\n    socket.projectId = payload.projectId;\n\n    if (!this.projectRooms.has(payload.projectId)) {\n      this.projectRooms.set(payload.projectId, new Set());\n    }\n    this.projectRooms.get(payload.projectId)!.add(socket);\n\n    this.broadcastToProject(\n      payload.projectId,\n      {\n        type: \"user-joined\",\n        payload: {\n          userId: socket.userId,\n          projectId: payload.projectId,\n        },\n        timestamp: Date.now(),\n        userId: socket.userId,\n      },\n      socket\n    );\n\n    const usersInRoom = Array.from(\n      this.projectRooms.get(payload.projectId) || []\n    ).map((s) => s.userId);\n\n    socket.send(\n      JSON.stringify({\n        type: \"project-joined\",\n        payload: {\n          projectId: payload.projectId,\n          users: usersInRoom,\n          timestamp: Date.now(),\n        },\n      })\n    );\n\n    log(\n      `User ${socket.userId} joined project ${payload.projectId} (${usersInRoom.length} users online)`,\n      \"ws\"\n    );\n  }\n\n  private handleLeaveProject(socket: AuthenticatedSocket) {\n    if (!socket.projectId) return;\n\n    const room = this.projectRooms.get(socket.projectId);\n    if (room) {\n      room.delete(socket);\n\n      this.broadcastToProject(socket.projectId, {\n        type: \"user-left\",\n        payload: {\n          userId: socket.userId,\n          projectId: socket.projectId,\n        },\n        timestamp: Date.now(),\n        userId: socket.userId,\n      });\n\n      if (room.size === 0) {\n        this.projectRooms.delete(socket.projectId);\n      }\n\n      log(`User ${socket.userId} left project ${socket.projectId}`, \"ws\");\n    }\n\n    socket.projectId = undefined;\n  }\n\n  private async handleJoinOrganization(\n    socket: AuthenticatedSocket,\n    payload: { organizationId: number }\n  ) {\n    if (!payload.organizationId) {\n      socket.send(\n        JSON.stringify({\n          type: \"error\",\n          payload: { message: \"Missing organizationId\" },\n        })\n      );\n      return;\n    }\n\n    const userOrg = await storage.getUserOrganization(socket.userId, payload.organizationId);\n    if (!userOrg) {\n      log(`Access denied: ${socket.userId} tried to join organization ${payload.organizationId}`, \"ws\");\n      socket.send(\n        JSON.stringify({\n          type: \"error\",\n          payload: { message: \"Access denied to organization\" },\n        })\n      );\n      return;\n    }\n\n    this.handleLeaveOrganization(socket);\n\n    socket.organizationId = payload.organizationId;\n\n    if (!this.organizationRooms.has(payload.organizationId)) {\n      this.organizationRooms.set(payload.organizationId, new Set());\n    }\n    this.organizationRooms.get(payload.organizationId)!.add(socket);\n\n    socket.send(\n      JSON.stringify({\n        type: \"organization-joined\",\n        payload: {\n          organizationId: payload.organizationId,\n          timestamp: Date.now(),\n        },\n      })\n    );\n\n    log(\n      `User ${socket.userId} joined organization ${payload.organizationId}`,\n      \"ws\"\n    );\n  }\n\n  private handleLeaveOrganization(socket: AuthenticatedSocket) {\n    if (!socket.organizationId) return;\n\n    const room = this.organizationRooms.get(socket.organizationId);\n    if (room) {\n      room.delete(socket);\n      if (room.size === 0) {\n        this.organizationRooms.delete(socket.organizationId);\n      }\n    }\n\n    socket.organizationId = undefined;\n  }\n\n  private handleCursorMove(\n    socket: AuthenticatedSocket,\n    payload: { x: number; y: number; elementId?: string }\n  ) {\n    if (!socket.projectId) return;\n\n    this.broadcastToProject(\n      socket.projectId,\n      {\n        type: \"cursor-move\",\n        payload: {\n          userId: socket.userId,\n          x: payload.x,\n          y: payload.y,\n          elementId: payload.elementId,\n        },\n        timestamp: Date.now(),\n        userId: socket.userId,\n      },\n      socket\n    );\n  }\n\n  private handleDisconnect(socket: AuthenticatedSocket) {\n    this.handleLeaveProject(socket);\n    this.handleLeaveOrganization(socket);\n  }\n\n  broadcastToProject(\n    projectId: number,\n    message: BroadcastMessage,\n    excludeSocket?: AuthenticatedSocket\n  ) {\n    const room = this.projectRooms.get(projectId);\n    if (!room) return;\n\n    const data = JSON.stringify(message);\n    room.forEach((socket) => {\n      if (socket !== excludeSocket && socket.readyState === WebSocket.OPEN) {\n        socket.send(data);\n      }\n    });\n  }\n\n  broadcastToOrganization(\n    organizationId: number,\n    message: BroadcastMessage,\n    excludeSocket?: AuthenticatedSocket\n  ) {\n    const room = this.organizationRooms.get(organizationId);\n    if (!room) return;\n\n    const data = JSON.stringify(message);\n    room.forEach((socket) => {\n      if (socket !== excludeSocket && socket.readyState === WebSocket.OPEN) {\n        socket.send(data);\n      }\n    });\n  }\n\n  notifyProjectUpdate(\n    projectId: number,\n    eventType: EventType,\n    payload: any,\n    userId: string\n  ) {\n    this.broadcastToProject(projectId, {\n      type: eventType,\n      payload,\n      timestamp: Date.now(),\n      userId,\n    });\n  }\n\n  notifyOrganizationUpdate(\n    organizationId: number,\n    eventType: EventType,\n    payload: any,\n    userId: string\n  ) {\n    this.broadcastToOrganization(organizationId, {\n      type: eventType,\n      payload,\n      timestamp: Date.now(),\n      userId,\n    });\n  }\n\n  getProjectUserCount(projectId: number): number {\n    return this.projectRooms.get(projectId)?.size || 0;\n  }\n\n  getConnectedUsers(): number {\n    return this.wss?.clients.size || 0;\n  }\n\n  shutdown() {\n    if (this.heartbeatInterval) {\n      clearInterval(this.heartbeatInterval);\n    }\n\n    if (this.wss) {\n      this.wss.clients.forEach((client) => {\n        client.close();\n      });\n      this.wss.close();\n    }\n\n    this.projectRooms.clear();\n    this.organizationRooms.clear();\n    this.failedAttempts.clear();\n\n    log(\"WebSocket server shut down\", \"ws\");\n  }\n}\n\nexport const wsManager = new WebSocketManager();\n","size_bytes":14718},"client/src/pages/AnalyticsPage.tsx":{"content":"import { useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { \n  AlertTriangle, Loader2, TrendingUp, TrendingDown, Minus,\n  CheckCircle2, Clock, AlertCircle, BarChart3, Activity\n} from \"lucide-react\";\nimport { \n  AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer,\n  BarChart, Bar, PieChart, Pie, Cell, Legend\n} from \"recharts\";\nimport type { Task, Risk, Issue, CostItem } from \"@shared/schema\";\n\nconst COLORS = [\"hsl(var(--chart-1))\", \"hsl(var(--chart-2))\", \"hsl(var(--chart-3))\", \"hsl(var(--chart-4))\", \"hsl(var(--chart-5))\"];\n\nexport default function AnalyticsPage() {\n  const { selectedProjectId } = useProject();\n\n  const { data: tasks = [], isLoading: tasksLoading } = useQuery<Task[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/tasks`],\n    enabled: !!selectedProjectId,\n  });\n\n  const { data: risks = [], isLoading: risksLoading } = useQuery<Risk[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/risks`],\n    enabled: !!selectedProjectId,\n  });\n\n  const { data: issues = [], isLoading: issuesLoading } = useQuery<Issue[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/issues`],\n    enabled: !!selectedProjectId,\n  });\n\n  const { data: costs = [], isLoading: costsLoading } = useQuery<CostItem[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/costs`],\n    enabled: !!selectedProjectId,\n  });\n\n  const taskStats = useMemo(() => {\n    const total = tasks.length;\n    const completed = tasks.filter(t => t.status === \"completed\").length;\n    const inProgress = tasks.filter(t => t.status === \"in-progress\").length;\n    const notStarted = tasks.filter(t => t.status === \"not-started\").length;\n    const onHold = tasks.filter(t => t.status === \"on-hold\").length;\n    const review = tasks.filter(t => t.status === \"review\").length;\n    \n    const avgProgress = total > 0 \n      ? Math.round(tasks.reduce((sum, t) => sum + (t.progress || 0), 0) / total)\n      : 0;\n\n    const byPriority = {\n      critical: tasks.filter(t => t.priority === \"critical\").length,\n      high: tasks.filter(t => t.priority === \"high\").length,\n      medium: tasks.filter(t => t.priority === \"medium\").length,\n      low: tasks.filter(t => t.priority === \"low\").length,\n    };\n\n    return { total, completed, inProgress, notStarted, onHold, review, avgProgress, byPriority };\n  }, [tasks]);\n\n  const riskStats = useMemo(() => {\n    const total = risks.length;\n    const open = risks.filter(r => r.status !== \"closed\").length;\n    \n    const byImpact = {\n      critical: risks.filter(r => r.impact === \"critical\").length,\n      high: risks.filter(r => r.impact === \"high\").length,\n      medium: risks.filter(r => r.impact === \"medium\").length,\n      low: risks.filter(r => r.impact === \"low\").length,\n    };\n\n    return { total, open, byImpact };\n  }, [risks]);\n\n  const issueStats = useMemo(() => {\n    const total = issues.length;\n    const open = issues.filter(i => i.status === \"open\").length;\n    const resolved = issues.filter(i => i.status === \"resolved\").length;\n    \n    const byPriority = {\n      critical: issues.filter(i => i.priority === \"critical\").length,\n      high: issues.filter(i => i.priority === \"high\").length,\n      medium: issues.filter(i => i.priority === \"medium\").length,\n      low: issues.filter(i => i.priority === \"low\").length,\n    };\n\n    return { total, open, resolved, byPriority };\n  }, [issues]);\n\n  const costStats = useMemo(() => {\n    const totalBudget = costs.reduce((sum, c) => sum + parseFloat(c.budgeted || \"0\"), 0);\n    const totalActual = costs.reduce((sum, c) => sum + parseFloat(c.actual || \"0\"), 0);\n    const variance = totalBudget - totalActual;\n    const variancePercent = totalBudget > 0 ? ((variance / totalBudget) * 100) : 0;\n\n    return { totalBudget, totalActual, variance, variancePercent };\n  }, [costs]);\n\n  const statusPieData = [\n    { name: \"Completed\", value: taskStats.completed, color: \"#22c55e\" },\n    { name: \"In Progress\", value: taskStats.inProgress, color: \"#3b82f6\" },\n    { name: \"Not Started\", value: taskStats.notStarted, color: \"#9ca3af\" },\n    { name: \"On Hold\", value: taskStats.onHold, color: \"#f59e0b\" },\n    { name: \"Review\", value: taskStats.review, color: \"#a855f7\" },\n  ].filter(d => d.value > 0);\n\n  const priorityBarData = [\n    { name: \"Critical\", tasks: taskStats.byPriority.critical, risks: riskStats.byImpact.critical, issues: issueStats.byPriority.critical },\n    { name: \"High\", tasks: taskStats.byPriority.high, risks: riskStats.byImpact.high, issues: issueStats.byPriority.high },\n    { name: \"Medium\", tasks: taskStats.byPriority.medium, risks: riskStats.byImpact.medium, issues: issueStats.byPriority.medium },\n    { name: \"Low\", tasks: taskStats.byPriority.low, risks: riskStats.byImpact.low, issues: issueStats.byPriority.low },\n  ];\n\n  const isLoading = tasksLoading || risksLoading || issuesLoading || costsLoading;\n\n  if (!selectedProjectId) {\n    return (\n      <div className=\"p-6\">\n        <Alert>\n          <AlertTriangle className=\"h-4 w-4\" />\n          <AlertDescription>\n            Please select a project from the dropdown above to view analytics.\n          </AlertDescription>\n        </Alert>\n      </div>\n    );\n  }\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-semibold\" data-testid=\"page-title-analytics\">Analytics</h1>\n        <p className=\"text-muted-foreground\">Project performance and trends</p>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Overall Progress</p>\n                <p className=\"text-2xl font-bold\">{taskStats.avgProgress}%</p>\n              </div>\n              <div className=\"h-12 w-12 rounded-full bg-primary/10 flex items-center justify-center\">\n                <Activity className=\"h-6 w-6 text-primary\" />\n              </div>\n            </div>\n            <Progress value={taskStats.avgProgress} className=\"mt-3\" />\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Tasks Completed</p>\n                <p className=\"text-2xl font-bold\">\n                  {taskStats.completed}/{taskStats.total}\n                </p>\n              </div>\n              <div className=\"h-12 w-12 rounded-full bg-green-500/10 flex items-center justify-center\">\n                <CheckCircle2 className=\"h-6 w-6 text-green-500\" />\n              </div>\n            </div>\n            <p className=\"text-sm text-muted-foreground mt-2\">\n              {taskStats.total > 0 ? Math.round((taskStats.completed / taskStats.total) * 100) : 0}% completion rate\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Open Risks</p>\n                <p className=\"text-2xl font-bold\">{riskStats.open}</p>\n              </div>\n              <div className=\"h-12 w-12 rounded-full bg-amber-500/10 flex items-center justify-center\">\n                <AlertTriangle className=\"h-6 w-6 text-amber-500\" />\n              </div>\n            </div>\n            <div className=\"flex gap-1 mt-2\">\n              {riskStats.byImpact.critical > 0 && (\n                <Badge variant=\"destructive\" className=\"text-xs\">{riskStats.byImpact.critical} Critical</Badge>\n              )}\n              {riskStats.byImpact.high > 0 && (\n                <Badge variant=\"outline\" className=\"text-xs border-orange-500 text-orange-500\">{riskStats.byImpact.high} High</Badge>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Budget Variance</p>\n                <p className=\"text-2xl font-bold flex items-center gap-1\">\n                  {costStats.variancePercent >= 0 ? (\n                    <TrendingUp className=\"h-5 w-5 text-green-500\" />\n                  ) : (\n                    <TrendingDown className=\"h-5 w-5 text-red-500\" />\n                  )}\n                  {Math.abs(costStats.variancePercent).toFixed(1)}%\n                </p>\n              </div>\n              <div className=\"h-12 w-12 rounded-full bg-blue-500/10 flex items-center justify-center\">\n                <BarChart3 className=\"h-6 w-6 text-blue-500\" />\n              </div>\n            </div>\n            <p className=\"text-sm text-muted-foreground mt-2\">\n              ${costStats.variance.toLocaleString()} {costStats.variance >= 0 ? \"under\" : \"over\"} budget\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-lg\">Task Status Distribution</CardTitle>\n          </CardHeader>\n          <CardContent>\n            {statusPieData.length === 0 ? (\n              <div className=\"h-[300px] flex items-center justify-center text-muted-foreground\">\n                No tasks to display\n              </div>\n            ) : (\n              <div className=\"h-[300px]\">\n                <ResponsiveContainer width=\"100%\" height=\"100%\">\n                  <PieChart>\n                    <Pie\n                      data={statusPieData}\n                      cx=\"50%\"\n                      cy=\"50%\"\n                      innerRadius={60}\n                      outerRadius={100}\n                      paddingAngle={2}\n                      dataKey=\"value\"\n                      label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}\n                    >\n                      {statusPieData.map((entry, index) => (\n                        <Cell key={`cell-${index}`} fill={entry.color} />\n                      ))}\n                    </Pie>\n                    <Tooltip />\n                  </PieChart>\n                </ResponsiveContainer>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-lg\">Priority Breakdown</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"h-[300px]\">\n              <ResponsiveContainer width=\"100%\" height=\"100%\">\n                <BarChart data={priorityBarData}>\n                  <CartesianGrid strokeDasharray=\"3 3\" className=\"stroke-muted\" />\n                  <XAxis dataKey=\"name\" className=\"text-muted-foreground\" />\n                  <YAxis className=\"text-muted-foreground\" />\n                  <Tooltip \n                    contentStyle={{ \n                      backgroundColor: \"hsl(var(--background))\", \n                      border: \"1px solid hsl(var(--border))\",\n                      borderRadius: \"8px\"\n                    }}\n                  />\n                  <Legend />\n                  <Bar dataKey=\"tasks\" name=\"Tasks\" fill=\"hsl(var(--chart-1))\" />\n                  <Bar dataKey=\"risks\" name=\"Risks\" fill=\"hsl(var(--chart-2))\" />\n                  <Bar dataKey=\"issues\" name=\"Issues\" fill=\"hsl(var(--chart-3))\" />\n                </BarChart>\n              </ResponsiveContainer>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <Clock className=\"h-5 w-5\" />\n              Task Summary\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <div className=\"flex items-center justify-between p-2 rounded-lg bg-muted/50\">\n              <span className=\"text-sm\">Not Started</span>\n              <Badge variant=\"secondary\">{taskStats.notStarted}</Badge>\n            </div>\n            <div className=\"flex items-center justify-between p-2 rounded-lg bg-muted/50\">\n              <span className=\"text-sm\">In Progress</span>\n              <Badge>{taskStats.inProgress}</Badge>\n            </div>\n            <div className=\"flex items-center justify-between p-2 rounded-lg bg-muted/50\">\n              <span className=\"text-sm\">In Review</span>\n              <Badge variant=\"outline\">{taskStats.review}</Badge>\n            </div>\n            <div className=\"flex items-center justify-between p-2 rounded-lg bg-muted/50\">\n              <span className=\"text-sm\">Completed</span>\n              <Badge className=\"bg-green-500\">{taskStats.completed}</Badge>\n            </div>\n            <div className=\"flex items-center justify-between p-2 rounded-lg bg-muted/50\">\n              <span className=\"text-sm\">On Hold</span>\n              <Badge variant=\"destructive\">{taskStats.onHold}</Badge>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <AlertTriangle className=\"h-5 w-5\" />\n              Risk Summary\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <div className=\"flex items-center justify-between p-2 rounded-lg bg-muted/50\">\n              <span className=\"text-sm\">Total Risks</span>\n              <Badge variant=\"secondary\">{riskStats.total}</Badge>\n            </div>\n            <div className=\"flex items-center justify-between p-2 rounded-lg bg-muted/50\">\n              <span className=\"text-sm\">Open Risks</span>\n              <Badge variant=\"destructive\">{riskStats.open}</Badge>\n            </div>\n            <div className=\"flex items-center justify-between p-2 rounded-lg bg-muted/50\">\n              <span className=\"text-sm\">Critical Impact</span>\n              <Badge variant=\"destructive\">{riskStats.byImpact.critical}</Badge>\n            </div>\n            <div className=\"flex items-center justify-between p-2 rounded-lg bg-muted/50\">\n              <span className=\"text-sm\">High Impact</span>\n              <Badge className=\"bg-orange-500\">{riskStats.byImpact.high}</Badge>\n            </div>\n            <div className=\"flex items-center justify-between p-2 rounded-lg bg-muted/50\">\n              <span className=\"text-sm\">Medium Impact</span>\n              <Badge className=\"bg-amber-500\">{riskStats.byImpact.medium}</Badge>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <AlertCircle className=\"h-5 w-5\" />\n              Issue Summary\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <div className=\"flex items-center justify-between p-2 rounded-lg bg-muted/50\">\n              <span className=\"text-sm\">Total Issues</span>\n              <Badge variant=\"secondary\">{issueStats.total}</Badge>\n            </div>\n            <div className=\"flex items-center justify-between p-2 rounded-lg bg-muted/50\">\n              <span className=\"text-sm\">Open Issues</span>\n              <Badge variant=\"destructive\">{issueStats.open}</Badge>\n            </div>\n            <div className=\"flex items-center justify-between p-2 rounded-lg bg-muted/50\">\n              <span className=\"text-sm\">Resolved</span>\n              <Badge className=\"bg-green-500\">{issueStats.resolved}</Badge>\n            </div>\n            <div className=\"flex items-center justify-between p-2 rounded-lg bg-muted/50\">\n              <span className=\"text-sm\">Critical Priority</span>\n              <Badge variant=\"destructive\">{issueStats.byPriority.critical}</Badge>\n            </div>\n            <div className=\"flex items-center justify-between p-2 rounded-lg bg-muted/50\">\n              <span className=\"text-sm\">High Priority</span>\n              <Badge className=\"bg-orange-500\">{issueStats.byPriority.high}</Badge>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","size_bytes":16917},"server/seed-demo.ts":{"content":"import { drizzle } from \"drizzle-orm/neon-http\";\nimport { neon } from \"@neondatabase/serverless\";\nimport { eq } from \"drizzle-orm\";\nimport * as schema from \"@shared/schema\";\n\nconst sql = neon(process.env.DATABASE_URL!);\nconst db = drizzle(sql, { schema });\n\nconst DEMO_ORG_SLUG = \"demo-solar-project\";\nconst DEMO_USER_ID = \"demo-system-user\";\n\nasync function seedDemoProject() {\n  console.log(\"🌞 Creating Demo Solar Power Plant Project...\");\n\n  // Check if demo org already exists\n  const existingOrg = await db.query.organizations.findFirst({\n    where: eq(schema.organizations.slug, DEMO_ORG_SLUG),\n  });\n\n  if (existingOrg) {\n    console.log(\"⚠️ Demo organization already exists. Skipping seed.\");\n    return;\n  }\n\n  // Create Demo Organization\n  const [demoOrg] = await db.insert(schema.organizations).values({\n    name: \"Demo: GreenEnergy Solar\",\n    slug: DEMO_ORG_SLUG,\n  }).returning();\n\n  console.log(\"✓ Created Demo Organization:\", demoOrg.name);\n\n  // Create demo system user (for ownership of items)\n  let demoUser;\n  const existingUser = await db.query.users.findFirst({\n    where: eq(schema.users.id, DEMO_USER_ID),\n  });\n  \n  if (!existingUser) {\n    [demoUser] = await db.insert(schema.users).values({\n      id: DEMO_USER_ID,\n      email: \"demo@greenenergy-solar.com\",\n      firstName: \"Demo\",\n      lastName: \"Project Manager\",\n      profileImageUrl: null,\n    }).returning();\n  } else {\n    demoUser = existingUser;\n  }\n\n  // Link demo user as owner\n  await db.insert(schema.userOrganizations).values({\n    userId: demoUser.id,\n    organizationId: demoOrg.id,\n    role: \"owner\",\n  });\n\n  // Create the main demo project\n  const [project] = await db.insert(schema.projects).values({\n    organizationId: demoOrg.id,\n    name: \"50MW Riverside Solar Power Plant\",\n    code: \"SOLAR-2024-001\",\n    description: \"Engineering, Procurement, and Construction of a 50MW utility-scale solar photovoltaic power plant in Riverside County. Includes 150,000 solar panels, inverters, substation, and grid connection.\",\n    status: \"active\",\n    startDate: new Date(\"2024-01-15\"),\n    endDate: new Date(\"2025-09-30\"),\n    budget: \"75000000\",\n    currency: \"USD\",\n  }).returning();\n\n  console.log(\"✓ Created project:\", project.name);\n\n  // ============================================\n  // WBS TASK HIERARCHY - 5 LEVELS\n  // ============================================\n  \n  // Level 1: Major Phases\n  const [phase1] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: null,\n    wbsCode: \"1\",\n    name: \"Project Initiation & Planning\",\n    description: \"Project setup, feasibility studies, and detailed planning\",\n    status: \"completed\",\n    priority: \"critical\",\n    progress: 100,\n    startDate: new Date(\"2024-01-15\"),\n    endDate: new Date(\"2024-03-31\"),\n    estimatedHours: \"2400\",\n    actualHours: \"2280\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  const [phase2] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: null,\n    wbsCode: \"2\",\n    name: \"Engineering & Design\",\n    description: \"Detailed engineering, design documents, and technical specifications\",\n    status: \"completed\",\n    priority: \"critical\",\n    progress: 100,\n    startDate: new Date(\"2024-03-01\"),\n    endDate: new Date(\"2024-06-30\"),\n    estimatedHours: \"4800\",\n    actualHours: \"5100\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  const [phase3] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: null,\n    wbsCode: \"3\",\n    name: \"Procurement\",\n    description: \"Equipment procurement, vendor selection, and logistics\",\n    status: \"completed\",\n    priority: \"high\",\n    progress: 100,\n    startDate: new Date(\"2024-04-01\"),\n    endDate: new Date(\"2024-08-31\"),\n    estimatedHours: \"1600\",\n    actualHours: \"1520\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  const [phase4] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: null,\n    wbsCode: \"4\",\n    name: \"Construction\",\n    description: \"Site preparation, installation, and civil works\",\n    status: \"in-progress\",\n    priority: \"critical\",\n    progress: 65,\n    startDate: new Date(\"2024-06-01\"),\n    endDate: new Date(\"2025-06-30\"),\n    estimatedHours: \"48000\",\n    actualHours: \"28800\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  const [phase5] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: null,\n    wbsCode: \"5\",\n    name: \"Commissioning & Handover\",\n    description: \"Testing, commissioning, grid connection, and project handover\",\n    status: \"not-started\",\n    priority: \"high\",\n    progress: 0,\n    startDate: new Date(\"2025-05-01\"),\n    endDate: new Date(\"2025-09-30\"),\n    estimatedHours: \"3200\",\n    actualHours: \"0\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  console.log(\"✓ Created Level 1 phases\");\n\n  // Level 2: Phase 1 - Project Initiation\n  const [task1_1] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: phase1.id,\n    wbsCode: \"1.1\",\n    name: \"Feasibility Study\",\n    description: \"Solar resource assessment and financial viability analysis\",\n    status: \"completed\",\n    priority: \"critical\",\n    progress: 100,\n    startDate: new Date(\"2024-01-15\"),\n    endDate: new Date(\"2024-02-15\"),\n    estimatedHours: \"480\",\n    actualHours: \"460\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  const [task1_2] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: phase1.id,\n    wbsCode: \"1.2\",\n    name: \"Environmental Impact Assessment\",\n    description: \"EIA study and regulatory approvals\",\n    status: \"completed\",\n    priority: \"high\",\n    progress: 100,\n    startDate: new Date(\"2024-02-01\"),\n    endDate: new Date(\"2024-03-15\"),\n    estimatedHours: \"720\",\n    actualHours: \"780\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  const [task1_3] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: phase1.id,\n    wbsCode: \"1.3\",\n    name: \"Land Acquisition & Permits\",\n    description: \"Land lease agreements and construction permits\",\n    status: \"completed\",\n    priority: \"critical\",\n    progress: 100,\n    startDate: new Date(\"2024-02-15\"),\n    endDate: new Date(\"2024-03-31\"),\n    estimatedHours: \"600\",\n    actualHours: \"520\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  // Level 2: Phase 2 - Engineering\n  const [task2_1] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: phase2.id,\n    wbsCode: \"2.1\",\n    name: \"Preliminary Design\",\n    description: \"Conceptual layout and system sizing\",\n    status: \"completed\",\n    priority: \"high\",\n    progress: 100,\n    startDate: new Date(\"2024-03-01\"),\n    endDate: new Date(\"2024-04-15\"),\n    estimatedHours: \"960\",\n    actualHours: \"1020\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  const [task2_2] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: phase2.id,\n    wbsCode: \"2.2\",\n    name: \"Detailed Engineering\",\n    description: \"Complete design packages for all systems\",\n    status: \"completed\",\n    priority: \"critical\",\n    progress: 100,\n    startDate: new Date(\"2024-04-01\"),\n    endDate: new Date(\"2024-06-15\"),\n    estimatedHours: \"2400\",\n    actualHours: \"2580\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  const [task2_3] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: phase2.id,\n    wbsCode: \"2.3\",\n    name: \"Grid Connection Design\",\n    description: \"Substation and transmission line engineering\",\n    status: \"completed\",\n    priority: \"high\",\n    progress: 100,\n    startDate: new Date(\"2024-05-01\"),\n    endDate: new Date(\"2024-06-30\"),\n    estimatedHours: \"1200\",\n    actualHours: \"1320\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  // Level 2: Phase 3 - Procurement\n  const [task3_1] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: phase3.id,\n    wbsCode: \"3.1\",\n    name: \"Solar Panels Procurement\",\n    description: \"Purchase of 150,000 monocrystalline panels (400W each)\",\n    status: \"completed\",\n    priority: \"critical\",\n    progress: 100,\n    startDate: new Date(\"2024-04-01\"),\n    endDate: new Date(\"2024-06-30\"),\n    estimatedHours: \"400\",\n    actualHours: \"380\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  const [task3_2] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: phase3.id,\n    wbsCode: \"3.2\",\n    name: \"Inverter Systems\",\n    description: \"Central inverters and string inverters procurement\",\n    status: \"completed\",\n    priority: \"high\",\n    progress: 100,\n    startDate: new Date(\"2024-05-01\"),\n    endDate: new Date(\"2024-07-31\"),\n    estimatedHours: \"320\",\n    actualHours: \"300\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  const [task3_3] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: phase3.id,\n    wbsCode: \"3.3\",\n    name: \"Mounting Structures\",\n    description: \"Tracker systems and fixed-tilt structures\",\n    status: \"completed\",\n    priority: \"high\",\n    progress: 100,\n    startDate: new Date(\"2024-05-15\"),\n    endDate: new Date(\"2024-08-15\"),\n    estimatedHours: \"480\",\n    actualHours: \"440\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  const [task3_4] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: phase3.id,\n    wbsCode: \"3.4\",\n    name: \"Electrical Equipment\",\n    description: \"Transformers, switchgear, and cables\",\n    status: \"completed\",\n    priority: \"high\",\n    progress: 100,\n    startDate: new Date(\"2024-06-01\"),\n    endDate: new Date(\"2024-08-31\"),\n    estimatedHours: \"400\",\n    actualHours: \"400\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  // Level 2: Phase 4 - Construction\n  const [task4_1] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: phase4.id,\n    wbsCode: \"4.1\",\n    name: \"Site Preparation\",\n    description: \"Clearing, grading, and access roads\",\n    status: \"completed\",\n    priority: \"critical\",\n    progress: 100,\n    startDate: new Date(\"2024-06-01\"),\n    endDate: new Date(\"2024-08-31\"),\n    estimatedHours: \"4800\",\n    actualHours: \"5200\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  const [task4_2] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: phase4.id,\n    wbsCode: \"4.2\",\n    name: \"Civil Works\",\n    description: \"Foundations, drainage, and fencing\",\n    status: \"completed\",\n    priority: \"high\",\n    progress: 100,\n    startDate: new Date(\"2024-08-01\"),\n    endDate: new Date(\"2024-11-30\"),\n    estimatedHours: \"7200\",\n    actualHours: \"7400\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  const [task4_3] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: phase4.id,\n    wbsCode: \"4.3\",\n    name: \"Mounting Structure Installation\",\n    description: \"Tracker and fixed-mount assembly\",\n    status: \"in-progress\",\n    priority: \"critical\",\n    progress: 85,\n    startDate: new Date(\"2024-10-01\"),\n    endDate: new Date(\"2025-02-28\"),\n    estimatedHours: \"9600\",\n    actualHours: \"7200\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  const [task4_4] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: phase4.id,\n    wbsCode: \"4.4\",\n    name: \"Panel Installation\",\n    description: \"Solar panel mounting and connection\",\n    status: \"in-progress\",\n    priority: \"critical\",\n    progress: 55,\n    startDate: new Date(\"2024-11-15\"),\n    endDate: new Date(\"2025-04-30\"),\n    estimatedHours: \"14400\",\n    actualHours: \"6600\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  const [task4_5] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: phase4.id,\n    wbsCode: \"4.5\",\n    name: \"Electrical Installation\",\n    description: \"DC/AC wiring, inverters, and combiner boxes\",\n    status: \"in-progress\",\n    priority: \"high\",\n    progress: 40,\n    startDate: new Date(\"2025-01-01\"),\n    endDate: new Date(\"2025-05-31\"),\n    estimatedHours: \"8000\",\n    actualHours: \"2400\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  const [task4_6] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: phase4.id,\n    wbsCode: \"4.6\",\n    name: \"Substation Construction\",\n    description: \"Substation building and equipment installation\",\n    status: \"review\",\n    priority: \"critical\",\n    progress: 25,\n    startDate: new Date(\"2024-12-01\"),\n    endDate: new Date(\"2025-06-30\"),\n    estimatedHours: \"4000\",\n    actualHours: \"1000\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  // Level 2: Phase 5 - Commissioning\n  const [task5_1] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: phase5.id,\n    wbsCode: \"5.1\",\n    name: \"System Testing\",\n    description: \"Electrical testing and safety inspections\",\n    status: \"not-started\",\n    priority: \"critical\",\n    progress: 0,\n    startDate: new Date(\"2025-05-01\"),\n    endDate: new Date(\"2025-06-30\"),\n    estimatedHours: \"1200\",\n    actualHours: \"0\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  const [task5_2] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: phase5.id,\n    wbsCode: \"5.2\",\n    name: \"Grid Synchronization\",\n    description: \"Grid connection and power quality testing\",\n    status: \"not-started\",\n    priority: \"critical\",\n    progress: 0,\n    startDate: new Date(\"2025-06-15\"),\n    endDate: new Date(\"2025-08-15\"),\n    estimatedHours: \"800\",\n    actualHours: \"0\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  const [task5_3] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: phase5.id,\n    wbsCode: \"5.3\",\n    name: \"Performance Testing\",\n    description: \"30-day performance guarantee test\",\n    status: \"not-started\",\n    priority: \"high\",\n    progress: 0,\n    startDate: new Date(\"2025-07-15\"),\n    endDate: new Date(\"2025-08-31\"),\n    estimatedHours: \"600\",\n    actualHours: \"0\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  const [task5_4] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: phase5.id,\n    wbsCode: \"5.4\",\n    name: \"Training & Handover\",\n    description: \"Operations training and documentation handover\",\n    status: \"not-started\",\n    priority: \"medium\",\n    progress: 0,\n    startDate: new Date(\"2025-08-15\"),\n    endDate: new Date(\"2025-09-30\"),\n    estimatedHours: \"600\",\n    actualHours: \"0\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  console.log(\"✓ Created Level 2 tasks\");\n\n  // Level 3: Detailed sub-tasks\n  // 1.1.x - Feasibility Study details\n  await db.insert(schema.tasks).values([\n    {\n      projectId: project.id,\n      parentId: task1_1.id,\n      wbsCode: \"1.1.1\",\n      name: \"Solar Resource Analysis\",\n      description: \"GHI/DNI data analysis and PVsyst simulation\",\n      status: \"completed\",\n      priority: \"high\",\n      progress: 100,\n      startDate: new Date(\"2024-01-15\"),\n      endDate: new Date(\"2024-01-31\"),\n      estimatedHours: \"160\",\n      actualHours: \"140\",\n      createdBy: demoUser.id,\n    },\n    {\n      projectId: project.id,\n      parentId: task1_1.id,\n      wbsCode: \"1.1.2\",\n      name: \"Financial Modeling\",\n      description: \"LCOE calculations and investment analysis\",\n      status: \"completed\",\n      priority: \"high\",\n      progress: 100,\n      startDate: new Date(\"2024-02-01\"),\n      endDate: new Date(\"2024-02-15\"),\n      estimatedHours: \"200\",\n      actualHours: \"200\",\n      createdBy: demoUser.id,\n    },\n    {\n      projectId: project.id,\n      parentId: task1_1.id,\n      wbsCode: \"1.1.3\",\n      name: \"Site Selection Report\",\n      description: \"Final site recommendation with technical justification\",\n      status: \"completed\",\n      priority: \"medium\",\n      progress: 100,\n      startDate: new Date(\"2024-02-05\"),\n      endDate: new Date(\"2024-02-15\"),\n      estimatedHours: \"120\",\n      actualHours: \"120\",\n      createdBy: demoUser.id,\n    },\n  ]);\n\n  // 2.2.x - Detailed Engineering sub-tasks\n  await db.insert(schema.tasks).values([\n    {\n      projectId: project.id,\n      parentId: task2_2.id,\n      wbsCode: \"2.2.1\",\n      name: \"Electrical Single Line Diagram\",\n      description: \"Complete SLD with protection coordination\",\n      status: \"completed\",\n      priority: \"critical\",\n      progress: 100,\n      startDate: new Date(\"2024-04-01\"),\n      endDate: new Date(\"2024-04-30\"),\n      estimatedHours: \"320\",\n      actualHours: \"340\",\n      createdBy: demoUser.id,\n    },\n    {\n      projectId: project.id,\n      parentId: task2_2.id,\n      wbsCode: \"2.2.2\",\n      name: \"Cable Schedule & Routing\",\n      description: \"DC and AC cable sizing and routing plans\",\n      status: \"completed\",\n      priority: \"high\",\n      progress: 100,\n      startDate: new Date(\"2024-04-15\"),\n      endDate: new Date(\"2024-05-15\"),\n      estimatedHours: \"400\",\n      actualHours: \"420\",\n      createdBy: demoUser.id,\n    },\n    {\n      projectId: project.id,\n      parentId: task2_2.id,\n      wbsCode: \"2.2.3\",\n      name: \"Civil & Structural Drawings\",\n      description: \"Foundation designs and structural calculations\",\n      status: \"completed\",\n      priority: \"high\",\n      progress: 100,\n      startDate: new Date(\"2024-05-01\"),\n      endDate: new Date(\"2024-06-15\"),\n      estimatedHours: \"600\",\n      actualHours: \"640\",\n      createdBy: demoUser.id,\n    },\n    {\n      projectId: project.id,\n      parentId: task2_2.id,\n      wbsCode: \"2.2.4\",\n      name: \"SCADA & Monitoring Design\",\n      description: \"Plant monitoring and control system design\",\n      status: \"completed\",\n      priority: \"medium\",\n      progress: 100,\n      startDate: new Date(\"2024-05-15\"),\n      endDate: new Date(\"2024-06-15\"),\n      estimatedHours: \"280\",\n      actualHours: \"300\",\n      createdBy: demoUser.id,\n    },\n  ]);\n\n  // 4.4.x - Panel Installation sub-tasks  \n  const [task4_4_1] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: task4_4.id,\n    wbsCode: \"4.4.1\",\n    name: \"Zone A Panel Installation\",\n    description: \"Northern section - 50,000 panels\",\n    status: \"completed\",\n    priority: \"critical\",\n    progress: 100,\n    startDate: new Date(\"2024-11-15\"),\n    endDate: new Date(\"2025-01-31\"),\n    estimatedHours: \"4800\",\n    actualHours: \"4600\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  const [task4_4_2] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: task4_4.id,\n    wbsCode: \"4.4.2\",\n    name: \"Zone B Panel Installation\",\n    description: \"Central section - 50,000 panels\",\n    status: \"in-progress\",\n    priority: \"critical\",\n    progress: 60,\n    startDate: new Date(\"2025-01-15\"),\n    endDate: new Date(\"2025-03-15\"),\n    estimatedHours: \"4800\",\n    actualHours: \"2000\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  const [task4_4_3] = await db.insert(schema.tasks).values({\n    projectId: project.id,\n    parentId: task4_4.id,\n    wbsCode: \"4.4.3\",\n    name: \"Zone C Panel Installation\",\n    description: \"Southern section - 50,000 panels\",\n    status: \"not-started\",\n    priority: \"high\",\n    progress: 0,\n    startDate: new Date(\"2025-03-01\"),\n    endDate: new Date(\"2025-04-30\"),\n    estimatedHours: \"4800\",\n    actualHours: \"0\",\n    createdBy: demoUser.id,\n  }).returning();\n\n  console.log(\"✓ Created Level 3 tasks\");\n\n  // Level 4 & 5: Deep hierarchy example\n  await db.insert(schema.tasks).values([\n    {\n      projectId: project.id,\n      parentId: task4_4_2.id,\n      wbsCode: \"4.4.2.1\",\n      name: \"Zone B East Installation\",\n      description: \"Eastern half of Zone B\",\n      status: \"completed\",\n      priority: \"high\",\n      progress: 100,\n      startDate: new Date(\"2025-01-15\"),\n      endDate: new Date(\"2025-02-15\"),\n      estimatedHours: \"2400\",\n      actualHours: \"2000\",\n      createdBy: demoUser.id,\n    },\n    {\n      projectId: project.id,\n      parentId: task4_4_2.id,\n      wbsCode: \"4.4.2.2\",\n      name: \"Zone B West Installation\",\n      description: \"Western half of Zone B\",\n      status: \"in-progress\",\n      priority: \"critical\",\n      progress: 20,\n      startDate: new Date(\"2025-02-15\"),\n      endDate: new Date(\"2025-03-15\"),\n      estimatedHours: \"2400\",\n      actualHours: \"0\",\n      createdBy: demoUser.id,\n    },\n  ]);\n\n  console.log(\"✓ Created Level 4-5 tasks\");\n\n  // ============================================\n  // TASK DEPENDENCIES - All Types\n  // ============================================\n  \n  // Get all tasks for dependency mapping\n  const allTasks = await db.query.tasks.findMany({\n    where: eq(schema.tasks.projectId, project.id),\n  });\n  \n  const getTaskByCode = (code: string) => allTasks.find(t => t.wbsCode === code);\n\n  await db.insert(schema.taskDependencies).values([\n    // FS (Finish-to-Start) - Most common\n    { projectId: project.id, predecessorId: phase1.id, successorId: phase2.id, type: \"FS\", lagDays: 0 },\n    { projectId: project.id, predecessorId: task1_1.id, successorId: task1_2.id, type: \"FS\", lagDays: 0 },\n    { projectId: project.id, predecessorId: task1_2.id, successorId: task1_3.id, type: \"FS\", lagDays: -10 }, // Overlap\n    { projectId: project.id, predecessorId: task2_1.id, successorId: task2_2.id, type: \"FS\", lagDays: 0 },\n    { projectId: project.id, predecessorId: task4_1.id, successorId: task4_2.id, type: \"FS\", lagDays: 0 },\n    { projectId: project.id, predecessorId: task4_2.id, successorId: task4_3.id, type: \"FS\", lagDays: -30 }, // Fast-track\n    { projectId: project.id, predecessorId: task4_3.id, successorId: task4_4.id, type: \"FS\", lagDays: -15 },\n    { projectId: project.id, predecessorId: task4_4.id, successorId: task4_5.id, type: \"FS\", lagDays: -30 },\n    { projectId: project.id, predecessorId: task4_4_1.id, successorId: task4_4_2.id, type: \"FS\", lagDays: -15 },\n    { projectId: project.id, predecessorId: task4_4_2.id, successorId: task4_4_3.id, type: \"FS\", lagDays: -15 },\n    { projectId: project.id, predecessorId: phase4.id, successorId: phase5.id, type: \"FS\", lagDays: -30 },\n    { projectId: project.id, predecessorId: task5_1.id, successorId: task5_2.id, type: \"FS\", lagDays: 0 },\n    { projectId: project.id, predecessorId: task5_2.id, successorId: task5_3.id, type: \"FS\", lagDays: 0 },\n    { projectId: project.id, predecessorId: task5_3.id, successorId: task5_4.id, type: \"FS\", lagDays: 0 },\n    \n    // SS (Start-to-Start) - Parallel work\n    { projectId: project.id, predecessorId: phase2.id, successorId: phase3.id, type: \"SS\", lagDays: 30 },\n    { projectId: project.id, predecessorId: task2_2.id, successorId: task2_3.id, type: \"SS\", lagDays: 30 },\n    { projectId: project.id, predecessorId: task3_1.id, successorId: task3_2.id, type: \"SS\", lagDays: 30 },\n    { projectId: project.id, predecessorId: task3_2.id, successorId: task3_3.id, type: \"SS\", lagDays: 15 },\n    \n    // FF (Finish-to-Finish) - Must finish together\n    { projectId: project.id, predecessorId: task3_3.id, successorId: task3_4.id, type: \"FF\", lagDays: 0 },\n    { projectId: project.id, predecessorId: task4_5.id, successorId: task4_6.id, type: \"FF\", lagDays: 0 },\n    \n    // SF (Start-to-Finish) - Rare but valid\n    { projectId: project.id, predecessorId: task4_4.id, successorId: task3_4.id, type: \"SF\", lagDays: 0 },\n  ]);\n\n  console.log(\"✓ Created task dependencies (FS, SS, FF, SF types)\");\n\n  // ============================================\n  // STAKEHOLDERS\n  // ============================================\n  \n  await db.insert(schema.stakeholders).values([\n    {\n      projectId: project.id,\n      name: \"Jennifer Martinez\",\n      email: \"j.martinez@riversideutility.com\",\n      phone: \"+1-555-0201\",\n      organization: \"Riverside Utility Company\",\n      role: \"sponsor\",\n      influence: 5,\n      interest: 5,\n      notes: \"Primary project sponsor and off-taker. PPA signed for 25 years at $0.045/kWh\",\n    },\n    {\n      projectId: project.id,\n      name: \"Michael Chen\",\n      email: \"m.chen@greenenergy.com\",\n      phone: \"+1-555-0202\",\n      organization: \"GreenEnergy Solar Inc.\",\n      role: \"team-member\",\n      influence: 5,\n      interest: 5,\n      notes: \"EPC Project Director with 15+ years solar experience\",\n    },\n    {\n      projectId: project.id,\n      name: \"Sarah Johnson\",\n      email: \"s.johnson@sunpower.com\",\n      phone: \"+1-555-0203\",\n      organization: \"SunPower Technologies\",\n      role: \"contractor\",\n      influence: 4,\n      interest: 5,\n      notes: \"Solar panel supplier - 150,000 monocrystalline modules\",\n    },\n    {\n      projectId: project.id,\n      name: \"Robert Williams\",\n      email: \"r.williams@invertech.com\",\n      phone: \"+1-555-0204\",\n      organization: \"InverTech Systems\",\n      role: \"contractor\",\n      influence: 3,\n      interest: 4,\n      notes: \"Central inverter supplier and commissioning support\",\n    },\n    {\n      projectId: project.id,\n      name: \"Patricia Anderson\",\n      email: \"p.anderson@county.gov\",\n      phone: \"+1-555-0205\",\n      organization: \"Riverside County Planning\",\n      role: \"other\",\n      influence: 4,\n      interest: 3,\n      notes: \"Land use permits and environmental compliance officer (Regulator)\",\n    },\n    {\n      projectId: project.id,\n      name: \"David Thompson\",\n      email: \"d.thompson@gridops.com\",\n      phone: \"+1-555-0206\",\n      organization: \"State Grid Operations\",\n      role: \"other\",\n      influence: 5,\n      interest: 4,\n      notes: \"Grid interconnection approval and commissioning witness (Regulator)\",\n    },\n    {\n      projectId: project.id,\n      name: \"Emily Davis\",\n      email: \"e.davis@solarfinance.com\",\n      phone: \"+1-555-0207\",\n      organization: \"Solar Finance Partners\",\n      role: \"client\",\n      influence: 4,\n      interest: 5,\n      notes: \"Lead financial investor - $50M project financing\",\n    },\n    {\n      projectId: project.id,\n      name: \"James Wilson\",\n      email: \"j.wilson@buildright.com\",\n      phone: \"+1-555-0208\",\n      organization: \"BuildRight Construction\",\n      role: \"contractor\",\n      influence: 4,\n      interest: 5,\n      notes: \"Civil works and balance of plant contractor\",\n    },\n    {\n      projectId: project.id,\n      name: \"Lisa Brown\",\n      email: \"l.brown@econsult.com\",\n      phone: \"+1-555-0209\",\n      organization: \"Environmental Consultants Inc.\",\n      role: \"consultant\",\n      influence: 3,\n      interest: 4,\n      notes: \"EIA study and environmental monitoring\",\n    },\n    {\n      projectId: project.id,\n      name: \"Mark Garcia\",\n      email: \"m.garcia@localcomm.org\",\n      phone: \"+1-555-0210\",\n      organization: \"Riverside Community Association\",\n      role: \"other\",\n      influence: 2,\n      interest: 4,\n      notes: \"Community liaison - addressing local concerns and employment\",\n    },\n  ]);\n\n  console.log(\"✓ Created stakeholders\");\n\n  // ============================================\n  // RISKS\n  // ============================================\n  \n  await db.insert(schema.risks).values([\n    {\n      projectId: project.id,\n      code: \"RISK-001\",\n      title: \"Supply Chain Delays for Solar Panels\",\n      description: \"Global semiconductor shortage affecting panel manufacturing lead times. Current wait time is 16 weeks vs. planned 10 weeks. Contingency: Negotiate with secondary suppliers in Southeast Asia.\",\n      category: \"schedule\",\n      status: \"closed\",\n      probability: 4,\n      impact: \"high\",\n      mitigationPlan: \"Pre-order 110% of required panels, diversify suppliers across 3 manufacturers, expedited shipping for critical batches\",\n      owner: demoUser.id,\n    },\n    {\n      projectId: project.id,\n      code: \"RISK-002\",\n      title: \"Grid Interconnection Approval Delays\",\n      description: \"Utility company approval process may take longer due to grid capacity studies and upgrade requirements. Contingency: Install battery storage for energy curtailment.\",\n      category: \"technical\",\n      status: \"mitigating\",\n      probability: 3,\n      impact: \"critical\",\n      mitigationPlan: \"Early engagement with utility (6 months ahead), hire experienced grid consultant, pre-submit documentation\",\n      owner: demoUser.id,\n    },\n    {\n      projectId: project.id,\n      code: \"RISK-003\",\n      title: \"Extreme Weather Events\",\n      description: \"Construction delays due to heat waves, dust storms, or unexpected rainfall affecting site work. Contingency: Increase crew size for acceleration.\",\n      category: \"schedule\",\n      status: \"assessed\",\n      probability: 3,\n      impact: \"medium\",\n      mitigationPlan: \"Build 15% schedule contingency, schedule critical activities in mild weather months, install temporary weather shelters\",\n    },\n    {\n      projectId: project.id,\n      code: \"RISK-004\",\n      title: \"Steel Price Volatility\",\n      description: \"Mounting structure steel costs have increased 25% YoY, may continue rising due to tariffs. Contingency: Value engineering to reduce steel usage.\",\n      category: \"financial\",\n      status: \"mitigating\",\n      probability: 4,\n      impact: \"medium\",\n      mitigationPlan: \"Lock in steel prices with 60% deposit, hedge remaining 40% with futures contracts\",\n    },\n    {\n      projectId: project.id,\n      code: \"RISK-005\",\n      title: \"Skilled Labor Shortage\",\n      description: \"Regional competition for electrical workers due to multiple solar projects in the area. Contingency: Bring in crews from other regions.\",\n      category: \"resource\",\n      status: \"mitigating\",\n      probability: 4,\n      impact: \"high\",\n      mitigationPlan: \"Early recruitment (6 months ahead), partner with local technical schools, offer competitive wages and housing\",\n      owner: demoUser.id,\n    },\n    {\n      projectId: project.id,\n      code: \"RISK-006\",\n      title: \"Environmental Compliance Issues\",\n      description: \"Discovery of protected species habitat could trigger additional studies and mitigation requirements. Contingency: Relocate affected areas.\",\n      category: \"regulatory\",\n      status: \"assessed\",\n      probability: 2,\n      impact: \"high\",\n      mitigationPlan: \"Comprehensive pre-construction surveys, wildlife monitoring during construction, designated exclusion zones\",\n    },\n    {\n      projectId: project.id,\n      code: \"RISK-007\",\n      title: \"Inverter Technology Obsolescence\",\n      description: \"Rapid technology changes may make selected inverter model outdated by commissioning\",\n      category: \"technical\",\n      status: \"assessed\",\n      probability: 2,\n      impact: \"low\",\n      mitigationPlan: \"Select proven technology with 10+ year track record, ensure firmware upgrade path, secure long-term service agreement\",\n    },\n    {\n      projectId: project.id,\n      code: \"RISK-008\",\n      title: \"Financing Cost Increase\",\n      description: \"Interest rate hikes could increase project financing costs and affect IRR. Contingency: Renegotiate PPA pricing, reduce scope.\",\n      category: \"financial\",\n      status: \"closed\",\n      probability: 3,\n      impact: \"medium\",\n      mitigationPlan: \"Lock in fixed-rate financing early, maintain strong relationship with multiple lenders\",\n    },\n  ]);\n\n  console.log(\"✓ Created risks\");\n\n  // ============================================\n  // ISSUES\n  // ============================================\n  \n  await db.insert(schema.issues).values([\n    {\n      projectId: project.id,\n      code: \"ISS-001\",\n      title: \"Transformer Delivery Delayed 6 Weeks\",\n      description: \"Main power transformer from ABB has been delayed due to factory capacity constraints. Originally scheduled for delivery in December, now expected mid-January.\",\n      status: \"in-progress\",\n      priority: \"critical\",\n      category: \"technical\",\n      assignedTo: demoUser.id,\n      reportedBy: demoUser.id,\n      reportedDate: new Date(\"2024-11-15\"),\n    },\n    {\n      projectId: project.id,\n      code: \"ISS-002\",\n      title: \"Underground Cable Route Conflict\",\n      description: \"Utility survey discovered existing gas line in planned DC cable route. Requires re-routing approximately 500m of cable trench.\",\n      status: \"in-progress\",\n      priority: \"high\",\n      category: \"technical\",\n      assignedTo: demoUser.id,\n      reportedBy: demoUser.id,\n      reportedDate: new Date(\"2024-10-20\"),\n    },\n    {\n      projectId: project.id,\n      code: \"ISS-003\",\n      title: \"Worker Safety Incident - Heat Exhaustion\",\n      description: \"Two workers hospitalized for heat exhaustion during August heat wave. No permanent injuries. OSHA notification submitted.\",\n      status: \"resolved\",\n      priority: \"critical\",\n      category: \"safety\",\n      reportedBy: demoUser.id,\n      reportedDate: new Date(\"2024-08-12\"),\n      resolvedDate: new Date(\"2024-08-20\"),\n      resolution: \"Implemented mandatory 15-min breaks every hour when temp >100°F, installed additional shade structures, distributed electrolyte drinks\",\n    },\n    {\n      projectId: project.id,\n      code: \"ISS-004\",\n      title: \"Panel Micro-Crack Defects in Batch 23\",\n      description: \"Quality inspection revealed micro-cracks in 2,400 panels from manufacturing batch 23. Potential power degradation over time.\",\n      status: \"resolved\",\n      priority: \"high\",\n      category: \"quality\",\n      reportedBy: demoUser.id,\n      reportedDate: new Date(\"2024-12-01\"),\n      resolvedDate: new Date(\"2024-12-15\"),\n      resolution: \"Supplier replaced all affected panels at no cost. Implemented enhanced receiving inspection with EL testing.\",\n    },\n    {\n      projectId: project.id,\n      code: \"ISS-005\",\n      title: \"Permit Amendment Required for Substation\",\n      description: \"County requires amended building permit due to design changes in substation control building. 3-week processing time expected.\",\n      status: \"in-progress\",\n      priority: \"medium\",\n      category: \"regulatory\",\n      assignedTo: demoUser.id,\n      reportedBy: demoUser.id,\n      reportedDate: new Date(\"2025-01-10\"),\n    },\n    {\n      projectId: project.id,\n      code: \"ISS-006\",\n      title: \"Access Road Erosion After Storm\",\n      description: \"Heavy rainfall caused significant erosion on main site access road. Road partially impassable for heavy equipment.\",\n      status: \"resolved\",\n      priority: \"high\",\n      category: \"environmental\",\n      reportedBy: demoUser.id,\n      reportedDate: new Date(\"2024-09-25\"),\n      resolvedDate: new Date(\"2024-10-02\"),\n      resolution: \"Emergency grading and gravel replacement. Installed additional drainage culverts to prevent recurrence.\",\n    },\n    {\n      projectId: project.id,\n      code: \"ISS-007\",\n      title: \"String Inverter Firmware Bug\",\n      description: \"String inverters exhibit intermittent communication loss with monitoring system. Vendor investigating firmware issue.\",\n      status: \"open\",\n      priority: \"medium\",\n      category: \"technical\",\n      reportedBy: demoUser.id,\n      reportedDate: new Date(\"2025-01-20\"),\n    },\n  ]);\n\n  console.log(\"✓ Created issues\");\n\n  // ============================================\n  // COST ITEMS\n  // ============================================\n  \n  await db.insert(schema.costItems).values([\n    // Engineering & Design\n    {\n      projectId: project.id,\n      category: \"labor\",\n      description: \"Engineering & Design Services\",\n      budgeted: \"2500000\",\n      actual: \"2650000\",\n      currency: \"USD\",\n      date: new Date(\"2024-06-30\"),\n    },\n    {\n      projectId: project.id,\n      category: \"labor\",\n      description: \"Project Management & Supervision\",\n      budgeted: \"3000000\",\n      actual: \"1800000\",\n      currency: \"USD\",\n      date: new Date(\"2025-01-31\"),\n    },\n    // Equipment - Solar Panels\n    {\n      projectId: project.id,\n      category: \"materials\",\n      description: \"Solar Panels (150,000 x 400W Mono)\",\n      budgeted: \"22500000\",\n      actual: \"21200000\",\n      currency: \"USD\",\n      date: new Date(\"2024-08-31\"),\n    },\n    // Equipment - Inverters\n    {\n      projectId: project.id,\n      category: \"equipment\",\n      description: \"Central Inverters (10 x 5MW)\",\n      budgeted: \"5000000\",\n      actual: \"4800000\",\n      currency: \"USD\",\n      date: new Date(\"2024-07-31\"),\n    },\n    // Mounting Structures\n    {\n      projectId: project.id,\n      category: \"materials\",\n      description: \"Tracking Systems & Fixed Mounts\",\n      budgeted: \"12000000\",\n      actual: \"12800000\",\n      currency: \"USD\",\n      date: new Date(\"2024-08-31\"),\n    },\n    // Electrical Balance of System\n    {\n      projectId: project.id,\n      category: \"materials\",\n      description: \"Cables, Combiner Boxes, Switchgear\",\n      budgeted: \"4500000\",\n      actual: \"2100000\",\n      currency: \"USD\",\n      date: new Date(\"2025-01-31\"),\n    },\n    // Transformer & Substation\n    {\n      projectId: project.id,\n      category: \"equipment\",\n      description: \"Substation Equipment & Transformers\",\n      budgeted: \"6000000\",\n      actual: \"1500000\",\n      currency: \"USD\",\n      date: new Date(\"2025-01-31\"),\n    },\n    // Civil Works\n    {\n      projectId: project.id,\n      category: \"labor\",\n      description: \"Site Preparation & Civil Works\",\n      budgeted: \"5500000\",\n      actual: \"5200000\",\n      currency: \"USD\",\n      date: new Date(\"2024-11-30\"),\n    },\n    // Installation Labor\n    {\n      projectId: project.id,\n      category: \"labor\",\n      description: \"Panel & Electrical Installation\",\n      budgeted: \"7000000\",\n      actual: \"3200000\",\n      currency: \"USD\",\n      date: new Date(\"2025-01-31\"),\n    },\n    // Grid Connection\n    {\n      projectId: project.id,\n      category: \"equipment\",\n      description: \"Grid Connection & Transmission Line\",\n      budgeted: \"3500000\",\n      actual: \"500000\",\n      currency: \"USD\",\n      date: new Date(\"2025-01-31\"),\n    },\n    // Contingency\n    {\n      projectId: project.id,\n      category: \"contingency\",\n      description: \"Project Contingency Reserve\",\n      budgeted: \"3500000\",\n      actual: \"850000\",\n      currency: \"USD\",\n      date: new Date(\"2025-01-31\"),\n    },\n  ]);\n\n  console.log(\"✓ Created cost items\");\n\n  // ============================================\n  // RESOURCES\n  // ============================================\n  \n  const resources = await db.insert(schema.resources).values([\n    // Project Management\n    {\n      projectId: project.id,\n      name: \"Project Director - Michael Chen\",\n      type: \"human\",\n      discipline: \"general\",\n      costPerHour: \"175.00\",\n      availability: 100,\n    },\n    {\n      projectId: project.id,\n      name: \"Project Manager - Sarah Johnson\",\n      type: \"human\",\n      discipline: \"general\",\n      costPerHour: \"150.00\",\n      availability: 100,\n    },\n    {\n      projectId: project.id,\n      name: \"Construction Manager - James Rodriguez\",\n      type: \"human\",\n      discipline: \"civil\",\n      costPerHour: \"140.00\",\n      availability: 100,\n    },\n    {\n      projectId: project.id,\n      name: \"HSE Manager - Lisa Wang\",\n      type: \"human\",\n      discipline: \"general\",\n      costPerHour: \"125.00\",\n      availability: 100,\n    },\n    // Engineering Team\n    {\n      projectId: project.id,\n      name: \"Lead Electrical Engineer - David Kim\",\n      type: \"human\",\n      discipline: \"electrical\",\n      costPerHour: \"130.00\",\n      availability: 100,\n    },\n    {\n      projectId: project.id,\n      name: \"Senior Mechanical Engineer - Ahmed Hassan\",\n      type: \"human\",\n      discipline: \"mechanical\",\n      costPerHour: \"120.00\",\n      availability: 100,\n    },\n    {\n      projectId: project.id,\n      name: \"Civil Engineer - Patricia Martinez\",\n      type: \"human\",\n      discipline: \"civil\",\n      costPerHour: \"115.00\",\n      availability: 100,\n    },\n    {\n      projectId: project.id,\n      name: \"Instrumentation Engineer - Robert Chen\",\n      type: \"human\",\n      discipline: \"instrumentation\",\n      costPerHour: \"125.00\",\n      availability: 100,\n    },\n    {\n      projectId: project.id,\n      name: \"SCADA Specialist - Emily Taylor\",\n      type: \"human\",\n      discipline: \"instrumentation\",\n      costPerHour: \"135.00\",\n      availability: 80,\n    },\n    // Construction Crews\n    {\n      projectId: project.id,\n      name: \"Solar Installation Crew A (8 workers)\",\n      type: \"human\",\n      discipline: \"electrical\",\n      costPerHour: \"520.00\",\n      availability: 100,\n    },\n    {\n      projectId: project.id,\n      name: \"Solar Installation Crew B (8 workers)\",\n      type: \"human\",\n      discipline: \"electrical\",\n      costPerHour: \"520.00\",\n      availability: 100,\n    },\n    {\n      projectId: project.id,\n      name: \"Electrical Installation Team (6 workers)\",\n      type: \"human\",\n      discipline: \"electrical\",\n      costPerHour: \"510.00\",\n      availability: 100,\n    },\n    {\n      projectId: project.id,\n      name: \"Civil Works Crew (10 workers)\",\n      type: \"human\",\n      discipline: \"civil\",\n      costPerHour: \"550.00\",\n      availability: 100,\n    },\n    {\n      projectId: project.id,\n      name: \"Structural Steel Team (6 workers)\",\n      type: \"human\",\n      discipline: \"structural\",\n      costPerHour: \"480.00\",\n      availability: 90,\n    },\n    {\n      projectId: project.id,\n      name: \"Cable Pulling Team (4 workers)\",\n      type: \"human\",\n      discipline: \"electrical\",\n      costPerHour: \"320.00\",\n      availability: 100,\n    },\n    // Equipment\n    {\n      projectId: project.id,\n      name: \"Mobile Crane 100T - Liebherr LTM 1100\",\n      type: \"equipment\",\n      discipline: \"civil\",\n      costPerHour: \"350.00\",\n      availability: 80,\n    },\n    {\n      projectId: project.id,\n      name: \"Excavator CAT 320D\",\n      type: \"equipment\",\n      discipline: \"civil\",\n      costPerHour: \"145.00\",\n      availability: 90,\n    },\n    {\n      projectId: project.id,\n      name: \"Excavator CAT 325D\",\n      type: \"equipment\",\n      discipline: \"civil\",\n      costPerHour: \"165.00\",\n      availability: 85,\n    },\n    {\n      projectId: project.id,\n      name: \"Bulldozer CAT D6\",\n      type: \"equipment\",\n      discipline: \"civil\",\n      costPerHour: \"185.00\",\n      availability: 90,\n    },\n    {\n      projectId: project.id,\n      name: \"Concrete Pump Truck\",\n      type: \"equipment\",\n      discipline: \"civil\",\n      costPerHour: \"275.00\",\n      availability: 75,\n    },\n    {\n      projectId: project.id,\n      name: \"Cable Pulling Machine - Greenlee 6001\",\n      type: \"equipment\",\n      discipline: \"electrical\",\n      costPerHour: \"95.00\",\n      availability: 100,\n    },\n    {\n      projectId: project.id,\n      name: \"Aerial Work Platform - JLG 860SJ\",\n      type: \"equipment\",\n      discipline: \"electrical\",\n      costPerHour: \"85.00\",\n      availability: 95,\n    },\n    // Materials (bulk items tracked as resources)\n    {\n      projectId: project.id,\n      name: \"Solar Panel Inventory (monocrystalline 400W)\",\n      type: \"material\",\n      discipline: \"electrical\",\n      costPerHour: \"0.00\",\n      availability: 100,\n    },\n    {\n      projectId: project.id,\n      name: \"DC Cable Stock (1000V rated)\",\n      type: \"material\",\n      discipline: \"electrical\",\n      costPerHour: \"0.00\",\n      availability: 100,\n    },\n  ]).returning();\n\n  console.log(\"✓ Created resources\");\n\n  // Resource Assignments - indices: \n  // 0: Project Director, 1: Project Manager, 2: Construction Manager, 3: HSE Manager\n  // 4: Lead Electrical Engineer, 5: Senior Mechanical Engineer, 6: Civil Engineer\n  // 7: Instrumentation Engineer, 8: SCADA Specialist\n  // 9: Solar Crew A, 10: Solar Crew B, 11: Electrical Team, 12: Civil Crew\n  // 13: Structural Steel Team, 14: Cable Pulling Team\n  // 15: Crane, 16: Excavator 320D, 17: Excavator 325D, 18: Bulldozer\n  // 19: Concrete Pump, 20: Cable Puller, 21: Aerial Platform\n  // 22: Solar Panel Inventory, 23: DC Cable Stock\n  await db.insert(schema.resourceAssignments).values([\n    // Phase 4.1 Site Preparation\n    {\n      taskId: task4_1.id,\n      resourceId: resources[2].id, // Construction Manager\n      allocation: 50,\n    },\n    {\n      taskId: task4_1.id,\n      resourceId: resources[12].id, // Civil Works Crew\n      allocation: 100,\n    },\n    {\n      taskId: task4_1.id,\n      resourceId: resources[16].id, // Excavator 320D\n      allocation: 100,\n    },\n    {\n      taskId: task4_1.id,\n      resourceId: resources[18].id, // Bulldozer\n      allocation: 100,\n    },\n    // Phase 4.2 Civil Works\n    {\n      taskId: task4_2.id,\n      resourceId: resources[6].id, // Civil Engineer\n      allocation: 100,\n    },\n    {\n      taskId: task4_2.id,\n      resourceId: resources[12].id, // Civil Works Crew\n      allocation: 100,\n    },\n    {\n      taskId: task4_2.id,\n      resourceId: resources[19].id, // Concrete Pump\n      allocation: 80,\n    },\n    // Phase 4.3 Mounting Structure Installation\n    {\n      taskId: task4_3.id,\n      resourceId: resources[13].id, // Structural Steel Team\n      allocation: 100,\n    },\n    {\n      taskId: task4_3.id,\n      resourceId: resources[15].id, // Mobile Crane\n      allocation: 80,\n    },\n    // Phase 4.4 Panel Installation\n    {\n      taskId: task4_4.id,\n      resourceId: resources[4].id, // Lead Electrical Engineer\n      allocation: 50,\n    },\n    {\n      taskId: task4_4.id,\n      resourceId: resources[9].id, // Solar Installation Crew A\n      allocation: 100,\n    },\n    {\n      taskId: task4_4.id,\n      resourceId: resources[10].id, // Solar Installation Crew B\n      allocation: 100,\n    },\n    {\n      taskId: task4_4.id,\n      resourceId: resources[21].id, // Aerial Work Platform\n      allocation: 100,\n    },\n    // Phase 4.5 Electrical Installation\n    {\n      taskId: task4_5.id,\n      resourceId: resources[4].id, // Lead Electrical Engineer\n      allocation: 100,\n    },\n    {\n      taskId: task4_5.id,\n      resourceId: resources[11].id, // Electrical Installation Team\n      allocation: 100,\n    },\n    {\n      taskId: task4_5.id,\n      resourceId: resources[14].id, // Cable Pulling Team\n      allocation: 100,\n    },\n    {\n      taskId: task4_5.id,\n      resourceId: resources[20].id, // Cable Pulling Machine\n      allocation: 100,\n    },\n    // Phase 4.6 Substation Construction\n    {\n      taskId: task4_6.id,\n      resourceId: resources[7].id, // Instrumentation Engineer\n      allocation: 75,\n    },\n    {\n      taskId: task4_6.id,\n      resourceId: resources[15].id, // Mobile Crane\n      allocation: 50,\n    },\n    // Phase 5 Commissioning - future assignments\n    {\n      taskId: task5_1.id,\n      resourceId: resources[4].id, // Lead Electrical Engineer\n      allocation: 100,\n    },\n    {\n      taskId: task5_1.id,\n      resourceId: resources[8].id, // SCADA Specialist\n      allocation: 100,\n    },\n  ]);\n\n  console.log(\"✓ Created resource assignments\");\n\n  console.log(\"\\n🎉 Demo Solar Project seeded successfully!\");\n  console.log(`   Organization: ${demoOrg.name} (${demoOrg.slug})`);\n  console.log(`   Project: ${project.name}`);\n  console.log(\"   - 5 phases with 30+ tasks across 5 WBS levels\");\n  console.log(\"   - 22 task dependencies (FS, SS, FF, SF)\");\n  console.log(\"   - 10 stakeholders\");\n  console.log(\"   - 8 risks\");\n  console.log(\"   - 7 issues\");\n  console.log(\"   - 11 cost items ($75M budget)\");\n  console.log(\"   - 24 EPC resources (management, engineering, crews, equipment, materials)\");\n  console.log(\"   - 20 resource assignments across construction phases\");\n}\n\nexport { seedDemoProject, DEMO_ORG_SLUG, DEMO_USER_ID };\n\n// Run via: npx tsx server/seed-demo.ts --run\nconst args = process.argv.slice(2);\nif (args.includes(\"--run\")) {\n  seedDemoProject()\n    .catch((error) => {\n      console.error(\"❌ Error seeding demo project:\", error);\n      process.exit(1);\n    })\n    .then(() => {\n      process.exit(0);\n    });\n}\n","size_bytes":47463},"client/src/pages/DocumentsPage.tsx":{"content":"import { useState, useMemo, useRef } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { DocumentProvider, useDocuments } from \"@/contexts/DocumentContext\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { \n  Plus, AlertTriangle, Loader2, FileText, Search, \n  MoreHorizontal, Pencil, Trash2, Download, Filter,\n  FolderOpen, File, Clock, User, ArrowUpDown, Upload, X\n} from \"lucide-react\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport type { Document } from \"@shared/schema\";\n\nconst DISCIPLINES = [\n  { value: \"civil\", label: \"Civil\" },\n  { value: \"structural\", label: \"Structural\" },\n  { value: \"mechanical\", label: \"Mechanical\" },\n  { value: \"piping\", label: \"Piping\" },\n  { value: \"electrical\", label: \"Electrical\" },\n  { value: \"instrumentation\", label: \"Instrumentation\" },\n  { value: \"process\", label: \"Process\" },\n  { value: \"hse\", label: \"HSE\" },\n  { value: \"commissioning\", label: \"Commissioning\" },\n  { value: \"other\", label: \"Other\" },\n];\n\nconst DOC_TYPE_CATEGORIES = [\n  {\n    label: \"Technical\",\n    types: [\n      { value: \"drawing\", label: \"Drawing\" },\n      { value: \"specification\", label: \"Specification\" },\n      { value: \"datasheet\", label: \"Datasheet\" },\n      { value: \"calculation\", label: \"Calculation\" },\n      { value: \"report\", label: \"Report\" },\n    ]\n  },\n  {\n    label: \"Procedures\",\n    types: [\n      { value: \"sop\", label: \"SOP\" },\n      { value: \"procedure\", label: \"Procedure\" },\n      { value: \"work-instruction\", label: \"Work Instruction\" },\n      { value: \"checklist\", label: \"Checklist\" },\n    ]\n  },\n  {\n    label: \"Commercial\",\n    types: [\n      { value: \"invoice\", label: \"Invoice\" },\n      { value: \"rfp\", label: \"RFP\" },\n      { value: \"contract\", label: \"Contract\" },\n      { value: \"purchase-order\", label: \"Purchase Order\" },\n      { value: \"quote\", label: \"Quote\" },\n    ]\n  },\n  {\n    label: \"Vendor\",\n    types: [\n      { value: \"vendor-doc\", label: \"Vendor Document\" },\n      { value: \"certificate\", label: \"Certificate\" },\n      { value: \"warranty\", label: \"Warranty\" },\n    ]\n  },\n  {\n    label: \"Project\",\n    types: [\n      { value: \"lessons-learned\", label: \"Lessons Learned\" },\n      { value: \"bulletin\", label: \"Bulletin\" },\n      { value: \"meeting-minutes\", label: \"Meeting Minutes\" },\n      { value: \"transmittal\", label: \"Transmittal\" },\n    ]\n  },\n  {\n    label: \"Correspondence\",\n    types: [\n      { value: \"correspondence\", label: \"Correspondence\" },\n      { value: \"rfi\", label: \"RFI\" },\n      { value: \"ncr\", label: \"NCR\" },\n    ]\n  },\n  {\n    label: \"Other\",\n    types: [\n      { value: \"other\", label: \"Other\" },\n    ]\n  }\n];\n\nconst DOC_TYPES = DOC_TYPE_CATEGORIES.flatMap(cat => cat.types);\n\nconst DOC_STATUSES = [\n  { value: \"draft\", label: \"Draft\" },\n  { value: \"ifa\", label: \"Issued for Approval (IFA)\" },\n  { value: \"ifc\", label: \"Issued for Construction (IFC)\" },\n  { value: \"as-built\", label: \"As-Built\" },\n  { value: \"superseded\", label: \"Superseded\" },\n  { value: \"cancelled\", label: \"Cancelled\" },\n];\n\ninterface DocumentFormData {\n  documentNumber: string;\n  title: string;\n  discipline: string;\n  documentType: string;\n  revision: string;\n  status: string;\n  description: string;\n  file: File | null;\n  filePath: string | null;\n  fileSize: number | null;\n}\n\nfunction DocumentsPageContent() {\n  const { selectedProjectId } = useProject();\n  const { documents, isLoading, selectedDocumentId, setSelectedDocumentId } = useDocuments();\n  const { toast } = useToast();\n  const [modalOpen, setModalOpen] = useState(false);\n  const [editingDoc, setEditingDoc] = useState<Document | null>(null);\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [filterDiscipline, setFilterDiscipline] = useState<string>(\"all\");\n  const [filterDocType, setFilterDocType] = useState<string>(\"all\");\n  const [filterStatus, setFilterStatus] = useState<string>(\"all\");\n  const [formData, setFormData] = useState<DocumentFormData>({\n    documentNumber: \"\",\n    title: \"\",\n    discipline: \"civil\",\n    documentType: \"drawing\",\n    revision: \"A\",\n    status: \"draft\",\n    description: \"\",\n    file: null,\n    filePath: null,\n    fileSize: null,\n  });\n  const [isUploading, setIsUploading] = useState(false);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  const createMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return await apiRequest(\"POST\", `/api/documents`, {\n        ...data,\n        projectId: selectedProjectId,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/projects\", selectedProjectId, \"documents\"] });\n      toast({\n        title: \"Success\",\n        description: \"Document created successfully\",\n      });\n      handleCloseModal();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to create document\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: number; data: any }) => {\n      return await apiRequest(\"PATCH\", `/api/documents/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/projects\", selectedProjectId, \"documents\"] });\n      toast({\n        title: \"Success\",\n        description: \"Document updated successfully\",\n      });\n      handleCloseModal();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to update document\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return await apiRequest(\"DELETE\", `/api/documents/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/projects\", selectedProjectId, \"documents\"] });\n      toast({\n        title: \"Success\",\n        description: \"Document deleted successfully\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to delete document\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const filteredDocs = useMemo(() => {\n    return documents.filter(doc => {\n      const matchesSearch = searchTerm === \"\" || \n        doc.title.toLowerCase().includes(searchTerm.toLowerCase()) ||\n        doc.documentNumber.toLowerCase().includes(searchTerm.toLowerCase());\n      const matchesDiscipline = filterDiscipline === \"all\" || doc.discipline === filterDiscipline;\n      const matchesDocType = filterDocType === \"all\" || doc.documentType === filterDocType;\n      const matchesStatus = filterStatus === \"all\" || doc.status === filterStatus;\n      return matchesSearch && matchesDiscipline && matchesDocType && matchesStatus;\n    });\n  }, [documents, searchTerm, filterDiscipline, filterDocType, filterStatus]);\n\n  const docsByDiscipline = useMemo(() => {\n    const grouped: Record<string, Document[]> = {};\n    DISCIPLINES.forEach(d => { grouped[d.value] = []; });\n    filteredDocs.forEach(doc => {\n      const discipline = doc.discipline || \"other\";\n      if (!grouped[discipline]) grouped[discipline] = [];\n      grouped[discipline].push(doc);\n    });\n    return grouped;\n  }, [filteredDocs]);\n\n  const handleOpenModal = (doc?: Document) => {\n    if (doc) {\n      setEditingDoc(doc);\n      setFormData({\n        documentNumber: doc.documentNumber,\n        title: doc.title,\n        discipline: doc.discipline || \"civil\",\n        documentType: doc.documentType || \"drawing\",\n        revision: doc.revision || \"A\",\n        status: doc.status || \"draft\",\n        description: doc.description || \"\",\n        file: null,\n        filePath: doc.filePath || null,\n        fileSize: doc.fileSize || null,\n      });\n    } else {\n      setEditingDoc(null);\n      setFormData({\n        documentNumber: \"\",\n        title: \"\",\n        discipline: \"civil\",\n        documentType: \"drawing\",\n        revision: \"A\",\n        status: \"draft\",\n        description: \"\",\n        file: null,\n        filePath: null,\n        fileSize: null,\n      });\n    }\n    setModalOpen(true);\n  };\n\n  const handleCloseModal = () => {\n    setModalOpen(false);\n    setEditingDoc(null);\n    if (fileInputRef.current) {\n      fileInputRef.current.value = \"\";\n    }\n  };\n\n  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) {\n      setFormData(prev => ({\n        ...prev,\n        file,\n        fileSize: file.size,\n      }));\n    }\n  };\n\n  const removeSelectedFile = () => {\n    setFormData(prev => ({\n      ...prev,\n      file: null,\n      fileSize: null,\n    }));\n    if (fileInputRef.current) {\n      fileInputRef.current.value = \"\";\n    }\n  };\n\n  const formatFileSize = (bytes: number): string => {\n    if (bytes === 0) return '0 Bytes';\n    const k = 1024;\n    const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n  };\n\n  const uploadFile = async (file: File): Promise<{ filePath: string; fileSize: number } | null> => {\n    try {\n      const uploadUrlRes = await apiRequest(\"POST\", `/api/projects/${selectedProjectId}/files/upload-url`, {\n        fileSize: file.size\n      });\n      const { uploadURL, objectId } = await uploadUrlRes.json();\n\n      await fetch(uploadURL, {\n        method: 'PUT',\n        headers: { 'Content-Type': file.type },\n        body: file,\n      });\n\n      await apiRequest(\"POST\", `/api/projects/${selectedProjectId}/files`, {\n        name: objectId,\n        originalName: file.name,\n        mimeType: file.type,\n        size: file.size,\n        objectPath: objectId,\n        category: 'document',\n        description: `Attachment for ${formData.documentNumber}`,\n      });\n\n      return { filePath: objectId, fileSize: file.size };\n    } catch (error) {\n      console.error(\"File upload error:\", error);\n      throw error;\n    }\n  };\n\n  const handleSave = async () => {\n    if (!formData.documentNumber.trim() || !formData.title.trim()) {\n      toast({\n        title: \"Validation Error\",\n        description: \"Document number and title are required\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    let filePath = formData.filePath;\n    let fileSize = formData.fileSize;\n\n    if (formData.file) {\n      setIsUploading(true);\n      try {\n        const uploadResult = await uploadFile(formData.file);\n        if (uploadResult) {\n          filePath = uploadResult.filePath;\n          fileSize = uploadResult.fileSize;\n        }\n      } catch (error) {\n        toast({\n          title: \"Upload Error\",\n          description: \"Failed to upload file. Please try again.\",\n          variant: \"destructive\",\n        });\n        setIsUploading(false);\n        return;\n      }\n      setIsUploading(false);\n    }\n\n    const data = {\n      documentNumber: formData.documentNumber,\n      title: formData.title,\n      discipline: formData.discipline,\n      documentType: formData.documentType,\n      revision: formData.revision,\n      status: formData.status,\n      description: formData.description || null,\n      filePath: filePath || null,\n      fileSize: fileSize || null,\n    };\n\n    if (editingDoc) {\n      updateMutation.mutate({ id: editingDoc.id, data });\n    } else {\n      createMutation.mutate(data);\n    }\n  };\n\n  const handleDelete = (doc: Document) => {\n    if (confirm(`Are you sure you want to delete \"${doc.title}\"?`)) {\n      deleteMutation.mutate(doc.id);\n    }\n  };\n\n  const getStatusBadge = (status: string) => {\n    const statusConfig = DOC_STATUSES.find(s => s.value === status);\n    const variants: Record<string, \"default\" | \"secondary\" | \"destructive\" | \"outline\"> = {\n      \"draft\": \"secondary\",\n      \"ifa\": \"outline\",\n      \"ifc\": \"default\",\n      \"as-built\": \"default\",\n      \"superseded\": \"destructive\",\n      \"cancelled\": \"destructive\",\n    };\n    return (\n      <Badge variant={variants[status] || \"secondary\"}>\n        {statusConfig?.label || status}\n      </Badge>\n    );\n  };\n\n  const isLoading2 = createMutation.isPending || updateMutation.isPending || isUploading;\n\n  if (!selectedProjectId) {\n    return (\n      <div className=\"p-6\">\n        <Alert>\n          <AlertTriangle className=\"h-4 w-4\" />\n          <AlertDescription>\n            Please select a project from the dropdown above to view documents.\n          </AlertDescription>\n        </Alert>\n      </div>\n    );\n  }\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-semibold\" data-testid=\"page-title-documents\">Document Register</h1>\n          <p className=\"text-muted-foreground\">Manage project documents, drawings, and procedures</p>\n        </div>\n        <Button onClick={() => handleOpenModal()} data-testid=\"button-add-document\">\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Add Document\n        </Button>\n      </div>\n\n      <div className=\"flex flex-col sm:flex-row gap-4\">\n        <div className=\"relative flex-1\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Search documents...\"\n            value={searchTerm}\n            onChange={(e) => setSearchTerm(e.target.value)}\n            className=\"pl-9\"\n            data-testid=\"input-search-documents\"\n          />\n        </div>\n        <Select value={filterDiscipline} onValueChange={setFilterDiscipline}>\n          <SelectTrigger className=\"w-[180px]\" data-testid=\"select-filter-discipline\">\n            <SelectValue placeholder=\"Discipline\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Disciplines</SelectItem>\n            {DISCIPLINES.map(d => (\n              <SelectItem key={d.value} value={d.value}>{d.label}</SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n        <Select value={filterDocType} onValueChange={setFilterDocType}>\n          <SelectTrigger className=\"w-[180px]\" data-testid=\"select-filter-doctype\">\n            <SelectValue placeholder=\"Type\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Types</SelectItem>\n            {DOC_TYPE_CATEGORIES.map(cat => (\n              <div key={cat.label}>\n                <div className=\"px-2 py-1.5 text-xs font-semibold text-muted-foreground\">{cat.label}</div>\n                {cat.types.map(t => (\n                  <SelectItem key={t.value} value={t.value}>{t.label}</SelectItem>\n                ))}\n              </div>\n            ))}\n          </SelectContent>\n        </Select>\n        <Select value={filterStatus} onValueChange={setFilterStatus}>\n          <SelectTrigger className=\"w-[180px]\" data-testid=\"select-filter-status\">\n            <SelectValue placeholder=\"Status\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Statuses</SelectItem>\n            {DOC_STATUSES.map(s => (\n              <SelectItem key={s.value} value={s.value}>{s.label}</SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      {documents.length === 0 ? (\n        <Card>\n          <CardContent className=\"p-12 text-center\">\n            <FileText className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n            <h2 className=\"text-xl font-semibold mb-2\">No Documents Yet</h2>\n            <p className=\"text-muted-foreground mb-4\">\n              Start by adding project documents, drawings, and procedures.\n            </p>\n            <Button onClick={() => handleOpenModal()} data-testid=\"button-add-first-document\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Add First Document\n            </Button>\n          </CardContent>\n        </Card>\n      ) : filteredDocs.length === 0 ? (\n        <Card>\n          <CardContent className=\"p-12 text-center\">\n            <Search className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n            <h2 className=\"text-xl font-semibold mb-2\">No Results Found</h2>\n            <p className=\"text-muted-foreground\">\n              Try adjusting your search or filters.\n            </p>\n          </CardContent>\n        </Card>\n      ) : (\n        <Card>\n          <CardContent className=\"p-0\">\n            <div className=\"overflow-x-auto\">\n              <table className=\"w-full\">\n                <thead>\n                  <tr className=\"border-b bg-muted/50\">\n                    <th className=\"text-left p-4 font-medium\">Document No.</th>\n                    <th className=\"text-left p-4 font-medium\">Title</th>\n                    <th className=\"text-left p-4 font-medium\">Discipline</th>\n                    <th className=\"text-left p-4 font-medium\">Type</th>\n                    <th className=\"text-left p-4 font-medium\">Rev</th>\n                    <th className=\"text-left p-4 font-medium\">Status</th>\n                    <th className=\"text-left p-4 font-medium\">Actions</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {filteredDocs.map((doc) => (\n                    <tr \n                      key={doc.id} \n                      className={`border-b cursor-pointer transition-colors ${\n                        selectedDocumentId === doc.id \n                          ? \"bg-primary/10 hover:bg-primary/15\" \n                          : \"hover:bg-muted/30\"\n                      }`}\n                      onClick={() => setSelectedDocumentId(doc.id)}\n                      data-testid={`document-row-${doc.id}`}\n                    >\n                      <td className=\"p-4 font-mono text-sm\">{doc.documentNumber}</td>\n                      <td className=\"p-4\">\n                        <div className=\"font-medium\">{doc.title}</div>\n                        {doc.description && (\n                          <div className=\"text-sm text-muted-foreground truncate max-w-[300px]\">\n                            {doc.description}\n                          </div>\n                        )}\n                      </td>\n                      <td className=\"p-4\">\n                        <Badge variant=\"outline\">\n                          {DISCIPLINES.find(d => d.value === doc.discipline)?.label || doc.discipline}\n                        </Badge>\n                      </td>\n                      <td className=\"p-4 text-sm\">\n                        {DOC_TYPES.find(t => t.value === doc.documentType)?.label || doc.documentType}\n                      </td>\n                      <td className=\"p-4 font-mono\">{doc.revision}</td>\n                      <td className=\"p-4\">{getStatusBadge(doc.status)}</td>\n                      <td className=\"p-4\">\n                        <DropdownMenu>\n                          <DropdownMenuTrigger asChild>\n                            <Button variant=\"ghost\" size=\"icon\" data-testid={`button-doc-actions-${doc.id}`}>\n                              <MoreHorizontal className=\"h-4 w-4\" />\n                            </Button>\n                          </DropdownMenuTrigger>\n                          <DropdownMenuContent align=\"end\">\n                            <DropdownMenuItem onClick={() => handleOpenModal(doc)}>\n                              <Pencil className=\"h-4 w-4 mr-2\" />\n                              Edit\n                            </DropdownMenuItem>\n                            <DropdownMenuItem \n                              className=\"text-destructive\"\n                              onClick={() => handleDelete(doc)}\n                            >\n                              <Trash2 className=\"h-4 w-4 mr-2\" />\n                              Delete\n                            </DropdownMenuItem>\n                          </DropdownMenuContent>\n                        </DropdownMenu>\n                      </td>\n                    </tr>\n                  ))}\n                </tbody>\n              </table>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      <Dialog open={modalOpen} onOpenChange={setModalOpen}>\n        <DialogContent className=\"max-w-lg\" data-testid=\"modal-document\">\n          <DialogHeader>\n            <DialogTitle>{editingDoc ? \"Edit Document\" : \"Add Document\"}</DialogTitle>\n          </DialogHeader>\n\n          <div className=\"space-y-4\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"doc-number\">Document Number *</Label>\n                <Input\n                  id=\"doc-number\"\n                  placeholder=\"e.g., DWG-CIV-001\"\n                  value={formData.documentNumber}\n                  onChange={(e) => setFormData({ ...formData, documentNumber: e.target.value })}\n                  data-testid=\"input-doc-number\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"revision\">Revision</Label>\n                <Input\n                  id=\"revision\"\n                  placeholder=\"e.g., A, B, 01\"\n                  value={formData.revision}\n                  onChange={(e) => setFormData({ ...formData, revision: e.target.value })}\n                  data-testid=\"input-revision\"\n                />\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"title\">Title *</Label>\n              <Input\n                id=\"title\"\n                placeholder=\"Enter document title\"\n                value={formData.title}\n                onChange={(e) => setFormData({ ...formData, title: e.target.value })}\n                data-testid=\"input-doc-title\"\n              />\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"discipline\">Discipline</Label>\n                <Select \n                  value={formData.discipline} \n                  onValueChange={(value) => setFormData({ ...formData, discipline: value })}\n                >\n                  <SelectTrigger id=\"discipline\" data-testid=\"select-doc-discipline\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {DISCIPLINES.map((d) => (\n                      <SelectItem key={d.value} value={d.value}>{d.label}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"doc-type\">Type</Label>\n                <Select \n                  value={formData.documentType} \n                  onValueChange={(value) => setFormData({ ...formData, documentType: value })}\n                >\n                  <SelectTrigger id=\"doc-type\" data-testid=\"select-doc-type\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {DOC_TYPES.map((t) => (\n                      <SelectItem key={t.value} value={t.value}>{t.label}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"status\">Status</Label>\n              <Select \n                value={formData.status} \n                onValueChange={(value) => setFormData({ ...formData, status: value })}\n              >\n                <SelectTrigger id=\"status\" data-testid=\"select-doc-status\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {DOC_STATUSES.map((s) => (\n                    <SelectItem key={s.value} value={s.value}>{s.label}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"description\">Description</Label>\n              <Textarea\n                id=\"description\"\n                placeholder=\"Enter document description\"\n                rows={3}\n                value={formData.description}\n                onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                data-testid=\"textarea-doc-description\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>File Attachment</Label>\n              <input\n                ref={fileInputRef}\n                type=\"file\"\n                onChange={handleFileSelect}\n                className=\"hidden\"\n                data-testid=\"input-file-upload\"\n              />\n              {formData.file ? (\n                <div className=\"flex items-center gap-3 p-3 rounded-md border bg-muted/30\">\n                  <File className=\"h-5 w-5 text-muted-foreground flex-shrink-0\" />\n                  <div className=\"flex-1 min-w-0\">\n                    <p className=\"text-sm truncate\">{formData.file.name}</p>\n                    <p className=\"text-xs text-muted-foreground\">{formatFileSize(formData.file.size)}</p>\n                  </div>\n                  <Button\n                    type=\"button\"\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    onClick={removeSelectedFile}\n                    data-testid=\"button-remove-file\"\n                  >\n                    <X className=\"h-4 w-4\" />\n                  </Button>\n                </div>\n              ) : formData.filePath ? (\n                <div className=\"flex items-center gap-3 p-3 rounded-md border bg-muted/30\">\n                  <File className=\"h-5 w-5 text-muted-foreground flex-shrink-0\" />\n                  <div className=\"flex-1 min-w-0\">\n                    <p className=\"text-sm truncate\">Existing file attached</p>\n                    {formData.fileSize && (\n                      <p className=\"text-xs text-muted-foreground\">{formatFileSize(formData.fileSize)}</p>\n                    )}\n                  </div>\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => fileInputRef.current?.click()}\n                    data-testid=\"button-replace-file\"\n                  >\n                    Replace\n                  </Button>\n                </div>\n              ) : (\n                <div \n                  className=\"flex flex-col items-center justify-center p-6 border-2 border-dashed rounded-md cursor-pointer hover:border-primary/50 transition-colors\"\n                  onClick={() => fileInputRef.current?.click()}\n                  data-testid=\"dropzone-file\"\n                >\n                  <Upload className=\"h-8 w-8 text-muted-foreground mb-2\" />\n                  <p className=\"text-sm text-muted-foreground\">Click to upload a file</p>\n                  <p className=\"text-xs text-muted-foreground mt-1\">PDF, DOC, XLS, DWG up to 50MB</p>\n                </div>\n              )}\n            </div>\n          </div>\n\n          <DialogFooter className=\"gap-2\">\n            <Button variant=\"outline\" onClick={handleCloseModal} disabled={isLoading2} data-testid=\"button-cancel\">\n              Cancel\n            </Button>\n            <Button onClick={handleSave} disabled={isLoading2} data-testid=\"button-save-document\">\n              {isLoading2 && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n              {editingDoc ? \"Update\" : \"Create\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n\nexport default function DocumentsPage() {\n  return (\n    <DocumentProvider>\n      <DocumentsPageContent />\n    </DocumentProvider>\n  );\n}\n","size_bytes":28786},"client/src/pages/ResourcesPage.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { \n  Plus, AlertTriangle, Loader2, User, Wrench, Package, \n  DollarSign, Percent, MoreHorizontal, Pencil, Trash2, Eye,\n  BarChart3, List\n} from \"lucide-react\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { ResourceDetailsModal } from \"@/components/modals/ResourceDetailsModal\";\nimport { EditResourceModal } from \"@/components/modals/EditResourceModal\";\nimport { ResourceUtilizationChart } from \"@/components/ResourceUtilizationChart\";\nimport type { Resource } from \"@shared/schema\";\n\nconst RESOURCE_TYPES = [\n  { value: \"human\", label: \"Human Resource\", icon: User },\n  { value: \"equipment\", label: \"Equipment\", icon: Wrench },\n  { value: \"material\", label: \"Material\", icon: Package },\n];\n\nconst DISCIPLINES = [\n  { value: \"general\", label: \"General\" },\n  { value: \"civil\", label: \"Civil\" },\n  { value: \"structural\", label: \"Structural\" },\n  { value: \"mechanical\", label: \"Mechanical\" },\n  { value: \"piping\", label: \"Piping\" },\n  { value: \"electrical\", label: \"Electrical\" },\n  { value: \"instrumentation\", label: \"Instrumentation\" },\n  { value: \"process\", label: \"Process\" },\n  { value: \"hse\", label: \"HSE\" },\n];\n\n\nexport default function ResourcesPage() {\n  const { selectedProjectId } = useProject();\n  const { toast } = useToast();\n  const [editModalOpen, setEditModalOpen] = useState(false);\n  const [detailsModalOpen, setDetailsModalOpen] = useState(false);\n  const [selectedResource, setSelectedResource] = useState<Resource | null>(null);\n\n  const { data: resources = [], isLoading } = useQuery<Resource[]>({\n    queryKey: [`/api/projects/${selectedProjectId}/resources`],\n    enabled: !!selectedProjectId,\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return await apiRequest(\"DELETE\", `/api/resources/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/projects/${selectedProjectId}/resources`] });\n      toast({\n        title: \"Success\",\n        description: \"Resource deleted successfully\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to delete resource\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleOpenCreate = () => {\n    setSelectedResource(null);\n    setEditModalOpen(true);\n  };\n\n  const handleOpenEdit = (resource: Resource) => {\n    setSelectedResource(resource);\n    setEditModalOpen(true);\n  };\n\n  const handleOpenDetails = (resource: Resource) => {\n    setSelectedResource(resource);\n    setDetailsModalOpen(true);\n  };\n\n  const handleDelete = (resource: Resource) => {\n    if (confirm(`Are you sure you want to delete \"${resource.name}\"?`)) {\n      deleteMutation.mutate(resource.id);\n    }\n  };\n\n  const getTypeIcon = (type: string) => {\n    const typeConfig = RESOURCE_TYPES.find(t => t.value === type);\n    if (!typeConfig) return User;\n    return typeConfig.icon;\n  };\n\n  const getTypeLabel = (type: string) => {\n    const typeConfig = RESOURCE_TYPES.find(t => t.value === type);\n    return typeConfig?.label || type;\n  };\n\n  const getDisciplineLabel = (discipline: string | null | undefined) => {\n    if (!discipline) return \"General\";\n    const disciplineConfig = DISCIPLINES.find(d => d.value === discipline);\n    return disciplineConfig?.label || discipline;\n  };\n\n  const resourcesByType = RESOURCE_TYPES.map(type => ({\n    ...type,\n    resources: resources.filter(r => r.type === type.value),\n  }));\n\n  const totalResources = resources.length;\n  const avgAvailability = resources.length > 0 \n    ? Math.round(resources.reduce((sum, r) => sum + r.availability, 0) / resources.length)\n    : 0;\n\n  if (!selectedProjectId) {\n    return (\n      <div className=\"p-6\">\n        <Alert>\n          <AlertTriangle className=\"h-4 w-4\" />\n          <AlertDescription>\n            Please select a project from the dropdown above to view resources.\n          </AlertDescription>\n        </Alert>\n      </div>\n    );\n  }\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-semibold\" data-testid=\"page-title-resources\">Resources</h1>\n          <p className=\"text-muted-foreground\">Manage project resources and assignments</p>\n        </div>\n        <Button onClick={handleOpenCreate} data-testid=\"button-add-resource\">\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Add Resource\n        </Button>\n      </div>\n\n      <Tabs defaultValue=\"list\" className=\"space-y-4\">\n        <TabsList>\n          <TabsTrigger value=\"list\" data-testid=\"tab-resources-list\">\n            <List className=\"h-4 w-4 mr-2\" />\n            List View\n          </TabsTrigger>\n          <TabsTrigger value=\"utilization\" data-testid=\"tab-resources-utilization\">\n            <BarChart3 className=\"h-4 w-4 mr-2\" />\n            Utilization\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"list\" className=\"space-y-6\">\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center\">\n                <User className=\"h-5 w-5 text-primary\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold\">{totalResources}</p>\n                <p className=\"text-sm text-muted-foreground\">Total Resources</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"h-10 w-10 rounded-full bg-blue-500/10 flex items-center justify-center\">\n                <User className=\"h-5 w-5 text-blue-500\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold\">\n                  {resources.filter(r => r.type === \"human\").length}\n                </p>\n                <p className=\"text-sm text-muted-foreground\">Human Resources</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"h-10 w-10 rounded-full bg-amber-500/10 flex items-center justify-center\">\n                <Wrench className=\"h-5 w-5 text-amber-500\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold\">\n                  {resources.filter(r => r.type === \"equipment\").length}\n                </p>\n                <p className=\"text-sm text-muted-foreground\">Equipment</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"h-10 w-10 rounded-full bg-green-500/10 flex items-center justify-center\">\n                <Percent className=\"h-5 w-5 text-green-500\" />\n              </div>\n              <div>\n                <p className=\"text-2xl font-bold\">{avgAvailability}%</p>\n                <p className=\"text-sm text-muted-foreground\">Avg Availability</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {resources.length === 0 ? (\n        <Card>\n          <CardContent className=\"p-12 text-center\">\n            <User className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n            <h2 className=\"text-xl font-semibold mb-2\">No Resources Yet</h2>\n            <p className=\"text-muted-foreground mb-4\">\n              Add resources like team members, equipment, or materials to manage your project.\n            </p>\n            <Button onClick={handleOpenCreate} data-testid=\"button-add-first-resource\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Add First Resource\n            </Button>\n          </CardContent>\n        </Card>\n      ) : (\n        <div className=\"space-y-6\">\n          {resourcesByType.filter(g => g.resources.length > 0).map((group) => {\n            const Icon = group.icon;\n            return (\n              <Card key={group.value}>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-lg flex items-center gap-2\">\n                    <Icon className=\"h-5 w-5\" />\n                    {group.label} ({group.resources.length})\n                  </CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-3\">\n                    {group.resources.map((resource) => {\n                      const TypeIcon = getTypeIcon(resource.type);\n                      return (\n                        <div \n                          key={resource.id}\n                          className=\"flex items-center justify-between p-4 rounded-lg border hover-elevate\"\n                          data-testid={`resource-row-${resource.id}`}\n                        >\n                          <div className=\"flex items-center gap-4\">\n                            <div className=\"h-10 w-10 rounded-full bg-muted flex items-center justify-center\">\n                              <TypeIcon className=\"h-5 w-5\" />\n                            </div>\n                            <div>\n                              <div className=\"flex items-center gap-2\">\n                                <p className=\"font-medium\">{resource.name}</p>\n                                <Badge variant=\"secondary\" className=\"text-xs\">\n                                  {getDisciplineLabel(resource.discipline)}\n                                </Badge>\n                              </div>\n                              <p className=\"text-sm text-muted-foreground\">{getTypeLabel(resource.type)}</p>\n                            </div>\n                          </div>\n\n                          <div className=\"flex items-center gap-6\">\n                            <div className=\"text-center\">\n                              <div className=\"flex items-center gap-2\">\n                                <Progress value={resource.availability} className=\"w-20 h-2\" />\n                                <span className=\"text-sm font-mono\">{resource.availability}%</span>\n                              </div>\n                              <p className=\"text-xs text-muted-foreground\">Availability</p>\n                            </div>\n\n                            {(resource.rate || resource.costPerHour) && (\n                              <div className=\"text-right\">\n                                <p className=\"font-mono text-sm flex items-center gap-1\">\n                                  <DollarSign className=\"h-3 w-3\" />\n                                  {parseFloat(resource.rate || resource.costPerHour || \"0\").toFixed(2)}\n                                  {resource.rateType === \"per-hour\" && \"/hr\"}\n                                  {resource.rateType === \"per-use\" && \"/use\"}\n                                  {resource.rateType === \"per-unit\" && `/${resource.unitType || \"unit\"}`}\n                                  {!resource.rateType && \"/hr\"}\n                                </p>\n                                <p className=\"text-xs text-muted-foreground\">{resource.currency}</p>\n                              </div>\n                            )}\n\n                            <DropdownMenu>\n                              <DropdownMenuTrigger asChild>\n                                <Button variant=\"ghost\" size=\"icon\" data-testid={`button-resource-actions-${resource.id}`}>\n                                  <MoreHorizontal className=\"h-4 w-4\" />\n                                </Button>\n                              </DropdownMenuTrigger>\n                              <DropdownMenuContent align=\"end\">\n                                <DropdownMenuItem onClick={() => handleOpenDetails(resource)}>\n                                  <Eye className=\"h-4 w-4 mr-2\" />\n                                  View Details\n                                </DropdownMenuItem>\n                                <DropdownMenuItem onClick={() => handleOpenEdit(resource)}>\n                                  <Pencil className=\"h-4 w-4 mr-2\" />\n                                  Edit\n                                </DropdownMenuItem>\n                                <DropdownMenuSeparator />\n                                <DropdownMenuItem \n                                  className=\"text-destructive\"\n                                  onClick={() => handleDelete(resource)}\n                                >\n                                  <Trash2 className=\"h-4 w-4 mr-2\" />\n                                  Delete\n                                </DropdownMenuItem>\n                              </DropdownMenuContent>\n                            </DropdownMenu>\n                          </div>\n                        </div>\n                      );\n                    })}\n                  </div>\n                </CardContent>\n              </Card>\n            );\n          })}\n        </div>\n      )}\n        </TabsContent>\n\n        <TabsContent value=\"utilization\">\n          <ResourceUtilizationChart />\n        </TabsContent>\n      </Tabs>\n\n      <ResourceDetailsModal\n        resource={selectedResource}\n        open={detailsModalOpen}\n        onOpenChange={setDetailsModalOpen}\n      />\n\n      <EditResourceModal\n        resource={selectedResource}\n        open={editModalOpen}\n        onOpenChange={setEditModalOpen}\n      />\n    </div>\n  );\n}\n","size_bytes":14560},"client/src/components/epc/DisciplineProgress.tsx":{"content":"import { useMemo } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  BarChart, \n  Bar, \n  XAxis, \n  YAxis, \n  CartesianGrid, \n  Tooltip, \n  ResponsiveContainer,\n  Cell\n} from \"recharts\";\nimport type { Task } from \"@shared/schema\";\n\ninterface DisciplineProgressProps {\n  tasks: Task[];\n  showChart?: boolean;\n}\n\nconst DISCIPLINE_COLORS: Record<string, string> = {\n  civil: \"#3b82f6\",       // blue\n  structural: \"#6366f1\",   // indigo\n  mechanical: \"#8b5cf6\",   // violet\n  electrical: \"#f59e0b\",   // amber\n  piping: \"#10b981\",       // emerald\n  instrumentation: \"#ef4444\", // red\n  process: \"#06b6d4\",      // cyan\n  hvac: \"#ec4899\",         // pink\n  architectural: \"#84cc16\", // lime\n  general: \"#6b7280\",      // gray\n};\n\nconst DISCIPLINE_LABELS: Record<string, string> = {\n  civil: \"Civil\",\n  structural: \"Structural\",\n  mechanical: \"Mechanical\",\n  electrical: \"Electrical\",\n  piping: \"Piping\",\n  instrumentation: \"Instrumentation\",\n  process: \"Process\",\n  hvac: \"HVAC\",\n  architectural: \"Architectural\",\n  general: \"General\",\n};\n\ninterface DisciplineData {\n  discipline: string;\n  label: string;\n  taskCount: number;\n  completedTasks: number;\n  progress: number;\n  color: string;\n}\n\nfunction calculateDisciplineProgress(tasks: Task[]): DisciplineData[] {\n  if (tasks.length === 0) {\n    return [];\n  }\n\n  const disciplineMap = new Map<string, { total: number; completed: number; progressSum: number }>();\n\n  tasks.forEach(task => {\n    const discipline = task.discipline || \"general\";\n    const current = disciplineMap.get(discipline) || { total: 0, completed: 0, progressSum: 0 };\n    \n    current.total++;\n    if (task.status === \"completed\") current.completed++;\n    \n    const progress = typeof task.progress === 'number' && !isNaN(task.progress) ? task.progress : 0;\n    current.progressSum += progress;\n    \n    disciplineMap.set(discipline, current);\n  });\n\n  return Array.from(disciplineMap.entries())\n    .map(([discipline, data]) => {\n      const avgProgress = data.total > 0 ? data.progressSum / data.total : 0;\n      return {\n        discipline,\n        label: DISCIPLINE_LABELS[discipline] || discipline,\n        taskCount: data.total,\n        completedTasks: data.completed,\n        progress: isNaN(avgProgress) ? 0 : Math.round(avgProgress),\n        color: DISCIPLINE_COLORS[discipline] || \"#6b7280\",\n      };\n    })\n    .sort((a, b) => b.taskCount - a.taskCount);\n}\n\nexport function DisciplineProgress({ tasks, showChart = true }: DisciplineProgressProps) {\n  const data = useMemo(() => calculateDisciplineProgress(tasks), [tasks]);\n\n  if (data.length === 0) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-lg\">Discipline Progress</CardTitle>\n        </CardHeader>\n        <CardContent className=\"h-[200px] flex items-center justify-center\">\n          <p className=\"text-muted-foreground\">\n            No tasks with disciplines assigned\n          </p>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const totalTasks = data.reduce((sum, d) => sum + d.taskCount, 0);\n  const overallProgress = Math.round(data.reduce((sum, d) => sum + d.progress * d.taskCount, 0) / totalTasks);\n\n  return (\n    <Card>\n      <CardHeader className=\"pb-2\">\n        <div className=\"flex items-center justify-between flex-wrap gap-2\">\n          <CardTitle className=\"text-lg\">Discipline Progress</CardTitle>\n          <Badge variant=\"secondary\">{overallProgress}% Overall</Badge>\n        </div>\n      </CardHeader>\n      <CardContent>\n        {showChart && data.length > 1 && (\n          <div className=\"h-[180px] mb-4\">\n            <ResponsiveContainer width=\"100%\" height=\"100%\">\n              <BarChart data={data} layout=\"vertical\" margin={{ top: 5, right: 20, left: 60, bottom: 5 }}>\n                <CartesianGrid strokeDasharray=\"3 3\" horizontal={true} vertical={false} className=\"stroke-muted\" />\n                <XAxis type=\"number\" domain={[0, 100]} tickFormatter={(v) => `${v}%`} />\n                <YAxis type=\"category\" dataKey=\"label\" tick={{ fontSize: 12 }} width={55} />\n                <Tooltip \n                  contentStyle={{ \n                    backgroundColor: 'hsl(var(--card))',\n                    border: '1px solid hsl(var(--border))',\n                    borderRadius: '6px'\n                  }}\n                  formatter={(value: number, name: string) => [`${value}%`, 'Progress']}\n                />\n                <Bar dataKey=\"progress\" radius={[0, 4, 4, 0]}>\n                  {data.map((entry, index) => (\n                    <Cell key={`cell-${index}`} fill={entry.color} />\n                  ))}\n                </Bar>\n              </BarChart>\n            </ResponsiveContainer>\n          </div>\n        )}\n\n        <div className=\"space-y-3\">\n          {data.slice(0, 6).map((item) => (\n            <div key={item.discipline}>\n              <div className=\"flex items-center justify-between mb-1 gap-2\">\n                <div className=\"flex items-center gap-2\">\n                  <div \n                    className=\"w-3 h-3 rounded-full\" \n                    style={{ backgroundColor: item.color }}\n                  />\n                  <span className=\"text-sm font-medium\">{item.label}</span>\n                  <Badge variant=\"outline\" className=\"text-xs\">\n                    {item.taskCount} tasks\n                  </Badge>\n                </div>\n                <span className=\"text-sm font-semibold\">{item.progress}%</span>\n              </div>\n              <Progress value={item.progress} className=\"h-2\" />\n            </div>\n          ))}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":5749},"client/src/components/epc/index.ts":{"content":"export { SCurveChart } from \"./SCurveChart\";\nexport { PerformanceGauges } from \"./PerformanceGauges\";\nexport { DisciplineProgress } from \"./DisciplineProgress\";\nexport { RiskExposureSummary } from \"./RiskExposureSummary\";\n","size_bytes":222},"client/src/components/epc/PerformanceGauges.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { cn } from \"@/lib/utils\";\nimport type { Task, CostItem } from \"@shared/schema\";\n\ninterface PerformanceGaugesProps {\n  tasks: Task[];\n  costItems: CostItem[];\n  className?: string;\n}\n\ninterface EVAMetrics {\n  bcwp: number; // Budgeted Cost of Work Performed (Earned Value)\n  bcws: number; // Budgeted Cost of Work Scheduled (Planned Value)\n  acwp: number; // Actual Cost of Work Performed\n  bac: number;  // Budget at Completion\n  spi: number;  // Schedule Performance Index\n  cpi: number;  // Cost Performance Index\n  sv: number;   // Schedule Variance\n  cv: number;   // Cost Variance\n  eac: number;  // Estimate at Completion\n  etc: number;  // Estimate to Complete\n  vac: number;  // Variance at Completion\n}\n\ninterface EVADataQuality {\n  hasValidData: boolean;\n  hasCostData: boolean;\n  hasBaselineDates: boolean;\n  message: string;\n}\n\nfunction assessDataQuality(tasks: Task[], costItems: CostItem[]): EVADataQuality {\n  const hasCostData = costItems.length > 0 && \n    costItems.some(c => Number(c.budgeted) > 0 || Number(c.actual) > 0);\n  \n  const hasBaselineDates = tasks.some(t => t.baselineStart && t.baselineFinish);\n  const hasBaselineCosts = tasks.some(t => {\n    const cost = Number(t.baselineCost);\n    return !isNaN(cost) && cost > 0;\n  });\n  \n  const hasValidData = hasCostData || hasBaselineCosts;\n  \n  let message = \"\";\n  if (!hasValidData) {\n    message = \"Add baseline costs to tasks or cost items to enable EVA calculations\";\n  } else if (!hasBaselineDates) {\n    message = \"Add baseline dates to tasks for more accurate schedule performance\";\n  }\n  \n  return { hasValidData, hasCostData, hasBaselineDates, message };\n}\n\nfunction calculateEVAMetrics(tasks: Task[], costItems: CostItem[]): EVAMetrics {\n  const costItemBac = costItems.reduce((sum, c) => {\n    const val = Number(c.budgeted);\n    return sum + (isNaN(val) ? 0 : val);\n  }, 0);\n  \n  const taskBasedBac = tasks.reduce((sum, t) => {\n    const val = Number(t.baselineCost);\n    return sum + (isNaN(val) ? 0 : val);\n  }, 0);\n  \n  const bac = costItemBac > 0 ? costItemBac : taskBasedBac;\n  \n  const costItemAcwp = costItems.reduce((sum, c) => {\n    const val = Number(c.actual);\n    return sum + (isNaN(val) ? 0 : val);\n  }, 0);\n  \n  const taskActualCost = tasks.reduce((sum, t) => {\n    const val = Number(t.actualCost);\n    return sum + (isNaN(val) ? 0 : val);\n  }, 0);\n  \n  const acwp = costItemAcwp > 0 ? costItemAcwp : taskActualCost;\n\n  let bcws = 0;\n  let bcwp = 0;\n\n  const today = new Date();\n  const taskCount = tasks.length || 1;\n  const perTaskBacShare = bac / taskCount;\n\n  tasks.forEach(task => {\n    const rawBaseline = Number(task.baselineCost);\n    const taskBaseline = isNaN(rawBaseline) || rawBaseline === 0 ? perTaskBacShare : rawBaseline;\n    \n    const rawEV = Number(task.earnedValue);\n    const progress = typeof task.progress === 'number' ? task.progress : 0;\n    const taskEV = isNaN(rawEV) || rawEV === 0 ? (taskBaseline * progress / 100) : rawEV;\n    \n    const taskStart = task.baselineStart ? new Date(task.baselineStart) : \n                     (task.startDate ? new Date(task.startDate) : null);\n    const taskEnd = task.baselineFinish ? new Date(task.baselineFinish) : \n                   (task.endDate ? new Date(task.endDate) : null);\n\n    if (taskStart && taskEnd && !isNaN(taskStart.getTime()) && !isNaN(taskEnd.getTime())) {\n      const duration = taskEnd.getTime() - taskStart.getTime();\n      if (duration > 0) {\n        const elapsed = Math.max(0, Math.min(duration, today.getTime() - taskStart.getTime()));\n        const plannedFraction = elapsed / duration;\n        bcws += taskBaseline * plannedFraction;\n      }\n    }\n\n    bcwp += taskEV;\n  });\n\n  if (bcws === 0 && bac > 0 && tasks.length > 0) {\n    const totalProgress = tasks.reduce((sum, t) => sum + (typeof t.progress === 'number' ? t.progress : 0), 0);\n    const overallProgress = totalProgress / tasks.length;\n    bcws = bac * (overallProgress / 100);\n  }\n\n  const spi = bcws > 0 ? bcwp / bcws : (bcwp > 0 ? 1 : (bac > 0 ? 1 : 0));\n  const cpi = acwp > 0 ? bcwp / acwp : (bcwp > 0 ? 1 : (bac > 0 ? 1 : 0));\n  const sv = bcwp - bcws;\n  const cv = bcwp - acwp;\n  const eac = cpi > 0 ? bac / cpi : bac;\n  const etc = Math.max(0, eac - acwp);\n  const vac = bac - eac;\n\n  return {\n    bcwp: isNaN(bcwp) ? 0 : bcwp,\n    bcws: isNaN(bcws) ? 0 : bcws,\n    acwp: isNaN(acwp) ? 0 : acwp,\n    bac: isNaN(bac) ? 0 : bac,\n    spi: isNaN(spi) ? 0 : Math.round(spi * 100) / 100,\n    cpi: isNaN(cpi) ? 0 : Math.round(cpi * 100) / 100,\n    sv: isNaN(sv) ? 0 : Math.round(sv),\n    cv: isNaN(cv) ? 0 : Math.round(cv),\n    eac: isNaN(eac) ? 0 : Math.round(eac),\n    etc: isNaN(etc) ? 0 : Math.round(etc),\n    vac: isNaN(vac) ? 0 : Math.round(vac),\n  };\n}\n\nfunction getPerformanceColor(value: number): { bg: string; text: string; label: string } {\n  if (value >= 0.95) {\n    return { bg: \"bg-emerald-500\", text: \"text-emerald-500\", label: \"On Track\" };\n  }\n  if (value >= 0.85) {\n    return { bg: \"bg-amber-500\", text: \"text-amber-500\", label: \"At Risk\" };\n  }\n  return { bg: \"bg-red-500\", text: \"text-red-500\", label: \"Critical\" };\n}\n\nfunction GaugeIndicator({ value, label, description }: { value: number; label: string; description: string }) {\n  const color = getPerformanceColor(value);\n  const clampedValue = Math.min(1.5, Math.max(0.5, value));\n  const normalizedValue = (clampedValue - 0.5) / 1.0;\n  const angle = -90 + (normalizedValue * 180);\n  \n  const size = 140;\n  const strokeWidth = 14;\n  const radius = (size - strokeWidth) / 2 - 4;\n  const center = size / 2;\n  \n  const createArc = (startAngle: number, endAngle: number) => {\n    const startRad = (startAngle - 90) * (Math.PI / 180);\n    const endRad = (endAngle - 90) * (Math.PI / 180);\n    const x1 = center + radius * Math.cos(startRad);\n    const y1 = center + radius * Math.sin(startRad);\n    const x2 = center + radius * Math.cos(endRad);\n    const y2 = center + radius * Math.sin(endRad);\n    const largeArc = endAngle - startAngle > 180 ? 1 : 0;\n    return `M ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2}`;\n  };\n\n  const needleLength = radius - 10;\n  const needleAngle = (angle) * (Math.PI / 180);\n  const needleX = center + needleLength * Math.cos(needleAngle);\n  const needleY = center + needleLength * Math.sin(needleAngle);\n\n  return (\n    <div className=\"flex flex-col items-center\">\n      <div className=\"relative\" style={{ width: size, height: size / 2 + 8 }}>\n        <svg width={size} height={size / 2 + 8} viewBox={`0 0 ${size} ${size / 2 + 8}`}>\n          <path\n            d={createArc(-90, -27)}\n            fill=\"none\"\n            stroke=\"#ef4444\"\n            strokeWidth={strokeWidth}\n            strokeLinecap=\"round\"\n          />\n          <path\n            d={createArc(-27, 9)}\n            fill=\"none\"\n            stroke=\"#f59e0b\"\n            strokeWidth={strokeWidth}\n            strokeLinecap=\"butt\"\n          />\n          <path\n            d={createArc(9, 90)}\n            fill=\"none\"\n            stroke=\"#10b981\"\n            strokeWidth={strokeWidth}\n            strokeLinecap=\"round\"\n          />\n          \n          <line\n            x1={center}\n            y1={center}\n            x2={needleX}\n            y2={needleY}\n            stroke=\"currentColor\"\n            strokeWidth={3}\n            strokeLinecap=\"round\"\n            className=\"text-foreground transition-all duration-500\"\n          />\n          <circle cx={center} cy={center} r={8} className=\"fill-foreground\" />\n          <circle cx={center} cy={center} r={4} className=\"fill-background\" />\n        </svg>\n      </div>\n      \n      <div className=\"text-center mt-1\">\n        <div className={cn(\"text-3xl font-bold tabular-nums\", color.text)}>{value.toFixed(2)}</div>\n        <div className=\"text-base font-semibold mt-1\">{label}</div>\n        <div className=\"text-sm text-muted-foreground\">{description}</div>\n        <div className={cn(\n          \"inline-flex items-center gap-1.5 mt-2 px-3 py-1 rounded-full text-xs font-medium\",\n          color.bg, \"text-white\"\n        )}>\n          <span className=\"w-1.5 h-1.5 rounded-full bg-white/80\" />\n          {color.label}\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction formatCurrency(value: number): string {\n  if (Math.abs(value) >= 1000000) {\n    return `$${(value / 1000000).toFixed(1)}M`;\n  }\n  if (Math.abs(value) >= 1000) {\n    return `$${(value / 1000).toFixed(0)}K`;\n  }\n  return `$${value.toFixed(0)}`;\n}\n\nexport function PerformanceGauges({ tasks, costItems, className }: PerformanceGaugesProps) {\n  const metrics = calculateEVAMetrics(tasks, costItems);\n  const dataQuality = assessDataQuality(tasks, costItems);\n\n  if (!dataQuality.hasValidData && tasks.length === 0 && costItems.length === 0) {\n    return (\n      <Card className={className}>\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-lg\">Earned Value Analysis (EVA)</CardTitle>\n        </CardHeader>\n        <CardContent className=\"h-[300px] flex items-center justify-center\">\n          <p className=\"text-muted-foreground text-center\">\n            Add tasks and cost items to enable EVA calculations\n          </p>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card className={className}>\n      <CardHeader className=\"pb-4\">\n        <CardTitle className=\"text-lg\">Earned Value Analysis (EVA)</CardTitle>\n        <p className=\"text-sm text-muted-foreground\">Schedule & Cost Performance Indicators</p>\n      </CardHeader>\n      <CardContent className=\"pt-2\">\n        <div className=\"grid grid-cols-2 gap-8 mb-6 mt-2\">\n          <GaugeIndicator \n            value={metrics.spi} \n            label=\"SPI\" \n            description=\"Schedule Performance\"\n          />\n          <GaugeIndicator \n            value={metrics.cpi} \n            label=\"CPI\" \n            description=\"Cost Performance\"\n          />\n        </div>\n\n        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t\">\n          <div className=\"text-center\">\n            <div className=\"text-lg font-semibold\">{formatCurrency(metrics.bcwp)}</div>\n            <div className=\"text-xs text-muted-foreground\">Earned Value (EV)</div>\n          </div>\n          <div className=\"text-center\">\n            <div className=\"text-lg font-semibold\">{formatCurrency(metrics.bcws)}</div>\n            <div className=\"text-xs text-muted-foreground\">Planned Value (PV)</div>\n          </div>\n          <div className=\"text-center\">\n            <div className=\"text-lg font-semibold\">{formatCurrency(metrics.acwp)}</div>\n            <div className=\"text-xs text-muted-foreground\">Actual Cost (AC)</div>\n          </div>\n          <div className=\"text-center\">\n            <div className=\"text-lg font-semibold\">{formatCurrency(metrics.bac)}</div>\n            <div className=\"text-xs text-muted-foreground\">Budget (BAC)</div>\n          </div>\n        </div>\n\n        <div className=\"grid grid-cols-2 md:grid-cols-3 gap-4 pt-4 border-t mt-4\">\n          <div className=\"text-center\">\n            <div className={cn(\"text-lg font-semibold\", metrics.sv >= 0 ? \"text-emerald-500\" : \"text-red-500\")}>\n              {metrics.sv >= 0 ? \"+\" : \"\"}{formatCurrency(metrics.sv)}\n            </div>\n            <div className=\"text-xs text-muted-foreground\">Schedule Variance</div>\n          </div>\n          <div className=\"text-center\">\n            <div className={cn(\"text-lg font-semibold\", metrics.cv >= 0 ? \"text-emerald-500\" : \"text-red-500\")}>\n              {metrics.cv >= 0 ? \"+\" : \"\"}{formatCurrency(metrics.cv)}\n            </div>\n            <div className=\"text-xs text-muted-foreground\">Cost Variance</div>\n          </div>\n          <div className=\"text-center\">\n            <div className=\"text-lg font-semibold\">{formatCurrency(metrics.eac)}</div>\n            <div className=\"text-xs text-muted-foreground\">Est. at Completion</div>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":11971},"client/src/components/epc/SCurveChart.tsx":{"content":"import { useMemo } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { \n  LineChart, \n  Line, \n  XAxis, \n  YAxis, \n  CartesianGrid, \n  Tooltip, \n  Legend, \n  ResponsiveContainer,\n  ReferenceLine\n} from \"recharts\";\nimport { format, startOfMonth, eachMonthOfInterval, differenceInDays, addDays, isBefore, isAfter } from \"date-fns\";\nimport type { Task } from \"@shared/schema\";\n\ninterface SCurveChartProps {\n  tasks: Task[];\n  projectStartDate: Date;\n  projectEndDate: Date;\n}\n\ninterface SCurveDataPoint {\n  date: string;\n  month: string;\n  planned: number;\n  actual: number;\n  earned: number;\n}\n\nfunction calculateSCurveData(\n  tasks: Task[],\n  projectStart: Date,\n  projectEnd: Date\n): SCurveDataPoint[] {\n  if (tasks.length === 0) return [];\n\n  if (!projectStart || !projectEnd || isNaN(projectStart.getTime()) || isNaN(projectEnd.getTime())) {\n    return [];\n  }\n\n  if (differenceInDays(projectEnd, projectStart) <= 0) {\n    return [];\n  }\n\n  const months = eachMonthOfInterval({\n    start: startOfMonth(projectStart),\n    end: startOfMonth(projectEnd)\n  });\n\n  const tasksWithDates = tasks.filter(task => {\n    const start = task.baselineStart || task.startDate;\n    const end = task.baselineFinish || task.endDate;\n    return start && end;\n  });\n\n  if (tasksWithDates.length === 0) {\n    return months.map(monthDate => ({\n      date: format(monthDate, 'yyyy-MM-dd'),\n      month: format(monthDate, 'MMM yyyy'),\n      planned: 0,\n      actual: 0,\n      earned: 0\n    }));\n  }\n\n  const totalWeight = tasksWithDates.reduce((sum, t) => {\n    const w = Number(t.weightFactor);\n    return sum + (isNaN(w) || w <= 0 ? 1 : w);\n  }, 0);\n\n  const today = new Date();\n\n  return months.map(monthDate => {\n    const monthEnd = addDays(startOfMonth(addDays(monthDate, 32)), -1);\n    \n    let plannedProgress = 0;\n    let actualProgress = 0;\n    let earnedProgress = 0;\n\n    tasksWithDates.forEach(task => {\n      const rawWeight = Number(task.weightFactor);\n      const weight = (isNaN(rawWeight) || rawWeight <= 0 ? 1 : rawWeight) / totalWeight;\n      \n      const taskStart = task.baselineStart ? new Date(task.baselineStart) : \n                       (task.startDate ? new Date(task.startDate) : null);\n      const taskEnd = task.baselineFinish ? new Date(task.baselineFinish) : \n                     (task.endDate ? new Date(task.endDate) : null);\n\n      if (taskStart && taskEnd && !isNaN(taskStart.getTime()) && !isNaN(taskEnd.getTime())) {\n        const taskDuration = differenceInDays(taskEnd, taskStart) || 1;\n        \n        if (isBefore(monthEnd, taskStart)) {\n          // Task hasn't started by this month - planned is 0\n        } else if (isAfter(monthEnd, taskEnd)) {\n          plannedProgress += weight * 100;\n        } else {\n          const daysElapsed = differenceInDays(monthEnd, taskStart);\n          const fraction = Math.min(1, Math.max(0, daysElapsed / taskDuration));\n          plannedProgress += weight * 100 * fraction;\n        }\n\n        const progress = typeof task.progress === 'number' ? task.progress : 0;\n        \n        if (isBefore(monthEnd, today) || format(monthEnd, 'yyyy-MM') === format(today, 'yyyy-MM')) {\n          actualProgress += weight * 100 * (progress / 100);\n        }\n\n        const baselineCost = Number(task.baselineCost) || 0;\n        const earnedValue = Number(task.earnedValue) || 0;\n        \n        if (isBefore(monthEnd, today) || format(monthEnd, 'yyyy-MM') === format(today, 'yyyy-MM')) {\n          if (earnedValue > 0 && baselineCost > 0) {\n            earnedProgress += weight * 100 * (earnedValue / baselineCost);\n          } else {\n            earnedProgress += weight * 100 * (progress / 100);\n          }\n        }\n      }\n    });\n\n    return {\n      date: format(monthDate, 'yyyy-MM-dd'),\n      month: format(monthDate, 'MMM yyyy'),\n      planned: Math.round(plannedProgress * 10) / 10,\n      actual: Math.round(actualProgress * 10) / 10,\n      earned: Math.round(earnedProgress * 10) / 10\n    };\n  });\n}\n\nexport function SCurveChart({ tasks, projectStartDate, projectEndDate }: SCurveChartProps) {\n  const data = useMemo(() => \n    calculateSCurveData(tasks, projectStartDate, projectEndDate),\n    [tasks, projectStartDate, projectEndDate]\n  );\n\n  const todayMonth = format(new Date(), 'MMM yyyy');\n\n  if (data.length === 0) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-lg\">S-Curve Progress</CardTitle>\n        </CardHeader>\n        <CardContent className=\"h-[300px] flex items-center justify-center\">\n          <p className=\"text-muted-foreground\">\n            Add tasks with planned dates to see the S-Curve\n          </p>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const currentData = data.find(d => d.month === todayMonth);\n  const variance = currentData \n    ? (currentData.actual - currentData.planned).toFixed(1)\n    : \"0\";\n\n  return (\n    <Card>\n      <CardHeader className=\"pb-2\">\n        <div className=\"flex items-center justify-between flex-wrap gap-2\">\n          <CardTitle className=\"text-lg\">S-Curve Progress</CardTitle>\n          <div className=\"flex gap-4 text-sm\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-3 h-3 rounded-full bg-blue-500\" />\n              <span>Planned</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-3 h-3 rounded-full bg-emerald-500\" />\n              <span>Actual</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-3 h-3 rounded-full bg-amber-500\" />\n              <span>Earned</span>\n            </div>\n          </div>\n        </div>\n        {currentData && (\n          <p className=\"text-sm text-muted-foreground\">\n            Current variance: <span className={Number(variance) >= 0 ? \"text-emerald-500\" : \"text-red-500\"}>\n              {Number(variance) >= 0 ? \"+\" : \"\"}{variance}%\n            </span>\n          </p>\n        )}\n      </CardHeader>\n      <CardContent>\n        <div className=\"h-[300px]\">\n          <ResponsiveContainer width=\"100%\" height=\"100%\">\n            <LineChart data={data} margin={{ top: 5, right: 20, left: 10, bottom: 5 }}>\n              <CartesianGrid strokeDasharray=\"3 3\" className=\"stroke-muted\" />\n              <XAxis \n                dataKey=\"month\" \n                tick={{ fontSize: 12 }}\n                tickLine={false}\n                axisLine={false}\n              />\n              <YAxis \n                domain={[0, 100]}\n                tick={{ fontSize: 12 }}\n                tickLine={false}\n                axisLine={false}\n                tickFormatter={(value) => `${value}%`}\n              />\n              <Tooltip \n                contentStyle={{ \n                  backgroundColor: 'hsl(var(--card))',\n                  border: '1px solid hsl(var(--border))',\n                  borderRadius: '6px'\n                }}\n                formatter={(value: number) => [`${value}%`, '']}\n              />\n              <ReferenceLine \n                x={todayMonth} \n                stroke=\"hsl(var(--muted-foreground))\" \n                strokeDasharray=\"5 5\"\n                label={{ value: 'Today', position: 'top', fontSize: 10 }}\n              />\n              <Line \n                type=\"monotone\" \n                dataKey=\"planned\" \n                stroke=\"#3b82f6\" \n                strokeWidth={2}\n                dot={{ r: 3 }}\n                name=\"Planned\"\n              />\n              <Line \n                type=\"monotone\" \n                dataKey=\"actual\" \n                stroke=\"#10b981\" \n                strokeWidth={2}\n                dot={{ r: 3 }}\n                name=\"Actual\"\n              />\n              <Line \n                type=\"monotone\" \n                dataKey=\"earned\" \n                stroke=\"#f59e0b\" \n                strokeWidth={2}\n                dot={{ r: 3 }}\n                name=\"Earned\"\n              />\n            </LineChart>\n          </ResponsiveContainer>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":8078},"client/src/components/epc/RiskExposureSummary.tsx":{"content":"import { useMemo } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { AlertTriangle, DollarSign, TrendingUp, TrendingDown } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport type { Risk } from \"@shared/schema\";\n\ninterface RiskExposureSummaryProps {\n  risks: Risk[];\n  totalBudget?: number;\n}\n\ninterface RiskSummary {\n  totalExposure: number;\n  totalContingency: number;\n  exposurePercentage: number;\n  topRisks: Array<{\n    id: number;\n    title: string;\n    exposure: number;\n    probability: number;\n    impact: string;\n    status: string;\n  }>;\n  byCategory: Array<{\n    category: string;\n    count: number;\n    exposure: number;\n  }>;\n  openCount: number;\n  closedCount: number;\n  mitigatingCount: number;\n}\n\nconst IMPACT_MULTIPLIER: Record<string, number> = {\n  low: 1,\n  medium: 2,\n  high: 3,\n  critical: 4,\n};\n\nfunction calculateRiskExposure(risk: Risk): number {\n  const rawCostImpact = Number(risk.costImpact);\n  const costImpact = isNaN(rawCostImpact) ? 0 : rawCostImpact;\n  \n  const rawProb = typeof risk.probability === 'number' ? risk.probability : 3;\n  const probability = (isNaN(rawProb) ? 3 : rawProb) / 5;\n  \n  const impactMult = IMPACT_MULTIPLIER[risk.impact || 'medium'] || 2;\n  \n  if (costImpact > 0) {\n    return costImpact * probability;\n  }\n  return impactMult * probability * 10000;\n}\n\nfunction calculateRiskSummary(risks: Risk[], totalBudget: number): RiskSummary {\n  const openRisks = risks.filter(r => r.status !== 'closed');\n  \n  let totalExposure = 0;\n  let totalContingency = 0;\n  \n  const topRisks = openRisks\n    .map(risk => {\n      const rawExposure = Number(risk.riskExposure);\n      const exposure = isNaN(rawExposure) || rawExposure === 0 ? calculateRiskExposure(risk) : rawExposure;\n      \n      const rawContingency = Number(risk.contingencyReserve);\n      const contingency = isNaN(rawContingency) ? 0 : rawContingency;\n      \n      totalExposure += exposure;\n      totalContingency += contingency;\n      \n      return {\n        id: risk.id,\n        title: risk.title,\n        exposure,\n        probability: typeof risk.probability === 'number' ? risk.probability : 0,\n        impact: risk.impact || 'medium',\n        status: risk.status || 'identified',\n      };\n    })\n    .sort((a, b) => b.exposure - a.exposure)\n    .slice(0, 5);\n\n  const categoryMap = new Map<string, { count: number; exposure: number }>();\n  openRisks.forEach(risk => {\n    const category = risk.categoryEpc || 'technical';\n    const current = categoryMap.get(category) || { count: 0, exposure: 0 };\n    current.count++;\n    \n    const rawExposure = Number(risk.riskExposure);\n    const exposure = isNaN(rawExposure) || rawExposure === 0 ? calculateRiskExposure(risk) : rawExposure;\n    current.exposure += exposure;\n    \n    categoryMap.set(category, current);\n  });\n\n  const byCategory = Array.from(categoryMap.entries())\n    .map(([category, data]) => ({\n      category,\n      count: data.count,\n      exposure: data.exposure,\n    }))\n    .sort((a, b) => b.exposure - a.exposure);\n\n  return {\n    totalExposure,\n    totalContingency,\n    exposurePercentage: totalBudget > 0 ? (totalExposure / totalBudget) * 100 : 0,\n    topRisks,\n    byCategory,\n    openCount: risks.filter(r => r.status !== 'closed').length,\n    closedCount: risks.filter(r => r.status === 'closed').length,\n    mitigatingCount: risks.filter(r => r.status === 'mitigating').length,\n  };\n}\n\nfunction formatCurrency(value: number): string {\n  if (value >= 1000000) {\n    return `$${(value / 1000000).toFixed(1)}M`;\n  }\n  if (value >= 1000) {\n    return `$${(value / 1000).toFixed(0)}K`;\n  }\n  return `$${value.toFixed(0)}`;\n}\n\nconst CATEGORY_LABELS: Record<string, string> = {\n  technical: \"Technical\",\n  external: \"External\",\n  organizational: \"Organizational\",\n  \"project-management\": \"Project Mgmt\",\n  commercial: \"Commercial\",\n  hse: \"HSE\",\n  quality: \"Quality\",\n  schedule: \"Schedule\",\n  resource: \"Resource\",\n};\n\nexport function RiskExposureSummary({ risks, totalBudget = 0 }: RiskExposureSummaryProps) {\n  const summary = useMemo(() => calculateRiskSummary(risks, totalBudget), [risks, totalBudget]);\n\n  if (risks.length === 0) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-lg flex items-center gap-2\">\n            <AlertTriangle className=\"h-5 w-5\" />\n            Risk Exposure\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"h-[200px] flex items-center justify-center\">\n          <p className=\"text-muted-foreground\">No risks identified</p>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const contingencyCoverage = summary.totalExposure > 0 \n    ? (summary.totalContingency / summary.totalExposure) * 100 \n    : 0;\n\n  return (\n    <Card>\n      <CardHeader className=\"pb-2\">\n        <div className=\"flex items-center justify-between flex-wrap gap-2\">\n          <CardTitle className=\"text-lg flex items-center gap-2\">\n            <AlertTriangle className=\"h-5 w-5 text-amber-500\" />\n            Risk Exposure Summary\n          </CardTitle>\n          <div className=\"flex gap-2\">\n            <Badge variant=\"destructive\">{summary.openCount} Open</Badge>\n            <Badge variant=\"secondary\">{summary.mitigatingCount} Mitigating</Badge>\n          </div>\n        </div>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        <div className=\"grid grid-cols-2 gap-4\">\n          <div className=\"p-3 rounded-lg bg-muted\">\n            <div className=\"flex items-center gap-2 text-muted-foreground text-sm mb-1\">\n              <DollarSign className=\"h-4 w-4\" />\n              Total Exposure\n            </div>\n            <div className=\"text-2xl font-bold text-red-500\">\n              {formatCurrency(summary.totalExposure)}\n            </div>\n            {totalBudget > 0 && (\n              <div className=\"text-xs text-muted-foreground\">\n                {summary.exposurePercentage.toFixed(1)}% of budget\n              </div>\n            )}\n          </div>\n          \n          <div className=\"p-3 rounded-lg bg-muted\">\n            <div className=\"flex items-center gap-2 text-muted-foreground text-sm mb-1\">\n              <TrendingDown className=\"h-4 w-4\" />\n              Contingency Reserve\n            </div>\n            <div className=\"text-2xl font-bold text-emerald-500\">\n              {formatCurrency(summary.totalContingency)}\n            </div>\n            <div className=\"text-xs text-muted-foreground\">\n              {contingencyCoverage.toFixed(0)}% coverage\n            </div>\n          </div>\n        </div>\n\n        <div className=\"pt-4 border-t\">\n          <h4 className=\"text-sm font-medium mb-3\">Top Risk Exposures</h4>\n          <div className=\"space-y-3\">\n            {summary.topRisks.map((risk, index) => (\n              <div key={risk.id} className=\"flex items-center gap-3\">\n                <span className=\"text-xs text-muted-foreground w-4\">{index + 1}</span>\n                <div className=\"flex-1 min-w-0\">\n                  <div className=\"text-sm font-medium truncate\">{risk.title}</div>\n                  <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n                    <span>P: {risk.probability}/5</span>\n                    <span className=\"capitalize\">I: {risk.impact}</span>\n                  </div>\n                </div>\n                <span className={cn(\n                  \"font-mono text-sm font-semibold\",\n                  risk.exposure > 100000 ? \"text-red-500\" : \n                  risk.exposure > 50000 ? \"text-amber-500\" : \"text-emerald-500\"\n                )}>\n                  {formatCurrency(risk.exposure)}\n                </span>\n              </div>\n            ))}\n          </div>\n        </div>\n\n        {summary.byCategory.length > 0 && (\n          <div className=\"pt-4 border-t\">\n            <h4 className=\"text-sm font-medium mb-3\">Exposure by Category</h4>\n            <div className=\"space-y-2\">\n              {summary.byCategory.slice(0, 4).map((cat) => {\n                const percentage = summary.totalExposure > 0 \n                  ? (cat.exposure / summary.totalExposure) * 100 \n                  : 0;\n                return (\n                  <div key={cat.category}>\n                    <div className=\"flex items-center justify-between text-sm mb-1\">\n                      <span className=\"capitalize\">{CATEGORY_LABELS[cat.category] || cat.category}</span>\n                      <span className=\"text-muted-foreground\">{cat.count} risks</span>\n                    </div>\n                    <Progress value={percentage} className=\"h-2\" />\n                  </div>\n                );\n              })}\n            </div>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":8830},"server/pdfReports.ts":{"content":"import PdfPrinter from 'pdfmake';\nimport type { TDocumentDefinitions, Content, TableCell, Style, StyleDictionary, TFontDictionary } from 'pdfmake/interfaces';\nimport type { Project, Risk, Issue, Task, CostItem, Stakeholder } from '@shared/schema';\nimport path from 'path';\n\nconst fontsDir = path.join(process.cwd(), 'server', 'fonts');\n\nconst fonts: TFontDictionary = {\n  Roboto: {\n    normal: path.join(fontsDir, 'Roboto-Regular.ttf'),\n    bold: path.join(fontsDir, 'Roboto-Medium.ttf'),\n    italics: path.join(fontsDir, 'Roboto-Italic.ttf'),\n    bolditalics: path.join(fontsDir, 'Roboto-MediumItalic.ttf')\n  }\n};\n\nconst printer = new PdfPrinter(fonts);\n\nconst styles: StyleDictionary = {\n  header: {\n    fontSize: 24,\n    bold: true,\n    color: '#1a365d',\n    margin: [0, 0, 0, 10]\n  },\n  subheader: {\n    fontSize: 16,\n    bold: true,\n    color: '#2d3748',\n    margin: [0, 15, 0, 8]\n  },\n  sectionTitle: {\n    fontSize: 14,\n    bold: true,\n    color: '#4a5568',\n    margin: [0, 10, 0, 5]\n  },\n  tableHeader: {\n    fontSize: 10,\n    bold: true,\n    fillColor: '#e2e8f0',\n    color: '#1a202c'\n  },\n  tableCell: {\n    fontSize: 9,\n    color: '#4a5568'\n  },\n  footer: {\n    fontSize: 8,\n    color: '#718096',\n    alignment: 'center' as const\n  },\n  projectInfo: {\n    fontSize: 11,\n    color: '#4a5568',\n    margin: [0, 2, 0, 2]\n  },\n  statusHigh: {\n    fontSize: 9,\n    bold: true,\n    color: '#c53030'\n  },\n  statusMedium: {\n    fontSize: 9,\n    bold: true,\n    color: '#d69e2e'\n  },\n  statusLow: {\n    fontSize: 9,\n    bold: true,\n    color: '#38a169'\n  },\n  metricValue: {\n    fontSize: 18,\n    bold: true,\n    color: '#2d3748'\n  },\n  metricLabel: {\n    fontSize: 10,\n    color: '#718096'\n  }\n};\n\nfunction formatDate(date: Date | string | null | undefined): string {\n  if (!date) return 'N/A';\n  const d = new Date(date);\n  return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });\n}\n\nfunction formatCurrency(amount: number | string | null | undefined, currency: string = 'USD'): string {\n  if (amount === null || amount === undefined) return 'N/A';\n  const num = typeof amount === 'string' ? parseFloat(amount) : amount;\n  return new Intl.NumberFormat('en-US', { style: 'currency', currency }).format(num);\n}\n\nfunction getImpactColor(impact: string): string {\n  switch (impact) {\n    case 'critical': return '#c53030';\n    case 'high': return '#dd6b20';\n    case 'medium': return '#d69e2e';\n    case 'low': return '#38a169';\n    default: return '#718096';\n  }\n}\n\nfunction getPriorityColor(priority: string): string {\n  switch (priority) {\n    case 'critical': return '#c53030';\n    case 'high': return '#dd6b20';\n    case 'medium': return '#d69e2e';\n    case 'low': return '#38a169';\n    default: return '#718096';\n  }\n}\n\nfunction createHeader(title: string, project: Project, reportDate: Date): Content[] {\n  return [\n    {\n      columns: [\n        {\n          text: title,\n          style: 'header',\n          width: '*'\n        },\n        {\n          text: `Report Date: ${formatDate(reportDate)}`,\n          alignment: 'right' as const,\n          fontSize: 10,\n          color: '#718096',\n          width: 'auto'\n        }\n      ]\n    },\n    {\n      canvas: [{ type: 'line', x1: 0, y1: 0, x2: 515, y2: 0, lineWidth: 2, lineColor: '#3182ce' }]\n    },\n    { text: '', margin: [0, 10, 0, 0] },\n    {\n      columns: [\n        {\n          stack: [\n            { text: `Project: ${project.name}`, style: 'projectInfo', bold: true },\n            { text: `Code: ${project.code}`, style: 'projectInfo' },\n            { text: `Status: ${project.status}`, style: 'projectInfo' }\n          ],\n          width: '*'\n        },\n        {\n          stack: [\n            { text: `Start Date: ${formatDate(project.startDate)}`, style: 'projectInfo' },\n            { text: `End Date: ${formatDate(project.endDate)}`, style: 'projectInfo' },\n            { text: `Budget: ${formatCurrency(project.budget, project.currency)}`, style: 'projectInfo' }\n          ],\n          width: 'auto'\n        }\n      ]\n    },\n    { text: '', margin: [0, 15, 0, 0] }\n  ];\n}\n\nfunction createFooter(currentPage: number, pageCount: number): Content {\n  return {\n    columns: [\n      { text: 'Generated by EPC PMIS', style: 'footer', width: '*' },\n      { text: `Page ${currentPage} of ${pageCount}`, style: 'footer', alignment: 'right' as const, width: 'auto' }\n    ],\n    margin: [40, 0, 40, 0]\n  };\n}\n\nexport interface RiskRegisterReportData {\n  project: Project;\n  risks: Risk[];\n  generatedBy: string;\n}\n\nexport function generateRiskRegisterReport(data: RiskRegisterReportData): PDFKit.PDFDocument {\n  const { project, risks, generatedBy } = data;\n  const reportDate = new Date();\n\n  const risksByStatus = {\n    identified: risks.filter(r => r.status === 'identified'),\n    assessed: risks.filter(r => r.status === 'assessed'),\n    mitigating: risks.filter(r => r.status === 'mitigating'),\n    closed: risks.filter(r => r.status === 'closed')\n  };\n\n  const highRisks = risks.filter(r => r.impact === 'high' || r.impact === 'critical');\n  const avgProbability = risks.length > 0 \n    ? (risks.reduce((sum, r) => sum + (r.probability || 3), 0) / risks.length).toFixed(1)\n    : '0';\n\n  const tableBody: TableCell[][] = [\n    [\n      { text: 'Code', style: 'tableHeader' },\n      { text: 'Title', style: 'tableHeader' },\n      { text: 'Category', style: 'tableHeader' },\n      { text: 'Status', style: 'tableHeader' },\n      { text: 'Prob.', style: 'tableHeader' },\n      { text: 'Impact', style: 'tableHeader' },\n      { text: 'Mitigation Plan', style: 'tableHeader' }\n    ]\n  ];\n\n  risks.forEach(risk => {\n    tableBody.push([\n      { text: risk.code, style: 'tableCell' },\n      { text: risk.title, style: 'tableCell' },\n      { text: risk.category || 'N/A', style: 'tableCell' },\n      { text: risk.status, style: 'tableCell' },\n      { text: `${risk.probability}/5`, style: 'tableCell' },\n      { text: risk.impact, style: 'tableCell', color: getImpactColor(risk.impact) },\n      { text: risk.mitigationPlan || 'Not defined', style: 'tableCell', noWrap: false }\n    ]);\n  });\n\n  const docDefinition: TDocumentDefinitions = {\n    pageSize: 'A4',\n    pageOrientation: 'landscape',\n    pageMargins: [40, 60, 40, 60],\n    styles,\n    content: [\n      ...createHeader('Risk Register Report', project, reportDate),\n      \n      { text: 'Executive Summary', style: 'subheader' },\n      {\n        columns: [\n          {\n            stack: [\n              { text: risks.length.toString(), style: 'metricValue' },\n              { text: 'Total Risks', style: 'metricLabel' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          },\n          {\n            stack: [\n              { text: highRisks.length.toString(), style: 'metricValue', color: '#c53030' },\n              { text: 'High/Critical Risks', style: 'metricLabel' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          },\n          {\n            stack: [\n              { text: avgProbability, style: 'metricValue' },\n              { text: 'Avg Probability (1-5)', style: 'metricLabel' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          },\n          {\n            stack: [\n              { text: risksByStatus.closed.length.toString(), style: 'metricValue', color: '#38a169' },\n              { text: 'Closed Risks', style: 'metricLabel' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          }\n        ],\n        margin: [0, 10, 0, 20]\n      },\n\n      { text: 'Risk Register', style: 'subheader' },\n      risks.length > 0 ? {\n        table: {\n          headerRows: 1,\n          widths: [50, 100, 70, 60, 40, 50, '*'],\n          body: tableBody\n        },\n        layout: {\n          fillColor: (rowIndex: number) => rowIndex === 0 ? '#e2e8f0' : (rowIndex % 2 === 0 ? '#f7fafc' : null)\n        }\n      } : { text: 'No risks registered for this project.', style: 'tableCell', italics: true },\n\n      { text: '', pageBreak: 'after' },\n      \n      { text: 'Risk Distribution by Status', style: 'subheader' },\n      {\n        columns: [\n          {\n            stack: [\n              { text: 'Identified', style: 'sectionTitle' },\n              { text: `${risksByStatus.identified.length} risks`, style: 'projectInfo' }\n            ],\n            width: '*'\n          },\n          {\n            stack: [\n              { text: 'Assessed', style: 'sectionTitle' },\n              { text: `${risksByStatus.assessed.length} risks`, style: 'projectInfo' }\n            ],\n            width: '*'\n          },\n          {\n            stack: [\n              { text: 'Mitigating', style: 'sectionTitle' },\n              { text: `${risksByStatus.mitigating.length} risks`, style: 'projectInfo' }\n            ],\n            width: '*'\n          },\n          {\n            stack: [\n              { text: 'Closed', style: 'sectionTitle' },\n              { text: `${risksByStatus.closed.length} risks`, style: 'projectInfo' }\n            ],\n            width: '*'\n          }\n        ],\n        margin: [0, 10, 0, 20]\n      },\n\n      { text: `Report generated by: ${generatedBy}`, style: 'footer', margin: [0, 30, 0, 0] }\n    ],\n    footer: createFooter\n  };\n\n  return printer.createPdfKitDocument(docDefinition);\n}\n\nexport interface ProjectStatusReportData {\n  project: Project;\n  tasks: Task[];\n  risks: Risk[];\n  issues: Issue[];\n  costItems: CostItem[];\n  generatedBy: string;\n}\n\nexport function generateProjectStatusReport(data: ProjectStatusReportData): PDFKit.PDFDocument {\n  const { project, tasks, risks, issues, costItems, generatedBy } = data;\n  const reportDate = new Date();\n\n  const tasksByStatus = {\n    notStarted: tasks.filter(t => t.status === 'not-started'),\n    inProgress: tasks.filter(t => t.status === 'in-progress'),\n    review: tasks.filter(t => t.status === 'review'),\n    completed: tasks.filter(t => t.status === 'completed'),\n    onHold: tasks.filter(t => t.status === 'on-hold')\n  };\n\n  const completionRate = tasks.length > 0 \n    ? ((tasksByStatus.completed.length / tasks.length) * 100).toFixed(1)\n    : '0';\n\n  const avgProgress = tasks.length > 0\n    ? (tasks.reduce((sum, t) => sum + (t.progress || 0), 0) / tasks.length).toFixed(1)\n    : '0';\n\n  const openIssues = issues.filter(i => i.status === 'open' || i.status === 'in-progress');\n  const activeRisks = risks.filter(r => r.status !== 'closed');\n\n  const totalBudgeted = costItems.reduce((sum, c) => sum + parseFloat(c.budgeted?.toString() || '0'), 0);\n  const totalActual = costItems.reduce((sum, c) => sum + parseFloat(c.actual?.toString() || '0'), 0);\n  const costVariance = totalBudgeted - totalActual;\n\n  const taskTableBody: TableCell[][] = [\n    [\n      { text: 'WBS', style: 'tableHeader' },\n      { text: 'Task Name', style: 'tableHeader' },\n      { text: 'Status', style: 'tableHeader' },\n      { text: 'Priority', style: 'tableHeader' },\n      { text: 'Progress', style: 'tableHeader' },\n      { text: 'Start Date', style: 'tableHeader' },\n      { text: 'End Date', style: 'tableHeader' }\n    ]\n  ];\n\n  tasks.slice(0, 20).forEach(task => {\n    taskTableBody.push([\n      { text: task.wbsCode, style: 'tableCell' },\n      { text: task.name, style: 'tableCell' },\n      { text: task.status, style: 'tableCell' },\n      { text: task.priority, style: 'tableCell', color: getPriorityColor(task.priority) },\n      { text: `${task.progress}%`, style: 'tableCell' },\n      { text: formatDate(task.startDate), style: 'tableCell' },\n      { text: formatDate(task.endDate), style: 'tableCell' }\n    ]);\n  });\n\n  const docDefinition: TDocumentDefinitions = {\n    pageSize: 'A4',\n    pageOrientation: 'portrait',\n    pageMargins: [40, 60, 40, 60],\n    styles,\n    content: [\n      ...createHeader('Project Status Report', project, reportDate),\n\n      { text: 'Executive Summary', style: 'subheader' },\n      {\n        columns: [\n          {\n            stack: [\n              { text: `${completionRate}%`, style: 'metricValue', color: '#3182ce' },\n              { text: 'Task Completion', style: 'metricLabel' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          },\n          {\n            stack: [\n              { text: `${avgProgress}%`, style: 'metricValue' },\n              { text: 'Avg Progress', style: 'metricLabel' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          },\n          {\n            stack: [\n              { text: openIssues.length.toString(), style: 'metricValue', color: openIssues.length > 0 ? '#dd6b20' : '#38a169' },\n              { text: 'Open Issues', style: 'metricLabel' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          },\n          {\n            stack: [\n              { text: activeRisks.length.toString(), style: 'metricValue', color: activeRisks.length > 5 ? '#c53030' : '#718096' },\n              { text: 'Active Risks', style: 'metricLabel' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          }\n        ],\n        margin: [0, 10, 0, 20]\n      },\n\n      { text: 'Task Status Overview', style: 'subheader' },\n      {\n        columns: [\n          { text: `Not Started: ${tasksByStatus.notStarted.length}`, style: 'projectInfo', width: '*' },\n          { text: `In Progress: ${tasksByStatus.inProgress.length}`, style: 'projectInfo', width: '*' },\n          { text: `Completed: ${tasksByStatus.completed.length}`, style: 'projectInfo', width: '*' },\n          { text: `On Hold: ${tasksByStatus.onHold.length}`, style: 'projectInfo', width: '*' }\n        ],\n        margin: [0, 5, 0, 15]\n      },\n\n      { text: 'Budget Summary', style: 'subheader' },\n      {\n        columns: [\n          {\n            stack: [\n              { text: formatCurrency(totalBudgeted, project.currency), style: 'metricValue', fontSize: 14 },\n              { text: 'Total Budgeted', style: 'metricLabel' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          },\n          {\n            stack: [\n              { text: formatCurrency(totalActual, project.currency), style: 'metricValue', fontSize: 14 },\n              { text: 'Total Actual', style: 'metricLabel' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          },\n          {\n            stack: [\n              { text: formatCurrency(costVariance, project.currency), style: 'metricValue', fontSize: 14, color: costVariance >= 0 ? '#38a169' : '#c53030' },\n              { text: 'Variance', style: 'metricLabel' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          }\n        ],\n        margin: [0, 10, 0, 20]\n      },\n\n      { text: 'Task Details (Top 20)', style: 'subheader' },\n      tasks.length > 0 ? {\n        table: {\n          headerRows: 1,\n          widths: [50, '*', 60, 50, 50, 60, 60],\n          body: taskTableBody\n        },\n        layout: {\n          fillColor: (rowIndex: number) => rowIndex === 0 ? '#e2e8f0' : (rowIndex % 2 === 0 ? '#f7fafc' : null)\n        }\n      } : { text: 'No tasks found for this project.', style: 'tableCell', italics: true },\n\n      { text: `Report generated by: ${generatedBy}`, style: 'footer', margin: [0, 30, 0, 0] }\n    ],\n    footer: createFooter\n  };\n\n  return printer.createPdfKitDocument(docDefinition);\n}\n\nexport interface EVAReportData {\n  project: Project;\n  tasks: Task[];\n  costItems: CostItem[];\n  generatedBy: string;\n}\n\nexport function generateEVAReport(data: EVAReportData): PDFKit.PDFDocument {\n  const { project, tasks, costItems, generatedBy } = data;\n  const reportDate = new Date();\n\n  const totalBudget = parseFloat(project.budget?.toString() || '0');\n  const totalBudgeted = costItems.reduce((sum, c) => sum + parseFloat(c.budgeted?.toString() || '0'), 0);\n  const totalActual = costItems.reduce((sum, c) => sum + parseFloat(c.actual?.toString() || '0'), 0);\n  \n  const avgProgress = tasks.length > 0\n    ? tasks.reduce((sum, t) => sum + (t.progress || 0), 0) / tasks.length\n    : 0;\n\n  const plannedValue = totalBudget;\n  const earnedValue = totalBudget * (avgProgress / 100);\n  const actualCost = totalActual;\n\n  const scheduleVariance = earnedValue - plannedValue * (avgProgress / 100);\n  const costVariance = earnedValue - actualCost;\n  \n  const schedulePerformanceIndex = plannedValue > 0 ? earnedValue / (plannedValue * (avgProgress / 100)) : 0;\n  const costPerformanceIndex = actualCost > 0 ? earnedValue / actualCost : 0;\n\n  const estimateAtCompletion = costPerformanceIndex > 0 ? totalBudget / costPerformanceIndex : totalBudget;\n  const estimateToComplete = estimateAtCompletion - actualCost;\n  const varianceAtCompletion = totalBudget - estimateAtCompletion;\n\n  const costBreakdown = costItems.reduce((acc, item) => {\n    const category = item.category || 'Other';\n    if (!acc[category]) {\n      acc[category] = { budgeted: 0, actual: 0 };\n    }\n    acc[category].budgeted += parseFloat(item.budgeted?.toString() || '0');\n    acc[category].actual += parseFloat(item.actual?.toString() || '0');\n    return acc;\n  }, {} as Record<string, { budgeted: number; actual: number }>);\n\n  const costTableBody: TableCell[][] = [\n    [\n      { text: 'Category', style: 'tableHeader' },\n      { text: 'Budgeted', style: 'tableHeader' },\n      { text: 'Actual', style: 'tableHeader' },\n      { text: 'Variance', style: 'tableHeader' },\n      { text: '% of Budget', style: 'tableHeader' }\n    ]\n  ];\n\n  Object.entries(costBreakdown).forEach(([category, values]) => {\n    const variance = values.budgeted - values.actual;\n    const pctOfBudget = values.budgeted > 0 ? ((values.actual / values.budgeted) * 100).toFixed(1) : '0';\n    costTableBody.push([\n      { text: category, style: 'tableCell' },\n      { text: formatCurrency(values.budgeted, project.currency), style: 'tableCell' },\n      { text: formatCurrency(values.actual, project.currency), style: 'tableCell' },\n      { text: formatCurrency(variance, project.currency), style: 'tableCell', color: variance >= 0 ? '#38a169' : '#c53030' },\n      { text: `${pctOfBudget}%`, style: 'tableCell' }\n    ]);\n  });\n\n  const docDefinition: TDocumentDefinitions = {\n    pageSize: 'A4',\n    pageOrientation: 'portrait',\n    pageMargins: [40, 60, 40, 60],\n    styles,\n    content: [\n      ...createHeader('Earned Value Analysis Report', project, reportDate),\n\n      { text: 'Key Performance Indicators', style: 'subheader' },\n      {\n        columns: [\n          {\n            stack: [\n              { text: formatCurrency(plannedValue, project.currency), style: 'metricValue', fontSize: 14 },\n              { text: 'Planned Value (PV)', style: 'metricLabel' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          },\n          {\n            stack: [\n              { text: formatCurrency(earnedValue, project.currency), style: 'metricValue', fontSize: 14, color: '#3182ce' },\n              { text: 'Earned Value (EV)', style: 'metricLabel' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          },\n          {\n            stack: [\n              { text: formatCurrency(actualCost, project.currency), style: 'metricValue', fontSize: 14 },\n              { text: 'Actual Cost (AC)', style: 'metricLabel' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          }\n        ],\n        margin: [0, 10, 0, 20]\n      },\n\n      { text: 'Variance Analysis', style: 'subheader' },\n      {\n        columns: [\n          {\n            stack: [\n              { text: formatCurrency(scheduleVariance, project.currency), style: 'metricValue', fontSize: 14, color: scheduleVariance >= 0 ? '#38a169' : '#c53030' },\n              { text: 'Schedule Variance (SV)', style: 'metricLabel' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          },\n          {\n            stack: [\n              { text: formatCurrency(costVariance, project.currency), style: 'metricValue', fontSize: 14, color: costVariance >= 0 ? '#38a169' : '#c53030' },\n              { text: 'Cost Variance (CV)', style: 'metricLabel' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          }\n        ],\n        margin: [0, 10, 0, 20]\n      },\n\n      { text: 'Performance Indices', style: 'subheader' },\n      {\n        columns: [\n          {\n            stack: [\n              { text: schedulePerformanceIndex.toFixed(2), style: 'metricValue', fontSize: 14, color: schedulePerformanceIndex >= 1 ? '#38a169' : '#c53030' },\n              { text: 'Schedule Performance Index (SPI)', style: 'metricLabel' },\n              { text: schedulePerformanceIndex >= 1 ? 'Ahead of Schedule' : 'Behind Schedule', style: 'projectInfo', color: schedulePerformanceIndex >= 1 ? '#38a169' : '#c53030' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          },\n          {\n            stack: [\n              { text: costPerformanceIndex.toFixed(2), style: 'metricValue', fontSize: 14, color: costPerformanceIndex >= 1 ? '#38a169' : '#c53030' },\n              { text: 'Cost Performance Index (CPI)', style: 'metricLabel' },\n              { text: costPerformanceIndex >= 1 ? 'Under Budget' : 'Over Budget', style: 'projectInfo', color: costPerformanceIndex >= 1 ? '#38a169' : '#c53030' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          }\n        ],\n        margin: [0, 10, 0, 20]\n      },\n\n      { text: 'Forecasting', style: 'subheader' },\n      {\n        columns: [\n          {\n            stack: [\n              { text: formatCurrency(estimateAtCompletion, project.currency), style: 'metricValue', fontSize: 12 },\n              { text: 'Estimate at Completion (EAC)', style: 'metricLabel' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          },\n          {\n            stack: [\n              { text: formatCurrency(estimateToComplete, project.currency), style: 'metricValue', fontSize: 12 },\n              { text: 'Estimate to Complete (ETC)', style: 'metricLabel' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          },\n          {\n            stack: [\n              { text: formatCurrency(varianceAtCompletion, project.currency), style: 'metricValue', fontSize: 12, color: varianceAtCompletion >= 0 ? '#38a169' : '#c53030' },\n              { text: 'Variance at Completion (VAC)', style: 'metricLabel' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          }\n        ],\n        margin: [0, 10, 0, 20]\n      },\n\n      { text: 'Cost Breakdown by Category', style: 'subheader' },\n      Object.keys(costBreakdown).length > 0 ? {\n        table: {\n          headerRows: 1,\n          widths: ['*', 'auto', 'auto', 'auto', 'auto'],\n          body: costTableBody\n        },\n        layout: {\n          fillColor: (rowIndex: number) => rowIndex === 0 ? '#e2e8f0' : (rowIndex % 2 === 0 ? '#f7fafc' : null)\n        }\n      } : { text: 'No cost items recorded for this project.', style: 'tableCell', italics: true },\n\n      { text: `Report generated by: ${generatedBy}`, style: 'footer', margin: [0, 30, 0, 0] }\n    ],\n    footer: createFooter\n  };\n\n  return printer.createPdfKitDocument(docDefinition);\n}\n\nexport interface IssueLogReportData {\n  project: Project;\n  issues: Issue[];\n  generatedBy: string;\n}\n\nexport function generateIssueLogReport(data: IssueLogReportData): PDFKit.PDFDocument {\n  const { project, issues, generatedBy } = data;\n  const reportDate = new Date();\n\n  const issuesByStatus = {\n    open: issues.filter(i => i.status === 'open'),\n    inProgress: issues.filter(i => i.status === 'in-progress'),\n    resolved: issues.filter(i => i.status === 'resolved'),\n    closed: issues.filter(i => i.status === 'closed')\n  };\n\n  const issuesByPriority = {\n    critical: issues.filter(i => i.priority === 'critical'),\n    high: issues.filter(i => i.priority === 'high'),\n    medium: issues.filter(i => i.priority === 'medium'),\n    low: issues.filter(i => i.priority === 'low')\n  };\n\n  const tableBody: TableCell[][] = [\n    [\n      { text: 'Code', style: 'tableHeader' },\n      { text: 'Title', style: 'tableHeader' },\n      { text: 'Status', style: 'tableHeader' },\n      { text: 'Priority', style: 'tableHeader' },\n      { text: 'Category', style: 'tableHeader' },\n      { text: 'Reported Date', style: 'tableHeader' },\n      { text: 'Resolution', style: 'tableHeader' }\n    ]\n  ];\n\n  issues.forEach(issue => {\n    tableBody.push([\n      { text: issue.code, style: 'tableCell' },\n      { text: issue.title, style: 'tableCell' },\n      { text: issue.status, style: 'tableCell' },\n      { text: issue.priority, style: 'tableCell', color: getPriorityColor(issue.priority) },\n      { text: issue.category || 'N/A', style: 'tableCell' },\n      { text: formatDate(issue.reportedDate), style: 'tableCell' },\n      { text: issue.resolution || 'Pending', style: 'tableCell' }\n    ]);\n  });\n\n  const docDefinition: TDocumentDefinitions = {\n    pageSize: 'A4',\n    pageOrientation: 'landscape',\n    pageMargins: [40, 60, 40, 60],\n    styles,\n    content: [\n      ...createHeader('Issue Log Report', project, reportDate),\n\n      { text: 'Executive Summary', style: 'subheader' },\n      {\n        columns: [\n          {\n            stack: [\n              { text: issues.length.toString(), style: 'metricValue' },\n              { text: 'Total Issues', style: 'metricLabel' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          },\n          {\n            stack: [\n              { text: issuesByStatus.open.length.toString(), style: 'metricValue', color: '#dd6b20' },\n              { text: 'Open Issues', style: 'metricLabel' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          },\n          {\n            stack: [\n              { text: issuesByPriority.critical.length.toString(), style: 'metricValue', color: '#c53030' },\n              { text: 'Critical Priority', style: 'metricLabel' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          },\n          {\n            stack: [\n              { text: issuesByStatus.resolved.length.toString(), style: 'metricValue', color: '#38a169' },\n              { text: 'Resolved Issues', style: 'metricLabel' }\n            ],\n            width: '*',\n            alignment: 'center' as const\n          }\n        ],\n        margin: [0, 10, 0, 20]\n      },\n\n      { text: 'Issue Log', style: 'subheader' },\n      issues.length > 0 ? {\n        table: {\n          headerRows: 1,\n          widths: [50, '*', 60, 50, 70, 70, 100],\n          body: tableBody\n        },\n        layout: {\n          fillColor: (rowIndex: number) => rowIndex === 0 ? '#e2e8f0' : (rowIndex % 2 === 0 ? '#f7fafc' : null)\n        }\n      } : { text: 'No issues logged for this project.', style: 'tableCell', italics: true },\n\n      { text: `Report generated by: ${generatedBy}`, style: 'footer', margin: [0, 30, 0, 0] }\n    ],\n    footer: createFooter\n  };\n\n  return printer.createPdfKitDocument(docDefinition);\n}\n","size_bytes":27141},"client/src/components/widgets/CadencePlaybook.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { \n  Clock, Pin, Calendar, Users, FileText, \n  BarChart3, AlertTriangle, CheckSquare\n} from \"lucide-react\";\nimport { useProject } from \"@/contexts/ProjectContext\";\n\ninterface CadenceItem {\n  id: string;\n  title: string;\n  schedule: string;\n  icon: React.ReactNode;\n  isPinned?: boolean;\n  nextDate?: string;\n}\n\nconst DEFAULT_CADENCES: CadenceItem[] = [\n  {\n    id: \"daily-standup\",\n    title: \"Daily Standup\",\n    schedule: \"Weekdays 9:00 AM\",\n    icon: <Users className=\"h-4 w-4\" />,\n    isPinned: true,\n  },\n  {\n    id: \"weekly-review\",\n    title: \"Weekly Progress Review\",\n    schedule: \"Fridays 2:00 PM\",\n    icon: <BarChart3 className=\"h-4 w-4\" />,\n    isPinned: true,\n  },\n  {\n    id: \"risk-review\",\n    title: \"Risk Review Meeting\",\n    schedule: \"Bi-weekly Tuesdays\",\n    icon: <AlertTriangle className=\"h-4 w-4\" />,\n    isPinned: false,\n  },\n  {\n    id: \"monthly-report\",\n    title: \"Monthly Status Report\",\n    schedule: \"Last Friday of month\",\n    icon: <FileText className=\"h-4 w-4\" />,\n    isPinned: false,\n  },\n];\n\ninterface ReviewItem {\n  id: string;\n  title: string;\n  owner: string;\n  dueDate: string;\n  type: \"approval\" | \"review\" | \"sign-off\";\n}\n\nconst PENDING_REVIEWS: ReviewItem[] = [\n  {\n    id: \"review-1\",\n    title: \"Engineering Drawing Package\",\n    owner: \"John Smith\",\n    dueDate: \"Tomorrow\",\n    type: \"approval\",\n  },\n  {\n    id: \"review-2\",\n    title: \"Procurement Schedule\",\n    owner: \"Sarah Johnson\",\n    dueDate: \"Dec 2\",\n    type: \"review\",\n  },\n  {\n    id: \"review-3\",\n    title: \"HSE Plan Update\",\n    owner: \"Mike Chen\",\n    dueDate: \"Dec 5\",\n    type: \"sign-off\",\n  },\n];\n\nexport function CadencePlaybook() {\n  const { selectedProject } = useProject();\n\n  const pinnedCadences = DEFAULT_CADENCES.filter(c => c.isPinned);\n  const otherCadences = DEFAULT_CADENCES.filter(c => !c.isPinned);\n\n  return (\n    <Card data-testid=\"widget-cadence-playbook\">\n      <CardHeader className=\"pb-2\">\n        <div className=\"flex items-center justify-between\">\n          <CardTitle className=\"text-sm flex items-center gap-2\">\n            <Clock className=\"h-4 w-4\" />\n            Cadence Playbook\n          </CardTitle>\n          <Button variant=\"ghost\" size=\"sm\" className=\"h-6 text-xs\">\n            Edit\n          </Button>\n        </div>\n      </CardHeader>\n      <CardContent className=\"space-y-3\">\n        {pinnedCadences.length > 0 && (\n          <div className=\"space-y-2\">\n            <p className=\"text-xs font-medium text-muted-foreground flex items-center gap-1\">\n              <Pin className=\"h-3 w-3\" />\n              Pinned Routines\n            </p>\n            {pinnedCadences.map((cadence) => (\n              <div\n                key={cadence.id}\n                className=\"flex items-center gap-2 p-2 rounded-md bg-muted/50\"\n                data-testid={`cadence-item-${cadence.id}`}\n              >\n                <div className=\"h-7 w-7 rounded-full bg-primary/10 flex items-center justify-center shrink-0\">\n                  {cadence.icon}\n                </div>\n                <div className=\"flex-1 min-w-0\">\n                  <p className=\"text-sm font-medium truncate\">{cadence.title}</p>\n                  <p className=\"text-xs text-muted-foreground\">{cadence.schedule}</p>\n                </div>\n                <Pin className=\"h-3 w-3 text-primary shrink-0\" />\n              </div>\n            ))}\n          </div>\n        )}\n\n        {otherCadences.length > 0 && (\n          <div className=\"space-y-2\">\n            <p className=\"text-xs font-medium text-muted-foreground\">Other Routines</p>\n            {otherCadences.map((cadence) => (\n              <div\n                key={cadence.id}\n                className=\"flex items-center gap-2 py-1.5 border-b last:border-0\"\n                data-testid={`cadence-item-${cadence.id}`}\n              >\n                <div className=\"h-6 w-6 rounded-full bg-muted flex items-center justify-center shrink-0\">\n                  {cadence.icon}\n                </div>\n                <div className=\"flex-1 min-w-0\">\n                  <p className=\"text-sm truncate\">{cadence.title}</p>\n                  <p className=\"text-xs text-muted-foreground\">{cadence.schedule}</p>\n                </div>\n              </div>\n            ))}\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\nexport function ReviewsWidget() {\n  return (\n    <Card data-testid=\"widget-reviews\">\n      <CardHeader className=\"pb-2\">\n        <CardTitle className=\"text-sm flex items-center gap-2\">\n          <CheckSquare className=\"h-4 w-4\" />\n          Next Approvals on Deck\n        </CardTitle>\n      </CardHeader>\n      <CardContent>\n        {PENDING_REVIEWS.length === 0 ? (\n          <p className=\"text-sm text-muted-foreground text-center py-4\">\n            No pending approvals\n          </p>\n        ) : (\n          <div className=\"space-y-2\">\n            {PENDING_REVIEWS.map((review) => (\n              <div\n                key={review.id}\n                className=\"flex items-start gap-2 py-1.5 border-b last:border-0\"\n                data-testid={`review-item-${review.id}`}\n              >\n                <div className=\"h-6 w-6 rounded bg-muted flex items-center justify-center shrink-0 mt-0.5\">\n                  <CheckSquare className=\"h-3.5 w-3.5\" />\n                </div>\n                <div className=\"flex-1 min-w-0\">\n                  <p className=\"text-sm font-medium truncate\">{review.title}</p>\n                  <p className=\"text-xs text-muted-foreground\">\n                    {review.owner} · Due {review.dueDate}\n                  </p>\n                </div>\n                <Badge \n                  variant={review.type === \"approval\" ? \"default\" : \"secondary\"} \n                  className=\"text-xs shrink-0 capitalize\"\n                >\n                  {review.type}\n                </Badge>\n              </div>\n            ))}\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":6106},"client/src/components/widgets/ResourceSnapshot.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { \n  Users, Wrench, Package, AlertCircle, \n  DollarSign, TrendingUp, TrendingDown\n} from \"lucide-react\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport type { Resource, ResourceAssignment } from \"@shared/schema\";\n\ninterface StatItemProps {\n  icon: React.ReactNode;\n  label: string;\n  value: string | number;\n  subValue?: string;\n  trend?: \"up\" | \"down\";\n}\n\nfunction StatItem({ icon, label, value, subValue, trend }: StatItemProps) {\n  return (\n    <div className=\"flex items-center justify-between py-2 border-b last:border-0\">\n      <div className=\"flex items-center gap-2\">\n        {icon}\n        <span className=\"text-sm\">{label}</span>\n      </div>\n      <div className=\"text-right\">\n        <span className=\"text-sm font-semibold tabular-nums flex items-center gap-1\">\n          {value}\n          {trend === \"up\" && <TrendingUp className=\"h-3 w-3 text-green-500\" />}\n          {trend === \"down\" && <TrendingDown className=\"h-3 w-3 text-red-500\" />}\n        </span>\n        {subValue && <span className=\"text-xs text-muted-foreground\">{subValue}</span>}\n      </div>\n    </div>\n  );\n}\n\nexport function ResourceSnapshot() {\n  const { selectedProjectId } = useProject();\n\n  const { data: resources = [], isLoading } = useQuery<Resource[]>({\n    queryKey: [\"/api/projects\", selectedProjectId, \"resources\"],\n    enabled: !!selectedProjectId,\n    refetchInterval: 15 * 60 * 1000,\n  });\n\n  if (isLoading) {\n    return (\n      <Card data-testid=\"widget-resource-snapshot\">\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-sm flex items-center gap-2\">\n            <Users className=\"h-4 w-4\" />\n            Resource Snapshot\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-3\">\n          {[1, 2, 3, 4].map((i) => (\n            <div key={i} className=\"flex items-center justify-between py-2\">\n              <div className=\"flex items-center gap-2\">\n                <Skeleton className=\"h-4 w-4\" />\n                <Skeleton className=\"h-4 w-20\" />\n              </div>\n              <Skeleton className=\"h-4 w-12\" />\n            </div>\n          ))}\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const humanResources = resources.filter(r => r.type === \"human\");\n  const equipmentResources = resources.filter(r => r.type === \"equipment\");\n  const materialResources = resources.filter(r => r.type === \"material\");\n\n  const totalResources = resources.length;\n  const avgAvailability = resources.length > 0\n    ? Math.round(resources.reduce((sum, r) => sum + (r.availability || 0), 0) / resources.length)\n    : 0;\n\n  const overAllocated = resources.filter(r => (r.availability || 0) > 100).length;\n  const underUtilized = resources.filter(r => (r.availability || 0) < 50).length;\n\n  const totalCostExposure = resources.reduce((sum, r) => {\n    const rate = parseFloat(r.rate || r.costPerHour || \"0\");\n    return sum + rate;\n  }, 0);\n\n  const formatCurrency = (amount: number) => {\n    if (amount >= 1000) return `$${(amount / 1000).toFixed(1)}K`;\n    return `$${amount.toFixed(0)}`;\n  };\n\n  return (\n    <Card data-testid=\"widget-resource-snapshot\">\n      <CardHeader className=\"pb-2\">\n        <CardTitle className=\"text-sm flex items-center gap-2\">\n          <Users className=\"h-4 w-4\" />\n          Resource Snapshot\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-1\">\n        <StatItem\n          icon={<Users className=\"h-4 w-4 text-blue-500\" />}\n          label=\"Team Members\"\n          value={humanResources.length}\n          subValue={`of ${totalResources} total`}\n        />\n\n        <StatItem\n          icon={<Wrench className=\"h-4 w-4 text-amber-500\" />}\n          label=\"Equipment\"\n          value={equipmentResources.length}\n        />\n\n        <StatItem\n          icon={<Package className=\"h-4 w-4 text-green-500\" />}\n          label=\"Materials\"\n          value={materialResources.length}\n        />\n\n        <StatItem\n          icon={<DollarSign className=\"h-4 w-4 text-muted-foreground\" />}\n          label=\"Hourly Rate Total\"\n          value={formatCurrency(totalCostExposure)}\n          subValue=\"/hr combined\"\n        />\n\n        <div className=\"pt-2 space-y-2\">\n          <div className=\"flex items-center justify-between\">\n            <span className=\"text-xs text-muted-foreground\">Avg Availability</span>\n            <span className=\"text-xs font-medium\">{avgAvailability}%</span>\n          </div>\n          <Progress value={avgAvailability} className=\"h-1.5\" />\n        </div>\n\n        {(overAllocated > 0 || underUtilized > 0) && (\n          <div className=\"pt-2 flex flex-wrap gap-2\">\n            {overAllocated > 0 && (\n              <Badge variant=\"destructive\" className=\"text-xs gap-1\">\n                <AlertCircle className=\"h-3 w-3\" />\n                {overAllocated} Over-allocated\n              </Badge>\n            )}\n            {underUtilized > 0 && (\n              <Badge variant=\"secondary\" className=\"text-xs gap-1\">\n                {underUtilized} Under-utilized\n              </Badge>\n            )}\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":5403},"client/src/components/ai/AISettingsModal.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Label } from \"@/components/ui/label\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport interface AISettings {\n  personality: \"professional\" | \"friendly\" | \"technical\";\n  verbosity: number;\n  focusAreas: string[];\n  autoSuggest: boolean;\n}\n\nconst DEFAULT_SETTINGS: AISettings = {\n  personality: \"professional\",\n  verbosity: 50,\n  focusAreas: [\"tasks\", \"risks\", \"costs\", \"resources\"],\n  autoSuggest: true,\n};\n\nconst STORAGE_KEY = \"ai_assistant_settings\";\n\nexport function getAISettings(): AISettings {\n  if (typeof window === 'undefined') {\n    return DEFAULT_SETTINGS;\n  }\n  try {\n    const stored = localStorage.getItem(STORAGE_KEY);\n    if (stored) {\n      return { ...DEFAULT_SETTINGS, ...JSON.parse(stored) };\n    }\n  } catch (error) {\n    console.error(\"Failed to load AI settings:\", error);\n  }\n  return DEFAULT_SETTINGS;\n}\n\nexport function saveAISettings(settings: AISettings): void {\n  if (typeof window === 'undefined') {\n    return;\n  }\n  try {\n    localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));\n  } catch (error) {\n    console.error(\"Failed to save AI settings:\", error);\n  }\n}\n\ninterface AISettingsModalProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  onSettingsChange?: (settings: AISettings) => void;\n}\n\nexport function AISettingsModal({ open, onOpenChange, onSettingsChange }: AISettingsModalProps) {\n  const { toast } = useToast();\n  const [settings, setSettings] = useState<AISettings>(getAISettings);\n\n  useEffect(() => {\n    if (open) {\n      setSettings(getAISettings());\n    }\n  }, [open]);\n\n  const focusAreaOptions = [\n    { id: \"tasks\", label: \"Tasks & WBS\" },\n    { id: \"risks\", label: \"Risk Management\" },\n    { id: \"issues\", label: \"Issue Tracking\" },\n    { id: \"costs\", label: \"Cost & Budget\" },\n    { id: \"resources\", label: \"Resources\" },\n    { id: \"stakeholders\", label: \"Stakeholders\" },\n    { id: \"schedule\", label: \"Schedule & Milestones\" },\n  ];\n\n  const handleFocusAreaToggle = (areaId: string) => {\n    setSettings((prev) => ({\n      ...prev,\n      focusAreas: prev.focusAreas.includes(areaId)\n        ? prev.focusAreas.filter((a) => a !== areaId)\n        : [...prev.focusAreas, areaId],\n    }));\n  };\n\n  const handleSave = () => {\n    saveAISettings(settings);\n    onSettingsChange?.(settings);\n    toast({ title: \"Settings saved\", description: \"AI Assistant preferences updated\" });\n    onOpenChange(false);\n  };\n\n  const handleReset = () => {\n    setSettings(DEFAULT_SETTINGS);\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-md\">\n        <DialogHeader>\n          <DialogTitle data-testid=\"text-settings-dialog-title\">AI Assistant Settings</DialogTitle>\n          <DialogDescription data-testid=\"text-settings-dialog-description\">\n            Customize how the AI Assistant responds to your queries.\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-6 py-4\">\n          {/* Personality */}\n          <div className=\"space-y-3\">\n            <Label className=\"text-sm font-medium\">Response Style</Label>\n            <RadioGroup\n              value={settings.personality}\n              onValueChange={(value) =>\n                setSettings((prev) => ({ ...prev, personality: value as AISettings[\"personality\"] }))\n              }\n              className=\"grid grid-cols-3 gap-2\"\n            >\n              <div>\n                <RadioGroupItem\n                  value=\"professional\"\n                  id=\"professional\"\n                  className=\"peer sr-only\"\n                  data-testid=\"radio-professional\"\n                />\n                <Label\n                  htmlFor=\"professional\"\n                  className=\"flex flex-col items-center justify-center rounded-md border-2 border-muted bg-popover p-3 hover:bg-accent hover:text-accent-foreground peer-data-[state=checked]:border-primary [&:has([data-state=checked])]:border-primary cursor-pointer\"\n                >\n                  <span className=\"text-sm font-medium\">Professional</span>\n                  <span className=\"text-xs text-muted-foreground\">Formal tone</span>\n                </Label>\n              </div>\n              <div>\n                <RadioGroupItem\n                  value=\"friendly\"\n                  id=\"friendly\"\n                  className=\"peer sr-only\"\n                  data-testid=\"radio-friendly\"\n                />\n                <Label\n                  htmlFor=\"friendly\"\n                  className=\"flex flex-col items-center justify-center rounded-md border-2 border-muted bg-popover p-3 hover:bg-accent hover:text-accent-foreground peer-data-[state=checked]:border-primary [&:has([data-state=checked])]:border-primary cursor-pointer\"\n                >\n                  <span className=\"text-sm font-medium\">Friendly</span>\n                  <span className=\"text-xs text-muted-foreground\">Casual tone</span>\n                </Label>\n              </div>\n              <div>\n                <RadioGroupItem\n                  value=\"technical\"\n                  id=\"technical\"\n                  className=\"peer sr-only\"\n                  data-testid=\"radio-technical\"\n                />\n                <Label\n                  htmlFor=\"technical\"\n                  className=\"flex flex-col items-center justify-center rounded-md border-2 border-muted bg-popover p-3 hover:bg-accent hover:text-accent-foreground peer-data-[state=checked]:border-primary [&:has([data-state=checked])]:border-primary cursor-pointer\"\n                >\n                  <span className=\"text-sm font-medium\">Technical</span>\n                  <span className=\"text-xs text-muted-foreground\">Detailed data</span>\n                </Label>\n              </div>\n            </RadioGroup>\n          </div>\n\n          {/* Verbosity */}\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center justify-between\">\n              <Label className=\"text-sm font-medium\">Response Length</Label>\n              <span className=\"text-xs text-muted-foreground\">\n                {settings.verbosity < 33 ? \"Concise\" : settings.verbosity < 66 ? \"Balanced\" : \"Detailed\"}\n              </span>\n            </div>\n            <Slider\n              value={[settings.verbosity]}\n              onValueChange={([value]) => setSettings((prev) => ({ ...prev, verbosity: value }))}\n              max={100}\n              step={1}\n              className=\"w-full\"\n              data-testid=\"slider-verbosity\"\n            />\n            <div className=\"flex justify-between text-xs text-muted-foreground\">\n              <span>Brief</span>\n              <span>Comprehensive</span>\n            </div>\n          </div>\n\n          {/* Focus Areas */}\n          <div className=\"space-y-3\">\n            <Label className=\"text-sm font-medium\">Focus Areas</Label>\n            <p className=\"text-xs text-muted-foreground\">\n              AI will prioritize these areas when analyzing your project\n            </p>\n            <div className=\"grid grid-cols-2 gap-2\">\n              {focusAreaOptions.map((area) => (\n                <div key={area.id} className=\"flex items-center space-x-2\">\n                  <Checkbox\n                    id={area.id}\n                    checked={settings.focusAreas.includes(area.id)}\n                    onCheckedChange={() => handleFocusAreaToggle(area.id)}\n                    data-testid={`checkbox-focus-${area.id}`}\n                  />\n                  <Label htmlFor={area.id} className=\"text-sm cursor-pointer\">\n                    {area.label}\n                  </Label>\n                </div>\n              ))}\n            </div>\n          </div>\n\n          {/* Auto-suggest */}\n          <div className=\"flex items-center space-x-2\">\n            <Checkbox\n              id=\"autoSuggest\"\n              checked={settings.autoSuggest}\n              onCheckedChange={(checked) =>\n                setSettings((prev) => ({ ...prev, autoSuggest: checked === true }))\n              }\n              data-testid=\"checkbox-auto-suggest\"\n            />\n            <Label htmlFor=\"autoSuggest\" className=\"text-sm cursor-pointer\">\n              Show follow-up suggestions after responses\n            </Label>\n          </div>\n        </div>\n\n        <div className=\"flex gap-2 justify-between\">\n          <Button variant=\"outline\" onClick={handleReset} data-testid=\"button-reset-settings\">\n            Reset to Default\n          </Button>\n          <div className=\"flex gap-2\">\n            <Button variant=\"outline\" onClick={() => onOpenChange(false)} data-testid=\"button-cancel-settings\">\n              Cancel\n            </Button>\n            <Button onClick={handleSave} data-testid=\"button-save-settings\">\n              Save Settings\n            </Button>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":9214},"client/src/components/widgets/CostSnapshot.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { \n  DollarSign, TrendingUp, TrendingDown, \n  Target, BarChart3, Gauge\n} from \"lucide-react\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport type { CostItem, Task } from \"@shared/schema\";\n\nfunction GaugeIndicator({ value, label, thresholds }: { \n  value: number; \n  label: string;\n  thresholds: { warning: number; danger: number };\n}) {\n  const getColor = () => {\n    if (value < thresholds.warning) return \"text-green-600 dark:text-green-400\";\n    if (value < thresholds.danger) return \"text-amber-600 dark:text-amber-400\";\n    return \"text-red-600 dark:text-red-400\";\n  };\n\n  const getBgColor = () => {\n    if (value < thresholds.warning) return \"bg-green-100 dark:bg-green-900/30\";\n    if (value < thresholds.danger) return \"bg-amber-100 dark:bg-amber-900/30\";\n    return \"bg-red-100 dark:bg-red-900/30\";\n  };\n\n  return (\n    <div className=\"flex flex-col items-center p-3 rounded-lg bg-muted/50\">\n      <div className={`h-12 w-12 rounded-full flex items-center justify-center ${getBgColor()}`}>\n        <span className={`text-lg font-bold tabular-nums ${getColor()}`}>\n          {value.toFixed(2)}\n        </span>\n      </div>\n      <span className=\"text-xs text-muted-foreground mt-1\">{label}</span>\n    </div>\n  );\n}\n\nexport function CostSnapshot() {\n  const { selectedProjectId, selectedProject } = useProject();\n\n  const { data: costs = [], isLoading: costsLoading } = useQuery<CostItem[]>({\n    queryKey: [\"/api/projects\", selectedProjectId, \"costs\"],\n    enabled: !!selectedProjectId,\n    refetchInterval: 15 * 60 * 1000,\n  });\n\n  const { data: tasks = [], isLoading: tasksLoading } = useQuery<Task[]>({\n    queryKey: [\"/api/projects\", selectedProjectId, \"tasks\"],\n    enabled: !!selectedProjectId,\n    refetchInterval: 15 * 60 * 1000,\n  });\n\n  const isLoading = costsLoading || tasksLoading;\n\n  if (isLoading) {\n    return (\n      <Card data-testid=\"widget-cost-snapshot\">\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-sm flex items-center gap-2\">\n            <DollarSign className=\"h-4 w-4\" />\n            Cost & EVM Snapshot\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-3\">\n          <div className=\"flex gap-2\">\n            <Skeleton className=\"h-20 flex-1 rounded-lg\" />\n            <Skeleton className=\"h-20 flex-1 rounded-lg\" />\n          </div>\n          {[1, 2, 3].map((i) => (\n            <div key={i} className=\"flex items-center justify-between py-1.5\">\n              <Skeleton className=\"h-4 w-24\" />\n              <Skeleton className=\"h-4 w-16\" />\n            </div>\n          ))}\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const totalBudget = parseFloat(selectedProject?.budget || \"0\") || \n    costs.reduce((sum, c) => sum + Number(c.budgeted || 0), 0);\n  const actualCost = costs.reduce((sum, c) => sum + Number(c.actual || 0), 0);\n  const variance = totalBudget - actualCost;\n  const burnPercent = totalBudget > 0 ? (actualCost / totalBudget) * 100 : 0;\n\n  const plannedValue = tasks.reduce((sum, t) => sum + parseFloat(t.baselineCost || \"0\"), 0);\n  const earnedValue = tasks.reduce((sum, t) => sum + parseFloat(t.earnedValue || \"0\"), 0);\n  const actualTaskCost = tasks.reduce((sum, t) => sum + parseFloat(t.actualCost || \"0\"), 0);\n\n  const cpi = actualTaskCost > 0 ? earnedValue / actualTaskCost : 1;\n  const spi = plannedValue > 0 ? earnedValue / plannedValue : 1;\n\n  const eac = cpi > 0 ? totalBudget / cpi : totalBudget;\n  const vac = totalBudget - eac;\n\n  const formatCurrency = (amount: number) => {\n    if (amount >= 1000000) return `$${(amount / 1000000).toFixed(1)}M`;\n    if (amount >= 1000) return `$${(amount / 1000).toFixed(0)}K`;\n    return `$${amount.toFixed(0)}`;\n  };\n\n  return (\n    <Card data-testid=\"widget-cost-snapshot\">\n      <CardHeader className=\"pb-2\">\n        <div className=\"flex items-center justify-between\">\n          <CardTitle className=\"text-sm flex items-center gap-2\">\n            <DollarSign className=\"h-4 w-4\" />\n            Cost & EVM Snapshot\n          </CardTitle>\n          <Badge variant=\"outline\" className=\"text-xs\">\n            {selectedProject?.currency || \"USD\"}\n          </Badge>\n        </div>\n      </CardHeader>\n      <CardContent className=\"space-y-3\">\n        <div className=\"grid grid-cols-2 gap-2\">\n          <GaugeIndicator \n            value={cpi} \n            label=\"CPI\" \n            thresholds={{ warning: 0.95, danger: 0.85 }}\n          />\n          <GaugeIndicator \n            value={spi} \n            label=\"SPI\" \n            thresholds={{ warning: 0.95, danger: 0.85 }}\n          />\n        </div>\n\n        <div className=\"space-y-2\">\n          <div className=\"flex items-center justify-between text-sm\">\n            <span className=\"text-muted-foreground\">Budget Burn</span>\n            <span className=\"font-medium tabular-nums\">{burnPercent.toFixed(1)}%</span>\n          </div>\n          <Progress value={Math.min(burnPercent, 100)} className=\"h-2\" />\n        </div>\n\n        <div className=\"space-y-1 pt-1\">\n          <div className=\"flex items-center justify-between py-1 border-b\">\n            <div className=\"flex items-center gap-2\">\n              <Target className=\"h-3.5 w-3.5 text-muted-foreground\" />\n              <span className=\"text-sm\">Budget</span>\n            </div>\n            <span className=\"text-sm font-semibold tabular-nums\">\n              {formatCurrency(totalBudget)}\n            </span>\n          </div>\n\n          <div className=\"flex items-center justify-between py-1 border-b\">\n            <div className=\"flex items-center gap-2\">\n              <BarChart3 className=\"h-3.5 w-3.5 text-muted-foreground\" />\n              <span className=\"text-sm\">Actual Cost</span>\n            </div>\n            <span className=\"text-sm font-semibold tabular-nums\">\n              {formatCurrency(actualCost)}\n            </span>\n          </div>\n\n          <div className=\"flex items-center justify-between py-1\">\n            <div className=\"flex items-center gap-2\">\n              {variance >= 0 \n                ? <TrendingUp className=\"h-3.5 w-3.5 text-green-500\" />\n                : <TrendingDown className=\"h-3.5 w-3.5 text-red-500\" />\n              }\n              <span className=\"text-sm\">Variance</span>\n            </div>\n            <span className={`text-sm font-semibold tabular-nums ${\n              variance >= 0 \n                ? \"text-green-600 dark:text-green-400\" \n                : \"text-red-600 dark:text-red-400\"\n            }`}>\n              {variance >= 0 ? \"+\" : \"\"}{formatCurrency(variance)}\n            </span>\n          </div>\n        </div>\n\n        {vac !== 0 && (\n          <div className=\"pt-2 border-t\">\n            <div className=\"flex items-center justify-between\">\n              <span className=\"text-xs text-muted-foreground\">Est. at Completion</span>\n              <span className=\"text-sm font-semibold\">{formatCurrency(eac)}</span>\n            </div>\n            <div className=\"flex items-center justify-between\">\n              <span className=\"text-xs text-muted-foreground\">Variance at Completion</span>\n              <span className={`text-sm font-semibold ${\n                vac >= 0 \n                  ? \"text-green-600 dark:text-green-400\" \n                  : \"text-red-600 dark:text-red-400\"\n              }`}>\n                {vac >= 0 ? \"+\" : \"\"}{formatCurrency(vac)}\n              </span>\n            </div>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":7726},"client/src/components/modals/EditResourceModal.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { \n  User, Wrench, Package, DollarSign, Calendar, Clock, \n  Award, Briefcase, Plus, X, Loader2, AlertTriangle\n} from \"lucide-react\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport type { Resource } from \"@shared/schema\";\n\ninterface EditResourceModalProps {\n  resource: Resource | null;\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  onSuccess?: () => void;\n}\n\ninterface PricingModel {\n  name: string;\n  rateType: string;\n  rate: number;\n  unitType: string;\n  currency: string;\n  effectiveFrom?: string;\n  effectiveTo?: string;\n  isDefault?: boolean;\n}\n\ninterface CalendarException {\n  date: string;\n  type: string;\n  note?: string;\n}\n\nconst RESOURCE_TYPES = [\n  { value: \"human\", label: \"Human Resource\", icon: User },\n  { value: \"equipment\", label: \"Equipment\", icon: Wrench },\n  { value: \"material\", label: \"Material\", icon: Package },\n];\n\nconst DISCIPLINES = [\n  { value: \"general\", label: \"General\" },\n  { value: \"civil\", label: \"Civil\" },\n  { value: \"structural\", label: \"Structural\" },\n  { value: \"mechanical\", label: \"Mechanical\" },\n  { value: \"piping\", label: \"Piping\" },\n  { value: \"electrical\", label: \"Electrical\" },\n  { value: \"instrumentation\", label: \"Instrumentation\" },\n  { value: \"process\", label: \"Process\" },\n  { value: \"hvac\", label: \"HVAC\" },\n  { value: \"architectural\", label: \"Architectural\" },\n];\n\nconst RATE_TYPES = [\n  { value: \"per-hour\", label: \"Per Hour (USD/hr)\" },\n  { value: \"per-use\", label: \"Per Use (USD/use)\" },\n  { value: \"per-unit\", label: \"Per Unit (USD/unit)\" },\n];\n\nconst UNIT_TYPES = [\n  { value: \"ea\", label: \"Each (EA)\" },\n  { value: \"lot\", label: \"Lot\" },\n  { value: \"hr\", label: \"Hour (hr)\" },\n  { value: \"day\", label: \"Day\" },\n  { value: \"week\", label: \"Week\" },\n  { value: \"month\", label: \"Month\" },\n  { value: \"m\", label: \"Meter (m)\" },\n  { value: \"ft\", label: \"Feet (ft)\" },\n  { value: \"kg\", label: \"Kilogram (kg)\" },\n  { value: \"lb\", label: \"Pound (lb)\" },\n  { value: \"ton\", label: \"Ton\" },\n];\n\nconst CONTRACT_TYPES = [\n  { value: \"full-time\", label: \"Full-Time Employee\" },\n  { value: \"part-time\", label: \"Part-Time Employee\" },\n  { value: \"contract\", label: \"Contractor\" },\n  { value: \"temporary\", label: \"Temporary\" },\n  { value: \"rental\", label: \"Rental\" },\n  { value: \"purchase\", label: \"Purchase\" },\n  { value: \"lease\", label: \"Lease\" },\n];\n\nconst CURRENCIES = [\n  { value: \"USD\", label: \"USD - US Dollar\" },\n  { value: \"EUR\", label: \"EUR - Euro\" },\n  { value: \"GBP\", label: \"GBP - British Pound\" },\n  { value: \"INR\", label: \"INR - Indian Rupee\" },\n  { value: \"AED\", label: \"AED - UAE Dirham\" },\n  { value: \"SAR\", label: \"SAR - Saudi Riyal\" },\n];\n\nconst AVAILABILITY_STATUSES = [\n  { value: \"available\", label: \"Available\" },\n  { value: \"partially_available\", label: \"Partially Available\" },\n  { value: \"unavailable\", label: \"Unavailable\" },\n  { value: \"on_leave\", label: \"On Leave\" },\n];\n\nconst DAYS_OF_WEEK = [\n  { value: \"monday\", label: \"Mon\" },\n  { value: \"tuesday\", label: \"Tue\" },\n  { value: \"wednesday\", label: \"Wed\" },\n  { value: \"thursday\", label: \"Thu\" },\n  { value: \"friday\", label: \"Fri\" },\n  { value: \"saturday\", label: \"Sat\" },\n  { value: \"sunday\", label: \"Sun\" },\n];\n\nconst MAX_SKILLS = 10;\n\nexport function EditResourceModal({ resource, open, onOpenChange, onSuccess }: EditResourceModalProps) {\n  const { selectedProjectId } = useProject();\n  const { toast } = useToast();\n  const isEditing = !!resource;\n\n  const [formData, setFormData] = useState({\n    name: \"\",\n    type: \"human\",\n    discipline: \"general\",\n    availability: 100,\n    availabilityStatus: \"available\",\n    rate: \"\",\n    rateType: \"per-hour\",\n    unitType: \"hr\",\n    currency: \"USD\",\n    description: \"\",\n    notes: \"\",\n    contractType: \"\",\n    vendorName: \"\",\n    vendorContactEmail: \"\",\n    vendorContactPhone: \"\",\n    contractStartDate: \"\",\n    contractEndDate: \"\",\n    contractReference: \"\",\n    maxHoursPerDay: 8,\n    maxHoursPerWeek: 40,\n    efficiencyRating: \"1.0\",\n    productivityFactor: \"1.0\",\n    qualityScore: \"\",\n  });\n\n  const [skills, setSkills] = useState<string[]>([]);\n  const [newSkill, setNewSkill] = useState(\"\");\n  const [certifications, setCertifications] = useState<string[]>([]);\n  const [newCertification, setNewCertification] = useState(\"\");\n  const [workingDays, setWorkingDays] = useState<string[]>([\"monday\", \"tuesday\", \"wednesday\", \"thursday\", \"friday\"]);\n  const [pricingModels, setPricingModels] = useState<PricingModel[]>([]);\n  const [calendarExceptions, setCalendarExceptions] = useState<CalendarException[]>([]);\n\n  useEffect(() => {\n    if (resource) {\n      setFormData({\n        name: resource.name,\n        type: resource.type,\n        discipline: resource.discipline || \"general\",\n        availability: resource.availability,\n        availabilityStatus: resource.availabilityStatus || \"available\",\n        rate: resource.rate || \"\",\n        rateType: resource.rateType || \"per-hour\",\n        unitType: resource.unitType || \"hr\",\n        currency: resource.currency || \"USD\",\n        description: resource.description || \"\",\n        notes: resource.notes || \"\",\n        contractType: resource.contractType || \"\",\n        vendorName: resource.vendorName || \"\",\n        vendorContactEmail: resource.vendorContactEmail || \"\",\n        vendorContactPhone: resource.vendorContactPhone || \"\",\n        contractStartDate: resource.contractStartDate ? new Date(resource.contractStartDate).toISOString().split(\"T\")[0] : \"\",\n        contractEndDate: resource.contractEndDate ? new Date(resource.contractEndDate).toISOString().split(\"T\")[0] : \"\",\n        contractReference: resource.contractReference || \"\",\n        maxHoursPerDay: resource.maxHoursPerDay || 8,\n        maxHoursPerWeek: resource.maxHoursPerWeek || 40,\n        efficiencyRating: resource.efficiencyRating || \"1.0\",\n        productivityFactor: resource.productivityFactor || \"1.0\",\n        qualityScore: resource.qualityScore?.toString() || \"\",\n      });\n\n      const resourceSkills = (resource.skillsArray as string[] | null) || \n        (resource.skills?.split(\",\").map(s => s.trim()).filter(Boolean) || []);\n      setSkills(resourceSkills);\n      \n      setCertifications((resource.certifications as string[] | null) || []);\n      setWorkingDays((resource.workingDays as string[] | null) || [\"monday\", \"tuesday\", \"wednesday\", \"thursday\", \"friday\"]);\n      setPricingModels((resource.pricingModels as PricingModel[] | null) || []);\n      setCalendarExceptions((resource.calendarExceptions as CalendarException[] | null) || []);\n    } else {\n      resetForm();\n    }\n  }, [resource, open]);\n\n  const resetForm = () => {\n    setFormData({\n      name: \"\",\n      type: \"human\",\n      discipline: \"general\",\n      availability: 100,\n      availabilityStatus: \"available\",\n      rate: \"\",\n      rateType: \"per-hour\",\n      unitType: \"hr\",\n      currency: \"USD\",\n      description: \"\",\n      notes: \"\",\n      contractType: \"\",\n      vendorName: \"\",\n      vendorContactEmail: \"\",\n      vendorContactPhone: \"\",\n      contractStartDate: \"\",\n      contractEndDate: \"\",\n      contractReference: \"\",\n      maxHoursPerDay: 8,\n      maxHoursPerWeek: 40,\n      efficiencyRating: \"1.0\",\n      productivityFactor: \"1.0\",\n      qualityScore: \"\",\n    });\n    setSkills([]);\n    setNewSkill(\"\");\n    setCertifications([]);\n    setNewCertification(\"\");\n    setWorkingDays([\"monday\", \"tuesday\", \"wednesday\", \"thursday\", \"friday\"]);\n    setPricingModels([]);\n    setCalendarExceptions([]);\n  };\n\n  const createMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return await apiRequest(\"POST\", \"/api/resources\", {\n        ...data,\n        projectId: selectedProjectId,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/projects\", selectedProjectId, \"resources\"] });\n      toast({ title: \"Success\", description: \"Resource created successfully\" });\n      onOpenChange(false);\n      onSuccess?.();\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message || \"Failed to create resource\", variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: number; data: any }) => {\n      return await apiRequest(\"PATCH\", `/api/resources/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/projects\", selectedProjectId, \"resources\"] });\n      toast({ title: \"Success\", description: \"Resource updated successfully\" });\n      onOpenChange(false);\n      onSuccess?.();\n    },\n    onError: (error: Error) => {\n      toast({ title: \"Error\", description: error.message || \"Failed to update resource\", variant: \"destructive\" });\n    },\n  });\n\n  const handleAddSkill = () => {\n    if (newSkill.trim() && skills.length < MAX_SKILLS && !skills.includes(newSkill.trim())) {\n      setSkills([...skills, newSkill.trim()]);\n      setNewSkill(\"\");\n    }\n  };\n\n  const handleRemoveSkill = (skillToRemove: string) => {\n    setSkills(skills.filter(s => s !== skillToRemove));\n  };\n\n  const handleAddCertification = () => {\n    if (newCertification.trim() && !certifications.includes(newCertification.trim())) {\n      setCertifications([...certifications, newCertification.trim()]);\n      setNewCertification(\"\");\n    }\n  };\n\n  const handleRemoveCertification = (certToRemove: string) => {\n    setCertifications(certifications.filter(c => c !== certToRemove));\n  };\n\n  const handleToggleWorkingDay = (day: string) => {\n    if (workingDays.includes(day)) {\n      setWorkingDays(workingDays.filter(d => d !== day));\n    } else {\n      setWorkingDays([...workingDays, day]);\n    }\n  };\n\n  const handleAddPricingModel = () => {\n    setPricingModels([...pricingModels, {\n      name: `Rate ${pricingModels.length + 1}`,\n      rateType: \"per-hour\",\n      rate: 0,\n      unitType: \"hr\",\n      currency: \"USD\",\n      isDefault: pricingModels.length === 0,\n    }]);\n  };\n\n  const handleUpdatePricingModel = (index: number, updates: Partial<PricingModel>) => {\n    const updated = [...pricingModels];\n    updated[index] = { ...updated[index], ...updates };\n    setPricingModels(updated);\n  };\n\n  const handleRemovePricingModel = (index: number) => {\n    setPricingModels(pricingModels.filter((_, i) => i !== index));\n  };\n\n  const handleSave = () => {\n    if (!formData.name.trim()) {\n      toast({ title: \"Validation Error\", description: \"Resource name is required\", variant: \"destructive\" });\n      return;\n    }\n\n    const data = {\n      name: formData.name,\n      type: formData.type,\n      discipline: formData.discipline,\n      availability: formData.availability,\n      availabilityStatus: formData.availabilityStatus,\n      rate: formData.rate || null,\n      rateType: formData.rateType,\n      unitType: formData.unitType,\n      currency: formData.currency,\n      description: formData.description || null,\n      notes: formData.notes || null,\n      contractType: formData.contractType || null,\n      vendorName: formData.vendorName || null,\n      vendorContactEmail: formData.vendorContactEmail || null,\n      vendorContactPhone: formData.vendorContactPhone || null,\n      contractStartDate: formData.contractStartDate || null,\n      contractEndDate: formData.contractEndDate || null,\n      contractReference: formData.contractReference || null,\n      maxHoursPerDay: formData.maxHoursPerDay,\n      maxHoursPerWeek: formData.maxHoursPerWeek,\n      efficiencyRating: formData.efficiencyRating,\n      productivityFactor: formData.productivityFactor,\n      qualityScore: formData.qualityScore ? parseInt(formData.qualityScore) : null,\n      skillsArray: skills.length > 0 ? skills : null,\n      skills: skills.length > 0 ? skills.join(\", \") : null,\n      certifications: certifications.length > 0 ? certifications : null,\n      workingDays: workingDays.length > 0 ? workingDays : null,\n      pricingModels: pricingModels.length > 0 ? pricingModels : null,\n      calendarExceptions: calendarExceptions.length > 0 ? calendarExceptions : null,\n    };\n\n    if (isEditing && resource) {\n      updateMutation.mutate({ id: resource.id, data });\n    } else {\n      createMutation.mutate(data);\n    }\n  };\n\n  const isPending = createMutation.isPending || updateMutation.isPending;\n  const TypeIcon = RESOURCE_TYPES.find(t => t.value === formData.type)?.icon || User;\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent \n        className=\"max-w-3xl max-h-[90vh]\" \n        data-testid=\"modal-edit-resource\"\n        aria-describedby=\"edit-resource-description\"\n      >\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-3\">\n            <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center\">\n              <TypeIcon className=\"h-5 w-5\" />\n            </div>\n            {isEditing ? \"Edit Resource\" : \"Add Resource\"}\n          </DialogTitle>\n        </DialogHeader>\n\n        <p id=\"edit-resource-description\" className=\"sr-only\">\n          Form to {isEditing ? \"edit\" : \"add\"} a resource\n        </p>\n\n        <ScrollArea className=\"h-[65vh]\">\n          <Tabs defaultValue=\"basic\" className=\"w-full\">\n            <TabsList className=\"grid w-full grid-cols-5\">\n              <TabsTrigger value=\"basic\" data-testid=\"tab-basic\">Basic</TabsTrigger>\n              <TabsTrigger value=\"pricing\" data-testid=\"tab-pricing\">Pricing</TabsTrigger>\n              <TabsTrigger value=\"skills\" data-testid=\"tab-skills\">Skills</TabsTrigger>\n              <TabsTrigger value=\"contract\" data-testid=\"tab-contract\">Contract</TabsTrigger>\n              <TabsTrigger value=\"capacity\" data-testid=\"tab-capacity\">Capacity</TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"basic\" className=\"mt-4 space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"name\">Name *</Label>\n                <Input\n                  id=\"name\"\n                  placeholder=\"Enter resource name\"\n                  value={formData.name}\n                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                  data-testid=\"input-resource-name\"\n                />\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label>Type</Label>\n                  <Select value={formData.type} onValueChange={(v) => setFormData({ ...formData, type: v })}>\n                    <SelectTrigger data-testid=\"select-type\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {RESOURCE_TYPES.map((type) => (\n                        <SelectItem key={type.value} value={type.value}>\n                          <div className=\"flex items-center gap-2\">\n                            <type.icon className=\"h-4 w-4\" />\n                            {type.label}\n                          </div>\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label>Discipline</Label>\n                  <Select value={formData.discipline} onValueChange={(v) => setFormData({ ...formData, discipline: v })}>\n                    <SelectTrigger data-testid=\"select-discipline\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {DISCIPLINES.map((disc) => (\n                        <SelectItem key={disc.value} value={disc.value}>{disc.label}</SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label>Availability ({formData.availability}%)</Label>\n                  <Input\n                    type=\"range\"\n                    min={0}\n                    max={100}\n                    value={formData.availability}\n                    onChange={(e) => setFormData({ ...formData, availability: parseInt(e.target.value) })}\n                    data-testid=\"input-availability\"\n                  />\n                  <Progress value={formData.availability} className=\"h-2\" />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label>Status</Label>\n                  <Select value={formData.availabilityStatus} onValueChange={(v) => setFormData({ ...formData, availabilityStatus: v })}>\n                    <SelectTrigger data-testid=\"select-status\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {AVAILABILITY_STATUSES.map((status) => (\n                        <SelectItem key={status.value} value={status.value}>{status.label}</SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label>Description</Label>\n                <Textarea\n                  placeholder=\"Enter description\"\n                  value={formData.description}\n                  onChange={(e) => setFormData({ ...formData, description: e.target.value })}\n                  className=\"resize-none\"\n                  rows={3}\n                  data-testid=\"input-description\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label>Notes</Label>\n                <Textarea\n                  placeholder=\"Additional notes\"\n                  value={formData.notes}\n                  onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n                  className=\"resize-none\"\n                  rows={2}\n                  data-testid=\"input-notes\"\n                />\n              </div>\n            </TabsContent>\n\n            <TabsContent value=\"pricing\" className=\"mt-4 space-y-4\">\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-sm flex items-center gap-2\">\n                    <DollarSign className=\"h-4 w-4\" />\n                    Primary Rate\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  <div className=\"grid grid-cols-3 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label>Rate</Label>\n                      <Input\n                        type=\"number\"\n                        step=\"0.01\"\n                        placeholder=\"0.00\"\n                        value={formData.rate}\n                        onChange={(e) => setFormData({ ...formData, rate: e.target.value })}\n                        data-testid=\"input-rate\"\n                      />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label>Rate Type</Label>\n                      <Select value={formData.rateType} onValueChange={(v) => setFormData({ ...formData, rateType: v })}>\n                        <SelectTrigger data-testid=\"select-rate-type\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {RATE_TYPES.map((rt) => (\n                            <SelectItem key={rt.value} value={rt.value}>{rt.label}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label>Currency</Label>\n                      <Select value={formData.currency} onValueChange={(v) => setFormData({ ...formData, currency: v })}>\n                        <SelectTrigger data-testid=\"select-currency\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {CURRENCIES.map((c) => (\n                            <SelectItem key={c.value} value={c.value}>{c.label}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                  </div>\n\n                  {formData.rateType === \"per-unit\" && (\n                    <div className=\"space-y-2\">\n                      <Label>Unit Type</Label>\n                      <Select value={formData.unitType} onValueChange={(v) => setFormData({ ...formData, unitType: v })}>\n                        <SelectTrigger data-testid=\"select-unit-type\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {UNIT_TYPES.map((ut) => (\n                            <SelectItem key={ut.value} value={ut.value}>{ut.label}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <div className=\"flex items-center justify-between\">\n                    <CardTitle className=\"text-sm flex items-center gap-2\">\n                      <DollarSign className=\"h-4 w-4\" />\n                      Additional Pricing Models\n                    </CardTitle>\n                    <Button variant=\"outline\" size=\"sm\" onClick={handleAddPricingModel} data-testid=\"button-add-pricing-model\">\n                      <Plus className=\"h-4 w-4 mr-1\" />\n                      Add\n                    </Button>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  {pricingModels.length === 0 ? (\n                    <p className=\"text-sm text-muted-foreground text-center py-4\">\n                      No additional pricing models\n                    </p>\n                  ) : (\n                    <div className=\"space-y-3\">\n                      {pricingModels.map((model, index) => (\n                        <div key={index} className=\"p-3 rounded-lg border space-y-3\" data-testid={`pricing-model-${index}`}>\n                          <div className=\"flex items-center justify-between\">\n                            <Input\n                              placeholder=\"Rate name\"\n                              value={model.name}\n                              onChange={(e) => handleUpdatePricingModel(index, { name: e.target.value })}\n                              className=\"w-48\"\n                            />\n                            <Button variant=\"ghost\" size=\"icon\" onClick={() => handleRemovePricingModel(index)}>\n                              <X className=\"h-4 w-4\" />\n                            </Button>\n                          </div>\n                          <div className=\"grid grid-cols-3 gap-2\">\n                            <Input\n                              type=\"number\"\n                              step=\"0.01\"\n                              placeholder=\"Rate\"\n                              value={model.rate}\n                              onChange={(e) => handleUpdatePricingModel(index, { rate: parseFloat(e.target.value) || 0 })}\n                            />\n                            <Select value={model.rateType} onValueChange={(v) => handleUpdatePricingModel(index, { rateType: v })}>\n                              <SelectTrigger>\n                                <SelectValue />\n                              </SelectTrigger>\n                              <SelectContent>\n                                {RATE_TYPES.map((rt) => (\n                                  <SelectItem key={rt.value} value={rt.value}>{rt.label}</SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                            <Select value={model.currency} onValueChange={(v) => handleUpdatePricingModel(index, { currency: v })}>\n                              <SelectTrigger>\n                                <SelectValue />\n                              </SelectTrigger>\n                              <SelectContent>\n                                {CURRENCIES.map((c) => (\n                                  <SelectItem key={c.value} value={c.value}>{c.value}</SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"skills\" className=\"mt-4 space-y-4\">\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-sm flex items-center gap-2\">\n                    <Award className=\"h-4 w-4\" />\n                    Skills ({skills.length}/{MAX_SKILLS})\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <div className=\"flex gap-2\">\n                    <Input\n                      placeholder=\"Add a skill\"\n                      value={newSkill}\n                      onChange={(e) => setNewSkill(e.target.value)}\n                      onKeyDown={(e) => e.key === \"Enter\" && (e.preventDefault(), handleAddSkill())}\n                      disabled={skills.length >= MAX_SKILLS}\n                      data-testid=\"input-new-skill\"\n                    />\n                    <Button \n                      variant=\"outline\" \n                      onClick={handleAddSkill} \n                      disabled={skills.length >= MAX_SKILLS || !newSkill.trim()}\n                      data-testid=\"button-add-skill\"\n                    >\n                      <Plus className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                  \n                  {skills.length > 0 && (\n                    <div className=\"flex flex-wrap gap-2\">\n                      {skills.map((skill) => (\n                        <Badge key={skill} variant=\"secondary\" className=\"gap-1 pr-1\">\n                          {skill}\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            className=\"h-4 w-4 p-0 ml-1\"\n                            onClick={() => handleRemoveSkill(skill)}\n                          >\n                            <X className=\"h-3 w-3\" />\n                          </Button>\n                        </Badge>\n                      ))}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-sm flex items-center gap-2\">\n                    <Award className=\"h-4 w-4\" />\n                    Certifications\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <div className=\"flex gap-2\">\n                    <Input\n                      placeholder=\"Add a certification\"\n                      value={newCertification}\n                      onChange={(e) => setNewCertification(e.target.value)}\n                      onKeyDown={(e) => e.key === \"Enter\" && (e.preventDefault(), handleAddCertification())}\n                      data-testid=\"input-new-certification\"\n                    />\n                    <Button \n                      variant=\"outline\" \n                      onClick={handleAddCertification} \n                      disabled={!newCertification.trim()}\n                      data-testid=\"button-add-certification\"\n                    >\n                      <Plus className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                  \n                  {certifications.length > 0 && (\n                    <div className=\"flex flex-wrap gap-2\">\n                      {certifications.map((cert) => (\n                        <Badge key={cert} variant=\"outline\" className=\"gap-1 pr-1\">\n                          {cert}\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            className=\"h-4 w-4 p-0 ml-1\"\n                            onClick={() => handleRemoveCertification(cert)}\n                          >\n                            <X className=\"h-3 w-3\" />\n                          </Button>\n                        </Badge>\n                      ))}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"contract\" className=\"mt-4 space-y-4\">\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-sm flex items-center gap-2\">\n                    <Briefcase className=\"h-4 w-4\" />\n                    Contract Details\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label>Contract Type</Label>\n                      <Select value={formData.contractType} onValueChange={(v) => setFormData({ ...formData, contractType: v })}>\n                        <SelectTrigger data-testid=\"select-contract-type\">\n                          <SelectValue placeholder=\"Select type\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {CONTRACT_TYPES.map((ct) => (\n                            <SelectItem key={ct.value} value={ct.value}>{ct.label}</SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label>Contract Reference</Label>\n                      <Input\n                        placeholder=\"e.g., CTR-2024-001\"\n                        value={formData.contractReference}\n                        onChange={(e) => setFormData({ ...formData, contractReference: e.target.value })}\n                        data-testid=\"input-contract-reference\"\n                      />\n                    </div>\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label>Contract Start</Label>\n                      <Input\n                        type=\"date\"\n                        value={formData.contractStartDate}\n                        onChange={(e) => setFormData({ ...formData, contractStartDate: e.target.value })}\n                        data-testid=\"input-contract-start\"\n                      />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label>Contract End</Label>\n                      <Input\n                        type=\"date\"\n                        value={formData.contractEndDate}\n                        onChange={(e) => setFormData({ ...formData, contractEndDate: e.target.value })}\n                        data-testid=\"input-contract-end\"\n                      />\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-sm\">Vendor Information</CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  <div className=\"space-y-2\">\n                    <Label>Vendor Name</Label>\n                    <Input\n                      placeholder=\"Vendor company name\"\n                      value={formData.vendorName}\n                      onChange={(e) => setFormData({ ...formData, vendorName: e.target.value })}\n                      data-testid=\"input-vendor-name\"\n                    />\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label>Contact Email</Label>\n                      <Input\n                        type=\"email\"\n                        placeholder=\"vendor@example.com\"\n                        value={formData.vendorContactEmail}\n                        onChange={(e) => setFormData({ ...formData, vendorContactEmail: e.target.value })}\n                        data-testid=\"input-vendor-email\"\n                      />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label>Contact Phone</Label>\n                      <Input\n                        type=\"tel\"\n                        placeholder=\"+1 234 567 8900\"\n                        value={formData.vendorContactPhone}\n                        onChange={(e) => setFormData({ ...formData, vendorContactPhone: e.target.value })}\n                        data-testid=\"input-vendor-phone\"\n                      />\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"capacity\" className=\"mt-4 space-y-4\">\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-sm flex items-center gap-2\">\n                    <Clock className=\"h-4 w-4\" />\n                    Working Hours\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label>Max Hours/Day</Label>\n                      <Input\n                        type=\"number\"\n                        min={1}\n                        max={24}\n                        value={formData.maxHoursPerDay}\n                        onChange={(e) => setFormData({ ...formData, maxHoursPerDay: parseInt(e.target.value) || 8 })}\n                        data-testid=\"input-max-hours-day\"\n                      />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label>Max Hours/Week</Label>\n                      <Input\n                        type=\"number\"\n                        min={1}\n                        max={168}\n                        value={formData.maxHoursPerWeek}\n                        onChange={(e) => setFormData({ ...formData, maxHoursPerWeek: parseInt(e.target.value) || 40 })}\n                        data-testid=\"input-max-hours-week\"\n                      />\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-sm flex items-center gap-2\">\n                    <Calendar className=\"h-4 w-4\" />\n                    Working Days\n                  </CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"flex gap-2\">\n                    {DAYS_OF_WEEK.map((day) => (\n                      <Button\n                        key={day.value}\n                        variant={workingDays.includes(day.value) ? \"default\" : \"outline\"}\n                        size=\"sm\"\n                        className=\"flex-1\"\n                        onClick={() => handleToggleWorkingDay(day.value)}\n                        data-testid={`button-day-${day.value}`}\n                      >\n                        {day.label}\n                      </Button>\n                    ))}\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-sm\">Efficiency & Productivity</CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  <div className=\"grid grid-cols-3 gap-4\">\n                    <div className=\"space-y-2\">\n                      <Label>Efficiency Rating (0.5-2.0)</Label>\n                      <Input\n                        type=\"number\"\n                        step=\"0.1\"\n                        min=\"0.5\"\n                        max=\"2.0\"\n                        value={formData.efficiencyRating}\n                        onChange={(e) => setFormData({ ...formData, efficiencyRating: e.target.value })}\n                        data-testid=\"input-efficiency\"\n                      />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label>Productivity Factor</Label>\n                      <Input\n                        type=\"number\"\n                        step=\"0.1\"\n                        min=\"0.5\"\n                        max=\"2.0\"\n                        value={formData.productivityFactor}\n                        onChange={(e) => setFormData({ ...formData, productivityFactor: e.target.value })}\n                        data-testid=\"input-productivity\"\n                      />\n                    </div>\n\n                    <div className=\"space-y-2\">\n                      <Label>Quality Score (1-100)</Label>\n                      <Input\n                        type=\"number\"\n                        min=\"1\"\n                        max=\"100\"\n                        value={formData.qualityScore}\n                        onChange={(e) => setFormData({ ...formData, qualityScore: e.target.value })}\n                        data-testid=\"input-quality-score\"\n                      />\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            </TabsContent>\n          </Tabs>\n        </ScrollArea>\n\n        <DialogFooter className=\"gap-2\">\n          <Button variant=\"outline\" onClick={() => onOpenChange(false)} disabled={isPending}>\n            Cancel\n          </Button>\n          <Button onClick={handleSave} disabled={isPending} data-testid=\"button-save-resource\">\n            {isPending && <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />}\n            {isEditing ? \"Update\" : \"Create\"} Resource\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":39487},"client/src/contexts/PageContext.tsx":{"content":"import { createContext, useContext, useEffect, useState } from \"react\";\nimport { useLocation } from \"wouter\";\n\nexport type PageModule = \n  | \"dashboard\"\n  | \"wbs\"\n  | \"gantt\"\n  | \"kanban\"\n  | \"calendar\"\n  | \"stakeholders\"\n  | \"resources\"\n  | \"risks\"\n  | \"issues\"\n  | \"change-requests\"\n  | \"cost\"\n  | \"analytics\"\n  | \"documents\"\n  | \"reports\"\n  | \"email-templates\"\n  | \"ai-assistant\"\n  | \"settings\"\n  | \"admin\"\n  | \"pmo\";\n\nexport interface PageContextType {\n  currentPage: PageModule;\n  pageTitle: string;\n  isScheduleRelated: boolean;\n  isCostRelated: boolean;\n  isRiskRelated: boolean;\n  isResourceRelated: boolean;\n  isDocumentRelated: boolean;\n  showPortfolioSignals: boolean;\n  showUpcomingEvents: boolean;\n  showCadencePlaybook: boolean;\n  showResourceSnapshot: boolean;\n  showRiskSnapshot: boolean;\n  showCostSnapshot: boolean;\n  showWBSLinkage: boolean;\n  showAIAssistantGuide: boolean;\n  showDocumentStats: boolean;\n  showDocumentDetails: boolean;\n}\n\nconst PageContext = createContext<PageContextType | undefined>(undefined);\n\nconst PAGE_CONFIG: Record<PageModule, { \n  title: string; \n  schedule?: boolean; \n  cost?: boolean; \n  risk?: boolean; \n  resource?: boolean;\n  document?: boolean;\n}> = {\n  \"dashboard\": { title: \"Dashboard\", schedule: true, cost: true, risk: true, resource: true },\n  \"wbs\": { title: \"Work Breakdown Structure\", schedule: true },\n  \"gantt\": { title: \"Gantt Chart\", schedule: true },\n  \"kanban\": { title: \"Kanban Board\", schedule: true },\n  \"calendar\": { title: \"Calendar\", schedule: true },\n  \"stakeholders\": { title: \"Stakeholders\" },\n  \"resources\": { title: \"Resources\", resource: true },\n  \"risks\": { title: \"Risk Register\", risk: true },\n  \"issues\": { title: \"Issue Log\", risk: true },\n  \"change-requests\": { title: \"Change Requests\" },\n  \"cost\": { title: \"Cost Management\", cost: true },\n  \"analytics\": { title: \"Analytics\", cost: true, schedule: true },\n  \"documents\": { title: \"Documents\", document: true },\n  \"reports\": { title: \"Reports\" },\n  \"email-templates\": { title: \"Email Templates\" },\n  \"ai-assistant\": { title: \"AI Assistant\" },\n  \"settings\": { title: \"Settings\" },\n  \"admin\": { title: \"Admin Dashboard\" },\n  \"pmo\": { title: \"PMO\" },\n};\n\nfunction getPageModuleFromPath(path: string): PageModule {\n  const segment = path.split(\"/\")[1] || \"dashboard\";\n  \n  if (segment === \"\" || segment === \"/\") return \"dashboard\";\n  if (segment.startsWith(\"pmo\")) return \"pmo\";\n  \n  const validPages: PageModule[] = [\n    \"dashboard\", \"wbs\", \"gantt\", \"kanban\", \"calendar\", \"stakeholders\",\n    \"resources\", \"risks\", \"issues\", \"change-requests\", \"cost\", \"analytics\",\n    \"documents\", \"reports\", \"email-templates\", \"ai-assistant\", \"settings\", \"admin\"\n  ];\n  \n  return validPages.includes(segment as PageModule) ? (segment as PageModule) : \"dashboard\";\n}\n\nexport function PageProvider({ children }: { children: React.ReactNode }) {\n  const [location] = useLocation();\n  const [currentPage, setCurrentPage] = useState<PageModule>(\"dashboard\");\n\n  useEffect(() => {\n    const page = getPageModuleFromPath(location);\n    setCurrentPage(page);\n  }, [location]);\n\n  const config = PAGE_CONFIG[currentPage] || PAGE_CONFIG.dashboard;\n\n  const value: PageContextType = {\n    currentPage,\n    pageTitle: config.title,\n    isScheduleRelated: !!config.schedule,\n    isCostRelated: !!config.cost,\n    isRiskRelated: !!config.risk,\n    isResourceRelated: !!config.resource,\n    isDocumentRelated: !!config.document,\n    showPortfolioSignals: currentPage === \"dashboard\" || currentPage === \"analytics\",\n    showUpcomingEvents: [\"dashboard\", \"calendar\", \"gantt\", \"wbs\"].includes(currentPage),\n    showCadencePlaybook: [\"dashboard\", \"reports\"].includes(currentPage),\n    showResourceSnapshot: [\"dashboard\", \"resources\", \"wbs\", \"gantt\"].includes(currentPage),\n    showRiskSnapshot: [\"dashboard\", \"risks\", \"issues\"].includes(currentPage),\n    showCostSnapshot: [\"dashboard\", \"cost\", \"analytics\"].includes(currentPage),\n    showWBSLinkage: [\"wbs\", \"gantt\", \"kanban\", \"risks\", \"issues\", \"stakeholders\"].includes(currentPage),\n    showAIAssistantGuide: currentPage === \"ai-assistant\",\n    showDocumentStats: currentPage === \"documents\",\n    showDocumentDetails: currentPage === \"documents\",\n  };\n\n  return (\n    <PageContext.Provider value={value}>\n      {children}\n    </PageContext.Provider>\n  );\n}\n\nexport function usePage() {\n  const context = useContext(PageContext);\n  if (context === undefined) {\n    throw new Error(\"usePage must be used within a PageProvider\");\n  }\n  return context;\n}\n","size_bytes":4505},"client/src/components/widgets/ContextAwareRightRail.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Button } from \"@/components/ui/button\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { \n  ChevronLeft, ChevronRight, PanelRightClose, \n  PanelRight, Maximize2, Minimize2 \n} from \"lucide-react\";\nimport { usePage } from \"@/contexts/PageContext\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { useIsMobile } from \"@/hooks/use-mobile\";\n\nimport { PortfolioSignals } from \"./PortfolioSignals\";\nimport { UpcomingEvents, EventLegend } from \"./UpcomingEvents\";\nimport { CadencePlaybook, ReviewsWidget } from \"./CadencePlaybook\";\nimport { ResourceSnapshot } from \"./ResourceSnapshot\";\nimport { RiskSnapshot } from \"./RiskSnapshot\";\nimport { CostSnapshot } from \"./CostSnapshot\";\nimport { WBSLinkage } from \"./WBSLinkage\";\nimport { AIAssistantGuide } from \"./AIAssistantGuide\";\nimport { DocumentStats } from \"./DocumentStats\";\nimport { DocumentDetails } from \"./DocumentDetails\";\n\ninterface ContextAwareRightRailProps {\n  className?: string;\n}\n\nexport function ContextAwareRightRail({ className }: ContextAwareRightRailProps) {\n  const { selectedProjectId } = useProject();\n  const {\n    currentPage,\n    showPortfolioSignals,\n    showUpcomingEvents,\n    showCadencePlaybook,\n    showResourceSnapshot,\n    showRiskSnapshot,\n    showCostSnapshot,\n    showWBSLinkage,\n    showAIAssistantGuide,\n    showDocumentStats,\n    showDocumentDetails,\n  } = usePage();\n\n  const isMobile = useIsMobile();\n  const [isCollapsed, setIsCollapsed] = useState(false);\n  const [isExpanded, setIsExpanded] = useState(false);\n\n  useEffect(() => {\n    if (isMobile) {\n      setIsCollapsed(true);\n    }\n  }, [isMobile]);\n\n  if (!selectedProjectId) {\n    return (\n      <aside \n        className={`w-80 border-l bg-background p-4 ${className}`}\n        data-testid=\"sidebar-right\"\n        aria-label=\"Context sidebar\"\n      >\n        <div className=\"flex items-center justify-center h-32 text-center\">\n          <p className=\"text-sm text-muted-foreground\">\n            Select a project to view insights\n          </p>\n        </div>\n      </aside>\n    );\n  }\n\n  if (isCollapsed) {\n    return (\n      <aside \n        className=\"w-12 border-l bg-background flex flex-col items-center py-4\"\n        data-testid=\"sidebar-right-collapsed\"\n        aria-label=\"Context sidebar (collapsed)\"\n      >\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          onClick={() => setIsCollapsed(false)}\n          className=\"mb-4\"\n          aria-label=\"Expand sidebar\"\n          data-testid=\"button-expand-sidebar\"\n        >\n          <PanelRight className=\"h-4 w-4\" />\n        </Button>\n      </aside>\n    );\n  }\n\n  const railWidth = isExpanded ? \"w-96\" : \"w-80\";\n\n  return (\n    <motion.aside\n      initial={{ width: 320 }}\n      animate={{ width: isExpanded ? 384 : 320 }}\n      transition={{ duration: 0.2 }}\n      className={`border-l bg-background flex flex-col ${className}`}\n      data-testid=\"sidebar-right\"\n      aria-label=\"Context sidebar\"\n    >\n      <div className=\"flex items-center justify-between px-4 py-2 border-b\">\n        <span className=\"text-xs font-medium text-muted-foreground uppercase tracking-wide\">\n          {currentPage === \"dashboard\" ? \"Overview\" : currentPage.replace(\"-\", \" \")}\n        </span>\n        <div className=\"flex items-center gap-1\">\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            className=\"h-7 w-7\"\n            onClick={() => setIsExpanded(!isExpanded)}\n            aria-label={isExpanded ? \"Minimize sidebar\" : \"Maximize sidebar\"}\n            data-testid=\"button-toggle-sidebar-size\"\n          >\n            {isExpanded ? <Minimize2 className=\"h-3.5 w-3.5\" /> : <Maximize2 className=\"h-3.5 w-3.5\" />}\n          </Button>\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            className=\"h-7 w-7\"\n            onClick={() => setIsCollapsed(true)}\n            aria-label=\"Collapse sidebar\"\n            data-testid=\"button-collapse-sidebar\"\n          >\n            <PanelRightClose className=\"h-3.5 w-3.5\" />\n          </Button>\n        </div>\n      </div>\n\n      <ScrollArea className=\"flex-1\">\n        <div className=\"p-4 space-y-4\">\n          <AnimatePresence mode=\"popLayout\">\n            {showPortfolioSignals && (\n              <motion.div\n                key=\"portfolio-signals\"\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                exit={{ opacity: 0, y: -10 }}\n                transition={{ duration: 0.2 }}\n              >\n                <PortfolioSignals />\n              </motion.div>\n            )}\n\n            {showCostSnapshot && (\n              <motion.div\n                key=\"cost-snapshot\"\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                exit={{ opacity: 0, y: -10 }}\n                transition={{ duration: 0.2, delay: 0.05 }}\n              >\n                <CostSnapshot />\n              </motion.div>\n            )}\n\n            {showResourceSnapshot && (\n              <motion.div\n                key=\"resource-snapshot\"\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                exit={{ opacity: 0, y: -10 }}\n                transition={{ duration: 0.2, delay: 0.1 }}\n              >\n                <ResourceSnapshot />\n              </motion.div>\n            )}\n\n            {showRiskSnapshot && (\n              <motion.div\n                key=\"risk-snapshot\"\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                exit={{ opacity: 0, y: -10 }}\n                transition={{ duration: 0.2, delay: 0.15 }}\n              >\n                <RiskSnapshot />\n              </motion.div>\n            )}\n\n            {showWBSLinkage && (\n              <motion.div\n                key=\"wbs-linkage\"\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                exit={{ opacity: 0, y: -10 }}\n                transition={{ duration: 0.2, delay: 0.2 }}\n              >\n                <WBSLinkage />\n              </motion.div>\n            )}\n\n            {showUpcomingEvents && (\n              <motion.div\n                key=\"upcoming-events\"\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                exit={{ opacity: 0, y: -10 }}\n                transition={{ duration: 0.2, delay: 0.25 }}\n              >\n                <UpcomingEvents />\n              </motion.div>\n            )}\n\n            {showUpcomingEvents && (\n              <motion.div\n                key=\"event-legend\"\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                exit={{ opacity: 0, y: -10 }}\n                transition={{ duration: 0.2, delay: 0.3 }}\n              >\n                <EventLegend />\n              </motion.div>\n            )}\n\n            {showCadencePlaybook && (\n              <motion.div\n                key=\"cadence-playbook\"\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                exit={{ opacity: 0, y: -10 }}\n                transition={{ duration: 0.2, delay: 0.35 }}\n              >\n                <CadencePlaybook />\n              </motion.div>\n            )}\n\n            {showCadencePlaybook && (\n              <motion.div\n                key=\"reviews\"\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                exit={{ opacity: 0, y: -10 }}\n                transition={{ duration: 0.2, delay: 0.4 }}\n              >\n                <ReviewsWidget />\n              </motion.div>\n            )}\n\n            {showAIAssistantGuide && (\n              <motion.div\n                key=\"ai-assistant-guide\"\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                exit={{ opacity: 0, y: -10 }}\n                transition={{ duration: 0.2 }}\n              >\n                <AIAssistantGuide />\n              </motion.div>\n            )}\n\n            {showDocumentStats && (\n              <motion.div\n                key=\"document-stats\"\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                exit={{ opacity: 0, y: -10 }}\n                transition={{ duration: 0.2 }}\n              >\n                <DocumentStats />\n              </motion.div>\n            )}\n\n            {showDocumentDetails && (\n              <motion.div\n                key=\"document-details\"\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                exit={{ opacity: 0, y: -10 }}\n                transition={{ duration: 0.2, delay: 0.05 }}\n              >\n                <DocumentDetails />\n              </motion.div>\n            )}\n          </AnimatePresence>\n        </div>\n      </ScrollArea>\n    </motion.aside>\n  );\n}\n","size_bytes":9095},"client/src/components/ai/AIFileAttachment.tsx":{"content":"import { useState, useRef } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Paperclip, X, Image, FileText, File } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\n\nexport interface AttachmentFile {\n  file: File;\n  preview?: string;\n  type: \"image\" | \"text\" | \"other\";\n}\n\ninterface AIFileAttachmentProps {\n  attachments: AttachmentFile[];\n  onAttachmentsChange: (attachments: AttachmentFile[]) => void;\n  disabled?: boolean;\n  maxFiles?: number;\n  maxSizeMB?: number;\n}\n\nexport function AIFileAttachment({\n  attachments,\n  onAttachmentsChange,\n  disabled = false,\n  maxFiles = 3,\n  maxSizeMB = 5,\n}: AIFileAttachmentProps) {\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const [error, setError] = useState<string | null>(null);\n\n  const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = e.target.files;\n    if (!files || files.length === 0) return;\n\n    setError(null);\n\n    const newAttachments: AttachmentFile[] = [];\n    for (let i = 0; i < files.length; i++) {\n      if (attachments.length + newAttachments.length >= maxFiles) {\n        setError(`Maximum ${maxFiles} files allowed`);\n        break;\n      }\n\n      const file = files[i];\n      const sizeMB = file.size / (1024 * 1024);\n\n      if (sizeMB > maxSizeMB) {\n        setError(`File ${file.name} exceeds ${maxSizeMB}MB limit`);\n        continue;\n      }\n\n      let type: AttachmentFile[\"type\"] = \"other\";\n      let preview: string | undefined;\n\n      if (file.type.startsWith(\"image/\")) {\n        type = \"image\";\n        preview = await readFileAsDataURL(file);\n      } else if (\n        file.type.startsWith(\"text/\") ||\n        file.name.endsWith(\".txt\") ||\n        file.name.endsWith(\".md\") ||\n        file.name.endsWith(\".csv\") ||\n        file.name.endsWith(\".json\")\n      ) {\n        type = \"text\";\n      }\n\n      newAttachments.push({ file, preview, type });\n    }\n\n    onAttachmentsChange([...attachments, ...newAttachments]);\n\n    if (fileInputRef.current) {\n      fileInputRef.current.value = \"\";\n    }\n  };\n\n  const removeAttachment = (index: number) => {\n    const newAttachments = attachments.filter((_, i) => i !== index);\n    onAttachmentsChange(newAttachments);\n  };\n\n  const readFileAsDataURL = (file: File): Promise<string> => {\n    return new Promise((resolve, reject) => {\n      const reader = new FileReader();\n      reader.onload = () => resolve(reader.result as string);\n      reader.onerror = reject;\n      reader.readAsDataURL(file);\n    });\n  };\n\n  const getFileIcon = (type: AttachmentFile[\"type\"]) => {\n    switch (type) {\n      case \"image\":\n        return Image;\n      case \"text\":\n        return FileText;\n      default:\n        return File;\n    }\n  };\n\n  const formatFileSize = (bytes: number): string => {\n    if (bytes < 1024) return `${bytes} B`;\n    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;\n    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;\n  };\n\n  return (\n    <div className=\"space-y-2\">\n      <input\n        ref={fileInputRef}\n        type=\"file\"\n        multiple\n        accept=\"image/*,.txt,.md,.csv,.json,.pdf\"\n        onChange={handleFileSelect}\n        className=\"hidden\"\n        data-testid=\"input-file-attachment\"\n      />\n\n      <Button\n        type=\"button\"\n        size=\"icon\"\n        variant=\"ghost\"\n        onClick={() => fileInputRef.current?.click()}\n        disabled={disabled || attachments.length >= maxFiles}\n        title={`Attach files (max ${maxFiles})`}\n        data-testid=\"button-attach-file\"\n      >\n        <Paperclip className=\"h-4 w-4\" />\n      </Button>\n\n      {error && (\n        <p className=\"text-xs text-destructive\" data-testid=\"text-attachment-error\">\n          {error}\n        </p>\n      )}\n\n      {attachments.length > 0 && (\n        <div className=\"flex flex-wrap gap-2 mt-2\" data-testid=\"attachment-list\">\n          {attachments.map((attachment, index) => {\n            const FileIcon = getFileIcon(attachment.type);\n            return (\n              <div\n                key={index}\n                className=\"relative group flex items-center gap-1 bg-muted rounded-md p-1 pr-2\"\n                data-testid={`attachment-item-${index}`}\n              >\n                {attachment.type === \"image\" && attachment.preview ? (\n                  <img\n                    src={attachment.preview}\n                    alt={attachment.file.name}\n                    className=\"w-8 h-8 object-cover rounded\"\n                  />\n                ) : (\n                  <div className=\"w-8 h-8 flex items-center justify-center bg-background rounded\">\n                    <FileIcon className=\"h-4 w-4 text-muted-foreground\" />\n                  </div>\n                )}\n                <div className=\"flex flex-col min-w-0\">\n                  <span className=\"text-xs truncate max-w-[100px]\">{attachment.file.name}</span>\n                  <span className=\"text-xs text-muted-foreground\">\n                    {formatFileSize(attachment.file.size)}\n                  </span>\n                </div>\n                <Button\n                  type=\"button\"\n                  size=\"icon\"\n                  variant=\"ghost\"\n                  className=\"h-4 w-4 opacity-0 group-hover:opacity-100 transition-opacity\"\n                  onClick={() => removeAttachment(index)}\n                  data-testid={`button-remove-attachment-${index}`}\n                >\n                  <X className=\"h-3 w-3\" />\n                </Button>\n              </div>\n            );\n          })}\n        </div>\n      )}\n    </div>\n  );\n}\n\nexport async function getAttachmentContent(attachment: AttachmentFile): Promise<string> {\n  if (attachment.type === \"image\" && attachment.preview) {\n    return `[Image attached: ${attachment.file.name}]\\n\\n(Image data provided as base64)`;\n  }\n\n  if (attachment.type === \"text\") {\n    return new Promise((resolve, reject) => {\n      const reader = new FileReader();\n      reader.onload = () => {\n        const content = reader.result as string;\n        resolve(`[File: ${attachment.file.name}]\\n\\`\\`\\`\\n${content}\\n\\`\\`\\``);\n      };\n      reader.onerror = reject;\n      reader.readAsText(attachment.file);\n    });\n  }\n\n  return `[Attached file: ${attachment.file.name} (${attachment.file.type})]`;\n}\n\nexport async function prepareAttachmentsForMessage(\n  attachments: AttachmentFile[]\n): Promise<string> {\n  if (attachments.length === 0) return \"\";\n\n  const contents = await Promise.all(attachments.map(getAttachmentContent));\n  return \"\\n\\n---\\nAttached files:\\n\" + contents.join(\"\\n\\n\");\n}\n","size_bytes":6562},"client/src/components/widgets/WBSLinkage.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { \n  Link2, FileText, AlertTriangle, Users, \n  ExternalLink, ChevronRight\n} from \"lucide-react\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { useLocation } from \"wouter\";\nimport type { Task, TaskDocument, TaskRisk, TaskIssue } from \"@shared/schema\";\n\ninterface LinkageItemProps {\n  icon: React.ReactNode;\n  label: string;\n  count: number;\n  onClick?: () => void;\n}\n\nfunction LinkageItem({ icon, label, count, onClick }: LinkageItemProps) {\n  return (\n    <div \n      className={`flex items-center justify-between py-2 border-b last:border-0 ${\n        onClick ? \"cursor-pointer hover-elevate rounded-md px-2 -mx-2\" : \"\"\n      }`}\n      onClick={onClick}\n      data-testid={`linkage-item-${label.toLowerCase().replace(/\\s/g, \"-\")}`}\n    >\n      <div className=\"flex items-center gap-2\">\n        {icon}\n        <span className=\"text-sm\">{label}</span>\n      </div>\n      <div className=\"flex items-center gap-2\">\n        <Badge variant=\"secondary\" className=\"tabular-nums\">{count}</Badge>\n        {onClick && <ChevronRight className=\"h-3.5 w-3.5 text-muted-foreground\" />}\n      </div>\n    </div>\n  );\n}\n\nexport function WBSLinkage() {\n  const { selectedProjectId } = useProject();\n  const [, setLocation] = useLocation();\n\n  const { data: tasks = [], isLoading: tasksLoading } = useQuery<Task[]>({\n    queryKey: [\"/api/projects\", selectedProjectId, \"tasks\"],\n    enabled: !!selectedProjectId,\n  });\n\n  const { data: taskDocuments = [] } = useQuery<TaskDocument[]>({\n    queryKey: [\"/api/projects\", selectedProjectId, \"task-documents\"],\n    enabled: !!selectedProjectId,\n  });\n\n  const { data: taskRisks = [] } = useQuery<TaskRisk[]>({\n    queryKey: [\"/api/projects\", selectedProjectId, \"task-risks\"],\n    enabled: !!selectedProjectId,\n  });\n\n  const { data: taskIssues = [] } = useQuery<TaskIssue[]>({\n    queryKey: [\"/api/projects\", selectedProjectId, \"task-issues\"],\n    enabled: !!selectedProjectId,\n  });\n\n  if (tasksLoading) {\n    return (\n      <Card data-testid=\"widget-wbs-linkage\">\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-sm flex items-center gap-2\">\n            <Link2 className=\"h-4 w-4\" />\n            WBS Linkages\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-2\">\n          {[1, 2, 3, 4].map((i) => (\n            <div key={i} className=\"flex items-center justify-between py-2\">\n              <Skeleton className=\"h-4 w-28\" />\n              <Skeleton className=\"h-5 w-8\" />\n            </div>\n          ))}\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const totalTasks = tasks.length;\n  const milestoneTasks = tasks.filter(t => t.isMilestone).length;\n  const criticalPathTasks = tasks.filter(t => t.isCriticalPath).length;\n\n  const tasksWithDependencies = tasks.filter(t => t.parentId !== null).length;\n\n  const uniqueDocLinks = new Set(taskDocuments.map(td => td.documentId)).size;\n  const uniqueRiskLinks = new Set(taskRisks.map(tr => tr.riskId)).size;\n  const uniqueIssueLinks = new Set(taskIssues.map(ti => ti.issueId)).size;\n\n  return (\n    <Card data-testid=\"widget-wbs-linkage\">\n      <CardHeader className=\"pb-2\">\n        <div className=\"flex items-center justify-between\">\n          <CardTitle className=\"text-sm flex items-center gap-2\">\n            <Link2 className=\"h-4 w-4\" />\n            WBS Linkages\n          </CardTitle>\n          <Button \n            variant=\"ghost\" \n            size=\"sm\" \n            className=\"h-6 text-xs gap-1\"\n            onClick={() => setLocation(\"/wbs\")}\n          >\n            View WBS\n            <ExternalLink className=\"h-3 w-3\" />\n          </Button>\n        </div>\n      </CardHeader>\n      <CardContent className=\"space-y-1\">\n        <div className=\"pb-2 border-b\">\n          <div className=\"flex items-center justify-between\">\n            <span className=\"text-xs text-muted-foreground\">Total WBS Items</span>\n            <span className=\"text-lg font-bold tabular-nums\">{totalTasks}</span>\n          </div>\n        </div>\n\n        <LinkageItem\n          icon={<FileText className=\"h-4 w-4 text-blue-500\" />}\n          label=\"Linked Documents\"\n          count={uniqueDocLinks}\n          onClick={() => setLocation(\"/sop\")}\n        />\n\n        <LinkageItem\n          icon={<AlertTriangle className=\"h-4 w-4 text-amber-500\" />}\n          label=\"Linked Risks\"\n          count={uniqueRiskLinks}\n          onClick={() => setLocation(\"/risks\")}\n        />\n\n        <LinkageItem\n          icon={<AlertTriangle className=\"h-4 w-4 text-red-500\" />}\n          label=\"Linked Issues\"\n          count={uniqueIssueLinks}\n          onClick={() => setLocation(\"/issues\")}\n        />\n\n        <div className=\"pt-2 border-t space-y-1\">\n          <div className=\"flex items-center justify-between py-1\">\n            <span className=\"text-xs text-muted-foreground\">Milestones</span>\n            <Badge variant=\"outline\" className=\"tabular-nums\">{milestoneTasks}</Badge>\n          </div>\n          <div className=\"flex items-center justify-between py-1\">\n            <span className=\"text-xs text-muted-foreground\">Critical Path</span>\n            <Badge variant=\"destructive\" className=\"tabular-nums\">{criticalPathTasks}</Badge>\n          </div>\n          <div className=\"flex items-center justify-between py-1\">\n            <span className=\"text-xs text-muted-foreground\">With Dependencies</span>\n            <Badge variant=\"secondary\" className=\"tabular-nums\">{tasksWithDependencies}</Badge>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":5797},"client/src/components/widgets/AIAssistantGuide.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { \n  Bot,\n  ChevronDown,\n  ChevronRight,\n  Lightbulb, \n  Keyboard, \n  Wand2,\n  BarChart3,\n  AlertTriangle,\n  Users,\n  DollarSign,\n  ClipboardList\n} from \"lucide-react\";\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from \"@/components/ui/collapsible\";\nimport { useAIPrompt } from \"@/contexts/AIPromptContext\";\n\nexport function AIAssistantGuide() {\n  const [capabilitiesOpen, setCapabilitiesOpen] = useState(true);\n  const [promptsOpen, setPromptsOpen] = useState(true);\n  const [shortcutsOpen, setShortcutsOpen] = useState(false);\n  const { setExamplePrompt } = useAIPrompt();\n\n  const capabilities = [\n    { icon: BarChart3, label: \"Project Analytics\", description: \"Analyze progress, metrics, and KPIs\" },\n    { icon: AlertTriangle, label: \"Risk Analysis\", description: \"Identify and track project risks\" },\n    { icon: Users, label: \"Resource Management\", description: \"Review allocation and availability\" },\n    { icon: DollarSign, label: \"Cost Tracking\", description: \"Monitor budget and expenses\" },\n    { icon: ClipboardList, label: \"Task Management\", description: \"Help with WBS and schedules\" },\n  ];\n\n  const examplePrompts = [\n    \"What are the top 5 risks in this project?\",\n    \"Show me a summary of project status\",\n    \"Which tasks are behind schedule?\",\n    \"What's the current budget variance?\",\n    \"List all open issues by priority\",\n    \"Who are the key stakeholders?\",\n    \"Analyze resource utilization\",\n    \"What milestones are coming up?\",\n  ];\n\n  const shortcuts = [\n    { keys: [\"Enter\"], description: \"Send message\" },\n    { keys: [\"Shift\", \"Enter\"], description: \"New line\" },\n    { keys: [\"⌘/Ctrl\", \"K\"], description: \"New conversation\" },\n  ];\n\n  return (\n    <Card data-testid=\"widget-ai-assistant-guide\">\n      <CardHeader className=\"pb-3\">\n        <CardTitle className=\"text-base flex items-center gap-2\">\n          <Bot className=\"h-4 w-4 text-primary\" />\n          AI Assistant Guide\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-3\">\n        <Collapsible open={capabilitiesOpen} onOpenChange={setCapabilitiesOpen}>\n          <CollapsibleTrigger className=\"flex items-center gap-2 w-full text-left hover-elevate p-1 rounded\" data-testid=\"button-toggle-capabilities\">\n            {capabilitiesOpen ? <ChevronDown className=\"h-3 w-3\" /> : <ChevronRight className=\"h-3 w-3\" />}\n            <Wand2 className=\"h-3 w-3 text-muted-foreground\" />\n            <span className=\"text-xs font-medium text-muted-foreground uppercase tracking-wide\">Capabilities</span>\n          </CollapsibleTrigger>\n          <CollapsibleContent>\n            <div className=\"mt-2 space-y-1\">\n              {capabilities.map((cap, index) => (\n                <div key={index} className=\"flex items-start gap-2 p-2 rounded hover-elevate\">\n                  <cap.icon className=\"h-4 w-4 text-primary flex-shrink-0 mt-0.5\" />\n                  <div>\n                    <p className=\"text-xs font-medium\">{cap.label}</p>\n                    <p className=\"text-xs text-muted-foreground\">{cap.description}</p>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </CollapsibleContent>\n        </Collapsible>\n\n        <Collapsible open={promptsOpen} onOpenChange={setPromptsOpen}>\n          <CollapsibleTrigger className=\"flex items-center gap-2 w-full text-left hover-elevate p-1 rounded\" data-testid=\"button-toggle-prompts\">\n            {promptsOpen ? <ChevronDown className=\"h-3 w-3\" /> : <ChevronRight className=\"h-3 w-3\" />}\n            <Lightbulb className=\"h-3 w-3 text-muted-foreground\" />\n            <span className=\"text-xs font-medium text-muted-foreground uppercase tracking-wide\">Try Asking</span>\n          </CollapsibleTrigger>\n          <CollapsibleContent>\n            <div className=\"mt-2 space-y-1\">\n              {examplePrompts.map((prompt, index) => (\n                <Button\n                  key={index}\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => setExamplePrompt(prompt)}\n                  className=\"w-full justify-start text-xs font-normal\"\n                  data-testid={`button-example-prompt-${index}`}\n                >\n                  \"{prompt}\"\n                </Button>\n              ))}\n            </div>\n          </CollapsibleContent>\n        </Collapsible>\n\n        <Collapsible open={shortcutsOpen} onOpenChange={setShortcutsOpen}>\n          <CollapsibleTrigger className=\"flex items-center gap-2 w-full text-left hover-elevate p-1 rounded\" data-testid=\"button-toggle-shortcuts\">\n            {shortcutsOpen ? <ChevronDown className=\"h-3 w-3\" /> : <ChevronRight className=\"h-3 w-3\" />}\n            <Keyboard className=\"h-3 w-3 text-muted-foreground\" />\n            <span className=\"text-xs font-medium text-muted-foreground uppercase tracking-wide\">Shortcuts</span>\n          </CollapsibleTrigger>\n          <CollapsibleContent>\n            <div className=\"mt-2 space-y-1\">\n              {shortcuts.map((shortcut, index) => (\n                <div key={index} className=\"flex items-center justify-between p-2\">\n                  <span className=\"text-xs text-muted-foreground\">{shortcut.description}</span>\n                  <div className=\"flex gap-1\">\n                    {shortcut.keys.map((key, keyIndex) => (\n                      <Badge key={keyIndex} variant=\"secondary\" className=\"text-xs px-1.5 py-0\">\n                        {key}\n                      </Badge>\n                    ))}\n                  </div>\n                </div>\n              ))}\n            </div>\n          </CollapsibleContent>\n        </Collapsible>\n\n        <div className=\"bg-primary/5 rounded-lg p-3 mt-3\">\n          <p className=\"text-xs font-medium mb-1\">Pro Tips</p>\n          <ul className=\"text-xs text-muted-foreground space-y-1\">\n            <li>• Be specific about what you want to analyze</li>\n            <li>• Ask follow-up questions for more details</li>\n            <li>• Reference tasks, risks, or issues by name</li>\n          </ul>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":6307},"client/src/components/widgets/PortfolioSignals.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { \n  Activity, Calendar, DollarSign, Users, \n  TrendingUp, TrendingDown, RefreshCw \n} from \"lucide-react\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { differenceInBusinessDays, format } from \"date-fns\";\nimport type { Task, CostItem, Resource } from \"@shared/schema\";\n\ninterface SignalItemProps {\n  icon: React.ReactNode;\n  label: string;\n  value: string | number;\n  subtext?: string;\n  status?: \"success\" | \"warning\" | \"danger\" | \"neutral\";\n}\n\nfunction SignalItem({ icon, label, value, subtext, status = \"neutral\" }: SignalItemProps) {\n  const statusColors = {\n    success: \"text-green-600 dark:text-green-400\",\n    warning: \"text-amber-600 dark:text-amber-400\",\n    danger: \"text-red-600 dark:text-red-400\",\n    neutral: \"text-foreground\",\n  };\n\n  return (\n    <div className=\"flex items-center justify-between py-2.5 border-b last:border-0\">\n      <div className=\"flex items-center gap-2.5\">\n        <div className=\"h-8 w-8 rounded-full bg-muted flex items-center justify-center shrink-0\">\n          {icon}\n        </div>\n        <div>\n          <p className=\"text-sm font-medium\">{label}</p>\n          {subtext && <p className=\"text-xs text-muted-foreground\">{subtext}</p>}\n        </div>\n      </div>\n      <span className={`text-sm font-semibold tabular-nums ${statusColors[status]}`}>\n        {value}\n      </span>\n    </div>\n  );\n}\n\nexport function PortfolioSignals() {\n  const { selectedProjectId, selectedProject } = useProject();\n\n  const { data: tasks = [], isLoading: tasksLoading } = useQuery<Task[]>({\n    queryKey: [\"/api/projects\", selectedProjectId, \"tasks\"],\n    enabled: !!selectedProjectId,\n    refetchInterval: 15 * 60 * 1000,\n  });\n\n  const { data: costs = [], isLoading: costsLoading } = useQuery<CostItem[]>({\n    queryKey: [\"/api/projects\", selectedProjectId, \"costs\"],\n    enabled: !!selectedProjectId,\n    refetchInterval: 15 * 60 * 1000,\n  });\n\n  const { data: resources = [], isLoading: resourcesLoading } = useQuery<Resource[]>({\n    queryKey: [\"/api/projects\", selectedProjectId, \"resources\"],\n    enabled: !!selectedProjectId,\n    refetchInterval: 15 * 60 * 1000,\n  });\n\n  const isLoading = tasksLoading || costsLoading || resourcesLoading;\n\n  if (isLoading) {\n    return (\n      <Card data-testid=\"widget-portfolio-signals\">\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-sm flex items-center gap-2\">\n            <Activity className=\"h-4 w-4\" />\n            Portfolio Signals\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-3\">\n          {[1, 2, 3, 4].map((i) => (\n            <div key={i} className=\"flex items-center justify-between py-2\">\n              <div className=\"flex items-center gap-2\">\n                <Skeleton className=\"h-8 w-8 rounded-full\" />\n                <Skeleton className=\"h-4 w-24\" />\n              </div>\n              <Skeleton className=\"h-4 w-12\" />\n            </div>\n          ))}\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const projectEndDate = selectedProject?.endDate ? new Date(selectedProject.endDate) : null;\n  const workingDaysToEnd = projectEndDate \n    ? Math.max(0, differenceInBusinessDays(projectEndDate, new Date()))\n    : null;\n\n  const totalBudget = costs.reduce((sum, c) => sum + Number(c.budgeted || 0), 0);\n  const actualSpend = costs.reduce((sum, c) => sum + Number(c.actual || 0), 0);\n  const budgetBurnPercent = totalBudget > 0 ? Math.round((actualSpend / totalBudget) * 100) : 0;\n\n  const avgAvailability = resources.length > 0\n    ? Math.round(resources.reduce((sum, r) => sum + (r.availability || 0), 0) / resources.length)\n    : 100;\n\n  const overallocatedCount = resources.filter(r => (r.availability || 0) > 100).length;\n\n  const completedTasks = tasks.filter(t => t.status === \"completed\").length;\n  const progressPercent = tasks.length > 0 ? Math.round((completedTasks / tasks.length) * 100) : 0;\n\n  const criticalTasks = tasks.filter(t => t.isCriticalPath).length;\n\n  const getBudgetStatus = (): \"success\" | \"warning\" | \"danger\" => {\n    if (budgetBurnPercent > 90) return \"danger\";\n    if (budgetBurnPercent > 75) return \"warning\";\n    return \"success\";\n  };\n\n  const getAvailabilityStatus = (): \"success\" | \"warning\" | \"danger\" => {\n    if (avgAvailability < 50) return \"danger\";\n    if (avgAvailability < 70) return \"warning\";\n    return \"success\";\n  };\n\n  return (\n    <Card data-testid=\"widget-portfolio-signals\">\n      <CardHeader className=\"pb-2\">\n        <div className=\"flex items-center justify-between\">\n          <CardTitle className=\"text-sm flex items-center gap-2\">\n            <Activity className=\"h-4 w-4\" />\n            Portfolio Signals\n          </CardTitle>\n          <Badge variant=\"secondary\" className=\"text-xs gap-1\">\n            <RefreshCw className=\"h-3 w-3\" />\n            15m\n          </Badge>\n        </div>\n      </CardHeader>\n      <CardContent className=\"space-y-1\">\n        <SignalItem\n          icon={<Calendar className=\"h-4 w-4 text-muted-foreground\" />}\n          label=\"Days to Project End\"\n          value={workingDaysToEnd !== null ? `${workingDaysToEnd} days` : \"N/A\"}\n          subtext={projectEndDate ? format(projectEndDate, \"MMM d, yyyy\") : \"No end date\"}\n          status={workingDaysToEnd !== null && workingDaysToEnd < 30 ? \"warning\" : \"neutral\"}\n        />\n\n        <SignalItem\n          icon={<DollarSign className=\"h-4 w-4 text-muted-foreground\" />}\n          label=\"Budget Burn\"\n          value={`${budgetBurnPercent}%`}\n          subtext={`$${actualSpend.toLocaleString()} of $${totalBudget.toLocaleString()}`}\n          status={getBudgetStatus()}\n        />\n\n        <SignalItem\n          icon={<Users className=\"h-4 w-4 text-muted-foreground\" />}\n          label=\"Resource Availability\"\n          value={`${avgAvailability}%`}\n          subtext={overallocatedCount > 0 ? `${overallocatedCount} over-allocated` : \"All within capacity\"}\n          status={getAvailabilityStatus()}\n        />\n\n        <SignalItem\n          icon={progressPercent >= 50 \n            ? <TrendingUp className=\"h-4 w-4 text-green-500\" /> \n            : <TrendingDown className=\"h-4 w-4 text-amber-500\" />\n          }\n          label=\"Task Completion\"\n          value={`${progressPercent}%`}\n          subtext={`${completedTasks} of ${tasks.length} tasks`}\n          status={progressPercent >= 75 ? \"success\" : progressPercent >= 50 ? \"warning\" : \"danger\"}\n        />\n\n        {criticalTasks > 0 && (\n          <div className=\"pt-2\">\n            <Badge variant=\"destructive\" className=\"w-full justify-center\">\n              {criticalTasks} Critical Path Task{criticalTasks !== 1 ? \"s\" : \"\"}\n            </Badge>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":6991},"client/src/contexts/AIPromptContext.tsx":{"content":"import { createContext, useContext, useState, useCallback } from \"react\";\n\ninterface AIPromptContextType {\n  setExamplePrompt: (prompt: string) => void;\n  pendingPrompt: string | null;\n  clearPendingPrompt: () => void;\n}\n\nconst AIPromptContext = createContext<AIPromptContextType | undefined>(undefined);\n\nexport function AIPromptProvider({ children }: { children: React.ReactNode }) {\n  const [pendingPrompt, setPendingPrompt] = useState<string | null>(null);\n\n  const setExamplePrompt = useCallback((prompt: string) => {\n    setPendingPrompt(prompt);\n  }, []);\n\n  const clearPendingPrompt = useCallback(() => {\n    setPendingPrompt(null);\n  }, []);\n\n  return (\n    <AIPromptContext.Provider value={{ setExamplePrompt, pendingPrompt, clearPendingPrompt }}>\n      {children}\n    </AIPromptContext.Provider>\n  );\n}\n\nexport function useAIPrompt() {\n  const context = useContext(AIPromptContext);\n  if (context === undefined) {\n    throw new Error(\"useAIPrompt must be used within an AIPromptProvider\");\n  }\n  return context;\n}\n","size_bytes":1025},"client/src/components/widgets/UpcomingEvents.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { \n  Calendar, Clock, Video, FileCheck, Target, \n  AlertTriangle, Package, Palmtree \n} from \"lucide-react\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { format, isToday, isTomorrow, isThisWeek, addDays } from \"date-fns\";\nimport type { Task, ProjectEvent } from \"@shared/schema\";\n\ninterface EventItem {\n  id: string;\n  title: string;\n  date: Date;\n  type: \"meeting\" | \"review\" | \"deadline\" | \"deliverable\" | \"milestone\" | \"shutdown\" | \"holiday\" | \"other\";\n}\n\nconst EVENT_COLORS: Record<string, { bg: string; text: string; icon: React.ReactNode }> = {\n  meeting: { \n    bg: \"bg-blue-100 dark:bg-blue-900/30\", \n    text: \"text-blue-700 dark:text-blue-300\",\n    icon: <Video className=\"h-3 w-3\" />\n  },\n  review: { \n    bg: \"bg-purple-100 dark:bg-purple-900/30\", \n    text: \"text-purple-700 dark:text-purple-300\",\n    icon: <FileCheck className=\"h-3 w-3\" />\n  },\n  deadline: { \n    bg: \"bg-red-100 dark:bg-red-900/30\", \n    text: \"text-red-700 dark:text-red-300\",\n    icon: <AlertTriangle className=\"h-3 w-3\" />\n  },\n  deliverable: { \n    bg: \"bg-green-100 dark:bg-green-900/30\", \n    text: \"text-green-700 dark:text-green-300\",\n    icon: <Package className=\"h-3 w-3\" />\n  },\n  milestone: { \n    bg: \"bg-amber-100 dark:bg-amber-900/30\", \n    text: \"text-amber-700 dark:text-amber-300\",\n    icon: <Target className=\"h-3 w-3\" />\n  },\n  shutdown: { \n    bg: \"bg-gray-100 dark:bg-gray-800\", \n    text: \"text-gray-700 dark:text-gray-300\",\n    icon: <AlertTriangle className=\"h-3 w-3\" />\n  },\n  holiday: { \n    bg: \"bg-teal-100 dark:bg-teal-900/30\", \n    text: \"text-teal-700 dark:text-teal-300\",\n    icon: <Palmtree className=\"h-3 w-3\" />\n  },\n  other: { \n    bg: \"bg-muted\", \n    text: \"text-muted-foreground\",\n    icon: <Calendar className=\"h-3 w-3\" />\n  },\n};\n\nfunction formatEventDate(date: Date): string {\n  if (isToday(date)) return \"Today\";\n  if (isTomorrow(date)) return \"Tomorrow\";\n  if (isThisWeek(date)) return format(date, \"EEEE\");\n  return format(date, \"MMM d\");\n}\n\nexport function EventLegend() {\n  return (\n    <Card data-testid=\"widget-event-legend\">\n      <CardHeader className=\"pb-2\">\n        <CardTitle className=\"text-sm\">Legend</CardTitle>\n      </CardHeader>\n      <CardContent>\n        <div className=\"grid grid-cols-2 gap-2\">\n          {Object.entries(EVENT_COLORS).map(([type, config]) => (\n            <div key={type} className=\"flex items-center gap-2\">\n              <div className={`h-5 w-5 rounded flex items-center justify-center ${config.bg}`}>\n                <span className={config.text}>{config.icon}</span>\n              </div>\n              <span className=\"text-xs capitalize\">{type}</span>\n            </div>\n          ))}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nexport function UpcomingEvents() {\n  const { selectedProjectId } = useProject();\n\n  const { data: tasks = [], isLoading: tasksLoading } = useQuery<Task[]>({\n    queryKey: [\"/api/projects\", selectedProjectId, \"tasks\"],\n    enabled: !!selectedProjectId,\n    refetchInterval: 15 * 60 * 1000,\n  });\n\n  const { data: projectEvents = [], isLoading: eventsLoading } = useQuery<ProjectEvent[]>({\n    queryKey: [\"/api/projects\", selectedProjectId, \"events\"],\n    enabled: !!selectedProjectId,\n    refetchInterval: 15 * 60 * 1000,\n  });\n\n  const isLoading = tasksLoading || eventsLoading;\n\n  if (isLoading) {\n    return (\n      <Card data-testid=\"widget-upcoming-events\">\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-sm flex items-center gap-2\">\n            <Calendar className=\"h-4 w-4\" />\n            Upcoming Events\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-2\">\n          {[1, 2, 3].map((i) => (\n            <div key={i} className=\"flex items-center gap-2 py-1.5\">\n              <Skeleton className=\"h-6 w-6 rounded\" />\n              <div className=\"flex-1\">\n                <Skeleton className=\"h-4 w-3/4 mb-1\" />\n                <Skeleton className=\"h-3 w-1/2\" />\n              </div>\n            </div>\n          ))}\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const now = new Date();\n  const twoWeeksFromNow = addDays(now, 14);\n\n  const taskEvents: EventItem[] = tasks\n    .filter(t => t.endDate && new Date(t.endDate) >= now && new Date(t.endDate) <= twoWeeksFromNow)\n    .filter(t => t.status !== \"completed\")\n    .map(t => ({\n      id: `task-${t.id}`,\n      title: t.name,\n      date: new Date(t.endDate!),\n      type: t.isMilestone ? \"milestone\" : \"deadline\" as const,\n    }));\n\n  const calendarEvents: EventItem[] = projectEvents\n    .filter(e => new Date(e.startDate) >= now && new Date(e.startDate) <= twoWeeksFromNow)\n    .map(e => ({\n      id: `event-${e.id}`,\n      title: e.title,\n      date: new Date(e.startDate),\n      type: (e.eventType as EventItem[\"type\"]) || \"other\",\n    }));\n\n  const allEvents = [...taskEvents, ...calendarEvents]\n    .sort((a, b) => a.date.getTime() - b.date.getTime())\n    .slice(0, 6);\n\n  const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;\n\n  return (\n    <Card data-testid=\"widget-upcoming-events\">\n      <CardHeader className=\"pb-2\">\n        <div className=\"flex items-center justify-between\">\n          <CardTitle className=\"text-sm flex items-center gap-2\">\n            <Calendar className=\"h-4 w-4\" />\n            Upcoming Events\n          </CardTitle>\n          <span className=\"text-xs text-muted-foreground flex items-center gap-1\">\n            <Clock className=\"h-3 w-3\" />\n            {timezone.split(\"/\").pop()?.replace(\"_\", \" \")}\n          </span>\n        </div>\n      </CardHeader>\n      <CardContent>\n        {allEvents.length === 0 ? (\n          <p className=\"text-sm text-muted-foreground text-center py-4\">\n            No upcoming events in the next 2 weeks\n          </p>\n        ) : (\n          <div className=\"space-y-2\">\n            {allEvents.map((event) => {\n              const config = EVENT_COLORS[event.type] || EVENT_COLORS.other;\n              return (\n                <div\n                  key={event.id}\n                  className=\"flex items-start gap-2 py-1.5 border-b last:border-0\"\n                  data-testid={`event-item-${event.id}`}\n                >\n                  <div className={`h-6 w-6 rounded flex items-center justify-center shrink-0 ${config.bg}`}>\n                    <span className={config.text}>{config.icon}</span>\n                  </div>\n                  <div className=\"flex-1 min-w-0\">\n                    <p className=\"text-sm font-medium truncate\">{event.title}</p>\n                    <p className=\"text-xs text-muted-foreground\">\n                      {formatEventDate(event.date)} · {format(event.date, \"h:mm a\")}\n                    </p>\n                  </div>\n                  <Badge variant=\"secondary\" className=\"text-xs shrink-0 capitalize\">\n                    {event.type}\n                  </Badge>\n                </div>\n              );\n            })}\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":7205},"client/src/components/modals/ResourceDetailsModal.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { \n  User, Wrench, Package, DollarSign, Calendar, Clock, \n  Award, Briefcase, FileText, AlertCircle, CheckCircle2,\n  Building, Phone, Mail, ExternalLink, Star, Loader2\n} from \"lucide-react\";\nimport { format, differenceInDays } from \"date-fns\";\nimport type { Resource, ResourceAssignment, Task } from \"@shared/schema\";\n\ninterface AssignmentWithTask extends ResourceAssignment {\n  task: Task | null;\n}\n\ninterface ResourceDetailsModalProps {\n  resource: Resource | null;\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}\n\nconst RESOURCE_TYPE_ICONS: Record<string, typeof User> = {\n  human: User,\n  equipment: Wrench,\n  material: Package,\n};\n\nconst RESOURCE_TYPE_LABELS: Record<string, string> = {\n  human: \"Human Resource\",\n  equipment: \"Equipment\",\n  material: \"Material\",\n};\n\nconst DISCIPLINE_LABELS: Record<string, string> = {\n  civil: \"Civil\",\n  structural: \"Structural\",\n  mechanical: \"Mechanical\",\n  electrical: \"Electrical\",\n  piping: \"Piping\",\n  instrumentation: \"Instrumentation\",\n  process: \"Process\",\n  hvac: \"HVAC\",\n  architectural: \"Architectural\",\n  general: \"General\",\n};\n\nconst CONTRACT_TYPE_LABELS: Record<string, string> = {\n  \"full-time\": \"Full-Time Employee\",\n  \"part-time\": \"Part-Time Employee\",\n  \"contract\": \"Contractor\",\n  \"temporary\": \"Temporary\",\n  \"rental\": \"Rental\",\n  \"purchase\": \"Purchase\",\n  \"lease\": \"Lease\",\n};\n\nconst AVAILABILITY_STATUS_COLORS: Record<string, string> = {\n  available: \"bg-green-500\",\n  partially_available: \"bg-amber-500\",\n  unavailable: \"bg-red-500\",\n  on_leave: \"bg-blue-500\",\n};\n\nconst AVAILABILITY_STATUS_LABELS: Record<string, string> = {\n  available: \"Available\",\n  partially_available: \"Partially Available\",\n  unavailable: \"Unavailable\",\n  on_leave: \"On Leave\",\n};\n\nconst DAYS_OF_WEEK = [\"monday\", \"tuesday\", \"wednesday\", \"thursday\", \"friday\", \"saturday\", \"sunday\"];\n\nexport function ResourceDetailsModal({ resource, open, onOpenChange }: ResourceDetailsModalProps) {\n  const { data: assignments = [], isLoading: assignmentsLoading } = useQuery<AssignmentWithTask[]>({\n    queryKey: [\"/api/resources\", resource?.id, \"assignments\"],\n    enabled: !!resource?.id && open,\n  });\n\n  if (!resource) return null;\n\n  const TypeIcon = RESOURCE_TYPE_ICONS[resource.type] || User;\n  const typeLabel = RESOURCE_TYPE_LABELS[resource.type] || resource.type;\n  const disciplineLabel = DISCIPLINE_LABELS[resource.discipline || \"general\"] || resource.discipline;\n  const contractTypeLabel = CONTRACT_TYPE_LABELS[resource.contractType || \"\"] || resource.contractType;\n\n  const workingDays = (resource.workingDays as string[] | null) || [\"monday\", \"tuesday\", \"wednesday\", \"thursday\", \"friday\"];\n  const pricingModels = resource.pricingModels as Array<{\n    name: string;\n    rateType: string;\n    rate: number;\n    unitType: string;\n    currency: string;\n    effectiveFrom?: string;\n    effectiveTo?: string;\n    isDefault?: boolean;\n  }> | null;\n  const calendarExceptions = resource.calendarExceptions as Array<{\n    date: string;\n    type: string;\n    note?: string;\n  }> | null;\n  const skills = (resource.skillsArray as string[] | null) || (resource.skills?.split(\",\").map(s => s.trim()) || []);\n  const certifications = (resource.certifications as string[] | null) || [];\n\n  const formatRate = (rate: string | number | null, rateType: string | null, unitType: string | null) => {\n    if (!rate) return \"N/A\";\n    const amount = typeof rate === \"string\" ? parseFloat(rate) : rate;\n    const suffix = rateType === \"per-hour\" ? \"/hr\" : rateType === \"per-use\" ? \"/use\" : `/${unitType || \"unit\"}`;\n    return `$${amount.toFixed(2)}${suffix}`;\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent \n        className=\"max-w-2xl max-h-[85vh]\" \n        data-testid=\"modal-resource-details\"\n        aria-describedby=\"resource-details-description\"\n      >\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-3\">\n            <div className=\"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center\">\n              <TypeIcon className=\"h-5 w-5\" />\n            </div>\n            <div>\n              <span>{resource.name}</span>\n              <div className=\"flex items-center gap-2 mt-1\">\n                <Badge variant=\"secondary\">{typeLabel}</Badge>\n                <Badge variant=\"outline\">{disciplineLabel}</Badge>\n                {resource.availabilityStatus && (\n                  <Badge className={`${AVAILABILITY_STATUS_COLORS[resource.availabilityStatus]} text-white`}>\n                    {AVAILABILITY_STATUS_LABELS[resource.availabilityStatus] || resource.availabilityStatus}\n                  </Badge>\n                )}\n              </div>\n            </div>\n          </DialogTitle>\n        </DialogHeader>\n        \n        <p id=\"resource-details-description\" className=\"sr-only\">\n          Detailed information about {resource.name} resource\n        </p>\n\n        <ScrollArea className=\"h-[60vh]\">\n          <Tabs defaultValue=\"overview\" className=\"w-full\">\n            <TabsList className=\"grid w-full grid-cols-4\">\n              <TabsTrigger value=\"overview\" data-testid=\"tab-overview\">Overview</TabsTrigger>\n              <TabsTrigger value=\"pricing\" data-testid=\"tab-pricing\">Pricing</TabsTrigger>\n              <TabsTrigger value=\"calendar\" data-testid=\"tab-calendar\">Calendar</TabsTrigger>\n              <TabsTrigger value=\"assignments\" data-testid=\"tab-assignments\">Assignments</TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"overview\" className=\"mt-4 space-y-4\">\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-sm flex items-center gap-2\">\n                    <User className=\"h-4 w-4\" />\n                    Basic Information\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <p className=\"text-xs text-muted-foreground\">Type</p>\n                      <p className=\"text-sm font-medium\">{typeLabel}</p>\n                    </div>\n                    <div>\n                      <p className=\"text-xs text-muted-foreground\">Discipline</p>\n                      <p className=\"text-sm font-medium\">{disciplineLabel}</p>\n                    </div>\n                    <div>\n                      <p className=\"text-xs text-muted-foreground\">Availability</p>\n                      <div className=\"flex items-center gap-2\">\n                        <Progress value={resource.availability} className=\"flex-1 h-2\" />\n                        <span className=\"text-sm font-mono\">{resource.availability}%</span>\n                      </div>\n                    </div>\n                    <div>\n                      <p className=\"text-xs text-muted-foreground\">Status</p>\n                      <p className=\"text-sm font-medium\">{AVAILABILITY_STATUS_LABELS[resource.availabilityStatus || \"available\"] || \"Available\"}</p>\n                    </div>\n                  </div>\n\n                  {resource.description && (\n                    <div className=\"pt-2\">\n                      <p className=\"text-xs text-muted-foreground\">Description</p>\n                      <p className=\"text-sm\">{resource.description}</p>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n\n              {(skills.length > 0 || certifications.length > 0) && (\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-sm flex items-center gap-2\">\n                      <Award className=\"h-4 w-4\" />\n                      Skills & Certifications\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-3\">\n                    {skills.length > 0 && (\n                      <div>\n                        <p className=\"text-xs text-muted-foreground mb-2\">Skills</p>\n                        <div className=\"flex flex-wrap gap-1.5\">\n                          {skills.filter(Boolean).map((skill, i) => (\n                            <Badge key={i} variant=\"secondary\">{skill}</Badge>\n                          ))}\n                        </div>\n                      </div>\n                    )}\n                    {certifications.length > 0 && (\n                      <div>\n                        <p className=\"text-xs text-muted-foreground mb-2\">Certifications</p>\n                        <div className=\"flex flex-wrap gap-1.5\">\n                          {certifications.filter(Boolean).map((cert, i) => (\n                            <Badge key={i} variant=\"outline\" className=\"gap-1\">\n                              <CheckCircle2 className=\"h-3 w-3\" />\n                              {cert}\n                            </Badge>\n                          ))}\n                        </div>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              )}\n\n              {(resource.contractType || resource.vendorName) && (\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-sm flex items-center gap-2\">\n                      <Briefcase className=\"h-4 w-4\" />\n                      Contract Information\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-3\">\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      {resource.contractType && (\n                        <div>\n                          <p className=\"text-xs text-muted-foreground\">Contract Type</p>\n                          <p className=\"text-sm font-medium\">{contractTypeLabel}</p>\n                        </div>\n                      )}\n                      {resource.contractReference && (\n                        <div>\n                          <p className=\"text-xs text-muted-foreground\">Reference</p>\n                          <p className=\"text-sm font-medium font-mono\">{resource.contractReference}</p>\n                        </div>\n                      )}\n                    </div>\n\n                    {resource.vendorName && (\n                      <div className=\"pt-2 border-t\">\n                        <p className=\"text-xs text-muted-foreground mb-2\">Vendor</p>\n                        <div className=\"flex items-center gap-3\">\n                          <Building className=\"h-4 w-4 text-muted-foreground\" />\n                          <span className=\"text-sm font-medium\">{resource.vendorName}</span>\n                        </div>\n                        <div className=\"flex items-center gap-4 mt-2\">\n                          {resource.vendorContactEmail && (\n                            <div className=\"flex items-center gap-1.5 text-sm\">\n                              <Mail className=\"h-3.5 w-3.5 text-muted-foreground\" />\n                              <a href={`mailto:${resource.vendorContactEmail}`} className=\"text-primary hover:underline\">\n                                {resource.vendorContactEmail}\n                              </a>\n                            </div>\n                          )}\n                          {resource.vendorContactPhone && (\n                            <div className=\"flex items-center gap-1.5 text-sm\">\n                              <Phone className=\"h-3.5 w-3.5 text-muted-foreground\" />\n                              {resource.vendorContactPhone}\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    )}\n\n                    {(resource.contractStartDate || resource.contractEndDate) && (\n                      <div className=\"pt-2 border-t\">\n                        <p className=\"text-xs text-muted-foreground mb-2\">Contract Period</p>\n                        <div className=\"flex items-center gap-2\">\n                          <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n                          <span className=\"text-sm\">\n                            {resource.contractStartDate \n                              ? format(new Date(resource.contractStartDate), \"MMM d, yyyy\") \n                              : \"N/A\"\n                            }\n                            {\" — \"}\n                            {resource.contractEndDate \n                              ? format(new Date(resource.contractEndDate), \"MMM d, yyyy\") \n                              : \"Ongoing\"\n                            }\n                          </span>\n                        </div>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              )}\n\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-sm flex items-center gap-2\">\n                    <Star className=\"h-4 w-4\" />\n                    Efficiency Metrics\n                  </CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"grid grid-cols-3 gap-4\">\n                    <div className=\"text-center p-3 rounded-lg bg-muted/50\">\n                      <p className=\"text-2xl font-bold\">{resource.efficiencyRating || \"1.0\"}</p>\n                      <p className=\"text-xs text-muted-foreground\">Efficiency</p>\n                    </div>\n                    <div className=\"text-center p-3 rounded-lg bg-muted/50\">\n                      <p className=\"text-2xl font-bold\">{resource.productivityFactor || \"1.0\"}</p>\n                      <p className=\"text-xs text-muted-foreground\">Productivity</p>\n                    </div>\n                    <div className=\"text-center p-3 rounded-lg bg-muted/50\">\n                      <p className=\"text-2xl font-bold\">{resource.qualityScore || \"—\"}</p>\n                      <p className=\"text-xs text-muted-foreground\">Quality Score</p>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n\n              {resource.notes && (\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-sm flex items-center gap-2\">\n                      <FileText className=\"h-4 w-4\" />\n                      Notes\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <p className=\"text-sm whitespace-pre-wrap\">{resource.notes}</p>\n                  </CardContent>\n                </Card>\n              )}\n            </TabsContent>\n\n            <TabsContent value=\"pricing\" className=\"mt-4 space-y-4\">\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-sm flex items-center gap-2\">\n                    <DollarSign className=\"h-4 w-4\" />\n                    Primary Rate\n                  </CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-center py-4\">\n                    <p className=\"text-3xl font-bold\">\n                      {formatRate(resource.rate, resource.rateType, resource.unitType)}\n                    </p>\n                    <p className=\"text-sm text-muted-foreground mt-1\">{resource.currency}</p>\n                  </div>\n                </CardContent>\n              </Card>\n\n              {pricingModels && pricingModels.length > 0 && (\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-sm flex items-center gap-2\">\n                      <DollarSign className=\"h-4 w-4\" />\n                      Additional Pricing Models\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-3\">\n                      {pricingModels.map((model, index) => (\n                        <div \n                          key={index} \n                          className=\"flex items-center justify-between p-3 rounded-lg border\"\n                          data-testid={`pricing-model-${index}`}\n                        >\n                          <div>\n                            <div className=\"flex items-center gap-2\">\n                              <p className=\"font-medium\">{model.name}</p>\n                              {model.isDefault && <Badge variant=\"secondary\">Default</Badge>}\n                            </div>\n                            {(model.effectiveFrom || model.effectiveTo) && (\n                              <p className=\"text-xs text-muted-foreground\">\n                                {model.effectiveFrom && format(new Date(model.effectiveFrom), \"MMM d, yyyy\")}\n                                {model.effectiveFrom && model.effectiveTo && \" — \"}\n                                {model.effectiveTo && format(new Date(model.effectiveTo), \"MMM d, yyyy\")}\n                              </p>\n                            )}\n                          </div>\n                          <div className=\"text-right\">\n                            <p className=\"font-mono font-semibold\">\n                              ${model.rate.toFixed(2)}\n                              {model.rateType === \"per-hour\" && \"/hr\"}\n                              {model.rateType === \"per-use\" && \"/use\"}\n                              {model.rateType === \"per-unit\" && `/${model.unitType}`}\n                            </p>\n                            <p className=\"text-xs text-muted-foreground\">{model.currency}</p>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  </CardContent>\n                </Card>\n              )}\n            </TabsContent>\n\n            <TabsContent value=\"calendar\" className=\"mt-4 space-y-4\">\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-sm flex items-center gap-2\">\n                    <Clock className=\"h-4 w-4\" />\n                    Working Hours\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <p className=\"text-xs text-muted-foreground\">Max Hours/Day</p>\n                      <p className=\"text-sm font-medium\">{resource.maxHoursPerDay || 8} hours</p>\n                    </div>\n                    <div>\n                      <p className=\"text-xs text-muted-foreground\">Max Hours/Week</p>\n                      <p className=\"text-sm font-medium\">{resource.maxHoursPerWeek || 40} hours</p>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-sm flex items-center gap-2\">\n                    <Calendar className=\"h-4 w-4\" />\n                    Working Days\n                  </CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"flex gap-2\">\n                    {DAYS_OF_WEEK.map((day) => (\n                      <div\n                        key={day}\n                        className={`flex-1 text-center p-2 rounded-md text-xs font-medium capitalize ${\n                          workingDays.includes(day)\n                            ? \"bg-primary text-primary-foreground\"\n                            : \"bg-muted text-muted-foreground\"\n                        }`}\n                      >\n                        {day.slice(0, 3)}\n                      </div>\n                    ))}\n                  </div>\n                </CardContent>\n              </Card>\n\n              {calendarExceptions && calendarExceptions.length > 0 && (\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardTitle className=\"text-sm flex items-center gap-2\">\n                      <AlertCircle className=\"h-4 w-4\" />\n                      Calendar Exceptions\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-2\">\n                      {calendarExceptions.map((exception, index) => (\n                        <div \n                          key={index}\n                          className=\"flex items-center justify-between p-2 rounded-md border\"\n                        >\n                          <div className=\"flex items-center gap-2\">\n                            <Badge variant=\"outline\" className=\"capitalize\">\n                              {exception.type}\n                            </Badge>\n                            <span className=\"text-sm\">\n                              {format(new Date(exception.date), \"MMM d, yyyy\")}\n                            </span>\n                          </div>\n                          {exception.note && (\n                            <span className=\"text-xs text-muted-foreground\">{exception.note}</span>\n                          )}\n                        </div>\n                      ))}\n                    </div>\n                  </CardContent>\n                </Card>\n              )}\n            </TabsContent>\n\n            <TabsContent value=\"assignments\" className=\"mt-4\">\n              <Card>\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-sm flex items-center gap-2\">\n                    <Briefcase className=\"h-4 w-4\" />\n                    Project Assignments ({assignments.length})\n                  </CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {assignmentsLoading ? (\n                    <div className=\"flex items-center justify-center py-8\">\n                      <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n                    </div>\n                  ) : assignments.length === 0 ? (\n                    <p className=\"text-sm text-muted-foreground text-center py-4\">\n                      No active assignments\n                    </p>\n                  ) : (\n                    <div className=\"space-y-3\">\n                      {assignments.map((assignment) => {\n                        const task = assignment.task;\n                        const taskDuration = task?.startDate && task?.endDate \n                          ? differenceInDays(new Date(task.endDate), new Date(task.startDate)) + 1\n                          : null;\n                        \n                        return (\n                          <div \n                            key={assignment.id}\n                            className=\"p-4 rounded-lg border space-y-3\"\n                            data-testid={`assignment-${assignment.id}`}\n                          >\n                            <div className=\"flex items-start justify-between gap-4\">\n                              <div className=\"flex-1 min-w-0\">\n                                <div className=\"flex items-center gap-2 flex-wrap\">\n                                  {task?.wbsCode && (\n                                    <Badge variant=\"outline\" className=\"font-mono text-xs\">\n                                      {task.wbsCode}\n                                    </Badge>\n                                  )}\n                                  <p className=\"font-medium truncate\" data-testid={`task-name-${assignment.id}`}>\n                                    {task?.name || `Task #${assignment.taskId}`}\n                                  </p>\n                                </div>\n                                {task?.status && (\n                                  <Badge \n                                    variant=\"secondary\" \n                                    className=\"mt-1 capitalize text-xs\"\n                                    data-testid={`task-status-${assignment.id}`}\n                                  >\n                                    {task.status.replace(/_/g, \" \")}\n                                  </Badge>\n                                )}\n                              </div>\n                              <div className=\"flex flex-col items-end gap-1\">\n                                <Badge data-testid={`allocation-${assignment.id}`}>\n                                  {assignment.allocation}% allocated\n                                </Badge>\n                                {assignment.plannedHours && (\n                                  <span className=\"text-xs text-muted-foreground font-mono\" data-testid={`planned-hours-${assignment.id}`}>\n                                    {assignment.plannedHours}h planned\n                                  </span>\n                                )}\n                              </div>\n                            </div>\n                            \n                            {(task?.startDate || task?.endDate) && (\n                              <div className=\"flex items-center gap-4 text-xs text-muted-foreground border-t pt-2\">\n                                <div className=\"flex items-center gap-1.5\">\n                                  <Calendar className=\"h-3.5 w-3.5\" />\n                                  <span>\n                                    {task.startDate \n                                      ? format(new Date(task.startDate), \"MMM d, yyyy\")\n                                      : \"No start\"\n                                    }\n                                    {\" — \"}\n                                    {task.endDate \n                                      ? format(new Date(task.endDate), \"MMM d, yyyy\")\n                                      : \"No end\"\n                                    }\n                                  </span>\n                                </div>\n                                {taskDuration && (\n                                  <div className=\"flex items-center gap-1.5\">\n                                    <Clock className=\"h-3.5 w-3.5\" />\n                                    <span>{taskDuration} days</span>\n                                  </div>\n                                )}\n                              </div>\n                            )}\n                            \n                            {task?.progress !== undefined && task.progress !== null && (\n                              <div className=\"space-y-1\">\n                                <div className=\"flex items-center justify-between text-xs\">\n                                  <span className=\"text-muted-foreground\">Progress</span>\n                                  <span className=\"font-mono\">{task.progress}%</span>\n                                </div>\n                                <Progress value={task.progress} className=\"h-1.5\" />\n                              </div>\n                            )}\n                          </div>\n                        );\n                      })}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n          </Tabs>\n        </ScrollArea>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":27737},"client/src/components/modals/index.ts":{"content":"export { ResourceDetailsModal } from \"./ResourceDetailsModal\";\nexport { EditResourceModal } from \"./EditResourceModal\";\n","size_bytes":120},"client/src/components/ai/AIHelpPanel.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { \n  HelpCircle, \n  ChevronRight, \n  ChevronDown,\n  Lightbulb, \n  Keyboard, \n  Wand2,\n  BarChart3,\n  AlertTriangle,\n  Users,\n  DollarSign,\n  ClipboardList\n} from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from \"@/components/ui/collapsible\";\n\ninterface AIHelpPanelProps {\n  onExampleClick?: (example: string) => void;\n}\n\nexport function AIHelpPanel({ onExampleClick }: AIHelpPanelProps) {\n  const [isOpen, setIsOpen] = useState(false);\n\n  const capabilities = [\n    { icon: BarChart3, label: \"Project Analytics\", description: \"Analyze project progress, metrics, and KPIs\" },\n    { icon: AlertTriangle, label: \"Risk Analysis\", description: \"Identify, assess, and track project risks\" },\n    { icon: Users, label: \"Resource Management\", description: \"Review resource allocation and availability\" },\n    { icon: DollarSign, label: \"Cost Tracking\", description: \"Monitor budget, expenses, and forecasts\" },\n    { icon: ClipboardList, label: \"Task Management\", description: \"Help with WBS, schedules, and dependencies\" },\n  ];\n\n  const examplePrompts = [\n    \"What are the top 5 risks in this project?\",\n    \"Show me a summary of project status\",\n    \"Which tasks are behind schedule?\",\n    \"What's the current budget variance?\",\n    \"List all open issues by priority\",\n    \"Who are the key stakeholders?\",\n    \"Analyze resource utilization\",\n    \"What milestones are coming up?\",\n  ];\n\n  const shortcuts = [\n    { keys: [\"Enter\"], description: \"Send message\" },\n    { keys: [\"Shift\", \"Enter\"], description: \"New line\" },\n    { keys: [\"⌘/Ctrl\", \"K\"], description: \"New conversation\" },\n  ];\n\n  return (\n    <div className=\"w-64 border-l bg-muted/30 flex flex-col h-full\" data-testid=\"ai-help-panel\">\n      <Collapsible open={isOpen} onOpenChange={setIsOpen}>\n        <CollapsibleTrigger asChild>\n          <div\n            className=\"w-full flex items-center justify-between p-4 border-b cursor-pointer hover-elevate\"\n            data-testid=\"button-toggle-help\"\n          >\n            <div className=\"flex items-center gap-2\">\n              <HelpCircle className=\"h-4 w-4 text-primary\" />\n              <span className=\"font-medium text-sm\">AI Assistant Guide</span>\n            </div>\n            {isOpen ? (\n              <ChevronDown className=\"h-4 w-4\" />\n            ) : (\n              <ChevronRight className=\"h-4 w-4\" />\n            )}\n          </div>\n        </CollapsibleTrigger>\n\n        <CollapsibleContent>\n          <ScrollArea className=\"flex-1 h-[calc(100vh-200px)]\">\n            <div className=\"p-3 space-y-4\">\n              {/* Capabilities Section */}\n              <div>\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <Wand2 className=\"h-3 w-3 text-muted-foreground\" />\n                  <span className=\"text-xs font-medium text-muted-foreground uppercase tracking-wide\">Capabilities</span>\n                </div>\n                <div className=\"space-y-1\">\n                  {capabilities.map((cap, index) => (\n                    <div key={index} className=\"flex items-start gap-2 p-2 rounded hover-elevate\">\n                      <cap.icon className=\"h-4 w-4 text-primary flex-shrink-0 mt-0.5\" />\n                      <div>\n                        <p className=\"text-xs font-medium\">{cap.label}</p>\n                        <p className=\"text-xs text-muted-foreground\">{cap.description}</p>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              </div>\n\n              {/* Example Prompts Section */}\n              <div>\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <Lightbulb className=\"h-3 w-3 text-muted-foreground\" />\n                  <span className=\"text-xs font-medium text-muted-foreground uppercase tracking-wide\">Try asking</span>\n                </div>\n                <div className=\"space-y-1\">\n                  {examplePrompts.map((prompt, index) => (\n                    <button\n                      key={index}\n                      onClick={() => onExampleClick?.(prompt)}\n                      className=\"w-full text-left p-2 text-xs rounded hover-elevate border border-transparent hover:border-border transition-colors\"\n                      data-testid={`button-example-prompt-${index}`}\n                    >\n                      \"{prompt}\"\n                    </button>\n                  ))}\n                </div>\n              </div>\n\n              {/* Keyboard Shortcuts Section */}\n              <div>\n                <div className=\"flex items-center gap-2 mb-2\">\n                  <Keyboard className=\"h-3 w-3 text-muted-foreground\" />\n                  <span className=\"text-xs font-medium text-muted-foreground uppercase tracking-wide\">Shortcuts</span>\n                </div>\n                <div className=\"space-y-1\">\n                  {shortcuts.map((shortcut, index) => (\n                    <div key={index} className=\"flex items-center justify-between p-2\">\n                      <span className=\"text-xs text-muted-foreground\">{shortcut.description}</span>\n                      <div className=\"flex gap-1\">\n                        {shortcut.keys.map((key, keyIndex) => (\n                          <Badge key={keyIndex} variant=\"secondary\" className=\"text-xs px-1.5 py-0\">\n                            {key}\n                          </Badge>\n                        ))}\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              </div>\n\n              {/* Tips Section */}\n              <div className=\"bg-primary/5 rounded-lg p-3\">\n                <p className=\"text-xs font-medium mb-1\">Pro Tips</p>\n                <ul className=\"text-xs text-muted-foreground space-y-1\">\n                  <li>• Be specific about what you want to analyze</li>\n                  <li>• Ask follow-up questions for more details</li>\n                  <li>• Reference specific tasks, risks, or issues by name</li>\n                </ul>\n              </div>\n            </div>\n          </ScrollArea>\n        </CollapsibleContent>\n      </Collapsible>\n    </div>\n  );\n}\n","size_bytes":6344},"client/src/components/ai/AIMentionInput.tsx":{"content":"import { useState, useRef, useEffect, useCallback } from \"react\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { \n  ClipboardList, \n  AlertTriangle, \n  AlertCircle, \n  Users,\n  DollarSign,\n  Loader2\n} from \"lucide-react\";\n\ninterface MentionItem {\n  id: string;\n  type: \"task\" | \"risk\" | \"issue\" | \"stakeholder\" | \"cost\";\n  name: string;\n  code?: string;\n  description?: string;\n}\n\ninterface AIMentionInputProps {\n  value: string;\n  onChange: (value: string) => void;\n  onKeyDown?: (e: React.KeyboardEvent<HTMLTextAreaElement>) => void;\n  disabled?: boolean;\n  placeholder?: string;\n  className?: string;\n}\n\nexport function AIMentionInput({\n  value,\n  onChange,\n  onKeyDown,\n  disabled = false,\n  placeholder = \"Type @ to mention...\",\n  className = \"\",\n}: AIMentionInputProps) {\n  const { selectedProjectId } = useProject();\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n  const dropdownRef = useRef<HTMLDivElement>(null);\n  \n  const [showMentions, setShowMentions] = useState(false);\n  const [mentionQuery, setMentionQuery] = useState(\"\");\n  const [mentionStartIndex, setMentionStartIndex] = useState(-1);\n  const [selectedIndex, setSelectedIndex] = useState(0);\n\n  const { data: tasks = [] } = useQuery<any[]>({\n    queryKey: selectedProjectId ? [`/api/projects/${selectedProjectId}/tasks`] : [\"__disabled__\"],\n    enabled: !!selectedProjectId && showMentions,\n  });\n\n  const { data: risks = [] } = useQuery<any[]>({\n    queryKey: selectedProjectId ? [`/api/projects/${selectedProjectId}/risks`] : [\"__disabled__\"],\n    enabled: !!selectedProjectId && showMentions,\n  });\n\n  const { data: issues = [] } = useQuery<any[]>({\n    queryKey: selectedProjectId ? [`/api/projects/${selectedProjectId}/issues`] : [\"__disabled__\"],\n    enabled: !!selectedProjectId && showMentions,\n  });\n\n  const { data: stakeholders = [] } = useQuery<any[]>({\n    queryKey: selectedProjectId ? [`/api/projects/${selectedProjectId}/stakeholders`] : [\"__disabled__\"],\n    enabled: !!selectedProjectId && showMentions,\n  });\n\n  const mentionItems: MentionItem[] = [\n    ...tasks.map((t: any) => ({\n      id: `task-${t.id}`,\n      type: \"task\" as const,\n      name: t.name,\n      code: t.wbsCode,\n      description: t.description?.substring(0, 50),\n    })),\n    ...risks.map((r: any) => ({\n      id: `risk-${r.id}`,\n      type: \"risk\" as const,\n      name: r.title,\n      code: r.code,\n      description: r.description?.substring(0, 50),\n    })),\n    ...issues.map((i: any) => ({\n      id: `issue-${i.id}`,\n      type: \"issue\" as const,\n      name: i.title,\n      code: i.code,\n      description: i.description?.substring(0, 50),\n    })),\n    ...stakeholders.map((s: any) => ({\n      id: `stakeholder-${s.id}`,\n      type: \"stakeholder\" as const,\n      name: s.name,\n      description: s.role || s.organization,\n    })),\n  ];\n\n  const filteredItems = mentionItems.filter((item) => {\n    const query = mentionQuery.toLowerCase();\n    return (\n      item.name.toLowerCase().includes(query) ||\n      item.code?.toLowerCase().includes(query) ||\n      item.description?.toLowerCase().includes(query)\n    );\n  }).slice(0, 10);\n\n  const handleChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {\n    const newValue = e.target.value;\n    const cursorPos = e.target.selectionStart;\n    \n    onChange(newValue);\n\n    const textBeforeCursor = newValue.substring(0, cursorPos);\n    const lastAtIndex = textBeforeCursor.lastIndexOf(\"@\");\n\n    if (lastAtIndex !== -1) {\n      const textAfterAt = textBeforeCursor.substring(lastAtIndex + 1);\n      if (!textAfterAt.includes(\" \") && !textAfterAt.includes(\"\\n\")) {\n        setShowMentions(true);\n        setMentionQuery(textAfterAt);\n        setMentionStartIndex(lastAtIndex);\n        setSelectedIndex(0);\n        return;\n      }\n    }\n\n    setShowMentions(false);\n    setMentionQuery(\"\");\n    setMentionStartIndex(-1);\n  };\n\n  const insertMention = useCallback((item: MentionItem) => {\n    if (mentionStartIndex === -1) return;\n\n    const beforeMention = value.substring(0, mentionStartIndex);\n    const afterMention = value.substring(mentionStartIndex + mentionQuery.length + 1);\n    const mentionText = `@${item.type}:${item.code || item.name}`;\n    \n    onChange(beforeMention + mentionText + \" \" + afterMention);\n    setShowMentions(false);\n    setMentionQuery(\"\");\n    setMentionStartIndex(-1);\n\n    setTimeout(() => {\n      if (textareaRef.current) {\n        const newCursorPos = beforeMention.length + mentionText.length + 1;\n        textareaRef.current.setSelectionRange(newCursorPos, newCursorPos);\n        textareaRef.current.focus();\n      }\n    }, 0);\n  }, [mentionStartIndex, mentionQuery, value, onChange]);\n\n  const handleKeyDownInternal = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {\n    if (showMentions && filteredItems.length > 0) {\n      if (e.key === \"ArrowDown\") {\n        e.preventDefault();\n        setSelectedIndex((prev) => Math.min(prev + 1, filteredItems.length - 1));\n        return;\n      }\n      if (e.key === \"ArrowUp\") {\n        e.preventDefault();\n        setSelectedIndex((prev) => Math.max(prev - 1, 0));\n        return;\n      }\n      if (e.key === \"Enter\" || e.key === \"Tab\") {\n        e.preventDefault();\n        insertMention(filteredItems[selectedIndex]);\n        return;\n      }\n      if (e.key === \"Escape\") {\n        e.preventDefault();\n        setShowMentions(false);\n        return;\n      }\n    }\n\n    onKeyDown?.(e);\n  };\n\n  useEffect(() => {\n    const handleClickOutside = (e: MouseEvent) => {\n      if (\n        dropdownRef.current &&\n        !dropdownRef.current.contains(e.target as Node) &&\n        textareaRef.current &&\n        !textareaRef.current.contains(e.target as Node)\n      ) {\n        setShowMentions(false);\n      }\n    };\n\n    document.addEventListener(\"mousedown\", handleClickOutside);\n    return () => document.removeEventListener(\"mousedown\", handleClickOutside);\n  }, []);\n\n  const getTypeIcon = (type: MentionItem[\"type\"]) => {\n    switch (type) {\n      case \"task\":\n        return ClipboardList;\n      case \"risk\":\n        return AlertTriangle;\n      case \"issue\":\n        return AlertCircle;\n      case \"stakeholder\":\n        return Users;\n      case \"cost\":\n        return DollarSign;\n    }\n  };\n\n  const getTypeColor = (type: MentionItem[\"type\"]) => {\n    switch (type) {\n      case \"task\":\n        return \"text-blue-500\";\n      case \"risk\":\n        return \"text-orange-500\";\n      case \"issue\":\n        return \"text-red-500\";\n      case \"stakeholder\":\n        return \"text-green-500\";\n      case \"cost\":\n        return \"text-purple-500\";\n    }\n  };\n\n  return (\n    <div className=\"relative flex-1\">\n      <Textarea\n        ref={textareaRef}\n        value={value}\n        onChange={handleChange}\n        onKeyDown={handleKeyDownInternal}\n        disabled={disabled}\n        placeholder={placeholder}\n        className={`min-h-[60px] resize-none ${className}`}\n        data-testid=\"input-message-mention\"\n      />\n\n      {showMentions && (\n        <div\n          ref={dropdownRef}\n          className=\"absolute bottom-full left-0 right-0 mb-1 bg-popover border rounded-md shadow-lg z-50 max-h-64 overflow-hidden\"\n          data-testid=\"mention-dropdown\"\n        >\n          <div className=\"p-2 border-b bg-muted/50\">\n            <p className=\"text-xs text-muted-foreground\">\n              Type to search tasks, risks, issues, or stakeholders\n            </p>\n          </div>\n          <ScrollArea className=\"max-h-48\">\n            {filteredItems.length === 0 ? (\n              <div className=\"p-3 text-center text-sm text-muted-foreground\">\n                {mentionQuery ? \"No matches found\" : \"Loading...\"}\n              </div>\n            ) : (\n              <div className=\"py-1\">\n                {filteredItems.map((item, index) => {\n                  const Icon = getTypeIcon(item.type);\n                  return (\n                    <button\n                      key={item.id}\n                      type=\"button\"\n                      className={`w-full px-3 py-2 text-left flex items-center gap-2 hover:bg-accent ${\n                        index === selectedIndex ? \"bg-accent\" : \"\"\n                      }`}\n                      onClick={() => insertMention(item)}\n                      data-testid={`mention-item-${item.id}`}\n                    >\n                      <Icon className={`h-4 w-4 flex-shrink-0 ${getTypeColor(item.type)}`} />\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center gap-2\">\n                          {item.code && (\n                            <span className=\"text-xs font-mono text-muted-foreground\">\n                              {item.code}\n                            </span>\n                          )}\n                          <span className=\"text-sm truncate\">{item.name}</span>\n                        </div>\n                        {item.description && (\n                          <p className=\"text-xs text-muted-foreground truncate\">\n                            {item.description}\n                          </p>\n                        )}\n                      </div>\n                      <span className=\"text-xs text-muted-foreground capitalize\">\n                        {item.type}\n                      </span>\n                    </button>\n                  );\n                })}\n              </div>\n            )}\n          </ScrollArea>\n        </div>\n      )}\n    </div>\n  );\n}\n","size_bytes":9585},"client/src/components/widgets/RiskSnapshot.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { \n  AlertTriangle, Shield, Target, TrendingUp, \n  TrendingDown, Eye, Zap\n} from \"lucide-react\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport type { Risk, Issue } from \"@shared/schema\";\n\ninterface StatItemProps {\n  label: string;\n  value: number;\n  icon?: React.ReactNode;\n  badgeVariant?: \"default\" | \"secondary\" | \"destructive\" | \"outline\";\n}\n\nfunction StatItem({ label, value, icon, badgeVariant }: StatItemProps) {\n  return (\n    <div className=\"flex items-center justify-between py-1.5\">\n      <div className=\"flex items-center gap-2\">\n        {icon}\n        <span className=\"text-sm\">{label}</span>\n      </div>\n      <Badge variant={badgeVariant || \"secondary\"} className=\"tabular-nums\">\n        {value}\n      </Badge>\n    </div>\n  );\n}\n\nexport function RiskSnapshot() {\n  const { selectedProjectId } = useProject();\n\n  const { data: risks = [], isLoading: risksLoading } = useQuery<Risk[]>({\n    queryKey: [\"/api/projects\", selectedProjectId, \"risks\"],\n    enabled: !!selectedProjectId,\n    refetchInterval: 15 * 60 * 1000,\n  });\n\n  const { data: issues = [], isLoading: issuesLoading } = useQuery<Issue[]>({\n    queryKey: [\"/api/projects\", selectedProjectId, \"issues\"],\n    enabled: !!selectedProjectId,\n    refetchInterval: 15 * 60 * 1000,\n  });\n\n  const isLoading = risksLoading || issuesLoading;\n\n  if (isLoading) {\n    return (\n      <Card data-testid=\"widget-risk-snapshot\">\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-sm flex items-center gap-2\">\n            <AlertTriangle className=\"h-4 w-4\" />\n            Risk & Issue Snapshot\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-3\">\n          {[1, 2, 3, 4].map((i) => (\n            <div key={i} className=\"flex items-center justify-between py-1.5\">\n              <Skeleton className=\"h-4 w-24\" />\n              <Skeleton className=\"h-5 w-8\" />\n            </div>\n          ))}\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const openRisks = risks.filter(r => r.status !== \"closed\");\n  const criticalRisks = risks.filter(r => \n    (r.impact === \"critical\" || r.impact === \"high\") && r.status !== \"closed\"\n  );\n  const mitigatingRisks = risks.filter(r => r.status === \"mitigating\");\n\n  const openIssues = issues.filter(i => i.status === \"open\" || i.status === \"in-progress\");\n  const criticalIssues = issues.filter(i => \n    (i.priority === \"critical\" || i.priority === \"high\") && \n    i.status !== \"closed\" && i.status !== \"resolved\"\n  );\n  const overdueIssues = issues.filter(i => \n    i.targetResolutionDate && \n    new Date(i.targetResolutionDate) < new Date() && \n    i.status !== \"closed\" && i.status !== \"resolved\"\n  );\n\n  const totalExposure = risks.reduce((sum, r) => {\n    return sum + parseFloat(r.riskExposure || \"0\");\n  }, 0);\n\n  const avgRiskScore = openRisks.length > 0\n    ? (openRisks.reduce((sum, r) => sum + (r.probability || 0), 0) / openRisks.length).toFixed(1)\n    : \"0\";\n\n  const formatCurrency = (amount: number) => {\n    if (amount >= 1000000) return `$${(amount / 1000000).toFixed(1)}M`;\n    if (amount >= 1000) return `$${(amount / 1000).toFixed(0)}K`;\n    return `$${amount.toFixed(0)}`;\n  };\n\n  return (\n    <Card data-testid=\"widget-risk-snapshot\">\n      <CardHeader className=\"pb-2\">\n        <CardTitle className=\"text-sm flex items-center gap-2\">\n          <AlertTriangle className=\"h-4 w-4\" />\n          Risk & Issue Snapshot\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-3\">\n        <div className=\"space-y-1\">\n          <p className=\"text-xs font-medium text-muted-foreground flex items-center gap-1\">\n            <Eye className=\"h-3 w-3\" />\n            Risk Watchlist\n          </p>\n          <StatItem\n            label=\"Open Risks\"\n            value={openRisks.length}\n            icon={<AlertTriangle className=\"h-3.5 w-3.5 text-amber-500\" />}\n          />\n          {criticalRisks.length > 0 && (\n            <StatItem\n              label=\"Critical/High\"\n              value={criticalRisks.length}\n              icon={<Zap className=\"h-3.5 w-3.5 text-red-500\" />}\n              badgeVariant=\"destructive\"\n            />\n          )}\n          <StatItem\n            label=\"In Mitigation\"\n            value={mitigatingRisks.length}\n            icon={<Shield className=\"h-3.5 w-3.5 text-blue-500\" />}\n          />\n        </div>\n\n        <div className=\"space-y-1\">\n          <p className=\"text-xs font-medium text-muted-foreground flex items-center gap-1\">\n            <Target className=\"h-3 w-3\" />\n            Issue Tracker\n          </p>\n          <StatItem\n            label=\"Open Issues\"\n            value={openIssues.length}\n            icon={<AlertTriangle className=\"h-3.5 w-3.5 text-orange-500\" />}\n          />\n          {criticalIssues.length > 0 && (\n            <StatItem\n              label=\"Critical/High\"\n              value={criticalIssues.length}\n              badgeVariant=\"destructive\"\n            />\n          )}\n          {overdueIssues.length > 0 && (\n            <StatItem\n              label=\"Overdue\"\n              value={overdueIssues.length}\n              icon={<TrendingDown className=\"h-3.5 w-3.5 text-red-500\" />}\n              badgeVariant=\"destructive\"\n            />\n          )}\n        </div>\n\n        <div className=\"pt-2 border-t space-y-2\">\n          <div className=\"flex items-center justify-between\">\n            <span className=\"text-xs text-muted-foreground\">Avg Risk Score</span>\n            <span className=\"text-sm font-semibold\">{avgRiskScore}/5</span>\n          </div>\n          {totalExposure > 0 && (\n            <div className=\"flex items-center justify-between\">\n              <span className=\"text-xs text-muted-foreground\">Total Exposure</span>\n              <span className=\"text-sm font-semibold text-amber-600 dark:text-amber-400\">\n                {formatCurrency(totalExposure)}\n              </span>\n            </div>\n          )}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":6262},"client/src/components/widgets/index.ts":{"content":"export { PortfolioSignals } from \"./PortfolioSignals\";\nexport { UpcomingEvents, EventLegend } from \"./UpcomingEvents\";\nexport { CadencePlaybook, ReviewsWidget } from \"./CadencePlaybook\";\nexport { ResourceSnapshot } from \"./ResourceSnapshot\";\nexport { RiskSnapshot } from \"./RiskSnapshot\";\nexport { CostSnapshot } from \"./CostSnapshot\";\nexport { WBSLinkage } from \"./WBSLinkage\";\nexport { DocumentStats } from \"./DocumentStats\";\nexport { DocumentDetails } from \"./DocumentDetails\";\n","size_bytes":481},"client/src/components/widgets/DocumentStats.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { \n  FileText, CheckCircle, Clock, AlertCircle, \n  FileCheck, FolderOpen, File\n} from \"lucide-react\";\nimport { useDocumentsOptional } from \"@/contexts/DocumentContext\";\n\ninterface StatItemProps {\n  label: string;\n  value: number;\n  icon?: React.ReactNode;\n  badgeVariant?: \"default\" | \"secondary\" | \"destructive\" | \"outline\";\n}\n\nfunction StatItem({ label, value, icon, badgeVariant }: StatItemProps) {\n  return (\n    <div className=\"flex items-center justify-between py-1.5\">\n      <div className=\"flex items-center gap-2\">\n        {icon}\n        <span className=\"text-sm\">{label}</span>\n      </div>\n      <Badge variant={badgeVariant || \"secondary\"} className=\"tabular-nums\">\n        {value}\n      </Badge>\n    </div>\n  );\n}\n\nexport function DocumentStats() {\n  const docContext = useDocumentsOptional();\n  const documents = docContext?.documents || [];\n  const isLoading = docContext?.isLoading ?? false;\n\n  if (isLoading) {\n    return (\n      <Card data-testid=\"widget-document-stats\">\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-sm flex items-center gap-2\">\n            <FileText className=\"h-4 w-4\" />\n            Document Statistics\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-3\">\n          {[1, 2, 3, 4].map((i) => (\n            <div key={i} className=\"flex items-center justify-between py-1.5\">\n              <Skeleton className=\"h-4 w-24\" />\n              <Skeleton className=\"h-5 w-8\" />\n            </div>\n          ))}\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const totalDocs = documents.length;\n  const draftDocs = documents.filter(d => d.status === \"draft\");\n  const ifaDocs = documents.filter(d => d.status === \"ifa\");\n  const ifcDocs = documents.filter(d => d.status === \"ifc\");\n  const asBuiltDocs = documents.filter(d => d.status === \"as-built\");\n  const supersededDocs = documents.filter(d => d.status === \"superseded\");\n  const withAttachments = documents.filter(d => d.filePath);\n\n  const technicalDocs = documents.filter(d => \n    [\"drawing\", \"specification\", \"datasheet\", \"calculation\", \"report\"].includes(d.documentType || \"\")\n  );\n  const procedureDocs = documents.filter(d => \n    [\"sop\", \"procedure\", \"work-instruction\", \"checklist\"].includes(d.documentType || \"\")\n  );\n  const commercialDocs = documents.filter(d => \n    [\"invoice\", \"rfp\", \"contract\", \"purchase-order\", \"quote\", \"warranty\"].includes(d.documentType || \"\")\n  );\n\n  return (\n    <Card data-testid=\"widget-document-stats\">\n      <CardHeader className=\"pb-2\">\n        <CardTitle className=\"text-sm flex items-center gap-2\">\n          <FileText className=\"h-4 w-4\" />\n          Document Statistics\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-3\">\n        <div className=\"grid grid-cols-2 gap-2\">\n          <div className=\"p-3 rounded-lg bg-primary/10 flex items-center gap-2\">\n            <FileText className=\"h-5 w-5 text-primary\" />\n            <div>\n              <p className=\"text-xl font-bold\">{totalDocs}</p>\n              <p className=\"text-xs text-muted-foreground\">Total Documents</p>\n            </div>\n          </div>\n          <div className=\"p-3 rounded-lg bg-blue-500/10 flex items-center gap-2\">\n            <File className=\"h-5 w-5 text-blue-500\" />\n            <div>\n              <p className=\"text-xl font-bold\">{ifcDocs.length}</p>\n              <p className=\"text-xs text-muted-foreground\">Issued for Construction</p>\n            </div>\n          </div>\n          <div className=\"p-3 rounded-lg bg-amber-500/10 flex items-center gap-2\">\n            <Clock className=\"h-5 w-5 text-amber-500\" />\n            <div>\n              <p className=\"text-xl font-bold\">{ifaDocs.length}</p>\n              <p className=\"text-xs text-muted-foreground\">Pending Approval</p>\n            </div>\n          </div>\n          <div className=\"p-3 rounded-lg bg-green-500/10 flex items-center gap-2\">\n            <FolderOpen className=\"h-5 w-5 text-green-500\" />\n            <div>\n              <p className=\"text-xl font-bold\">{withAttachments.length}</p>\n              <p className=\"text-xs text-muted-foreground\">With Files</p>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"border-t pt-3 space-y-1\">\n          <p className=\"text-xs font-medium text-muted-foreground flex items-center gap-1\">\n            <FolderOpen className=\"h-3 w-3\" />\n            Status Breakdown\n          </p>\n          <StatItem\n            label=\"Draft\"\n            value={draftDocs.length}\n            icon={<Clock className=\"h-3.5 w-3.5 text-amber-500\" />}\n            badgeVariant=\"secondary\"\n          />\n          <StatItem\n            label=\"IFA (For Approval)\"\n            value={ifaDocs.length}\n            icon={<AlertCircle className=\"h-3.5 w-3.5 text-blue-500\" />}\n            badgeVariant=\"outline\"\n          />\n          <StatItem\n            label=\"IFC (For Construction)\"\n            value={ifcDocs.length}\n            icon={<CheckCircle className=\"h-3.5 w-3.5 text-green-500\" />}\n            badgeVariant=\"default\"\n          />\n          <StatItem\n            label=\"As-Built\"\n            value={asBuiltDocs.length}\n            icon={<FileCheck className=\"h-3.5 w-3.5 text-emerald-600\" />}\n            badgeVariant=\"default\"\n          />\n        </div>\n\n        <div className=\"border-t pt-2 space-y-1\">\n          <p className=\"text-xs font-medium text-muted-foreground flex items-center gap-1\">\n            <FileText className=\"h-3 w-3\" />\n            Document Categories\n          </p>\n          <StatItem\n            label=\"Technical\"\n            value={technicalDocs.length}\n            icon={<div className=\"h-2.5 w-2.5 rounded-full bg-blue-500\" />}\n          />\n          <StatItem\n            label=\"Procedures\"\n            value={procedureDocs.length}\n            icon={<div className=\"h-2.5 w-2.5 rounded-full bg-amber-500\" />}\n          />\n          <StatItem\n            label=\"Commercial\"\n            value={commercialDocs.length}\n            icon={<div className=\"h-2.5 w-2.5 rounded-full bg-green-500\" />}\n          />\n        </div>\n\n        <div className=\"border-t pt-2 space-y-1\">\n          <p className=\"text-xs font-medium text-muted-foreground\">Quick Stats</p>\n          <div className=\"grid grid-cols-2 gap-2 text-center\">\n            <div className=\"p-2 rounded-md bg-muted/50\">\n              <p className=\"text-lg font-semibold\">{withAttachments.length}</p>\n              <p className=\"text-xs text-muted-foreground\">With Files</p>\n            </div>\n            <div className=\"p-2 rounded-md bg-muted/50\">\n              <p className=\"text-lg font-semibold\">{supersededDocs.length}</p>\n              <p className=\"text-xs text-muted-foreground\">Superseded</p>\n            </div>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":6995},"client/src/contexts/DocumentContext.tsx":{"content":"import { createContext, useContext, useState, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport type { Document } from \"@shared/schema\";\n\ninterface DocumentContextType {\n  documents: Document[];\n  isLoading: boolean;\n  selectedDocumentId: number | null;\n  selectedDocument: Document | null;\n  setSelectedDocumentId: (id: number | null) => void;\n}\n\nconst DocumentContext = createContext<DocumentContextType | undefined>(undefined);\n\nexport function DocumentProvider({ children }: { children: React.ReactNode }) {\n  const { selectedProjectId } = useProject();\n  const [selectedDocumentId, setSelectedDocumentId] = useState<number | null>(null);\n\n  const { data: documents = [], isLoading } = useQuery<Document[]>({\n    queryKey: [\"/api/projects\", selectedProjectId, \"documents\"],\n    enabled: !!selectedProjectId,\n    refetchInterval: 15 * 60 * 1000,\n  });\n\n  const selectedDocument = useMemo(() => {\n    if (!selectedDocumentId) return null;\n    return documents.find(d => d.id === selectedDocumentId) || null;\n  }, [documents, selectedDocumentId]);\n\n  const value: DocumentContextType = {\n    documents,\n    isLoading,\n    selectedDocumentId,\n    selectedDocument,\n    setSelectedDocumentId,\n  };\n\n  return (\n    <DocumentContext.Provider value={value}>\n      {children}\n    </DocumentContext.Provider>\n  );\n}\n\nexport function useDocuments() {\n  const context = useContext(DocumentContext);\n  if (context === undefined) {\n    throw new Error(\"useDocuments must be used within a DocumentProvider\");\n  }\n  return context;\n}\n\nexport function useDocumentsOptional() {\n  return useContext(DocumentContext);\n}\n","size_bytes":1691},"client/src/components/widgets/DocumentDetails.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { \n  FileText, Calendar, User, Tag, \n  Download, ExternalLink, Clock, File\n} from \"lucide-react\";\nimport { useDocumentsOptional } from \"@/contexts/DocumentContext\";\nimport { format } from \"date-fns\";\n\nconst DOC_STATUSES: Record<string, { label: string; variant: \"default\" | \"secondary\" | \"destructive\" | \"outline\" }> = {\n  \"draft\": { label: \"Draft\", variant: \"secondary\" },\n  \"ifa\": { label: \"Issued for Approval\", variant: \"outline\" },\n  \"ifc\": { label: \"Issued for Construction\", variant: \"default\" },\n  \"as-built\": { label: \"As-Built\", variant: \"default\" },\n  \"superseded\": { label: \"Superseded\", variant: \"destructive\" },\n  \"cancelled\": { label: \"Cancelled\", variant: \"destructive\" },\n};\n\nconst DISCIPLINES: Record<string, string> = {\n  \"civil\": \"Civil\",\n  \"structural\": \"Structural\",\n  \"mechanical\": \"Mechanical\",\n  \"electrical\": \"Electrical\",\n  \"instrumentation\": \"Instrumentation\",\n  \"piping\": \"Piping\",\n  \"process\": \"Process\",\n  \"hse\": \"HSE\",\n  \"project-controls\": \"Project Controls\",\n  \"construction\": \"Construction\",\n  \"commissioning\": \"Commissioning\",\n  \"general\": \"General\",\n};\n\nconst DOC_TYPES: Record<string, string> = {\n  \"drawing\": \"Drawing\",\n  \"specification\": \"Specification\",\n  \"datasheet\": \"Datasheet\",\n  \"calculation\": \"Calculation\",\n  \"report\": \"Report\",\n  \"sop\": \"SOP\",\n  \"procedure\": \"Procedure\",\n  \"work-instruction\": \"Work Instruction\",\n  \"checklist\": \"Checklist\",\n  \"invoice\": \"Invoice\",\n  \"rfp\": \"RFP\",\n  \"contract\": \"Contract\",\n  \"purchase-order\": \"Purchase Order\",\n  \"quote\": \"Quote\",\n  \"warranty\": \"Warranty\",\n  \"vendor-doc\": \"Vendor Document\",\n  \"certificate\": \"Certificate\",\n  \"lessons-learned\": \"Lessons Learned\",\n  \"bulletin\": \"Bulletin\",\n  \"meeting-minutes\": \"Meeting Minutes\",\n  \"transmittal\": \"Transmittal\",\n  \"rfi\": \"RFI\",\n  \"ncr\": \"NCR\",\n  \"letter\": \"Letter\",\n  \"email\": \"Email\",\n  \"memo\": \"Memo\",\n};\n\nfunction formatFileSize(bytes: number): string {\n  if (bytes === 0) return '0 Bytes';\n  const k = 1024;\n  const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\n  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n}\n\nexport function DocumentDetails() {\n  const context = useDocumentsOptional();\n  \n  if (!context) {\n    return null;\n  }\n\n  const { selectedDocument } = context;\n\n  if (!selectedDocument) {\n    return (\n      <Card data-testid=\"widget-document-details\">\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-sm flex items-center gap-2\">\n            <FileText className=\"h-4 w-4\" />\n            Document Details\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex flex-col items-center justify-center py-6 text-center\">\n            <FileText className=\"h-8 w-8 text-muted-foreground mb-2\" />\n            <p className=\"text-sm text-muted-foreground\">\n              Select a document from the list to view its details\n            </p>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const statusInfo = DOC_STATUSES[selectedDocument.status || \"draft\"] || DOC_STATUSES.draft;\n  const discipline = DISCIPLINES[selectedDocument.discipline || \"general\"] || selectedDocument.discipline || \"General\";\n  const docType = DOC_TYPES[selectedDocument.documentType || \"drawing\"] || selectedDocument.documentType || \"Document\";\n\n  return (\n    <Card data-testid=\"widget-document-details\">\n      <CardHeader className=\"pb-2\">\n        <CardTitle className=\"text-sm flex items-center gap-2\">\n          <FileText className=\"h-4 w-4\" />\n          Document Details\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-3\">\n        <div>\n          <p className=\"text-xs text-muted-foreground\">Document Number</p>\n          <p className=\"text-sm font-medium\">{selectedDocument.documentNumber}</p>\n        </div>\n\n        <div>\n          <p className=\"text-xs text-muted-foreground\">Title</p>\n          <p className=\"text-sm\">{selectedDocument.title}</p>\n        </div>\n\n        <Separator />\n\n        <div className=\"grid grid-cols-2 gap-3\">\n          <div>\n            <p className=\"text-xs text-muted-foreground flex items-center gap-1\">\n              <Tag className=\"h-3 w-3\" />\n              Type\n            </p>\n            <p className=\"text-sm\">{docType}</p>\n          </div>\n          <div>\n            <p className=\"text-xs text-muted-foreground\">Discipline</p>\n            <p className=\"text-sm\">{discipline}</p>\n          </div>\n        </div>\n\n        <div className=\"grid grid-cols-2 gap-3\">\n          <div>\n            <p className=\"text-xs text-muted-foreground\">Revision</p>\n            <p className=\"text-sm font-medium\">{selectedDocument.revision || \"A\"}</p>\n          </div>\n          <div>\n            <p className=\"text-xs text-muted-foreground\">Status</p>\n            <Badge variant={statusInfo.variant} className=\"mt-0.5\">\n              {statusInfo.label}\n            </Badge>\n          </div>\n        </div>\n\n        {selectedDocument.description && (\n          <>\n            <Separator />\n            <div>\n              <p className=\"text-xs text-muted-foreground\">Description</p>\n              <p className=\"text-sm text-muted-foreground mt-1\">{selectedDocument.description}</p>\n            </div>\n          </>\n        )}\n\n        {selectedDocument.filePath && (\n          <>\n            <Separator />\n            <div className=\"flex items-center justify-between p-2 rounded-md bg-muted/30\">\n              <div className=\"flex items-center gap-2\">\n                <File className=\"h-4 w-4 text-muted-foreground\" />\n                <div>\n                  <p className=\"text-xs\">Attached File</p>\n                  {selectedDocument.fileSize && (\n                    <p className=\"text-xs text-muted-foreground\">{formatFileSize(selectedDocument.fileSize)}</p>\n                  )}\n                </div>\n              </div>\n              <Button variant=\"ghost\" size=\"icon\" data-testid=\"button-download-file\">\n                <Download className=\"h-4 w-4\" />\n              </Button>\n            </div>\n          </>\n        )}\n\n        {selectedDocument.createdAt && (\n          <div className=\"pt-2 border-t\">\n            <p className=\"text-xs text-muted-foreground flex items-center gap-1\">\n              <Clock className=\"h-3 w-3\" />\n              Created {format(new Date(selectedDocument.createdAt), \"MMM d, yyyy\")}\n            </p>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":6686},"client/src/pages/PMOCalendarPage.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { ChevronLeft, ChevronRight, Loader2, AlertTriangle } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { cn } from \"@/lib/utils\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { TaskModal } from \"@/components/TaskModal\";\nimport type { Task } from \"@shared/schema\";\n\ntype OrgTask = Task & { projectName: string };\n\nconst WEEKDAYS = [\"Sun\", \"Mon\", \"Tue\", \"Wed\", \"Thu\", \"Fri\", \"Sat\"];\n\nconst getStatusColor = (status: string) => {\n  switch (status) {\n    case \"completed\": return \"bg-green-500\";\n    case \"in-progress\": return \"bg-blue-500\";\n    case \"review\": return \"bg-purple-500\";\n    case \"on-hold\": return \"bg-amber-500\";\n    default: return \"bg-gray-400\";\n  }\n};\n\nconst getPriorityBorder = (priority: string) => {\n  switch (priority) {\n    case \"critical\": return \"border-l-2 border-l-red-500\";\n    case \"high\": return \"border-l-2 border-l-orange-500\";\n    default: return \"\";\n  }\n};\n\nconst getProjectColor = (projectId: number): string => {\n  const colors = [\n    \"bg-blue-500\", \"bg-green-500\", \"bg-purple-500\", \"bg-orange-500\", \n    \"bg-pink-500\", \"bg-teal-500\", \"bg-indigo-500\", \"bg-amber-500\"\n  ];\n  return colors[projectId % colors.length];\n};\n\nexport default function PMOCalendarPage() {\n  const { selectedOrgId, selectedOrg, isLoadingOrgs } = useProject();\n  const [currentDate, setCurrentDate] = useState(new Date());\n  const [selectedTask, setSelectedTask] = useState<Task | undefined>();\n  const [taskModalOpen, setTaskModalOpen] = useState(false);\n\n  const { \n    data: tasks = [], \n    isLoading \n  } = useQuery<OrgTask[]>({\n    queryKey: [`/api/organizations/${selectedOrgId}/pmo/calendar`],\n    enabled: !!selectedOrgId,\n  });\n\n  const { year, month, daysInMonth, startDay, today, monthName } = useMemo(() => {\n    const y = currentDate.getFullYear();\n    const m = currentDate.getMonth();\n    const firstDay = new Date(y, m, 1);\n    const lastDay = new Date(y, m + 1, 0);\n    const todayDate = new Date();\n    \n    return {\n      year: y,\n      month: m,\n      daysInMonth: lastDay.getDate(),\n      startDay: firstDay.getDay(),\n      today: todayDate.getFullYear() === y && todayDate.getMonth() === m ? todayDate.getDate() : -1,\n      monthName: firstDay.toLocaleDateString(\"en-US\", { month: \"long\", year: \"numeric\" }),\n    };\n  }, [currentDate]);\n\n  const tasksOnDate = useMemo(() => {\n    const taskMap: Map<number, OrgTask[]> = new Map();\n    \n    tasks.forEach(task => {\n      if (task.startDate) {\n        const startDate = new Date(task.startDate);\n        if (startDate.getFullYear() === year && startDate.getMonth() === month) {\n          const day = startDate.getDate();\n          if (!taskMap.has(day)) taskMap.set(day, []);\n          taskMap.get(day)!.push({ ...task, _isStart: true } as any);\n        }\n      }\n      if (task.endDate) {\n        const endDate = new Date(task.endDate);\n        if (endDate.getFullYear() === year && endDate.getMonth() === month) {\n          const day = endDate.getDate();\n          if (!taskMap.has(day)) taskMap.set(day, []);\n          const existing = taskMap.get(day)!.find(t => t.id === task.id);\n          if (!existing) {\n            taskMap.get(day)!.push({ ...task, _isEnd: true } as any);\n          }\n        }\n      }\n    });\n    \n    return taskMap;\n  }, [tasks, year, month]);\n\n  const upcomingTasks = useMemo(() => {\n    const now = new Date();\n    return tasks\n      .filter(task => {\n        if (!task.endDate) return false;\n        const endDate = new Date(task.endDate);\n        return endDate >= now && task.status !== \"completed\";\n      })\n      .sort((a, b) => new Date(a.endDate!).getTime() - new Date(b.endDate!).getTime())\n      .slice(0, 10);\n  }, [tasks]);\n\n  const projectStats = useMemo(() => {\n    const stats = new Map<string, { count: number; projectId: number }>();\n    tasks.forEach(task => {\n      const name = task.projectName;\n      if (!stats.has(name)) {\n        stats.set(name, { count: 0, projectId: task.projectId });\n      }\n      stats.get(name)!.count++;\n    });\n    return Array.from(stats.entries()).map(([name, data]) => ({ name, ...data }));\n  }, [tasks]);\n\n  const weeks = Math.ceil((daysInMonth + startDay) / 7);\n\n  const goToPrevMonth = () => {\n    setCurrentDate(new Date(year, month - 1, 1));\n  };\n\n  const goToNextMonth = () => {\n    setCurrentDate(new Date(year, month + 1, 1));\n  };\n\n  const goToToday = () => {\n    setCurrentDate(new Date());\n  };\n\n  const handleTaskClick = (task: Task) => {\n    setSelectedTask(task);\n    setTaskModalOpen(true);\n  };\n\n  const getDaysUntil = (date: string | Date) => {\n    const target = typeof date === 'string' ? new Date(date) : date;\n    const now = new Date();\n    const diff = Math.ceil((target.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n    if (diff === 0) return \"Today\";\n    if (diff === 1) return \"Tomorrow\";\n    if (diff < 0) return `${Math.abs(diff)} days ago`;\n    return `${diff} days`;\n  };\n\n  if (!selectedOrgId) {\n    return (\n      <div className=\"p-6\">\n        <Alert>\n          <AlertTriangle className=\"h-4 w-4\" />\n          <AlertDescription>\n            Please select an organization to view the PMO calendar.\n          </AlertDescription>\n        </Alert>\n      </div>\n    );\n  }\n\n  if (isLoading || isLoadingOrgs) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-4\">\n      <div className=\"flex items-center justify-between flex-wrap gap-4\">\n        <div>\n          <h1 className=\"text-3xl font-semibold\" data-testid=\"page-title-pmo-calendar\">PMO Calendar</h1>\n          <p className=\"text-muted-foreground\">\n            Organization-wide project timeline for {selectedOrg?.name || 'All Projects'}\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Button variant=\"outline\" size=\"sm\" onClick={goToToday} data-testid=\"button-today\">\n            Today\n          </Button>\n          <Button variant=\"outline\" size=\"icon\" onClick={goToPrevMonth} data-testid=\"button-prev-month\">\n            <ChevronLeft className=\"h-4 w-4\" />\n          </Button>\n          <div className=\"px-4 font-semibold min-w-[180px] text-center\">{monthName}</div>\n          <Button variant=\"outline\" size=\"icon\" onClick={goToNextMonth} data-testid=\"button-next-month\">\n            <ChevronRight className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      </div>\n\n      {projectStats.length > 0 && (\n        <div className=\"flex flex-wrap gap-2\">\n          {projectStats.map(({ name, count, projectId }) => (\n            <Badge key={projectId} variant=\"outline\" className=\"gap-1.5\">\n              <span className={cn(\"w-2 h-2 rounded-full\", getProjectColor(projectId))} />\n              {name} ({count})\n            </Badge>\n          ))}\n        </div>\n      )}\n\n      <Card>\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-lg\">Monthly View</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-7 gap-px bg-border rounded-lg overflow-hidden\">\n            {WEEKDAYS.map((day) => (\n              <div\n                key={day}\n                className=\"bg-muted p-3 text-center text-sm font-semibold\"\n              >\n                {day}\n              </div>\n            ))}\n\n            {Array.from({ length: weeks * 7 }).map((_, index) => {\n              const dayNumber = index - startDay + 1;\n              const isValidDay = dayNumber > 0 && dayNumber <= daysInMonth;\n              const isToday = dayNumber === today;\n              const dayTasks = tasksOnDate.get(dayNumber) || [];\n\n              return (\n                <div\n                  key={index}\n                  className={cn(\n                    \"bg-background p-2 min-h-28\",\n                    isToday && \"ring-2 ring-primary ring-inset\",\n                    !isValidDay && \"bg-muted/30\"\n                  )}\n                  data-testid={isValidDay ? `calendar-day-${dayNumber}` : undefined}\n                >\n                  {isValidDay && (\n                    <>\n                      <div\n                        className={cn(\n                          \"text-sm font-semibold mb-2\",\n                          isToday && \"text-primary\"\n                        )}\n                      >\n                        {dayNumber}\n                      </div>\n                      <div className=\"space-y-1\">\n                        {dayTasks.slice(0, 3).map((task: any) => (\n                          <div\n                            key={`${task.id}-${task._isStart ? 'start' : 'end'}`}\n                            className={cn(\n                              \"text-xs px-1.5 py-0.5 rounded text-white truncate cursor-pointer hover:opacity-80\",\n                              getProjectColor(task.projectId),\n                              getPriorityBorder(task.priority)\n                            )}\n                            title={`${task.projectName}: ${task.name} (${task._isStart ? 'Start' : 'Due'})`}\n                            onClick={() => handleTaskClick(task)}\n                            data-testid={`calendar-task-${task.id}`}\n                          >\n                            {task._isStart ? \"▶ \" : \"◼ \"}{task.name}\n                          </div>\n                        ))}\n                        {dayTasks.length > 3 && (\n                          <div className=\"text-xs text-muted-foreground\">\n                            +{dayTasks.length - 3} more\n                          </div>\n                        )}\n                      </div>\n                    </>\n                  )}\n                </div>\n              );\n            })}\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-lg\">Upcoming Deadlines Across Projects</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {upcomingTasks.length === 0 ? (\n            <p className=\"text-sm text-muted-foreground text-center py-8\">\n              No upcoming deadlines. All tasks are either completed or have no end date set.\n            </p>\n          ) : (\n            <div className=\"space-y-3\">\n              {upcomingTasks.map((task) => (\n                <div \n                  key={task.id} \n                  className={cn(\n                    \"flex items-center gap-3 p-3 rounded-lg hover-elevate cursor-pointer\",\n                    getPriorityBorder(task.priority)\n                  )}\n                  onClick={() => handleTaskClick(task)}\n                  data-testid={`upcoming-task-${task.id}`}\n                >\n                  <div className={cn(\"w-1 h-12 rounded\", getProjectColor(task.projectId))} />\n                  <div className=\"flex-1 min-w-0\">\n                    <p className=\"font-medium truncate\">{task.name}</p>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {task.projectName} • Due: {new Date(task.endDate!).toLocaleDateString(\"en-US\", { \n                        month: \"short\", \n                        day: \"numeric\",\n                        year: \"numeric\"\n                      })}\n                    </p>\n                  </div>\n                  <Badge variant={task.priority === \"critical\" ? \"destructive\" : \"outline\"}>\n                    {getDaysUntil(task.endDate!)}\n                  </Badge>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      <TaskModal\n        open={taskModalOpen}\n        onOpenChange={setTaskModalOpen}\n        task={selectedTask}\n      />\n    </div>\n  );\n}\n","size_bytes":11994},"client/src/pages/PMOInventoryPage.tsx":{"content":"import { useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { \n  Users, \n  Package, \n  AlertTriangle, \n  HardHat,\n  Wrench,\n  Truck,\n  DollarSign\n} from \"lucide-react\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { cn } from \"@/lib/utils\";\nimport type { Resource } from \"@shared/schema\";\n\ntype OrgResource = Resource & { projectName: string };\n\nconst getResourceTypeIcon = (type: string) => {\n  switch (type) {\n    case \"labor\": return HardHat;\n    case \"equipment\": return Wrench;\n    case \"material\": return Package;\n    default: return Users;\n  }\n};\n\nconst getResourceTypeColor = (type: string) => {\n  switch (type) {\n    case \"labor\": return \"bg-blue-500\";\n    case \"equipment\": return \"bg-purple-500\";\n    case \"material\": return \"bg-amber-500\";\n    default: return \"bg-gray-400\";\n  }\n};\n\nconst getProjectColor = (projectId: number): string => {\n  const colors = [\n    \"bg-blue-500\", \"bg-green-500\", \"bg-purple-500\", \"bg-orange-500\", \n    \"bg-pink-500\", \"bg-teal-500\", \"bg-indigo-500\", \"bg-amber-500\"\n  ];\n  return colors[projectId % colors.length];\n};\n\nfunction formatCurrency(value: number): string {\n  if (value >= 1000000) {\n    return `$${(value / 1000000).toFixed(1)}M`;\n  }\n  if (value >= 1000) {\n    return `$${(value / 1000).toFixed(0)}K`;\n  }\n  return `$${value.toFixed(0)}`;\n}\n\nfunction StatCard({ \n  title, \n  value, \n  subtitle, \n  icon: Icon,\n  className \n}: { \n  title: string; \n  value: string | number; \n  subtitle?: string; \n  icon: React.ElementType;\n  className?: string;\n}) {\n  return (\n    <Card className={cn(\"relative overflow-hidden\", className)}>\n      <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2 gap-2\">\n        <CardTitle className=\"text-sm font-medium\">{title}</CardTitle>\n        <Icon className=\"h-4 w-4 text-muted-foreground\" />\n      </CardHeader>\n      <CardContent>\n        <div className=\"text-2xl font-bold\">{value}</div>\n        {subtitle && (\n          <p className=\"text-xs text-muted-foreground mt-1\">{subtitle}</p>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\nexport default function PMOInventoryPage() {\n  const { selectedOrgId, selectedOrg, isLoadingOrgs } = useProject();\n\n  const { data: resources = [], isLoading, error } = useQuery<OrgResource[]>({\n    queryKey: [`/api/organizations/${selectedOrgId}/pmo/inventory`],\n    enabled: !!selectedOrgId,\n  });\n\n  const stats = useMemo(() => {\n    const laborResources = resources.filter(r => r.type === 'labor' || r.type === 'human');\n    const equipmentResources = resources.filter(r => r.type === 'equipment');\n    const materialResources = resources.filter(r => r.type === 'material');\n    \n    const totalCost = resources.reduce((sum, r) => sum + (Number(r.rate) || 0), 0);\n    const laborCost = laborResources.reduce((sum, r) => sum + (Number(r.rate) || 0), 0);\n    const equipmentCost = equipmentResources.reduce((sum, r) => sum + (Number(r.rate) || 0), 0);\n    const materialCost = materialResources.reduce((sum, r) => sum + (Number(r.rate) || 0), 0);\n\n    return {\n      total: resources.length,\n      labor: laborResources.length,\n      equipment: equipmentResources.length,\n      material: materialResources.length,\n      totalCost,\n      laborCost,\n      equipmentCost,\n      materialCost,\n    };\n  }, [resources]);\n\n  const projectBreakdown = useMemo(() => {\n    const breakdown = new Map<string, { \n      projectId: number;\n      labor: number; \n      equipment: number; \n      material: number;\n      totalCost: number;\n    }>();\n    \n    resources.forEach(resource => {\n      if (!breakdown.has(resource.projectName)) {\n        breakdown.set(resource.projectName, { \n          projectId: resource.projectId,\n          labor: 0, \n          equipment: 0, \n          material: 0,\n          totalCost: 0\n        });\n      }\n      const stats = breakdown.get(resource.projectName)!;\n      const cost = Number(resource.rate) || 0;\n      stats.totalCost += cost;\n      \n      if (resource.type === 'labor' || resource.type === 'human') stats.labor++;\n      else if (resource.type === 'equipment') stats.equipment++;\n      else if (resource.type === 'material') stats.material++;\n    });\n    \n    return Array.from(breakdown.entries()).map(([name, data]) => ({\n      name,\n      ...data\n    }));\n  }, [resources]);\n\n  if (!selectedOrgId) {\n    return (\n      <div className=\"p-6\">\n        <Alert>\n          <AlertTriangle className=\"h-4 w-4\" />\n          <AlertDescription>\n            Please select an organization to view the inventory.\n          </AlertDescription>\n        </Alert>\n      </div>\n    );\n  }\n\n  if (isLoading || isLoadingOrgs) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <div>\n          <Skeleton className=\"h-8 w-64 mb-2\" />\n          <Skeleton className=\"h-4 w-96\" />\n        </div>\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n          {Array.from({ length: 4 }).map((_, i) => (\n            <Skeleton key={i} className=\"h-32\" />\n          ))}\n        </div>\n        <Skeleton className=\"h-64\" />\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"p-6\">\n        <Alert variant=\"destructive\">\n          <AlertTriangle className=\"h-4 w-4\" />\n          <AlertDescription>\n            Failed to load inventory data. Please try again.\n          </AlertDescription>\n        </Alert>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-semibold\" data-testid=\"page-title-pmo-inventory\">Inventory Management</h1>\n        <p className=\"text-muted-foreground\">\n          Organization-wide resource inventory for {selectedOrg?.name || 'All Projects'}\n        </p>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        <StatCard\n          title=\"Total Resources\"\n          value={stats.total}\n          subtitle={`Across ${projectBreakdown.length} projects`}\n          icon={Package}\n          data-testid=\"stat-total-resources\"\n        />\n        <StatCard\n          title=\"Labor Resources\"\n          value={stats.labor}\n          subtitle={formatCurrency(stats.laborCost)}\n          icon={HardHat}\n          data-testid=\"stat-labor-resources\"\n        />\n        <StatCard\n          title=\"Equipment\"\n          value={stats.equipment}\n          subtitle={formatCurrency(stats.equipmentCost)}\n          icon={Wrench}\n          data-testid=\"stat-equipment\"\n        />\n        <StatCard\n          title=\"Materials\"\n          value={stats.material}\n          subtitle={formatCurrency(stats.materialCost)}\n          icon={Truck}\n          data-testid=\"stat-materials\"\n        />\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <DollarSign className=\"h-5 w-5\" />\n              Resource Cost Distribution\n            </CardTitle>\n            <CardDescription>Cost breakdown by resource type</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <div className=\"flex justify-between text-sm\">\n                <span className=\"flex items-center gap-2\">\n                  <span className=\"w-3 h-3 rounded-full bg-blue-500\" />\n                  Labor\n                </span>\n                <span className=\"font-medium\">{formatCurrency(stats.laborCost)}</span>\n              </div>\n              <Progress \n                value={stats.totalCost > 0 ? (stats.laborCost / stats.totalCost) * 100 : 0} \n                className=\"h-2 bg-muted\" \n              />\n            </div>\n            <div className=\"space-y-2\">\n              <div className=\"flex justify-between text-sm\">\n                <span className=\"flex items-center gap-2\">\n                  <span className=\"w-3 h-3 rounded-full bg-purple-500\" />\n                  Equipment\n                </span>\n                <span className=\"font-medium\">{formatCurrency(stats.equipmentCost)}</span>\n              </div>\n              <Progress \n                value={stats.totalCost > 0 ? (stats.equipmentCost / stats.totalCost) * 100 : 0} \n                className=\"h-2 bg-muted\" \n              />\n            </div>\n            <div className=\"space-y-2\">\n              <div className=\"flex justify-between text-sm\">\n                <span className=\"flex items-center gap-2\">\n                  <span className=\"w-3 h-3 rounded-full bg-amber-500\" />\n                  Materials\n                </span>\n                <span className=\"font-medium\">{formatCurrency(stats.materialCost)}</span>\n              </div>\n              <Progress \n                value={stats.totalCost > 0 ? (stats.materialCost / stats.totalCost) * 100 : 0} \n                className=\"h-2 bg-muted\" \n              />\n            </div>\n            <div className=\"pt-4 border-t\">\n              <div className=\"flex justify-between text-sm font-semibold\">\n                <span>Total Resource Value</span>\n                <span>{formatCurrency(stats.totalCost)}</span>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Package className=\"h-5 w-5\" />\n              Resources by Project\n            </CardTitle>\n            <CardDescription>Resource distribution across projects</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {projectBreakdown.length === 0 ? (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                No resources found in any project.\n              </div>\n            ) : (\n              <div className=\"space-y-4\">\n                {projectBreakdown.map(({ name, projectId, labor, equipment, material, totalCost }) => (\n                  <div key={projectId} className=\"space-y-2\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center gap-2\">\n                        <span className={cn(\"w-2 h-2 rounded-full\", getProjectColor(projectId))} />\n                        <span className=\"font-medium truncate max-w-[200px]\">{name}</span>\n                      </div>\n                      <span className=\"text-sm text-muted-foreground\">{formatCurrency(totalCost)}</span>\n                    </div>\n                    <div className=\"flex gap-2 text-xs text-muted-foreground\">\n                      {labor > 0 && (\n                        <Badge variant=\"outline\" className=\"gap-1\">\n                          <HardHat className=\"h-3 w-3\" /> {labor}\n                        </Badge>\n                      )}\n                      {equipment > 0 && (\n                        <Badge variant=\"outline\" className=\"gap-1\">\n                          <Wrench className=\"h-3 w-3\" /> {equipment}\n                        </Badge>\n                      )}\n                      {material > 0 && (\n                        <Badge variant=\"outline\" className=\"gap-1\">\n                          <Truck className=\"h-3 w-3\" /> {material}\n                        </Badge>\n                      )}\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Users className=\"h-5 w-5\" />\n            All Resources\n          </CardTitle>\n          <CardDescription>Complete resource inventory across organization</CardDescription>\n        </CardHeader>\n        <CardContent>\n          {resources.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              No resources found in this organization.\n            </div>\n          ) : (\n            <div className=\"overflow-x-auto\">\n              <table className=\"w-full\">\n                <thead>\n                  <tr className=\"border-b\">\n                    <th className=\"py-3 px-4 text-left text-sm font-medium text-muted-foreground\">Resource</th>\n                    <th className=\"py-3 px-4 text-left text-sm font-medium text-muted-foreground\">Type</th>\n                    <th className=\"py-3 px-4 text-left text-sm font-medium text-muted-foreground\">Project</th>\n                    <th className=\"py-3 px-4 text-left text-sm font-medium text-muted-foreground\">Discipline</th>\n                    <th className=\"py-3 px-4 text-right text-sm font-medium text-muted-foreground\">Rate</th>\n                    <th className=\"py-3 px-4 text-center text-sm font-medium text-muted-foreground\">Availability</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {resources.map((resource) => {\n                    const TypeIcon = getResourceTypeIcon(resource.type);\n                    return (\n                      <tr \n                        key={resource.id} \n                        className=\"border-b hover-elevate\"\n                        data-testid={`resource-row-${resource.id}`}\n                      >\n                        <td className=\"py-3 px-4\">\n                          <div className=\"flex items-center gap-2\">\n                            <div className={cn(\n                              \"w-8 h-8 rounded-full flex items-center justify-center\",\n                              getResourceTypeColor(resource.type) + \"/10\"\n                            )}>\n                              <TypeIcon className={cn(\n                                \"h-4 w-4\",\n                                (resource.type === 'labor' || resource.type === 'human') && \"text-blue-500\",\n                                resource.type === 'equipment' && \"text-purple-500\",\n                                resource.type === 'material' && \"text-amber-500\",\n                              )} />\n                            </div>\n                            <div>\n                              <p className=\"font-medium\">{resource.name}</p>\n                              {resource.discipline && resource.discipline !== 'general' && (\n                                <p className=\"text-xs text-muted-foreground capitalize\">{resource.discipline}</p>\n                              )}\n                            </div>\n                          </div>\n                        </td>\n                        <td className=\"py-3 px-4\">\n                          <Badge variant=\"outline\" className=\"capitalize\">\n                            {resource.type}\n                          </Badge>\n                        </td>\n                        <td className=\"py-3 px-4\">\n                          <div className=\"flex items-center gap-2\">\n                            <span className={cn(\"w-2 h-2 rounded-full\", getProjectColor(resource.projectId))} />\n                            <span className=\"text-sm truncate max-w-[150px]\">{resource.projectName}</span>\n                          </div>\n                        </td>\n                        <td className=\"py-3 px-4\">\n                          <span className=\"text-sm capitalize\">{resource.discipline || 'General'}</span>\n                        </td>\n                        <td className=\"py-3 px-4 text-right font-mono text-sm\">\n                          {formatCurrency(Number(resource.rate) || 0)}\n                          {resource.unitType && <span className=\"text-muted-foreground\">/{resource.unitType}</span>}\n                        </td>\n                        <td className=\"py-3 px-4 text-center\">\n                          <Badge variant={resource.availability === 100 ? \"outline\" : \"secondary\"}>\n                            {resource.availability || 100}%\n                          </Badge>\n                        </td>\n                      </tr>\n                    );\n                  })}\n                </tbody>\n              </table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":16357},"client/src/pages/PMODashboardPage.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { BarChart3, TrendingUp, AlertTriangle, CheckCircle2, Clock, DollarSign, FolderKanban, Activity, Loader2, Building2, Users, FileWarning, CircleDot } from \"lucide-react\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { cn } from \"@/lib/utils\";\n\ninterface PMODashboardData {\n  projectCount: number;\n  projects: Array<{ id: number; name: string; status: string }>;\n  taskStats: {\n    total: number;\n    completed: number;\n    inProgress: number;\n    notStarted: number;\n    onHold: number;\n  };\n  riskStats: {\n    total: number;\n    open: number;\n    mitigated: number;\n    closed: number;\n    highRisks: number;\n  };\n  issueStats: {\n    total: number;\n    open: number;\n    inProgress: number;\n    resolved: number;\n    critical: number;\n  };\n  budgetStats: {\n    totalBudget: number;\n    actualCost: number;\n    variance: number;\n    utilizationPercent: number;\n  };\n}\n\nfunction formatCurrency(value: number): string {\n  if (value >= 1000000) {\n    return `$${(value / 1000000).toFixed(1)}M`;\n  }\n  if (value >= 1000) {\n    return `$${(value / 1000).toFixed(0)}K`;\n  }\n  return `$${value.toFixed(0)}`;\n}\n\nfunction StatCard({ \n  title, \n  value, \n  subtitle, \n  icon: Icon, \n  trend,\n  className \n}: { \n  title: string; \n  value: string | number; \n  subtitle?: string; \n  icon: React.ElementType;\n  trend?: { value: number; positive: boolean };\n  className?: string;\n}) {\n  return (\n    <Card className={cn(\"relative overflow-hidden\", className)}>\n      <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2 gap-2\">\n        <CardTitle className=\"text-sm font-medium\">{title}</CardTitle>\n        <Icon className=\"h-4 w-4 text-muted-foreground\" />\n      </CardHeader>\n      <CardContent>\n        <div className=\"text-2xl font-bold\">{value}</div>\n        {subtitle && (\n          <p className=\"text-xs text-muted-foreground mt-1\">{subtitle}</p>\n        )}\n        {trend && (\n          <div className={cn(\n            \"flex items-center text-xs mt-1\",\n            trend.positive ? \"text-green-500\" : \"text-red-500\"\n          )}>\n            <TrendingUp className={cn(\"h-3 w-3 mr-1\", !trend.positive && \"rotate-180\")} />\n            {trend.value}%\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction ProjectStatusBadge({ status }: { status: string }) {\n  const variants: Record<string, { color: string; label: string }> = {\n    'planning': { color: 'bg-blue-500', label: 'Planning' },\n    'active': { color: 'bg-green-500', label: 'Active' },\n    'on-hold': { color: 'bg-amber-500', label: 'On Hold' },\n    'completed': { color: 'bg-gray-500', label: 'Completed' },\n    'cancelled': { color: 'bg-red-500', label: 'Cancelled' },\n  };\n  const variant = variants[status] || { color: 'bg-gray-400', label: status };\n  \n  return (\n    <Badge variant=\"outline\" className=\"gap-1.5\">\n      <span className={cn(\"w-2 h-2 rounded-full\", variant.color)} />\n      {variant.label}\n    </Badge>\n  );\n}\n\nexport default function PMODashboardPage() {\n  const { selectedOrgId, selectedOrg, isLoadingOrgs } = useProject();\n\n  const { data, isLoading, error } = useQuery<PMODashboardData>({\n    queryKey: [`/api/organizations/${selectedOrgId}/pmo/dashboard`],\n    enabled: !!selectedOrgId,\n  });\n\n  if (!selectedOrgId) {\n    return (\n      <div className=\"p-6\">\n        <Alert>\n          <AlertTriangle className=\"h-4 w-4\" />\n          <AlertDescription>\n            Please select an organization to view the PMO dashboard.\n          </AlertDescription>\n        </Alert>\n      </div>\n    );\n  }\n\n  if (isLoading || isLoadingOrgs) {\n    return (\n      <div className=\"p-6 space-y-6\">\n        <div>\n          <Skeleton className=\"h-8 w-64 mb-2\" />\n          <Skeleton className=\"h-4 w-96\" />\n        </div>\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n          {Array.from({ length: 4 }).map((_, i) => (\n            <Skeleton key={i} className=\"h-32\" />\n          ))}\n        </div>\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n          <Skeleton className=\"h-64\" />\n          <Skeleton className=\"h-64\" />\n        </div>\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"p-6\">\n        <Alert variant=\"destructive\">\n          <AlertTriangle className=\"h-4 w-4\" />\n          <AlertDescription>\n            Failed to load PMO dashboard data. Please try again.\n          </AlertDescription>\n        </Alert>\n      </div>\n    );\n  }\n\n  const completionRate = data?.taskStats.total ? \n    Math.round((data.taskStats.completed / data.taskStats.total) * 100) : 0;\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div>\n        <h1 className=\"text-3xl font-semibold\" data-testid=\"page-title-pmo-dashboard\">PMO Dashboard</h1>\n        <p className=\"text-muted-foreground\">\n          Organization-wide project portfolio overview for {selectedOrg?.name || 'All Projects'}\n        </p>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n        <StatCard\n          title=\"Total Projects\"\n          value={data?.projectCount || 0}\n          subtitle={`${data?.projects.filter(p => p.status === 'active').length || 0} active`}\n          icon={FolderKanban}\n          data-testid=\"stat-total-projects\"\n        />\n        <StatCard\n          title=\"Total Tasks\"\n          value={data?.taskStats.total || 0}\n          subtitle={`${completionRate}% completion rate`}\n          icon={Activity}\n          data-testid=\"stat-total-tasks\"\n        />\n        <StatCard\n          title=\"Open Risks\"\n          value={data?.riskStats.open || 0}\n          subtitle={`${data?.riskStats.highRisks || 0} high priority`}\n          icon={AlertTriangle}\n          data-testid=\"stat-open-risks\"\n        />\n        <StatCard\n          title=\"Open Issues\"\n          value={data?.issueStats.open || 0}\n          subtitle={`${data?.issueStats.critical || 0} critical`}\n          icon={FileWarning}\n          data-testid=\"stat-open-issues\"\n        />\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <BarChart3 className=\"h-5 w-5\" />\n              Task Status Overview\n            </CardTitle>\n            <CardDescription>Aggregated task status across all projects</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <div className=\"flex justify-between text-sm\">\n                <span className=\"flex items-center gap-2\">\n                  <span className=\"w-3 h-3 rounded-full bg-green-500\" />\n                  Completed\n                </span>\n                <span className=\"font-medium\">{data?.taskStats.completed || 0}</span>\n              </div>\n              <Progress value={data?.taskStats.total ? (data.taskStats.completed / data.taskStats.total) * 100 : 0} className=\"h-2 bg-muted\" />\n            </div>\n            <div className=\"space-y-2\">\n              <div className=\"flex justify-between text-sm\">\n                <span className=\"flex items-center gap-2\">\n                  <span className=\"w-3 h-3 rounded-full bg-blue-500\" />\n                  In Progress\n                </span>\n                <span className=\"font-medium\">{data?.taskStats.inProgress || 0}</span>\n              </div>\n              <Progress value={data?.taskStats.total ? (data.taskStats.inProgress / data.taskStats.total) * 100 : 0} className=\"h-2 bg-muted\" />\n            </div>\n            <div className=\"space-y-2\">\n              <div className=\"flex justify-between text-sm\">\n                <span className=\"flex items-center gap-2\">\n                  <span className=\"w-3 h-3 rounded-full bg-gray-400\" />\n                  Not Started\n                </span>\n                <span className=\"font-medium\">{data?.taskStats.notStarted || 0}</span>\n              </div>\n              <Progress value={data?.taskStats.total ? (data.taskStats.notStarted / data.taskStats.total) * 100 : 0} className=\"h-2 bg-muted\" />\n            </div>\n            <div className=\"space-y-2\">\n              <div className=\"flex justify-between text-sm\">\n                <span className=\"flex items-center gap-2\">\n                  <span className=\"w-3 h-3 rounded-full bg-amber-500\" />\n                  On Hold\n                </span>\n                <span className=\"font-medium\">{data?.taskStats.onHold || 0}</span>\n              </div>\n              <Progress value={data?.taskStats.total ? (data.taskStats.onHold / data.taskStats.total) * 100 : 0} className=\"h-2 bg-muted\" />\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <DollarSign className=\"h-5 w-5\" />\n              Budget Overview\n            </CardTitle>\n            <CardDescription>Organization-wide budget utilization</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Total Budget</p>\n                <p className=\"text-2xl font-bold\">{formatCurrency(data?.budgetStats.totalBudget || 0)}</p>\n              </div>\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Actual Cost</p>\n                <p className=\"text-2xl font-bold\">{formatCurrency(data?.budgetStats.actualCost || 0)}</p>\n              </div>\n            </div>\n            <div className=\"space-y-2\">\n              <div className=\"flex justify-between text-sm\">\n                <span>Budget Utilization</span>\n                <span className=\"font-medium\">{data?.budgetStats.utilizationPercent || 0}%</span>\n              </div>\n              <Progress \n                value={data?.budgetStats.utilizationPercent || 0} \n                className={cn(\n                  \"h-3\",\n                  (data?.budgetStats.utilizationPercent || 0) > 90 ? \"bg-red-100\" : \"bg-muted\"\n                )}\n              />\n            </div>\n            <div className={cn(\n              \"flex items-center justify-between p-3 rounded-lg\",\n              (data?.budgetStats.variance || 0) >= 0 ? \"bg-green-500/10\" : \"bg-red-500/10\"\n            )}>\n              <span className=\"text-sm font-medium\">Variance</span>\n              <span className={cn(\n                \"font-bold\",\n                (data?.budgetStats.variance || 0) >= 0 ? \"text-green-600\" : \"text-red-600\"\n              )}>\n                {(data?.budgetStats.variance || 0) >= 0 ? '+' : ''}{formatCurrency(data?.budgetStats.variance || 0)}\n              </span>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <AlertTriangle className=\"h-5 w-5\" />\n              Risk Summary\n            </CardTitle>\n            <CardDescription>Risk distribution across all projects</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"text-center p-4 rounded-lg bg-amber-500/10\">\n                <p className=\"text-3xl font-bold text-amber-600\">{data?.riskStats.open || 0}</p>\n                <p className=\"text-sm text-muted-foreground\">Open</p>\n              </div>\n              <div className=\"text-center p-4 rounded-lg bg-blue-500/10\">\n                <p className=\"text-3xl font-bold text-blue-600\">{data?.riskStats.mitigated || 0}</p>\n                <p className=\"text-sm text-muted-foreground\">Mitigated</p>\n              </div>\n              <div className=\"text-center p-4 rounded-lg bg-green-500/10\">\n                <p className=\"text-3xl font-bold text-green-600\">{data?.riskStats.closed || 0}</p>\n                <p className=\"text-sm text-muted-foreground\">Closed</p>\n              </div>\n              <div className=\"text-center p-4 rounded-lg bg-red-500/10\">\n                <p className=\"text-3xl font-bold text-red-600\">{data?.riskStats.highRisks || 0}</p>\n                <p className=\"text-sm text-muted-foreground\">High Priority</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <FileWarning className=\"h-5 w-5\" />\n              Issue Summary\n            </CardTitle>\n            <CardDescription>Issue distribution across all projects</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"text-center p-4 rounded-lg bg-amber-500/10\">\n                <p className=\"text-3xl font-bold text-amber-600\">{data?.issueStats.open || 0}</p>\n                <p className=\"text-sm text-muted-foreground\">Open</p>\n              </div>\n              <div className=\"text-center p-4 rounded-lg bg-blue-500/10\">\n                <p className=\"text-3xl font-bold text-blue-600\">{data?.issueStats.inProgress || 0}</p>\n                <p className=\"text-sm text-muted-foreground\">In Progress</p>\n              </div>\n              <div className=\"text-center p-4 rounded-lg bg-green-500/10\">\n                <p className=\"text-3xl font-bold text-green-600\">{data?.issueStats.resolved || 0}</p>\n                <p className=\"text-sm text-muted-foreground\">Resolved</p>\n              </div>\n              <div className=\"text-center p-4 rounded-lg bg-red-500/10\">\n                <p className=\"text-3xl font-bold text-red-600\">{data?.issueStats.critical || 0}</p>\n                <p className=\"text-sm text-muted-foreground\">Critical</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <FolderKanban className=\"h-5 w-5\" />\n            Project Portfolio\n          </CardTitle>\n          <CardDescription>All projects in this organization</CardDescription>\n        </CardHeader>\n        <CardContent>\n          {data?.projects.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              No projects found in this organization.\n            </div>\n          ) : (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n              {data?.projects.map((project) => (\n                <div\n                  key={project.id}\n                  className=\"flex items-center justify-between p-4 rounded-lg border hover-elevate\"\n                  data-testid={`project-card-${project.id}`}\n                >\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center\">\n                      <Building2 className=\"h-5 w-5 text-primary\" />\n                    </div>\n                    <div>\n                      <p className=\"font-medium truncate max-w-[200px]\">{project.name}</p>\n                    </div>\n                  </div>\n                  <ProjectStatusBadge status={project.status} />\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":15791},"client/src/pages/RACIMatrixPage.tsx":{"content":"import { useState, useMemo, useCallback } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useProject } from \"@/contexts/ProjectContext\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport {\n  Command,\n  CommandEmpty,\n  CommandGroup,\n  CommandInput,\n  CommandItem,\n  CommandList,\n  CommandSeparator,\n} from \"@/components/ui/command\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { \n  AlertCircle, \n  Users, \n  FolderTree, \n  Search, \n  ChevronRight, \n  ChevronDown,\n  AlertTriangle,\n  RotateCcw,\n  Check,\n  X,\n  User,\n  Briefcase\n} from \"lucide-react\";\nimport type { Task, Stakeholder, StakeholderRaci, Resource } from \"@shared/schema\";\n\ntype RaciRole = \"R\" | \"A\" | \"C\" | \"I\";\n\ninterface Person {\n  id: number;\n  name: string;\n  type: \"stakeholder\" | \"resource\";\n  role?: string;\n  organization?: string;\n}\n\nconst RACI_COLUMNS: { key: RaciRole; label: string; description: string; color: string }[] = [\n  { key: \"R\", label: \"Responsible\", description: \"Does the work to complete the task\", color: \"bg-blue-500 text-white\" },\n  { key: \"A\", label: \"Accountable\", description: \"Ultimately answerable for the task\", color: \"bg-green-500 text-white\" },\n  { key: \"C\", label: \"Consulted\", description: \"Provides input before work is done\", color: \"bg-yellow-500 text-black\" },\n  { key: \"I\", label: \"Informed\", description: \"Kept up-to-date on progress\", color: \"bg-purple-500 text-white\" },\n];\n\nfunction PersonMultiSelect({\n  selectedPeople,\n  allPeople,\n  onSelectionChange,\n  raciRole,\n  taskId,\n  isInherited,\n  hasParent,\n  onResetToInherited,\n  disabled,\n}: {\n  selectedPeople: Person[];\n  allPeople: Person[];\n  onSelectionChange: (people: Person[]) => void;\n  raciRole: RaciRole;\n  taskId: number;\n  isInherited: boolean;\n  hasParent: boolean;\n  onResetToInherited?: () => void;\n  disabled?: boolean;\n}) {\n  const [open, setOpen] = useState(false);\n  const showAccountableWarning = raciRole === \"A\" && selectedPeople.length > 1;\n  const showResetButton = hasParent && !isInherited && selectedPeople.length > 0 && onResetToInherited;\n\n  const handleTogglePerson = (person: Person) => {\n    const isSelected = selectedPeople.some(p => p.id === person.id && p.type === person.type);\n    if (isSelected) {\n      onSelectionChange(selectedPeople.filter(p => !(p.id === person.id && p.type === person.type)));\n    } else {\n      onSelectionChange([...selectedPeople, person]);\n    }\n  };\n\n  const stakeholders = allPeople.filter(p => p.type === \"stakeholder\");\n  const resources = allPeople.filter(p => p.type === \"resource\");\n\n  return (\n    <div className=\"relative\">\n      <Popover open={open} onOpenChange={setOpen}>\n        <PopoverTrigger asChild>\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            className={`w-full justify-start text-left font-normal min-h-[36px] ${\n              isInherited ? \"border-dashed bg-muted/50\" : \"\"\n            } ${showAccountableWarning ? \"border-amber-500\" : \"\"}`}\n            disabled={disabled}\n            data-testid={`raci-cell-${taskId}-${raciRole}`}\n          >\n            {selectedPeople.length === 0 ? (\n              <span className=\"text-muted-foreground text-xs\">Select...</span>\n            ) : (\n              <div className=\"flex flex-wrap gap-1\">\n                {selectedPeople.slice(0, 2).map((person) => (\n                  <Badge \n                    key={`${person.type}-${person.id}`} \n                    variant=\"secondary\" \n                    className={`text-[10px] px-1 py-0 ${isInherited ? \"opacity-70\" : \"\"}`}\n                  >\n                    {person.type === \"resource\" && <Briefcase className=\"h-2 w-2 mr-0.5\" />}\n                    {person.name.split(\" \")[0]}\n                  </Badge>\n                ))}\n                {selectedPeople.length > 2 && (\n                  <Badge variant=\"secondary\" className=\"text-[10px] px-1 py-0\">\n                    +{selectedPeople.length - 2}\n                  </Badge>\n                )}\n              </div>\n            )}\n          </Button>\n        </PopoverTrigger>\n        <PopoverContent className=\"w-64 p-0\" align=\"start\">\n          <Command>\n            <CommandInput placeholder=\"Search people...\" />\n            <CommandList>\n              <CommandEmpty>No people found.</CommandEmpty>\n              {stakeholders.length > 0 && (\n                <CommandGroup heading=\"Stakeholders\">\n                  {stakeholders.map((person) => {\n                    const isSelected = selectedPeople.some(p => p.id === person.id && p.type === person.type);\n                    return (\n                      <CommandItem\n                        key={`stakeholder-${person.id}`}\n                        onSelect={() => handleTogglePerson(person)}\n                        className=\"cursor-pointer\"\n                      >\n                        <div className=\"flex items-center gap-2 flex-1\">\n                          <Checkbox checked={isSelected} className=\"pointer-events-none\" />\n                          <User className=\"h-3 w-3 text-muted-foreground\" />\n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"text-sm truncate\">{person.name}</div>\n                            {person.role && (\n                              <div className=\"text-[10px] text-muted-foreground truncate\">{person.role}</div>\n                            )}\n                          </div>\n                        </div>\n                      </CommandItem>\n                    );\n                  })}\n                </CommandGroup>\n              )}\n              {resources.length > 0 && (\n                <>\n                  <CommandSeparator />\n                  <CommandGroup heading=\"Resources\">\n                    {resources.map((person) => {\n                      const isSelected = selectedPeople.some(p => p.id === person.id && p.type === person.type);\n                      return (\n                        <CommandItem\n                          key={`resource-${person.id}`}\n                          onSelect={() => handleTogglePerson(person)}\n                          className=\"cursor-pointer\"\n                        >\n                          <div className=\"flex items-center gap-2 flex-1\">\n                            <Checkbox checked={isSelected} className=\"pointer-events-none\" />\n                            <Briefcase className=\"h-3 w-3 text-muted-foreground\" />\n                            <div className=\"flex-1 min-w-0\">\n                              <div className=\"text-sm truncate\">{person.name}</div>\n                              {person.role && (\n                                <div className=\"text-[10px] text-muted-foreground truncate\">{person.role}</div>\n                              )}\n                            </div>\n                          </div>\n                        </CommandItem>\n                      );\n                    })}\n                  </CommandGroup>\n                </>\n              )}\n            </CommandList>\n          </Command>\n          {showResetButton && (\n            <div className=\"border-t p-2\">\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                className=\"w-full text-xs\"\n                onClick={() => {\n                  onResetToInherited!();\n                  setOpen(false);\n                }}\n              >\n                <RotateCcw className=\"h-3 w-3 mr-1\" />\n                Reset to parent\n              </Button>\n            </div>\n          )}\n        </PopoverContent>\n      </Popover>\n      {showAccountableWarning && (\n        <TooltipProvider>\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <div className=\"absolute -top-1 -right-1\">\n                <AlertTriangle className=\"h-3 w-3 text-amber-500\" />\n              </div>\n            </TooltipTrigger>\n            <TooltipContent>\n              <p className=\"text-xs\">Warning: Multiple people accountable. Best practice is one person per task.</p>\n            </TooltipContent>\n          </Tooltip>\n        </TooltipProvider>\n      )}\n      {isInherited && (\n        <TooltipProvider>\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <div className=\"absolute -bottom-1 -left-1\">\n                <div className=\"h-2 w-2 rounded-full bg-blue-400\" />\n              </div>\n            </TooltipTrigger>\n            <TooltipContent>\n              <p className=\"text-xs\">Inherited from parent task</p>\n            </TooltipContent>\n          </Tooltip>\n        </TooltipProvider>\n      )}\n    </div>\n  );\n}\n\nexport default function RACIMatrixPage() {\n  const { selectedProject } = useProject();\n  const { toast } = useToast();\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [expandedTasks, setExpandedTasks] = useState<Set<number>>(new Set());\n\n  const projectId = selectedProject?.id;\n\n  // Fetch tasks\n  const { data: tasks = [], isLoading: tasksLoading } = useQuery<Task[]>({\n    queryKey: [\"/api/projects\", projectId, \"tasks\"],\n    enabled: Boolean(projectId),\n  });\n\n  // Fetch stakeholders\n  const { data: stakeholders = [], isLoading: stakeholdersLoading } = useQuery<Stakeholder[]>({\n    queryKey: [\"/api/projects\", projectId, \"stakeholders\"],\n    enabled: Boolean(projectId),\n  });\n\n  // Fetch resources (human type only for RACI)\n  const { data: resources = [], isLoading: resourcesLoading } = useQuery<Resource[]>({\n    queryKey: [\"/api/projects\", projectId, \"resources\"],\n    enabled: Boolean(projectId),\n  });\n\n  // Fetch RACI assignments\n  const { data: raciAssignments = [], isLoading: raciLoading } = useQuery<StakeholderRaci[]>({\n    queryKey: [\"/api/projects\", projectId, \"raci\"],\n    enabled: Boolean(projectId),\n  });\n\n  // Combine stakeholders and human resources into unified people list\n  const allPeople: Person[] = useMemo(() => {\n    const people: Person[] = [];\n    stakeholders.forEach(s => {\n      people.push({\n        id: s.id,\n        name: s.name,\n        type: \"stakeholder\",\n        role: s.role,\n        organization: s.organization || undefined,\n      });\n    });\n    resources.filter(r => r.type === \"human\").forEach(r => {\n      people.push({\n        id: r.id,\n        name: r.name,\n        type: \"resource\",\n        role: r.discipline || undefined,\n      });\n    });\n    return people;\n  }, [stakeholders, resources]);\n\n  // Build RACI lookup: { taskId: { raciRole: Person[] } }\n  const raciByTask = useMemo(() => {\n    const map: Map<number, Map<RaciRole, { people: Person[]; isInherited: boolean }>> = new Map();\n    \n    raciAssignments.forEach((raci) => {\n      if (!map.has(raci.taskId)) {\n        map.set(raci.taskId, new Map());\n      }\n      const taskMap = map.get(raci.taskId)!;\n      const role = raci.raciType as RaciRole;\n      \n      if (!taskMap.has(role)) {\n        taskMap.set(role, { people: [], isInherited: raci.isInherited || false });\n      }\n      \n      const roleData = taskMap.get(role)!;\n      \n      // Find the person\n      if (raci.stakeholderId) {\n        const stakeholder = stakeholders.find(s => s.id === raci.stakeholderId);\n        if (stakeholder) {\n          roleData.people.push({\n            id: stakeholder.id,\n            name: stakeholder.name,\n            type: \"stakeholder\",\n            role: stakeholder.role,\n            organization: stakeholder.organization || undefined,\n          });\n        }\n      } else if (raci.resourceId) {\n        const resource = resources.find(r => r.id === raci.resourceId);\n        if (resource) {\n          roleData.people.push({\n            id: resource.id,\n            name: resource.name,\n            type: \"resource\",\n            role: resource.discipline || undefined,\n          });\n        }\n      }\n    });\n    \n    return map;\n  }, [raciAssignments, stakeholders, resources]);\n\n  // Upsert RACI mutation\n  const updateRaciMutation = useMutation({\n    mutationFn: async ({ \n      taskId, \n      raciType, \n      people,\n      isInherited = false,\n      inheritedFromTaskId = null,\n    }: { \n      taskId: number; \n      raciType: RaciRole;\n      people: Person[];\n      isInherited?: boolean;\n      inheritedFromTaskId?: number | null;\n    }) => {\n      if (!projectId) throw new Error(\"No project selected\");\n      \n      // First, delete all existing assignments for this task+role\n      const existingForRole = raciAssignments.filter(\n        r => r.taskId === taskId && r.raciType === raciType\n      );\n      \n      for (const existing of existingForRole) {\n        await apiRequest(\"DELETE\", `/api/raci/${existing.id}`);\n      }\n      \n      // Then create new assignments for each person\n      for (const person of people) {\n        await apiRequest(\"POST\", \"/api/raci\", {\n          projectId,\n          taskId,\n          raciType,\n          stakeholderId: person.type === \"stakeholder\" ? person.id : null,\n          resourceId: person.type === \"resource\" ? person.id : null,\n          isInherited,\n          inheritedFromTaskId,\n        });\n      }\n      \n      return { taskId, raciType, people };\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/projects\", projectId, \"raci\"] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Update Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Get people assigned to a task for a specific RACI role\n  const getAssignedPeople = useCallback((taskId: number, role: RaciRole): { people: Person[]; isInherited: boolean } => {\n    const taskMap = raciByTask.get(taskId);\n    if (!taskMap) return { people: [], isInherited: false };\n    return taskMap.get(role) || { people: [], isInherited: false };\n  }, [raciByTask]);\n\n  // Reset RACI to inherited mutation\n  const resetRaciMutation = useMutation({\n    mutationFn: async ({ taskId, raciType }: { taskId: number; raciType: RaciRole }) => {\n      if (!projectId) throw new Error(\"No project selected\");\n      await apiRequest(\"POST\", \"/api/raci/reset\", { taskId, raciType, projectId });\n      return { taskId, raciType };\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/projects\", projectId, \"raci\"] });\n      toast({\n        title: \"Reset Successful\",\n        description: \"RACI assignment has been reset to inherit from parent task.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Reset Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Handle selection change\n  const handleSelectionChange = useCallback((taskId: number, role: RaciRole, people: Person[]) => {\n    // Show warning toast for multiple Accountable\n    if (role === \"A\" && people.length > 1) {\n      toast({\n        title: \"Multiple Accountable Warning\",\n        description: \"Best practice is to have only one person Accountable per task. Consider reviewing this assignment.\",\n        variant: \"default\",\n      });\n    }\n    updateRaciMutation.mutate({ taskId, raciType: role, people });\n  }, [updateRaciMutation, toast]);\n\n  // Handle reset to inherited\n  const handleResetToInherited = useCallback((taskId: number, role: RaciRole) => {\n    resetRaciMutation.mutate({ taskId, raciType: role });\n  }, [resetRaciMutation]);\n\n  // Filter tasks by search\n  const filteredTasks = useMemo(() => {\n    if (!searchTerm) return tasks;\n    const search = searchTerm.toLowerCase();\n    return tasks.filter(\n      t => t.name.toLowerCase().includes(search) || \n           t.wbsCode.toLowerCase().includes(search)\n    );\n  }, [tasks, searchTerm]);\n\n  // Build tree structure\n  const rootTasks = useMemo(() => {\n    return filteredTasks\n      .filter(t => !t.parentId)\n      .sort((a, b) => a.wbsCode.localeCompare(b.wbsCode, undefined, { numeric: true }));\n  }, [filteredTasks]);\n\n  const getChildren = useCallback((parentId: number) => {\n    return filteredTasks\n      .filter(t => t.parentId === parentId)\n      .sort((a, b) => a.wbsCode.localeCompare(b.wbsCode, undefined, { numeric: true }));\n  }, [filteredTasks]);\n\n  const toggleExpand = useCallback((taskId: number) => {\n    setExpandedTasks(prev => {\n      const next = new Set(prev);\n      if (next.has(taskId)) {\n        next.delete(taskId);\n      } else {\n        next.add(taskId);\n      }\n      return next;\n    });\n  }, []);\n\n  const expandAll = useCallback(() => {\n    setExpandedTasks(new Set(tasks.map(t => t.id)));\n  }, [tasks]);\n\n  const collapseAll = useCallback(() => {\n    setExpandedTasks(new Set());\n  }, []);\n\n  // Render a single task row\n  const renderTaskRow = (task: Task, level: number = 0) => {\n    const children = getChildren(task.id);\n    const hasChildren = children.length > 0;\n    const isExpanded = expandedTasks.has(task.id);\n\n    return (\n      <div key={task.id}>\n        <div \n          className=\"grid grid-cols-[minmax(250px,2fr),repeat(4,minmax(120px,1fr))] gap-2 items-center py-2 px-3 border-b hover:bg-muted/30\"\n          data-testid={`raci-row-${task.id}`}\n        >\n          {/* Task column with tree indentation */}\n          <div className=\"flex items-center gap-1\" style={{ paddingLeft: `${level * 1.25}rem` }}>\n            {hasChildren ? (\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className=\"h-6 w-6 p-0\"\n                onClick={() => toggleExpand(task.id)}\n                data-testid={`expand-toggle-${task.id}`}\n              >\n                {isExpanded ? (\n                  <ChevronDown className=\"h-4 w-4\" />\n                ) : (\n                  <ChevronRight className=\"h-4 w-4\" />\n                )}\n              </Button>\n            ) : (\n              <div className=\"w-6\" />\n            )}\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"font-medium text-sm truncate\">{task.name}</div>\n              <div className=\"text-xs text-muted-foreground font-mono\">{task.wbsCode}</div>\n            </div>\n          </div>\n\n          {/* RACI columns */}\n          {RACI_COLUMNS.map((col) => {\n            const { people, isInherited } = getAssignedPeople(task.id, col.key);\n            return (\n              <PersonMultiSelect\n                key={col.key}\n                selectedPeople={people}\n                allPeople={allPeople}\n                onSelectionChange={(newPeople) => handleSelectionChange(task.id, col.key, newPeople)}\n                raciRole={col.key}\n                taskId={task.id}\n                isInherited={isInherited}\n                hasParent={Boolean(task.parentId)}\n                onResetToInherited={() => handleResetToInherited(task.id, col.key)}\n                disabled={updateRaciMutation.isPending || resetRaciMutation.isPending}\n              />\n            );\n          })}\n        </div>\n\n        {/* Render children if expanded */}\n        {isExpanded && children.map(child => renderTaskRow(child, level + 1))}\n      </div>\n    );\n  };\n\n  if (!selectedProject) {\n    return (\n      <div className=\"p-6\">\n        <Alert>\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertDescription>\n            Please select a project to view the RACI Matrix.\n          </AlertDescription>\n        </Alert>\n      </div>\n    );\n  }\n\n  const isLoading = tasksLoading || stakeholdersLoading || resourcesLoading || raciLoading;\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-semibold\" data-testid=\"text-raci-title\">RACI Matrix</h1>\n          <p className=\"text-muted-foreground\">\n            Assign Responsible, Accountable, Consulted, and Informed roles for each WBS item\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Badge variant=\"outline\" className=\"gap-1\">\n            <FolderTree className=\"h-3 w-3\" />\n            {tasks.length} Tasks\n          </Badge>\n          <Badge variant=\"outline\" className=\"gap-1\">\n            <Users className=\"h-3 w-3\" />\n            {allPeople.length} People\n          </Badge>\n        </div>\n      </div>\n\n      {/* RACI Legend */}\n      <Card>\n        <CardHeader className=\"pb-3\">\n          <CardTitle className=\"text-base\">RACI Legend</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex flex-wrap gap-4\">\n            {RACI_COLUMNS.map(({ key, label, description, color }) => (\n              <div key={key} className=\"flex items-center gap-2\">\n                <div className={`h-6 w-6 rounded flex items-center justify-center font-bold text-xs ${color}`}>\n                  {key}\n                </div>\n                <div>\n                  <span className=\"font-medium text-sm\">{label}</span>\n                  <span className=\"text-xs text-muted-foreground ml-1\">- {description}</span>\n                </div>\n              </div>\n            ))}\n          </div>\n          <div className=\"flex items-center gap-4 mt-3 pt-3 border-t\">\n            <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n              <div className=\"h-2 w-2 rounded-full bg-blue-400\" />\n              <span>Inherited from parent</span>\n            </div>\n            <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n              <AlertTriangle className=\"h-3 w-3 text-amber-500\" />\n              <span>Multiple accountable (warning)</span>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Search and controls */}\n      <div className=\"flex items-center gap-4\">\n        <div className=\"relative flex-1 max-w-sm\">\n          <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Search tasks by name or WBS code...\"\n            value={searchTerm}\n            onChange={(e) => setSearchTerm(e.target.value)}\n            className=\"pl-10\"\n            data-testid=\"input-search-tasks\"\n          />\n        </div>\n        <Button variant=\"outline\" size=\"sm\" onClick={expandAll} data-testid=\"button-expand-all\">\n          Expand All\n        </Button>\n        <Button variant=\"outline\" size=\"sm\" onClick={collapseAll} data-testid=\"button-collapse-all\">\n          Collapse All\n        </Button>\n      </div>\n\n      {/* RACI Matrix Grid */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Responsibility Assignment Matrix</CardTitle>\n          <CardDescription>\n            Click on cells to assign people. Children inherit parent assignments unless explicitly overridden.\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"p-0\">\n          {isLoading ? (\n            <div className=\"p-6 space-y-4\">\n              <Skeleton className=\"h-12 w-full\" />\n              <Skeleton className=\"h-64 w-full\" />\n            </div>\n          ) : allPeople.length === 0 ? (\n            <div className=\"p-6\">\n              <Alert>\n                <AlertCircle className=\"h-4 w-4\" />\n                <AlertDescription>\n                  No stakeholders or resources found. Add people to this project before creating RACI assignments.\n                </AlertDescription>\n              </Alert>\n            </div>\n          ) : filteredTasks.length === 0 ? (\n            <div className=\"p-6\">\n              <Alert>\n                <AlertCircle className=\"h-4 w-4\" />\n                <AlertDescription>\n                  No tasks found matching your search. Try adjusting your search criteria.\n                </AlertDescription>\n              </Alert>\n            </div>\n          ) : (\n            <ScrollArea className=\"max-h-[600px]\">\n              <div className=\"min-w-[700px]\">\n                {/* Header row */}\n                <div className=\"grid grid-cols-[minmax(250px,2fr),repeat(4,minmax(120px,1fr))] gap-2 items-center py-3 px-3 bg-muted/50 border-b sticky top-0 z-10\">\n                  <div className=\"font-medium text-sm\">WBS / Task</div>\n                  {RACI_COLUMNS.map((col) => (\n                    <TooltipProvider key={col.key}>\n                      <Tooltip>\n                        <TooltipTrigger asChild>\n                          <div className=\"flex items-center justify-center gap-1 cursor-help\">\n                            <div className={`h-5 w-5 rounded flex items-center justify-center font-bold text-[10px] ${col.color}`}>\n                              {col.key}\n                            </div>\n                            <span className=\"font-medium text-xs\">{col.label}</span>\n                          </div>\n                        </TooltipTrigger>\n                        <TooltipContent>\n                          <p className=\"text-sm\">{col.description}</p>\n                        </TooltipContent>\n                      </Tooltip>\n                    </TooltipProvider>\n                  ))}\n                </div>\n\n                {/* Task rows */}\n                <div>\n                  {rootTasks.map(task => renderTaskRow(task, 0))}\n                </div>\n              </div>\n            </ScrollArea>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":25764},"client/src/components/ResourceUtilizationChart.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea, ScrollBar } from \"@/components/ui/scroll-area\";\nimport { Tooltip, TooltipContent, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { Loader2, AlertTriangle, User, Wrench, Package, Calendar } from \"lucide-react\";\nimport { format, differenceInWeeks } from \"date-fns\";\nimport { useProject } from \"@/contexts/ProjectContext\";\n\ninterface ResourceUtilizationData {\n  resources: Array<{\n    resourceId: number;\n    resourceName: string;\n    resourceType: string;\n    periods: Array<{\n      periodStart: string;\n      periodEnd: string;\n      utilization: number;\n      isOverAllocated: boolean;\n      assignments: Array<{\n        taskId: number;\n        taskName: string;\n        allocation: number;\n      }>;\n    }>;\n  }>;\n}\n\nconst RESOURCE_TYPE_ICONS: Record<string, typeof User> = {\n  human: User,\n  equipment: Wrench,\n  material: Package,\n};\n\nfunction getUtilizationColor(utilization: number): string {\n  if (utilization === 0) return \"bg-muted\";\n  if (utilization <= 50) return \"bg-green-500/70\";\n  if (utilization <= 80) return \"bg-yellow-500/70\";\n  if (utilization <= 100) return \"bg-orange-500/70\";\n  return \"bg-red-500\";\n}\n\nfunction getUtilizationTextColor(utilization: number): string {\n  if (utilization === 0) return \"text-muted-foreground\";\n  return \"text-white\";\n}\n\nexport function ResourceUtilizationChart() {\n  const { selectedProjectId } = useProject();\n\n  const { data, isLoading, error } = useQuery<ResourceUtilizationData>({\n    queryKey: [`/api/projects/${selectedProjectId}/resource-utilization`],\n    enabled: !!selectedProjectId,\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <Card>\n        <CardContent className=\"p-6\">\n          <div className=\"flex items-center gap-2 text-destructive\">\n            <AlertTriangle className=\"h-5 w-5\" />\n            <p>Failed to load resource utilization data</p>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (!data || data.resources.length === 0) {\n    return (\n      <Card>\n        <CardContent className=\"p-12 text-center\">\n          <Calendar className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n          <h2 className=\"text-xl font-semibold mb-2\">No Utilization Data</h2>\n          <p className=\"text-muted-foreground\">\n            Add resources and assign them to tasks to see utilization data.\n          </p>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const periods = data.resources[0]?.periods || [];\n  const overAllocatedResources = data.resources.filter(r => \n    r.periods.some(p => p.isOverAllocated)\n  );\n\n  return (\n    <div className=\"space-y-4\">\n      {overAllocatedResources.length > 0 && (\n        <Card className=\"border-destructive/50 bg-destructive/5\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-2\">\n              <AlertTriangle className=\"h-5 w-5 text-destructive\" />\n              <p className=\"font-medium text-destructive\">\n                {overAllocatedResources.length} resource(s) are over-allocated\n              </p>\n            </div>\n            <p className=\"text-sm text-muted-foreground mt-1\">\n              {overAllocatedResources.map(r => r.resourceName).join(\", \")}\n            </p>\n          </CardContent>\n        </Card>\n      )}\n\n      <Card>\n        <CardHeader className=\"pb-2\">\n          <CardTitle className=\"text-lg flex items-center gap-2\">\n            <Calendar className=\"h-5 w-5\" />\n            Resource Utilization Timeline\n          </CardTitle>\n          <p className=\"text-sm text-muted-foreground\">\n            Weekly view of resource allocation across project tasks\n          </p>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex gap-4 mb-4\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-4 h-4 rounded bg-green-500/70\" />\n              <span className=\"text-xs text-muted-foreground\">0-50%</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-4 h-4 rounded bg-yellow-500/70\" />\n              <span className=\"text-xs text-muted-foreground\">51-80%</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-4 h-4 rounded bg-orange-500/70\" />\n              <span className=\"text-xs text-muted-foreground\">81-100%</span>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <div className=\"w-4 h-4 rounded bg-red-500\" />\n              <span className=\"text-xs text-muted-foreground\">Over-allocated</span>\n            </div>\n          </div>\n\n          <ScrollArea className=\"w-full\" type=\"always\">\n            <div className=\"min-w-max\">\n              <div className=\"flex border-b\">\n                <div className=\"w-48 shrink-0 p-2 font-medium text-sm border-r bg-muted/30\">\n                  Resource\n                </div>\n                {periods.map((period, idx) => (\n                  <div \n                    key={idx}\n                    className=\"w-16 shrink-0 p-2 text-center text-xs text-muted-foreground border-r\"\n                  >\n                    {format(new Date(period.periodStart), \"MMM d\")}\n                  </div>\n                ))}\n              </div>\n\n              {data.resources.map((resource) => {\n                const TypeIcon = RESOURCE_TYPE_ICONS[resource.resourceType] || User;\n                return (\n                  <div \n                    key={resource.resourceId} \n                    className=\"flex border-b hover:bg-muted/20\"\n                    data-testid={`utilization-row-${resource.resourceId}`}\n                  >\n                    <div className=\"w-48 shrink-0 p-2 border-r flex items-center gap-2\">\n                      <TypeIcon className=\"h-4 w-4 text-muted-foreground\" />\n                      <span className=\"text-sm font-medium truncate\" title={resource.resourceName}>\n                        {resource.resourceName}\n                      </span>\n                    </div>\n                    {resource.periods.map((period, idx) => (\n                      <Tooltip key={idx}>\n                        <TooltipTrigger asChild>\n                          <div \n                            className={`w-16 shrink-0 p-1 border-r flex items-center justify-center cursor-pointer ${period.isOverAllocated ? 'animate-pulse' : ''}`}\n                            data-testid={`utilization-cell-${resource.resourceId}-${idx}`}\n                          >\n                            <div \n                              className={`w-12 h-8 rounded flex items-center justify-center text-xs font-mono ${getUtilizationColor(period.utilization)} ${getUtilizationTextColor(period.utilization)}`}\n                            >\n                              {period.utilization > 0 ? `${period.utilization}%` : '-'}\n                            </div>\n                          </div>\n                        </TooltipTrigger>\n                        <TooltipContent side=\"bottom\" className=\"max-w-xs\">\n                          <div className=\"space-y-2\">\n                            <div className=\"font-medium\">\n                              {format(new Date(period.periodStart), \"MMM d\")} - {format(new Date(period.periodEnd), \"MMM d, yyyy\")}\n                            </div>\n                            <div className=\"text-sm\">\n                              Utilization: <span className={period.isOverAllocated ? 'text-destructive font-bold' : ''}>\n                                {period.utilization}%\n                              </span>\n                              {period.isOverAllocated && (\n                                <Badge variant=\"destructive\" className=\"ml-2 text-xs\">\n                                  Over-allocated\n                                </Badge>\n                              )}\n                            </div>\n                            {period.assignments.length > 0 && (\n                              <div className=\"border-t pt-2 mt-2\">\n                                <p className=\"text-xs font-medium mb-1\">Assigned Tasks:</p>\n                                <ul className=\"text-xs space-y-1\">\n                                  {period.assignments.map((assignment, aIdx) => (\n                                    <li key={aIdx} className=\"flex justify-between gap-4\">\n                                      <span className=\"truncate\">{assignment.taskName}</span>\n                                      <span className=\"shrink-0 font-mono\">{assignment.allocation}%</span>\n                                    </li>\n                                  ))}\n                                </ul>\n                              </div>\n                            )}\n                          </div>\n                        </TooltipContent>\n                      </Tooltip>\n                    ))}\n                  </div>\n                );\n              })}\n            </div>\n            <ScrollBar orientation=\"horizontal\" />\n          </ScrollArea>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":9402},"server/scheduling.ts":{"content":"import { db } from \"./db\";\nimport { tasks, taskDependencies, resourceAssignments, resources } from \"@shared/schema\";\nimport { eq, and, desc, sql } from \"drizzle-orm\";\nimport type { Task, TaskDependency, Resource, ResourceAssignment } from \"@shared/schema\";\n\ninterface ScheduleTask {\n  id: number;\n  name: string;\n  wbsCode: string;\n  duration: number; // in days\n  earlyStart: Date | null;\n  earlyFinish: Date | null;\n  lateStart: Date | null;\n  lateFinish: Date | null;\n  totalFloat: number | null;\n  freeFloat: number | null;\n  isCriticalPath: boolean;\n  predecessors: { taskId: number; type: string; lagDays: number }[];\n  successors: { taskId: number; type: string; lagDays: number }[];\n  constraintType: string;\n  constraintDate: Date | null;\n  estimatedHours: number | null;\n}\n\ninterface ScheduleResult {\n  success: boolean;\n  message: string;\n  tasksUpdated: number;\n  criticalPathLength: number;\n  projectEndDate: Date | null;\n  criticalTasks: number[];\n}\n\nexport class SchedulingService {\n  /**\n   * Calculate task duration in days based on estimated hours and resource capacity\n   * Default: 8 hours per day if no resources assigned\n   */\n  calculateDuration(estimatedHours: number | null, hoursPerDay: number = 8): number {\n    if (!estimatedHours || estimatedHours <= 0) {\n      return 1; // Minimum 1 day duration\n    }\n    return Math.ceil(Number(estimatedHours) / hoursPerDay);\n  }\n\n  /**\n   * Add business days to a date (skipping weekends)\n   */\n  addBusinessDays(startDate: Date, days: number): Date {\n    const result = new Date(startDate);\n    let remainingDays = days;\n    \n    while (remainingDays > 0) {\n      result.setDate(result.getDate() + 1);\n      const dayOfWeek = result.getDay();\n      // Skip weekends (0 = Sunday, 6 = Saturday)\n      if (dayOfWeek !== 0 && dayOfWeek !== 6) {\n        remainingDays--;\n      }\n    }\n    \n    return result;\n  }\n\n  /**\n   * Subtract business days from a date (skipping weekends)\n   */\n  subtractBusinessDays(endDate: Date, days: number): Date {\n    const result = new Date(endDate);\n    let remainingDays = days;\n    \n    while (remainingDays > 0) {\n      result.setDate(result.getDate() - 1);\n      const dayOfWeek = result.getDay();\n      // Skip weekends (0 = Sunday, 6 = Saturday)\n      if (dayOfWeek !== 0 && dayOfWeek !== 6) {\n        remainingDays--;\n      }\n    }\n    \n    return result;\n  }\n\n  /**\n   * Calculate business days between two dates\n   */\n  getBusinessDaysBetween(start: Date, end: Date): number {\n    let count = 0;\n    const current = new Date(start);\n    \n    while (current < end) {\n      current.setDate(current.getDate() + 1);\n      const dayOfWeek = current.getDay();\n      if (dayOfWeek !== 0 && dayOfWeek !== 6) {\n        count++;\n      }\n    }\n    \n    return count;\n  }\n\n  /**\n   * Perform Forward Pass - Calculate Early Start (ES) and Early Finish (EF)\n   * ES = Max(EF of all predecessors) adjusted for dependency type and lag\n   * EF = ES + Duration\n   */\n  async forwardPass(projectId: number, projectStartDate: Date): Promise<Map<number, ScheduleTask>> {\n    // Fetch all tasks for the project\n    const projectTasks = await db.select()\n      .from(tasks)\n      .where(eq(tasks.projectId, projectId));\n    \n    // Fetch all dependencies\n    const dependencies = await db.select()\n      .from(taskDependencies)\n      .where(eq(taskDependencies.projectId, projectId));\n    \n    // Build schedule task map\n    const taskMap = new Map<number, ScheduleTask>();\n    \n    for (const task of projectTasks) {\n      const predecessors = dependencies\n        .filter(d => d.successorId === task.id)\n        .map(d => ({ taskId: d.predecessorId, type: d.type, lagDays: d.lagDays }));\n      \n      const successors = dependencies\n        .filter(d => d.predecessorId === task.id)\n        .map(d => ({ taskId: d.successorId, type: d.type, lagDays: d.lagDays }));\n      \n      const duration = this.calculateDuration(task.estimatedHours ? Number(task.estimatedHours) : null);\n      \n      taskMap.set(task.id, {\n        id: task.id,\n        name: task.name,\n        wbsCode: task.wbsCode,\n        duration,\n        earlyStart: null,\n        earlyFinish: null,\n        lateStart: null,\n        lateFinish: null,\n        totalFloat: null,\n        freeFloat: null,\n        isCriticalPath: false,\n        predecessors,\n        successors,\n        constraintType: task.constraintType || \"asap\",\n        constraintDate: task.constraintDate,\n        estimatedHours: task.estimatedHours ? Number(task.estimatedHours) : null,\n      });\n    }\n    \n    // Topological sort to determine processing order\n    const processed = new Set<number>();\n    const sortedTasks: number[] = [];\n    \n    const visit = (taskId: number): void => {\n      if (processed.has(taskId)) return;\n      \n      const task = taskMap.get(taskId);\n      if (!task) return;\n      \n      // Process all predecessors first\n      for (const pred of task.predecessors) {\n        if (!processed.has(pred.taskId)) {\n          visit(pred.taskId);\n        }\n      }\n      \n      processed.add(taskId);\n      sortedTasks.push(taskId);\n    };\n    \n    // Visit all tasks\n    for (const taskId of Array.from(taskMap.keys())) {\n      visit(taskId);\n    }\n    \n    // Forward pass: Calculate ES and EF\n    for (const taskId of sortedTasks) {\n      const task = taskMap.get(taskId)!;\n      \n      if (task.predecessors.length === 0) {\n        // No predecessors - start at project start date\n        task.earlyStart = new Date(projectStartDate);\n        \n        // Apply constraint if applicable\n        if (task.constraintType === \"snet\" && task.constraintDate) {\n          // Start No Earlier Than\n          if (task.constraintDate > task.earlyStart) {\n            task.earlyStart = new Date(task.constraintDate);\n          }\n        } else if (task.constraintType === \"mso\" && task.constraintDate) {\n          // Must Start On\n          task.earlyStart = new Date(task.constraintDate);\n        }\n      } else {\n        // Has predecessors - calculate based on dependency types\n        let maxDate = new Date(0); // Start with epoch\n        \n        for (const pred of task.predecessors) {\n          const predTask = taskMap.get(pred.taskId);\n          if (!predTask || !predTask.earlyFinish) continue;\n          \n          let constrainedDate: Date;\n          \n          switch (pred.type) {\n            case \"FS\": // Finish-to-Start: Successor starts the next business day after predecessor finishes\n              constrainedDate = this.addBusinessDays(predTask.earlyFinish, 1 + pred.lagDays);\n              break;\n            case \"SS\": // Start-to-Start: Successor starts after predecessor starts\n              constrainedDate = predTask.earlyStart ? \n                this.addBusinessDays(predTask.earlyStart, pred.lagDays) : \n                this.addBusinessDays(predTask.earlyFinish, pred.lagDays - task.duration);\n              break;\n            case \"FF\": // Finish-to-Finish: Successor finishes after predecessor finishes\n              constrainedDate = predTask.earlyFinish ?\n                this.addBusinessDays(this.subtractBusinessDays(predTask.earlyFinish, task.duration - 1), pred.lagDays) :\n                new Date(projectStartDate);\n              break;\n            case \"SF\": // Start-to-Finish: Successor finishes after predecessor starts\n              constrainedDate = predTask.earlyStart ?\n                this.addBusinessDays(this.subtractBusinessDays(predTask.earlyStart, task.duration - 1), pred.lagDays) :\n                new Date(projectStartDate);\n              break;\n            default:\n              constrainedDate = this.addBusinessDays(predTask.earlyFinish!, pred.lagDays);\n          }\n          \n          if (constrainedDate > maxDate) {\n            maxDate = constrainedDate;\n          }\n        }\n        \n        task.earlyStart = maxDate;\n        \n        // Apply constraints\n        if (task.constraintType === \"snet\" && task.constraintDate) {\n          if (task.constraintDate > task.earlyStart) {\n            task.earlyStart = new Date(task.constraintDate);\n          }\n        } else if (task.constraintType === \"mso\" && task.constraintDate) {\n          task.earlyStart = new Date(task.constraintDate);\n        }\n      }\n      \n      // Calculate Early Finish (duration - 1 because start day counts as day 1)\n      // A 1-day task starts and finishes on the same day\n      task.earlyFinish = task.duration <= 1 \n        ? new Date(task.earlyStart!) \n        : this.addBusinessDays(task.earlyStart!, task.duration - 1);\n    }\n    \n    return taskMap;\n  }\n\n  /**\n   * Perform Backward Pass - Calculate Late Start (LS) and Late Finish (LF)\n   * LF = Min(LS of all successors) adjusted for dependency type and lag\n   * LS = LF - Duration\n   */\n  backwardPass(taskMap: Map<number, ScheduleTask>, projectEndDate: Date): void {\n    // Get tasks in reverse topological order\n    const sortedTasks = Array.from(taskMap.keys());\n    const processed = new Set<number>();\n    const reverseSorted: number[] = [];\n    \n    const visit = (taskId: number): void => {\n      if (processed.has(taskId)) return;\n      \n      const task = taskMap.get(taskId);\n      if (!task) return;\n      \n      // Process all successors first\n      for (const succ of task.successors) {\n        if (!processed.has(succ.taskId)) {\n          visit(succ.taskId);\n        }\n      }\n      \n      processed.add(taskId);\n      reverseSorted.push(taskId);\n    };\n    \n    for (const taskId of sortedTasks) {\n      visit(taskId);\n    }\n    \n    // Backward pass: Calculate LS and LF\n    for (const taskId of reverseSorted) {\n      const task = taskMap.get(taskId)!;\n      \n      if (task.successors.length === 0) {\n        // No successors - end at project end date\n        task.lateFinish = new Date(projectEndDate);\n        \n        // Apply constraint if applicable\n        if (task.constraintType === \"fnet\" && task.constraintDate) {\n          // Finish No Later Than\n          if (task.constraintDate < task.lateFinish) {\n            task.lateFinish = new Date(task.constraintDate);\n          }\n        } else if (task.constraintType === \"mfo\" && task.constraintDate) {\n          // Must Finish On\n          task.lateFinish = new Date(task.constraintDate);\n        }\n      } else {\n        // Has successors - calculate based on dependency types\n        let minDate = new Date(8640000000000000); // Max date\n        \n        for (const succ of task.successors) {\n          const succTask = taskMap.get(succ.taskId);\n          if (!succTask || !succTask.lateStart) continue;\n          \n          let constrainedDate: Date;\n          \n          switch (succ.type) {\n            case \"FS\": // Finish-to-Start: This task must finish one day before successor starts\n              constrainedDate = this.subtractBusinessDays(succTask.lateStart, 1 + succ.lagDays);\n              break;\n            case \"SS\": // Start-to-Start\n              constrainedDate = succTask.lateStart ?\n                this.addBusinessDays(this.subtractBusinessDays(succTask.lateStart, succ.lagDays), task.duration) :\n                new Date(projectEndDate);\n              break;\n            case \"FF\": // Finish-to-Finish\n              constrainedDate = succTask.lateFinish ?\n                this.subtractBusinessDays(succTask.lateFinish, succ.lagDays) :\n                new Date(projectEndDate);\n              break;\n            case \"SF\": // Start-to-Finish\n              constrainedDate = succTask.lateStart ?\n                this.addBusinessDays(succTask.lateStart, task.duration - 1 - succ.lagDays) :\n                new Date(projectEndDate);\n              break;\n            default:\n              constrainedDate = this.subtractBusinessDays(succTask.lateStart!, 1 + succ.lagDays);\n          }\n          \n          if (constrainedDate < minDate) {\n            minDate = constrainedDate;\n          }\n        }\n        \n        task.lateFinish = minDate;\n        \n        // Apply constraints\n        if (task.constraintType === \"fnet\" && task.constraintDate) {\n          if (task.constraintDate < task.lateFinish) {\n            task.lateFinish = new Date(task.constraintDate);\n          }\n        } else if (task.constraintType === \"mfo\" && task.constraintDate) {\n          task.lateFinish = new Date(task.constraintDate);\n        }\n      }\n      \n      // Calculate Late Start (duration - 1 because finish day counts as part of duration)\n      // A 1-day task starts and finishes on the same day\n      task.lateStart = task.duration <= 1 \n        ? new Date(task.lateFinish!) \n        : this.subtractBusinessDays(task.lateFinish!, task.duration - 1);\n    }\n  }\n\n  /**\n   * Calculate Float (Total Float and Free Float) and identify Critical Path\n   */\n  calculateFloatAndCriticalPath(taskMap: Map<number, ScheduleTask>): number[] {\n    const criticalTasks: number[] = [];\n    \n    for (const [taskId, task] of Array.from(taskMap.entries())) {\n      if (!task.lateFinish || !task.earlyFinish || !task.lateStart || !task.earlyStart) {\n        continue;\n      }\n      \n      // Total Float = LF - EF = LS - ES\n      task.totalFloat = this.getBusinessDaysBetween(task.earlyFinish, task.lateFinish);\n      \n      // Free Float = Earliest ES of successors - EF of this task - 1\n      if (task.successors.length > 0) {\n        let minSuccessorES = new Date(8640000000000000);\n        for (const succ of task.successors) {\n          const succTask = taskMap.get(succ.taskId);\n          if (succTask?.earlyStart && succTask.earlyStart < minSuccessorES) {\n            minSuccessorES = succTask.earlyStart;\n          }\n        }\n        task.freeFloat = Math.max(0, this.getBusinessDaysBetween(task.earlyFinish, minSuccessorES));\n      } else {\n        task.freeFloat = task.totalFloat;\n      }\n      \n      // Critical Path: Tasks with zero total float\n      task.isCriticalPath = task.totalFloat === 0;\n      if (task.isCriticalPath) {\n        criticalTasks.push(taskId);\n      }\n    }\n    \n    return criticalTasks;\n  }\n\n  /**\n   * Run the complete scheduling calculation for a project\n   */\n  async runSchedule(projectId: number, projectStartDate?: Date): Promise<ScheduleResult> {\n    try {\n      // Get project info for default start date\n      const [project] = await db.select()\n        .from(tasks)\n        .where(eq(tasks.projectId, projectId))\n        .limit(1);\n      \n      if (!project && !projectStartDate) {\n        return {\n          success: false,\n          message: \"No tasks found for project\",\n          tasksUpdated: 0,\n          criticalPathLength: 0,\n          projectEndDate: null,\n          criticalTasks: [],\n        };\n      }\n      \n      const startDate = projectStartDate || new Date();\n      \n      // Step 1: Forward Pass\n      const taskMap = await this.forwardPass(projectId, startDate);\n      \n      if (taskMap.size === 0) {\n        return {\n          success: true,\n          message: \"No tasks to schedule\",\n          tasksUpdated: 0,\n          criticalPathLength: 0,\n          projectEndDate: null,\n          criticalTasks: [],\n        };\n      }\n      \n      // Find project end date (max EF)\n      let projectEndDate = new Date(0);\n      for (const task of Array.from(taskMap.values())) {\n        if (task.earlyFinish && task.earlyFinish > projectEndDate) {\n          projectEndDate = task.earlyFinish;\n        }\n      }\n      \n      // Step 2: Backward Pass\n      this.backwardPass(taskMap, projectEndDate);\n      \n      // Step 3: Calculate Float and Critical Path\n      const criticalTasks = this.calculateFloatAndCriticalPath(taskMap);\n      \n      // Step 4: Update tasks in database\n      let tasksUpdated = 0;\n      for (const [taskId, task] of Array.from(taskMap.entries())) {\n        await db.update(tasks)\n          .set({\n            duration: task.duration,\n            earlyStart: task.earlyStart,\n            earlyFinish: task.earlyFinish,\n            lateStart: task.lateStart,\n            lateFinish: task.lateFinish,\n            float: task.totalFloat,\n            freeFloat: task.freeFloat,\n            isCriticalPath: task.isCriticalPath,\n            // Also update startDate/endDate if not set\n            startDate: task.earlyStart,\n            endDate: task.earlyFinish,\n          })\n          .where(eq(tasks.id, taskId));\n        tasksUpdated++;\n      }\n      \n      // Calculate critical path length\n      const criticalPathLength = criticalTasks.reduce((sum, taskId) => {\n        const task = taskMap.get(taskId);\n        return sum + (task?.duration || 0);\n      }, 0);\n      \n      return {\n        success: true,\n        message: `Successfully scheduled ${tasksUpdated} tasks`,\n        tasksUpdated,\n        criticalPathLength,\n        projectEndDate,\n        criticalTasks,\n      };\n    } catch (error) {\n      console.error(\"Scheduling error:\", error);\n      return {\n        success: false,\n        message: error instanceof Error ? error.message : \"Unknown scheduling error\",\n        tasksUpdated: 0,\n        criticalPathLength: 0,\n        projectEndDate: null,\n        criticalTasks: [],\n      };\n    }\n  }\n\n  /**\n   * Get the scheduled data for all tasks in a project\n   */\n  async getScheduleData(projectId: number): Promise<ScheduleTask[]> {\n    const projectTasks = await db.select()\n      .from(tasks)\n      .where(eq(tasks.projectId, projectId));\n    \n    const dependencies = await db.select()\n      .from(taskDependencies)\n      .where(eq(taskDependencies.projectId, projectId));\n    \n    return projectTasks.map(task => {\n      const predecessors = dependencies\n        .filter(d => d.successorId === task.id)\n        .map(d => ({ taskId: d.predecessorId, type: d.type, lagDays: d.lagDays }));\n      \n      const successors = dependencies\n        .filter(d => d.predecessorId === task.id)\n        .map(d => ({ taskId: d.successorId, type: d.type, lagDays: d.lagDays }));\n      \n      return {\n        id: task.id,\n        name: task.name,\n        wbsCode: task.wbsCode,\n        duration: task.duration || this.calculateDuration(task.estimatedHours ? Number(task.estimatedHours) : null),\n        earlyStart: task.earlyStart,\n        earlyFinish: task.earlyFinish,\n        lateStart: task.lateStart,\n        lateFinish: task.lateFinish,\n        totalFloat: task.float,\n        freeFloat: task.freeFloat,\n        isCriticalPath: task.isCriticalPath || false,\n        predecessors,\n        successors,\n        constraintType: task.constraintType || \"asap\",\n        constraintDate: task.constraintDate,\n        estimatedHours: task.estimatedHours ? Number(task.estimatedHours) : null,\n      };\n    });\n  }\n}\n\nexport const schedulingService = new SchedulingService();\n","size_bytes":18561}},"version":2}